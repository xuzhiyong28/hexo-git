{"meta":{"version":1,"warehouse":"3.0.2"},"models":{"Asset":[{"_id":"themes/volantis/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/volantis/source/fonts/Monaco.ttf","path":"fonts/Monaco.ttf","modified":0,"renderable":1},{"_id":"themes/volantis/source/img/algolia.svg","path":"img/algolia.svg","modified":0,"renderable":1},{"_id":"themes/volantis/source/img/azure.svg","path":"img/azure.svg","modified":0,"renderable":1},{"_id":"themes/volantis/source/img/baidu.svg","path":"img/baidu.svg","modified":0,"renderable":1},{"_id":"themes/volantis/source/js/app.js","path":"js/app.js","modified":0,"renderable":1},{"_id":"themes/volantis/source/js/search.js","path":"js/search.js","modified":0,"renderable":1},{"_id":"themes/volantis/source/fonts/Skranji-Regular.ttf","path":"fonts/Skranji-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/volantis/source/js/valine.js","path":"js/valine.js","modified":0,"renderable":1},{"_id":"themes/volantis/source/fonts/Ubuntu-Regular.ttf","path":"fonts/Ubuntu-Regular.ttf","modified":0,"renderable":1},{"_id":"source/CHAME","path":"CHAME","modified":0,"renderable":0},{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/categories/index/index.txt","path":"categories/index/index.txt","modified":0,"renderable":0},{"_id":"source/tags/index/index.txt","path":"tags/index/index.txt","modified":0,"renderable":0},{"_id":"themes/volantis/source/img/default.cur","path":"img/default.cur","modified":0,"renderable":1},{"_id":"themes/volantis/source/img/pointer.cur","path":"img/pointer.cur","modified":0,"renderable":1}],"Cache":[{"_id":"themes/volantis/.gitignore","hash":"4b5e4eb66070da8433cd43d75af0de341e04a2ed","modified":1595250283359},{"_id":"themes/volantis/LICENSE","hash":"e0cbf6906cab5926a34f17852db6c05187ee1f68","modified":1595250283359},{"_id":"themes/volantis/README.md","hash":"91f213a172dd9e57e4ef03c9151ad94ec1bb2690","modified":1595250283359},{"_id":"themes/volantis/_config.yml","hash":"60a22e1e4466394c9f658ff5d8d431358fec2f49","modified":1617842827217},{"_id":"source/_posts/db-w-r-dynamic.md","hash":"b00c324524f6c46d8928e6afbf08051b680f3fe4","modified":1617842826717},{"_id":"source/_posts/myblob.md","hash":"4be2ae2ed53c78f6c4d9ff29f83ad6c49836ad95","modified":1595250283322},{"_id":"source/_posts/hello-world.md","hash":"6b9c5669b13f4d29a510acd4c4ff046f3486bc5f","modified":1595250283322},{"_id":"themes/volantis/languages/en.yml","hash":"809cbd1198ff45440e2997a22be34ae94367f92d","modified":1595250283361},{"_id":"themes/volantis/languages/zh-CN.yml","hash":"2735c9942ba1ece0124cf65cbc2101a54eb3e0d6","modified":1595250283361},{"_id":"themes/volantis/languages/zh-TW.yml","hash":"99962c8d9b941b85395dc73d581aaf927b19275b","modified":1595250283361},{"_id":"themes/volantis/layout/404.ejs","hash":"805804c27fcdb07201d38162361c606a167b44e9","modified":1595250283362},{"_id":"themes/volantis/layout/_pre.ejs","hash":"bdbcf68e3f71df73bc59ffa5007d8fe800c5cdc1","modified":1595250283371},{"_id":"themes/volantis/layout/archive.ejs","hash":"39760a20302fe11b8e12a7e32665bbe8477ac204","modified":1595250283396},{"_id":"themes/volantis/layout/category.ejs","hash":"45345ffec8a9a737ffd767c4cce4dfed30930e20","modified":1595250283396},{"_id":"themes/volantis/layout/index.ejs","hash":"6fee00696b3de0b7440cf1b4c2c099f19c2580f8","modified":1595250283396},{"_id":"themes/volantis/layout/layout.ejs","hash":"f75179757fc587f0d26bce24c608077676dffe02","modified":1617842827257},{"_id":"themes/volantis/layout/links.ejs","hash":"1bebe4b632945d33f36e2fc446c48ff4dda65819","modified":1595250283397},{"_id":"themes/volantis/layout/page.ejs","hash":"e1285b47ace87cbcf0ab459ab2d51567e3d43bba","modified":1595250283398},{"_id":"themes/volantis/layout/list.ejs","hash":"5d1efdee83a9979996b34fc743ac957517be5bb4","modified":1595250283397},{"_id":"themes/volantis/layout/post.ejs","hash":"e1285b47ace87cbcf0ab459ab2d51567e3d43bba","modified":1595250283398},{"_id":"themes/volantis/layout/tag.ejs","hash":"ea2058e970a8a5c933c6b0180d8fc8f4985e6dea","modified":1595250283398},{"_id":"themes/volantis/layout/_cover/index.ejs","hash":"cdf5c5e17a57cda45fdb890c8f061f3f39202ca2","modified":1595250283362},{"_id":"themes/volantis/layout/_meta/author.ejs","hash":"6abae4a1e188d2f059b841d6f466c8b77918ab66","modified":1595250283363},{"_id":"themes/volantis/layout/_meta/btns.ejs","hash":"e4004bbb7a2bf46dfc95cd610822c0d58e7af6b7","modified":1595250283363},{"_id":"themes/volantis/layout/_meta/category.ejs","hash":"1a801cf409dc24fd4ea1f90c9941b74890a16ec3","modified":1595250283363},{"_id":"themes/volantis/layout/_meta/counter.ejs","hash":"65168cd369fd0ff442b07a7d84bca12bd68b37bf","modified":1595250283364},{"_id":"themes/volantis/layout/_meta/date.ejs","hash":"e18dd6f5ea703ebd7afe50d4e94fdce8e33e71b3","modified":1595250283364},{"_id":"themes/volantis/layout/_meta/share.ejs","hash":"d1aca13ece4278daf470e801b23b7546959a5b4e","modified":1595250283365},{"_id":"themes/volantis/layout/_meta/music.ejs","hash":"32e95a5ad95bf799b58ca9f4d595c201d64e372e","modified":1595250283364},{"_id":"themes/volantis/layout/_meta/tags.ejs","hash":"111c399d6b90e2cda99d9d846c60e0a65bcd7e2d","modified":1595250283365},{"_id":"themes/volantis/layout/_meta/thumbnail.ejs","hash":"8afd94949e88f7c0373974234c6f80ed858705c7","modified":1595250283365},{"_id":"themes/volantis/layout/_meta/title.ejs","hash":"fd8c7b0011d4e9c5b3aad4f3a0a058cb6c33c05c","modified":1595250283366},{"_id":"themes/volantis/layout/_meta/top.ejs","hash":"4e7f1b980942b15eb5b15e43d969c4a0d3ad921f","modified":1595250283366},{"_id":"themes/volantis/layout/_meta/updated.ejs","hash":"4e6ed816c7ff181c820d1976e4557bcfb1486bc2","modified":1595250283367},{"_id":"themes/volantis/layout/_meta/wordcount.ejs","hash":"6d75bcb787ce216b45830c52e3a69b0b2630110e","modified":1595250283367},{"_id":"themes/volantis/layout/_partial/archive.ejs","hash":"4f3ec993e4498d0a9cd6e3f9aa796cbf6e659571","modified":1595250283367},{"_id":"themes/volantis/layout/_partial/article.ejs","hash":"0ac0daa27fa74185837c7d25593400d1aab2a2e9","modified":1595250283368},{"_id":"themes/volantis/layout/_partial/categories.ejs","hash":"7c7b6cc39e1aa8d01cc2e94d1195bb7620bb68ea","modified":1595250283368},{"_id":"themes/volantis/layout/_partial/cover.ejs","hash":"5beb8271519bccc1297381effd5de7f6cbf3cd7d","modified":1595250283368},{"_id":"themes/volantis/layout/_partial/footer.ejs","hash":"5f52f4e182e5329366ff1120df83e84553d339e3","modified":1595250283369},{"_id":"themes/volantis/layout/_partial/head.ejs","hash":"ce965fcfe6109fa4a03491421651be1c6688c2b4","modified":1595250283369},{"_id":"themes/volantis/layout/_partial/header.ejs","hash":"1c6ce0c39a0d6f76df4205d8d922e052a93d3b0c","modified":1595250283370},{"_id":"themes/volantis/layout/_partial/meta.ejs","hash":"35a7ca48dda87e414abb924468a9dcdcac0aca00","modified":1595250283370},{"_id":"themes/volantis/layout/_partial/post.ejs","hash":"b4f9de79f5d153898685de976218c5ff10175d35","modified":1595250283370},{"_id":"themes/volantis/layout/_partial/scripts.ejs","hash":"0086a9122a2a18ab1ecb89740ac9127e3efac72e","modified":1595250283371},{"_id":"themes/volantis/layout/_partial/side.ejs","hash":"8fcd8edfaa77a9f2b8ec93268c9448e515b46254","modified":1595250283371},{"_id":"themes/volantis/layout/_third-party/aplayer.ejs","hash":"e520ca71b9c5a8b9eb383d82ca741efcc753ee47","modified":1595250283372},{"_id":"themes/volantis/layout/_third-party/clipboard.ejs","hash":"88266c917e7283a6c76c382ac5fa7507729d586e","modified":1595250283373},{"_id":"themes/volantis/layout/_third-party/comments.ejs","hash":"9b1910c8900b2e4f0fd97922a83a0143c88cad77","modified":1595250283373},{"_id":"themes/volantis/layout/_third-party/fancybox.ejs","hash":"43a218adabbb875f8052d552ec045c7844717f24","modified":1595250283374},{"_id":"themes/volantis/layout/_third-party/mathjax.ejs","hash":"7a041dc40a291f5e75ffdc6f9cd04f49ac00f475","modified":1595250283375},{"_id":"themes/volantis/layout/_third-party/share.ejs","hash":"c94992ac78cbf97858f0cebc4a239ac8ab9fca55","modified":1595250283375},{"_id":"themes/volantis/layout/_widget/blogger.ejs","hash":"a7762c1b189ba5a644d140a3dbf9206864505d3c","modified":1595250283390},{"_id":"themes/volantis/layout/_widget/_pre.ejs","hash":"be59b18c8816d469e2d24fa644d7dc105ed2f850","modified":1595250283376},{"_id":"themes/volantis/layout/_widget/copyright.ejs","hash":"de6870c3cc658c054012c0c700d3e0342de99251","modified":1595250283391},{"_id":"themes/volantis/layout/_widget/category.ejs","hash":"7295c87e3e095018d07af7941232b12970f0fcc5","modified":1595250283390},{"_id":"themes/volantis/layout/_widget/grid.ejs","hash":"6ceb91ad7fecbfaf86342a99656767c76bca357d","modified":1595250283391},{"_id":"themes/volantis/layout/_widget/group.ejs","hash":"28955bae655056275b5b6313a296c4601c9f421c","modified":1595250283392},{"_id":"themes/volantis/layout/_widget/header.ejs","hash":"b54a04af22efd55585af6e76ddbb7e856c5e9601","modified":1595250283392},{"_id":"themes/volantis/layout/_widget/list.ejs","hash":"eac7e6b422049eff92e2eaff892519c9058dc342","modified":1595250283393},{"_id":"themes/volantis/layout/_widget/load.ejs","hash":"ebfb18816e32dd657eb6ecdb91e8f885e9e6d85e","modified":1595250283393},{"_id":"themes/volantis/layout/_widget/music.ejs","hash":"92f156ef87392f7842c72540367ae452d85b2d63","modified":1595250283394},{"_id":"themes/volantis/layout/_widget/page.ejs","hash":"49ee453f2694a978dc159a39667e74d6b5b139e5","modified":1595250283394},{"_id":"themes/volantis/layout/_widget/qrcode.ejs","hash":"0209fc678cf2e7d0bf35be6a4b572598c150515d","modified":1595250283394},{"_id":"themes/volantis/layout/_widget/references.ejs","hash":"99621003f5c8ec8aac7cbbb10924b33c9e2a705d","modified":1595250283395},{"_id":"themes/volantis/layout/_widget/related_posts.ejs","hash":"92754a4f747299709cda4e32a1eecb6ec54265ef","modified":1595250283395},{"_id":"themes/volantis/layout/_widget/tagcloud.ejs","hash":"e58c16a7671a3575cfec7093a24267d97f84646f","modified":1595250283395},{"_id":"themes/volantis/layout/_widget/text.ejs","hash":"a6e2d9e52008b548e1863355d319504abb59fabb","modified":1595250283395},{"_id":"themes/volantis/layout/_widget/toc.ejs","hash":"14e2078fcee0dabc10f37be53a065a8d1932dcfc","modified":1595250283396},{"_id":"themes/volantis/scripts/events/index.js","hash":"a0f10031807f8c58c99085cfe95d850269ca709b","modified":1595250283399},{"_id":"themes/volantis/scripts/tags/btn.js","hash":"b89a1a6a889ed5b54b2d9a5c63493fa35934e3aa","modified":1595250283400},{"_id":"themes/volantis/scripts/tags/btns.js","hash":"84f9f17a2b73ab84d0a4e0980e393a00807db4ec","modified":1595250283400},{"_id":"themes/volantis/scripts/tags/checkbox.js","hash":"636cef0f4500a14b123c6b21187fb67989472cbd","modified":1595250283401},{"_id":"themes/volantis/scripts/tags/dropmenu.js","hash":"5af4b247d1c05681455a3538949a95486f65eea8","modified":1595250283401},{"_id":"themes/volantis/scripts/tags/fancybox.js","hash":"775cfaccf7fc77dc9cbebe64bddcfe68eeafef4b","modified":1595250283401},{"_id":"themes/volantis/scripts/tags/folding.js","hash":"13cde292311a8d00f5d149a171f3d0f3251e20da","modified":1595250283402},{"_id":"themes/volantis/scripts/tags/image.js","hash":"6b575b64f6e185583794c6bb38a3f2a6d92b3ca0","modified":1595250283402},{"_id":"themes/volantis/scripts/tags/media.js","hash":"ebe4a6ebe34e8d77c0652c63bd5f763439743eb2","modified":1595250283418},{"_id":"themes/volantis/scripts/tags/note.js","hash":"21b6180562952b425e884dad73af3728179fb675","modified":1595250283430},{"_id":"themes/volantis/scripts/tags/span.js","hash":"89aaa0678188aa85ec18116af4b036f80ca7c073","modified":1595250283430},{"_id":"themes/volantis/scripts/tags/tabs.js","hash":"c59daf8a06e3a355663b89a7ab5445cdec5384fd","modified":1595250283430},{"_id":"themes/volantis/source/css/style.styl","hash":"1495c9f380ef3767b77251dfbb30d2cefe78ca4d","modified":1595250283518},{"_id":"themes/volantis/source/fonts/Monaco.ttf","hash":"d4de9305ce9e916ece179c3ab3b1faf80cc52bbb","modified":1595250283519},{"_id":"themes/volantis/source/img/algolia.svg","hash":"f86c0288423ba1b62c3bde06fc38f031af56e5f6","modified":1595250283530},{"_id":"themes/volantis/source/img/azure.svg","hash":"9c42c8070528e28a97705fb410e65100632ae92b","modified":1595250283530},{"_id":"themes/volantis/source/img/baidu.svg","hash":"8f08ba555b4d8b262e2c3b7793dd169760f63880","modified":1595250283531},{"_id":"themes/volantis/source/js/app.js","hash":"ccc2c5bc1df54f416885c5d3cac04af754da9ee7","modified":1595250283532},{"_id":"themes/volantis/source/js/search.js","hash":"f350aa35ddd23a9ccfed7b43043dbb1f5b53964f","modified":1595250283533},{"_id":"source/_posts/db-w-r-dynamic/db1.png","hash":"e0b0e27ac757a07286dd4489837218d24b204d2e","modified":1595250283322},{"_id":"themes/volantis/scripts/events/lib/config.js","hash":"913154f487b0e49c5a7fb0f462ec7fa4c90e87cb","modified":1595250283399},{"_id":"themes/volantis/source/css/_base/index.styl","hash":"ee21eabcb9908fd01c23ae85eb8707f414c03ec7","modified":1595250283441},{"_id":"themes/volantis/source/css/_defines/color.styl","hash":"e597104a59416e7fb4d1572ff5fd0e67f297f964","modified":1595250283442},{"_id":"themes/volantis/source/css/_defines/effect.styl","hash":"065bc72deaea55a248bd1e022d92252f456d7036","modified":1595250283456},{"_id":"themes/volantis/source/css/_defines/fonts.styl","hash":"0234b03f71e7b0ee1c2f2bf48cd37737e2d0b5cd","modified":1595250283457},{"_id":"themes/volantis/source/css/_defines/func.styl","hash":"79aa375a4e3a6c6f2a0ec87fd85c547612296ecb","modified":1595250283458},{"_id":"themes/volantis/source/css/_defines/layout.styl","hash":"1643920e34312eb2f4321998aaacede68a1587db","modified":1595250283480},{"_id":"themes/volantis/source/css/_highlight/index.styl","hash":"53db45fefb84930d5d40ae439464295a2d2dbaad","modified":1595250283481},{"_id":"themes/volantis/source/css/_layout/archive.styl","hash":"67056065d1281bdd176aae97fef87f197d2e407d","modified":1595250283483},{"_id":"themes/volantis/source/css/_layout/article.styl","hash":"62d690ba78262ff5511ee5c491b5035fb2b257d7","modified":1595250283484},{"_id":"themes/volantis/source/css/_layout/cover.styl","hash":"a6db8065545e8620403a9795584cea6d10ee42c5","modified":1595250283485},{"_id":"themes/volantis/source/css/_layout/footer.styl","hash":"b1052db8e5460c825fff635cbed54d5f1bf38af1","modified":1595250283486},{"_id":"themes/volantis/source/css/_layout/friends.styl","hash":"8f5cc4d8ca1caec43fc9d257a1901322ab66e8a5","modified":1595250283487},{"_id":"themes/volantis/source/css/_layout/main.styl","hash":"6b8a19f8b820d3cce8c99f956d85dd5af500ba82","modified":1595250283488},{"_id":"themes/volantis/source/css/_layout/navbar.styl","hash":"6c1d481974c5f7285e967305db17fd53a196ec24","modified":1617842827287},{"_id":"themes/volantis/source/css/_layout/pagination.styl","hash":"9036915102a38c51f012929a6d7d5ce80c5db937","modified":1595250283490},{"_id":"themes/volantis/source/css/_layout/search.styl","hash":"1c59d6f1a45b30cc367716d340b06808a6cf5709","modified":1595250283491},{"_id":"themes/volantis/source/css/_layout/sidebar.styl","hash":"540b86a614b07955d6caea91a73f1e904141c1eb","modified":1595250283492},{"_id":"themes/volantis/source/css/_layout/toc.styl","hash":"e9d2f43c88d801fa0a4d06821a2fc0fb38e98005","modified":1595250283493},{"_id":"themes/volantis/source/css/_tag-plugins/btns.styl","hash":"a498b10986c6a0a5525753a965842d9dcf2dffdb","modified":1595250283504},{"_id":"themes/volantis/source/css/_tag-plugins/checkbox.styl","hash":"aa14bee36fb93f8dbfe2289ce3be79a42ace2f10","modified":1595250283505},{"_id":"themes/volantis/source/css/_tag-plugins/dropmenu.styl","hash":"95dee4693b259c2cf301732d02f62fc932438bda","modified":1595250283506},{"_id":"themes/volantis/source/css/_tag-plugins/folding.styl","hash":"f3fa87977eaeefb35bafd3de07a31028e2a1217b","modified":1595250283507},{"_id":"themes/volantis/source/css/_tag-plugins/media.styl","hash":"de97807507e324554608c890c7fb54aecfbffd7e","modified":1595250283508},{"_id":"themes/volantis/source/css/_tag-plugins/note.styl","hash":"d57d8bc39e1c357467948b76106921d5e6a88098","modified":1595250283509},{"_id":"themes/volantis/source/css/_tag-plugins/span.styl","hash":"d12727c02efc5cd36ab7878f1dedbbbc2a1d07b3","modified":1595250283510},{"_id":"themes/volantis/source/css/_tag-plugins/tabs.styl","hash":"c33b6d2d7094512819180c72d36101670ed491fd","modified":1595250283511},{"_id":"themes/volantis/source/css/_third-party/aplayer.styl","hash":"2aa314005ced93a5b5b6d9b7b26b613a2ad5cac7","modified":1595250283513},{"_id":"themes/volantis/source/css/_third-party/alert.styl","hash":"b70cf9bb91586c70c70238802165a56b4bee8004","modified":1595250283512},{"_id":"themes/volantis/source/css/_third-party/clipboard.styl","hash":"939053df26a187536414eccadc4114c7ad0e3532","modified":1595250283515},{"_id":"themes/volantis/source/css/_third-party/fancybox.styl","hash":"1a1cbcf39561eb1cf65528d1fe9113f081bce208","modified":1595250283516},{"_id":"themes/volantis/source/css/_third-party/mathjax.styl","hash":"67e530188e29139c63c2c5a296f210c8069b8ef6","modified":1595250283516},{"_id":"themes/volantis/source/css/_third-party/valine.styl","hash":"1655fd3d16c135024a04de8d41fcb10290773c68","modified":1595250283517},{"_id":"themes/volantis/source/fonts/Skranji-Regular.ttf","hash":"485dc033e34a5a92a45ffe5839514f0471b18208","modified":1595250283523},{"_id":"themes/volantis/source/js/valine.js","hash":"f1d97dc61c43d8f40599f35314f0573987fb0d91","modified":1595250283536},{"_id":"themes/volantis/source/fonts/Ubuntu-Regular.ttf","hash":"b100b2ed912a91e4d0a7c5f5309fe8ad7b3a2dd8","modified":1595250283529},{"_id":"source/CHAME","hash":"301f6e82d2220eefbfc7f7f4464ec99b5286fd0a","modified":1617842826707},{"_id":"source/CNAME","hash":"301f6e82d2220eefbfc7f7f4464ec99b5286fd0a","modified":1617842826707},{"_id":"source/_posts/blockingqueue.md","hash":"6565dab640803c1d82b37ec14191c2de697c4594","modified":1617842826707},{"_id":"source/_posts/completable-future.md","hash":"0c2a55e127bd6f8660d8dc698c45ac9088f2e115","modified":1617842826717},{"_id":"source/_posts/design-pattern-singleton.md","hash":"a035779fdc3e6a7c45297ed73b13cbdffb187f34","modified":1617842826727},{"_id":"source/_posts/executorservice.md","hash":"387c5b667a828241972544d39b54d35483a85a1e","modified":1626659292692},{"_id":"source/_posts/fork-join.md","hash":"5c4ee3107ee1746ff782f33fd266456c9cfe4408","modified":1617842826727},{"_id":"source/_posts/gc-log.md","hash":"8b7931316493275521aee6ec92ac7fdb32398b00","modified":1617842826737},{"_id":"source/_posts/futuretask.md","hash":"bb4bbbd63539722972c50144fc4d2ebd64256448","modified":1617842826737},{"_id":"source/_posts/hashmap.md","hash":"eb5f789f8fec3d9786cb2ed0e7240221ffaacb64","modified":1637648751471},{"_id":"source/_posts/java-aqs.md","hash":"38269a587bd0a3ba323ba5f06599d6ce2cd1442b","modified":1617842826767},{"_id":"source/_posts/jvm-optimization.md","hash":"e7acd15b9d3912b5dd891c8796dc21421ff835a5","modified":1617842826777},{"_id":"source/_posts/io.md","hash":"0f8c33513dc7d4fb65b5120efc907248a0a2c59e","modified":1617842826757},{"_id":"source/_posts/kafka-base.md","hash":"1c3f0f2edf6120190db8f113bd42d2ae4ab0f383","modified":1617842826787},{"_id":"source/_posts/kafka-messge-complete.md","hash":"757e75c0bdf72de05519109bb3a677f2560067cf","modified":1617842826787},{"_id":"source/_posts/kafka-muticustomerthread.md","hash":"84370f4350b345b9e70e0b8152500e3edd1b4f2f","modified":1617842826797},{"_id":"source/_posts/kafka-operation.md","hash":"1faf25e1fc31503392c473917a402441f77d7863","modified":1617842826797},{"_id":"source/_posts/limit-single.md","hash":"13799bdf1bf5db8b87f839bb38c8f7cbbc8fa162","modified":1617842826797},{"_id":"source/_posts/linux-netstat.md","hash":"283a96974629fc714f944300f252aab8642ef068","modified":1617842826807},{"_id":"source/_posts/mysql-count.md","hash":"2a2724da4c7526a1144768dfe5cc6470266d62f5","modified":1617842826837},{"_id":"source/_posts/linux-top.md","hash":"06c1bdb91adc940f92a0485f86f52acdb09f7e91","modified":1619744319974},{"_id":"source/_posts/mysql-explain.md","hash":"d16ffc8dc61dfa79cd94ec12a9f74c97f7c3429f","modified":1629766550559},{"_id":"source/_posts/mysql-index-single.md","hash":"b52df215b9a9bd28d46d3cf934307adf87fb04cb","modified":1617842826847},{"_id":"source/_posts/mysql-index-use.md","hash":"95b787db5b0251005acbdc73712f3c3ff7de405b","modified":1617842826867},{"_id":"source/_posts/mysql-index.md","hash":"3f1ebbf53aa2b1f0bb9612bddd77ffd5e2382694","modified":1617842826867},{"_id":"source/_posts/mysql-lock.md","hash":"aa8ad2ce8370f1a58e4362800ec5cc246665b8d1","modified":1617842826887},{"_id":"source/_posts/mysql-log.md","hash":"7afee6fb64b0d5256218b74c71ff8a11c28c5c8d","modified":1617842826897},{"_id":"source/_posts/mysql-masterslave-solve.md","hash":"2abcd0c123a3988b2d1b0715ee75429ac8db11ab","modified":1617842826907},{"_id":"source/_posts/mysql-mvcc.md","hash":"2a834ebf3fbff9b8580028dcf1ea540d33638ada","modified":1617842826907},{"_id":"source/_posts/redis-aop-limit-boot.md","hash":"22e3722d1e0c56e5306f4137f38a7d7e8e724691","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build-2.md","hash":"f46c5bdd9b1cacbce4a97070331b14efc1f096b2","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build.md","hash":"5d5558f73bcb8bd0d62648a52c26b01657f5e044","modified":1617842826937},{"_id":"source/_posts/redis-commons.md","hash":"4f6d387d262bd3acb2eae066d52e77fb2c95233c","modified":1617842826947},{"_id":"source/_posts/redis-data-type.md","hash":"4525fbe0bc5892b6819ec00d423898b2efb2f044","modified":1617842826947},{"_id":"source/_posts/redis-known.md","hash":"0bb12006c15ab35035e871ec77ca9edef24dfa6c","modified":1617842826957},{"_id":"source/_posts/redis-master-slave.md","hash":"c91ba100b8a6e59b4ed785dd0c126f04c25cec91","modified":1617842826957},{"_id":"source/_posts/redis-rdb-aop.md","hash":"be6c42065db57ee932efdea1d13cb9c21b0a8592","modified":1617842826967},{"_id":"source/_posts/redis-sentinel.md","hash":"3533178d64b1432eee4c39ce457ba79b0840e08a","modified":1617842826977},{"_id":"source/_posts/sharding-student.md","hash":"9d7449fc6301cd3ac039ae28892efa2accb2efd7","modified":1617842826977},{"_id":"source/_posts/shardingjdbc-reg.md","hash":"aaa21d25f387c14bb7707024db95f9abc88ba5aa","modified":1617842826987},{"_id":"source/_posts/shardingphere-problem.md","hash":"8b4e0adbed35fea3ba17a80fd33fbedbdb2f9eb5","modified":1617842826987},{"_id":"source/_posts/spring-extend.md","hash":"bb2cfd834935d8d2d73cd18344218fbeccd312fb","modified":1617842826997},{"_id":"source/_posts/spring-forbean.md","hash":"bfdd48208c55e8d394daa698beb6219aef9d2226","modified":1617842827007},{"_id":"source/_posts/springboot-custom-start.md","hash":"32e7179c03bb17b09b4b5f233b242a676f361200","modified":1617842827017},{"_id":"source/_posts/springcloud-1.md","hash":"6023de05bf1aa0ebfc14d237669c064edc3d1df0","modified":1617842827027},{"_id":"source/_posts/springcloud-2.md","hash":"4b230991c0b47123ccad58a215e4b892962271ba","modified":1617842827037},{"_id":"source/_posts/springmvc.md","hash":"9a9e15e55bfcaf9e975690e9805126ab9273dff7","modified":1617842827037},{"_id":"source/_posts/springmvc2.md","hash":"8921380354719a268dfacddc4dc90943a9b3130e","modified":1617842827057},{"_id":"source/_posts/sring-class.md","hash":"e4dea8aa07b9798189606d76122e5ba065fe348d","modified":1617842827077},{"_id":"source/_posts/synchronized-up.md","hash":"044aa2e13e0606c4cfe2ba98460bffbf20d4f375","modified":1617842827087},{"_id":"source/_posts/thread-interrupted.md","hash":"9afbdb2ba9ac476bc5f808db017b90a7116172a3","modified":1617842827107},{"_id":"source/_posts/threadlocal.md","hash":"75187e01e65dbed6990fdc45387a5dec600c6daa","modified":1617842827107},{"_id":"source/_posts/volatile.md","hash":"93407a5813ea0b239adfe0dfc604aca7d2939bde","modified":1617842827117},{"_id":"source/_posts/zookeeper-lock.md","hash":"f7a14280a45a5c85a2a26a6abe6ac1980235370d","modified":1617842827127},{"_id":"source/categories/index.md","hash":"b4f1a5e7cd7b7e254ca6bd061a4c46f42137d410","modified":1617842827137},{"_id":"source/tags/index.md","hash":"d38ed53cd835a3b4a90f4ad48c8fff2f3cdc81d0","modified":1617842827137},{"_id":"source/categories/index/index.txt","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1617842827137},{"_id":"source/tags/index/index.txt","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1617842827137},{"_id":"themes/volantis/source/img/default.cur","hash":"3381d41a9dcbb4c4e69559723481f85e2b8cf99e","modified":1617842827307},{"_id":"themes/volantis/source/img/pointer.cur","hash":"3adb643f97571f547021fb57b2d9d768a252d546","modified":1617842827307},{"_id":"source/_posts/blockingqueue/0.png","hash":"5efe3b81835c7c439ac393832bc94d280dc08ccb","modified":1617842826707},{"_id":"source/_posts/blockingqueue/1.png","hash":"706d0a431cbaa440a336173cf51678a4996ee473","modified":1617842826707},{"_id":"source/_posts/blockingqueue/3.png","hash":"3244b501e93cfbad236c456aeb1da81861327163","modified":1617842826717},{"_id":"source/_posts/blockingqueue/2.png","hash":"ed56711e743235cd50b30ae086eead64f2e337ce","modified":1617842826707},{"_id":"source/_posts/blockingqueue/4.png","hash":"3227d5bf94727d69d4795bd29c82dada24fa9818","modified":1617842826717},{"_id":"source/_posts/blockingqueue/6.png","hash":"3d8f8532f5a2816bd4d5541cde6f675e18ad18b3","modified":1617842826717},{"_id":"source/_posts/blockingqueue/7.png","hash":"c54a2e76935d39bb1e6b60a986ac3cae7e054426","modified":1617842826717},{"_id":"source/_posts/blockingqueue/5.png","hash":"13ee83e568c5e0c3733dba8fbb71f4f28e28eecf","modified":1617842826717},{"_id":"source/_posts/db-w-r-dynamic/AbstractRoutingDataSource.png","hash":"512e2e6fecac69a70840cc70722dfc02c504c455","modified":1617842826717},{"_id":"source/_posts/executorservice/1.png","hash":"3a4682b8288aea56f4318ab6145cdb6effa97583","modified":1617842826727},{"_id":"source/_posts/executorservice/1.jpg","hash":"283b9ab6fc7eff67a534e8eed0801ba379de9b38","modified":1617842826727},{"_id":"source/_posts/executorservice/3.png","hash":"40d81d94837d24b540bddbf732ca3b30051ca987","modified":1617842826727},{"_id":"source/_posts/futuretask/2.png","hash":"fda83c61771ca8c8b2c79397f8dbe50fb9c2dfd4","modified":1617842826737},{"_id":"source/_posts/gc-log/3.png","hash":"d1c91df081fdd9086d7baaf6a0c5492be4291f1c","modified":1617842826737},{"_id":"source/_posts/futuretask/1.png","hash":"a111c366b9a45fa298e137539cd5957291ab02c2","modified":1617842826737},{"_id":"source/_posts/gc-log/2.jpg","hash":"ad542328d4e5de941acb2a23b1259e7faf49f6ea","modified":1617842826737},{"_id":"source/_posts/hashmap/2.png","hash":"2cb5fa5e53f4d70d62fd01fb6166cf28a14c9ee6","modified":1617842826747},{"_id":"source/_posts/gc-log/4.png","hash":"ac6072dcb882aa5502bcc645a6fdfcb62154b1c1","modified":1617842826737},{"_id":"source/_posts/hashmap/4.png","hash":"a00f42064c6eae9c95ef8c7142c7f08a48edd11d","modified":1617842826747},{"_id":"source/_posts/io/2.png","hash":"1d2bc6c05645cb5960c0c9e3d92d1432fa02260e","modified":1617842826757},{"_id":"source/_posts/io/1.png","hash":"9402dda2b02714b552cb2d984a889277715dd5ab","modified":1617842826757},{"_id":"source/_posts/java-aqs/1.jpg","hash":"d75006e35829bce9dabb8bff79b3d8cf549783a7","modified":1617842826767},{"_id":"source/_posts/java-aqs/2.jpg","hash":"7963eafcf3d94f053c6402527b0a561a9ca34389","modified":1617842826767},{"_id":"source/_posts/java-aqs/1.png","hash":"c13b617e06e9e6b17ca36dd9a4b6d98e2cebe4dd","modified":1617842826767},{"_id":"source/_posts/java-aqs/3.jpg","hash":"c72369593396990ad186c629f165731dd35d2ea9","modified":1617842826777},{"_id":"source/_posts/jvm-optimization/4.png","hash":"9038f86e74d4b8171a7f977d4644220ca57a4dae","modified":1617842826777},{"_id":"source/_posts/jvm-optimization/1.png","hash":"f4b894336a9d58bf18edbd158935d59751786f3e","modified":1617842826777},{"_id":"source/_posts/jvm-optimization/3.png","hash":"ac9c07053f183fd8a0933aa5422170e33bb3e0fd","modified":1617842826777},{"_id":"source/_posts/jvm-optimization/6.png","hash":"10b2c564e4848a168aa3e416b5595e9375a49a65","modified":1617842826787},{"_id":"source/_posts/jvm-optimization/5.png","hash":"8b41811815d037aa4a61ebfe9a6ea92284e278bb","modified":1617842826777},{"_id":"source/_posts/kafka-base/3.png","hash":"3c247c08bf7d3d898a4a4d3c0d258a7b5ad2822d","modified":1617842826787},{"_id":"source/_posts/kafka-base/4.png","hash":"6712356b0e980ddc61b89255c8ba460257a8cdd2","modified":1617842826787},{"_id":"source/_posts/kafka-messge-complete/1.png","hash":"15601248b896ece38b6e2d38c043fa8c0832e30d","modified":1617842826787},{"_id":"source/_posts/kafka-base/2.png","hash":"a43939ffe6e5600199a91f4d8e1829b7809360d3","modified":1617842826787},{"_id":"source/_posts/kafka-messge-complete/2.png","hash":"45d7e5819528878cfe10df49ae48a495608fb7aa","modified":1617842826787},{"_id":"source/_posts/kafka-messge-complete/3.png","hash":"36c0d3146f92baadac31322df649422a59c3cfc9","modified":1617842826797},{"_id":"source/_posts/kafka-muticustomerthread/1.png","hash":"1b42338f1630c801a1e7ed6b32b2db146918a69b","modified":1617842826797},{"_id":"source/_posts/linkedHashMap/1.png","hash":"1c11a7a02b5e2bdffc040fdc6ba840ca03d1686b","modified":1617842826807},{"_id":"source/_posts/linkedHashMap/2.png","hash":"3b1c66a4483f4e616eb3919ded8d5d03b6fa437d","modified":1617842826807},{"_id":"source/_posts/linux-netstat/2.png","hash":"e40e1b480ed38713e32b9f671384496b8b1b8ce3","modified":1617842826817},{"_id":"source/_posts/linux-netstat/4.png","hash":"48bb93f74ed981b730813cce7e446a26d2d59b89","modified":1617842826817},{"_id":"source/_posts/linux-netstat/3.png","hash":"ac7cf1e40ac921ea6d8506658992f3f6c2ee9391","modified":1617842826817},{"_id":"source/_posts/linux-netstat/5.png","hash":"637b69dec456a83c060cfd58088823d1d3f7af2b","modified":1617842826817},{"_id":"source/_posts/linux-top/1.png","hash":"73e5dd02fb26ec42690de2f23e235a9a0b160ce6","modified":1617842826827},{"_id":"source/_posts/linux-top/3.png","hash":"0eb78426115f0d147234b6439b5e5d43be704910","modified":1617842826827},{"_id":"source/_posts/linux-top/2.png","hash":"2546bb8025ef05a9634387f3d8e1ab330dbdabe2","modified":1617842826827},{"_id":"source/_posts/linux-top/4.png","hash":"cb057751e28e7505c010f4a73c300fab50f93724","modified":1617842826827},{"_id":"source/_posts/linux-top/5.png","hash":"9bb01438c01bbac427fb7beab021e6e43846650f","modified":1617842826827},{"_id":"source/_posts/linux-top/6.png","hash":"396444e99f9157531f18f03306f4bea3642c8183","modified":1617842826827},{"_id":"source/_posts/mysql-explain/1.png","hash":"e0a148157bca31264cd139d82b078f3a32105370","modified":1617842826837},{"_id":"source/_posts/mysql-explain/11.png","hash":"b9c9db4c3f28bce4148b16c85ea0f0b4c193f7c3","modified":1617842826837},{"_id":"source/_posts/mysql-explain/10.png","hash":"723b17612c27bc7528c2574fbf8b2b17d7062219","modified":1617842826837},{"_id":"source/_posts/mysql-explain/12.png","hash":"612d2986eac25acd1a93d54def33c20502b57a9f","modified":1617842826837},{"_id":"source/_posts/mysql-explain/13.png","hash":"5ef2b16707384b1e46618781a6295adb11959bf9","modified":1617842826847},{"_id":"source/_posts/mysql-explain/2.png","hash":"f9766858f432eb4ea210913d15841e32c1296dee","modified":1617842826847},{"_id":"source/_posts/mysql-explain/3.png","hash":"2fb49c998c5c441144f770822a39cea0ff3b76c2","modified":1617842826847},{"_id":"source/_posts/mysql-explain/5.png","hash":"00bc3294472b3ad24e6c5a7efc34d08eb6552fb4","modified":1617842826847},{"_id":"source/_posts/mysql-explain/4.png","hash":"f1e4211a217a0f1e2591a22afb87e371d466f076","modified":1617842826847},{"_id":"source/_posts/mysql-explain/7.png","hash":"882d96312ae1a994d23ba3c2a5f93c2f8b8a9557","modified":1617842826847},{"_id":"source/_posts/mysql-explain/8.png","hash":"fad38b076519dcf2e46678ec8bf8dd6191c638d9","modified":1617842826847},{"_id":"source/_posts/mysql-explain/9.png","hash":"0686402a1d93025d80ab4a0b9b8bd48bef13bfff","modified":1617842826847},{"_id":"source/_posts/mysql-explain/6.png","hash":"3a86a6468bee06b62826b4b6e31d58f55aad5697","modified":1617842826847},{"_id":"source/_posts/mysql-index/5.png","hash":"34c2d39e25de753949c40b308bc14720fbc9dee4","modified":1617842826877},{"_id":"source/_posts/mysql-index/6.png","hash":"be29dafbbba51cadded9c50c8602169f16a42e4f","modified":1617842826877},{"_id":"source/_posts/mysql-index-single/1.png","hash":"c9f3596a49b492c6ba587497d4d00df0aa5680ca","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/2.png","hash":"e1aa45ba85c9740cd734035ec369b079b7f7c6c4","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/10.png","hash":"e9d0f6012dbbc64b30270bdfd96ba835962c3c9c","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/3.png","hash":"31cb0c3b4ac8639de69147403d55e165e501ca6f","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/7.png","hash":"24ea2cf8b38aa29485dd4643c74450a50621b8f8","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/6.png","hash":"5129bb4d3810f203f362b7f2bf36991d2b6a69ba","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/8.png","hash":"6e56a2abaf102799bf3198c6f8f3436b9b86141b","modified":1617842826857},{"_id":"source/_posts/mysql-lock/2.png","hash":"0adcfa90c5a8f52ca0aa57570c8fda2be66947ca","modified":1617842826897},{"_id":"source/_posts/mysql-lock/3.png","hash":"435d3d4888673dac7b2cd6663f45286a747f7387","modified":1617842826897},{"_id":"source/_posts/mysql-lock/5.png","hash":"3d916d5e030ba6282cc2d9209c2ecfb1ba24f8de","modified":1617842826897},{"_id":"source/_posts/mysql-lock/4.png","hash":"d19e8e93ed53ff9278857aec39a0c22691687e4e","modified":1617842826897},{"_id":"source/_posts/mysql-lock/6.png","hash":"52dd43e150fdba915712541333ab157182d1b4b9","modified":1617842826897},{"_id":"source/_posts/mysql-lock/8.png","hash":"2427f9d7dbf5b2f8677edb97eabff99ca3ab375c","modified":1617842826897},{"_id":"source/_posts/mysql-masterslave-solve/1.jpg","hash":"8b36c7c9a7aff09da128c6056e910133276a32b0","modified":1617842826907},{"_id":"source/_posts/mysql-mvcc/1.png","hash":"62e983218071cfade48ef493afe9fb828ab75b8b","modified":1617842826917},{"_id":"source/_posts/mysql-mvcc/2.png","hash":"065d56e599940faa50daa41f43f1526f5bd8e83d","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build/1.png","hash":"684e357612fccba91f3c261aaf0e0b67c05cea9e","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/10.png","hash":"900addde5c2b629f060a99f8640630ae6628e94c","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/3.png","hash":"b253f7fe18c6784a586e4b6ce9f16c27490e69fc","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/2.png","hash":"aa598a040798a15494cbe9b7005a9abc35f8c962","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/5.png","hash":"b31ca09270410b604344bce804f3a99d2bae4535","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/4.png","hash":"9b1271e1e5caf4231d9cec8f740eaa13158bc963","modified":1617842826937},{"_id":"source/_posts/redis-cluster-build/6.png","hash":"05693e37fbc379accc5b70add27c034cbae65d56","modified":1617842826947},{"_id":"source/_posts/redis-cluster-build/8.png","hash":"e299893a6c1496fb19d7ee730d94869f1a73d2b8","modified":1617842826947},{"_id":"source/_posts/redis-cluster-build/7.png","hash":"e7980bef26cc81a5807f04fe39956f000ac26eeb","modified":1617842826947},{"_id":"source/_posts/redis-cluster-build/9.png","hash":"856105fa0775abe10d445e322a24baa2784660bd","modified":1617842826947},{"_id":"source/_posts/redis-cluster-build-2/1.png","hash":"53ffddf403a4d26e9a24de4c7ed60058fdd81aaf","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build-2/2.png","hash":"81304c8a9087f6efd692b90fe897e650fa879906","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build-2/3.png","hash":"d9d1f25700a1b7872a3294bb20140be663a335de","modified":1617842826927},{"_id":"source/_posts/redis-cluster-build-2/4.png","hash":"342e3a623d9828c5b29e33960f75fcc61530397e","modified":1617842826927},{"_id":"source/_posts/redis-cluster-build-2/5.png","hash":"412648b61d5cdf2104894d66f62ee173bc38109f","modified":1617842826927},{"_id":"source/_posts/redis-cluster-build-2/6.png","hash":"e18fec49233eb866383c92df84cccae6731218fe","modified":1617842826927},{"_id":"source/_posts/redis-cluster-build-2/9.png","hash":"d92d64a7b127e888d3cc67856450248f9de58d1f","modified":1617842826937},{"_id":"source/_posts/redis-data-type/1.png","hash":"7d5fc065f85184510445c8100993f81aaed90095","modified":1617842826947},{"_id":"source/_posts/redis-data-type/3.png","hash":"a63c9b8d4194eb88e2898f890582ab2c3243e03f","modified":1617842826947},{"_id":"source/_posts/redis-data-type/2.png","hash":"b267cb522acd47056318e0b1181077cecbd93af7","modified":1617842826947},{"_id":"source/_posts/redis-data-type/4.png","hash":"5c1a19807fc9134cce58aac14f33422ddbabe859","modified":1617842826957},{"_id":"source/_posts/redis-data-type/5.png","hash":"96db1ca1407c9a79d39ffddd07c7af32612a281f","modified":1617842826957},{"_id":"source/_posts/redis-known/2.png","hash":"5653ea41f9fa3e5889860945d287d960476a6f06","modified":1617842826957},{"_id":"source/_posts/redis-known/1.png","hash":"c3b59a9ddc1bb1ce14c7aa28b169dac0e03297e3","modified":1617842826957},{"_id":"source/_posts/redis-master-slave/3.png","hash":"f627db51ddd50f68fa21e3bddf8e5ed3645fdf63","modified":1617842826967},{"_id":"source/_posts/redis-sentinel/1.png","hash":"0a5def8c5a790f12261f0a2d7bf9fcf0ca7b0478","modified":1617842826977},{"_id":"source/_posts/sharding-student/1.png","hash":"969c138fcf2d2ae8c083011da4473107fcab242d","modified":1617842826977},{"_id":"source/_posts/redis-sentinel/2.png","hash":"23b48b7cee91f9bad089f8f2b2a829d3ef814f9f","modified":1617842826977},{"_id":"source/_posts/sharding-student/3.png","hash":"1f4b4f7c349d8cf113bf973fc5333ce578b09ec8","modified":1617842826977},{"_id":"source/_posts/sharding-student/4.png","hash":"5ad4d9f93109ad3c683648f935d0be70f6a6364d","modified":1617842826977},{"_id":"source/_posts/shardingjdbc-reg/1.png","hash":"28b3eb91b0c4d3d6414862fb454e3fa8b3f31004","modified":1617842826987},{"_id":"source/_posts/spring-extend/1.png","hash":"208b77be0ca2c4386916695f0d0a9950a1ba35da","modified":1617842826997},{"_id":"source/_posts/spring-extend/3.png","hash":"5412c8b35c9f27cd2b64b2cc52ec1e6ff2a70d2f","modified":1617842826997},{"_id":"source/_posts/spring-extend/2.png","hash":"c2ef9b256068d6ced1dd89ee60b0e247a1df4e90","modified":1617842826997},{"_id":"source/_posts/springboot-custom-start/1.png","hash":"abcc5ad123604454dcb2e082cd5a9ca020152a81","modified":1617842827017},{"_id":"source/_posts/springboot-custom-start/2.png","hash":"b70ebadd1e9b3855ff890e7edfc6d4a5cc0e6782","modified":1617842827017},{"_id":"source/_posts/springboot-custom-start/4.png","hash":"7d07b83787c26f6aa47606c10332ab944321d2ca","modified":1617842827027},{"_id":"source/_posts/springboot-custom-start/5.png","hash":"0d1de503cb979be81d68b926432c60667c37b330","modified":1617842827027},{"_id":"source/_posts/springboot-custom-start/6.png","hash":"7eece3ad17a6a588d7f186632eda6310cbd51d6a","modified":1617842827027},{"_id":"source/_posts/springcloud-1/1.png","hash":"bef59875b49bcfee389e483f6a1c5910f31273ba","modified":1617842827027},{"_id":"source/_posts/springcloud-2/1.png","hash":"b6e339997ff3e3faba8a7f46e5b18150e2d63efc","modified":1617842827037},{"_id":"source/_posts/springmvc/2.png","hash":"36d372d40a4662102d10040b2058e134e66d9983","modified":1617842827047},{"_id":"source/_posts/springmvc/5.png","hash":"f655f0507e55e592d94a79a46d8220846026b63f","modified":1617842827057},{"_id":"source/_posts/springmvc/4.png","hash":"8badfc7b4a8e32b64ad5a1cda5e73ce1ded5a135","modified":1617842827047},{"_id":"source/_posts/springmvc/7.png","hash":"5b5aa2a37e3f7741444e8864a15b5a8350b6dac4","modified":1617842827057},{"_id":"source/_posts/springmvc2/10.png","hash":"10d853c5b61981adbd913aa1b5def022ab531cbc","modified":1617842827067},{"_id":"source/_posts/sring-class/1.jpg","hash":"f60f5483f0e7d0b8ad27fd320e356198603f3177","modified":1617842827077},{"_id":"source/_posts/sring-class/2.jpg","hash":"f23f793c0ccde9bf19502b79ae634c8262431e5f","modified":1617842827087},{"_id":"source/_posts/sring-class/4.png","hash":"5007fe666463ec229d2e4d5805281f462355b75e","modified":1617842827087},{"_id":"source/_posts/synchronized-up/1.jpg","hash":"4b096854decabb8c19d717d9e84e49bc02a3360c","modified":1617842827087},{"_id":"source/_posts/synchronized-up/6.png","hash":"d0a9ebec0a968cd3d37a68f11654c897e1f54bf1","modified":1617842827107},{"_id":"source/_posts/volatile/2.png","hash":"87caef509ec0ee6d8d852fc446a56e10018574cc","modified":1617842827127},{"_id":"source/_posts/zookeeper-lock/1.png","hash":"78e0866ada3a68c6eddbacad6ab5998f065cef56","modified":1617842827127},{"_id":"source/_posts/zookeeper-lock/2.png","hash":"dc7d2b0d8fb619856c189c035b4223ff5e08e23f","modified":1617842827127},{"_id":"source/_posts/zookeeper-lock/3.png","hash":"fa9549485e0509604e585b32c3a35dea17ab78c8","modified":1617842827127},{"_id":"source/_posts/executorservice/4.png","hash":"91149d5c4ee2014b517540877336ca6ef510294e","modified":1617842826727},{"_id":"source/_posts/gc-log/1.jpg","hash":"f576808db7c258888e0c4b961066219e3eacda51","modified":1617842826737},{"_id":"source/_posts/java-aqs/2.png","hash":"17106cdf8abc13e7404989b489084e29e2151caa","modified":1617842826767},{"_id":"source/_posts/kafka-base/1.png","hash":"d531dad10c13bca4d48dd6ffdd62443dc22ee3e9","modified":1617842826787},{"_id":"source/_posts/limit-single/2.png","hash":"fab361dd8d9049acb285b3afd9becb4d7c4b7eae","modified":1617842826807},{"_id":"source/_posts/limit-single/1.png","hash":"79174ff831d95783ef983cb161914319e8aa53bf","modified":1617842826797},{"_id":"source/_posts/linux-netstat/6.png","hash":"2813d5df686053cef0e10a717ef952b1d0a480b1","modified":1617842826827},{"_id":"source/_posts/mysql-explain/14.png","hash":"d75a58d8ed4fd012f962d8d7317981f929cdf9d6","modified":1617842826847},{"_id":"source/_posts/mysql-index/1.png","hash":"d3ea95f9a94a36a972f3bf46173b20045a5f4c88","modified":1617842826867},{"_id":"source/_posts/mysql-index/2.png","hash":"8bbaf9d18a8d0c8043000923c77c9983af0a8c8c","modified":1617842826867},{"_id":"source/_posts/mysql-index/3.png","hash":"9174ec848d4fdf797ab730a379b7a2fc4e32f93f","modified":1617842826877},{"_id":"source/_posts/mysql-index-single/4.png","hash":"397358c3fcd12febc42c138639474d851995a249","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/5.png","hash":"fd0f98c5315e33c21f7345f26f7becee6f98191c","modified":1617842826857},{"_id":"source/_posts/mysql-index-single/9.png","hash":"08c706d872e5166067b6c5c019c865cf395750c8","modified":1617842826867},{"_id":"source/_posts/redis-aop-limit-boot/1.png","hash":"79174ff831d95783ef983cb161914319e8aa53bf","modified":1617842826917},{"_id":"source/_posts/redis-aop-limit-boot/2.png","hash":"fab361dd8d9049acb285b3afd9becb4d7c4b7eae","modified":1617842826917},{"_id":"source/_posts/redis-cluster-build-2/8.png","hash":"55479153d8d624a5ab1ce600d2873438cf326302","modified":1617842826927},{"_id":"source/_posts/redis-cluster-build-2/7.png","hash":"c4bcd50ed8860b29e70113f2135596ba1c3043c7","modified":1617842826927},{"_id":"source/_posts/redis-master-slave/1.png","hash":"7c944848d609b32c54dc41dd12229e02b7a073e3","modified":1617842826967},{"_id":"source/_posts/redis-master-slave/2.png","hash":"efafddee4293ed2ffa9c83fd69cba447a36b3cd3","modified":1617842826967},{"_id":"source/_posts/redis-rdb-aop/1.png","hash":"7c944848d609b32c54dc41dd12229e02b7a073e3","modified":1617842826967},{"_id":"source/_posts/shardingjdbc-reg/2.png","hash":"60cd868c22211019331342266a00937d29f5db38","modified":1617842826987},{"_id":"source/_posts/shardingphere-problem/2.png","hash":"4ade0a4a28428211126978a3e52979bb85eca8f0","modified":1617842826997},{"_id":"source/_posts/spring-extend/4.png","hash":"627e82ae73a943379d62dcad307274d2290bb601","modified":1617842827007},{"_id":"source/_posts/spring-forbean/1.png","hash":"f01c0cc64977367829d830d848610ad05e410846","modified":1617842827007},{"_id":"source/_posts/spring-forbean/5.png","hash":"01c0a43780757c3a953d59190613903d71939c96","modified":1617842827017},{"_id":"source/_posts/springcloud-2/Hystrix.png","hash":"933e4df680f8f681a3934bf9a666ecd6faef7258","modified":1617842827037},{"_id":"source/_posts/springmvc/10.png","hash":"7c4d83765f9f74b84861cf806ee8170bdea9d00f","modified":1617842827047},{"_id":"source/_posts/springmvc/6.png","hash":"7bacf148e1e82022d616a8989b6d02cc8582d71c","modified":1617842827057},{"_id":"source/_posts/springmvc/8.png","hash":"b83b77cfd02de2607eaff64828a0c06ae7b3972f","modified":1617842827057},{"_id":"source/_posts/springmvc2/11.png","hash":"7aca834d553f182df1bb89b72df61bf0a719ce3a","modified":1617842827067},{"_id":"source/_posts/springmvc2/13.png","hash":"6fcc61bec3de669e69f07524e6b17098cda5bc29","modified":1617842827067},{"_id":"source/_posts/sring-class/1.png","hash":"6be2302b416e6a29b41da1531c34281565f4a721","modified":1617842827087},{"_id":"source/_posts/threadlocal/4.png","hash":"f6e5dbb559dc1f7b7ae5dc02f09cdb2d87ba08fc","modified":1617842827117},{"_id":"source/_posts/threadlocal/2.png","hash":"8cc5585a4ddc1e81e11a35d3401ab7058444fc70","modified":1617842827107},{"_id":"source/_posts/threadlocal/5.png","hash":"d42aeff70c69f488dbca9450c891665efd17f604","modified":1617842827117},{"_id":"source/_posts/threadlocal/6.png","hash":"d0c160d22ac14324d20a4dbde468d530d20edd9e","modified":1617842827117},{"_id":"source/_posts/volatile/1.png","hash":"128c34f5c3b398cf0efdc4bb14c626761d1ff13b","modified":1617842827127},{"_id":"source/_posts/mysql-index/4.png","hash":"c84c1987cc47d6f36ae8ddcfbcfca68ebbf3f2a2","modified":1617842826877},{"_id":"source/_posts/mysql-index/7.png","hash":"92bf4b898e3501d626f0bee5e5614a6682a89bf6","modified":1617842826877},{"_id":"source/_posts/mysql-index-use/1.png","hash":"63057fb1deb7fa27ab2c73779a742874a3ec13b5","modified":1617842826867},{"_id":"source/_posts/mysql-lock/7.png","hash":"0603105790a687ab19ec220563de68ec27b11cf5","modified":1617842826897},{"_id":"source/_posts/redis-rdb-aop/3.png","hash":"974dda74335d942120861d44655c705807427c88","modified":1617842826967},{"_id":"source/_posts/sharding-student/2.png","hash":"225583b10cda9550c62b3c6d803c8bbd611420f9","modified":1617842826977},{"_id":"source/_posts/shardingphere-problem/1.png","hash":"9b6a021f9cc3075bac7fa77766ea4cd9665ac645","modified":1617842826997},{"_id":"source/_posts/spring-forbean/1.jpg","hash":"f57e001a46ea900febb2bc28dfa1eaaa46e9c686","modified":1617842827007},{"_id":"source/_posts/springmvc2/12.png","hash":"1f41a0a5ae46cfc3ba5550d8595ca4425935ca77","modified":1617842827067},{"_id":"source/_posts/springmvc2/14.png","hash":"97e3e2e2cae20302c1db05d7b0dfe5d12215de77","modified":1617842827067},{"_id":"source/_posts/sring-class/3.png","hash":"256ff4a2a75e539ca9a24d8aaff92c7a675ca30c","modified":1617842827087},{"_id":"source/_posts/threadlocal/1.png","hash":"138bfe43bc2548b17b22b416c905551bf90fc879","modified":1617842827107},{"_id":"source/_posts/io/3.png","hash":"28049a44fae989f2e1064c513ac693787e085429","modified":1617842826757},{"_id":"source/_posts/jvm-optimization/2.png","hash":"190f2e044a6baf14da40fc8df3262577b5a9875f","modified":1617842826777},{"_id":"source/_posts/mysql-index/8.png","hash":"764bd50903b85cbfc9c14d2fd36e6e1377b50fc2","modified":1617842826887},{"_id":"source/_posts/redis-rdb-aop/2.png","hash":"fa15ad2b45c316c9e7262882d877401cdfa7d678","modified":1617842826967},{"_id":"source/_posts/spring-forbean/2.png","hash":"7ba2d137e4613ba1d6dca98bf22fcc6d3652e5d8","modified":1617842827007},{"_id":"source/_posts/spring-forbean/4.png","hash":"8b46904f55c3af297eb4727b39fc5b0685867c88","modified":1617842827017},{"_id":"source/_posts/springboot-custom-start/3.png","hash":"c038091fde608162d3412d3f71517ad66f2de3eb","modified":1617842827027},{"_id":"source/_posts/springboot-custom-start/7.png","hash":"fdb6365de751bf2944c2860dff54f869c3dd3c8e","modified":1617842827027},{"_id":"source/_posts/springmvc2/15.png","hash":"4f95e32fa55772ee20d816ada0acff48b8841a65","modified":1617842827077},{"_id":"source/_posts/springmvc2/16.png","hash":"e8c121887f8a46a819f6357565ce4ae9a230f0b8","modified":1617842827077},{"_id":"source/_posts/hashmap/3.png","hash":"4643087f458887d5743069f90e1691642a47ae6f","modified":1617842826747},{"_id":"source/_posts/hashmap/1.png","hash":"d7c240371f349cc0a84411bb72dfcb9a0eaa2d8b","modified":1617842826747},{"_id":"source/_posts/io/4.png","hash":"e706080387623abcbce59b0853564c411812fc6d","modified":1617842826767},{"_id":"source/_posts/springmvc/9.png","hash":"d7c1d85109edd964cb9b5a74b43124e849a60562","modified":1617842827057},{"_id":"source/_posts/threadlocal/3.png","hash":"b78663c288f6015f002fa1b2cdb93a1f87dad055","modified":1617842827117},{"_id":"source/_posts/mysql-explain/1.jpg","hash":"127cba4a5ff20fca3c34ab946c0c2af3f97bf0dc","modified":1617842826837},{"_id":"source/_posts/mysql-log/1.png","hash":"b697a4d816c99d0a275ecea99302f3a5d508170b","modified":1617842826907},{"_id":"source/_posts/mysql-log/2.png","hash":"b0311c9c6a1ac5aad8bbb34f123db0e6131857a3","modified":1617842826907},{"_id":"source/_posts/spring-forbean/3.png","hash":"a5b9516ad74ad7424cd8fa8a6fe3b4a940b78351","modified":1617842827017},{"_id":"source/_posts/springmvc/3.png","hash":"b1fce291dcc78db58788e58e9c585475014d2833","modified":1617842827047},{"_id":"source/_posts/synchronized-up/4.png","hash":"b28b3266ec5e47c8c04744bd5d4b22dfccdf8f27","modified":1617842827097},{"_id":"source/_posts/synchronized-up/3.png","hash":"9e4849d1fac3ff7e76c653d6d78dae28d23355cb","modified":1617842827097},{"_id":"source/_posts/executorservice/2.png","hash":"094bb1fb6515174badd053a02f493cf7ed252c01","modified":1617842826727},{"_id":"source/_posts/synchronized-up/2.png","hash":"0b636cb6389f04aa5d5649588fa2aabe8917e727","modified":1617842827087},{"_id":"source/_posts/synchronized-up/5.png","hash":"c997c59d5468ce4f709917e7ac7975b56e816605","modified":1617842827097},{"_id":"source/_posts/hashmap/5.png","hash":"5be06150681a29d113a9db3dbf6bb5c268382460","modified":1617842826757},{"_id":"source/_posts/linux-netstat/1.png","hash":"ef984b3b670eac9b4425a87979db0dc9e6edae48","modified":1617842826817},{"_id":"source/_posts/springmvc/1.png","hash":"f97a46fefebc780e4a5f543058dc5b6e7152a903","modified":1617842827047},{"_id":"source/_posts/mysql-lock/1.png","hash":"2a84e5eadda98e728c1727e6eb1f24e9d5b51398","modified":1617842826887},{"_id":"source/_posts/blockchain-1.md","hash":"0888fb07fc501a0a556361df9c482516dca8d5fb","modified":1623036015938},{"_id":"source/_posts/elasticsearch-01.md","hash":"9a9288f3623ab49288b76701861070f256b9728b","modified":1619267355104},{"_id":"source/_posts/influxdb-1.md","hash":"d127fb1afc66c4444a2b8aa5145041a8247efddc","modified":1619744891109},{"_id":"source/_posts/docker-redis.md","hash":"398a41c4dbc156bfd22635a4c6feebef62eca283","modified":1623978927673},{"_id":"source/_posts/docker-study.md","hash":"3b55e936148eadef6e3eee9276a78e181ac99aa2","modified":1633786550014},{"_id":"source/_posts/go-pointer.md","hash":"4926b59a2c13c3ce4883342ee28148910a2ad6ea","modified":1637306226487},{"_id":"source/_posts/go-study-01.md","hash":"22cc4a2ff29503809c61cccaa4f6da2ecb819b6f","modified":1637648751468},{"_id":"source/_posts/rust-node-1.md","hash":"4e968a400432bf1ea4268bc43ec0d0a5e92f7b18","modified":1624257182868},{"_id":"source/_posts/solidity.md","hash":"2b7f0c614374c8fc75e916d2525edc6c1d5bbbaa","modified":1632057287967},{"_id":"source/_posts/go-study-01/1.png","hash":"b770e4ca2a8968347213686f7ce5246cf441f78e","modified":1637648751469},{"_id":"source/_posts/go-study-01/2.png","hash":"18b6014911463fbddb0ef5ee65badd6edb6fee5f","modified":1637648751469},{"_id":"source/_posts/go-pointer/1.png","hash":"f43eb962738647a211080a5c74dd79be59b933ce","modified":1637302969598},{"_id":"source/_posts/go-study-01/3.png","hash":"5327dad3dc7977ac4b7d15f1c97294b2b021fef0","modified":1637648751470},{"_id":"source/_posts/go-pointer/2.png","hash":"47b77c3c51073d8e98ef1a9dcacd79fd443903f0","modified":1637305315428},{"_id":"source/_posts/go-study-01/4.png","hash":"3156a3a5bd07ac5d43cff196c5eebf40de5d2df0","modified":1637648751470},{"_id":"source/_posts/go-study-01/5.png","hash":"513dd952b1aa49d43875903bb0586149171335b4","modified":1637648751470},{"_id":"source/_posts/go-pointer/3.png","hash":"31f29c33776040af4a5a345966b2e2a3a12c33a7","modified":1637305689830},{"_id":"public/tags/index.html","hash":"297344778f7eee10c8923fae3660fda006c08fe5","modified":1637648791194},{"_id":"public/categories/index.html","hash":"3c580ae3d6020182c000aa6d84087783b97cedba","modified":1637648791194},{"_id":"public/2021/11/12/go-pointer/index.html","hash":"506a4bbce853156f19e87c53021f9d5e88bec9f7","modified":1637648791194},{"_id":"public/2021/05/30/solidity/index.html","hash":"d8fb67be7a304f80b92ab3d112a0350372a5c65e","modified":1637648791194},{"_id":"public/2021/04/24/elasticsearch-01/index.html","hash":"437714cef0e3ff489e387edad050f6aac197c27e","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/index.html","hash":"cfd103126d34fbebf755917fe5b30774d20d9b93","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/index.html","hash":"586853f70535518e771d9071a72254941c0f6f35","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/index.html","hash":"a25270b3a1b6507c6759f969610b8b8f10eac7a5","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/index.html","hash":"f562c667da8cf5303152e9a55d9a0b1fbb730616","modified":1637648791194},{"_id":"public/2020/07/20/db-w-r-dynamic/index.html","hash":"da3f5cad058aa74a39814039ffda6a87f2a8e674","modified":1637648791194},{"_id":"public/archives/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/2020/index.html","hash":"45eef648cf6e61ee874c553a0a6ee313bcddbdba","modified":1637648791194},{"_id":"public/archives/2020/07/index.html","hash":"444fcb4575b71cdb06571ddc6c2953d2b8f81fb6","modified":1637648791194},{"_id":"public/tags/mysql/index.html","hash":"bcff1015e56765d14143391b8a31d8c09643fe57","modified":1637648791194},{"_id":"public/tags//index.html","hash":"8ef41c90fd373bb474677601bef63b6d6258c65f","modified":1637648791194},{"_id":"public/index.html","hash":"a8c02f8bc8e5a4891dd771c832fe14619ee06a83","modified":1637648791194},{"_id":"public/tags/index/index.txt","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1637648791194},{"_id":"public/categories/index/index.txt","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1637648791194},{"_id":"public/2021/02/02/shardingjdbc-reg/index.html","hash":"1dca3cc8bc2634580b86259339165bd200beafd4","modified":1637648791194},{"_id":"public/2021/02/02/shardingphere-problem/index.html","hash":"5d869e0dfc7de5e798a97b5c250276c06861603c","modified":1637648791194},{"_id":"public/2021/02/10/influxdb-1/index.html","hash":"d02509db6726eb6fbedf535e789b73419c77efbb","modified":1637648791194},{"_id":"public/2021/01/09/sharding-student/index.html","hash":"40f30cfa6d2141e4827fd620e4adf21424d17029","modified":1637648791194},{"_id":"public/2021/01/02/springcloud-2/index.html","hash":"037cf6d16b3c0a3970547a18ba7fdd5b08c6c7d6","modified":1637648791194},{"_id":"public/2021/01/01/springcloud-1/index.html","hash":"d10e9e8feb10df88a5987f17116dd29912d3ace2","modified":1637648791194},{"_id":"public/2020/12/02/kafka-messge-complete/index.html","hash":"bc81518078af87e10f471dcfcec94a006c33b01a","modified":1637648791194},{"_id":"public/2020/12/10/io/index.html","hash":"40d2eade731bd355b8f78dbde7740c96c7f8f734","modified":1637648791194},{"_id":"public/2020/12/17/redis-known/index.html","hash":"d343aa9ce0fee19515564a7150c3f1d6be84a38b","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/index.html","hash":"0817b5b1e8792cebff19fee02016ee475e163df8","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/index.html","hash":"b9f17a17d5c0aee9dcb8ebf5cbabffa2fe9d8fd3","modified":1637648791194},{"_id":"public/2020/10/30/blockchain-1/index.html","hash":"eb42c172f7ef18283187ab8a1b273febaaf5b0b2","modified":1637648791194},{"_id":"public/2020/10/09/kafka-base/index.html","hash":"50070d36e70f7e760f0723bc07e8c26c990ee8b4","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/index.html","hash":"6de2e00255d8e5545e983896899c017d1f042f1b","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/index.html","hash":"c99d3086f22e706cd85bdf73ca50f5be38a09756","modified":1637648791194},{"_id":"public/2020/09/13/spring-extend/index.html","hash":"8f0358263449e1671aec41de4f97e18f26312252","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/index.html","hash":"69200fc34a11465edd187c2263f19f7970c42972","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/index.html","hash":"0c53667d2ec777899951755bfbf7b04e34073292","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/index.html","hash":"a7f15b3c704ea966aadc997568fbe8f90d54a895","modified":1637648791194},{"_id":"public/2020/08/30/mysql-mvcc/index.html","hash":"4e3981d0ec13ccefb2ebb6f3088d667db0fc1beb","modified":1637648791194},{"_id":"public/2020/08/27/zookeeper-lock/index.html","hash":"1ab7689e3386ee0dd27071ff84e6fef7556f02b9","modified":1637648791194},{"_id":"public/2020/08/27/thread-interrupted/index.html","hash":"0bdb23da8bfff76087f44eb5a10445ec82459792","modified":1637648791194},{"_id":"public/2020/08/26/redis-rdb-aop/index.html","hash":"65ce19a8caa6a91aa38d21ad0a3201501fae5728","modified":1637648791194},{"_id":"public/2020/08/19/mysql-masterslave-solve/index.html","hash":"530522edaf807975b31b5b0d27f45bbd24b1d7ec","modified":1637648791194},{"_id":"public/2020/08/20/redis-master-slave/index.html","hash":"d015b91480da9a65b91a9f463f5ab04115b8811a","modified":1637648791194},{"_id":"public/2020/08/14/redis-sentinel/index.html","hash":"18152b10bf958b223176454e8135c3e2cae9ec13","modified":1637648791194},{"_id":"public/2020/08/14/rust-node-1/index.html","hash":"bbecf1db149a8495483940af62b5345001582850","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/index.html","hash":"e1e9605b2a740068490a9213137dd1e49e32935c","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/index.html","hash":"c1a8ec7b44d268d630c51a0f48d1736ea8ae4735","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/index.html","hash":"afbe67b29321cde164540b9f7801129f5186ae43","modified":1637648791194},{"_id":"public/2020/07/30/fork-join/index.html","hash":"93380cc27fbe0c81868665e655dce693df466ea8","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/index.html","hash":"123aace2f73080e69b3ebea0170153a45b136687","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/index.html","hash":"af2282404063a7c1f773bbef5e51768eafab91eb","modified":1637648791194},{"_id":"public/2020/01/26/mysql-count/index.html","hash":"f3813f634bcaa4f2490bb80f44e3a88dd8de4c4d","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/index.html","hash":"7419bb9e088465fce75487e1f8405ca493076ef8","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/index.html","hash":"c86a81b343305c7fcc5e99f64c77f5c2adc7cb5d","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/index.html","hash":"437ffe053c55ca3aea938ceaba64a1704b9ef02c","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/index.html","hash":"2251a3420d26bb98b36e21e02f5608d56cfab033","modified":1637648791194},{"_id":"public/2019/11/16/kafka-operation/index.html","hash":"b019707d324cb9ad7d51675f7485e688d23962b4","modified":1637648791194},{"_id":"public/2019/10/03/redis-commons/index.html","hash":"2a1123ed13027d8f3c727655e7ccc5c4aea97ddf","modified":1637648791194},{"_id":"public/2019/11/15/kafka-muticustomerthread/index.html","hash":"8abad8742af924b81d525f59904c54c1aba3a075","modified":1637648791194},{"_id":"public/2019/07/18/completable-future/index.html","hash":"c7af3bb2ecbadcc7a92902933b37eb39a0bd7b76","modified":1637648791194},{"_id":"public/2019/07/18/design-pattern-singleton/index.html","hash":"bf7381d8a79ed6563bdb2d79616a06be1497e7ca","modified":1637648791194},{"_id":"public/2019/07/18/futuretask/index.html","hash":"15820bf56afeb4819e306af1057dadda549a88e0","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index-use/index.html","hash":"bc187a7e4b4f69face56f8e8cb4d231c828b35ed","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/index.html","hash":"ca65c25de6e7fa048b13b5ada8f969f14044aa28","modified":1637648791194},{"_id":"public/2019/07/18/volatile/index.html","hash":"c6d69e9935d977eb2fcf355f9e23bbdf3fc482f8","modified":1637648791194},{"_id":"public/2019/07/18/docker-study/index.html","hash":"215d7e97e6de8cb37be156a35fc92d328075b477","modified":1637648791194},{"_id":"public/2019/07/18/docker-redis/index.html","hash":"f3f3e2bb72d24fb85bdf7b179233586e8251ca22","modified":1637648791194},{"_id":"public/2019/02/18/gc-log/index.html","hash":"1fe99e2fb67121bef47707cd4c0b8a9e799ec95f","modified":1637648791194},{"_id":"public/2019/02/18/limit-single/index.html","hash":"ab272b37aaa3c1e31cf23a54b903f7f0e9b056b7","modified":1637648791194},{"_id":"public/2019/02/18/redis-aop-limit-boot/index.html","hash":"ad03773d3e80436d00703b198789afd272dd1c8f","modified":1637648791194},{"_id":"public/2018/08/07/mysql-log/index.html","hash":"e1efc22d09c17bc57e1f673e575e420b69138a52","modified":1637648791194},{"_id":"public/archives/page/2/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/index.html","hash":"eee7db3cd458419e2285bea672f8b8106e3c61f1","modified":1637648791194},{"_id":"public/archives/page/3/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/page/4/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/page/5/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/page/6/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/page/7/index.html","hash":"9fb9c2e7a397d8c70b133330c6772057416b2018","modified":1637648791194},{"_id":"public/archives/2018/index.html","hash":"d8f9c18e0994242f8bc6724dff6e11039c0c1a87","modified":1637648791194},{"_id":"public/archives/2018/01/index.html","hash":"1595bfc792143e6ace90bfdcb8e4a3835b598f0f","modified":1637648791194},{"_id":"public/archives/2018/08/index.html","hash":"fc37c236cde37d5bafa79c607c9026a97d8bcb79","modified":1637648791194},{"_id":"public/archives/2019/index.html","hash":"70d1c41f7a1efd737f465c13883d0dc8b1eadbc2","modified":1637648791194},{"_id":"public/archives/2019/page/2/index.html","hash":"85d479ebfbc618c20e19d49bcfb6d2b4bd6425e3","modified":1637648791194},{"_id":"public/archives/2019/02/index.html","hash":"013d07db6601c74598c7eb42ce64499ba26e2efe","modified":1637648791194},{"_id":"public/archives/2019/07/index.html","hash":"3e554a96a63ffc98d4ffcffc29e97e6cca3ad30b","modified":1637648791194},{"_id":"public/archives/2019/10/index.html","hash":"337a606e083a1b1974f8a566f9273baeccdbc8dd","modified":1637648791194},{"_id":"public/archives/2019/11/index.html","hash":"4d70649d0989881b794982bc02083b5ae0f89145","modified":1637648791194},{"_id":"public/archives/2020/page/3/index.html","hash":"0f89d6bb1200dc941ca0d8a4e99035a02313566d","modified":1637648791194},{"_id":"public/archives/2020/page/2/index.html","hash":"6955e6ad7eb4156900553dc9d275b67406186935","modified":1637648791194},{"_id":"public/archives/2020/page/4/index.html","hash":"f7879a3181be8d0900d92565263bcbd429136c28","modified":1637648791194},{"_id":"public/archives/2020/01/index.html","hash":"629c13909f5cdda3f29df1057d783a97a66c6e7c","modified":1637648791194},{"_id":"public/archives/2020/05/index.html","hash":"8636f3b3e8a0b13b5585a7b6078285533daa24d9","modified":1637648791194},{"_id":"public/archives/2020/08/index.html","hash":"65c46679e23c23df55f4c7dac77ca0cd1486c703","modified":1637648791194},{"_id":"public/archives/2020/09/index.html","hash":"8fe9995f2de2cc21e5d52959ce74355b1e018189","modified":1637648791194},{"_id":"public/archives/2021/index.html","hash":"e04f301a0b813cfe31358a49720a50d718e8725c","modified":1637648791194},{"_id":"public/archives/2021/page/2/index.html","hash":"bba7f2f3ddd1dca9718a3e81e5d3ceb61aa0d2ed","modified":1637648791194},{"_id":"public/archives/2021/01/index.html","hash":"94b363b6f55c68fd60110b1cc54238f4d3e5a11e","modified":1637648791194},{"_id":"public/archives/2020/10/index.html","hash":"19ecc1b1dfecf4a56e41c61bf468c091bd5b5ca9","modified":1637648791194},{"_id":"public/archives/2021/02/index.html","hash":"a88f07296d89c9dadd9e23fe2bd4e5709575d900","modified":1637648791194},{"_id":"public/archives/2020/11/index.html","hash":"6691cf34a5988227ad67114e702708db5e61abbe","modified":1637648791194},{"_id":"public/archives/2020/12/index.html","hash":"cf1c85ecca27ef325b05f49c598936025648d09e","modified":1637648791194},{"_id":"public/archives/2021/04/index.html","hash":"28de372a01cf512f735a0eda2a960ee2bd41a386","modified":1637648791194},{"_id":"public/categories/java/index.html","hash":"198369fa61e122dc40b0add66ca4f6635e87e5ec","modified":1637648791194},{"_id":"public/archives/2021/05/index.html","hash":"da9e989a8f8e28feb327d644a30f26411dd8c43e","modified":1637648791194},{"_id":"public/archives/2021/11/index.html","hash":"251f8fb031760fcab0742c01178ffaf95cfe772c","modified":1637648791194},{"_id":"public/categories/linux/index.html","hash":"74311760bf1c090d39531568055b88af6ac118f7","modified":1637648791194},{"_id":"public/categories/java/page/2/index.html","hash":"4a69ce158e4f868b0e6af169c8a1471e0c5a66fe","modified":1637648791194},{"_id":"public/categories/kafka/index.html","hash":"a97285f97b9080b8c04c45aac004c72b3247ddd2","modified":1637648791194},{"_id":"public/categories/mysql/index.html","hash":"28092caacb7d28bc252434db2a26084a50ddd11d","modified":1637648791194},{"_id":"public/categories/redis/index.html","hash":"af3cf2ff18f8a8e297b4c328784b217f321380b8","modified":1637648791194},{"_id":"public/categories/shardingjdbc/index.html","hash":"2625fa96762a5bcb64cfb1f7114a2632b6c8b22f","modified":1637648791194},{"_id":"public/categories/spring/index.html","hash":"a134e4796922c01d255a7c899ff4656dde21ed01","modified":1637648791194},{"_id":"public/categories/SpringCloud/index.html","hash":"9c48d8d3b9b98da6a3485135be5053c9c5608ba9","modified":1637648791194},{"_id":"public/categories/zookeeper/index.html","hash":"a06737d050e438701fd0c00b4355f99fd6a3287b","modified":1637648791194},{"_id":"public/categories//index.html","hash":"5654dfc94ec1ef961b1059a0cfa0cdd385939bd1","modified":1637648791194},{"_id":"public/categories//index.html","hash":"5c318994e2e7fdbdf01c5f0d28c8d05eb61d3280","modified":1637648791194},{"_id":"public/categories/influxdb/index.html","hash":"5b6edea376b6c4cac38719047b1244a1893461c0","modified":1637648791194},{"_id":"public/categories/ElasticSearch/index.html","hash":"d919d768d997ec4d6206371d68e651899601cc42","modified":1637648791194},{"_id":"public/categories/GoLang/index.html","hash":"de83ff3776a1e0c010bee0f1a21d124a09c2b9b6","modified":1637648791194},{"_id":"public/categories/Docker/index.html","hash":"2571c4b9db1640384c6f918fcfb88cb66d5c6e4c","modified":1637648791194},{"_id":"public/tags/java/index.html","hash":"cccad559225cecc94edb55ff5577e2cac025d0b2","modified":1637648791194},{"_id":"public/categories/rust/index.html","hash":"e545f779337a731416c972b2ead4a0de05b544b9","modified":1637648791194},{"_id":"public/tags//index.html","hash":"d3f0b2f9cdad995eec82e44827f949cf4a8b1164","modified":1637648791194},{"_id":"public/tags/java8/index.html","hash":"dfbccfab8b835177e811637510e4d3a8bda3d19c","modified":1637648791194},{"_id":"public/tags/java/page/2/index.html","hash":"4002f80ea0e93f93520d71c72f3d43ddd1defd78","modified":1637648791194},{"_id":"public/tags/jvm/index.html","hash":"a53a10252bcc4186ad71a29801c1428a671f86b8","modified":1637648791194},{"_id":"public/tags/linux/index.html","hash":"41437fb690f29c6dcd28f5cc8ddc541045af5afc","modified":1637648791194},{"_id":"public/tags/java/index.html","hash":"5f501a42c9e3d9cef2c76d26f800af496bb1c27a","modified":1637648791194},{"_id":"public/tags/kafka/index.html","hash":"de680455fe5ec3c1a4caef3d4b55920accbccbd1","modified":1637648791194},{"_id":"public/tags//index.html","hash":"19e45cf94f2ee2034ca86b7e6755b115c94d6374","modified":1637648791194},{"_id":"public/tags//index.html","hash":"765b55bbd4d6b72d0ecaa8aad57c660dc21d94ff","modified":1637648791194},{"_id":"public/tags/redis/index.html","hash":"e782c58c3bd5a4137f6aafe4d38157205933bba8","modified":1637648791194},{"_id":"public/tags/shardingjdbc/index.html","hash":"618e02a7b8da9459e130d2a4781ee77f14e7dd21","modified":1637648791194},{"_id":"public/tags/spring/index.html","hash":"98b55afdf3160414d56368f090ed842dcd78b84d","modified":1637648791194},{"_id":"public/tags/SpringCloud/index.html","hash":"2eae486b69a9a2e4e01583f4a887e35789e34330","modified":1637648791194},{"_id":"public/tags/zookeeper/index.html","hash":"a584072f3f45b0a49320b4d1f944d65b0ed8414d","modified":1637648791194},{"_id":"public/tags//index.html","hash":"54746361b1c54991b9388f8910a9bcf688395b0d","modified":1637648791194},{"_id":"public/tags/influxdb/index.html","hash":"4e7b90a99776d1104e580b2aa6cb47131fdec0fa","modified":1637648791194},{"_id":"public/tags/ElasticSearch/index.html","hash":"d9aa27195493c6aea420ac5423051a3e0a209985","modified":1637648791194},{"_id":"public/tags/GoLang/index.html","hash":"2856860540814b4ec67ee6046203ea969c6c83e0","modified":1637648791194},{"_id":"public/tags/Docker/index.html","hash":"96a0adf802f9093a330e9661f1db8a86262c04fc","modified":1637648791194},{"_id":"public/page/3/index.html","hash":"fedd6ab4ee622102799b2cd4839d088fa06c9b39","modified":1637648791194},{"_id":"public/tags/rust/index.html","hash":"73d5a901522e127bbb0cdc0de81fbffafc30a6cd","modified":1637648791194},{"_id":"public/page/4/index.html","hash":"1bc822a2faafe2ff61fff05bb93c8deef1f39cbd","modified":1637648791194},{"_id":"public/page/2/index.html","hash":"05db1dddc9b72f118c6e47a2692667c595c7b7e0","modified":1637648791194},{"_id":"public/page/5/index.html","hash":"00403b9ddd6afe726b02939923b40946872343e4","modified":1637648791194},{"_id":"public/page/6/index.html","hash":"36ff93ead0be51f3a72df3ab1a1be4e921e6d173","modified":1637648791194},{"_id":"public/page/7/index.html","hash":"1322e30b6420d21ba9c0d34545de0bea353a50db","modified":1637648791194},{"_id":"public/CNAME","hash":"301f6e82d2220eefbfc7f7f4464ec99b5286fd0a","modified":1637648791194},{"_id":"public/CHAME","hash":"301f6e82d2220eefbfc7f7f4464ec99b5286fd0a","modified":1637648791194},{"_id":"public/2020/07/20/db-w-r-dynamic/AbstractRoutingDataSource.png","hash":"512e2e6fecac69a70840cc70722dfc02c504c455","modified":1637648791194},{"_id":"public/img/pointer.cur","hash":"3adb643f97571f547021fb57b2d9d768a252d546","modified":1637648791194},{"_id":"public/img/default.cur","hash":"3381d41a9dcbb4c4e69559723481f85e2b8cf99e","modified":1637648791194},{"_id":"public/2019/11/15/kafka-muticustomerthread/1.png","hash":"1b42338f1630c801a1e7ed6b32b2db146918a69b","modified":1637648791194},{"_id":"public/2021/01/01/springcloud-1/1.png","hash":"bef59875b49bcfee389e483f6a1c5910f31273ba","modified":1637648791194},{"_id":"public/2019/07/18/futuretask/1.png","hash":"a111c366b9a45fa298e137539cd5957291ab02c2","modified":1637648791194},{"_id":"public/2019/07/18/futuretask/2.png","hash":"fda83c61771ca8c8b2c79397f8dbe50fb9c2dfd4","modified":1637648791194},{"_id":"public/2020/08/19/mysql-masterslave-solve/1.jpg","hash":"8b36c7c9a7aff09da128c6056e910133276a32b0","modified":1637648791194},{"_id":"public/2020/08/30/mysql-mvcc/1.png","hash":"62e983218071cfade48ef493afe9fb828ab75b8b","modified":1637648791194},{"_id":"public/2020/08/30/mysql-mvcc/2.png","hash":"065d56e599940faa50daa41f43f1526f5bd8e83d","modified":1637648791194},{"_id":"public/2020/12/17/redis-known/1.png","hash":"c3b59a9ddc1bb1ce14c7aa28b169dac0e03297e3","modified":1637648791194},{"_id":"public/2020/08/14/redis-sentinel/1.png","hash":"0a5def8c5a790f12261f0a2d7bf9fcf0ca7b0478","modified":1637648791194},{"_id":"public/2021/02/02/shardingjdbc-reg/1.png","hash":"28b3eb91b0c4d3d6414862fb454e3fa8b3f31004","modified":1637648791194},{"_id":"public/2020/08/14/redis-sentinel/2.png","hash":"23b48b7cee91f9bad089f8f2b2a829d3ef814f9f","modified":1637648791194},{"_id":"public/2021/01/02/springcloud-2/1.png","hash":"b6e339997ff3e3faba8a7f46e5b18150e2d63efc","modified":1637648791194},{"_id":"public/2020/12/02/kafka-messge-complete/2.png","hash":"45d7e5819528878cfe10df49ae48a495608fb7aa","modified":1637648791194},{"_id":"public/2020/08/20/redis-master-slave/3.png","hash":"f627db51ddd50f68fa21e3bddf8e5ed3645fdf63","modified":1637648791194},{"_id":"public/2020/12/02/kafka-messge-complete/3.png","hash":"36c0d3146f92baadac31322df649422a59c3cfc9","modified":1637648791194},{"_id":"public/2019/07/18/volatile/2.png","hash":"87caef509ec0ee6d8d852fc446a56e10018574cc","modified":1637648791194},{"_id":"public/2020/12/02/kafka-messge-complete/1.png","hash":"15601248b896ece38b6e2d38c043fa8c0832e30d","modified":1637648791194},{"_id":"public/2019/02/18/gc-log/3.png","hash":"d1c91df081fdd9086d7baaf6a0c5492be4291f1c","modified":1637648791194},{"_id":"public/2020/08/27/zookeeper-lock/1.png","hash":"78e0866ada3a68c6eddbacad6ab5998f065cef56","modified":1637648791194},{"_id":"public/2020/12/10/io/2.png","hash":"1d2bc6c05645cb5960c0c9e3d92d1432fa02260e","modified":1637648791194},{"_id":"public/2019/02/18/gc-log/2.jpg","hash":"ad542328d4e5de941acb2a23b1259e7faf49f6ea","modified":1637648791194},{"_id":"public/2021/01/09/sharding-student/1.png","hash":"969c138fcf2d2ae8c083011da4473107fcab242d","modified":1637648791194},{"_id":"public/2020/08/27/zookeeper-lock/2.png","hash":"dc7d2b0d8fb619856c189c035b4223ff5e08e23f","modified":1637648791194},{"_id":"public/2020/10/09/kafka-base/2.png","hash":"a43939ffe6e5600199a91f4d8e1829b7809360d3","modified":1637648791194},{"_id":"public/2021/01/09/sharding-student/3.png","hash":"1f4b4f7c349d8cf113bf973fc5333ce578b09ec8","modified":1637648791194},{"_id":"public/2020/10/09/kafka-base/4.png","hash":"6712356b0e980ddc61b89255c8ba460257a8cdd2","modified":1637648791194},{"_id":"public/2021/01/09/sharding-student/4.png","hash":"5ad4d9f93109ad3c683648f935d0be70f6a6364d","modified":1637648791194},{"_id":"public/2020/10/09/kafka-base/3.png","hash":"3c247c08bf7d3d898a4a4d3c0d258a7b5ad2822d","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/1.jpg","hash":"283b9ab6fc7eff67a534e8eed0801ba379de9b38","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/1.png","hash":"3a4682b8288aea56f4318ab6145cdb6effa97583","modified":1637648791194},{"_id":"public/2020/09/13/spring-extend/1.png","hash":"208b77be0ca2c4386916695f0d0a9950a1ba35da","modified":1637648791194},{"_id":"public/2020/09/13/spring-extend/2.png","hash":"c2ef9b256068d6ced1dd89ee60b0e247a1df4e90","modified":1637648791194},{"_id":"public/2020/09/13/spring-extend/3.png","hash":"5412c8b35c9f27cd2b64b2cc52ec1e6ff2a70d2f","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/4.png","hash":"91149d5c4ee2014b517540877336ca6ef510294e","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/4.png","hash":"a00f42064c6eae9c95ef8c7142c7f08a48edd11d","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/1.jpg","hash":"d75006e35829bce9dabb8bff79b3d8cf549783a7","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/3.png","hash":"40d81d94837d24b540bddbf732ca3b30051ca987","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/2.jpg","hash":"7963eafcf3d94f053c6402527b0a561a9ca34389","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/1.png","hash":"c13b617e06e9e6b17ca36dd9a4b6d98e2cebe4dd","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/2.png","hash":"2cb5fa5e53f4d70d62fd01fb6166cf28a14c9ee6","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/2.png","hash":"b267cb522acd47056318e0b1181077cecbd93af7","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/1.png","hash":"7d5fc065f85184510445c8100993f81aaed90095","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/1.jpg","hash":"f60f5483f0e7d0b8ad27fd320e356198603f3177","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/3.png","hash":"a63c9b8d4194eb88e2898f890582ab2c3243e03f","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/3.jpg","hash":"c72369593396990ad186c629f165731dd35d2ea9","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/4.png","hash":"5c1a19807fc9134cce58aac14f33422ddbabe859","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/2.jpg","hash":"f23f793c0ccde9bf19502b79ae634c8262431e5f","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/4.png","hash":"5007fe666463ec229d2e4d5805281f462355b75e","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/4.png","hash":"9038f86e74d4b8171a7f977d4644220ca57a4dae","modified":1637648791194},{"_id":"public/2020/10/03/redis-data-type/5.png","hash":"96db1ca1407c9a79d39ffddd07c7af32612a281f","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/3.png","hash":"ac9c07053f183fd8a0933aa5422170e33bb3e0fd","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/2.png","hash":"e40e1b480ed38713e32b9f671384496b8b1b8ce3","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/4.png","hash":"48bb93f74ed981b730813cce7e446a26d2d59b89","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/1.png","hash":"f4b894336a9d58bf18edbd158935d59751786f3e","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/5.png","hash":"637b69dec456a83c060cfd58088823d1d3f7af2b","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/5.png","hash":"8b41811815d037aa4a61ebfe9a6ea92284e278bb","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/6.png","hash":"10b2c564e4848a168aa3e416b5595e9375a49a65","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/3.png","hash":"ac7cf1e40ac921ea6d8506658992f3f6c2ee9391","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/1.png","hash":"73e5dd02fb26ec42690de2f23e235a9a0b160ce6","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/2.png","hash":"2546bb8025ef05a9634387f3d8e1ab330dbdabe2","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/3.png","hash":"0eb78426115f0d147234b6439b5e5d43be704910","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/4.png","hash":"cb057751e28e7505c010f4a73c300fab50f93724","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/5.png","hash":"9bb01438c01bbac427fb7beab021e6e43846650f","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/1.jpg","hash":"4b096854decabb8c19d717d9e84e49bc02a3360c","modified":1637648791194},{"_id":"public/2021/04/08/linux-top/6.png","hash":"396444e99f9157531f18f03306f4bea3642c8183","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/6.png","hash":"d0a9ebec0a968cd3d37a68f11654c897e1f54bf1","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/1.png","hash":"abcc5ad123604454dcb2e082cd5a9ca020152a81","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/2.png","hash":"b70ebadd1e9b3855ff890e7edfc6d4a5cc0e6782","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/4.png","hash":"7d07b83787c26f6aa47606c10332ab944321d2ca","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/5.png","hash":"0d1de503cb979be81d68b926432c60667c37b330","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/6.png","hash":"7eece3ad17a6a588d7f186632eda6310cbd51d6a","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/10.png","hash":"10d853c5b61981adbd913aa1b5def022ab531cbc","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/0.png","hash":"5efe3b81835c7c439ac393832bc94d280dc08ccb","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/1.png","hash":"706d0a431cbaa440a336173cf51678a4996ee473","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/4.png","hash":"3227d5bf94727d69d4795bd29c82dada24fa9818","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/2.png","hash":"ed56711e743235cd50b30ae086eead64f2e337ce","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/3.png","hash":"3244b501e93cfbad236c456aeb1da81861327163","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/5.png","hash":"13ee83e568c5e0c3733dba8fbb71f4f28e28eecf","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/7.png","hash":"c54a2e76935d39bb1e6b60a986ac3cae7e054426","modified":1637648791194},{"_id":"public/2020/10/30/blockingqueue/6.png","hash":"3d8f8532f5a2816bd4d5541cde6f675e18ad18b3","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/2.png","hash":"0adcfa90c5a8f52ca0aa57570c8fda2be66947ca","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/4.png","hash":"d19e8e93ed53ff9278857aec39a0c22691687e4e","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/3.png","hash":"435d3d4888673dac7b2cd6663f45286a747f7387","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/6.png","hash":"52dd43e150fdba915712541333ab157182d1b4b9","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/5.png","hash":"3d916d5e030ba6282cc2d9209c2ecfb1ba24f8de","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/8.png","hash":"2427f9d7dbf5b2f8677edb97eabff99ca3ab375c","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/1.png","hash":"53ffddf403a4d26e9a24de4c7ed60058fdd81aaf","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/2.png","hash":"81304c8a9087f6efd692b90fe897e650fa879906","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/5.png","hash":"34c2d39e25de753949c40b308bc14720fbc9dee4","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/6.png","hash":"be29dafbbba51cadded9c50c8602169f16a42e4f","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/3.png","hash":"d9d1f25700a1b7872a3294bb20140be663a335de","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/6.png","hash":"e18fec49233eb866383c92df84cccae6731218fe","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/4.png","hash":"342e3a623d9828c5b29e33960f75fcc61530397e","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/7.png","hash":"c4bcd50ed8860b29e70113f2135596ba1c3043c7","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/5.png","hash":"412648b61d5cdf2104894d66f62ee173bc38109f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/1.png","hash":"c9f3596a49b492c6ba587497d4d00df0aa5680ca","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/10.png","hash":"e9d0f6012dbbc64b30270bdfd96ba835962c3c9c","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/2.png","hash":"e1aa45ba85c9740cd734035ec369b079b7f7c6c4","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/9.png","hash":"d92d64a7b127e888d3cc67856450248f9de58d1f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/3.png","hash":"31cb0c3b4ac8639de69147403d55e165e501ca6f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/6.png","hash":"5129bb4d3810f203f362b7f2bf36991d2b6a69ba","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/7.png","hash":"24ea2cf8b38aa29485dd4643c74450a50621b8f8","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/1.png","hash":"684e357612fccba91f3c261aaf0e0b67c05cea9e","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/8.png","hash":"6e56a2abaf102799bf3198c6f8f3436b9b86141b","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/2.png","hash":"aa598a040798a15494cbe9b7005a9abc35f8c962","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/3.png","hash":"b253f7fe18c6784a586e4b6ce9f16c27490e69fc","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/4.png","hash":"9b1271e1e5caf4231d9cec8f740eaa13158bc963","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/6.png","hash":"05693e37fbc379accc5b70add27c034cbae65d56","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/10.png","hash":"900addde5c2b629f060a99f8640630ae6628e94c","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/5.png","hash":"b31ca09270410b604344bce804f3a99d2bae4535","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/8.png","hash":"e299893a6c1496fb19d7ee730d94869f1a73d2b8","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/7.png","hash":"e7980bef26cc81a5807f04fe39956f000ac26eeb","modified":1637648791194},{"_id":"public/2020/09/01/redis-cluster-build/9.png","hash":"856105fa0775abe10d445e322a24baa2784660bd","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/2.png","hash":"36d372d40a4662102d10040b2058e134e66d9983","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/4.png","hash":"8badfc7b4a8e32b64ad5a1cda5e73ce1ded5a135","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/5.png","hash":"f655f0507e55e592d94a79a46d8220846026b63f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/1.png","hash":"e0a148157bca31264cd139d82b078f3a32105370","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/10.png","hash":"723b17612c27bc7528c2574fbf8b2b17d7062219","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/7.png","hash":"5b5aa2a37e3f7741444e8864a15b5a8350b6dac4","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/13.png","hash":"5ef2b16707384b1e46618781a6295adb11959bf9","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/11.png","hash":"b9c9db4c3f28bce4148b16c85ea0f0b4c193f7c3","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/12.png","hash":"612d2986eac25acd1a93d54def33c20502b57a9f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/2.png","hash":"f9766858f432eb4ea210913d15841e32c1296dee","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/3.png","hash":"2fb49c998c5c441144f770822a39cea0ff3b76c2","modified":1637648791194},{"_id":"public/2021/11/12/go-pointer/1.png","hash":"f43eb962738647a211080a5c74dd79be59b933ce","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/4.png","hash":"f1e4211a217a0f1e2591a22afb87e371d466f076","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/6.png","hash":"3a86a6468bee06b62826b4b6e31d58f55aad5697","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/5.png","hash":"00bc3294472b3ad24e6c5a7efc34d08eb6552fb4","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/7.png","hash":"882d96312ae1a994d23ba3c2a5f93c2f8b8a9557","modified":1637648791194},{"_id":"public/2021/11/12/go-pointer/3.png","hash":"31f29c33776040af4a5a345966b2e2a3a12c33a7","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/2.png","hash":"18b6014911463fbddb0ef5ee65badd6edb6fee5f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/8.png","hash":"fad38b076519dcf2e46678ec8bf8dd6191c638d9","modified":1637648791194},{"_id":"public/2021/11/12/go-pointer/2.png","hash":"47b77c3c51073d8e98ef1a9dcacd79fd443903f0","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/1.png","hash":"b770e4ca2a8968347213686f7ce5246cf441f78e","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/4.png","hash":"3156a3a5bd07ac5d43cff196c5eebf40de5d2df0","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/3.png","hash":"5327dad3dc7977ac4b7d15f1c97294b2b021fef0","modified":1637648791194},{"_id":"public/2021/05/18/go-study-01/5.png","hash":"513dd952b1aa49d43875903bb0586149171335b4","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/9.png","hash":"0686402a1d93025d80ab4a0b9b8bd48bef13bfff","modified":1637648791194},{"_id":"public/css/prism.css","hash":"7525a8ef14db7e676922607e580e90dc68ad3e35","modified":1637648791194},{"_id":"public/2019/02/18/limit-single/2.png","hash":"fab361dd8d9049acb285b3afd9becb4d7c4b7eae","modified":1637648791194},{"_id":"public/2019/02/18/limit-single/1.png","hash":"79174ff831d95783ef983cb161914319e8aa53bf","modified":1637648791194},{"_id":"public/2019/02/18/redis-aop-limit-boot/1.png","hash":"79174ff831d95783ef983cb161914319e8aa53bf","modified":1637648791194},{"_id":"public/2020/12/17/redis-known/2.png","hash":"5653ea41f9fa3e5889860945d287d960476a6f06","modified":1637648791194},{"_id":"public/2019/02/18/redis-aop-limit-boot/2.png","hash":"fab361dd8d9049acb285b3afd9becb4d7c4b7eae","modified":1637648791194},{"_id":"public/2021/02/02/shardingjdbc-reg/2.png","hash":"60cd868c22211019331342266a00937d29f5db38","modified":1637648791194},{"_id":"public/2021/01/02/springcloud-2/Hystrix.png","hash":"933e4df680f8f681a3934bf9a666ecd6faef7258","modified":1637648791194},{"_id":"public/2021/02/02/shardingphere-problem/2.png","hash":"4ade0a4a28428211126978a3e52979bb85eca8f0","modified":1637648791194},{"_id":"public/2019/07/18/volatile/1.png","hash":"128c34f5c3b398cf0efdc4bb14c626761d1ff13b","modified":1637648791194},{"_id":"public/2020/08/20/redis-master-slave/2.png","hash":"efafddee4293ed2ffa9c83fd69cba447a36b3cd3","modified":1637648791194},{"_id":"public/2020/08/26/redis-rdb-aop/1.png","hash":"7c944848d609b32c54dc41dd12229e02b7a073e3","modified":1637648791194},{"_id":"public/2020/08/20/redis-master-slave/1.png","hash":"7c944848d609b32c54dc41dd12229e02b7a073e3","modified":1637648791194},{"_id":"public/2019/02/18/gc-log/1.jpg","hash":"f576808db7c258888e0c4b961066219e3eacda51","modified":1637648791194},{"_id":"public/2020/08/27/zookeeper-lock/3.png","hash":"fa9549485e0509604e585b32c3a35dea17ab78c8","modified":1637648791194},{"_id":"public/2019/02/18/gc-log/4.png","hash":"ac6072dcb882aa5502bcc645a6fdfcb62154b1c1","modified":1637648791194},{"_id":"public/2020/10/09/kafka-base/1.png","hash":"d531dad10c13bca4d48dd6ffdd62443dc22ee3e9","modified":1637648791194},{"_id":"public/2020/12/10/io/1.png","hash":"9402dda2b02714b552cb2d984a889277715dd5ab","modified":1637648791194},{"_id":"public/2020/09/13/spring-extend/4.png","hash":"627e82ae73a943379d62dcad307274d2290bb601","modified":1637648791194},{"_id":"public/2020/09/06/java-aqs/2.png","hash":"17106cdf8abc13e7404989b489084e29e2151caa","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/1.png","hash":"6be2302b416e6a29b41da1531c34281565f4a721","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/6.png","hash":"2813d5df686053cef0e10a717ef952b1d0a480b1","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/1.png","hash":"f01c0cc64977367829d830d848610ad05e410846","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/5.png","hash":"01c0a43780757c3a953d59190613903d71939c96","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/2.png","hash":"8cc5585a4ddc1e81e11a35d3401ab7058444fc70","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/5.png","hash":"d42aeff70c69f488dbca9450c891665efd17f604","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/4.png","hash":"f6e5dbb559dc1f7b7ae5dc02f09cdb2d87ba08fc","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/6.png","hash":"d0c160d22ac14324d20a4dbde468d530d20edd9e","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/11.png","hash":"7aca834d553f182df1bb89b72df61bf0a719ce3a","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/13.png","hash":"6fcc61bec3de669e69f07524e6b17098cda5bc29","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/1.png","hash":"d3ea95f9a94a36a972f3bf46173b20045a5f4c88","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/3.png","hash":"9174ec848d4fdf797ab730a379b7a2fc4e32f93f","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/2.png","hash":"8bbaf9d18a8d0c8043000923c77c9983af0a8c8c","modified":1637648791194},{"_id":"public/2020/09/02/redis-cluster-build-2/8.png","hash":"55479153d8d624a5ab1ce600d2873438cf326302","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/5.png","hash":"fd0f98c5315e33c21f7345f26f7becee6f98191c","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/4.png","hash":"397358c3fcd12febc42c138639474d851995a249","modified":1637648791194},{"_id":"public/2020/07/31/mysql-index-single/9.png","hash":"08c706d872e5166067b6c5c019c865cf395750c8","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/10.png","hash":"7c4d83765f9f74b84861cf806ee8170bdea9d00f","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/6.png","hash":"7bacf148e1e82022d616a8989b6d02cc8582d71c","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/8.png","hash":"b83b77cfd02de2607eaff64828a0c06ae7b3972f","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/14.png","hash":"d75a58d8ed4fd012f962d8d7317981f929cdf9d6","modified":1637648791194},{"_id":"public/2020/08/26/redis-rdb-aop/2.png","hash":"fa15ad2b45c316c9e7262882d877401cdfa7d678","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/7.png","hash":"fdb6365de751bf2944c2860dff54f869c3dd3c8e","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/2.png","hash":"7ba2d137e4613ba1d6dca98bf22fcc6d3652e5d8","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/4.png","hash":"8b46904f55c3af297eb4727b39fc5b0685867c88","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/16.png","hash":"e8c121887f8a46a819f6357565ce4ae9a230f0b8","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index-use/1.png","hash":"63057fb1deb7fa27ab2c73779a742874a3ec13b5","modified":1637648791194},{"_id":"public/2021/02/02/shardingphere-problem/1.png","hash":"9b6a021f9cc3075bac7fa77766ea4cd9665ac645","modified":1637648791194},{"_id":"public/2021/01/09/sharding-student/2.png","hash":"225583b10cda9550c62b3c6d803c8bbd611420f9","modified":1637648791194},{"_id":"public/2021/04/08/sring-class/3.png","hash":"256ff4a2a75e539ca9a24d8aaff92c7a675ca30c","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/1.jpg","hash":"f57e001a46ea900febb2bc28dfa1eaaa46e9c686","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/1.png","hash":"138bfe43bc2548b17b22b416c905551bf90fc879","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/12.png","hash":"1f41a0a5ae46cfc3ba5550d8595ca4425935ca77","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/14.png","hash":"97e3e2e2cae20302c1db05d7b0dfe5d12215de77","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/7.png","hash":"0603105790a687ab19ec220563de68ec27b11cf5","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/4.png","hash":"c84c1987cc47d6f36ae8ddcfbcfca68ebbf3f2a2","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/7.png","hash":"92bf4b898e3501d626f0bee5e5614a6682a89bf6","modified":1637648791194},{"_id":"public/2019/07/18/mysql-index/8.png","hash":"764bd50903b85cbfc9c14d2fd36e6e1377b50fc2","modified":1637648791194},{"_id":"public/2020/05/07/jvm-optimization/2.png","hash":"190f2e044a6baf14da40fc8df3262577b5a9875f","modified":1637648791194},{"_id":"public/2020/12/10/io/3.png","hash":"28049a44fae989f2e1064c513ac693787e085429","modified":1637648791194},{"_id":"public/2020/09/27/springboot-custom-start/3.png","hash":"c038091fde608162d3412d3f71517ad66f2de3eb","modified":1637648791194},{"_id":"public/2020/01/04/springmvc2/15.png","hash":"4f95e32fa55772ee20d816ada0acff48b8841a65","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/1.png","hash":"d7c240371f349cc0a84411bb72dfcb9a0eaa2d8b","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/9.png","hash":"d7c1d85109edd964cb9b5a74b43124e849a60562","modified":1637648791194},{"_id":"public/2018/08/07/mysql-log/2.png","hash":"b0311c9c6a1ac5aad8bbb34f123db0e6131857a3","modified":1637648791194},{"_id":"public/2020/08/26/redis-rdb-aop/3.png","hash":"974dda74335d942120861d44655c705807427c88","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/3.png","hash":"4643087f458887d5743069f90e1691642a47ae6f","modified":1637648791194},{"_id":"public/2020/08/12/threadlocal/3.png","hash":"b78663c288f6015f002fa1b2cdb93a1f87dad055","modified":1637648791194},{"_id":"public/2018/08/07/mysql-log/1.png","hash":"b697a4d816c99d0a275ecea99302f3a5d508170b","modified":1637648791194},{"_id":"public/2020/05/10/spring-forbean/3.png","hash":"a5b9516ad74ad7424cd8fa8a6fe3b4a940b78351","modified":1637648791194},{"_id":"public/2018/01/18/executorservice/2.png","hash":"094bb1fb6515174badd053a02f493cf7ed252c01","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/3.png","hash":"9e4849d1fac3ff7e76c653d6d78dae28d23355cb","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/3.png","hash":"b1fce291dcc78db58788e58e9c585475014d2833","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/2.png","hash":"0b636cb6389f04aa5d5649588fa2aabe8917e727","modified":1637648791194},{"_id":"public/2020/07/31/mysql-explain/1.jpg","hash":"127cba4a5ff20fca3c34ab946c0c2af3f97bf0dc","modified":1637648791194},{"_id":"public/2020/12/10/io/4.png","hash":"e706080387623abcbce59b0853564c411812fc6d","modified":1637648791194},{"_id":"public/2020/07/28/hashmap/5.png","hash":"5be06150681a29d113a9db3dbf6bb5c268382460","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/4.png","hash":"b28b3266ec5e47c8c04744bd5d4b22dfccdf8f27","modified":1637648791194},{"_id":"public/2020/08/09/synchronized-up/5.png","hash":"c997c59d5468ce4f709917e7ac7975b56e816605","modified":1637648791194},{"_id":"public/2021/04/08/linux-netstat/1.png","hash":"ef984b3b670eac9b4425a87979db0dc9e6edae48","modified":1637648791194},{"_id":"public/2020/11/11/mysql-lock/1.png","hash":"2a84e5eadda98e728c1727e6eb1f24e9d5b51398","modified":1637648791194},{"_id":"public/2020/01/01/springmvc/1.png","hash":"f97a46fefebc780e4a5f543058dc5b6e7152a903","modified":1637648791194}],"Category":[{"name":"java","_id":"ckn9yvhua0003qwv20e2fceb2"},{"name":"linux","_id":"ckn9yvhut000nqwv2491z2enk"},{"name":"kafka","_id":"ckn9yvhv2000xqwv27se1ajnh"},{"name":"mysql","_id":"ckn9yvhv9001gqwv240uigsrm"},{"name":"redis","_id":"ckn9yvhvk002mqwv253w783ef"},{"name":"shardingjdbc","_id":"ckn9yvhvu003kqwv274ho83o7"},{"name":"spring","_id":"ckn9yvhvy0042qwv2drgndm5p"},{"name":"SpringCloud","_id":"ckn9yvhw6004oqwv2bebqbtxq"},{"name":"zookeeper","_id":"ckn9yvhw90055qwv2dcjqfso9"},{"name":"","_id":"ckn9yvhwi005uqwv2eypzfb12"},{"name":"","_id":"ckpxmxgsc0002h8v23tnn8wbb"},{"name":"influxdb","_id":"ckpxmxgsi0005h8v2bbvg6twm"},{"name":"ElasticSearch","_id":"ckpxmxgsk0009h8v28hs7gosd"},{"name":"GoLang","_id":"ckwbpt4ir0002zsv2f53i8sju"},{"name":"Docker","_id":"ckwbpt4iy0007zsv2cwyr7zd6"},{"name":"rust","_id":"ckwbpt4j2000gzsv2ax606pdu"}],"Data":[],"Page":[{"title":"","date":"2020-07-21T09:44:02.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: \ndate: 2020-07-21 17:44:02\ntype: \"categories\"\ncomments: false\n---\n","updated":"2021-04-08T00:47:07.137Z","path":"categories/index.html","layout":"page","_id":"ckn9yvhu50001qwv2hcch9zba","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"","date":"2017-05-27T05:47:40.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: \ndate: 2017-05-27 13:47:40\ntype: \"tags\"\n---","updated":"2021-04-08T00:47:07.137Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckn9yvhwh005tqwv2bejkdvq2","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"","description":"","date":"2020-07-20T02:14:00.000Z","_content":"\n## \n\n******\n\n\n\n- \n- \n- \n- \n\n![](db-w-r-dynamic/db1.png)\n<!--more-->\n\n## \n\n### \nMYSQL11(1)\n### \n1. \n2. \n\n## Spring\n### \nSrpingAbstractRoutingDataSourceInitializingBean,beanafterPropertiesSet\n![](db-w-r-dynamic/AbstractRoutingDataSource.png)\n```\n    Override\n    public void afterPropertiesSet() {\n        if (this.targetDataSources == null) {\n            throw new IllegalArgumentException(\"Property 'targetDataSources' is required\");\n        }\n        //xmlresolvedDataSources\n        this.resolvedDataSources = new HashMap<>(this.targetDataSources.size());\n        this.targetDataSources.forEach((key, value) -> {\n            Object lookupKey = resolveSpecifiedLookupKey(key);\n            DataSource dataSource = resolveSpecifiedDataSource(value);\n            this.resolvedDataSources.put(lookupKey, dataSource);\n        });\n        if (this.defaultTargetDataSource != null) {\n            this.resolvedDefaultDataSource = resolveSpecifiedDataSource(this.defaultTargetDataSource);\n        }\n    }\n```\nDynamicDataSourcedetermineCurrentLookupKeyThreadLocal\n```\n\t//\n\t@Override\n\tpublic Connection getConnection() throws SQLException {\n\t\treturn determineTargetDataSource().getConnection();\n\t}\n\t\n\tprotected DataSource determineTargetDataSource() {\n\t\tAssert.notNull(this.resolvedDataSources, \"DataSource router not initialized\");\n\t\tObject lookupKey = determineCurrentLookupKey();\n\t\tDataSource dataSource = this.resolvedDataSources.get(lookupKey);\n\t\tif (dataSource == null && (this.lenientFallback || lookupKey == null)) {\n\t\t\tdataSource = this.resolvedDefaultDataSource;\n\t\t}\n\t\tif (dataSource == null) {\n\t\t\tthrow new IllegalStateException(\"Cannot determine target DataSource for lookup key [\" + lookupKey + \"]\");\n\t\t}\n\t\treturn dataSource;\n\t}\n\n\t//determineCurrentLookupKey\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n\n```\n\n### \n#### MAVEN\n```\n<dependency>\n      <groupId>com.alibaba</groupId>\n      <artifactId>druid</artifactId>\n      <version>1.0.9</version>\n</dependency>\n```\n#### \n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd\">\n    <context:component-scan base-package=\"com.xzy.tx\"/>\n    <tx:annotation-driven/>\n    <!---->\n    <bean id=\"dynamicDataSource\" class=\"com.xzy.rwDynamic.DynamicDataSource\">\n        <property name=\"targetDataSources\">\n            <map>\n                <entry value-ref=\"dataSourceMaster\" key=\"dataSourceMaster\"></entry>\n                <entry value-ref=\"dataSourceSlave\" key=\"dataSourceSlave\"></entry>\n            </map>\n        </property>\n    </bean>\n\n    <bean id=\"transactionManager\"\n          class=\"org.springframework.jdbc.datasource.DataSourceTransactionManager\">\n        <property name=\"dataSource\" ref=\"dynamicDataSource\"/>\n    </bean>\n\n    <bean id=\"jdbcTemplate\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"dynamicDataSource\"></property>\n    </bean>\n\t<!---->\n    <bean id=\"dataSourceMaster\" class=\"com.alibaba.druid.pool.DruidDataSource\" init-method=\"init\"\n          destroy-method=\"close\">\n        <!---->\n    </bean>\n    <!---->\n    <bean id=\"dataSourceSlave\" class=\"com.alibaba.druid.pool.DruidDataSource\" init-method=\"init\" destroy-method=\"close\">\n        <!---->\n    </bean>\n</beans>\n```\n\n#### \n```\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/***\n * \n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n}\n```\n```\npackage com.xzy.rwDynamic;\n/**\n * \n*/\npublic enum DbType {\n    MASTER(\"dataSourceMaster\"),\n    SLAVE(\"dataSourceSlave\");\n    private String type;\n    DbType(String type){\n        this.type = type;\n    }\n    public String getType() {\n        return type;\n    }\n    public void setType(String type) {\n        this.type = type;\n    }\n}\n```\n\n```\npackage com.xzy.rwDynamic;\nimport org.apache.commons.lang3.StringUtils;\n\npublic class DBContextHolder {\n    private static final ThreadLocal<String> dbHolder = new ThreadLocal<String>();\n\n    public static String get(){\n        String db = dbHolder.get();\n        return StringUtils.isNoneBlank(db) ? db : DbType.MASTER.getType();\n    }\n    public static void set(String type){\n        if(StringUtils.isBlank(type)){\n            dbHolder.set(DbType.MASTER.getType());\n        }else{\n            dbHolder.set(type);\n        }\n    }\n    public static void remove(){\n        dbHolder.remove();\n    }\n}\n```\n#### \n```\n@Test\n    public void testwrDynamic(){\n        //\n        DBContextHolder.set(DbType.MASTER.getType());\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"classpath:applicationContext-w-r-dynamic.xml\");\n        JdbcTemplate jdbcTemplate = context.getBean(JdbcTemplate.class);\n        jdbcTemplate.queryForList(\"select * from user\");\n        DBContextHolder.remove()\n    }\n```\n#### \nDBContextHolder.set()DBContextHolder.remove()AOP+\n\n\n","source":"_posts/db-w-r-dynamic.md","raw":"---\ntitle: \ntags:\n  - mysql\n  - \ncategories: \n  - \ndescription : \ndate: 2020-07-20 10:14:00\n---\n\n## \n\n******\n\n\n\n- \n- \n- \n- \n\n![](db-w-r-dynamic/db1.png)\n<!--more-->\n\n## \n\n### \nMYSQL11(1)\n### \n1. \n2. \n\n## Spring\n### \nSrpingAbstractRoutingDataSourceInitializingBean,beanafterPropertiesSet\n![](db-w-r-dynamic/AbstractRoutingDataSource.png)\n```\n    Override\n    public void afterPropertiesSet() {\n        if (this.targetDataSources == null) {\n            throw new IllegalArgumentException(\"Property 'targetDataSources' is required\");\n        }\n        //xmlresolvedDataSources\n        this.resolvedDataSources = new HashMap<>(this.targetDataSources.size());\n        this.targetDataSources.forEach((key, value) -> {\n            Object lookupKey = resolveSpecifiedLookupKey(key);\n            DataSource dataSource = resolveSpecifiedDataSource(value);\n            this.resolvedDataSources.put(lookupKey, dataSource);\n        });\n        if (this.defaultTargetDataSource != null) {\n            this.resolvedDefaultDataSource = resolveSpecifiedDataSource(this.defaultTargetDataSource);\n        }\n    }\n```\nDynamicDataSourcedetermineCurrentLookupKeyThreadLocal\n```\n\t//\n\t@Override\n\tpublic Connection getConnection() throws SQLException {\n\t\treturn determineTargetDataSource().getConnection();\n\t}\n\t\n\tprotected DataSource determineTargetDataSource() {\n\t\tAssert.notNull(this.resolvedDataSources, \"DataSource router not initialized\");\n\t\tObject lookupKey = determineCurrentLookupKey();\n\t\tDataSource dataSource = this.resolvedDataSources.get(lookupKey);\n\t\tif (dataSource == null && (this.lenientFallback || lookupKey == null)) {\n\t\t\tdataSource = this.resolvedDefaultDataSource;\n\t\t}\n\t\tif (dataSource == null) {\n\t\t\tthrow new IllegalStateException(\"Cannot determine target DataSource for lookup key [\" + lookupKey + \"]\");\n\t\t}\n\t\treturn dataSource;\n\t}\n\n\t//determineCurrentLookupKey\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n\n```\n\n### \n#### MAVEN\n```\n<dependency>\n      <groupId>com.alibaba</groupId>\n      <artifactId>druid</artifactId>\n      <version>1.0.9</version>\n</dependency>\n```\n#### \n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd\">\n    <context:component-scan base-package=\"com.xzy.tx\"/>\n    <tx:annotation-driven/>\n    <!---->\n    <bean id=\"dynamicDataSource\" class=\"com.xzy.rwDynamic.DynamicDataSource\">\n        <property name=\"targetDataSources\">\n            <map>\n                <entry value-ref=\"dataSourceMaster\" key=\"dataSourceMaster\"></entry>\n                <entry value-ref=\"dataSourceSlave\" key=\"dataSourceSlave\"></entry>\n            </map>\n        </property>\n    </bean>\n\n    <bean id=\"transactionManager\"\n          class=\"org.springframework.jdbc.datasource.DataSourceTransactionManager\">\n        <property name=\"dataSource\" ref=\"dynamicDataSource\"/>\n    </bean>\n\n    <bean id=\"jdbcTemplate\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"dynamicDataSource\"></property>\n    </bean>\n\t<!---->\n    <bean id=\"dataSourceMaster\" class=\"com.alibaba.druid.pool.DruidDataSource\" init-method=\"init\"\n          destroy-method=\"close\">\n        <!---->\n    </bean>\n    <!---->\n    <bean id=\"dataSourceSlave\" class=\"com.alibaba.druid.pool.DruidDataSource\" init-method=\"init\" destroy-method=\"close\">\n        <!---->\n    </bean>\n</beans>\n```\n\n#### \n```\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/***\n * \n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n}\n```\n```\npackage com.xzy.rwDynamic;\n/**\n * \n*/\npublic enum DbType {\n    MASTER(\"dataSourceMaster\"),\n    SLAVE(\"dataSourceSlave\");\n    private String type;\n    DbType(String type){\n        this.type = type;\n    }\n    public String getType() {\n        return type;\n    }\n    public void setType(String type) {\n        this.type = type;\n    }\n}\n```\n\n```\npackage com.xzy.rwDynamic;\nimport org.apache.commons.lang3.StringUtils;\n\npublic class DBContextHolder {\n    private static final ThreadLocal<String> dbHolder = new ThreadLocal<String>();\n\n    public static String get(){\n        String db = dbHolder.get();\n        return StringUtils.isNoneBlank(db) ? db : DbType.MASTER.getType();\n    }\n    public static void set(String type){\n        if(StringUtils.isBlank(type)){\n            dbHolder.set(DbType.MASTER.getType());\n        }else{\n            dbHolder.set(type);\n        }\n    }\n    public static void remove(){\n        dbHolder.remove();\n    }\n}\n```\n#### \n```\n@Test\n    public void testwrDynamic(){\n        //\n        DBContextHolder.set(DbType.MASTER.getType());\n        ApplicationContext context = new ClassPathXmlApplicationContext(\"classpath:applicationContext-w-r-dynamic.xml\");\n        JdbcTemplate jdbcTemplate = context.getBean(JdbcTemplate.class);\n        jdbcTemplate.queryForList(\"select * from user\");\n        DBContextHolder.remove()\n    }\n```\n#### \nDBContextHolder.set()DBContextHolder.remove()AOP+\n\n\n","slug":"db-w-r-dynamic","published":1,"updated":"2021-04-08T00:47:06.717Z","_id":"ckcujgdbf0000e0xlg085gsal","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong><em></em></strong></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><img src=\"/2020/07/20/db-w-r-dynamic/db1.png\" alt></p>\n<a id=\"more\"></a>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MYSQL11(1)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li></li>\n<li></li>\n</ol>\n<h2 id=\"Spring\"><a href=\"#Spring\" class=\"headerlink\" title=\"Spring\"></a>Spring</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SrpingAbstractRoutingDataSourceInitializingBean,beanafterPropertiesSet<br><img src=\"/2020/07/20/db-w-r-dynamic/AbstractRoutingDataSource.png\" alt></p>\n<pre><code>    Override\n    public void afterPropertiesSet() {\n        if (this.targetDataSources == null) {\n            throw new IllegalArgumentException(&quot;Property &#39;targetDataSources&#39; is required&quot;);\n        }\n        //xmlresolvedDataSources\n        this.resolvedDataSources = new HashMap&lt;&gt;(this.targetDataSources.size());\n        this.targetDataSources.forEach((key, value) -&gt; {\n            Object lookupKey = resolveSpecifiedLookupKey(key);\n            DataSource dataSource = resolveSpecifiedDataSource(value);\n            this.resolvedDataSources.put(lookupKey, dataSource);\n        });\n        if (this.defaultTargetDataSource != null) {\n            this.resolvedDefaultDataSource = resolveSpecifiedDataSource(this.defaultTargetDataSource);\n        }\n    }</code></pre><p>DynamicDataSourcedetermineCurrentLookupKeyThreadLocal</p>\n<pre><code>    //\n    @Override\n    public Connection getConnection() throws SQLException {\n        return determineTargetDataSource().getConnection();\n    }\n\n    protected DataSource determineTargetDataSource() {\n        Assert.notNull(this.resolvedDataSources, &quot;DataSource router not initialized&quot;);\n        Object lookupKey = determineCurrentLookupKey();\n        DataSource dataSource = this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null &amp;&amp; (this.lenientFallback || lookupKey == null)) {\n            dataSource = this.resolvedDefaultDataSource;\n        }\n        if (dataSource == null) {\n            throw new IllegalStateException(&quot;Cannot determine target DataSource for lookup key [&quot; + lookupKey + &quot;]&quot;);\n        }\n        return dataSource;\n    }\n\n    //determineCurrentLookupKey\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"MAVEN\"><a href=\"#MAVEN\" class=\"headerlink\" title=\"MAVEN\"></a>MAVEN</h4><pre><code>&lt;dependency&gt;\n      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;\n      &lt;artifactId&gt;druid&lt;/artifactId&gt;\n      &lt;version&gt;1.0.9&lt;/version&gt;\n&lt;/dependency&gt;</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;\n    &lt;context:component-scan base-package=&quot;com.xzy.tx&quot;/&gt;\n    &lt;tx:annotation-driven/&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dynamicDataSource&quot; class=&quot;com.xzy.rwDynamic.DynamicDataSource&quot;&gt;\n        &lt;property name=&quot;targetDataSources&quot;&gt;\n            &lt;map&gt;\n                &lt;entry value-ref=&quot;dataSourceMaster&quot; key=&quot;dataSourceMaster&quot;&gt;&lt;/entry&gt;\n                &lt;entry value-ref=&quot;dataSourceSlave&quot; key=&quot;dataSourceSlave&quot;&gt;&lt;/entry&gt;\n            &lt;/map&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;bean id=&quot;transactionManager&quot;\n          class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dynamicDataSource&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dynamicDataSource&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dataSourceMaster&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method=&quot;init&quot;\n          destroy-method=&quot;close&quot;&gt;\n        &lt;!----&gt;\n    &lt;/bean&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dataSourceSlave&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method=&quot;init&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;!----&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/***\n * \n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n}</code></pre><pre><code>package com.xzy.rwDynamic;\n/**\n * \n*/\npublic enum DbType {\n    MASTER(&quot;dataSourceMaster&quot;),\n    SLAVE(&quot;dataSourceSlave&quot;);\n    private String type;\n    DbType(String type){\n        this.type = type;\n    }\n    public String getType() {\n        return type;\n    }\n    public void setType(String type) {\n        this.type = type;\n    }\n}</code></pre><pre><code>package com.xzy.rwDynamic;\nimport org.apache.commons.lang3.StringUtils;\n\npublic class DBContextHolder {\n    private static final ThreadLocal&lt;String&gt; dbHolder = new ThreadLocal&lt;String&gt;();\n\n    public static String get(){\n        String db = dbHolder.get();\n        return StringUtils.isNoneBlank(db) ? db : DbType.MASTER.getType();\n    }\n    public static void set(String type){\n        if(StringUtils.isBlank(type)){\n            dbHolder.set(DbType.MASTER.getType());\n        }else{\n            dbHolder.set(type);\n        }\n    }\n    public static void remove(){\n        dbHolder.remove();\n    }\n}</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>@Test\n    public void testwrDynamic(){\n        //\n        DBContextHolder.set(DbType.MASTER.getType());\n        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;classpath:applicationContext-w-r-dynamic.xml&quot;);\n        JdbcTemplate jdbcTemplate = context.getBean(JdbcTemplate.class);\n        jdbcTemplate.queryForList(&quot;select * from user&quot;);\n        DBContextHolder.remove()\n    }</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DBContextHolder.set()DBContextHolder.remove()AOP+</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong><em></em></strong></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><img src=\"/2020/07/20/db-w-r-dynamic/db1.png\" alt></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MYSQL11(1)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li></li>\n<li></li>\n</ol>\n<h2 id=\"Spring\"><a href=\"#Spring\" class=\"headerlink\" title=\"Spring\"></a>Spring</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SrpingAbstractRoutingDataSourceInitializingBean,beanafterPropertiesSet<br><img src=\"/2020/07/20/db-w-r-dynamic/AbstractRoutingDataSource.png\" alt></p>\n<pre><code>    Override\n    public void afterPropertiesSet() {\n        if (this.targetDataSources == null) {\n            throw new IllegalArgumentException(&quot;Property &#39;targetDataSources&#39; is required&quot;);\n        }\n        //xmlresolvedDataSources\n        this.resolvedDataSources = new HashMap&lt;&gt;(this.targetDataSources.size());\n        this.targetDataSources.forEach((key, value) -&gt; {\n            Object lookupKey = resolveSpecifiedLookupKey(key);\n            DataSource dataSource = resolveSpecifiedDataSource(value);\n            this.resolvedDataSources.put(lookupKey, dataSource);\n        });\n        if (this.defaultTargetDataSource != null) {\n            this.resolvedDefaultDataSource = resolveSpecifiedDataSource(this.defaultTargetDataSource);\n        }\n    }</code></pre><p>DynamicDataSourcedetermineCurrentLookupKeyThreadLocal</p>\n<pre><code>    //\n    @Override\n    public Connection getConnection() throws SQLException {\n        return determineTargetDataSource().getConnection();\n    }\n\n    protected DataSource determineTargetDataSource() {\n        Assert.notNull(this.resolvedDataSources, &quot;DataSource router not initialized&quot;);\n        Object lookupKey = determineCurrentLookupKey();\n        DataSource dataSource = this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null &amp;&amp; (this.lenientFallback || lookupKey == null)) {\n            dataSource = this.resolvedDefaultDataSource;\n        }\n        if (dataSource == null) {\n            throw new IllegalStateException(&quot;Cannot determine target DataSource for lookup key [&quot; + lookupKey + &quot;]&quot;);\n        }\n        return dataSource;\n    }\n\n    //determineCurrentLookupKey\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"MAVEN\"><a href=\"#MAVEN\" class=\"headerlink\" title=\"MAVEN\"></a>MAVEN</h4><pre><code>&lt;dependency&gt;\n      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;\n      &lt;artifactId&gt;druid&lt;/artifactId&gt;\n      &lt;version&gt;1.0.9&lt;/version&gt;\n&lt;/dependency&gt;</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;\n    &lt;context:component-scan base-package=&quot;com.xzy.tx&quot;/&gt;\n    &lt;tx:annotation-driven/&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dynamicDataSource&quot; class=&quot;com.xzy.rwDynamic.DynamicDataSource&quot;&gt;\n        &lt;property name=&quot;targetDataSources&quot;&gt;\n            &lt;map&gt;\n                &lt;entry value-ref=&quot;dataSourceMaster&quot; key=&quot;dataSourceMaster&quot;&gt;&lt;/entry&gt;\n                &lt;entry value-ref=&quot;dataSourceSlave&quot; key=&quot;dataSourceSlave&quot;&gt;&lt;/entry&gt;\n            &lt;/map&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;bean id=&quot;transactionManager&quot;\n          class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dynamicDataSource&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dynamicDataSource&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dataSourceMaster&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method=&quot;init&quot;\n          destroy-method=&quot;close&quot;&gt;\n        &lt;!----&gt;\n    &lt;/bean&gt;\n    &lt;!----&gt;\n    &lt;bean id=&quot;dataSourceSlave&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method=&quot;init&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;!----&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/***\n * \n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    protected Object determineCurrentLookupKey() {\n        return DBContextHolder.get();\n    }\n}</code></pre><pre><code>package com.xzy.rwDynamic;\n/**\n * \n*/\npublic enum DbType {\n    MASTER(&quot;dataSourceMaster&quot;),\n    SLAVE(&quot;dataSourceSlave&quot;);\n    private String type;\n    DbType(String type){\n        this.type = type;\n    }\n    public String getType() {\n        return type;\n    }\n    public void setType(String type) {\n        this.type = type;\n    }\n}</code></pre><pre><code>package com.xzy.rwDynamic;\nimport org.apache.commons.lang3.StringUtils;\n\npublic class DBContextHolder {\n    private static final ThreadLocal&lt;String&gt; dbHolder = new ThreadLocal&lt;String&gt;();\n\n    public static String get(){\n        String db = dbHolder.get();\n        return StringUtils.isNoneBlank(db) ? db : DbType.MASTER.getType();\n    }\n    public static void set(String type){\n        if(StringUtils.isBlank(type)){\n            dbHolder.set(DbType.MASTER.getType());\n        }else{\n            dbHolder.set(type);\n        }\n    }\n    public static void remove(){\n        dbHolder.remove();\n    }\n}</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>@Test\n    public void testwrDynamic(){\n        //\n        DBContextHolder.set(DbType.MASTER.getType());\n        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;classpath:applicationContext-w-r-dynamic.xml&quot;);\n        JdbcTemplate jdbcTemplate = context.getBean(JdbcTemplate.class);\n        jdbcTemplate.queryForList(&quot;select * from user&quot;);\n        DBContextHolder.remove()\n    }</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DBContextHolder.set()DBContextHolder.remove()AOP+</p>"},{"title":"(BlockingQueue)()","description":"Fork/join","date":"2020-10-30T05:53:30.000Z","_content":"\n## BlockingQueue\n\nJava`BlockingQueue`Queue<font color=red></font>\n\n![BlockingQueue](blockingqueue/0.png)\n\n\n|          |   |  |  |               |\n| :------- | :-------- | :--------- | :------- | --------------------------- |\n|  | add(o)    | offer(o)   | put(o)   | offer(o, timeout, timeunit) |\n|  | remove(o) | poll()     | take(o)  | poll(o, timeout, timeunit)  |\n|  | element() | peek()     |         |                            |\n\n<!--more-->\n\n- IllegalStateException(\"Queue full\")NoSuchElementException\n- \n  -   truefalse\n  -  null\n- \n\nJDKBlockingQueue ArrayBlockingQueueLinkedBlockingQueuePriorityBlockingQueueDelayQueueSynchronousQueueLinkedTransferQueueLinkedBlockingDeque\n\n![](blockingqueue/1.png)\n\n## ArrayBlockingQueue\n\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>\n\n```java\n  public class ArrayBlockingQueue<E> extends AbstractQueue<E> implements BlockingQueue<E>, Serializable {\n        private static final long serialVersionUID = -817911632652898426L;\n        //\n        final Object[] items;\n        //\n        int takeIndex;\n        //\n        int putIndex;\n        //\n        int count;\n        // ,\n        final ReentrantLock lock;\n        // notEmpty.await()\n        private final Condition notEmpty;\n        // notFull.await()\n        private final Condition notFull;\n        transient ArrayBlockingQueue.Itrs itrs;\n    }\n\npublic ArrayBlockingQueue(int capacity) {\n      this(capacity, false);\n}\n\npublic ArrayBlockingQueue(int capacity, boolean fair) {\n    if (capacity <= 0)\n        throw new IllegalArgumentException();\n    this.items = new Object[capacity];\n    lock = new ReentrantLock(fair);\n    notEmpty = lock.newCondition();\n    notFull =  lock.newCondition();\n}\n```\n\n\n\n```java\n//===============================================================\npublic void put(E e) throws InterruptedException {\n    checkNotNull(e);\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == items.length)\n            notFull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate void enqueue(E x) {\n    final Object[] items = this.items;\n    items[putIndex] = x;\n    if (++putIndex == items.length)\n        putIndex = 0;\n    count++;\n    notEmpty.signal();\n}\n\n//===============================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == 0)\n            notEmpty.await();\n        return dequeue();\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate E dequeue() {\n    final Object[] items = this.items;\n    E x = (E) items[takeIndex];\n    items[takeIndex] = null;\n    if (++takeIndex == items.length)\n        takeIndex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementDequeued();\n    notFull.signal();\n    return x;\n}\n```\n\n\n\n- `ReentrantLock`\n- `count`\n- `count`0\n- `putIndex``takeIndex`items.length0<font color=red></font>\n\n![](blockingqueue/2.png)\n\n![](blockingqueue/3.png)\n\nArrayBlockingQueueReentrantLockCondition\n\n\n## LinkedBlockingQueue\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>LinkedBlockingQueue`Integer.MAX_VALUE`\n\n****\n\n```java\n// \nprivate final int capacity;\n// ,\nprivate final AtomicInteger count = new AtomicInteger();\n// \ntransient Node<E> head;\n// \nprivate transient Node<E> last;\n// \nprivate final ReentrantLock takeLock = new ReentrantLock();\n// notEmpty\n// notEmpty.await()\nprivate final Condition notEmpty = takeLock.newCondition();\n// \nprivate final ReentrantLock putLock = new ReentrantLock();\n// notFull\n// notFull.await()\nprivate final Condition notFull = putLock.newCondition();\n\nstatic class Node<E> {\n    E item;\n    Node<E> next;\n    Node(E x) { item = x; }\n}\n```\n\n\n\n```java\n//==================================================================\npublic void put(E e) throws InterruptedException {\n    if (e == null) throw new NullPointerException();\n    int c = -1;\n    Node<E> node = new Node<E>(e);\n    final ReentrantLock putLock = this.putLock;\n    final AtomicInteger count = this.count;\n    putLock.lockInterruptibly();\n    try {\n        while (count.get() == capacity) {\n            notFull.await();\n        }\n        enqueue(node);\n        //CAS++count\n        c = count.getAndIncrement();\n        //\n        if (c + 1 < capacity)\n            notFull.signal();\n    } finally {\n        putLock.unlock();\n    }\n    if (c == 0)\n        signalNotEmpty(); // notEmpty.signal()\n}\n\nprivate void enqueue(Node<E> node) {\n    last = last.next = node;\n}\n\n//======================================================\npublic E take() throws InterruptedException {\n    E x;\n    int c = -1;\n    final AtomicInteger count = this.count;\n    final ReentrantLock takeLock = this.takeLock;\n    takeLock.lockInterruptibly();\n    try {\n        while (count.get() == 0) {\n            notEmpty.await();\n        }\n        x = dequeue();\n        c = count.getAndDecrement();\n        if (c > 1)\n            notEmpty.signal();\n    } finally {\n        takeLock.unlock();\n    }\n    if (c == capacity)\n        signalNotFull();\n    return x;\n}\n\nprivate E dequeue() {\n    Node<E> h = head;\n    Node<E> first = h.next;\n    h.next = h; // help GC\n    head = first;\n    E x = first.item;\n    first.item = null;\n    return x;\n}\n```\n\n\n\n- putLock,takeLock\n- (AtomicInteger)count++CAS\n\n![LinkedBlockingQueue](blockingqueue/5.png)\n\n**ArrayBlockingQueueLinkedBlockingQueue**\n\n- \n  - \n- \n  - ArrayBlockingQueueLinkedBlockingQueue\n  - ArrayBlockingQueueLinkedBlockingQueue/GC\n\n## PriorityBlockingQueue\n\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>\n\nPriorityBlockingQueue\n\n```java\n// 11\nprivate static final int DEFAULT_INITIAL_CAPACITY = 11;\n// \nprivate static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;\n// \nprivate transient Object[] queue;\n// \nprivate transient int size;\n// \nprivate transient Comparator<? super E> comparator;\n//  ArrayBlockingQueue\nprivate final ReentrantLock lock;\n// \nprivate final Condition notEmpty;\n// CASCPU\nprivate transient volatile int allocationSpinLock;\n// /\nprivate PriorityQueue<E> q;\n\npublic PriorityBlockingQueue(int initialCapacity,\n                             Comparator<? super E> comparator) {\n    if (initialCapacity < 1)\n        throw new IllegalArgumentException();\n    this.lock = new ReentrantLock();\n    this.notEmpty = lock.newCondition();\n    this.comparator = comparator;\n    this.queue = new Object[initialCapacity];\n}\n```\n\n****\n\n```java\n//==================================================\npublic void put(E e) {\n    offer(e);\n}\n\npublic boolean offer(E e) {\n    if (e == null)\n        throw new NullPointerException();\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    int n, cap;\n    Object[] array;\n    while ((n = size) >= (cap = (array = queue).length))\n    \t//\n        tryGrow(array, cap);\n    try {\n        Comparator<? super E> cmp = comparator;\n        //\n        if (cmp == null)\n            siftUpComparable(n, e, array); //\n        else\n            siftUpUsingComparator(n, e, array, cmp); //\n        size = n + 1;\n        notEmpty.signal();\n    } finally {\n        lock.unlock();\n    }\n    return true;\n}\n\n//==================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    E result;\n    try {\n        while ( (result = dequeue()) == null)\n            notEmpty.await();\n    } finally {\n        lock.unlock();\n    }\n    return result;\n}\n\nprivate E dequeue() {\n    int n = size - 1;\n    if (n < 0)\n        return null;\n    else {\n        Object[] array = queue;\n        E result = (E) array[0]; //\n        E x = (E) array[n]; // \n        array[n] = null;\n        Comparator<? super E> cmp = comparator;\n        // \n        if (cmp == null)\n            siftDownComparable(0, x, array, n);\n        else\n            siftDownUsingComparator(0, x, array, n, cmp);\n        size = n;\n        return result;\n    }\n}\n```\n\n- PriorityBlockingQueue\n- notEmptynotEmtry\n- allocationSpinLockCAS\n- PriorityBlockingQueueComparator\n- [](https://mp.weixin.qq.com/s?__biz=MzkxNDEyOTI0OQ==&mid=2247484450&amp;idx=1&amp;sn=2be695dbf92e1e209a405422e8da5616&source=41#wechat_redirect)\n- \n- ()\n\n![PriorityBlockingQueue](blockingqueue/6.png)\n\n![PriorityBlockingQueue](blockingqueue/7.png)\n\n## ConcurrentLinkedQueue\n\n  <font color=red></font> <font color=red></font><font color=red>CAS</font><font color=red></font><font color=red>FIFO</font>\n\nArrayBlockingQueueLinkedBlockingQueueCASConcurrentLinkedQueueCASCASCASCASCPU\n\n(ConcurrentLinkedQueue[J.U.CJavaConcurrentLinkedQueue](http://cmsblogs.com/?p=2353))\n\n| queue                 |  |  |   |                        |                       |\n| --------------------- | -------- | -------- | ------------- | ------------------------------ | ----------------------------- |\n| ArrayBlockingQueue    |      |      |     |  | --                            |\n| LinkedBlockingQueue   |      |    | 2 |  |     |\n| ConcurrentLinkedQueue |    |      | CAS           |            | size()  |","source":"_posts/blockingqueue.md","raw":"---\ntitle: (BlockingQueue)()\ntags:\n  - java\ncategories:  java\ndescription : Fork/join\ndate: 2020-10-30 13:53:30\n---\n\n## BlockingQueue\n\nJava`BlockingQueue`Queue<font color=red></font>\n\n![BlockingQueue](blockingqueue/0.png)\n\n\n|          |   |  |  |               |\n| :------- | :-------- | :--------- | :------- | --------------------------- |\n|  | add(o)    | offer(o)   | put(o)   | offer(o, timeout, timeunit) |\n|  | remove(o) | poll()     | take(o)  | poll(o, timeout, timeunit)  |\n|  | element() | peek()     |         |                            |\n\n<!--more-->\n\n- IllegalStateException(\"Queue full\")NoSuchElementException\n- \n  -   truefalse\n  -  null\n- \n\nJDKBlockingQueue ArrayBlockingQueueLinkedBlockingQueuePriorityBlockingQueueDelayQueueSynchronousQueueLinkedTransferQueueLinkedBlockingDeque\n\n![](blockingqueue/1.png)\n\n## ArrayBlockingQueue\n\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>\n\n```java\n  public class ArrayBlockingQueue<E> extends AbstractQueue<E> implements BlockingQueue<E>, Serializable {\n        private static final long serialVersionUID = -817911632652898426L;\n        //\n        final Object[] items;\n        //\n        int takeIndex;\n        //\n        int putIndex;\n        //\n        int count;\n        // ,\n        final ReentrantLock lock;\n        // notEmpty.await()\n        private final Condition notEmpty;\n        // notFull.await()\n        private final Condition notFull;\n        transient ArrayBlockingQueue.Itrs itrs;\n    }\n\npublic ArrayBlockingQueue(int capacity) {\n      this(capacity, false);\n}\n\npublic ArrayBlockingQueue(int capacity, boolean fair) {\n    if (capacity <= 0)\n        throw new IllegalArgumentException();\n    this.items = new Object[capacity];\n    lock = new ReentrantLock(fair);\n    notEmpty = lock.newCondition();\n    notFull =  lock.newCondition();\n}\n```\n\n\n\n```java\n//===============================================================\npublic void put(E e) throws InterruptedException {\n    checkNotNull(e);\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == items.length)\n            notFull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate void enqueue(E x) {\n    final Object[] items = this.items;\n    items[putIndex] = x;\n    if (++putIndex == items.length)\n        putIndex = 0;\n    count++;\n    notEmpty.signal();\n}\n\n//===============================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == 0)\n            notEmpty.await();\n        return dequeue();\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate E dequeue() {\n    final Object[] items = this.items;\n    E x = (E) items[takeIndex];\n    items[takeIndex] = null;\n    if (++takeIndex == items.length)\n        takeIndex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementDequeued();\n    notFull.signal();\n    return x;\n}\n```\n\n\n\n- `ReentrantLock`\n- `count`\n- `count`0\n- `putIndex``takeIndex`items.length0<font color=red></font>\n\n![](blockingqueue/2.png)\n\n![](blockingqueue/3.png)\n\nArrayBlockingQueueReentrantLockCondition\n\n\n## LinkedBlockingQueue\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>LinkedBlockingQueue`Integer.MAX_VALUE`\n\n****\n\n```java\n// \nprivate final int capacity;\n// ,\nprivate final AtomicInteger count = new AtomicInteger();\n// \ntransient Node<E> head;\n// \nprivate transient Node<E> last;\n// \nprivate final ReentrantLock takeLock = new ReentrantLock();\n// notEmpty\n// notEmpty.await()\nprivate final Condition notEmpty = takeLock.newCondition();\n// \nprivate final ReentrantLock putLock = new ReentrantLock();\n// notFull\n// notFull.await()\nprivate final Condition notFull = putLock.newCondition();\n\nstatic class Node<E> {\n    E item;\n    Node<E> next;\n    Node(E x) { item = x; }\n}\n```\n\n\n\n```java\n//==================================================================\npublic void put(E e) throws InterruptedException {\n    if (e == null) throw new NullPointerException();\n    int c = -1;\n    Node<E> node = new Node<E>(e);\n    final ReentrantLock putLock = this.putLock;\n    final AtomicInteger count = this.count;\n    putLock.lockInterruptibly();\n    try {\n        while (count.get() == capacity) {\n            notFull.await();\n        }\n        enqueue(node);\n        //CAS++count\n        c = count.getAndIncrement();\n        //\n        if (c + 1 < capacity)\n            notFull.signal();\n    } finally {\n        putLock.unlock();\n    }\n    if (c == 0)\n        signalNotEmpty(); // notEmpty.signal()\n}\n\nprivate void enqueue(Node<E> node) {\n    last = last.next = node;\n}\n\n//======================================================\npublic E take() throws InterruptedException {\n    E x;\n    int c = -1;\n    final AtomicInteger count = this.count;\n    final ReentrantLock takeLock = this.takeLock;\n    takeLock.lockInterruptibly();\n    try {\n        while (count.get() == 0) {\n            notEmpty.await();\n        }\n        x = dequeue();\n        c = count.getAndDecrement();\n        if (c > 1)\n            notEmpty.signal();\n    } finally {\n        takeLock.unlock();\n    }\n    if (c == capacity)\n        signalNotFull();\n    return x;\n}\n\nprivate E dequeue() {\n    Node<E> h = head;\n    Node<E> first = h.next;\n    h.next = h; // help GC\n    head = first;\n    E x = first.item;\n    first.item = null;\n    return x;\n}\n```\n\n\n\n- putLock,takeLock\n- (AtomicInteger)count++CAS\n\n![LinkedBlockingQueue](blockingqueue/5.png)\n\n**ArrayBlockingQueueLinkedBlockingQueue**\n\n- \n  - \n- \n  - ArrayBlockingQueueLinkedBlockingQueue\n  - ArrayBlockingQueueLinkedBlockingQueue/GC\n\n## PriorityBlockingQueue\n\n  <font color=red></font> <font color=red></font><font color=red></font><font color=red></font><font color=red></font><font color=red></font><font color=red>FIFO</font>\n\nPriorityBlockingQueue\n\n```java\n// 11\nprivate static final int DEFAULT_INITIAL_CAPACITY = 11;\n// \nprivate static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;\n// \nprivate transient Object[] queue;\n// \nprivate transient int size;\n// \nprivate transient Comparator<? super E> comparator;\n//  ArrayBlockingQueue\nprivate final ReentrantLock lock;\n// \nprivate final Condition notEmpty;\n// CASCPU\nprivate transient volatile int allocationSpinLock;\n// /\nprivate PriorityQueue<E> q;\n\npublic PriorityBlockingQueue(int initialCapacity,\n                             Comparator<? super E> comparator) {\n    if (initialCapacity < 1)\n        throw new IllegalArgumentException();\n    this.lock = new ReentrantLock();\n    this.notEmpty = lock.newCondition();\n    this.comparator = comparator;\n    this.queue = new Object[initialCapacity];\n}\n```\n\n****\n\n```java\n//==================================================\npublic void put(E e) {\n    offer(e);\n}\n\npublic boolean offer(E e) {\n    if (e == null)\n        throw new NullPointerException();\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    int n, cap;\n    Object[] array;\n    while ((n = size) >= (cap = (array = queue).length))\n    \t//\n        tryGrow(array, cap);\n    try {\n        Comparator<? super E> cmp = comparator;\n        //\n        if (cmp == null)\n            siftUpComparable(n, e, array); //\n        else\n            siftUpUsingComparator(n, e, array, cmp); //\n        size = n + 1;\n        notEmpty.signal();\n    } finally {\n        lock.unlock();\n    }\n    return true;\n}\n\n//==================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    E result;\n    try {\n        while ( (result = dequeue()) == null)\n            notEmpty.await();\n    } finally {\n        lock.unlock();\n    }\n    return result;\n}\n\nprivate E dequeue() {\n    int n = size - 1;\n    if (n < 0)\n        return null;\n    else {\n        Object[] array = queue;\n        E result = (E) array[0]; //\n        E x = (E) array[n]; // \n        array[n] = null;\n        Comparator<? super E> cmp = comparator;\n        // \n        if (cmp == null)\n            siftDownComparable(0, x, array, n);\n        else\n            siftDownUsingComparator(0, x, array, n, cmp);\n        size = n;\n        return result;\n    }\n}\n```\n\n- PriorityBlockingQueue\n- notEmptynotEmtry\n- allocationSpinLockCAS\n- PriorityBlockingQueueComparator\n- [](https://mp.weixin.qq.com/s?__biz=MzkxNDEyOTI0OQ==&mid=2247484450&amp;idx=1&amp;sn=2be695dbf92e1e209a405422e8da5616&source=41#wechat_redirect)\n- \n- ()\n\n![PriorityBlockingQueue](blockingqueue/6.png)\n\n![PriorityBlockingQueue](blockingqueue/7.png)\n\n## ConcurrentLinkedQueue\n\n  <font color=red></font> <font color=red></font><font color=red>CAS</font><font color=red></font><font color=red>FIFO</font>\n\nArrayBlockingQueueLinkedBlockingQueueCASConcurrentLinkedQueueCASCASCASCASCPU\n\n(ConcurrentLinkedQueue[J.U.CJavaConcurrentLinkedQueue](http://cmsblogs.com/?p=2353))\n\n| queue                 |  |  |   |                        |                       |\n| --------------------- | -------- | -------- | ------------- | ------------------------------ | ----------------------------- |\n| ArrayBlockingQueue    |      |      |     |  | --                            |\n| LinkedBlockingQueue   |      |    | 2 |  |     |\n| ConcurrentLinkedQueue |    |      | CAS           |            | size()  |","slug":"blockingqueue","published":1,"updated":"2021-04-08T00:47:06.707Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhu00000qwv2glga3xcy","content":"<h2 id=\"BlockingQueue\"><a href=\"#BlockingQueue\" class=\"headerlink\" title=\"BlockingQueue\"></a>BlockingQueue</h2><p>Java<code>BlockingQueue</code>Queue<font color=\"red\"></font></p>\n<p><img src=\"/2020/10/30/blockingqueue/0.png\" alt=\"BlockingQueue\"></p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"></td>\n<td align=\"left\">add(o)</td>\n<td align=\"left\">offer(o)</td>\n<td align=\"left\">put(o)</td>\n<td>offer(o, timeout, timeunit)</td>\n</tr>\n<tr>\n<td align=\"left\"></td>\n<td align=\"left\">remove(o)</td>\n<td align=\"left\">poll()</td>\n<td align=\"left\">take(o)</td>\n<td>poll(o, timeout, timeunit)</td>\n</tr>\n<tr>\n<td align=\"left\"></td>\n<td align=\"left\">element()</td>\n<td align=\"left\">peek()</td>\n<td align=\"left\"></td>\n<td></td>\n</tr>\n</tbody></table>\n<a id=\"more\"></a>\n\n<ul>\n<li>IllegalStateException(Queue full)NoSuchElementException</li>\n<li><ul>\n<li>  truefalse</li>\n<li> null</li>\n</ul>\n</li>\n<li></li>\n</ul>\n<p>JDKBlockingQueue ArrayBlockingQueueLinkedBlockingQueuePriorityBlockingQueueDelayQueueSynchronousQueueLinkedTransferQueueLinkedBlockingDeque</p>\n<p><img src=\"/2020/10/30/blockingqueue/1.png\" alt=\"\"></p>\n<h2 id=\"ArrayBlockingQueue\"><a href=\"#ArrayBlockingQueue\" class=\"headerlink\" title=\"ArrayBlockingQueue\"></a>ArrayBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<pre class=\" language-java\"><code class=\"language-java\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ArrayBlockingQueue</span><span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractQueue</span><span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BlockingQueue</span><span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> Serializable <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>817911632652898426L<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">final</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> items<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">int</span> takeIndex<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">int</span> putIndex<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// ,</span>\n        <span class=\"token keyword\">final</span> ReentrantLock lock<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// notEmpty.await()</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Condition notEmpty<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// notFull.await()</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Condition notFull<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">transient</span> ArrayBlockingQueue<span class=\"token punctuation\">.</span>Itrs itrs<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token function\">ArrayBlockingQueue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> capacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>capacity<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token function\">ArrayBlockingQueue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> capacity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> fair<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>capacity <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span>capacity<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span>fair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    notEmpty <span class=\"token operator\">=</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    notFull <span class=\"token operator\">=</span>  lock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//===============================================================</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>E e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> ReentrantLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">;</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">==</span> items<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n            notFull<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>E x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">;</span>\n    items<span class=\"token punctuation\">[</span>putIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>putIndex <span class=\"token operator\">==</span> items<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n        putIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//===============================================================</span>\n<span class=\"token keyword\">public</span> E <span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> ReentrantLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">;</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> E <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">;</span>\n    E x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span> items<span class=\"token punctuation\">[</span>takeIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    items<span class=\"token punctuation\">[</span>takeIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>takeIndex <span class=\"token operator\">==</span> items<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n        takeIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    count<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itrs <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n        itrs<span class=\"token punctuation\">.</span><span class=\"token function\">elementDequeued</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    notFull<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<ul>\n<li><code>ReentrantLock</code></li>\n<li><code>count</code></li>\n<li><code>count</code>0</li>\n<li><code>putIndex</code><code>takeIndex</code>items.length0<font color=\"red\"></font></li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/2.png\" alt=\"\"></p>\n<p><img src=\"/2020/10/30/blockingqueue/3.png\" alt=\"\"></p>\n<p>ArrayBlockingQueueReentrantLockCondition</p>\n<h2 id=\"LinkedBlockingQueue\"><a href=\"#LinkedBlockingQueue\" class=\"headerlink\" title=\"LinkedBlockingQueue\"></a>LinkedBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font>LinkedBlockingQueue<code>Integer.MAX_VALUE</code></p>\n<p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> capacity<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// ,</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> AtomicInteger count <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">transient</span> Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> head<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> last<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> ReentrantLock takeLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// notEmpty</span>\n<span class=\"token comment\" spellcheck=\"true\">// notEmpty.await()</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Condition notEmpty <span class=\"token operator\">=</span> takeLock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> ReentrantLock putLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// notFull</span>\n<span class=\"token comment\" spellcheck=\"true\">// notFull.await()</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Condition notFull <span class=\"token operator\">=</span> putLock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    E item<span class=\"token punctuation\">;</span>\n    Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> next<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">Node</span><span class=\"token punctuation\">(</span>E x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> item <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//==================================================================</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>E e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> ReentrantLock putLock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>putLock<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> AtomicInteger count <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">;</span>\n    putLock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> capacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            notFull<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//CAS++count</span>\n        c <span class=\"token operator\">=</span> count<span class=\"token punctuation\">.</span><span class=\"token function\">getAndIncrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;</span> capacity<span class=\"token punctuation\">)</span>\n            notFull<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        putLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">signalNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// notEmpty.signal()</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    last <span class=\"token operator\">=</span> last<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//======================================================</span>\n<span class=\"token keyword\">public</span> E <span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    E x<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> AtomicInteger count <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> ReentrantLock takeLock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>takeLock<span class=\"token punctuation\">;</span>\n    takeLock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        x <span class=\"token operator\">=</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        c <span class=\"token operator\">=</span> count<span class=\"token punctuation\">.</span><span class=\"token function\">getAndDecrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        takeLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> capacity<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">signalNotFull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> E <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> h <span class=\"token operator\">=</span> head<span class=\"token punctuation\">;</span>\n    Node<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> first <span class=\"token operator\">=</span> h<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n    h<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> h<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// help GC</span>\n    head <span class=\"token operator\">=</span> first<span class=\"token punctuation\">;</span>\n    E x <span class=\"token operator\">=</span> first<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">;</span>\n    first<span class=\"token punctuation\">.</span>item <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<ul>\n<li>putLock,takeLock</li>\n<li>(AtomicInteger)count++CAS</li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/5.png\" alt=\"LinkedBlockingQueue\"></p>\n<p><strong>ArrayBlockingQueueLinkedBlockingQueue</strong></p>\n<ul>\n<li><ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li>ArrayBlockingQueueLinkedBlockingQueue</li>\n<li>ArrayBlockingQueueLinkedBlockingQueue/GC</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"PriorityBlockingQueue\"><a href=\"#PriorityBlockingQueue\" class=\"headerlink\" title=\"PriorityBlockingQueue\"></a>PriorityBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<p>PriorityBlockingQueue</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">// 11</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> DEFAULT_INITIAL_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> MAX_ARRAY_SIZE <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>MAX_VALUE <span class=\"token operator\">-</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> queue<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> Comparator<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> E<span class=\"token operator\">></span> comparator<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//  ArrayBlockingQueue</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> ReentrantLock lock<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Condition notEmpty<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// CASCPU</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> allocationSpinLock<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// /</span>\n<span class=\"token keyword\">private</span> PriorityQueue<span class=\"token operator\">&lt;</span>E<span class=\"token operator\">></span> q<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token function\">PriorityBlockingQueue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">,</span>\n                             Comparator<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> E<span class=\"token operator\">></span> comparator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialCapacity <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>notEmpty <span class=\"token operator\">=</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>comparator <span class=\"token operator\">=</span> comparator<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span>initialCapacity<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//==================================================</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>E e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>E e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> ReentrantLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">;</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">,</span> cap<span class=\"token punctuation\">;</span>\n    Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> array<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=</span> size<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>cap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>array <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token function\">tryGrow</span><span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">,</span> cap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        Comparator<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> E<span class=\"token operator\">></span> cmp <span class=\"token operator\">=</span> comparator<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">siftUpComparable</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">else</span>\n            <span class=\"token function\">siftUpUsingComparator</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">,</span> cmp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        size <span class=\"token operator\">=</span> n <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//==================================================</span>\n<span class=\"token keyword\">public</span> E <span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> ReentrantLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">;</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    E result<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">=</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            notEmpty<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> E <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> array <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">;</span>\n        E result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span> array<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        E x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span> array<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// </span>\n        array<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n        Comparator<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> E<span class=\"token operator\">></span> cmp <span class=\"token operator\">=</span> comparator<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// </span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">siftDownComparable</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span>\n            <span class=\"token function\">siftDownUsingComparator</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> cmp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        size <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<ul>\n<li>PriorityBlockingQueue</li>\n<li>notEmptynotEmtry</li>\n<li>allocationSpinLockCAS</li>\n<li>PriorityBlockingQueueComparator</li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzkxNDEyOTI0OQ==&mid=2247484450&amp;idx=1&amp;sn=2be695dbf92e1e209a405422e8da5616&source=41#wechat_redirect\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li></li>\n<li>()</li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/6.png\" alt=\"PriorityBlockingQueue\"></p>\n<p><img src=\"/2020/10/30/blockingqueue/7.png\" alt=\"PriorityBlockingQueue\"></p>\n<h2 id=\"ConcurrentLinkedQueue\"><a href=\"#ConcurrentLinkedQueue\" class=\"headerlink\" title=\"ConcurrentLinkedQueue\"></a>ConcurrentLinkedQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\">CAS</font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<p>ArrayBlockingQueueLinkedBlockingQueueCASConcurrentLinkedQueueCASCASCASCASCPU</p>\n<p>(ConcurrentLinkedQueue<a href=\"http://cmsblogs.com/?p=2353\" target=\"_blank\" rel=\"noopener\">J.U.CJavaConcurrentLinkedQueue</a>)</p>\n<table>\n<thead>\n<tr>\n<th>queue</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ArrayBlockingQueue</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>LinkedBlockingQueue</td>\n<td></td>\n<td></td>\n<td>2</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>ConcurrentLinkedQueue</td>\n<td></td>\n<td></td>\n<td>CAS</td>\n<td></td>\n<td>size() </td>\n</tr>\n</tbody></table>\n","site":{"data":{}},"excerpt":"<h2 id=\"BlockingQueue\"><a href=\"#BlockingQueue\" class=\"headerlink\" title=\"BlockingQueue\"></a>BlockingQueue</h2><p>Java<code>BlockingQueue</code>Queue<font color=\"red\"></font></p>\n<p><img src=\"/2020/10/30/blockingqueue/0.png\" alt=\"BlockingQueue\"></p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th align=\"left\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"></td>\n<td align=\"left\">add(o)</td>\n<td align=\"left\">offer(o)</td>\n<td align=\"left\">put(o)</td>\n<td>offer(o, timeout, timeunit)</td>\n</tr>\n<tr>\n<td align=\"left\"></td>\n<td align=\"left\">remove(o)</td>\n<td align=\"left\">poll()</td>\n<td align=\"left\">take(o)</td>\n<td>poll(o, timeout, timeunit)</td>\n</tr>\n<tr>\n<td align=\"left\"></td>\n<td align=\"left\">element()</td>\n<td align=\"left\">peek()</td>\n<td align=\"left\"></td>\n<td></td>\n</tr>\n</tbody></table>","more":"<ul>\n<li>IllegalStateException(Queue full)NoSuchElementException</li>\n<li><ul>\n<li>  truefalse</li>\n<li> null</li>\n</ul>\n</li>\n<li></li>\n</ul>\n<p>JDKBlockingQueue ArrayBlockingQueueLinkedBlockingQueuePriorityBlockingQueueDelayQueueSynchronousQueueLinkedTransferQueueLinkedBlockingDeque</p>\n<p><img src=\"/2020/10/30/blockingqueue/1.png\" alt=\"\"></p>\n<h2 id=\"ArrayBlockingQueue\"><a href=\"#ArrayBlockingQueue\" class=\"headerlink\" title=\"ArrayBlockingQueue\"></a>ArrayBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<pre><code class=\"java\">  public class ArrayBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements BlockingQueue&lt;E&gt;, Serializable {\n        private static final long serialVersionUID = -817911632652898426L;\n        //\n        final Object[] items;\n        //\n        int takeIndex;\n        //\n        int putIndex;\n        //\n        int count;\n        // ,\n        final ReentrantLock lock;\n        // notEmpty.await()\n        private final Condition notEmpty;\n        // notFull.await()\n        private final Condition notFull;\n        transient ArrayBlockingQueue.Itrs itrs;\n    }\n\npublic ArrayBlockingQueue(int capacity) {\n      this(capacity, false);\n}\n\npublic ArrayBlockingQueue(int capacity, boolean fair) {\n    if (capacity &lt;= 0)\n        throw new IllegalArgumentException();\n    this.items = new Object[capacity];\n    lock = new ReentrantLock(fair);\n    notEmpty = lock.newCondition();\n    notFull =  lock.newCondition();\n}</code></pre>\n<p></p>\n<pre><code class=\"java\">//===============================================================\npublic void put(E e) throws InterruptedException {\n    checkNotNull(e);\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == items.length)\n            notFull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate void enqueue(E x) {\n    final Object[] items = this.items;\n    items[putIndex] = x;\n    if (++putIndex == items.length)\n        putIndex = 0;\n    count++;\n    notEmpty.signal();\n}\n\n//===============================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == 0)\n            notEmpty.await();\n        return dequeue();\n    } finally {\n        lock.unlock();\n    }\n}\n\nprivate E dequeue() {\n    final Object[] items = this.items;\n    E x = (E) items[takeIndex];\n    items[takeIndex] = null;\n    if (++takeIndex == items.length)\n        takeIndex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementDequeued();\n    notFull.signal();\n    return x;\n}</code></pre>\n<p></p>\n<ul>\n<li><code>ReentrantLock</code></li>\n<li><code>count</code></li>\n<li><code>count</code>0</li>\n<li><code>putIndex</code><code>takeIndex</code>items.length0<font color=\"red\"></font></li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/2.png\" alt=\"\"></p>\n<p><img src=\"/2020/10/30/blockingqueue/3.png\" alt=\"\"></p>\n<p>ArrayBlockingQueueReentrantLockCondition</p>\n<h2 id=\"LinkedBlockingQueue\"><a href=\"#LinkedBlockingQueue\" class=\"headerlink\" title=\"LinkedBlockingQueue\"></a>LinkedBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font>LinkedBlockingQueue<code>Integer.MAX_VALUE</code></p>\n<p><strong></strong></p>\n<pre><code class=\"java\">// \nprivate final int capacity;\n// ,\nprivate final AtomicInteger count = new AtomicInteger();\n// \ntransient Node&lt;E&gt; head;\n// \nprivate transient Node&lt;E&gt; last;\n// \nprivate final ReentrantLock takeLock = new ReentrantLock();\n// notEmpty\n// notEmpty.await()\nprivate final Condition notEmpty = takeLock.newCondition();\n// \nprivate final ReentrantLock putLock = new ReentrantLock();\n// notFull\n// notFull.await()\nprivate final Condition notFull = putLock.newCondition();\n\nstatic class Node&lt;E&gt; {\n    E item;\n    Node&lt;E&gt; next;\n    Node(E x) { item = x; }\n}</code></pre>\n<p></p>\n<pre><code class=\"java\">//==================================================================\npublic void put(E e) throws InterruptedException {\n    if (e == null) throw new NullPointerException();\n    int c = -1;\n    Node&lt;E&gt; node = new Node&lt;E&gt;(e);\n    final ReentrantLock putLock = this.putLock;\n    final AtomicInteger count = this.count;\n    putLock.lockInterruptibly();\n    try {\n        while (count.get() == capacity) {\n            notFull.await();\n        }\n        enqueue(node);\n        //CAS++count\n        c = count.getAndIncrement();\n        //\n        if (c + 1 &lt; capacity)\n            notFull.signal();\n    } finally {\n        putLock.unlock();\n    }\n    if (c == 0)\n        signalNotEmpty(); // notEmpty.signal()\n}\n\nprivate void enqueue(Node&lt;E&gt; node) {\n    last = last.next = node;\n}\n\n//======================================================\npublic E take() throws InterruptedException {\n    E x;\n    int c = -1;\n    final AtomicInteger count = this.count;\n    final ReentrantLock takeLock = this.takeLock;\n    takeLock.lockInterruptibly();\n    try {\n        while (count.get() == 0) {\n            notEmpty.await();\n        }\n        x = dequeue();\n        c = count.getAndDecrement();\n        if (c &gt; 1)\n            notEmpty.signal();\n    } finally {\n        takeLock.unlock();\n    }\n    if (c == capacity)\n        signalNotFull();\n    return x;\n}\n\nprivate E dequeue() {\n    Node&lt;E&gt; h = head;\n    Node&lt;E&gt; first = h.next;\n    h.next = h; // help GC\n    head = first;\n    E x = first.item;\n    first.item = null;\n    return x;\n}</code></pre>\n<p></p>\n<ul>\n<li>putLock,takeLock</li>\n<li>(AtomicInteger)count++CAS</li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/5.png\" alt=\"LinkedBlockingQueue\"></p>\n<p><strong>ArrayBlockingQueueLinkedBlockingQueue</strong></p>\n<ul>\n<li><ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li>ArrayBlockingQueueLinkedBlockingQueue</li>\n<li>ArrayBlockingQueueLinkedBlockingQueue/GC</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"PriorityBlockingQueue\"><a href=\"#PriorityBlockingQueue\" class=\"headerlink\" title=\"PriorityBlockingQueue\"></a>PriorityBlockingQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<p>PriorityBlockingQueue</p>\n<pre><code class=\"java\">// 11\nprivate static final int DEFAULT_INITIAL_CAPACITY = 11;\n// \nprivate static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;\n// \nprivate transient Object[] queue;\n// \nprivate transient int size;\n// \nprivate transient Comparator&lt;? super E&gt; comparator;\n//  ArrayBlockingQueue\nprivate final ReentrantLock lock;\n// \nprivate final Condition notEmpty;\n// CASCPU\nprivate transient volatile int allocationSpinLock;\n// /\nprivate PriorityQueue&lt;E&gt; q;\n\npublic PriorityBlockingQueue(int initialCapacity,\n                             Comparator&lt;? super E&gt; comparator) {\n    if (initialCapacity &lt; 1)\n        throw new IllegalArgumentException();\n    this.lock = new ReentrantLock();\n    this.notEmpty = lock.newCondition();\n    this.comparator = comparator;\n    this.queue = new Object[initialCapacity];\n}</code></pre>\n<p><strong></strong></p>\n<pre><code class=\"java\">//==================================================\npublic void put(E e) {\n    offer(e);\n}\n\npublic boolean offer(E e) {\n    if (e == null)\n        throw new NullPointerException();\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    int n, cap;\n    Object[] array;\n    while ((n = size) &gt;= (cap = (array = queue).length))\n        //\n        tryGrow(array, cap);\n    try {\n        Comparator&lt;? super E&gt; cmp = comparator;\n        //\n        if (cmp == null)\n            siftUpComparable(n, e, array); //\n        else\n            siftUpUsingComparator(n, e, array, cmp); //\n        size = n + 1;\n        notEmpty.signal();\n    } finally {\n        lock.unlock();\n    }\n    return true;\n}\n\n//==================================================\npublic E take() throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    E result;\n    try {\n        while ( (result = dequeue()) == null)\n            notEmpty.await();\n    } finally {\n        lock.unlock();\n    }\n    return result;\n}\n\nprivate E dequeue() {\n    int n = size - 1;\n    if (n &lt; 0)\n        return null;\n    else {\n        Object[] array = queue;\n        E result = (E) array[0]; //\n        E x = (E) array[n]; // \n        array[n] = null;\n        Comparator&lt;? super E&gt; cmp = comparator;\n        // \n        if (cmp == null)\n            siftDownComparable(0, x, array, n);\n        else\n            siftDownUsingComparator(0, x, array, n, cmp);\n        size = n;\n        return result;\n    }\n}</code></pre>\n<ul>\n<li>PriorityBlockingQueue</li>\n<li>notEmptynotEmtry</li>\n<li>allocationSpinLockCAS</li>\n<li>PriorityBlockingQueueComparator</li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzkxNDEyOTI0OQ==&mid=2247484450&amp;idx=1&amp;sn=2be695dbf92e1e209a405422e8da5616&source=41#wechat_redirect\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li></li>\n<li>()</li>\n</ul>\n<p><img src=\"/2020/10/30/blockingqueue/6.png\" alt=\"PriorityBlockingQueue\"></p>\n<p><img src=\"/2020/10/30/blockingqueue/7.png\" alt=\"PriorityBlockingQueue\"></p>\n<h2 id=\"ConcurrentLinkedQueue\"><a href=\"#ConcurrentLinkedQueue\" class=\"headerlink\" title=\"ConcurrentLinkedQueue\"></a>ConcurrentLinkedQueue</h2><p>  <font color=\"red\"></font> <font color=\"red\"></font><font color=\"red\">CAS</font><font color=\"red\"></font><font color=\"red\">FIFO</font></p>\n<p>ArrayBlockingQueueLinkedBlockingQueueCASConcurrentLinkedQueueCASCASCASCASCPU</p>\n<p>(ConcurrentLinkedQueue<a href=\"http://cmsblogs.com/?p=2353\" target=\"_blank\" rel=\"noopener\">J.U.CJavaConcurrentLinkedQueue</a>)</p>\n<table>\n<thead>\n<tr>\n<th>queue</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ArrayBlockingQueue</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>LinkedBlockingQueue</td>\n<td></td>\n<td></td>\n<td>2</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>ConcurrentLinkedQueue</td>\n<td></td>\n<td></td>\n<td>CAS</td>\n<td></td>\n<td>size() </td>\n</tr>\n</tbody></table>"},{"title":"JAVA","description":"","date":"2018-01-18T13:10:00.000Z","_content":"## ?\n\n- T1 \n- T2 \n- T3 \n\nT1 + T3  T2\n,****:\n- \n- \n\n\n\n- LinuxAPI\n-  Java512K1MJVM\n- **loadCPU sy20%)**\n- CPU\n<!--more-->\n## \n\n### \n![](executorservice/1.png)\nExecutor<font color=#FF0000 >execute</font>\nExecutors\n\n### \n```java\npublic ThreadPoolExecutor(int corePoolSize,\n                          int maximumPoolSize,\n                          long keepAliveTime,\n                          TimeUnit unit,\n                          BlockingQueue<Runnable> workQueue,\n                          ThreadFactory threadFactory,\n                          RejectedExecutionHandler handler)\n```\n\n|             |                                                          |\n| --------------- | ------------------------------------------------------------ |\n| corePoolSize    |  |\n| maximumPoolSize |                                    |\n| keepAliveTime   |                                            |\n| workQueue       |                                |\n| threadFactory   |            |\n| handler         |  AbortPolicy |\n\n\n\n### \n\n![](executorservice/2.png)\n\ncorePoolSize = 2 \nkeepAliveTime = 10ms\nmaximumPoolSize = 3\nworkQueue = ArrayBlockingQueue(3)\n\n:\n1. A,, <  ,\n2. B,1. <  ,\n3. C, > ,workQueue\n4. DEF.....,3,DE\n5. F,  < ,F\n6. GABworkQueueCDE, =,G\n7. A,CworkQueue,\n\n**keepAliveTime** : F FkeepAliveTime >  & workQueue \n\n:\n\n|  |                                                         |              |\n| ---- | ----------------------------------------------------------- | ---------------- |\n| 1    |  < corePoolSize                                       |        |\n| 2    |   corePoolSize workQueue                     |        |\n| 3    | corePoolSize    maximumPoolSize workQueue  |        |\n| 4    |   maximumPoolSize workQueue                  |  |\n\n :\n\n- ()\n- allowCoreThreadTimeOuttrue\n- workQueuekeepAliveTime\n\n### \n  corePoolSize3\n\n|                 |        |                                                          |\n| --------------------- | ---------- | ------------------------------------------------------------ |\n| SynchronousQueue      |    |  |\n| ArrayBlockingQueue    |    |  FIFO              |\n| LinkedBlockingQueue   |    |  FIFO              |\n| PriorityBlockingQueue |  |                                          |\n\n### \n maximumPoolSize workQueue Java 4\n\n|               |                                           |\n| ------------------- | --------------------------------------------- |\n| AbortPolicy         |  RejectedExecutionException |\n| DiscardPolicy       |                   |\n| DiscardOldestPolicy |               |\n| CallerRunsPolicy    |                           |\n\n```java\n//\nThreadPoolExecutor executor = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES,new ArrayBlockingQueue<>(1),\nnew ThreadPoolExecutor.AbortPolicy());\n//\nThreadPoolExecutor executor2 = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES , new ArrayBlockingQueue<>(1),\n        new RejectedExecutionHandler(){\n            @Override\n            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n \t\t\t\t//doSomeing   \n            }\n });\n```\n\n\n\n## \n\nExecutors\n### newFixedThreadPool\n\n =  / \n```\n    public static ExecutorService newFixedThreadPool(int nThreads) {\n        return new ThreadPoolExecutor(nThreads, nThreads,\n                                      0L, TimeUnit.MILLISECONDS,\n                                      new LinkedBlockingQueue<Runnable>());\n    }\n```\n****\n\n### newCachedThreadPool\n60\n**SynchronousQueue**\n\n```\n    public static ExecutorService newCachedThreadPool() {\n        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                      60L, TimeUnit.SECONDS,\n                                      new SynchronousQueue<Runnable>());\n    }\n```\n****\n60\n****,\n### newSingleThreadExecutor\n1 newFixedThreadPool(1) \n```\n    public static ExecutorService newSingleThreadExecutor() {\n        return new FinalizableDelegatedExecutorService\n            (new ThreadPoolExecutor(1, 1,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue<Runnable>()));\n    }\n\n```\n****\n\n### newScheduledThreadPool\n\n```\n    public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {\n        return new ScheduledThreadPoolExecutor(corePoolSize);\n    }\n   public ScheduledThreadPoolExecutor(int corePoolSize) {\n        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\n              new DelayedWorkQueue());\n    }\n\n\n```\n\n## ThreadPoolExecutor\n\n### executresubmit\n\nexecutesubmittaskFutureTaskFutureTask[Fork/join](http://xuzyblog.top/2020/07/30/fork-join/)\n\n```java\n@Test\npublic void testError() throws InterruptedException, ExecutionException {\n    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(10, 20, 60L, TimeUnit.MINUTES, new LinkedBlockingQueue<>());\n    threadPoolExecutor.execute(() -> {\n        System.out.println(\"-execute\");\n    });\n    Future future = threadPoolExecutor.submit(() -> {\n        System.out.println(\"-submit\");\n    });\n    future.get();\n}\n```\n\n```java\njava.util.concurrent.AbstractExecutorService\n\nprotected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {\n    return new FutureTask<T>(callable);\n}\n\nprotected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {\n        return new FutureTask<T>(runnable, value);\n}\n\n//Runable Future\npublic Future<?> submit(Runnable task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture<Void> ftask = newTaskFor(task, null);\n    //execute\n    execute(ftask);\n    return ftask;\n}\n\n//Callable Future\npublic <T> Future<T> submit(Callable<T> task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture<T> ftask = newTaskFor(task);\n    execute(ftask);\n    return ftask;\n}\n```\n\nexecute(Runnable task)  submit(Runnable task) task  <font color=red>execturetaskWorkerWorkerThredtaskWorker</font>\n\n![](executorservice/3.png)\n\n### \n\n 32 \n\n-  3 \n-  29  29  5 \n\n```java\n//ThreadPoolExecutor\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\n//\n//1291 00000000 00000000 00000000 00000001 --> 001 0000 00000000 00000000 00000000 - 1 = 536870911\nprivate static final int CAPACITY   = (1 << COUNT_BITS) - 1;\n\n//===\n//RUNNING - \n//SHUTDOWN - \n//STOP - \n//TIDYING - workCount0TIDYINGterminated()\n//TERMINATED - terminated()\nprivate static final int RUNNING    = -1 << COUNT_BITS;\nprivate static final int SHUTDOWN   =  0 << COUNT_BITS;\nprivate static final int STOP       =  1 << COUNT_BITS;\nprivate static final int TIDYING    =  2 << COUNT_BITS;\nprivate static final int TERMINATED =  3 << COUNT_BITS;\n//task\nprivate final BlockingQueue<Runnable> workQueue;\n//worker\nprivate final HashSet<Worker> workers = new HashSet<Worker>();\n//WorkerThread t\nprivate volatile ThreadFactory threadFactory;\n//\nprivate volatile RejectedExecutionHandler handler;\n//\nprivate volatile long keepAliveTime;\n//\nprivate volatile int corePoolSize;\n//\nprivate volatile int maximumPoolSize;\n```\n\n![](executorservice/4.png)\n\n### Worker\n\nWorkerAQSRunableAQSWorker\n\n**WorkerReentrantLockAQS ?**  tryAcquireReentrantLock\n\nWorker<font color=red></font>Runnable command\n\n```java\nprivate final class Worker extends AbstractQueuedSynchronizer implements Runnable{\n    \n    private static final long serialVersionUID = 6138294804551838833L;\n    //\n    final Thread thread;\n    //new Workerfirstnew Worker\n    //null,\n    Runnable firstTask;\n    // volatile\n    volatile long completedTasks;\n\n    \n    Worker(Runnable firstTask) {\n        setState(-1);\n        this.firstTask = firstTask;\n        this.thread = getThreadFactory().newThread(this);\n    }\n\n    public void run() {\n        runWorker(this);\n    }\n\n    protected boolean isHeldExclusively() {\n        return getState() != 0;\n    }\n\n    protected boolean tryAcquire(int unused) {\n        if (compareAndSetState(0, 1)) {\n            setExclusiveOwnerThread(Thread.currentThread());\n            return true;\n        }\n        return false;\n    }\n\n    protected boolean tryRelease(int unused) {\n        setExclusiveOwnerThread(null);\n        setState(0);\n        return true;\n    }\n\n    public void lock()        { acquire(1); }\n    public boolean tryLock()  { return tryAcquire(1); }\n    public void unlock()      { release(1); }\n    public boolean isLocked() { return isHeldExclusively(); }\n\n    void interruptIfStarted() {\n        Thread t;\n        if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n            try {\n                t.interrupt();\n            } catch (SecurityException ignore) {\n            }\n        }\n    }\n}\n```\n\n\n\n### \n\n![](executorservice/1.jpg)\n\n#### execute\n\n\n```java\npublic void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    int c = ctl.get();\n    //Worker\n    if (workerCountOf(c) < corePoolSize) {\n        //newworker command (firstTask)\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n    \n    // addWorker \n    \n    //RUNNING\n    //offer - true, false\n    if (isRunning(c) && workQueue.offer(command)) {\n        int recheck = ctl.get();\n        //\n        if (! isRunning(recheck) && remove(command)){\n         \treject(command);   \n        }\n        // RUNNING  0\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n    // maximumPoolSize  worker\n    else if (!addWorker(command, false)){\n        reject(command); //   \n    }\n}\n```\n\n#### addWorker\n\n```java\n//core = true  corePoolSize \n//core = flase  maximumPoolSize \nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\n        // addWorker\n        if (rs >= SHUTDOWN &&\n            ! (rs == SHUTDOWN &&\n               firstTask == null &&\n               ! workQueue.isEmpty()))\n            return false;\n\n        for (;;) {\n            //worker\n            int wc = workerCountOf(c);\n            //false\n            if (wc >= CAPACITY ||\n                wc >= (core ? corePoolSize : maximumPoolSize))\n                return false;\n            //+1new Worker,\n            if (compareAndIncrementWorkerCount(c))\n                break retry;\n            c = ctl.get(); \n            if (runStateOf(c) != rs)\n                continue retry;\n        }\n    }\n\n    //worker \n    boolean workerStarted = false;\n    // worker  workers  HashSet \n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        //\"\"\n        w = new Worker(firstTask);\n        final Thread t = w.thread;\n        if (t != null) {\n            //mainLockworkers.add(w)\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n\n                int rs = runStateOf(ctl.get());\n\t\t\t   //SHUTTDOWN  RUNNING\n                //SHUTDOWN\n                if (rs < SHUTDOWN || (rs == SHUTDOWN && firstTask == null)) {\n                    if (t.isAlive()) throw new IllegalThreadStateException();\n                    //\"\"workers\n                    workers.add(w);\n                    int s = workers.size();\n                    if (s > largestPoolSize)\n                        largestPoolSize = s;\n                    workerAdded = true;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            if (workerAdded) {\n                //\"\"Worker->run->runWorker(this)\n                t.start();\n                workerStarted = true;\n            }\n        }\n    } finally {\n        // workCount  1\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    return workerStarted;\n}\n\n//\"\"\"\"\nprivate void addWorkerFailed(Worker w) {\n    final ReentrantLock mainLock = this.mainLock;\n    mainLock.lock();\n    try {\n        if (w != null)\n            workers.remove(w);\n        decrementWorkerCount();\n        tryTerminate();\n    } finally {\n        mainLock.unlock();\n    }\n}\n\n```\n\n#### runWorker\n\n```java\n//worker while \nfinal void runWorker(Worker w) {\n    Thread wt = Thread.currentThread();\n    //\n    Runnable task = w.firstTask;\n    w.firstTask = null;\n    w.unlock(); // allow interrupts\n    boolean completedAbruptly = true;\n    try {\n        while (task != null || (task = getTask()) != null) {\n            w.lock();\n            //\n            //(>=STOP  (>=STOP))  \n            //2 : 1. 2.\n            if (\n                ( runStateAtLeast(ctl.get(), STOP) ||\n                  (Thread.interrupted() && runStateAtLeast(ctl.get(), STOP))\n                ) &&\n                !wt.isInterrupted()\n               )\n                wt.interrupt();\n            try {\n                //\n                beforeExecute(wt, task);\n                Throwable thrown = null;\n                try {\n                    //taskRunnableFutureTask\n                    task.run();\n                } catch (RuntimeException x) {\n                    thrown = x; throw x;\n                } catch (Error x) {\n                    thrown = x; throw x;\n                } catch (Throwable x) {\n                    thrown = x; throw new Error(x);\n                } finally {\n                    //\n                    afterExecute(task, thrown);\n                }\n            } finally {\n                // task getTask \n                task = null;\n                //+1\n                w.completedTasks++;\n                //\n                w.unlock();\n            }\n        }\n        completedAbruptly = false;\n    } finally {\n        //\n        //getTask()\n        //worker\n        processWorkerExit(w, completedAbruptly);\n    }\n}\n```\n\nrunWorker\n\n1. whilegetTask()workerQueue\n2. 3.\n3. task.run()\n4. tasknullprocessWorkerExit()`workers.remove(w)`\n\n**keepAliveTime**\n\n+new WorkerWorker\n\n```java\nfinal void runWorker(Worker w) {\n   Thread wt = Thread.currentThread();\n   Runnable task = w.firstTask;\n   w.firstTask = null;\n   w.unlock(); // allow interrupts\n   boolean completedAbruptly = true;\n   try {\n       while (task != null || (task = getTask()) != null) {\n           //\n       }\n       completedAbruptly = false;\n   } finally {\n       //getTask()Worker\n       processWorkerExit(w, completedAbruptly);\n   }\n\n\nprivate Runnable getTask() {\n    boolean timedOut = false; \n    for (;;) {\n        \n        //...\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n        //...\n\n        try {\n        \t//\n        \t//InterruptedException\n        \t//runWorkerprocessWorkerExitWorker\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}\n```\n\n\n\n#### getTask()\n\ngetTaskWorker\n\nnull\n\n-  SHUTDOWN workQueue \n-  STOP workQueue \n- WorkerWorkerkeepAliveTimenull\n\n```java\nprivate Runnable getTask() {\n    boolean timedOut = false;\n\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\t    //1. rs == SHUTDOWN && workQueue.isEmpty()\n        //2. rs >= STOP\n        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n             // CAS \n            decrementWorkerCount();\n            return null;\n        }\n\t    //worker\n        int wc = workerCountOf(c);\n\t    //\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n        if ((wc > maximumPoolSize || (timed && timedOut)) && (wc > 1 || workQueue.isEmpty())) {\n            if (compareAndDecrementWorkerCount(c))\n                return null;\n            continue;\n        }\n        try {\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}\n```\n\n## \n\n### shutdown\n\n\n\n1. shutDown`SHUTDOWN`\n2. \n3. Worker\n4. shutdown()\n\n### shutdownNow\n\n\n\n## \n\n**executesubmit**\n\n```java\nexecutors.execute(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(\"xxx\");\n    }\n});\n//\nException in thread \"pool-1-thread-1\" java.lang.RuntimeException: xxx\n\tat xzy.OtherTest$1.run(OtherTest.java:33)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n\nexecutors.submit(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(\"xxx\");\n    }\n});\n//\n```\n\n**runWorker****task.run()**\n\n- executetask=Runnablerun\n- submitRunnableFutureTasktask=FutureTaskFutureTaskrunget()\n\n```java\ntry {\n       task.run();\n   } catch (RuntimeException x) {\n       thrown = x; throw x;\n   } catch (Error x) {\n       thrown = x; throw x;\n   } catch (Throwable x) {\n       //  Throwable Error\n       thrown = x; throw new Error(x);\n   } finally {\n       //  task \n       afterExecute(task, thrown);\n}\n```\n\n\n\n## \n\n- https://zhuanlan.zhihu.com/p/60524908","source":"_posts/executorservice.md","raw":"---\ntitle: JAVA\ntags:\n  - java\ncategories:  java\ndescription : \ndate: 2018-01-18 21:10:00\n---\n## ?\n\n- T1 \n- T2 \n- T3 \n\nT1 + T3  T2\n,****:\n- \n- \n\n\n\n- LinuxAPI\n-  Java512K1MJVM\n- **loadCPU sy20%)**\n- CPU\n<!--more-->\n## \n\n### \n![](executorservice/1.png)\nExecutor<font color=#FF0000 >execute</font>\nExecutors\n\n### \n```java\npublic ThreadPoolExecutor(int corePoolSize,\n                          int maximumPoolSize,\n                          long keepAliveTime,\n                          TimeUnit unit,\n                          BlockingQueue<Runnable> workQueue,\n                          ThreadFactory threadFactory,\n                          RejectedExecutionHandler handler)\n```\n\n|             |                                                          |\n| --------------- | ------------------------------------------------------------ |\n| corePoolSize    |  |\n| maximumPoolSize |                                    |\n| keepAliveTime   |                                            |\n| workQueue       |                                |\n| threadFactory   |            |\n| handler         |  AbortPolicy |\n\n\n\n### \n\n![](executorservice/2.png)\n\ncorePoolSize = 2 \nkeepAliveTime = 10ms\nmaximumPoolSize = 3\nworkQueue = ArrayBlockingQueue(3)\n\n:\n1. A,, <  ,\n2. B,1. <  ,\n3. C, > ,workQueue\n4. DEF.....,3,DE\n5. F,  < ,F\n6. GABworkQueueCDE, =,G\n7. A,CworkQueue,\n\n**keepAliveTime** : F FkeepAliveTime >  & workQueue \n\n:\n\n|  |                                                         |              |\n| ---- | ----------------------------------------------------------- | ---------------- |\n| 1    |  < corePoolSize                                       |        |\n| 2    |   corePoolSize workQueue                     |        |\n| 3    | corePoolSize    maximumPoolSize workQueue  |        |\n| 4    |   maximumPoolSize workQueue                  |  |\n\n :\n\n- ()\n- allowCoreThreadTimeOuttrue\n- workQueuekeepAliveTime\n\n### \n  corePoolSize3\n\n|                 |        |                                                          |\n| --------------------- | ---------- | ------------------------------------------------------------ |\n| SynchronousQueue      |    |  |\n| ArrayBlockingQueue    |    |  FIFO              |\n| LinkedBlockingQueue   |    |  FIFO              |\n| PriorityBlockingQueue |  |                                          |\n\n### \n maximumPoolSize workQueue Java 4\n\n|               |                                           |\n| ------------------- | --------------------------------------------- |\n| AbortPolicy         |  RejectedExecutionException |\n| DiscardPolicy       |                   |\n| DiscardOldestPolicy |               |\n| CallerRunsPolicy    |                           |\n\n```java\n//\nThreadPoolExecutor executor = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES,new ArrayBlockingQueue<>(1),\nnew ThreadPoolExecutor.AbortPolicy());\n//\nThreadPoolExecutor executor2 = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES , new ArrayBlockingQueue<>(1),\n        new RejectedExecutionHandler(){\n            @Override\n            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n \t\t\t\t//doSomeing   \n            }\n });\n```\n\n\n\n## \n\nExecutors\n### newFixedThreadPool\n\n =  / \n```\n    public static ExecutorService newFixedThreadPool(int nThreads) {\n        return new ThreadPoolExecutor(nThreads, nThreads,\n                                      0L, TimeUnit.MILLISECONDS,\n                                      new LinkedBlockingQueue<Runnable>());\n    }\n```\n****\n\n### newCachedThreadPool\n60\n**SynchronousQueue**\n\n```\n    public static ExecutorService newCachedThreadPool() {\n        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                      60L, TimeUnit.SECONDS,\n                                      new SynchronousQueue<Runnable>());\n    }\n```\n****\n60\n****,\n### newSingleThreadExecutor\n1 newFixedThreadPool(1) \n```\n    public static ExecutorService newSingleThreadExecutor() {\n        return new FinalizableDelegatedExecutorService\n            (new ThreadPoolExecutor(1, 1,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue<Runnable>()));\n    }\n\n```\n****\n\n### newScheduledThreadPool\n\n```\n    public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {\n        return new ScheduledThreadPoolExecutor(corePoolSize);\n    }\n   public ScheduledThreadPoolExecutor(int corePoolSize) {\n        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\n              new DelayedWorkQueue());\n    }\n\n\n```\n\n## ThreadPoolExecutor\n\n### executresubmit\n\nexecutesubmittaskFutureTaskFutureTask[Fork/join](http://xuzyblog.top/2020/07/30/fork-join/)\n\n```java\n@Test\npublic void testError() throws InterruptedException, ExecutionException {\n    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(10, 20, 60L, TimeUnit.MINUTES, new LinkedBlockingQueue<>());\n    threadPoolExecutor.execute(() -> {\n        System.out.println(\"-execute\");\n    });\n    Future future = threadPoolExecutor.submit(() -> {\n        System.out.println(\"-submit\");\n    });\n    future.get();\n}\n```\n\n```java\njava.util.concurrent.AbstractExecutorService\n\nprotected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {\n    return new FutureTask<T>(callable);\n}\n\nprotected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {\n        return new FutureTask<T>(runnable, value);\n}\n\n//Runable Future\npublic Future<?> submit(Runnable task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture<Void> ftask = newTaskFor(task, null);\n    //execute\n    execute(ftask);\n    return ftask;\n}\n\n//Callable Future\npublic <T> Future<T> submit(Callable<T> task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture<T> ftask = newTaskFor(task);\n    execute(ftask);\n    return ftask;\n}\n```\n\nexecute(Runnable task)  submit(Runnable task) task  <font color=red>execturetaskWorkerWorkerThredtaskWorker</font>\n\n![](executorservice/3.png)\n\n### \n\n 32 \n\n-  3 \n-  29  29  5 \n\n```java\n//ThreadPoolExecutor\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\n//\n//1291 00000000 00000000 00000000 00000001 --> 001 0000 00000000 00000000 00000000 - 1 = 536870911\nprivate static final int CAPACITY   = (1 << COUNT_BITS) - 1;\n\n//===\n//RUNNING - \n//SHUTDOWN - \n//STOP - \n//TIDYING - workCount0TIDYINGterminated()\n//TERMINATED - terminated()\nprivate static final int RUNNING    = -1 << COUNT_BITS;\nprivate static final int SHUTDOWN   =  0 << COUNT_BITS;\nprivate static final int STOP       =  1 << COUNT_BITS;\nprivate static final int TIDYING    =  2 << COUNT_BITS;\nprivate static final int TERMINATED =  3 << COUNT_BITS;\n//task\nprivate final BlockingQueue<Runnable> workQueue;\n//worker\nprivate final HashSet<Worker> workers = new HashSet<Worker>();\n//WorkerThread t\nprivate volatile ThreadFactory threadFactory;\n//\nprivate volatile RejectedExecutionHandler handler;\n//\nprivate volatile long keepAliveTime;\n//\nprivate volatile int corePoolSize;\n//\nprivate volatile int maximumPoolSize;\n```\n\n![](executorservice/4.png)\n\n### Worker\n\nWorkerAQSRunableAQSWorker\n\n**WorkerReentrantLockAQS ?**  tryAcquireReentrantLock\n\nWorker<font color=red></font>Runnable command\n\n```java\nprivate final class Worker extends AbstractQueuedSynchronizer implements Runnable{\n    \n    private static final long serialVersionUID = 6138294804551838833L;\n    //\n    final Thread thread;\n    //new Workerfirstnew Worker\n    //null,\n    Runnable firstTask;\n    // volatile\n    volatile long completedTasks;\n\n    \n    Worker(Runnable firstTask) {\n        setState(-1);\n        this.firstTask = firstTask;\n        this.thread = getThreadFactory().newThread(this);\n    }\n\n    public void run() {\n        runWorker(this);\n    }\n\n    protected boolean isHeldExclusively() {\n        return getState() != 0;\n    }\n\n    protected boolean tryAcquire(int unused) {\n        if (compareAndSetState(0, 1)) {\n            setExclusiveOwnerThread(Thread.currentThread());\n            return true;\n        }\n        return false;\n    }\n\n    protected boolean tryRelease(int unused) {\n        setExclusiveOwnerThread(null);\n        setState(0);\n        return true;\n    }\n\n    public void lock()        { acquire(1); }\n    public boolean tryLock()  { return tryAcquire(1); }\n    public void unlock()      { release(1); }\n    public boolean isLocked() { return isHeldExclusively(); }\n\n    void interruptIfStarted() {\n        Thread t;\n        if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n            try {\n                t.interrupt();\n            } catch (SecurityException ignore) {\n            }\n        }\n    }\n}\n```\n\n\n\n### \n\n![](executorservice/1.jpg)\n\n#### execute\n\n\n```java\npublic void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    int c = ctl.get();\n    //Worker\n    if (workerCountOf(c) < corePoolSize) {\n        //newworker command (firstTask)\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n    \n    // addWorker \n    \n    //RUNNING\n    //offer - true, false\n    if (isRunning(c) && workQueue.offer(command)) {\n        int recheck = ctl.get();\n        //\n        if (! isRunning(recheck) && remove(command)){\n         \treject(command);   \n        }\n        // RUNNING  0\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n    // maximumPoolSize  worker\n    else if (!addWorker(command, false)){\n        reject(command); //   \n    }\n}\n```\n\n#### addWorker\n\n```java\n//core = true  corePoolSize \n//core = flase  maximumPoolSize \nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\n        // addWorker\n        if (rs >= SHUTDOWN &&\n            ! (rs == SHUTDOWN &&\n               firstTask == null &&\n               ! workQueue.isEmpty()))\n            return false;\n\n        for (;;) {\n            //worker\n            int wc = workerCountOf(c);\n            //false\n            if (wc >= CAPACITY ||\n                wc >= (core ? corePoolSize : maximumPoolSize))\n                return false;\n            //+1new Worker,\n            if (compareAndIncrementWorkerCount(c))\n                break retry;\n            c = ctl.get(); \n            if (runStateOf(c) != rs)\n                continue retry;\n        }\n    }\n\n    //worker \n    boolean workerStarted = false;\n    // worker  workers  HashSet \n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        //\"\"\n        w = new Worker(firstTask);\n        final Thread t = w.thread;\n        if (t != null) {\n            //mainLockworkers.add(w)\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n\n                int rs = runStateOf(ctl.get());\n\t\t\t   //SHUTTDOWN  RUNNING\n                //SHUTDOWN\n                if (rs < SHUTDOWN || (rs == SHUTDOWN && firstTask == null)) {\n                    if (t.isAlive()) throw new IllegalThreadStateException();\n                    //\"\"workers\n                    workers.add(w);\n                    int s = workers.size();\n                    if (s > largestPoolSize)\n                        largestPoolSize = s;\n                    workerAdded = true;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            if (workerAdded) {\n                //\"\"Worker->run->runWorker(this)\n                t.start();\n                workerStarted = true;\n            }\n        }\n    } finally {\n        // workCount  1\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    return workerStarted;\n}\n\n//\"\"\"\"\nprivate void addWorkerFailed(Worker w) {\n    final ReentrantLock mainLock = this.mainLock;\n    mainLock.lock();\n    try {\n        if (w != null)\n            workers.remove(w);\n        decrementWorkerCount();\n        tryTerminate();\n    } finally {\n        mainLock.unlock();\n    }\n}\n\n```\n\n#### runWorker\n\n```java\n//worker while \nfinal void runWorker(Worker w) {\n    Thread wt = Thread.currentThread();\n    //\n    Runnable task = w.firstTask;\n    w.firstTask = null;\n    w.unlock(); // allow interrupts\n    boolean completedAbruptly = true;\n    try {\n        while (task != null || (task = getTask()) != null) {\n            w.lock();\n            //\n            //(>=STOP  (>=STOP))  \n            //2 : 1. 2.\n            if (\n                ( runStateAtLeast(ctl.get(), STOP) ||\n                  (Thread.interrupted() && runStateAtLeast(ctl.get(), STOP))\n                ) &&\n                !wt.isInterrupted()\n               )\n                wt.interrupt();\n            try {\n                //\n                beforeExecute(wt, task);\n                Throwable thrown = null;\n                try {\n                    //taskRunnableFutureTask\n                    task.run();\n                } catch (RuntimeException x) {\n                    thrown = x; throw x;\n                } catch (Error x) {\n                    thrown = x; throw x;\n                } catch (Throwable x) {\n                    thrown = x; throw new Error(x);\n                } finally {\n                    //\n                    afterExecute(task, thrown);\n                }\n            } finally {\n                // task getTask \n                task = null;\n                //+1\n                w.completedTasks++;\n                //\n                w.unlock();\n            }\n        }\n        completedAbruptly = false;\n    } finally {\n        //\n        //getTask()\n        //worker\n        processWorkerExit(w, completedAbruptly);\n    }\n}\n```\n\nrunWorker\n\n1. whilegetTask()workerQueue\n2. 3.\n3. task.run()\n4. tasknullprocessWorkerExit()`workers.remove(w)`\n\n**keepAliveTime**\n\n+new WorkerWorker\n\n```java\nfinal void runWorker(Worker w) {\n   Thread wt = Thread.currentThread();\n   Runnable task = w.firstTask;\n   w.firstTask = null;\n   w.unlock(); // allow interrupts\n   boolean completedAbruptly = true;\n   try {\n       while (task != null || (task = getTask()) != null) {\n           //\n       }\n       completedAbruptly = false;\n   } finally {\n       //getTask()Worker\n       processWorkerExit(w, completedAbruptly);\n   }\n\n\nprivate Runnable getTask() {\n    boolean timedOut = false; \n    for (;;) {\n        \n        //...\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n        //...\n\n        try {\n        \t//\n        \t//InterruptedException\n        \t//runWorkerprocessWorkerExitWorker\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}\n```\n\n\n\n#### getTask()\n\ngetTaskWorker\n\nnull\n\n-  SHUTDOWN workQueue \n-  STOP workQueue \n- WorkerWorkerkeepAliveTimenull\n\n```java\nprivate Runnable getTask() {\n    boolean timedOut = false;\n\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\t    //1. rs == SHUTDOWN && workQueue.isEmpty()\n        //2. rs >= STOP\n        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n             // CAS \n            decrementWorkerCount();\n            return null;\n        }\n\t    //worker\n        int wc = workerCountOf(c);\n\t    //\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n        if ((wc > maximumPoolSize || (timed && timedOut)) && (wc > 1 || workQueue.isEmpty())) {\n            if (compareAndDecrementWorkerCount(c))\n                return null;\n            continue;\n        }\n        try {\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}\n```\n\n## \n\n### shutdown\n\n\n\n1. shutDown`SHUTDOWN`\n2. \n3. Worker\n4. shutdown()\n\n### shutdownNow\n\n\n\n## \n\n**executesubmit**\n\n```java\nexecutors.execute(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(\"xxx\");\n    }\n});\n//\nException in thread \"pool-1-thread-1\" java.lang.RuntimeException: xxx\n\tat xzy.OtherTest$1.run(OtherTest.java:33)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n\nexecutors.submit(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(\"xxx\");\n    }\n});\n//\n```\n\n**runWorker****task.run()**\n\n- executetask=Runnablerun\n- submitRunnableFutureTasktask=FutureTaskFutureTaskrunget()\n\n```java\ntry {\n       task.run();\n   } catch (RuntimeException x) {\n       thrown = x; throw x;\n   } catch (Error x) {\n       thrown = x; throw x;\n   } catch (Throwable x) {\n       //  Throwable Error\n       thrown = x; throw new Error(x);\n   } finally {\n       //  task \n       afterExecute(task, thrown);\n}\n```\n\n\n\n## \n\n- https://zhuanlan.zhihu.com/p/60524908","slug":"executorservice","published":1,"updated":"2021-07-19T01:48:12.692Z","_id":"ckn9yvhu70002qwv28poxegic","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"?\"></a>?</h2><p></p>\n<ul>\n<li>T1 </li>\n<li>T2 </li>\n<li>T3 </li>\n</ul>\n<p>T1 + T3  T2<br>,<strong></strong>:</p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li>LinuxAPI</li>\n<li>Java512K1MJVM</li>\n<li><strong>loadCPU sy20%)</strong></li>\n<li>CPU<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/1.png\" alt><br>Executor<font color=\"#FF0000\">execute</font><br>Executors</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token function\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> corePoolSize<span class=\"token punctuation\">,</span>\n                          <span class=\"token keyword\">int</span> maximumPoolSize<span class=\"token punctuation\">,</span>\n                          <span class=\"token keyword\">long</span> keepAliveTime<span class=\"token punctuation\">,</span>\n                          TimeUnit unit<span class=\"token punctuation\">,</span>\n                          BlockingQueue<span class=\"token operator\">&lt;</span>Runnable<span class=\"token operator\">></span> workQueue<span class=\"token punctuation\">,</span>\n                          ThreadFactory threadFactory<span class=\"token punctuation\">,</span>\n                          RejectedExecutionHandler handler<span class=\"token punctuation\">)</span></code></pre>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>corePoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>maximumPoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>keepAliveTime</td>\n<td></td>\n</tr>\n<tr>\n<td>workQueue</td>\n<td></td>\n</tr>\n<tr>\n<td>threadFactory</td>\n<td></td>\n</tr>\n<tr>\n<td>handler</td>\n<td> AbortPolicy</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/2.png\" alt><br><br>corePoolSize = 2<br>keepAliveTime = 10ms<br>maximumPoolSize = 3<br>workQueue = ArrayBlockingQueue(3)</p>\n<p>:</p>\n<ol>\n<li>A,, &lt;  ,</li>\n<li>B,1. &lt;  ,</li>\n<li>C, &gt; ,workQueue</li>\n<li>DEF..,3,DE</li>\n<li>F,  &lt; ,F</li>\n<li>GABworkQueueCDE, =,G</li>\n<li>A,CworkQueue,</li>\n</ol>\n<p><strong>keepAliveTime</strong> : F FkeepAliveTime &gt;  &amp; workQueue </p>\n<p>:</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td> &lt; corePoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>  corePoolSize workQueue </td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>corePoolSize    maximumPoolSize workQueue </td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>  maximumPoolSize workQueue </td>\n<td></td>\n</tr>\n</tbody></table>\n<p> :</p>\n<ul>\n<li>()</li>\n<li>allowCoreThreadTimeOuttrue</li>\n<li>workQueuekeepAliveTime</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  corePoolSize3</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SynchronousQueue</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>ArrayBlockingQueue</td>\n<td></td>\n<td> FIFO </td>\n</tr>\n<tr>\n<td>LinkedBlockingQueue</td>\n<td></td>\n<td> FIFO </td>\n</tr>\n<tr>\n<td>PriorityBlockingQueue</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> maximumPoolSize workQueue Java 4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>AbortPolicy</td>\n<td> RejectedExecutionException</td>\n</tr>\n<tr>\n<td>DiscardPolicy</td>\n<td></td>\n</tr>\n<tr>\n<td>DiscardOldestPolicy</td>\n<td></td>\n</tr>\n<tr>\n<td>CallerRunsPolicy</td>\n<td></td>\n</tr>\n</tbody></table>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//</span>\nThreadPoolExecutor executor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> 1L <span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>MINUTES<span class=\"token punctuation\">,</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayBlockingQueue</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor<span class=\"token punctuation\">.</span>AbortPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\nThreadPoolExecutor executor2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> 1L <span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>MINUTES <span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayBlockingQueue</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">RejectedExecutionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">rejectedExecution</span><span class=\"token punctuation\">(</span>Runnable r<span class=\"token punctuation\">,</span> ThreadPoolExecutor executor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                 <span class=\"token comment\" spellcheck=\"true\">//doSomeing   </span>\n            <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Executors</p>\n<h3 id=\"newFixedThreadPool\"><a href=\"#newFixedThreadPool\" class=\"headerlink\" title=\"newFixedThreadPool\"></a>newFixedThreadPool</h3><p><br> =  / </p>\n<pre><code>    public static ExecutorService newFixedThreadPool(int nThreads) {\n        return new ThreadPoolExecutor(nThreads, nThreads,\n                                      0L, TimeUnit.MILLISECONDS,\n                                      new LinkedBlockingQueue&lt;Runnable&gt;());\n    }</code></pre><p><strong></strong><br></p>\n<h3 id=\"newCachedThreadPool\"><a href=\"#newCachedThreadPool\" class=\"headerlink\" title=\"newCachedThreadPool\"></a>newCachedThreadPool</h3><p>60<br><strong>SynchronousQueue</strong></p>\n<pre><code>    public static ExecutorService newCachedThreadPool() {\n        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                      60L, TimeUnit.SECONDS,\n                                      new SynchronousQueue&lt;Runnable&gt;());\n    }</code></pre><p><strong></strong><br>60<br><strong></strong>,</p>\n<h3 id=\"newSingleThreadExecutor\"><a href=\"#newSingleThreadExecutor\" class=\"headerlink\" title=\"newSingleThreadExecutor\"></a>newSingleThreadExecutor</h3><p>1 newFixedThreadPool(1) </p>\n<pre><code>    public static ExecutorService newSingleThreadExecutor() {\n        return new FinalizableDelegatedExecutorService\n            (new ThreadPoolExecutor(1, 1,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue&lt;Runnable&gt;()));\n    }\n</code></pre><p><strong></strong><br></p>\n<h3 id=\"newScheduledThreadPool\"><a href=\"#newScheduledThreadPool\" class=\"headerlink\" title=\"newScheduledThreadPool\"></a>newScheduledThreadPool</h3><p></p>\n<pre><code>    public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {\n        return new ScheduledThreadPoolExecutor(corePoolSize);\n    }\n   public ScheduledThreadPoolExecutor(int corePoolSize) {\n        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\n              new DelayedWorkQueue());\n    }\n\n</code></pre><h2 id=\"ThreadPoolExecutor\"><a href=\"#ThreadPoolExecutor\" class=\"headerlink\" title=\"ThreadPoolExecutor\"></a>ThreadPoolExecutor</h2><h3 id=\"executresubmit\"><a href=\"#executresubmit\" class=\"headerlink\" title=\"executresubmit\"></a>executresubmit</h3><p>executesubmittaskFutureTaskFutureTask<a href=\"http://xuzyblog.top/2020/07/30/fork-join/\" target=\"_blank\" rel=\"noopener\">Fork/join</a></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException<span class=\"token punctuation\">,</span> ExecutionException <span class=\"token punctuation\">{</span>\n    ThreadPoolExecutor threadPoolExecutor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> 60L<span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>MINUTES<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    threadPoolExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-execute\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Future future <span class=\"token operator\">=</span> threadPoolExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-submit\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    future<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>AbstractExecutorService\n\n<span class=\"token keyword\">protected</span> <span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> RunnableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">newTaskFor</span><span class=\"token punctuation\">(</span>Callable<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> callable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FutureTask</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>callable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">protected</span> <span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> RunnableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">newTaskFor</span><span class=\"token punctuation\">(</span>Runnable runnable<span class=\"token punctuation\">,</span> T value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FutureTask</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>runnable<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//Runable Future</span>\n<span class=\"token keyword\">public</span> Future<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>Runnable task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    RunnableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> ftask <span class=\"token operator\">=</span> <span class=\"token function\">newTaskFor</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//execute</span>\n    <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>ftask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> ftask<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//Callable Future</span>\n<span class=\"token keyword\">public</span> <span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> Future<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>Callable<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    RunnableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> ftask <span class=\"token operator\">=</span> <span class=\"token function\">newTaskFor</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>ftask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> ftask<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>execute(Runnable task)  submit(Runnable task) task  <font color=\"red\">execturetaskWorkerWorkerThredtaskWorker</font></p>\n<p><img src=\"/2018/01/18/executorservice/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> 32 </p>\n<ul>\n<li> 3 </li>\n<li> 29  29  5 </li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//ThreadPoolExecutor</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> AtomicInteger ctl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token function\">ctlOf</span><span class=\"token punctuation\">(</span>RUNNING<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> COUNT_BITS <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>SIZE <span class=\"token operator\">-</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//1291 00000000 00000000 00000000 00000001 --> 001 0000 00000000 00000000 00000000 - 1 = 536870911</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CAPACITY   <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//===</span>\n<span class=\"token comment\" spellcheck=\"true\">//RUNNING - </span>\n<span class=\"token comment\" spellcheck=\"true\">//SHUTDOWN - </span>\n<span class=\"token comment\" spellcheck=\"true\">//STOP - </span>\n<span class=\"token comment\" spellcheck=\"true\">//TIDYING - workCount0TIDYINGterminated()</span>\n<span class=\"token comment\" spellcheck=\"true\">//TERMINATED - terminated()</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> RUNNING    <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> SHUTDOWN   <span class=\"token operator\">=</span>  <span class=\"token number\">0</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> STOP       <span class=\"token operator\">=</span>  <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> TIDYING    <span class=\"token operator\">=</span>  <span class=\"token number\">2</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> TERMINATED <span class=\"token operator\">=</span>  <span class=\"token number\">3</span> <span class=\"token operator\">&lt;&lt;</span> COUNT_BITS<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//task</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> BlockingQueue<span class=\"token operator\">&lt;</span>Runnable<span class=\"token operator\">></span> workQueue<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//worker</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> HashSet<span class=\"token operator\">&lt;</span>Worker<span class=\"token operator\">></span> workers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token operator\">&lt;</span>Worker<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//WorkerThread t</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> ThreadFactory threadFactory<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> RejectedExecutionHandler handler<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">long</span> keepAliveTime<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> corePoolSize<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> maximumPoolSize<span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2018/01/18/executorservice/4.png\" alt=\"\"></p>\n<h3 id=\"Worker\"><a href=\"#Worker\" class=\"headerlink\" title=\"Worker\"></a>Worker</h3><p>WorkerAQSRunableAQSWorker</p>\n<p><strong>WorkerReentrantLockAQS ?</strong>  tryAcquireReentrantLock</p>\n<p>Worker<font color=\"red\"></font>Runnable command</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Worker</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractQueuedSynchronizer</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> 6138294804551838833L<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">final</span> Thread thread<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//new Workerfirstnew Worker</span>\n    <span class=\"token comment\" spellcheck=\"true\">//null,</span>\n    Runnable firstTask<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// volatile</span>\n    <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">long</span> completedTasks<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token function\">Worker</span><span class=\"token punctuation\">(</span>Runnable firstTask<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>firstTask <span class=\"token operator\">=</span> firstTask<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> <span class=\"token function\">getThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isHeldExclusively</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> unused<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryRelease</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> unused<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>        <span class=\"token punctuation\">{</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>      <span class=\"token punctuation\">{</span> <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isLocked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">isHeldExclusively</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">interruptIfStarted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Thread t<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> thread<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                t<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SecurityException</span> ignore<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/1.jpg\" alt=\"\"></p>\n<h4 id=\"execute\"><a href=\"#execute\" class=\"headerlink\" title=\"execute\"></a>execute</h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>Runnable command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>command <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Worker</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> corePoolSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//newworker command (firstTask)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">// addWorker </span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//RUNNING</span>\n    <span class=\"token comment\" spellcheck=\"true\">//offer - true, false</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> recheck <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> <span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span>recheck<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n             <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   \n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">// RUNNING  0</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>recheck<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">// maximumPoolSize  worker</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//   </span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"addWorker\"><a href=\"#addWorker\" class=\"headerlink\" title=\"addWorker\"></a>addWorker</h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//core = true  corePoolSize </span>\n<span class=\"token comment\" spellcheck=\"true\">//core = flase  maximumPoolSize </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>Runnable firstTask<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> core<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    retry<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> rs <span class=\"token operator\">=</span> <span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">// addWorker</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">>=</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token operator\">!</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">==</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span>\n               firstTask <span class=\"token operator\">==</span> null <span class=\"token operator\">&amp;&amp;</span>\n               <span class=\"token operator\">!</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//worker</span>\n            <span class=\"token keyword\">int</span> wc <span class=\"token operator\">=</span> <span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//false</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wc <span class=\"token operator\">>=</span> CAPACITY <span class=\"token operator\">||</span>\n                wc <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>core <span class=\"token operator\">?</span> corePoolSize <span class=\"token operator\">:</span> maximumPoolSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//+1new Worker,</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndIncrementWorkerCount</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">break</span> retry<span class=\"token punctuation\">;</span>\n            c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> rs<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">continue</span> retry<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//worker </span>\n    <span class=\"token keyword\">boolean</span> workerStarted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// worker  workers  HashSet </span>\n    <span class=\"token keyword\">boolean</span> workerAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    Worker w <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//\"\"</span>\n        w <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span>firstTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> Thread t <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>thread<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//mainLockworkers.add(w)</span>\n            <span class=\"token keyword\">final</span> ReentrantLock mainLock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mainLock<span class=\"token punctuation\">;</span>\n            mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n                <span class=\"token keyword\">int</span> rs <span class=\"token operator\">=</span> <span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n               <span class=\"token comment\" spellcheck=\"true\">//SHUTTDOWN  RUNNING</span>\n                <span class=\"token comment\" spellcheck=\"true\">//SHUTDOWN</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">&lt;</span> SHUTDOWN <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">==</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span> firstTask <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">isAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalThreadStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//\"\"workers</span>\n                    workers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> workers<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">></span> largestPoolSize<span class=\"token punctuation\">)</span>\n                        largestPoolSize <span class=\"token operator\">=</span> s<span class=\"token punctuation\">;</span>\n                    workerAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workerAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//\"\"Worker->run->runWorker(this)</span>\n                t<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                workerStarted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">// workCount  1</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> workerStarted<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">addWorkerFailed</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> workerStarted<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//\"\"\"\"</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addWorkerFailed</span><span class=\"token punctuation\">(</span>Worker w<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> ReentrantLock mainLock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mainLock<span class=\"token punctuation\">;</span>\n    mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n            workers<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">decrementWorkerCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">tryTerminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4 id=\"runWorker\"><a href=\"#runWorker\" class=\"headerlink\" title=\"runWorker\"></a>runWorker</h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//worker while </span>\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span>Worker w<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Thread wt <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    Runnable task <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>firstTask<span class=\"token punctuation\">;</span>\n    w<span class=\"token punctuation\">.</span>firstTask <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    w<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// allow interrupts</span>\n    <span class=\"token keyword\">boolean</span> completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">!=</span> null <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">=</span> <span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            w<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//(>=STOP  (>=STOP))  </span>\n            <span class=\"token comment\" spellcheck=\"true\">//2 : 1. 2.</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span> <span class=\"token function\">runStateAtLeast</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> STOP<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n                  <span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">runStateAtLeast</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> STOP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n                <span class=\"token operator\">!</span>wt<span class=\"token punctuation\">.</span><span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">)</span>\n                wt<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token function\">beforeExecute</span><span class=\"token punctuation\">(</span>wt<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                Throwable thrown <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//taskRunnableFutureTask</span>\n                    task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token function\">afterExecute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">// task getTask </span>\n                task <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//+1</span>\n                w<span class=\"token punctuation\">.</span>completedTasks<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                w<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token comment\" spellcheck=\"true\">//getTask()</span>\n        <span class=\"token comment\" spellcheck=\"true\">//worker</span>\n        <span class=\"token function\">processWorkerExit</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> completedAbruptly<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>runWorker</p>\n<ol>\n<li>whilegetTask()workerQueue</li>\n<li>3.</li>\n<li>task.run()</li>\n<li>tasknullprocessWorkerExit()<code>workers.remove(w)</code></li>\n</ol>\n<p><strong>keepAliveTime</strong></p>\n<p>+new WorkerWorker</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span>Worker w<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   Thread wt <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   Runnable task <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>firstTask<span class=\"token punctuation\">;</span>\n   w<span class=\"token punctuation\">.</span>firstTask <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n   w<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// allow interrupts</span>\n   <span class=\"token keyword\">boolean</span> completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">!=</span> null <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">=</span> <span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token comment\" spellcheck=\"true\">//</span>\n       <span class=\"token punctuation\">}</span>\n       completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token comment\" spellcheck=\"true\">//getTask()Worker</span>\n       <span class=\"token function\">processWorkerExit</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> completedAbruptly<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">private</span> Runnable <span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">boolean</span> timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">//...</span>\n        <span class=\"token keyword\">boolean</span> timed <span class=\"token operator\">=</span> allowCoreThreadTimeOut <span class=\"token operator\">||</span> wc <span class=\"token operator\">></span> corePoolSize<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">//...</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//InterruptedException</span>\n            <span class=\"token comment\" spellcheck=\"true\">//runWorkerprocessWorkerExitWorker</span>\n            Runnable r <span class=\"token operator\">=</span> timed <span class=\"token operator\">?</span>\n                workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span>keepAliveTime<span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>NANOSECONDS<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n                workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> r<span class=\"token punctuation\">;</span>\n            timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> retry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"getTask-\"><a href=\"#getTask-\" class=\"headerlink\" title=\"getTask()\"></a>getTask()</h4><p>getTaskWorker</p>\n<p>null</p>\n<ul>\n<li> SHUTDOWN workQueue </li>\n<li> STOP workQueue </li>\n<li>WorkerWorkerkeepAliveTimenull</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> Runnable <span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">boolean</span> timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> rs <span class=\"token operator\">=</span> <span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//1. rs == SHUTDOWN &amp;&amp; workQueue.isEmpty()</span>\n        <span class=\"token comment\" spellcheck=\"true\">//2. rs >= STOP</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">>=</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">>=</span> STOP <span class=\"token operator\">||</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n             <span class=\"token comment\" spellcheck=\"true\">// CAS </span>\n            <span class=\"token function\">decrementWorkerCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//worker</span>\n        <span class=\"token keyword\">int</span> wc <span class=\"token operator\">=</span> <span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">boolean</span> timed <span class=\"token operator\">=</span> allowCoreThreadTimeOut <span class=\"token operator\">||</span> wc <span class=\"token operator\">></span> corePoolSize<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>wc <span class=\"token operator\">></span> maximumPoolSize <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>timed <span class=\"token operator\">&amp;&amp;</span> timedOut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>wc <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">||</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndDecrementWorkerCount</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            Runnable r <span class=\"token operator\">=</span> timed <span class=\"token operator\">?</span>\n                workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span>keepAliveTime<span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>NANOSECONDS<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n                workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> r<span class=\"token punctuation\">;</span>\n            timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> retry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            timedOut <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"shutdown\"><a href=\"#shutdown\" class=\"headerlink\" title=\"shutdown\"></a>shutdown</h3><p></p>\n<ol>\n<li>shutDown<code>SHUTDOWN</code></li>\n<li></li>\n<li>Worker</li>\n<li>shutdown()</li>\n</ol>\n<h3 id=\"shutdownNow\"><a href=\"#shutdownNow\" class=\"headerlink\" title=\"shutdownNow\"></a>shutdownNow</h3><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>executesubmit</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\">executors<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\nException in thread <span class=\"token string\">\"pool-1-thread-1\"</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>RuntimeException<span class=\"token operator\">:</span> xxx\n    at xzy<span class=\"token punctuation\">.</span>OtherTest$<span class=\"token number\">1</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>OtherTest<span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">33</span><span class=\"token punctuation\">)</span>\n    at java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>ThreadPoolExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span>ThreadPoolExecutor<span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">1149</span><span class=\"token punctuation\">)</span>\n    at java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>ThreadPoolExecutor$Worker<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>ThreadPoolExecutor<span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">624</span><span class=\"token punctuation\">)</span>\n    at java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">748</span><span class=\"token punctuation\">)</span>\n\nexecutors<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span></code></pre>\n<p><strong>runWorker</strong><strong>task.run()</strong></p>\n<ul>\n<li>executetask=Runnablerun</li>\n<li>submitRunnableFutureTasktask=FutureTaskFutureTaskrunget()</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n       task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token comment\" spellcheck=\"true\">//  Throwable Error</span>\n       thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token comment\" spellcheck=\"true\">//  task </span>\n       <span class=\"token function\">afterExecute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/60524908\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/60524908</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"?\"></a>?</h2><p></p>\n<ul>\n<li>T1 </li>\n<li>T2 </li>\n<li>T3 </li>\n</ul>\n<p>T1 + T3  T2<br>,<strong></strong>:</p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li>LinuxAPI</li>\n<li>Java512K1MJVM</li>\n<li><strong>loadCPU sy20%)</strong></li>\n<li>CPU</li></ul>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/1.png\" alt><br>Executor<font color=\"#FF0000\">execute</font><br>Executors</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">public ThreadPoolExecutor(int corePoolSize,\n                          int maximumPoolSize,\n                          long keepAliveTime,\n                          TimeUnit unit,\n                          BlockingQueue&lt;Runnable&gt; workQueue,\n                          ThreadFactory threadFactory,\n                          RejectedExecutionHandler handler)</code></pre>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>corePoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>maximumPoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>keepAliveTime</td>\n<td></td>\n</tr>\n<tr>\n<td>workQueue</td>\n<td></td>\n</tr>\n<tr>\n<td>threadFactory</td>\n<td></td>\n</tr>\n<tr>\n<td>handler</td>\n<td> AbortPolicy</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/2.png\" alt><br><br>corePoolSize = 2<br>keepAliveTime = 10ms<br>maximumPoolSize = 3<br>workQueue = ArrayBlockingQueue(3)</p>\n<p>:</p>\n<ol>\n<li>A,, &lt;  ,</li>\n<li>B,1. &lt;  ,</li>\n<li>C, &gt; ,workQueue</li>\n<li>DEF..,3,DE</li>\n<li>F,  &lt; ,F</li>\n<li>GABworkQueueCDE, =,G</li>\n<li>A,CworkQueue,</li>\n</ol>\n<p><strong>keepAliveTime</strong> : F FkeepAliveTime &gt;  &amp; workQueue </p>\n<p>:</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td> &lt; corePoolSize</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>  corePoolSize workQueue </td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>corePoolSize    maximumPoolSize workQueue </td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>  maximumPoolSize workQueue </td>\n<td></td>\n</tr>\n</tbody></table>\n<p> :</p>\n<ul>\n<li>()</li>\n<li>allowCoreThreadTimeOuttrue</li>\n<li>workQueuekeepAliveTime</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>  corePoolSize3</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SynchronousQueue</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>ArrayBlockingQueue</td>\n<td></td>\n<td> FIFO </td>\n</tr>\n<tr>\n<td>LinkedBlockingQueue</td>\n<td></td>\n<td> FIFO </td>\n</tr>\n<tr>\n<td>PriorityBlockingQueue</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> maximumPoolSize workQueue Java 4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>AbortPolicy</td>\n<td> RejectedExecutionException</td>\n</tr>\n<tr>\n<td>DiscardPolicy</td>\n<td></td>\n</tr>\n<tr>\n<td>DiscardOldestPolicy</td>\n<td></td>\n</tr>\n<tr>\n<td>CallerRunsPolicy</td>\n<td></td>\n</tr>\n</tbody></table>\n<pre><code class=\"java\">//\nThreadPoolExecutor executor = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES,new ArrayBlockingQueue&lt;&gt;(1),\nnew ThreadPoolExecutor.AbortPolicy());\n//\nThreadPoolExecutor executor2 = new ThreadPoolExecutor(1 , 1 , 1L , TimeUnit.MINUTES , new ArrayBlockingQueue&lt;&gt;(1),\n        new RejectedExecutionHandler(){\n            @Override\n            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n                 //doSomeing   \n            }\n });</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Executors</p>\n<h3 id=\"newFixedThreadPool\"><a href=\"#newFixedThreadPool\" class=\"headerlink\" title=\"newFixedThreadPool\"></a>newFixedThreadPool</h3><p><br> =  / </p>\n<pre><code>    public static ExecutorService newFixedThreadPool(int nThreads) {\n        return new ThreadPoolExecutor(nThreads, nThreads,\n                                      0L, TimeUnit.MILLISECONDS,\n                                      new LinkedBlockingQueue&lt;Runnable&gt;());\n    }</code></pre><p><strong></strong><br></p>\n<h3 id=\"newCachedThreadPool\"><a href=\"#newCachedThreadPool\" class=\"headerlink\" title=\"newCachedThreadPool\"></a>newCachedThreadPool</h3><p>60<br><strong>SynchronousQueue</strong></p>\n<pre><code>    public static ExecutorService newCachedThreadPool() {\n        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                      60L, TimeUnit.SECONDS,\n                                      new SynchronousQueue&lt;Runnable&gt;());\n    }</code></pre><p><strong></strong><br>60<br><strong></strong>,</p>\n<h3 id=\"newSingleThreadExecutor\"><a href=\"#newSingleThreadExecutor\" class=\"headerlink\" title=\"newSingleThreadExecutor\"></a>newSingleThreadExecutor</h3><p>1 newFixedThreadPool(1) </p>\n<pre><code>    public static ExecutorService newSingleThreadExecutor() {\n        return new FinalizableDelegatedExecutorService\n            (new ThreadPoolExecutor(1, 1,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue&lt;Runnable&gt;()));\n    }\n</code></pre><p><strong></strong><br></p>\n<h3 id=\"newScheduledThreadPool\"><a href=\"#newScheduledThreadPool\" class=\"headerlink\" title=\"newScheduledThreadPool\"></a>newScheduledThreadPool</h3><p></p>\n<pre><code>    public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {\n        return new ScheduledThreadPoolExecutor(corePoolSize);\n    }\n   public ScheduledThreadPoolExecutor(int corePoolSize) {\n        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\n              new DelayedWorkQueue());\n    }\n\n</code></pre><h2 id=\"ThreadPoolExecutor\"><a href=\"#ThreadPoolExecutor\" class=\"headerlink\" title=\"ThreadPoolExecutor\"></a>ThreadPoolExecutor</h2><h3 id=\"executresubmit\"><a href=\"#executresubmit\" class=\"headerlink\" title=\"executresubmit\"></a>executresubmit</h3><p>executesubmittaskFutureTaskFutureTask<a href=\"http://xuzyblog.top/2020/07/30/fork-join/\" target=\"_blank\" rel=\"noopener\">Fork/join</a></p>\n<pre><code class=\"java\">@Test\npublic void testError() throws InterruptedException, ExecutionException {\n    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(10, 20, 60L, TimeUnit.MINUTES, new LinkedBlockingQueue&lt;&gt;());\n    threadPoolExecutor.execute(() -&gt; {\n        System.out.println(&quot;-execute&quot;);\n    });\n    Future future = threadPoolExecutor.submit(() -&gt; {\n        System.out.println(&quot;-submit&quot;);\n    });\n    future.get();\n}</code></pre>\n<pre><code class=\"java\">java.util.concurrent.AbstractExecutorService\n\nprotected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) {\n    return new FutureTask&lt;T&gt;(callable);\n}\n\nprotected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Runnable runnable, T value) {\n        return new FutureTask&lt;T&gt;(runnable, value);\n}\n\n//Runable Future\npublic Future&lt;?&gt; submit(Runnable task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null);\n    //execute\n    execute(ftask);\n    return ftask;\n}\n\n//Callable Future\npublic &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) {\n    if (task == null) throw new NullPointerException();\n    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);\n    execute(ftask);\n    return ftask;\n}</code></pre>\n<p>execute(Runnable task)  submit(Runnable task) task  <font color=\"red\">execturetaskWorkerWorkerThredtaskWorker</font></p>\n<p><img src=\"/2018/01/18/executorservice/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> 32 </p>\n<ul>\n<li> 3 </li>\n<li> 29  29  5 </li>\n</ul>\n<pre><code class=\"java\">//ThreadPoolExecutor\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\n//\n//1291 00000000 00000000 00000000 00000001 --&gt; 001 0000 00000000 00000000 00000000 - 1 = 536870911\nprivate static final int CAPACITY   = (1 &lt;&lt; COUNT_BITS) - 1;\n\n//===\n//RUNNING - \n//SHUTDOWN - \n//STOP - \n//TIDYING - workCount0TIDYINGterminated()\n//TERMINATED - terminated()\nprivate static final int RUNNING    = -1 &lt;&lt; COUNT_BITS;\nprivate static final int SHUTDOWN   =  0 &lt;&lt; COUNT_BITS;\nprivate static final int STOP       =  1 &lt;&lt; COUNT_BITS;\nprivate static final int TIDYING    =  2 &lt;&lt; COUNT_BITS;\nprivate static final int TERMINATED =  3 &lt;&lt; COUNT_BITS;\n//task\nprivate final BlockingQueue&lt;Runnable&gt; workQueue;\n//worker\nprivate final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;();\n//WorkerThread t\nprivate volatile ThreadFactory threadFactory;\n//\nprivate volatile RejectedExecutionHandler handler;\n//\nprivate volatile long keepAliveTime;\n//\nprivate volatile int corePoolSize;\n//\nprivate volatile int maximumPoolSize;</code></pre>\n<p><img src=\"/2018/01/18/executorservice/4.png\" alt=\"\"></p>\n<h3 id=\"Worker\"><a href=\"#Worker\" class=\"headerlink\" title=\"Worker\"></a>Worker</h3><p>WorkerAQSRunableAQSWorker</p>\n<p><strong>WorkerReentrantLockAQS ?</strong>  tryAcquireReentrantLock</p>\n<p>Worker<font color=\"red\"></font>Runnable command</p>\n<pre><code class=\"java\">private final class Worker extends AbstractQueuedSynchronizer implements Runnable{\n\n    private static final long serialVersionUID = 6138294804551838833L;\n    //\n    final Thread thread;\n    //new Workerfirstnew Worker\n    //null,\n    Runnable firstTask;\n    // volatile\n    volatile long completedTasks;\n\n\n    Worker(Runnable firstTask) {\n        setState(-1);\n        this.firstTask = firstTask;\n        this.thread = getThreadFactory().newThread(this);\n    }\n\n    public void run() {\n        runWorker(this);\n    }\n\n    protected boolean isHeldExclusively() {\n        return getState() != 0;\n    }\n\n    protected boolean tryAcquire(int unused) {\n        if (compareAndSetState(0, 1)) {\n            setExclusiveOwnerThread(Thread.currentThread());\n            return true;\n        }\n        return false;\n    }\n\n    protected boolean tryRelease(int unused) {\n        setExclusiveOwnerThread(null);\n        setState(0);\n        return true;\n    }\n\n    public void lock()        { acquire(1); }\n    public boolean tryLock()  { return tryAcquire(1); }\n    public void unlock()      { release(1); }\n    public boolean isLocked() { return isHeldExclusively(); }\n\n    void interruptIfStarted() {\n        Thread t;\n        if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) {\n            try {\n                t.interrupt();\n            } catch (SecurityException ignore) {\n            }\n        }\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2018/01/18/executorservice/1.jpg\" alt=\"\"></p>\n<h4 id=\"execute\"><a href=\"#execute\" class=\"headerlink\" title=\"execute\"></a>execute</h4><pre><code class=\"java\">public void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    int c = ctl.get();\n    //Worker\n    if (workerCountOf(c) &lt; corePoolSize) {\n        //newworker command (firstTask)\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n\n    // addWorker \n\n    //RUNNING\n    //offer - true, false\n    if (isRunning(c) &amp;&amp; workQueue.offer(command)) {\n        int recheck = ctl.get();\n        //\n        if (! isRunning(recheck) &amp;&amp; remove(command)){\n             reject(command);   \n        }\n        // RUNNING  0\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n    // maximumPoolSize  worker\n    else if (!addWorker(command, false)){\n        reject(command); //   \n    }\n}</code></pre>\n<h4 id=\"addWorker\"><a href=\"#addWorker\" class=\"headerlink\" title=\"addWorker\"></a>addWorker</h4><pre><code class=\"java\">//core = true  corePoolSize \n//core = flase  maximumPoolSize \nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\n        // addWorker\n        if (rs &gt;= SHUTDOWN &amp;&amp;\n            ! (rs == SHUTDOWN &amp;&amp;\n               firstTask == null &amp;&amp;\n               ! workQueue.isEmpty()))\n            return false;\n\n        for (;;) {\n            //worker\n            int wc = workerCountOf(c);\n            //false\n            if (wc &gt;= CAPACITY ||\n                wc &gt;= (core ? corePoolSize : maximumPoolSize))\n                return false;\n            //+1new Worker,\n            if (compareAndIncrementWorkerCount(c))\n                break retry;\n            c = ctl.get(); \n            if (runStateOf(c) != rs)\n                continue retry;\n        }\n    }\n\n    //worker \n    boolean workerStarted = false;\n    // worker  workers  HashSet \n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        //&quot;&quot;\n        w = new Worker(firstTask);\n        final Thread t = w.thread;\n        if (t != null) {\n            //mainLockworkers.add(w)\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n\n                int rs = runStateOf(ctl.get());\n               //SHUTTDOWN  RUNNING\n                //SHUTDOWN\n                if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) {\n                    if (t.isAlive()) throw new IllegalThreadStateException();\n                    //&quot;&quot;workers\n                    workers.add(w);\n                    int s = workers.size();\n                    if (s &gt; largestPoolSize)\n                        largestPoolSize = s;\n                    workerAdded = true;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            if (workerAdded) {\n                //&quot;&quot;Worker-&gt;run-&gt;runWorker(this)\n                t.start();\n                workerStarted = true;\n            }\n        }\n    } finally {\n        // workCount  1\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    return workerStarted;\n}\n\n//&quot;&quot;&quot;&quot;\nprivate void addWorkerFailed(Worker w) {\n    final ReentrantLock mainLock = this.mainLock;\n    mainLock.lock();\n    try {\n        if (w != null)\n            workers.remove(w);\n        decrementWorkerCount();\n        tryTerminate();\n    } finally {\n        mainLock.unlock();\n    }\n}\n</code></pre>\n<h4 id=\"runWorker\"><a href=\"#runWorker\" class=\"headerlink\" title=\"runWorker\"></a>runWorker</h4><pre><code class=\"java\">//worker while \nfinal void runWorker(Worker w) {\n    Thread wt = Thread.currentThread();\n    //\n    Runnable task = w.firstTask;\n    w.firstTask = null;\n    w.unlock(); // allow interrupts\n    boolean completedAbruptly = true;\n    try {\n        while (task != null || (task = getTask()) != null) {\n            w.lock();\n            //\n            //(&gt;=STOP  (&gt;=STOP))  \n            //2 : 1. 2.\n            if (\n                ( runStateAtLeast(ctl.get(), STOP) ||\n                  (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))\n                ) &amp;&amp;\n                !wt.isInterrupted()\n               )\n                wt.interrupt();\n            try {\n                //\n                beforeExecute(wt, task);\n                Throwable thrown = null;\n                try {\n                    //taskRunnableFutureTask\n                    task.run();\n                } catch (RuntimeException x) {\n                    thrown = x; throw x;\n                } catch (Error x) {\n                    thrown = x; throw x;\n                } catch (Throwable x) {\n                    thrown = x; throw new Error(x);\n                } finally {\n                    //\n                    afterExecute(task, thrown);\n                }\n            } finally {\n                // task getTask \n                task = null;\n                //+1\n                w.completedTasks++;\n                //\n                w.unlock();\n            }\n        }\n        completedAbruptly = false;\n    } finally {\n        //\n        //getTask()\n        //worker\n        processWorkerExit(w, completedAbruptly);\n    }\n}</code></pre>\n<p>runWorker</p>\n<ol>\n<li>whilegetTask()workerQueue</li>\n<li>3.</li>\n<li>task.run()</li>\n<li>tasknullprocessWorkerExit()<code>workers.remove(w)</code></li>\n</ol>\n<p><strong>keepAliveTime</strong></p>\n<p>+new WorkerWorker</p>\n<pre><code class=\"java\">final void runWorker(Worker w) {\n   Thread wt = Thread.currentThread();\n   Runnable task = w.firstTask;\n   w.firstTask = null;\n   w.unlock(); // allow interrupts\n   boolean completedAbruptly = true;\n   try {\n       while (task != null || (task = getTask()) != null) {\n           //\n       }\n       completedAbruptly = false;\n   } finally {\n       //getTask()Worker\n       processWorkerExit(w, completedAbruptly);\n   }\n\n\nprivate Runnable getTask() {\n    boolean timedOut = false; \n    for (;;) {\n\n        //...\n        boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;\n\n        //...\n\n        try {\n            //\n            //InterruptedException\n            //runWorkerprocessWorkerExitWorker\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}</code></pre>\n<h4 id=\"getTask-\"><a href=\"#getTask-\" class=\"headerlink\" title=\"getTask()\"></a>getTask()</h4><p>getTaskWorker</p>\n<p>null</p>\n<ul>\n<li> SHUTDOWN workQueue </li>\n<li> STOP workQueue </li>\n<li>WorkerWorkerkeepAliveTimenull</li>\n</ul>\n<pre><code class=\"java\">private Runnable getTask() {\n    boolean timedOut = false;\n\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n        //1. rs == SHUTDOWN &amp;&amp; workQueue.isEmpty()\n        //2. rs &gt;= STOP\n        if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {\n             // CAS \n            decrementWorkerCount();\n            return null;\n        }\n        //worker\n        int wc = workerCountOf(c);\n        //\n        boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;\n\n        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {\n            if (compareAndDecrementWorkerCount(c))\n                return null;\n            continue;\n        }\n        try {\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"shutdown\"><a href=\"#shutdown\" class=\"headerlink\" title=\"shutdown\"></a>shutdown</h3><p></p>\n<ol>\n<li>shutDown<code>SHUTDOWN</code></li>\n<li></li>\n<li>Worker</li>\n<li>shutdown()</li>\n</ol>\n<h3 id=\"shutdownNow\"><a href=\"#shutdownNow\" class=\"headerlink\" title=\"shutdownNow\"></a>shutdownNow</h3><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>executesubmit</strong></p>\n<pre><code class=\"java\">executors.execute(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(&quot;xxx&quot;);\n    }\n});\n//\nException in thread &quot;pool-1-thread-1&quot; java.lang.RuntimeException: xxx\n    at xzy.OtherTest$1.run(OtherTest.java:33)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n    at java.lang.Thread.run(Thread.java:748)\n\nexecutors.submit(new Runnable() {\n    @Override\n    public void run() {\n        throw new RuntimeException(&quot;xxx&quot;);\n    }\n});\n//</code></pre>\n<p><strong>runWorker</strong><strong>task.run()</strong></p>\n<ul>\n<li>executetask=Runnablerun</li>\n<li>submitRunnableFutureTasktask=FutureTaskFutureTaskrunget()</li>\n</ul>\n<pre><code class=\"java\">try {\n       task.run();\n   } catch (RuntimeException x) {\n       thrown = x; throw x;\n   } catch (Error x) {\n       thrown = x; throw x;\n   } catch (Throwable x) {\n       //  Throwable Error\n       thrown = x; throw new Error(x);\n   } finally {\n       //  task \n       afterExecute(task, thrown);\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/60524908\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/60524908</a></li>\n</ul>"},{"title":"CompletableFuture","description":"CompletableFuture","date":"2019-07-18T02:00:00.000Z","_content":"## CompletableFuture\nCompletableFutureJDK8\nFutureFuture \n- \n- Future\n- Future\n<!--more-->\n## CompletableFuture\n### \nCompletableFuture4\n```java\npublic static CompletableFuture<Void> runAsync(Runnable runnable)\npublic static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)\n```\n\n- runAsync  supplyAsync \n- ExecutorForkJoinPool.commonPool() \n- ForkJoinPool\n  - ThreadPool\n  - ForkJoinPool\n\n```java\n@org.junit.Test\npublic void runOrsupply() throws ExecutionException, InterruptedException {\n    //\n    CompletableFuture<Void> voidCompletableFuture = CompletableFuture.runAsync(new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"!!!\");\n        }\n    } , Executors.newCachedThreadPool());\n    voidCompletableFuture.get();\n   \n    //\n    CompletableFuture<String> stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            return \"success\";\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}\n```\n\n### \n\nCompletableFuture\n\n- whenComplete  whenCompleteAsync \n- exceptionally\n\n```java\npublic CompletableFuture<T> whenComplete(BiConsumer<? super T,? super Throwable> action)\npublic CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action)\npublic CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action, Executor executor)\npublic CompletableFuture<T> exceptionally(Function<Throwable,? extends T> fn)\n```\n\n```java\n@org.junit.Test\npublic void testWhenComplete2() throws ExecutionException, InterruptedException {\n    CompletableFuture<String> stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            int i = 1 / 0; //\n            return \"xuzy\";\n        }\n    }).whenComplete(new BiConsumer<String, Throwable>() {\n        @Override\n        public void accept(String s, Throwable throwable) {\n            System.out.println(\"supplyAsync = \" + s);\n        }\n    }).exceptionally(new Function<Throwable, String>() {\n        @Override\n        public String apply(Throwable throwable) {\n            //supplyAsync\n            return \"xuzy is fail\";\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}\n```\n\n### \n\nhandle \n\n```java\npublic <U> CompletionStage<U> handle(BiFunction<? super T, Throwable, ? extends U> fn);\npublic <U> CompletionStage<U> handleAsync(BiFunction<? super T, Throwable, ? extends U> fn);\npublic <U> CompletionStage<U> handleAsync(BiFunction<? super T, Throwable, ? extends U> fn,Executor executor);\n```\n\n```java\n@org.junit.Test\npublic void testHandle() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> future = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            int i = 1 / 0; //\n            return new RandomUtils().nextInt(0, 10);\n        }\n    }).handle(new BiFunction<Integer, Throwable, Integer>() {\n        @Override\n        public Integer apply(Integer integer, Throwable throwable) {\n            int result = -1;\n            //*2-1\n            if (throwable == null) {\n                result = integer * 2;\n            } else {\n                System.out.println(throwable.getMessage());\n            }\n            return result;\n        }\n    });\n    Integer result = future.get();\n    System.out.println(result);\n}\n```\n\n###   \n\n thenApply <font color=red>AthenApply</font>\n\n```java\n@org.junit.Test\npublic void testThenApply() throws ExecutionException, InterruptedException {\n    //A\n    CompletableFuture<Long> futureA = CompletableFuture.supplyAsync(new Supplier<Long>() {\n        @Override\n        public Long get() {\n            return RandomUtils.nextLong(0, 100);\n        }\n    });\n    //B\n    CompletableFuture<String> futureB = futureA.thenApply(new Function<Long, String>() {\n        @Override\n        public String apply(Long aLong) {\n            long result = aLong * 5;\n            return \"xuzy-\" + result;\n        }\n    });\n    System.out.println(futureB.get());\n}\n```\n\nhandle   thenApply\n\n- handle \n- thenApply  thenApply \n\n### A\n\nfutureAIntegerthenAcceptVoidfutureA\n\n```java\n@org.junit.Test\npublic void testThenAccept() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> futureA = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            System.out.println(\"A\");\n            return new Random().nextInt(10);\n        }\n    });\n    CompletableFuture<Void> futureVoid = futureA.thenAccept(new Consumer<Integer>() {\n        @Override\n        public void accept(Integer integer) {\n            System.out.println(\"A \" + integer + \" , \");\n        }\n    });\n    futureVoid.get();\n    \n    //thenAcceptthenRun\n    futureA.thenRun(new Runnable() {\n            @Override\n            public void run() {\n\t\t\t\tSystem.out.println(\"\");\n            }\n    });\n}\n```\n\n### AB\n\nthenCombine   CompletionStage  thenCombine \n\nthenAcceptBoth   CompletionStage \n\nthenCombine  thenAcceptBoth ()\n\n```java\n@org.junit.Test\npublic void testThenCombine() throws ExecutionException, InterruptedException {\n    CompletableFuture<String> future1 = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(5);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return \"hello\";\n        }\n    });\n    CompletableFuture<String> future2 = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return \"world\";\n        }\n    });\n    CompletableFuture<String> result = future1.thenCombine(future2, new BiFunction<String, String, String>() {\n        @Override\n        public String apply(String s, String s2) {\n            return s + \" \" + s2;\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(result.get());\n    System.out.println((System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n### AB\n\nCompletionStageCompletionStage\n\nacceptEither\n\n```java\npublic CompletionStage<Void> acceptEither(CompletionStage<? extends T> other,Consumer<? super T> action);\npublic CompletionStage<Void> acceptEitherAsync(CompletionStage<? extends T> other,Consumer<? super T> action);\npublic CompletionStage<Void> acceptEitherAsync(CompletionStage<? extends T> other,Consumer<? super T> action,Executor executor);\n```\n\n**runAfterEither**\n\n```java\npublic CompletionStage<Void> runAfterEither(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterEitherAsync(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterEitherAsync(CompletionStage<?> other,Runnable action,Executor executor);\n```\n\nacceptEither  runAfterEither \n\n<font color=red></font>\n\n```java\n@org.junit.Test\npublic void testJoinOr() {\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(\"f1\");\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    //f1.applyToEither(f2  f1f2\n    CompletableFuture<String> f3 = f1.applyToEither(f2, new Function<String, String>() {\n        @Override\n        public String apply(String s) {\n            return \"   : \" + s  + \", \";\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(f3.join());\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}\n```\n\n```java\n@org.junit.Test\npublic void testrunAfterEither(){\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(\"f1\");\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    CompletableFuture<Void> f3 = f1.runAfterEither(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"f3\");\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}\n```\n\n### \n\nCompletionStageRunnable\n\n```java\npublic CompletionStage<Void> runAfterBoth(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterBothAsync(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterBothAsync(CompletionStage<?> other,Runnable action,Executor executor);\n```\n\n```java\n@org.junit.Test\npublic void testrunAfterBoth(){\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    CompletableFuture<Void> f3 = f1.runAfterBoth(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"f1,f2\");\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n### allOf\n\n```java\n@org.junit.Test\npublic void testAllOf() throws ExecutionException, InterruptedException {\n    ExecutorService executorService = Executors.newCachedThreadPool();\n    List<CompletableFuture<String>> futureList = Lists.newArrayList();\n    List<String> uuidList = Lists.newArrayList();\n    for (int i = 0; i < 10; i++) {\n        futureList.add(CompletableFuture.supplyAsync(() -> {\n            synchronized (uuidList) {\n                for (int j = 0; j < 100; j++) {\n                    uuidList.add(UUID.randomUUID().toString());\n                }\n            }\n            System.out.println(\"threadID:\" + Thread.currentThread().getId() + \"\");\n            return null;\n        }, executorService));\n    }\n    CompletableFuture<Void> result = CompletableFuture.allOf(futureList.toArray(new CompletableFuture[futureList.size()]));\n    result.get();\n    System.out.println(uuidList.size());\n}\n```\n\n### anyOf \n\nacceptEither\n\n```java\n@org.junit.Test\npublic void testAnyOf() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> f1 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(2);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f1 done\");\n            return 1;\n        }\n    });\n    CompletableFuture<Integer> f2 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f2 done\");\n            return 2;\n        }\n    });\n    CompletableFuture<Integer> f3 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(15);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f3 done\");\n            return 3;\n        }\n    });\n\n    CompletableFuture<Object> objectCompletableFuture = CompletableFuture.anyOf(f1, f2, f3);\n    long start = System.currentTimeMillis();\n    Object o = objectCompletableFuture.get();\n    System.out.println(\"result = \" + o + \" :\" + (System.currentTimeMillis() - start) + \" ms\");\n    TimeUnit.SECONDS.sleep(30);\n}\n```\n\n## \n\n### get()join()\n\n- join()get()CompletableFuture\n- join()uncheck),\n- get()ExecutionException, InterruptedException  try catch\n\n### AsyncAsync\n\n Async  Async \n\n### Executor executor\n\nCompletableFuture<font color=red>Executor executor</font>ExecutorExecutorForkJoinPoolForkJoinPoolCPU\n\n```java\nprivate static final Executor asyncPool = useCommonPool ?\n        ForkJoinPool.commonPool() : new ThreadPerTaskExecutor();\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier) {\n        return asyncSupplyStage(asyncPool, supplier);\n    }\n```\n\n- CPUForkJoinPool\n- IOForkJoinPool","source":"_posts/completable-future.md","raw":"---\ntitle: CompletableFuture\ntags:\n  - java\n  - java8\ncategories:  java\ndescription : CompletableFuture\ndate: 2019-07-18 10:00:00\n---\n## CompletableFuture\nCompletableFutureJDK8\nFutureFuture \n- \n- Future\n- Future\n<!--more-->\n## CompletableFuture\n### \nCompletableFuture4\n```java\npublic static CompletableFuture<Void> runAsync(Runnable runnable)\npublic static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)\n```\n\n- runAsync  supplyAsync \n- ExecutorForkJoinPool.commonPool() \n- ForkJoinPool\n  - ThreadPool\n  - ForkJoinPool\n\n```java\n@org.junit.Test\npublic void runOrsupply() throws ExecutionException, InterruptedException {\n    //\n    CompletableFuture<Void> voidCompletableFuture = CompletableFuture.runAsync(new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"!!!\");\n        }\n    } , Executors.newCachedThreadPool());\n    voidCompletableFuture.get();\n   \n    //\n    CompletableFuture<String> stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            return \"success\";\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}\n```\n\n### \n\nCompletableFuture\n\n- whenComplete  whenCompleteAsync \n- exceptionally\n\n```java\npublic CompletableFuture<T> whenComplete(BiConsumer<? super T,? super Throwable> action)\npublic CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action)\npublic CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action, Executor executor)\npublic CompletableFuture<T> exceptionally(Function<Throwable,? extends T> fn)\n```\n\n```java\n@org.junit.Test\npublic void testWhenComplete2() throws ExecutionException, InterruptedException {\n    CompletableFuture<String> stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            int i = 1 / 0; //\n            return \"xuzy\";\n        }\n    }).whenComplete(new BiConsumer<String, Throwable>() {\n        @Override\n        public void accept(String s, Throwable throwable) {\n            System.out.println(\"supplyAsync = \" + s);\n        }\n    }).exceptionally(new Function<Throwable, String>() {\n        @Override\n        public String apply(Throwable throwable) {\n            //supplyAsync\n            return \"xuzy is fail\";\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}\n```\n\n### \n\nhandle \n\n```java\npublic <U> CompletionStage<U> handle(BiFunction<? super T, Throwable, ? extends U> fn);\npublic <U> CompletionStage<U> handleAsync(BiFunction<? super T, Throwable, ? extends U> fn);\npublic <U> CompletionStage<U> handleAsync(BiFunction<? super T, Throwable, ? extends U> fn,Executor executor);\n```\n\n```java\n@org.junit.Test\npublic void testHandle() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> future = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            int i = 1 / 0; //\n            return new RandomUtils().nextInt(0, 10);\n        }\n    }).handle(new BiFunction<Integer, Throwable, Integer>() {\n        @Override\n        public Integer apply(Integer integer, Throwable throwable) {\n            int result = -1;\n            //*2-1\n            if (throwable == null) {\n                result = integer * 2;\n            } else {\n                System.out.println(throwable.getMessage());\n            }\n            return result;\n        }\n    });\n    Integer result = future.get();\n    System.out.println(result);\n}\n```\n\n###   \n\n thenApply <font color=red>AthenApply</font>\n\n```java\n@org.junit.Test\npublic void testThenApply() throws ExecutionException, InterruptedException {\n    //A\n    CompletableFuture<Long> futureA = CompletableFuture.supplyAsync(new Supplier<Long>() {\n        @Override\n        public Long get() {\n            return RandomUtils.nextLong(0, 100);\n        }\n    });\n    //B\n    CompletableFuture<String> futureB = futureA.thenApply(new Function<Long, String>() {\n        @Override\n        public String apply(Long aLong) {\n            long result = aLong * 5;\n            return \"xuzy-\" + result;\n        }\n    });\n    System.out.println(futureB.get());\n}\n```\n\nhandle   thenApply\n\n- handle \n- thenApply  thenApply \n\n### A\n\nfutureAIntegerthenAcceptVoidfutureA\n\n```java\n@org.junit.Test\npublic void testThenAccept() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> futureA = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            System.out.println(\"A\");\n            return new Random().nextInt(10);\n        }\n    });\n    CompletableFuture<Void> futureVoid = futureA.thenAccept(new Consumer<Integer>() {\n        @Override\n        public void accept(Integer integer) {\n            System.out.println(\"A \" + integer + \" , \");\n        }\n    });\n    futureVoid.get();\n    \n    //thenAcceptthenRun\n    futureA.thenRun(new Runnable() {\n            @Override\n            public void run() {\n\t\t\t\tSystem.out.println(\"\");\n            }\n    });\n}\n```\n\n### AB\n\nthenCombine   CompletionStage  thenCombine \n\nthenAcceptBoth   CompletionStage \n\nthenCombine  thenAcceptBoth ()\n\n```java\n@org.junit.Test\npublic void testThenCombine() throws ExecutionException, InterruptedException {\n    CompletableFuture<String> future1 = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(5);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return \"hello\";\n        }\n    });\n    CompletableFuture<String> future2 = CompletableFuture.supplyAsync(new Supplier<String>() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return \"world\";\n        }\n    });\n    CompletableFuture<String> result = future1.thenCombine(future2, new BiFunction<String, String, String>() {\n        @Override\n        public String apply(String s, String s2) {\n            return s + \" \" + s2;\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(result.get());\n    System.out.println((System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n### AB\n\nCompletionStageCompletionStage\n\nacceptEither\n\n```java\npublic CompletionStage<Void> acceptEither(CompletionStage<? extends T> other,Consumer<? super T> action);\npublic CompletionStage<Void> acceptEitherAsync(CompletionStage<? extends T> other,Consumer<? super T> action);\npublic CompletionStage<Void> acceptEitherAsync(CompletionStage<? extends T> other,Consumer<? super T> action,Executor executor);\n```\n\n**runAfterEither**\n\n```java\npublic CompletionStage<Void> runAfterEither(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterEitherAsync(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterEitherAsync(CompletionStage<?> other,Runnable action,Executor executor);\n```\n\nacceptEither  runAfterEither \n\n<font color=red></font>\n\n```java\n@org.junit.Test\npublic void testJoinOr() {\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(\"f1\");\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    //f1.applyToEither(f2  f1f2\n    CompletableFuture<String> f3 = f1.applyToEither(f2, new Function<String, String>() {\n        @Override\n        public String apply(String s) {\n            return \"   : \" + s  + \", \";\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(f3.join());\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}\n```\n\n```java\n@org.junit.Test\npublic void testrunAfterEither(){\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(\"f1\");\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    CompletableFuture<Void> f3 = f1.runAfterEither(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"f3\");\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}\n```\n\n### \n\nCompletionStageRunnable\n\n```java\npublic CompletionStage<Void> runAfterBoth(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterBothAsync(CompletionStage<?> other,Runnable action);\npublic CompletionStage<Void> runAfterBothAsync(CompletionStage<?> other,Runnable action,Executor executor);\n```\n\n```java\n@org.junit.Test\npublic void testrunAfterBoth(){\n    CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f1\";\n    });\n    CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return \"f2\";\n    });\n    CompletableFuture<Void> f3 = f1.runAfterBoth(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"f1,f2\");\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(\":\" + (System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n### allOf\n\n```java\n@org.junit.Test\npublic void testAllOf() throws ExecutionException, InterruptedException {\n    ExecutorService executorService = Executors.newCachedThreadPool();\n    List<CompletableFuture<String>> futureList = Lists.newArrayList();\n    List<String> uuidList = Lists.newArrayList();\n    for (int i = 0; i < 10; i++) {\n        futureList.add(CompletableFuture.supplyAsync(() -> {\n            synchronized (uuidList) {\n                for (int j = 0; j < 100; j++) {\n                    uuidList.add(UUID.randomUUID().toString());\n                }\n            }\n            System.out.println(\"threadID:\" + Thread.currentThread().getId() + \"\");\n            return null;\n        }, executorService));\n    }\n    CompletableFuture<Void> result = CompletableFuture.allOf(futureList.toArray(new CompletableFuture[futureList.size()]));\n    result.get();\n    System.out.println(uuidList.size());\n}\n```\n\n### anyOf \n\nacceptEither\n\n```java\n@org.junit.Test\npublic void testAnyOf() throws ExecutionException, InterruptedException {\n    CompletableFuture<Integer> f1 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(2);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f1 done\");\n            return 1;\n        }\n    });\n    CompletableFuture<Integer> f2 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f2 done\");\n            return 2;\n        }\n    });\n    CompletableFuture<Integer> f3 = CompletableFuture.supplyAsync(new Supplier<Integer>() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(15);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(\"f3 done\");\n            return 3;\n        }\n    });\n\n    CompletableFuture<Object> objectCompletableFuture = CompletableFuture.anyOf(f1, f2, f3);\n    long start = System.currentTimeMillis();\n    Object o = objectCompletableFuture.get();\n    System.out.println(\"result = \" + o + \" :\" + (System.currentTimeMillis() - start) + \" ms\");\n    TimeUnit.SECONDS.sleep(30);\n}\n```\n\n## \n\n### get()join()\n\n- join()get()CompletableFuture\n- join()uncheck),\n- get()ExecutionException, InterruptedException  try catch\n\n### AsyncAsync\n\n Async  Async \n\n### Executor executor\n\nCompletableFuture<font color=red>Executor executor</font>ExecutorExecutorForkJoinPoolForkJoinPoolCPU\n\n```java\nprivate static final Executor asyncPool = useCommonPool ?\n        ForkJoinPool.commonPool() : new ThreadPerTaskExecutor();\npublic static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier) {\n        return asyncSupplyStage(asyncPool, supplier);\n    }\n```\n\n- CPUForkJoinPool\n- IOForkJoinPool","slug":"completable-future","published":1,"updated":"2021-04-08T00:47:06.717Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhuc0005qwv2cft38t6r","content":"<h2 id=\"CompletableFuture\"><a href=\"#CompletableFuture\" class=\"headerlink\" title=\"CompletableFuture\"></a>CompletableFuture</h2><p>CompletableFutureJDK8<br>FutureFuture </p>\n<ul>\n<li><p></p>\n</li>\n<li><p>Future</p>\n</li>\n<li><p>Future</p>\n<a id=\"more\"></a>\n<h2 id=\"CompletableFuture\"><a href=\"#CompletableFuture\" class=\"headerlink\" title=\"CompletableFuture\"></a>CompletableFuture</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletableFuture4</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span>Runnable runnable<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span>Runnable runnable<span class=\"token punctuation\">,</span> Executor executor<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletableFuture<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span>Supplier<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> supplier<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletableFuture<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span>Supplier<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> supplier<span class=\"token punctuation\">,</span> Executor executor<span class=\"token punctuation\">)</span></code></pre>\n</li>\n<li><p>runAsync  supplyAsync </p>\n</li>\n<li><p>ExecutorForkJoinPool.commonPool() </p>\n</li>\n<li><p>ForkJoinPool</p>\n<ul>\n<li>ThreadPool</li>\n<li>ForkJoinPool</li>\n</ul>\n</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runOrsupply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> voidCompletableFuture <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"!!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">,</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newCachedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    voidCompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> stringCompletableFuture <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>stringCompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletableFuture</p>\n<ul>\n<li>whenComplete  whenCompleteAsync </li>\n<li>exceptionally</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> CompletableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">whenComplete</span><span class=\"token punctuation\">(</span>BiConsumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> Throwable<span class=\"token operator\">></span> action<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> CompletableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">whenCompleteAsync</span><span class=\"token punctuation\">(</span>BiConsumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> Throwable<span class=\"token operator\">></span> action<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> CompletableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">whenCompleteAsync</span><span class=\"token punctuation\">(</span>BiConsumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> Throwable<span class=\"token operator\">></span> action<span class=\"token punctuation\">,</span> Executor executor<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> CompletableFuture<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">exceptionally</span><span class=\"token punctuation\">(</span>Function<span class=\"token operator\">&lt;</span>Throwable<span class=\"token punctuation\">,</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span> fn<span class=\"token punctuation\">)</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testWhenComplete2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> stringCompletableFuture <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"xuzy\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">whenComplete</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BiConsumer</span><span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Throwable<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>String s<span class=\"token punctuation\">,</span> Throwable throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"supplyAsync = \"</span> <span class=\"token operator\">+</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">exceptionally</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Function</span><span class=\"token operator\">&lt;</span>Throwable<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>Throwable throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//supplyAsync</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"xuzy is fail\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>stringCompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>handle </p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletionStage<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>BiFunction<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span> Throwable<span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">U</span><span class=\"token operator\">></span> fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletionStage<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">handleAsync</span><span class=\"token punctuation\">(</span>BiFunction<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span> Throwable<span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">U</span><span class=\"token operator\">></span> fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletionStage<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">handleAsync</span><span class=\"token punctuation\">(</span>BiFunction<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token punctuation\">,</span> Throwable<span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">U</span><span class=\"token operator\">></span> fn<span class=\"token punctuation\">,</span>Executor executor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testHandle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> future <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RandomUtils</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BiFunction</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token punctuation\">,</span> Throwable<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>Integer integer<span class=\"token punctuation\">,</span> Throwable throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> result <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//*2-1</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>throwable <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                result <span class=\"token operator\">=</span> integer <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>throwable<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Integer result <span class=\"token operator\">=</span> future<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"  \"></a>  </h3><p> thenApply <font color=\"red\">AthenApply</font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testThenApply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//A</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> futureA <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Long <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> RandomUtils<span class=\"token punctuation\">.</span><span class=\"token function\">nextLong</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//B</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> futureB <span class=\"token operator\">=</span> futureA<span class=\"token punctuation\">.</span><span class=\"token function\">thenApply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Function</span><span class=\"token operator\">&lt;</span>Long<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>Long aLong<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">long</span> result <span class=\"token operator\">=</span> aLong <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"xuzy-\"</span> <span class=\"token operator\">+</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>futureB<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>handle   thenApply</p>\n<ul>\n<li>handle </li>\n<li>thenApply  thenApply </li>\n</ul>\n<h3 id=\"A\"><a href=\"#A\" class=\"headerlink\" title=\"A\"></a>A</h3><p>futureAIntegerthenAcceptVoidfutureA</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testThenAccept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> futureA <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> futureVoid <span class=\"token operator\">=</span> futureA<span class=\"token punctuation\">.</span><span class=\"token function\">thenAccept</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Consumer</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>Integer integer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A \"</span> <span class=\"token operator\">+</span> integer <span class=\"token operator\">+</span> <span class=\"token string\">\" , \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    futureVoid<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//thenAcceptthenRun</span>\n    futureA<span class=\"token punctuation\">.</span><span class=\"token function\">thenRun</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"AB\"><a href=\"#AB\" class=\"headerlink\" title=\"AB\"></a>AB</h3><p>thenCombine   CompletionStage  thenCombine </p>\n<p>thenAcceptBoth   CompletionStage </p>\n<p>thenCombine  thenAcceptBoth ()</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testThenCombine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> future1 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> future2 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"world\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> result <span class=\"token operator\">=</span> future1<span class=\"token punctuation\">.</span><span class=\"token function\">thenCombine</span><span class=\"token punctuation\">(</span>future2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BiFunction</span><span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>String s<span class=\"token punctuation\">,</span> String s2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> s <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">+</span> s2<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"AB\"><a href=\"#AB\" class=\"headerlink\" title=\"AB\"></a>AB</h3><p>CompletionStageCompletionStage</p>\n<p>acceptEither</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">acceptEither</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Consumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token operator\">></span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">acceptEitherAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Consumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token operator\">></span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">acceptEitherAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Consumer<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> T<span class=\"token operator\">></span> action<span class=\"token punctuation\">,</span>Executor executor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><strong>runAfterEither</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterEither</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterEitherAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterEitherAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">,</span>Executor executor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>acceptEither  runAfterEither </p>\n<p><font color=\"red\"></font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testJoinOr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f1 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f2 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f2\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//f1.applyToEither(f2  f1f2</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f3 <span class=\"token operator\">=</span> f1<span class=\"token punctuation\">.</span><span class=\"token function\">applyToEither</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Function</span><span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> String <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>String s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"   : \"</span> <span class=\"token operator\">+</span> s  <span class=\"token operator\">+</span> <span class=\"token string\">\", \"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>f3<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//20f1f2</span>\n        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testrunAfterEither</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f1 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f2 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f2\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> f3 <span class=\"token operator\">=</span> f1<span class=\"token punctuation\">.</span><span class=\"token function\">runAfterEither</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    f3<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//20f1f2</span>\n        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletionStageRunnable</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterBoth</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterBothAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> CompletionStage<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> <span class=\"token function\">runAfterBothAsync</span><span class=\"token punctuation\">(</span>CompletionStage<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> other<span class=\"token punctuation\">,</span>Runnable action<span class=\"token punctuation\">,</span>Executor executor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testrunAfterBoth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f1 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> f2 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"f2\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> f3 <span class=\"token operator\">=</span> f1<span class=\"token punctuation\">.</span><span class=\"token function\">runAfterBoth</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f1,f2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    f3<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"allOf\"><a href=\"#allOf\" class=\"headerlink\" title=\"allOf\"></a>allOf</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testAllOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    ExecutorService executorService <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newCachedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    List<span class=\"token operator\">&lt;</span>CompletableFuture<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">>></span> futureList <span class=\"token operator\">=</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> uuidList <span class=\"token operator\">=</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        futureList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>uuidList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    uuidList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadID:\"</span> <span class=\"token operator\">+</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> executorService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> result <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>futureList<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">[</span>futureList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>uuidList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"anyOf-\"><a href=\"#anyOf-\" class=\"headerlink\" title=\"anyOf \"></a>anyOf </h3><p>acceptEither</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@org</span><span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testAnyOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> f1 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f1 done\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> f2 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f2 done\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    CompletableFuture<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> f3 <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Supplier</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> Integer <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f3 done\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    CompletableFuture<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> objectCompletableFuture <span class=\"token operator\">=</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">anyOf</span><span class=\"token punctuation\">(</span>f1<span class=\"token punctuation\">,</span> f2<span class=\"token punctuation\">,</span> f3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Object o <span class=\"token operator\">=</span> objectCompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result = \"</span> <span class=\"token operator\">+</span> o <span class=\"token operator\">+</span> <span class=\"token string\">\" :\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"get-join-\"><a href=\"#get-join-\" class=\"headerlink\" title=\"get()join()\"></a>get()join()</h3><ul>\n<li>join()get()CompletableFuture</li>\n<li>join()uncheck),</li>\n<li>get()ExecutionException, InterruptedException  try catch</li>\n</ul>\n<h3 id=\"AsyncAsync\"><a href=\"#AsyncAsync\" class=\"headerlink\" title=\"AsyncAsync\"></a>AsyncAsync</h3><p> Async  Async </p>\n<h3 id=\"Executor-executor\"><a href=\"#Executor-executor\" class=\"headerlink\" title=\"Executor executor\"></a>Executor executor</h3><p>CompletableFuture<font color=\"red\">Executor executor</font>ExecutorExecutorForkJoinPoolForkJoinPoolCPU</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Executor asyncPool <span class=\"token operator\">=</span> useCommonPool <span class=\"token operator\">?</span>\n        ForkJoinPool<span class=\"token punctuation\">.</span><span class=\"token function\">commonPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPerTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> CompletableFuture<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> <span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span>Supplier<span class=\"token operator\">&lt;</span>U<span class=\"token operator\">></span> supplier<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">asyncSupplyStage</span><span class=\"token punctuation\">(</span>asyncPool<span class=\"token punctuation\">,</span> supplier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<ul>\n<li>CPUForkJoinPool</li>\n<li>IOForkJoinPool</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"CompletableFuture\"><a href=\"#CompletableFuture\" class=\"headerlink\" title=\"CompletableFuture\"></a>CompletableFuture</h2><p>CompletableFutureJDK8<br>FutureFuture </p>\n<ul>\n<li><p></p>\n</li>\n<li><p>Future</p>\n</li>\n<li><p>Future</p></li></ul>","more":"<h2 id=\"CompletableFuture\"><a href=\"#CompletableFuture\" class=\"headerlink\" title=\"CompletableFuture\"></a>CompletableFuture</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletableFuture4</p>\n<pre><code class=\"java\">public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable)\npublic static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable, Executor executor)\npublic static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier)\npublic static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier, Executor executor)</code></pre>\n\n<li><p>runAsync  supplyAsync </p>\n</li>\n<li><p>ExecutorForkJoinPool.commonPool() </p>\n</li>\n<li><p>ForkJoinPool</p>\n<ul>\n<li>ThreadPool</li>\n<li>ForkJoinPool</li>\n</ul>\n</li>\n\n<pre><code class=\"java\">@org.junit.Test\npublic void runOrsupply() throws ExecutionException, InterruptedException {\n    //\n    CompletableFuture&lt;Void&gt; voidCompletableFuture = CompletableFuture.runAsync(new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(&quot;!!!&quot;);\n        }\n    } , Executors.newCachedThreadPool());\n    voidCompletableFuture.get();\n\n    //\n    CompletableFuture&lt;String&gt; stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() {\n        @Override\n        public String get() {\n            return &quot;success&quot;;\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletableFuture</p>\n<ul>\n<li>whenComplete  whenCompleteAsync </li>\n<li>exceptionally</li>\n</ul>\n<pre><code class=\"java\">public CompletableFuture&lt;T&gt; whenComplete(BiConsumer&lt;? super T,? super Throwable&gt; action)\npublic CompletableFuture&lt;T&gt; whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action)\npublic CompletableFuture&lt;T&gt; whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action, Executor executor)\npublic CompletableFuture&lt;T&gt; exceptionally(Function&lt;Throwable,? extends T&gt; fn)</code></pre>\n<pre><code class=\"java\">@org.junit.Test\npublic void testWhenComplete2() throws ExecutionException, InterruptedException {\n    CompletableFuture&lt;String&gt; stringCompletableFuture = CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() {\n        @Override\n        public String get() {\n            int i = 1 / 0; //\n            return &quot;xuzy&quot;;\n        }\n    }).whenComplete(new BiConsumer&lt;String, Throwable&gt;() {\n        @Override\n        public void accept(String s, Throwable throwable) {\n            System.out.println(&quot;supplyAsync = &quot; + s);\n        }\n    }).exceptionally(new Function&lt;Throwable, String&gt;() {\n        @Override\n        public String apply(Throwable throwable) {\n            //supplyAsync\n            return &quot;xuzy is fail&quot;;\n        }\n    });\n    System.out.println(stringCompletableFuture.get());\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>handle </p>\n<pre><code class=\"java\">public &lt;U&gt; CompletionStage&lt;U&gt; handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn);\npublic &lt;U&gt; CompletionStage&lt;U&gt; handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn);\npublic &lt;U&gt; CompletionStage&lt;U&gt; handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn,Executor executor);</code></pre>\n<pre><code class=\"java\">@org.junit.Test\npublic void testHandle() throws ExecutionException, InterruptedException {\n    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() {\n        @Override\n        public Integer get() {\n            int i = 1 / 0; //\n            return new RandomUtils().nextInt(0, 10);\n        }\n    }).handle(new BiFunction&lt;Integer, Throwable, Integer&gt;() {\n        @Override\n        public Integer apply(Integer integer, Throwable throwable) {\n            int result = -1;\n            //*2-1\n            if (throwable == null) {\n                result = integer * 2;\n            } else {\n                System.out.println(throwable.getMessage());\n            }\n            return result;\n        }\n    });\n    Integer result = future.get();\n    System.out.println(result);\n}</code></pre>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"  \"></a>  </h3><p> thenApply <font color=\"red\">AthenApply</font></p>\n<pre><code class=\"java\">@org.junit.Test\npublic void testThenApply() throws ExecutionException, InterruptedException {\n    //A\n    CompletableFuture&lt;Long&gt; futureA = CompletableFuture.supplyAsync(new Supplier&lt;Long&gt;() {\n        @Override\n        public Long get() {\n            return RandomUtils.nextLong(0, 100);\n        }\n    });\n    //B\n    CompletableFuture&lt;String&gt; futureB = futureA.thenApply(new Function&lt;Long, String&gt;() {\n        @Override\n        public String apply(Long aLong) {\n            long result = aLong * 5;\n            return &quot;xuzy-&quot; + result;\n        }\n    });\n    System.out.println(futureB.get());\n}</code></pre>\n<p>handle   thenApply</p>\n<ul>\n<li>handle </li>\n<li>thenApply  thenApply </li>\n</ul>\n<h3 id=\"A\"><a href=\"#A\" class=\"headerlink\" title=\"A\"></a>A</h3><p>futureAIntegerthenAcceptVoidfutureA</p>\n<pre><code class=\"java\">@org.junit.Test\npublic void testThenAccept() throws ExecutionException, InterruptedException {\n    CompletableFuture&lt;Integer&gt; futureA = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() {\n        @Override\n        public Integer get() {\n            System.out.println(&quot;A&quot;);\n            return new Random().nextInt(10);\n        }\n    });\n    CompletableFuture&lt;Void&gt; futureVoid = futureA.thenAccept(new Consumer&lt;Integer&gt;() {\n        @Override\n        public void accept(Integer integer) {\n            System.out.println(&quot;A &quot; + integer + &quot; , &quot;);\n        }\n    });\n    futureVoid.get();\n\n    //thenAcceptthenRun\n    futureA.thenRun(new Runnable() {\n            @Override\n            public void run() {\n                System.out.println(&quot;&quot;);\n            }\n    });\n}</code></pre>\n<h3 id=\"AB\"><a href=\"#AB\" class=\"headerlink\" title=\"AB\"></a>AB</h3><p>thenCombine   CompletionStage  thenCombine </p>\n<p>thenAcceptBoth   CompletionStage </p>\n<p>thenCombine  thenAcceptBoth ()</p>\n<pre><code class=\"java\">@org.junit.Test\npublic void testThenCombine() throws ExecutionException, InterruptedException {\n    CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(5);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return &quot;hello&quot;;\n        }\n    });\n    CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() {\n        @Override\n        public String get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            return &quot;world&quot;;\n        }\n    });\n    CompletableFuture&lt;String&gt; result = future1.thenCombine(future2, new BiFunction&lt;String, String, String&gt;() {\n        @Override\n        public String apply(String s, String s2) {\n            return s + &quot; &quot; + s2;\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(result.get());\n    System.out.println((System.currentTimeMillis() - start) + &quot; ms&quot;);\n}</code></pre>\n<h3 id=\"AB\"><a href=\"#AB\" class=\"headerlink\" title=\"AB\"></a>AB</h3><p>CompletionStageCompletionStage</p>\n<p>acceptEither</p>\n<pre><code class=\"java\">public CompletionStage&lt;Void&gt; acceptEither(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? super T&gt; action);\npublic CompletionStage&lt;Void&gt; acceptEitherAsync(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? super T&gt; action);\npublic CompletionStage&lt;Void&gt; acceptEitherAsync(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? super T&gt; action,Executor executor);</code></pre>\n<p><strong>runAfterEither</strong></p>\n<pre><code class=\"java\">public CompletionStage&lt;Void&gt; runAfterEither(CompletionStage&lt;?&gt; other,Runnable action);\npublic CompletionStage&lt;Void&gt; runAfterEitherAsync(CompletionStage&lt;?&gt; other,Runnable action);\npublic CompletionStage&lt;Void&gt; runAfterEitherAsync(CompletionStage&lt;?&gt; other,Runnable action,Executor executor);</code></pre>\n<p>acceptEither  runAfterEither </p>\n<p><font color=\"red\"></font></p>\n<pre><code class=\"java\">@org.junit.Test\npublic void testJoinOr() {\n    CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(&quot;f1&quot;);\n        return &quot;f1&quot;;\n    });\n    CompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return &quot;f2&quot;;\n    });\n    //f1.applyToEither(f2  f1f2\n    CompletableFuture&lt;String&gt; f3 = f1.applyToEither(f2, new Function&lt;String, String&gt;() {\n        @Override\n        public String apply(String s) {\n            return &quot;   : &quot; + s  + &quot;, &quot;;\n        }\n    });\n    long start = System.currentTimeMillis();\n    System.out.println(f3.join());\n    System.out.println(&quot;:&quot; + (System.currentTimeMillis() - start) + &quot; ms&quot;);\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}</code></pre>\n<pre><code class=\"java\">@org.junit.Test\npublic void testrunAfterEither(){\n    CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(&quot;f1&quot;);\n        return &quot;f1&quot;;\n    });\n    CompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return &quot;f2&quot;;\n    });\n    CompletableFuture&lt;Void&gt; f3 = f1.runAfterEither(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(&quot;f3&quot;);\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(&quot;:&quot; + (System.currentTimeMillis() - start) + &quot; ms&quot;);\n    try {\n        //20f1f2\n        TimeUnit.SECONDS.sleep(20);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CompletionStageRunnable</p>\n<pre><code class=\"java\">public CompletionStage&lt;Void&gt; runAfterBoth(CompletionStage&lt;?&gt; other,Runnable action);\npublic CompletionStage&lt;Void&gt; runAfterBothAsync(CompletionStage&lt;?&gt; other,Runnable action);\npublic CompletionStage&lt;Void&gt; runAfterBothAsync(CompletionStage&lt;?&gt; other,Runnable action,Executor executor);</code></pre>\n<pre><code class=\"java\">@org.junit.Test\npublic void testrunAfterBoth(){\n    CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(10);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return &quot;f1&quot;;\n    });\n    CompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(2);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return &quot;f2&quot;;\n    });\n    CompletableFuture&lt;Void&gt; f3 = f1.runAfterBoth(f2, new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(&quot;f1,f2&quot;);\n        }\n    });\n    long start = System.currentTimeMillis();\n    f3.join();\n    System.out.println(&quot;:&quot; + (System.currentTimeMillis() - start) + &quot; ms&quot;);\n}</code></pre>\n<h3 id=\"allOf\"><a href=\"#allOf\" class=\"headerlink\" title=\"allOf\"></a>allOf</h3><pre><code class=\"java\">@org.junit.Test\npublic void testAllOf() throws ExecutionException, InterruptedException {\n    ExecutorService executorService = Executors.newCachedThreadPool();\n    List&lt;CompletableFuture&lt;String&gt;&gt; futureList = Lists.newArrayList();\n    List&lt;String&gt; uuidList = Lists.newArrayList();\n    for (int i = 0; i &lt; 10; i++) {\n        futureList.add(CompletableFuture.supplyAsync(() -&gt; {\n            synchronized (uuidList) {\n                for (int j = 0; j &lt; 100; j++) {\n                    uuidList.add(UUID.randomUUID().toString());\n                }\n            }\n            System.out.println(&quot;threadID:&quot; + Thread.currentThread().getId() + &quot;&quot;);\n            return null;\n        }, executorService));\n    }\n    CompletableFuture&lt;Void&gt; result = CompletableFuture.allOf(futureList.toArray(new CompletableFuture[futureList.size()]));\n    result.get();\n    System.out.println(uuidList.size());\n}</code></pre>\n<h3 id=\"anyOf-\"><a href=\"#anyOf-\" class=\"headerlink\" title=\"anyOf \"></a>anyOf </h3><p>acceptEither</p>\n<pre><code class=\"java\">@org.junit.Test\npublic void testAnyOf() throws ExecutionException, InterruptedException {\n    CompletableFuture&lt;Integer&gt; f1 = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(2);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(&quot;f1 done&quot;);\n            return 1;\n        }\n    });\n    CompletableFuture&lt;Integer&gt; f2 = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(10);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(&quot;f2 done&quot;);\n            return 2;\n        }\n    });\n    CompletableFuture&lt;Integer&gt; f3 = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() {\n        @Override\n        public Integer get() {\n            try {\n                TimeUnit.SECONDS.sleep(15);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            System.out.println(&quot;f3 done&quot;);\n            return 3;\n        }\n    });\n\n    CompletableFuture&lt;Object&gt; objectCompletableFuture = CompletableFuture.anyOf(f1, f2, f3);\n    long start = System.currentTimeMillis();\n    Object o = objectCompletableFuture.get();\n    System.out.println(&quot;result = &quot; + o + &quot; :&quot; + (System.currentTimeMillis() - start) + &quot; ms&quot;);\n    TimeUnit.SECONDS.sleep(30);\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"get-join-\"><a href=\"#get-join-\" class=\"headerlink\" title=\"get()join()\"></a>get()join()</h3><ul>\n<li>join()get()CompletableFuture</li>\n<li>join()uncheck),</li>\n<li>get()ExecutionException, InterruptedException  try catch</li>\n</ul>\n<h3 id=\"AsyncAsync\"><a href=\"#AsyncAsync\" class=\"headerlink\" title=\"AsyncAsync\"></a>AsyncAsync</h3><p> Async  Async </p>\n<h3 id=\"Executor-executor\"><a href=\"#Executor-executor\" class=\"headerlink\" title=\"Executor executor\"></a>Executor executor</h3><p>CompletableFuture<font color=\"red\">Executor executor</font>ExecutorExecutorForkJoinPoolForkJoinPoolCPU</p>\n<pre><code class=\"java\">private static final Executor asyncPool = useCommonPool ?\n        ForkJoinPool.commonPool() : new ThreadPerTaskExecutor();\npublic static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier) {\n        return asyncSupplyStage(asyncPool, supplier);\n    }</code></pre>\n<ul>\n<li>CPUForkJoinPool</li>\n<li>IOForkJoinPool</li>\n</ul>"},{"title":"","description":"","date":"2019-07-18T02:00:00.000Z","_content":"## \n### \n(Singleton Pattern)\n### \n\n- \n- \n- \n\n### \n#### \n```java\npublic class SingletonOne {\n    private static SingletonOne singletonOne;\n    private SingletonOne(){}\n    private static SingletonOne getInstance(){\n        if(singletonOne == null)\n            singletonOne = new SingletonOne();\n        return singletonOne;\n    }\n}\npublic static void main(String[] args){\n    SingletonOne singletonOne = SingletonOne.getInstance();\n}\n```\n<!--more-->\n \n\n- \n\n#### \n\n```java\npublic class SingletonTwo {\n    private static SingletonTwo singletonTwo;\n    private SingletonTwo(){}\n    private synchronized static SingletonTwo getInstance(){\n        if(singletonTwo == null)\n            singletonTwo = new SingletonTwo();\n        return singletonTwo;\n    }\n}\npublic static void main(String[] args){\n    SingletonTwo singletonOne = SingletonTwo.getInstance();\n}\n```\n\nsynchronized\n\n\n\n- synchronized\n\n#### \n\n```java\npublic class SingletonThree {\n    private static SingletonThree singletonThree = new SingletonThree();\n    private SingletonThree(){}\n\n    private static SingletonThree getInstance(){\n        return singletonThree;\n    }\n}\npublic static void main(String[] args){\n    SingletonThree singletonOne = SingletonThree.getInstance();\n}\n```\n\n\n\n- \n- \n\n#### \n\n```java\npublic class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}\npublic static void main(String[] args){\n    SingletonFour singletonOne = SingletonFour.getInstance();\n}\n```\n\n+ synchronizedvolatilesynchronizedsynchronizednew \n\n**volatile**\n\nsingletonFour = new SingletonFour() \n\n```java\nmemory = allocate();// 1.\nctorInstance(memory);// 2.\nsInstance = memory;// 3.sInstance\n```\n\n23\n\n```java\nmemory = allocate();// 1.\nsInstance = memory;// 2.sInstance\nctorInstance(memory);// 3.\n```\n\nsingletonFour == nullture\n\n#### \n\n```java\npublic class SingletonFive {\n    private SingletonFive(){}\n    //\n    private static class SingletonHolder{\n        private final static SingletonFive sinleton = new SingletonFive();\n    }\n    public static SingletonFive getSingleton(){\n        return SingletonHolder.sinleton;\n    }\n}\npublic static void main(String[] args){\n    SingletonFive singletonOne = SingletonFive.getInstance();\n}\n```\n\n(static)getInstance()SingletonSingletongetInstance()SingletonHolderstaticinstanceJavagetInstance()IoDHJavaIoDH\n\n## \n\n- http://tengj.top/2016/04/06/sjms4singleton/\n\n","source":"_posts/design-pattern-singleton.md","raw":"---\ntitle: \ntags:\n  - \ncategories:  java\ndescription : \ndate: 2019-07-18 10:00:00\n---\n## \n### \n(Singleton Pattern)\n### \n\n- \n- \n- \n\n### \n#### \n```java\npublic class SingletonOne {\n    private static SingletonOne singletonOne;\n    private SingletonOne(){}\n    private static SingletonOne getInstance(){\n        if(singletonOne == null)\n            singletonOne = new SingletonOne();\n        return singletonOne;\n    }\n}\npublic static void main(String[] args){\n    SingletonOne singletonOne = SingletonOne.getInstance();\n}\n```\n<!--more-->\n \n\n- \n\n#### \n\n```java\npublic class SingletonTwo {\n    private static SingletonTwo singletonTwo;\n    private SingletonTwo(){}\n    private synchronized static SingletonTwo getInstance(){\n        if(singletonTwo == null)\n            singletonTwo = new SingletonTwo();\n        return singletonTwo;\n    }\n}\npublic static void main(String[] args){\n    SingletonTwo singletonOne = SingletonTwo.getInstance();\n}\n```\n\nsynchronized\n\n\n\n- synchronized\n\n#### \n\n```java\npublic class SingletonThree {\n    private static SingletonThree singletonThree = new SingletonThree();\n    private SingletonThree(){}\n\n    private static SingletonThree getInstance(){\n        return singletonThree;\n    }\n}\npublic static void main(String[] args){\n    SingletonThree singletonOne = SingletonThree.getInstance();\n}\n```\n\n\n\n- \n- \n\n#### \n\n```java\npublic class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}\npublic static void main(String[] args){\n    SingletonFour singletonOne = SingletonFour.getInstance();\n}\n```\n\n+ synchronizedvolatilesynchronizedsynchronizednew \n\n**volatile**\n\nsingletonFour = new SingletonFour() \n\n```java\nmemory = allocate();// 1.\nctorInstance(memory);// 2.\nsInstance = memory;// 3.sInstance\n```\n\n23\n\n```java\nmemory = allocate();// 1.\nsInstance = memory;// 2.sInstance\nctorInstance(memory);// 3.\n```\n\nsingletonFour == nullture\n\n#### \n\n```java\npublic class SingletonFive {\n    private SingletonFive(){}\n    //\n    private static class SingletonHolder{\n        private final static SingletonFive sinleton = new SingletonFive();\n    }\n    public static SingletonFive getSingleton(){\n        return SingletonHolder.sinleton;\n    }\n}\npublic static void main(String[] args){\n    SingletonFive singletonOne = SingletonFive.getInstance();\n}\n```\n\n(static)getInstance()SingletonSingletongetInstance()SingletonHolderstaticinstanceJavagetInstance()IoDHJavaIoDH\n\n## \n\n- http://tengj.top/2016/04/06/sjms4singleton/\n\n","slug":"design-pattern-singleton","published":1,"updated":"2021-04-08T00:47:06.727Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhue0006qwv2fdat28gv","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Singleton Pattern)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonOne</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonOne singletonOne<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">SingletonOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonOne <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>singletonOne <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            singletonOne <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> singletonOne<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    SingletonOne singletonOne <span class=\"token operator\">=</span> SingletonOne<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<a id=\"more\"></a>\n<p> </p>\n<ul>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonTwo</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonTwo singletonTwo<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">SingletonTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">static</span> SingletonTwo <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>singletonTwo <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            singletonTwo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> singletonTwo<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    SingletonTwo singletonOne <span class=\"token operator\">=</span> SingletonTwo<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>synchronized</p>\n<p></p>\n<ul>\n<li>synchronized</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonThree</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonThree singletonThree <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonThree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">SingletonThree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonThree <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> singletonThree<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    SingletonThree singletonOne <span class=\"token operator\">=</span> SingletonThree<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonFour</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> SingletonFour singletonFour<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">SingletonFour</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> SingletonFour <span class=\"token function\">getSingleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>singletonFour <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>SingletonFour<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>singletonFour <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    singletonFour <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonFour</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// 1</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> singletonFour<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    SingletonFour singletonOne <span class=\"token operator\">=</span> SingletonFour<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>+ synchronizedvolatilesynchronizedsynchronizednew </p>\n<p><strong>volatile</strong></p>\n<p>singletonFour = new SingletonFour() </p>\n<pre class=\" language-java\"><code class=\"language-java\">memory <span class=\"token operator\">=</span> <span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 1.</span>\n<span class=\"token function\">ctorInstance</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 2.</span>\nsInstance <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 3.sInstance</span></code></pre>\n<p>23</p>\n<pre class=\" language-java\"><code class=\"language-java\">memory <span class=\"token operator\">=</span> <span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 1.</span>\nsInstance <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 2.sInstance</span>\n<span class=\"token function\">ctorInstance</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// 3.</span></code></pre>\n<p>singletonFour == nullture</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonFive</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">SingletonFive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SingletonHolder</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">static</span> SingletonFive sinleton <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonFive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> SingletonFive <span class=\"token function\">getSingleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> SingletonHolder<span class=\"token punctuation\">.</span>sinleton<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    SingletonFive singletonOne <span class=\"token operator\">=</span> SingletonFive<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>(static)getInstance()SingletonSingletongetInstance()SingletonHolderstaticinstanceJavagetInstance()IoDHJavaIoDH</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"http://tengj.top/2016/04/06/sjms4singleton/\" target=\"_blank\" rel=\"noopener\">http://tengj.top/2016/04/06/sjms4singleton/</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Singleton Pattern)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public class SingletonOne {\n    private static SingletonOne singletonOne;\n    private SingletonOne(){}\n    private static SingletonOne getInstance(){\n        if(singletonOne == null)\n            singletonOne = new SingletonOne();\n        return singletonOne;\n    }\n}\npublic static void main(String[] args){\n    SingletonOne singletonOne = SingletonOne.getInstance();\n}</code></pre>","more":"<p> </p>\n<ul>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public class SingletonTwo {\n    private static SingletonTwo singletonTwo;\n    private SingletonTwo(){}\n    private synchronized static SingletonTwo getInstance(){\n        if(singletonTwo == null)\n            singletonTwo = new SingletonTwo();\n        return singletonTwo;\n    }\n}\npublic static void main(String[] args){\n    SingletonTwo singletonOne = SingletonTwo.getInstance();\n}</code></pre>\n<p>synchronized</p>\n<p></p>\n<ul>\n<li>synchronized</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public class SingletonThree {\n    private static SingletonThree singletonThree = new SingletonThree();\n    private SingletonThree(){}\n\n    private static SingletonThree getInstance(){\n        return singletonThree;\n    }\n}\npublic static void main(String[] args){\n    SingletonThree singletonOne = SingletonThree.getInstance();\n}</code></pre>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}\npublic static void main(String[] args){\n    SingletonFour singletonOne = SingletonFour.getInstance();\n}</code></pre>\n<p>+ synchronizedvolatilesynchronizedsynchronizednew </p>\n<p><strong>volatile</strong></p>\n<p>singletonFour = new SingletonFour() </p>\n<pre><code class=\"java\">memory = allocate();// 1.\nctorInstance(memory);// 2.\nsInstance = memory;// 3.sInstance</code></pre>\n<p>23</p>\n<pre><code class=\"java\">memory = allocate();// 1.\nsInstance = memory;// 2.sInstance\nctorInstance(memory);// 3.</code></pre>\n<p>singletonFour == nullture</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public class SingletonFive {\n    private SingletonFive(){}\n    //\n    private static class SingletonHolder{\n        private final static SingletonFive sinleton = new SingletonFive();\n    }\n    public static SingletonFive getSingleton(){\n        return SingletonHolder.sinleton;\n    }\n}\npublic static void main(String[] args){\n    SingletonFive singletonOne = SingletonFive.getInstance();\n}</code></pre>\n<p>(static)getInstance()SingletonSingletongetInstance()SingletonHolderstaticinstanceJavagetInstance()IoDHJavaIoDH</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"http://tengj.top/2016/04/06/sjms4singleton/\" target=\"_blank\" rel=\"noopener\">http://tengj.top/2016/04/06/sjms4singleton/</a></li>\n</ul>"},{"title":"GC","description":"GCJVMGCGC","date":"2019-02-18T09:14:00.000Z","_content":"## GC\n\n|                    |                                                      |\n| ---------------------- | ------------------------------------------------------------ |\n| -XX:+PrintGCDetails    | GC                                             |\n| -XX:+PrintGCTimeStamps | GC                           |\n| -XX:+PrintGCDateStamps | GC 2013-05-04T21:53:59.234+0800 |\n| -XX:+PrintHeapAtGC     | GC                                 |\n| -Xloggc:D:/gc.log      |                                            |\n| -XX:+PrintGC           | GC                                                   |\n<!--more-->\n## YGC\n\n### \n\n```properties\n-XX:+PrintGCDetails -XX:+PrintGCDateStamps\n```\n\nGC\n\n```\n2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGen: 33280K->5113K(38400K)] 33280K->5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n```\n\n![](gc-log/1.jpg)\n\n### \n\n```\n2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGenYoung GC: 33280K->5113K(38400K)] 33280K->5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n#GC (Allocation Failure) GC\n```\n\n## FGC\n### \n```properties\n-XX:+PrintGCDetails -XX:+PrintGCDateStamps\n```\nGC\n```\n2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K->0K(143360K)] [ParOldGen: 13088K->13236K(55808K)] 19218K->13236K(199168K), [Metaspace: 20856K->20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]\n```\n![](gc-log/2.jpg)\n\n### \n```\n2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K->0K(143360K)] [ParOldGen: 13088K->13236K(55808K)] 19218K->13236K(199168K), [Metaspace: 20856K->20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]\n```\n## GC\n### \n```java\npublic class TestHandlePromotionFailure {\n    private static final int _1M = 1024 * 1024;\n    /***\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:SurvivorRatio=8 -XX:+UseSerialGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParallelGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC\n     * @param args\n     */\n    public static void main(String[] args){\n        byte[] a1,a2,a3,a4;\n        a1 = new byte[2 * _1M];\n        a2 = new byte[2 * _1M];\n        a3 = new byte[2 * _1M];\n        a4 = new byte[4 * _1M];\n    }\n}\n```\n\n### IDEAGC\n![](gc-log/3.png)\n### \n![](gc-log/4.png)\n","source":"_posts/gc-log.md","raw":"---\ntitle: GC\ntags:\n  - jvm\ncategories: \n  - java\ndescription : GCJVMGCGC\ndate: 2019-02-18 17:14:00\n---\n## GC\n\n|                    |                                                      |\n| ---------------------- | ------------------------------------------------------------ |\n| -XX:+PrintGCDetails    | GC                                             |\n| -XX:+PrintGCTimeStamps | GC                           |\n| -XX:+PrintGCDateStamps | GC 2013-05-04T21:53:59.234+0800 |\n| -XX:+PrintHeapAtGC     | GC                                 |\n| -Xloggc:D:/gc.log      |                                            |\n| -XX:+PrintGC           | GC                                                   |\n<!--more-->\n## YGC\n\n### \n\n```properties\n-XX:+PrintGCDetails -XX:+PrintGCDateStamps\n```\n\nGC\n\n```\n2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGen: 33280K->5113K(38400K)] 33280K->5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n```\n\n![](gc-log/1.jpg)\n\n### \n\n```\n2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGenYoung GC: 33280K->5113K(38400K)] 33280K->5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n#GC (Allocation Failure) GC\n```\n\n## FGC\n### \n```properties\n-XX:+PrintGCDetails -XX:+PrintGCDateStamps\n```\nGC\n```\n2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K->0K(143360K)] [ParOldGen: 13088K->13236K(55808K)] 19218K->13236K(199168K), [Metaspace: 20856K->20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]\n```\n![](gc-log/2.jpg)\n\n### \n```\n2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K->0K(143360K)] [ParOldGen: 13088K->13236K(55808K)] 19218K->13236K(199168K), [Metaspace: 20856K->20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]\n```\n## GC\n### \n```java\npublic class TestHandlePromotionFailure {\n    private static final int _1M = 1024 * 1024;\n    /***\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:SurvivorRatio=8 -XX:+UseSerialGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParallelGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC\n     * @param args\n     */\n    public static void main(String[] args){\n        byte[] a1,a2,a3,a4;\n        a1 = new byte[2 * _1M];\n        a2 = new byte[2 * _1M];\n        a3 = new byte[2 * _1M];\n        a4 = new byte[4 * _1M];\n    }\n}\n```\n\n### IDEAGC\n![](gc-log/3.png)\n### \n![](gc-log/4.png)\n","slug":"gc-log","published":1,"updated":"2021-04-08T00:47:06.737Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhug0007qwv26zbi3n30","content":"<h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-XX:+PrintGCDetails</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-XX:+PrintGCTimeStamps</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-XX:+PrintGCDateStamps</td>\n<td>GC 2013-05-04T21:53:59.234+0800</td>\n</tr>\n<tr>\n<td>-XX:+PrintHeapAtGC</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-Xloggc:D:/gc.log</td>\n<td></td>\n</tr>\n<tr>\n<td>-XX:+PrintGC</td>\n<td>GC</td>\n</tr>\n<tr>\n<td><a id=\"more\"></a></td>\n<td></td>\n</tr>\n<tr>\n<td>## YGC</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token attr-name\">-XX</span><span class=\"token punctuation\">:</span><span class=\"token attr-value\">+PrintGCDetails -XX:+PrintGCDateStamps</span></code></pre>\n<p>GC</p>\n<pre><code>2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGen: 33280K-&gt;5113K(38400K)] 33280K-&gt;5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</code></pre><p><img src=\"/2019/02/18/gc-log/1.jpg\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGenYoung GC: 33280K-&gt;5113K(38400K)] 33280K-&gt;5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n#GC (Allocation Failure) GC</code></pre><h2 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token attr-name\">-XX</span><span class=\"token punctuation\">:</span><span class=\"token attr-value\">+PrintGCDetails -XX:+PrintGCDateStamps</span></code></pre>\n<p>GC</p>\n<pre><code>2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K-&gt;0K(143360K)] [ParOldGen: 13088K-&gt;13236K(55808K)] 19218K-&gt;13236K(199168K), [Metaspace: 20856K-&gt;20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]</code></pre><p><img src=\"/2019/02/18/gc-log/2.jpg\" alt></p>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre><code>2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K-&gt;0K(143360K)] [ParOldGen: 13088K-&gt;13236K(55808K)] 19218K-&gt;13236K(199168K), [Metaspace: 20856K-&gt;20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]</code></pre><h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestHandlePromotionFailure</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> _1M <span class=\"token operator\">=</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:SurvivorRatio=8 -XX:+UseSerialGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParallelGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC\n     * @param args\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> a1<span class=\"token punctuation\">,</span>a2<span class=\"token punctuation\">,</span>a3<span class=\"token punctuation\">,</span>a4<span class=\"token punctuation\">;</span>\n        a1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> _1M<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        a2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> _1M<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        a3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> _1M<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        a4 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> _1M<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"IDEAGC\"><a href=\"#IDEAGC\" class=\"headerlink\" title=\"IDEAGC\"></a>IDEAGC</h3><p><img src=\"/2019/02/18/gc-log/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2019/02/18/gc-log/4.png\" alt></p>\n","site":{"data":{}},"excerpt":"<h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-XX:+PrintGCDetails</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-XX:+PrintGCTimeStamps</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-XX:+PrintGCDateStamps</td>\n<td>GC 2013-05-04T21:53:59.234+0800</td>\n</tr>\n<tr>\n<td>-XX:+PrintHeapAtGC</td>\n<td>GC</td>\n</tr>\n<tr>\n<td>-Xloggc:D:/gc.log</td>\n<td></td>\n</tr>\n<tr>\n<td>-XX:+PrintGC</td>\n<td>GC</td>\n</tr>\n<tr>\n<td></td></tr></tbody></table>","more":"\n<td></td>\n\n<tr>\n<td>## YGC</td>\n<td></td>\n</tr>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"properties\">-XX:+PrintGCDetails -XX:+PrintGCDateStamps</code></pre>\n<p>GC</p>\n<pre><code>2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGen: 33280K-&gt;5113K(38400K)] 33280K-&gt;5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</code></pre><p><img src=\"/2019/02/18/gc-log/1.jpg\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>2019-04-18T14:52:06.790+0800: 2.653: [GC (Allocation Failure) [PSYoungGenYoung GC: 33280K-&gt;5113K(38400K)] 33280K-&gt;5848K(125952K), 0.0095764 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]\n#GC (Allocation Failure) GC</code></pre><h2 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"properties\">-XX:+PrintGCDetails -XX:+PrintGCDateStamps</code></pre>\n<p>GC</p>\n<pre><code>2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K-&gt;0K(143360K)] [ParOldGen: 13088K-&gt;13236K(55808K)] 19218K-&gt;13236K(199168K), [Metaspace: 20856K-&gt;20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]</code></pre><p><img src=\"/2019/02/18/gc-log/2.jpg\" alt></p>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre><code>2019-04-18T14:52:15.359+0800: 11.222: [Full GC (Metadata GC Threshold) [PSYoungGen: 6129K-&gt;0K(143360K)] [ParOldGen: 13088K-&gt;13236K(55808K)] 19218K-&gt;13236K(199168K), [Metaspace: 20856K-&gt;20856K(1069056K)], 0.1216713 secs] [Times: user=0.44 sys=0.02, real=0.12 secs]</code></pre><h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">public class TestHandlePromotionFailure {\n    private static final int _1M = 1024 * 1024;\n    /***\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:SurvivorRatio=8 -XX:+UseSerialGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParallelGC\n     * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC\n     * @param args\n     */\n    public static void main(String[] args){\n        byte[] a1,a2,a3,a4;\n        a1 = new byte[2 * _1M];\n        a2 = new byte[2 * _1M];\n        a3 = new byte[2 * _1M];\n        a4 = new byte[4 * _1M];\n    }\n}</code></pre>\n<h3 id=\"IDEAGC\"><a href=\"#IDEAGC\" class=\"headerlink\" title=\"IDEAGC\"></a>IDEAGC</h3><p><img src=\"/2019/02/18/gc-log/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2019/02/18/gc-log/4.png\" alt></p>"},{"title":"Fork/join","description":"Fork/join","date":"2020-07-30T08:35:57.000Z","_content":"## Fork/Join\n\n### \n\nFork/JoinJava 7Fork/Join\n- Fork/Join\n- \n\n### \n\nForkJoinPool  ExecutorService ExecutorService FokJoinPool<font color=red></font>\n<!--more-->\n## Fork/Join\n\nFork/JoinForkJoinforkjoinForkJoinTaskFork/Join:\n\n- RecursiveAction \n- RecursiveTask \n\n### \n\n\n\n```java\n@Test\npublic void test() {\n    long[] numbers = LongStream.rangeClosed(1, 5263).toArray();\n    ForkJoinTask<Long> task = new ForkJoinSumCalculator(numbers);\n    long start = System.currentTimeMillis();\n    long result = new ForkJoinPool().invoke(task);\n    System.out.println(\" = \" + result  + \",  = \" + (System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n```java\nimport java.util.concurrent.RecursiveTask;\n\npublic class ForkJoinSumCalculator extends RecursiveTask<Long> {\n    //\n    public static final long THRESHOLD = 100;\n    private final long[] numbers;\n    private final int start; //\n    private final int end; //\n    public ForkJoinSumCalculator(long[] numbers) {\n        this(numbers, 0, numbers.length);\n    }\n    private ForkJoinSumCalculator(long[] numbers, int start, int end) {\n        this.numbers = numbers;\n        this.start = start;\n        this.end = end;\n    }\n\n    @Override\n    protected Long compute() {\n        int length = end - start;\n        if (length <= THRESHOLD) {\n            return computeSequentially();\n        }\n        ForkJoinSumCalculator leftTask = new ForkJoinSumCalculator(numbers,start,start + length / 2);\n        ForkJoinSumCalculator rightTask = new ForkJoinSumCalculator(numbers, start + length/2, end);\n        invokeAll(leftTask,rightTask);\n        Long rightResult = rightTask.join();\n        Long leftResult = leftTask.join();\n        return leftResult + rightResult;\n    }\n\n    /**\n        \n    */\n    private long computeSequentially() {\n        long sum = 0;\n        for (int i = start; i < end; i++) {\n            sum += numbers[i];\n        }\n        return sum;\n    }\n}\n```\n\n### \n\n\n\n```java\n@Test\npublic void test4() {\n    int MAX = 10000;\n    int inits[] = new int[MAX];\n    for (int i = 0; i < inits.length; i++) {\n        inits[i] = RandomUtils.nextInt(0, MAX);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinArraySortTask task = new ForkJoinArraySortTask(inits);\n    int[] result = pool.invoke(task);\n    //\n    Arrays.stream(result).forEach(System.out::println);\n}\n```\n\n```java\npublic class ForkJoinArraySortTask extends RecursiveTask<int[]> {\n    private int source[];\n\n    public ForkJoinArraySortTask(int[] source) {\n        this.source = source;\n    }\n\n    @Override\n    protected int[] compute() {\n        int sourceSize = source.length;\n        // \n        if (sourceSize > 10) {\n            int midIndex = sourceSize / 2;\n            //\n            ForkJoinArraySortTask leftTask = new ForkJoinArraySortTask(Arrays.copyOf(source, midIndex));\n            ForkJoinArraySortTask rightTask = new ForkJoinArraySortTask(Arrays.copyOfRange(source, midIndex, sourceSize));\n            invokeAll(leftTask,rightTask);\n            int result1[] = leftTask.join();\n            int result2[] = rightTask.join();\n            int mer[] = joinInts(result1, result2);\n            return mer;\n        } else {\n            //\n            return Arrays.stream(source).sorted().toArray();\n        }\n    }\n\n    /***\n     * \n     * @param result1\n     * @param result2\n     * @return\n     */\n    private int[] joinInts(int[] result1, int[] result2) {\n        //\n        int[] array = ArrayUtils.addAll(result1,result2);\n        //\n        return Arrays.stream(array).sorted().toArray();\n    }\n}\n```\n\n### Map10\n\nMapFork/joinvalue+10\n\n```java\n@Test\npublic void test6(){\n    Map<String, Integer> myMap = Maps.newHashMap();\n    for (int i = 0; i < 526252; i++) {\n        myMap.put(String.valueOf(i), 1);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinMapDoTask forkJoinMapDoTask = new ForkJoinMapDoTask(myMap);\n    Map<String, Integer> invoke = pool.invoke(forkJoinMapDoTask);\n    System.out.println(invoke.keySet().size());\n    for(Map.Entry<String,Integer> entry : invoke.entrySet()){\n        if(entry.getValue() != 11){\n            System.out.println(\"\");\n        }\n    }\n}\n```\n\n```java\n/***\n * Map10\n */\npublic class ForkJoinMapDoTask extends RecursiveTask<Map<String, Integer>> {\n\n    private static final int TASK_COUNT = 5000; //5000\n\n    private Map<String, Integer> myMap;\n\n    public ForkJoinMapDoTask(Map<String, Integer> myMap) {\n        this.myMap = myMap;\n    }\n\n\n    @Override\n    protected Map<String, Integer> compute() {\n\n        if (myMap.keySet().size() <= TASK_COUNT) {\n            Map<String, Integer> resultMap = Maps.newHashMap();\n            for (Map.Entry<String, Integer> entry : myMap.entrySet()) {\n                resultMap.put(entry.getKey(), entry.getValue() + 10);\n            }\n            return resultMap;\n        } else {\n            List<Map<String,Integer>> mapList = ForkJoinMapDoTask.mapChunk(myMap,2);\n            ForkJoinMapDoTask leftTask = new ForkJoinMapDoTask(mapList.get(0));\n            ForkJoinMapDoTask rightTask = new ForkJoinMapDoTask(mapList.get(1));\n            invokeAll(leftTask,rightTask);\n            Map<String, Integer> lfetMap = leftTask.join();\n            Map<String, Integer> rightMap = rightTask.join();\n            Map<String, Integer> resultMap = Maps.newHashMap();\n            resultMap.putAll(lfetMap);\n            resultMap.putAll(rightMap);\n            return resultMap;\n        }\n    }\n\n\n    public static <k, v> List<Map<k, v>> mapChunk(Map<k, v> chunkMap, int batch) {\n        List<Map<k,v>> resultList = Lists.newArrayList();\n        if(MapUtils.isEmpty(chunkMap)){\n            return Lists.newArrayList();\n        }\n        int keyLength = chunkMap.keySet().size();\n        int pageSize = keyLength % batch == 0 ? (keyLength / batch) : (keyLength / batch + 1);\n        //\n        for(int i = 0 ; i < batch; i ++){\n            resultList.add(Maps.newHashMap());\n        }\n        int i = 0, count = 0;\n        for(Map.Entry<k,v> entry : chunkMap.entrySet()){\n            resultList.get(i).put(entry.getKey(),entry.getValue());\n            count++;\n            if(count % pageSize == 0){\n                i++;\n            }\n        }\n        return resultList;\n    }\n}\n```\n\n### Fork/Join\n\nForkJoinPoolForkJoinTaskForkJoinWorkerThreadForkJoinTaskForkJoinPoolForkJoinWorkerThread;\n\n#### ForkJoinTaskfork\n\nForkJoinTaskforkForkJoinWorkerThreadpushTaskworkQueue\n\n```java\npublic final ForkJoinTask<V> fork() {\n    Thread t;\n    if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)\n        ((ForkJoinWorkerThread)t).workQueue.push(this);\n    else\n        ForkJoinPool.common.externalPush(this);\n    return this;\n}\n```\n\npushTaskForkJoinTaskForkJoinPoolsignalWork()\n\n```java\nfinal void push(ForkJoinTask<?> task) {\n    ForkJoinTask<?>[] a; ForkJoinPool p;\n    int b = base, s = top, n;\n    if ((a = array) != null) {    // ignore if queue removed\n        int m = a.length - 1;     // fenced write for task visibility\n        U.putOrderedObject(a, ((m & s) << ASHIFT) + ABASE, task);\n        U.putOrderedInt(this, QTOP, s + 1);\n        if ((n = s - b) <= 1) {\n            if ((p = pool) != null)\n                p.signalWork(p.workQueues, this);\n        }\n        else if (n >= m)\n            growArray();\n    }\n}\n```\n\n#### ForkJoinTaskjoin\n\noinForkJoinTaskjoin\n\n```java\npublic final V join() {\n\tint s;\n    if ((s = doJoin() & DONE_MASK) != NORMAL){\n    \treportException(s);\n    }\n    return getRawResult();\n}\n```\n\ndoJoindoJoin()4NORMALCANCELLEDSIGNALEXCEPTIONAL\n\nCancellationException\n\ndoJoin\n\n```java\nprivate int doJoin() {\n\tint s;\n\tThread t;\n\tForkJoinWorkerThread wt;\n\tForkJoinPool.WorkQueue w;\n    return (s = status) < 0 ? s :\n            ((t = Thread.currentThread()) instanceof \t\t\t\t\t\t\t\tForkJoinWorkerThread) ? (w = (wt = \t\t\t\t\t\t\t\t\t\t(ForkJoinWorkerThread)t).workQueue).tryUnpush(this) && (s = \t\t\t\tdoExec()) < 0 ? s : wt.pool.awaitJoin(w, this, 0L) : \t\t\t\texternalAwaitDone();\n}\n```\n\ndoExec() :\n\n```java\nfinal int doExec() {\n\tint s; \n\tboolean completed;\n\tif ((s = status) >= 0) {\n\t\ttry {\n\t\t\tcompleted = exec();\n\t\t} catch (Throwable rex) {\n\t\t\treturn setExceptionalCompletion(rex);\n\t\t}\n\t\tif (completed){\n\t\t\ts = setCompletion(NORMAL);\n\t\t}\n\t}\n\treturn s;\n}\n```\n\ndoJoin()NORMALEXCEPTIONAL","source":"_posts/fork-join.md","raw":"---\ntitle: Fork/join\ntags:\n  - java\ncategories:  java\ndescription : Fork/join\ndate: 2020-07-30 16:35:57\n---\n## Fork/Join\n\n### \n\nFork/JoinJava 7Fork/Join\n- Fork/Join\n- \n\n### \n\nForkJoinPool  ExecutorService ExecutorService FokJoinPool<font color=red></font>\n<!--more-->\n## Fork/Join\n\nFork/JoinForkJoinforkjoinForkJoinTaskFork/Join:\n\n- RecursiveAction \n- RecursiveTask \n\n### \n\n\n\n```java\n@Test\npublic void test() {\n    long[] numbers = LongStream.rangeClosed(1, 5263).toArray();\n    ForkJoinTask<Long> task = new ForkJoinSumCalculator(numbers);\n    long start = System.currentTimeMillis();\n    long result = new ForkJoinPool().invoke(task);\n    System.out.println(\" = \" + result  + \",  = \" + (System.currentTimeMillis() - start) + \" ms\");\n}\n```\n\n```java\nimport java.util.concurrent.RecursiveTask;\n\npublic class ForkJoinSumCalculator extends RecursiveTask<Long> {\n    //\n    public static final long THRESHOLD = 100;\n    private final long[] numbers;\n    private final int start; //\n    private final int end; //\n    public ForkJoinSumCalculator(long[] numbers) {\n        this(numbers, 0, numbers.length);\n    }\n    private ForkJoinSumCalculator(long[] numbers, int start, int end) {\n        this.numbers = numbers;\n        this.start = start;\n        this.end = end;\n    }\n\n    @Override\n    protected Long compute() {\n        int length = end - start;\n        if (length <= THRESHOLD) {\n            return computeSequentially();\n        }\n        ForkJoinSumCalculator leftTask = new ForkJoinSumCalculator(numbers,start,start + length / 2);\n        ForkJoinSumCalculator rightTask = new ForkJoinSumCalculator(numbers, start + length/2, end);\n        invokeAll(leftTask,rightTask);\n        Long rightResult = rightTask.join();\n        Long leftResult = leftTask.join();\n        return leftResult + rightResult;\n    }\n\n    /**\n        \n    */\n    private long computeSequentially() {\n        long sum = 0;\n        for (int i = start; i < end; i++) {\n            sum += numbers[i];\n        }\n        return sum;\n    }\n}\n```\n\n### \n\n\n\n```java\n@Test\npublic void test4() {\n    int MAX = 10000;\n    int inits[] = new int[MAX];\n    for (int i = 0; i < inits.length; i++) {\n        inits[i] = RandomUtils.nextInt(0, MAX);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinArraySortTask task = new ForkJoinArraySortTask(inits);\n    int[] result = pool.invoke(task);\n    //\n    Arrays.stream(result).forEach(System.out::println);\n}\n```\n\n```java\npublic class ForkJoinArraySortTask extends RecursiveTask<int[]> {\n    private int source[];\n\n    public ForkJoinArraySortTask(int[] source) {\n        this.source = source;\n    }\n\n    @Override\n    protected int[] compute() {\n        int sourceSize = source.length;\n        // \n        if (sourceSize > 10) {\n            int midIndex = sourceSize / 2;\n            //\n            ForkJoinArraySortTask leftTask = new ForkJoinArraySortTask(Arrays.copyOf(source, midIndex));\n            ForkJoinArraySortTask rightTask = new ForkJoinArraySortTask(Arrays.copyOfRange(source, midIndex, sourceSize));\n            invokeAll(leftTask,rightTask);\n            int result1[] = leftTask.join();\n            int result2[] = rightTask.join();\n            int mer[] = joinInts(result1, result2);\n            return mer;\n        } else {\n            //\n            return Arrays.stream(source).sorted().toArray();\n        }\n    }\n\n    /***\n     * \n     * @param result1\n     * @param result2\n     * @return\n     */\n    private int[] joinInts(int[] result1, int[] result2) {\n        //\n        int[] array = ArrayUtils.addAll(result1,result2);\n        //\n        return Arrays.stream(array).sorted().toArray();\n    }\n}\n```\n\n### Map10\n\nMapFork/joinvalue+10\n\n```java\n@Test\npublic void test6(){\n    Map<String, Integer> myMap = Maps.newHashMap();\n    for (int i = 0; i < 526252; i++) {\n        myMap.put(String.valueOf(i), 1);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinMapDoTask forkJoinMapDoTask = new ForkJoinMapDoTask(myMap);\n    Map<String, Integer> invoke = pool.invoke(forkJoinMapDoTask);\n    System.out.println(invoke.keySet().size());\n    for(Map.Entry<String,Integer> entry : invoke.entrySet()){\n        if(entry.getValue() != 11){\n            System.out.println(\"\");\n        }\n    }\n}\n```\n\n```java\n/***\n * Map10\n */\npublic class ForkJoinMapDoTask extends RecursiveTask<Map<String, Integer>> {\n\n    private static final int TASK_COUNT = 5000; //5000\n\n    private Map<String, Integer> myMap;\n\n    public ForkJoinMapDoTask(Map<String, Integer> myMap) {\n        this.myMap = myMap;\n    }\n\n\n    @Override\n    protected Map<String, Integer> compute() {\n\n        if (myMap.keySet().size() <= TASK_COUNT) {\n            Map<String, Integer> resultMap = Maps.newHashMap();\n            for (Map.Entry<String, Integer> entry : myMap.entrySet()) {\n                resultMap.put(entry.getKey(), entry.getValue() + 10);\n            }\n            return resultMap;\n        } else {\n            List<Map<String,Integer>> mapList = ForkJoinMapDoTask.mapChunk(myMap,2);\n            ForkJoinMapDoTask leftTask = new ForkJoinMapDoTask(mapList.get(0));\n            ForkJoinMapDoTask rightTask = new ForkJoinMapDoTask(mapList.get(1));\n            invokeAll(leftTask,rightTask);\n            Map<String, Integer> lfetMap = leftTask.join();\n            Map<String, Integer> rightMap = rightTask.join();\n            Map<String, Integer> resultMap = Maps.newHashMap();\n            resultMap.putAll(lfetMap);\n            resultMap.putAll(rightMap);\n            return resultMap;\n        }\n    }\n\n\n    public static <k, v> List<Map<k, v>> mapChunk(Map<k, v> chunkMap, int batch) {\n        List<Map<k,v>> resultList = Lists.newArrayList();\n        if(MapUtils.isEmpty(chunkMap)){\n            return Lists.newArrayList();\n        }\n        int keyLength = chunkMap.keySet().size();\n        int pageSize = keyLength % batch == 0 ? (keyLength / batch) : (keyLength / batch + 1);\n        //\n        for(int i = 0 ; i < batch; i ++){\n            resultList.add(Maps.newHashMap());\n        }\n        int i = 0, count = 0;\n        for(Map.Entry<k,v> entry : chunkMap.entrySet()){\n            resultList.get(i).put(entry.getKey(),entry.getValue());\n            count++;\n            if(count % pageSize == 0){\n                i++;\n            }\n        }\n        return resultList;\n    }\n}\n```\n\n### Fork/Join\n\nForkJoinPoolForkJoinTaskForkJoinWorkerThreadForkJoinTaskForkJoinPoolForkJoinWorkerThread;\n\n#### ForkJoinTaskfork\n\nForkJoinTaskforkForkJoinWorkerThreadpushTaskworkQueue\n\n```java\npublic final ForkJoinTask<V> fork() {\n    Thread t;\n    if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)\n        ((ForkJoinWorkerThread)t).workQueue.push(this);\n    else\n        ForkJoinPool.common.externalPush(this);\n    return this;\n}\n```\n\npushTaskForkJoinTaskForkJoinPoolsignalWork()\n\n```java\nfinal void push(ForkJoinTask<?> task) {\n    ForkJoinTask<?>[] a; ForkJoinPool p;\n    int b = base, s = top, n;\n    if ((a = array) != null) {    // ignore if queue removed\n        int m = a.length - 1;     // fenced write for task visibility\n        U.putOrderedObject(a, ((m & s) << ASHIFT) + ABASE, task);\n        U.putOrderedInt(this, QTOP, s + 1);\n        if ((n = s - b) <= 1) {\n            if ((p = pool) != null)\n                p.signalWork(p.workQueues, this);\n        }\n        else if (n >= m)\n            growArray();\n    }\n}\n```\n\n#### ForkJoinTaskjoin\n\noinForkJoinTaskjoin\n\n```java\npublic final V join() {\n\tint s;\n    if ((s = doJoin() & DONE_MASK) != NORMAL){\n    \treportException(s);\n    }\n    return getRawResult();\n}\n```\n\ndoJoindoJoin()4NORMALCANCELLEDSIGNALEXCEPTIONAL\n\nCancellationException\n\ndoJoin\n\n```java\nprivate int doJoin() {\n\tint s;\n\tThread t;\n\tForkJoinWorkerThread wt;\n\tForkJoinPool.WorkQueue w;\n    return (s = status) < 0 ? s :\n            ((t = Thread.currentThread()) instanceof \t\t\t\t\t\t\t\tForkJoinWorkerThread) ? (w = (wt = \t\t\t\t\t\t\t\t\t\t(ForkJoinWorkerThread)t).workQueue).tryUnpush(this) && (s = \t\t\t\tdoExec()) < 0 ? s : wt.pool.awaitJoin(w, this, 0L) : \t\t\t\texternalAwaitDone();\n}\n```\n\ndoExec() :\n\n```java\nfinal int doExec() {\n\tint s; \n\tboolean completed;\n\tif ((s = status) >= 0) {\n\t\ttry {\n\t\t\tcompleted = exec();\n\t\t} catch (Throwable rex) {\n\t\t\treturn setExceptionalCompletion(rex);\n\t\t}\n\t\tif (completed){\n\t\t\ts = setCompletion(NORMAL);\n\t\t}\n\t}\n\treturn s;\n}\n```\n\ndoJoin()NORMALEXCEPTIONAL","slug":"fork-join","published":1,"updated":"2021-04-08T00:47:06.727Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhul000bqwv28px8gnnq","content":"<h2 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Fork/JoinJava 7Fork/Join</p>\n<ul>\n<li>Fork/Join</li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ForkJoinPool  ExecutorService ExecutorService FokJoinPool<font color=\"red\"></font></p>\n<a id=\"more\"></a>\n<h2 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h2><p>Fork/JoinForkJoinforkjoinForkJoinTaskFork/Join:</p>\n<ul>\n<li>RecursiveAction </li>\n<li>RecursiveTask </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> numbers <span class=\"token operator\">=</span> LongStream<span class=\"token punctuation\">.</span><span class=\"token function\">rangeClosed</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5263</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ForkJoinTask<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> task <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinSumCalculator</span><span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" = \"</span> <span class=\"token operator\">+</span> result  <span class=\"token operator\">+</span> <span class=\"token string\">\",  = \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>RecursiveTask<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ForkJoinSumCalculator</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RecursiveTask</span><span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> THRESHOLD <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> numbers<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> start<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> end<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ForkJoinSumCalculator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> numbers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> numbers<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function\">ForkJoinSumCalculator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> numbers<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> end<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>numbers <span class=\"token operator\">=</span> numbers<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>start <span class=\"token operator\">=</span> start<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>end <span class=\"token operator\">=</span> end<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> Long <span class=\"token function\">compute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> end <span class=\"token operator\">-</span> start<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>length <span class=\"token operator\">&lt;=</span> THRESHOLD<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">computeSequentially</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        ForkJoinSumCalculator leftTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinSumCalculator</span><span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">,</span>start<span class=\"token punctuation\">,</span>start <span class=\"token operator\">+</span> length <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ForkJoinSumCalculator rightTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinSumCalculator</span><span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">,</span> start <span class=\"token operator\">+</span> length<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">invokeAll</span><span class=\"token punctuation\">(</span>leftTask<span class=\"token punctuation\">,</span>rightTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Long rightResult <span class=\"token operator\">=</span> rightTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Long leftResult <span class=\"token operator\">=</span> leftTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> leftResult <span class=\"token operator\">+</span> rightResult<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/**\n        \n    */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> <span class=\"token function\">computeSequentially</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">long</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> start<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> end<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            sum <span class=\"token operator\">+=</span> numbers<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> sum<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> MAX <span class=\"token operator\">=</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> inits<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">int</span><span class=\"token punctuation\">[</span>MAX<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> inits<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        inits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> RandomUtils<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    ForkJoinPool pool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ForkJoinArraySortTask task <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinArraySortTask</span><span class=\"token punctuation\">(</span>inits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> result <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span>out<span class=\"token operator\">:</span><span class=\"token operator\">:</span>println<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ForkJoinArraySortTask</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RecursiveTask</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> source<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ForkJoinArraySortTask</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> source<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>source <span class=\"token operator\">=</span> source<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">compute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> sourceSize <span class=\"token operator\">=</span> source<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// </span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sourceSize <span class=\"token operator\">></span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> midIndex <span class=\"token operator\">=</span> sourceSize <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            ForkJoinArraySortTask leftTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinArraySortTask</span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">copyOf</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> midIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ForkJoinArraySortTask rightTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinArraySortTask</span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">copyOfRange</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> midIndex<span class=\"token punctuation\">,</span> sourceSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">invokeAll</span><span class=\"token punctuation\">(</span>leftTask<span class=\"token punctuation\">,</span>rightTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> result1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> leftTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> result2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rightTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">int</span> mer<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">joinInts</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">,</span> result2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> mer<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">return</span> Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @param result1\n     * @param result2\n     * @return\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">joinInts</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> result1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> result2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> array <span class=\"token operator\">=</span> ArrayUtils<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">,</span>result2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">return</span> Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"Map10\"><a href=\"#Map10\" class=\"headerlink\" title=\"Map10\"></a>Map10</h3><p>MapFork/joinvalue+10</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> myMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">526252</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        myMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    ForkJoinPool pool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ForkJoinMapDoTask forkJoinMapDoTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinMapDoTask</span><span class=\"token punctuation\">(</span>myMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> invoke <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>forkJoinMapDoTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>invoke<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>Map<span class=\"token punctuation\">.</span>Entry<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>Integer<span class=\"token operator\">></span> entry <span class=\"token operator\">:</span> invoke<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">/***\n * Map10\n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ForkJoinMapDoTask</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RecursiveTask</span><span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> TASK_COUNT <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//5000</span>\n\n    <span class=\"token keyword\">private</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> myMap<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ForkJoinMapDoTask</span><span class=\"token punctuation\">(</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> myMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>myMap <span class=\"token operator\">=</span> myMap<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> <span class=\"token function\">compute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>myMap<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> TASK_COUNT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> resultMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Map<span class=\"token punctuation\">.</span>Entry<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> entry <span class=\"token operator\">:</span> myMap<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> resultMap<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>Integer<span class=\"token operator\">>></span> mapList <span class=\"token operator\">=</span> ForkJoinMapDoTask<span class=\"token punctuation\">.</span><span class=\"token function\">mapChunk</span><span class=\"token punctuation\">(</span>myMap<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ForkJoinMapDoTask leftTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinMapDoTask</span><span class=\"token punctuation\">(</span>mapList<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ForkJoinMapDoTask rightTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForkJoinMapDoTask</span><span class=\"token punctuation\">(</span>mapList<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">invokeAll</span><span class=\"token punctuation\">(</span>leftTask<span class=\"token punctuation\">,</span>rightTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> lfetMap <span class=\"token operator\">=</span> leftTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> rightMap <span class=\"token operator\">=</span> rightTask<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Integer<span class=\"token operator\">></span> resultMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span>lfetMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span>rightMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> resultMap<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token operator\">&lt;</span>k<span class=\"token punctuation\">,</span> v<span class=\"token operator\">></span> List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>k<span class=\"token punctuation\">,</span> v<span class=\"token operator\">>></span> <span class=\"token function\">mapChunk</span><span class=\"token punctuation\">(</span>Map<span class=\"token operator\">&lt;</span>k<span class=\"token punctuation\">,</span> v<span class=\"token operator\">></span> chunkMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> batch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token operator\">>></span> resultList <span class=\"token operator\">=</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>MapUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>chunkMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">int</span> keyLength <span class=\"token operator\">=</span> chunkMap<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> pageSize <span class=\"token operator\">=</span> keyLength <span class=\"token operator\">%</span> batch <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>keyLength <span class=\"token operator\">/</span> batch<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>keyLength <span class=\"token operator\">/</span> batch <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> batch<span class=\"token punctuation\">;</span> i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            resultList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>Map<span class=\"token punctuation\">.</span>Entry<span class=\"token operator\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token operator\">></span> entry <span class=\"token operator\">:</span> chunkMap<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            resultList<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">%</span> pageSize <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> resultList<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h3><p>ForkJoinPoolForkJoinTaskForkJoinWorkerThreadForkJoinTaskForkJoinPoolForkJoinWorkerThread;</p>\n<h4 id=\"ForkJoinTaskfork\"><a href=\"#ForkJoinTaskfork\" class=\"headerlink\" title=\"ForkJoinTaskfork\"></a>ForkJoinTaskfork</h4><p>ForkJoinTaskforkForkJoinWorkerThreadpushTaskworkQueue</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> ForkJoinTask<span class=\"token operator\">&lt;</span>V<span class=\"token operator\">></span> <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Thread t<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ForkJoinWorkerThread</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ForkJoinWorkerThread<span class=\"token punctuation\">)</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span>\n        ForkJoinPool<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span><span class=\"token function\">externalPush</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>pushTaskForkJoinTaskForkJoinPoolsignalWork()</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>ForkJoinTask<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ForkJoinTask<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> a<span class=\"token punctuation\">;</span> ForkJoinPool p<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> base<span class=\"token punctuation\">,</span> s <span class=\"token operator\">=</span> top<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">=</span> array<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    <span class=\"token comment\" spellcheck=\"true\">// ignore if queue removed</span>\n        <span class=\"token keyword\">int</span> m <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\" spellcheck=\"true\">// fenced write for task visibility</span>\n        U<span class=\"token punctuation\">.</span><span class=\"token function\">putOrderedObject</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m <span class=\"token operator\">&amp;</span> s<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> ASHIFT<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> ABASE<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        U<span class=\"token punctuation\">.</span><span class=\"token function\">putOrderedInt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> QTOP<span class=\"token punctuation\">,</span> s <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=</span> s <span class=\"token operator\">-</span> b<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n                p<span class=\"token punctuation\">.</span><span class=\"token function\">signalWork</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>workQueues<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">>=</span> m<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">growArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"ForkJoinTaskjoin\"><a href=\"#ForkJoinTaskjoin\" class=\"headerlink\" title=\"ForkJoinTaskjoin\"></a>ForkJoinTaskjoin</h4><p>oinForkJoinTaskjoin</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> V <span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> s<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">=</span> <span class=\"token function\">doJoin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> DONE_MASK<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> NORMAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reportException</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getRawResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>doJoindoJoin()4NORMALCANCELLEDSIGNALEXCEPTIONAL<br><br>CancellationException<br><br>doJoin</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> <span class=\"token function\">doJoin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> s<span class=\"token punctuation\">;</span>\n    Thread t<span class=\"token punctuation\">;</span>\n    ForkJoinWorkerThread wt<span class=\"token punctuation\">;</span>\n    ForkJoinPool<span class=\"token punctuation\">.</span>WorkQueue w<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">=</span> status<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> s <span class=\"token operator\">:</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">instanceof</span>                                 <span class=\"token class-name\">ForkJoinWorkerThread</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wt <span class=\"token operator\">=</span>                                         <span class=\"token punctuation\">(</span>ForkJoinWorkerThread<span class=\"token punctuation\">)</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>workQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">tryUnpush</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">=</span>                 <span class=\"token function\">doExec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> s <span class=\"token operator\">:</span> wt<span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span><span class=\"token function\">awaitJoin</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> 0L<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>                 <span class=\"token function\">externalAwaitDone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>doExec() :</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">doExec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> s<span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">boolean</span> completed<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">=</span> status<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            completed <span class=\"token operator\">=</span> <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> rex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">setExceptionalCompletion</span><span class=\"token punctuation\">(</span>rex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>completed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            s <span class=\"token operator\">=</span> <span class=\"token function\">setCompletion</span><span class=\"token punctuation\">(</span>NORMAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>doJoin()NORMALEXCEPTIONAL</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Fork/JoinJava 7Fork/Join</p>\n<ul>\n<li>Fork/Join</li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ForkJoinPool  ExecutorService ExecutorService FokJoinPool<font color=\"red\"></font></p>","more":"<h2 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h2><p>Fork/JoinForkJoinforkjoinForkJoinTaskFork/Join:</p>\n<ul>\n<li>RecursiveAction </li>\n<li>RecursiveTask </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"java\">@Test\npublic void test() {\n    long[] numbers = LongStream.rangeClosed(1, 5263).toArray();\n    ForkJoinTask&lt;Long&gt; task = new ForkJoinSumCalculator(numbers);\n    long start = System.currentTimeMillis();\n    long result = new ForkJoinPool().invoke(task);\n    System.out.println(&quot; = &quot; + result  + &quot;,  = &quot; + (System.currentTimeMillis() - start) + &quot; ms&quot;);\n}</code></pre>\n<pre><code class=\"java\">import java.util.concurrent.RecursiveTask;\n\npublic class ForkJoinSumCalculator extends RecursiveTask&lt;Long&gt; {\n    //\n    public static final long THRESHOLD = 100;\n    private final long[] numbers;\n    private final int start; //\n    private final int end; //\n    public ForkJoinSumCalculator(long[] numbers) {\n        this(numbers, 0, numbers.length);\n    }\n    private ForkJoinSumCalculator(long[] numbers, int start, int end) {\n        this.numbers = numbers;\n        this.start = start;\n        this.end = end;\n    }\n\n    @Override\n    protected Long compute() {\n        int length = end - start;\n        if (length &lt;= THRESHOLD) {\n            return computeSequentially();\n        }\n        ForkJoinSumCalculator leftTask = new ForkJoinSumCalculator(numbers,start,start + length / 2);\n        ForkJoinSumCalculator rightTask = new ForkJoinSumCalculator(numbers, start + length/2, end);\n        invokeAll(leftTask,rightTask);\n        Long rightResult = rightTask.join();\n        Long leftResult = leftTask.join();\n        return leftResult + rightResult;\n    }\n\n    /**\n        \n    */\n    private long computeSequentially() {\n        long sum = 0;\n        for (int i = start; i &lt; end; i++) {\n            sum += numbers[i];\n        }\n        return sum;\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"java\">@Test\npublic void test4() {\n    int MAX = 10000;\n    int inits[] = new int[MAX];\n    for (int i = 0; i &lt; inits.length; i++) {\n        inits[i] = RandomUtils.nextInt(0, MAX);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinArraySortTask task = new ForkJoinArraySortTask(inits);\n    int[] result = pool.invoke(task);\n    //\n    Arrays.stream(result).forEach(System.out::println);\n}</code></pre>\n<pre><code class=\"java\">public class ForkJoinArraySortTask extends RecursiveTask&lt;int[]&gt; {\n    private int source[];\n\n    public ForkJoinArraySortTask(int[] source) {\n        this.source = source;\n    }\n\n    @Override\n    protected int[] compute() {\n        int sourceSize = source.length;\n        // \n        if (sourceSize &gt; 10) {\n            int midIndex = sourceSize / 2;\n            //\n            ForkJoinArraySortTask leftTask = new ForkJoinArraySortTask(Arrays.copyOf(source, midIndex));\n            ForkJoinArraySortTask rightTask = new ForkJoinArraySortTask(Arrays.copyOfRange(source, midIndex, sourceSize));\n            invokeAll(leftTask,rightTask);\n            int result1[] = leftTask.join();\n            int result2[] = rightTask.join();\n            int mer[] = joinInts(result1, result2);\n            return mer;\n        } else {\n            //\n            return Arrays.stream(source).sorted().toArray();\n        }\n    }\n\n    /***\n     * \n     * @param result1\n     * @param result2\n     * @return\n     */\n    private int[] joinInts(int[] result1, int[] result2) {\n        //\n        int[] array = ArrayUtils.addAll(result1,result2);\n        //\n        return Arrays.stream(array).sorted().toArray();\n    }\n}</code></pre>\n<h3 id=\"Map10\"><a href=\"#Map10\" class=\"headerlink\" title=\"Map10\"></a>Map10</h3><p>MapFork/joinvalue+10</p>\n<pre><code class=\"java\">@Test\npublic void test6(){\n    Map&lt;String, Integer&gt; myMap = Maps.newHashMap();\n    for (int i = 0; i &lt; 526252; i++) {\n        myMap.put(String.valueOf(i), 1);\n    }\n    ForkJoinPool pool = new ForkJoinPool();\n    ForkJoinMapDoTask forkJoinMapDoTask = new ForkJoinMapDoTask(myMap);\n    Map&lt;String, Integer&gt; invoke = pool.invoke(forkJoinMapDoTask);\n    System.out.println(invoke.keySet().size());\n    for(Map.Entry&lt;String,Integer&gt; entry : invoke.entrySet()){\n        if(entry.getValue() != 11){\n            System.out.println(&quot;&quot;);\n        }\n    }\n}</code></pre>\n<pre><code class=\"java\">/***\n * Map10\n */\npublic class ForkJoinMapDoTask extends RecursiveTask&lt;Map&lt;String, Integer&gt;&gt; {\n\n    private static final int TASK_COUNT = 5000; //5000\n\n    private Map&lt;String, Integer&gt; myMap;\n\n    public ForkJoinMapDoTask(Map&lt;String, Integer&gt; myMap) {\n        this.myMap = myMap;\n    }\n\n\n    @Override\n    protected Map&lt;String, Integer&gt; compute() {\n\n        if (myMap.keySet().size() &lt;= TASK_COUNT) {\n            Map&lt;String, Integer&gt; resultMap = Maps.newHashMap();\n            for (Map.Entry&lt;String, Integer&gt; entry : myMap.entrySet()) {\n                resultMap.put(entry.getKey(), entry.getValue() + 10);\n            }\n            return resultMap;\n        } else {\n            List&lt;Map&lt;String,Integer&gt;&gt; mapList = ForkJoinMapDoTask.mapChunk(myMap,2);\n            ForkJoinMapDoTask leftTask = new ForkJoinMapDoTask(mapList.get(0));\n            ForkJoinMapDoTask rightTask = new ForkJoinMapDoTask(mapList.get(1));\n            invokeAll(leftTask,rightTask);\n            Map&lt;String, Integer&gt; lfetMap = leftTask.join();\n            Map&lt;String, Integer&gt; rightMap = rightTask.join();\n            Map&lt;String, Integer&gt; resultMap = Maps.newHashMap();\n            resultMap.putAll(lfetMap);\n            resultMap.putAll(rightMap);\n            return resultMap;\n        }\n    }\n\n\n    public static &lt;k, v&gt; List&lt;Map&lt;k, v&gt;&gt; mapChunk(Map&lt;k, v&gt; chunkMap, int batch) {\n        List&lt;Map&lt;k,v&gt;&gt; resultList = Lists.newArrayList();\n        if(MapUtils.isEmpty(chunkMap)){\n            return Lists.newArrayList();\n        }\n        int keyLength = chunkMap.keySet().size();\n        int pageSize = keyLength % batch == 0 ? (keyLength / batch) : (keyLength / batch + 1);\n        //\n        for(int i = 0 ; i &lt; batch; i ++){\n            resultList.add(Maps.newHashMap());\n        }\n        int i = 0, count = 0;\n        for(Map.Entry&lt;k,v&gt; entry : chunkMap.entrySet()){\n            resultList.get(i).put(entry.getKey(),entry.getValue());\n            count++;\n            if(count % pageSize == 0){\n                i++;\n            }\n        }\n        return resultList;\n    }\n}</code></pre>\n<h3 id=\"Fork-Join\"><a href=\"#Fork-Join\" class=\"headerlink\" title=\"Fork/Join\"></a>Fork/Join</h3><p>ForkJoinPoolForkJoinTaskForkJoinWorkerThreadForkJoinTaskForkJoinPoolForkJoinWorkerThread;</p>\n<h4 id=\"ForkJoinTaskfork\"><a href=\"#ForkJoinTaskfork\" class=\"headerlink\" title=\"ForkJoinTaskfork\"></a>ForkJoinTaskfork</h4><p>ForkJoinTaskforkForkJoinWorkerThreadpushTaskworkQueue</p>\n<pre><code class=\"java\">public final ForkJoinTask&lt;V&gt; fork() {\n    Thread t;\n    if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)\n        ((ForkJoinWorkerThread)t).workQueue.push(this);\n    else\n        ForkJoinPool.common.externalPush(this);\n    return this;\n}</code></pre>\n<p>pushTaskForkJoinTaskForkJoinPoolsignalWork()</p>\n<pre><code class=\"java\">final void push(ForkJoinTask&lt;?&gt; task) {\n    ForkJoinTask&lt;?&gt;[] a; ForkJoinPool p;\n    int b = base, s = top, n;\n    if ((a = array) != null) {    // ignore if queue removed\n        int m = a.length - 1;     // fenced write for task visibility\n        U.putOrderedObject(a, ((m &amp; s) &lt;&lt; ASHIFT) + ABASE, task);\n        U.putOrderedInt(this, QTOP, s + 1);\n        if ((n = s - b) &lt;= 1) {\n            if ((p = pool) != null)\n                p.signalWork(p.workQueues, this);\n        }\n        else if (n &gt;= m)\n            growArray();\n    }\n}</code></pre>\n<h4 id=\"ForkJoinTaskjoin\"><a href=\"#ForkJoinTaskjoin\" class=\"headerlink\" title=\"ForkJoinTaskjoin\"></a>ForkJoinTaskjoin</h4><p>oinForkJoinTaskjoin</p>\n<pre><code class=\"java\">public final V join() {\n    int s;\n    if ((s = doJoin() &amp; DONE_MASK) != NORMAL){\n        reportException(s);\n    }\n    return getRawResult();\n}</code></pre>\n<p>doJoindoJoin()4NORMALCANCELLEDSIGNALEXCEPTIONAL<br><br>CancellationException<br><br>doJoin</p>\n<pre><code class=\"java\">private int doJoin() {\n    int s;\n    Thread t;\n    ForkJoinWorkerThread wt;\n    ForkJoinPool.WorkQueue w;\n    return (s = status) &lt; 0 ? s :\n            ((t = Thread.currentThread()) instanceof                                 ForkJoinWorkerThread) ? (w = (wt =                                         (ForkJoinWorkerThread)t).workQueue).tryUnpush(this) &amp;&amp; (s =                 doExec()) &lt; 0 ? s : wt.pool.awaitJoin(w, this, 0L) :                 externalAwaitDone();\n}</code></pre>\n<p>doExec() :</p>\n<pre><code class=\"java\">final int doExec() {\n    int s; \n    boolean completed;\n    if ((s = status) &gt;= 0) {\n        try {\n            completed = exec();\n        } catch (Throwable rex) {\n            return setExceptionalCompletion(rex);\n        }\n        if (completed){\n            s = setCompletion(NORMAL);\n        }\n    }\n    return s;\n}</code></pre>\n<p>doJoin()NORMALEXCEPTIONAL</p>"},{"title":"FutureFutureTask","description":"FutureFutureTask","date":"2019-07-18T02:00:00.000Z","_content":"## FutureFutureTask\nfutureJavaThreadRunnableJDKajax\"\"\"\"\n<!--more-->\n```java\n    @Test\n    public void test() throws ExecutionException, InterruptedException {\n        FutureTask<String> futureTask = new FutureTask<>(() -> {\n            System.out.println(\"!!!!\");\n            return \"success\";\n        });\n\n        Thread thread = new Thread(futureTask);\n        thread.start();\n        boolean isDone = futureTask.isDone();\n        System.out.println(\"isDone =\" + isDone);\n        long l = System.currentTimeMillis();\n        futureTask.get();\n        System.out.println(\"isDone =\" + isDone);\n        System.out.println(\" =\" + (System.currentTimeMillis() - l) + \" ms\");\n    }\n```\n\n### FutureTask\n\n```java\n@Test\npublic void test2(){\n    ExecutorService es = Executors.newCachedThreadPool();\n    List<Future<String>> futureList = Lists.newArrayList();\n    for(int i = 0 ; i < 10 ; i++){\n        Future<String> future = es.submit(new Callable<String>() {\n            @Override\n            public String call() throws Exception {\n                return UUID.randomUUID().toString();\n            }\n        });\n        futureList.add(future);\n    }\n    futureList.forEach(stringFuture -> {\n        try {\n            System.out.println(stringFuture.get());\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } catch (ExecutionException e) {\n            e.printStackTrace();\n        }\n    });\n}\n```\n\n\n\n### FutureTask\n\nFutureTask,futureTaskFutureRunnableFutureTask\n\n![](futuretask/1.png)\n\n|         |                                                          |\n| ----------- | ------------------------------------------------------------ |\n| cancel      |                                                      |\n| isCancelled |                                            |\n| isDone      |                                            |\n| get         | get |\n| run         |                                                |\n\n## FutureTask\n\n### FutureTask\n\nFutureTaskRunnableCallableRunableFutureTask(Runnable runnable, V result)Executors.callable(runnable, result)RunnableCallable\n\n![](futuretask/2.png)\n\n```java\npublic static <T> Callable<T> callable(Runnable task, T result) {\n        if (task == null)\n            throw new NullPointerException();\n        return new RunnableAdapter<T>(task, result);\n}\nstatic final class RunnableAdapter<T> implements Callable<T> {\n        final Runnable task;\n        final T result;\n        RunnableAdapter(Runnable task, T result) {\n            this.task = task;\n            this.result = result;\n        }\n        public T call() {\n            task.run();\n            return result;\n        }\n}\n```\n\nRunnableCallable\n\n### FutureTask\n\n```java\n//task\nprivate volatile int state;\n//\nprivate static final int NEW          = 0;\n//\nprivate static final int COMPLETING   = 1;\n//\nprivate static final int NORMAL       = 2;\n//\nprivate static final int EXCEPTIONAL  = 3;\n//\nprivate static final int CANCELLED    = 4;\n//\nprivate static final int INTERRUPTING = 5;\n//\nprivate static final int INTERRUPTED  = 6;\n// \"\" \nprivate Callable<V> callable;\n//\nprivate Object outcome;\n//\nprivate volatile Thread runner;\n/**\nfutureTask.getgetfutureTask.runfor\n**/\nprivate volatile WaitNode waiters;\n\n```\n\n### FutureTask\n\n```java\npublic void run() {\n       //NEWNEWTask\n       //UNSAFE.compareAndSwapObjectrunCASrunnerOffset\n       //CASrunnerOffset = null runnerOffset,turefalse\n        if (state != NEW ||\n            !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                         null, Thread.currentThread()))\n            return;\n        try {\n            //callable\n            Callable<V> c = callable;\n            //c!=null \n            //? cancel\n            if (c != null && state == NEW) {\n                V result;\n                boolean ran;\n                try {\n                    //\n                    result = c.call();\n                    ran = true;\n                } catch (Throwable ex) {\n                    result = null;\n                    ran = false;\n                    //\n                    setException(ex);\n                }\n                if (ran)\n                    //\n                    set(result);\n            }\n        } finally {\n            // runner must be non-null until state is settled to\n            // prevent concurrent calls to run()\n            runner = null;\n            // state must be re-read after nulling runner to prevent\n            // leaked interrupts\n            int s = state;\n            //\n            if (s >= INTERRUPTING)\n                //\n                handlePossibleCancellationInterrupt(s);\n        }\n    }\n```\n\nFutureTask#set()\n\n```java\n    protected void set(V v) {\n        //CASNEWCOMPLETINGCAS\n        //\n        if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n            //outcome\n            outcome = v;\n            //outcomeNORMAL\n            //putOrderedInt \n            UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state\n            //TODO\n            finishCompletion();\n        }\n    }\n```\n\n### FutureTask#get\n\ngetWaitNodes\n\n```java\nstatic final class WaitNode {\n    volatile Thread thread;\n    volatile WaitNode next;\n    WaitNode() { thread = Thread.currentThread(); }\n}\n```\n\n```java\n\n\npublic V get() throws InterruptedException, ExecutionException {\n    //\n    int s = state;\n    //COMPLETINGawaitDone\n    if (s <= COMPLETING)\n        s = awaitDone(false, 0L);\n    return report(s);\n}\n//get -- \nprivate int awaitDone(boolean timed, long nanos)\n    throws InterruptedException {\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    //WaitNode\n    WaitNode q = null;\n    //WaitNode\n    boolean queued = false;\n    //\n    for (;;) {\n        //\n        //ture \n        if (Thread.interrupted()) {\n            //node\n            removeWaiter(q);\n            //\n            throw new InterruptedException();\n        }\n        int s = state;\n        //unparkCOMPLETING\n        //\n        if (s > COMPLETING) {\n            if (q != null)\n                q.thread = null;\n            //\n            return s;\n        }\n        else if (s == COMPLETING) // cannot time out yet\n            Thread.yield();\n        else if (q == null) //WaitNode\n            q = new WaitNode();\n        else if (!queued){ //WaitNodenode\n            //\n            //q.next = waiters #next\n            //queued = UNSAFE.compareAndSwapObject(this, waitersOffset, waiters, q);\n            //# CASwaitersnode,\t\n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,\n                                                 q.next = waiters, q);\n        }else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos <= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            LockSupport.parkNanos(this, nanos);\n        }\n        else\n            //\n            LockSupport.park(this);\n           //\n    }\n}\n\n//\nprivate V report(int s) throws ExecutionException {\n    Object x = outcome;\n    //\n    if (s == NORMAL)\n        return (V)x;\n    //\n    if (s >= CANCELLED)\n        throw new CancellationException();\n    throw new ExecutionException((Throwable)x);\n}\n```\n\ngetgetWaitNodeLockSupport.park(this)(WaitNoderun)\n\n### FutureTask#finishCompletion\n\ngetLockSupport.parkWaitNoderun\n\n```java\nprivate void finishCompletion() {\n    // assert state > COMPLETING;\n    //waitNodeLockSupport.unpark\n    for (WaitNode q; (q = waiters) != null;) {\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                Thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    //\n                    LockSupport.unpark(t);\n                }\n                WaitNode next = q.next;\n                if (next == null)\n                    break;\n                q.next = null; // unlink to help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done(); //\n    callable = null;        // to reduce footprint\n}\n```\n\n","source":"_posts/futuretask.md","raw":"---\ntitle: FutureFutureTask\ntags:\n  - java\ncategories:  java\ndescription : FutureFutureTask\ndate: 2019-07-18 10:00:00\n---\n## FutureFutureTask\nfutureJavaThreadRunnableJDKajax\"\"\"\"\n<!--more-->\n```java\n    @Test\n    public void test() throws ExecutionException, InterruptedException {\n        FutureTask<String> futureTask = new FutureTask<>(() -> {\n            System.out.println(\"!!!!\");\n            return \"success\";\n        });\n\n        Thread thread = new Thread(futureTask);\n        thread.start();\n        boolean isDone = futureTask.isDone();\n        System.out.println(\"isDone =\" + isDone);\n        long l = System.currentTimeMillis();\n        futureTask.get();\n        System.out.println(\"isDone =\" + isDone);\n        System.out.println(\" =\" + (System.currentTimeMillis() - l) + \" ms\");\n    }\n```\n\n### FutureTask\n\n```java\n@Test\npublic void test2(){\n    ExecutorService es = Executors.newCachedThreadPool();\n    List<Future<String>> futureList = Lists.newArrayList();\n    for(int i = 0 ; i < 10 ; i++){\n        Future<String> future = es.submit(new Callable<String>() {\n            @Override\n            public String call() throws Exception {\n                return UUID.randomUUID().toString();\n            }\n        });\n        futureList.add(future);\n    }\n    futureList.forEach(stringFuture -> {\n        try {\n            System.out.println(stringFuture.get());\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } catch (ExecutionException e) {\n            e.printStackTrace();\n        }\n    });\n}\n```\n\n\n\n### FutureTask\n\nFutureTask,futureTaskFutureRunnableFutureTask\n\n![](futuretask/1.png)\n\n|         |                                                          |\n| ----------- | ------------------------------------------------------------ |\n| cancel      |                                                      |\n| isCancelled |                                            |\n| isDone      |                                            |\n| get         | get |\n| run         |                                                |\n\n## FutureTask\n\n### FutureTask\n\nFutureTaskRunnableCallableRunableFutureTask(Runnable runnable, V result)Executors.callable(runnable, result)RunnableCallable\n\n![](futuretask/2.png)\n\n```java\npublic static <T> Callable<T> callable(Runnable task, T result) {\n        if (task == null)\n            throw new NullPointerException();\n        return new RunnableAdapter<T>(task, result);\n}\nstatic final class RunnableAdapter<T> implements Callable<T> {\n        final Runnable task;\n        final T result;\n        RunnableAdapter(Runnable task, T result) {\n            this.task = task;\n            this.result = result;\n        }\n        public T call() {\n            task.run();\n            return result;\n        }\n}\n```\n\nRunnableCallable\n\n### FutureTask\n\n```java\n//task\nprivate volatile int state;\n//\nprivate static final int NEW          = 0;\n//\nprivate static final int COMPLETING   = 1;\n//\nprivate static final int NORMAL       = 2;\n//\nprivate static final int EXCEPTIONAL  = 3;\n//\nprivate static final int CANCELLED    = 4;\n//\nprivate static final int INTERRUPTING = 5;\n//\nprivate static final int INTERRUPTED  = 6;\n// \"\" \nprivate Callable<V> callable;\n//\nprivate Object outcome;\n//\nprivate volatile Thread runner;\n/**\nfutureTask.getgetfutureTask.runfor\n**/\nprivate volatile WaitNode waiters;\n\n```\n\n### FutureTask\n\n```java\npublic void run() {\n       //NEWNEWTask\n       //UNSAFE.compareAndSwapObjectrunCASrunnerOffset\n       //CASrunnerOffset = null runnerOffset,turefalse\n        if (state != NEW ||\n            !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                         null, Thread.currentThread()))\n            return;\n        try {\n            //callable\n            Callable<V> c = callable;\n            //c!=null \n            //? cancel\n            if (c != null && state == NEW) {\n                V result;\n                boolean ran;\n                try {\n                    //\n                    result = c.call();\n                    ran = true;\n                } catch (Throwable ex) {\n                    result = null;\n                    ran = false;\n                    //\n                    setException(ex);\n                }\n                if (ran)\n                    //\n                    set(result);\n            }\n        } finally {\n            // runner must be non-null until state is settled to\n            // prevent concurrent calls to run()\n            runner = null;\n            // state must be re-read after nulling runner to prevent\n            // leaked interrupts\n            int s = state;\n            //\n            if (s >= INTERRUPTING)\n                //\n                handlePossibleCancellationInterrupt(s);\n        }\n    }\n```\n\nFutureTask#set()\n\n```java\n    protected void set(V v) {\n        //CASNEWCOMPLETINGCAS\n        //\n        if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n            //outcome\n            outcome = v;\n            //outcomeNORMAL\n            //putOrderedInt \n            UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state\n            //TODO\n            finishCompletion();\n        }\n    }\n```\n\n### FutureTask#get\n\ngetWaitNodes\n\n```java\nstatic final class WaitNode {\n    volatile Thread thread;\n    volatile WaitNode next;\n    WaitNode() { thread = Thread.currentThread(); }\n}\n```\n\n```java\n\n\npublic V get() throws InterruptedException, ExecutionException {\n    //\n    int s = state;\n    //COMPLETINGawaitDone\n    if (s <= COMPLETING)\n        s = awaitDone(false, 0L);\n    return report(s);\n}\n//get -- \nprivate int awaitDone(boolean timed, long nanos)\n    throws InterruptedException {\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    //WaitNode\n    WaitNode q = null;\n    //WaitNode\n    boolean queued = false;\n    //\n    for (;;) {\n        //\n        //ture \n        if (Thread.interrupted()) {\n            //node\n            removeWaiter(q);\n            //\n            throw new InterruptedException();\n        }\n        int s = state;\n        //unparkCOMPLETING\n        //\n        if (s > COMPLETING) {\n            if (q != null)\n                q.thread = null;\n            //\n            return s;\n        }\n        else if (s == COMPLETING) // cannot time out yet\n            Thread.yield();\n        else if (q == null) //WaitNode\n            q = new WaitNode();\n        else if (!queued){ //WaitNodenode\n            //\n            //q.next = waiters #next\n            //queued = UNSAFE.compareAndSwapObject(this, waitersOffset, waiters, q);\n            //# CASwaitersnode,\t\n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,\n                                                 q.next = waiters, q);\n        }else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos <= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            LockSupport.parkNanos(this, nanos);\n        }\n        else\n            //\n            LockSupport.park(this);\n           //\n    }\n}\n\n//\nprivate V report(int s) throws ExecutionException {\n    Object x = outcome;\n    //\n    if (s == NORMAL)\n        return (V)x;\n    //\n    if (s >= CANCELLED)\n        throw new CancellationException();\n    throw new ExecutionException((Throwable)x);\n}\n```\n\ngetgetWaitNodeLockSupport.park(this)(WaitNoderun)\n\n### FutureTask#finishCompletion\n\ngetLockSupport.parkWaitNoderun\n\n```java\nprivate void finishCompletion() {\n    // assert state > COMPLETING;\n    //waitNodeLockSupport.unpark\n    for (WaitNode q; (q = waiters) != null;) {\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                Thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    //\n                    LockSupport.unpark(t);\n                }\n                WaitNode next = q.next;\n                if (next == null)\n                    break;\n                q.next = null; // unlink to help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done(); //\n    callable = null;        // to reduce footprint\n}\n```\n\n","slug":"futuretask","published":1,"updated":"2021-04-08T00:47:06.737Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhun000cqwv27tig1h1x","content":"<h2 id=\"FutureFutureTask\"><a href=\"#FutureFutureTask\" class=\"headerlink\" title=\"FutureFutureTask\"></a>FutureFutureTask</h2><p>futureJavaThreadRunnableJDKajax</p>\n<a id=\"more\"></a>\n<pre class=\" language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException<span class=\"token punctuation\">,</span> InterruptedException <span class=\"token punctuation\">{</span>\n        FutureTask<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> futureTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FutureTask</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"!!!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        Thread thread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>futureTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        thread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">boolean</span> isDone <span class=\"token operator\">=</span> futureTask<span class=\"token punctuation\">.</span><span class=\"token function\">isDone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"isDone =\"</span> <span class=\"token operator\">+</span> isDone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">long</span> l <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        futureTask<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"isDone =\"</span> <span class=\"token operator\">+</span> isDone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" =\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> l<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    ExecutorService es <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newCachedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    List<span class=\"token operator\">&lt;</span>Future<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">>></span> futureList <span class=\"token operator\">=</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        Future<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> future <span class=\"token operator\">=</span> es<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Callable</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> String <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        futureList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    futureList<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>stringFuture <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>stringFuture<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ExecutionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><p>FutureTask,futureTaskFutureRunnableFutureTask</p>\n<p><img src=\"/2019/07/18/futuretask/1.png\" alt></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>cancel</td>\n<td></td>\n</tr>\n<tr>\n<td>isCancelled</td>\n<td></td>\n</tr>\n<tr>\n<td>isDone</td>\n<td></td>\n</tr>\n<tr>\n<td>get</td>\n<td>get</td>\n</tr>\n<tr>\n<td>run</td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h2><h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><p>FutureTaskRunnableCallableRunableFutureTask(Runnable runnable, V result)Executors.callable(runnable, result)RunnableCallable</p>\n<p><img src=\"/2019/07/18/futuretask/2.png\" alt></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> Callable<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">callable</span><span class=\"token punctuation\">(</span>Runnable task<span class=\"token punctuation\">,</span> T result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RunnableAdapter</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RunnableAdapter</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Callable</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> Runnable task<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> T result<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">RunnableAdapter</span><span class=\"token punctuation\">(</span>Runnable task<span class=\"token punctuation\">,</span> T result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>task <span class=\"token operator\">=</span> task<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">public</span> T <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>RunnableCallable</p>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//task</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> state<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> NEW          <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> COMPLETING   <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> NORMAL       <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> EXCEPTIONAL  <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CANCELLED    <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> INTERRUPTING <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> INTERRUPTED  <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// \"\" </span>\n<span class=\"token keyword\">private</span> Callable<span class=\"token operator\">&lt;</span>V<span class=\"token operator\">></span> callable<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> Object outcome<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> Thread runner<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">/**\nfutureTask.getgetfutureTask.runfor\n**/</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> WaitNode waiters<span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token comment\" spellcheck=\"true\">//NEWNEWTask</span>\n       <span class=\"token comment\" spellcheck=\"true\">//UNSAFE.compareAndSwapObjectrunCASrunnerOffset</span>\n       <span class=\"token comment\" spellcheck=\"true\">//CASrunnerOffset = null runnerOffset,turefalse</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">!=</span> NEW <span class=\"token operator\">||</span>\n            <span class=\"token operator\">!</span>UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSwapObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> runnerOffset<span class=\"token punctuation\">,</span>\n                                         null<span class=\"token punctuation\">,</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//callable</span>\n            Callable<span class=\"token operator\">&lt;</span>V<span class=\"token operator\">></span> c <span class=\"token operator\">=</span> callable<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//c!=null </span>\n            <span class=\"token comment\" spellcheck=\"true\">//? cancel</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> state <span class=\"token operator\">==</span> NEW<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                V result<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">boolean</span> ran<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    result <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    ran <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    result <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                    ran <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token function\">setException</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ran<span class=\"token punctuation\">)</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">// runner must be non-null until state is settled to</span>\n            <span class=\"token comment\" spellcheck=\"true\">// prevent concurrent calls to run()</span>\n            runner <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">// state must be re-read after nulling runner to prevent</span>\n            <span class=\"token comment\" spellcheck=\"true\">// leaked interrupts</span>\n            <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">>=</span> INTERRUPTING<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token function\">handlePossibleCancellationInterrupt</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<p>FutureTask#set()</p>\n<pre class=\" language-java\"><code class=\"language-java\">    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>V v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//CASNEWCOMPLETINGCAS</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSwapInt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> stateOffset<span class=\"token punctuation\">,</span> NEW<span class=\"token punctuation\">,</span> COMPLETING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//outcome</span>\n            outcome <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//outcomeNORMAL</span>\n            <span class=\"token comment\" spellcheck=\"true\">//putOrderedInt </span>\n            UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">putOrderedInt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> stateOffset<span class=\"token punctuation\">,</span> NORMAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// final state</span>\n            <span class=\"token comment\" spellcheck=\"true\">//TODO</span>\n            <span class=\"token function\">finishCompletion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"FutureTask-get\"><a href=\"#FutureTask-get\" class=\"headerlink\" title=\"FutureTask#get\"></a>FutureTask#get</h3><p>getWaitNodes</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WaitNode</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">volatile</span> Thread thread<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">volatile</span> WaitNode next<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WaitNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> thread <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\">\n\n<span class=\"token keyword\">public</span> V <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException<span class=\"token punctuation\">,</span> ExecutionException <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//COMPLETINGawaitDone</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">&lt;=</span> COMPLETING<span class=\"token punctuation\">)</span>\n        s <span class=\"token operator\">=</span> <span class=\"token function\">awaitDone</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> 0L<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//get -- </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> <span class=\"token function\">awaitDone</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> timed<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> nanos<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> deadline <span class=\"token operator\">=</span> timed <span class=\"token operator\">?</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">nanoTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> nanos <span class=\"token operator\">:</span> 0L<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//WaitNode</span>\n    WaitNode q <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//WaitNode</span>\n    <span class=\"token keyword\">boolean</span> queued <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token comment\" spellcheck=\"true\">//ture </span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//node</span>\n            <span class=\"token function\">removeWaiter</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//unparkCOMPLETING</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">></span> COMPLETING<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>q <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n                q<span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> COMPLETING<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">// cannot time out yet</span>\n            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">yield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>q <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//WaitNode</span>\n            q <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WaitNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>queued<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">//WaitNodenode</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//q.next = waiters #next</span>\n            <span class=\"token comment\" spellcheck=\"true\">//queued = UNSAFE.compareAndSwapObject(this, waitersOffset, waiters, q);</span>\n            <span class=\"token comment\" spellcheck=\"true\">//# CASwaitersnode,    </span>\n            queued <span class=\"token operator\">=</span> UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSwapObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> waitersOffset<span class=\"token punctuation\">,</span>\n                                                 q<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> waiters<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            nanos <span class=\"token operator\">=</span> deadline <span class=\"token operator\">-</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">nanoTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nanos <span class=\"token operator\">&lt;=</span> 0L<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">removeWaiter</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            LockSupport<span class=\"token punctuation\">.</span><span class=\"token function\">parkNanos</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> nanos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            LockSupport<span class=\"token punctuation\">.</span><span class=\"token function\">park</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n           <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> V <span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> ExecutionException <span class=\"token punctuation\">{</span>\n    Object x <span class=\"token operator\">=</span> outcome<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> NORMAL<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>V<span class=\"token punctuation\">)</span>x<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">>=</span> CANCELLED<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CancellationException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Throwable<span class=\"token punctuation\">)</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>getgetWaitNodeLockSupport.park(this)(WaitNoderun)</p>\n<h3 id=\"FutureTask-finishCompletion\"><a href=\"#FutureTask-finishCompletion\" class=\"headerlink\" title=\"FutureTask#finishCompletion\"></a>FutureTask#finishCompletion</h3><p>getLockSupport.parkWaitNoderun</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">finishCompletion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">// assert state > COMPLETING;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//waitNodeLockSupport.unpark</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>WaitNode q<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span>q <span class=\"token operator\">=</span> waiters<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSwapObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> waitersOffset<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                Thread t <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span>thread<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    q<span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    LockSupport<span class=\"token punctuation\">.</span><span class=\"token function\">unpark</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                WaitNode next <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                q<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// unlink to help gc</span>\n                q <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    callable <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>        <span class=\"token comment\" spellcheck=\"true\">// to reduce footprint</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"FutureFutureTask\"><a href=\"#FutureFutureTask\" class=\"headerlink\" title=\"FutureFutureTask\"></a>FutureFutureTask</h2><p>futureJavaThreadRunnableJDKajax</p>","more":"<pre><code class=\"java\">    @Test\n    public void test() throws ExecutionException, InterruptedException {\n        FutureTask&lt;String&gt; futureTask = new FutureTask&lt;&gt;(() -&gt; {\n            System.out.println(&quot;!!!!&quot;);\n            return &quot;success&quot;;\n        });\n\n        Thread thread = new Thread(futureTask);\n        thread.start();\n        boolean isDone = futureTask.isDone();\n        System.out.println(&quot;isDone =&quot; + isDone);\n        long l = System.currentTimeMillis();\n        futureTask.get();\n        System.out.println(&quot;isDone =&quot; + isDone);\n        System.out.println(&quot; =&quot; + (System.currentTimeMillis() - l) + &quot; ms&quot;);\n    }</code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre><code class=\"java\">@Test\npublic void test2(){\n    ExecutorService es = Executors.newCachedThreadPool();\n    List&lt;Future&lt;String&gt;&gt; futureList = Lists.newArrayList();\n    for(int i = 0 ; i &lt; 10 ; i++){\n        Future&lt;String&gt; future = es.submit(new Callable&lt;String&gt;() {\n            @Override\n            public String call() throws Exception {\n                return UUID.randomUUID().toString();\n            }\n        });\n        futureList.add(future);\n    }\n    futureList.forEach(stringFuture -&gt; {\n        try {\n            System.out.println(stringFuture.get());\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } catch (ExecutionException e) {\n            e.printStackTrace();\n        }\n    });\n}</code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><p>FutureTask,futureTaskFutureRunnableFutureTask</p>\n<p><img src=\"/2019/07/18/futuretask/1.png\" alt></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>cancel</td>\n<td></td>\n</tr>\n<tr>\n<td>isCancelled</td>\n<td></td>\n</tr>\n<tr>\n<td>isDone</td>\n<td></td>\n</tr>\n<tr>\n<td>get</td>\n<td>get</td>\n</tr>\n<tr>\n<td>run</td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h2><h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><p>FutureTaskRunnableCallableRunableFutureTask(Runnable runnable, V result)Executors.callable(runnable, result)RunnableCallable</p>\n<p><img src=\"/2019/07/18/futuretask/2.png\" alt></p>\n<pre><code class=\"java\">public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result) {\n        if (task == null)\n            throw new NullPointerException();\n        return new RunnableAdapter&lt;T&gt;(task, result);\n}\nstatic final class RunnableAdapter&lt;T&gt; implements Callable&lt;T&gt; {\n        final Runnable task;\n        final T result;\n        RunnableAdapter(Runnable task, T result) {\n            this.task = task;\n            this.result = result;\n        }\n        public T call() {\n            task.run();\n            return result;\n        }\n}</code></pre>\n<p>RunnableCallable</p>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre><code class=\"java\">//task\nprivate volatile int state;\n//\nprivate static final int NEW          = 0;\n//\nprivate static final int COMPLETING   = 1;\n//\nprivate static final int NORMAL       = 2;\n//\nprivate static final int EXCEPTIONAL  = 3;\n//\nprivate static final int CANCELLED    = 4;\n//\nprivate static final int INTERRUPTING = 5;\n//\nprivate static final int INTERRUPTED  = 6;\n// &quot;&quot; \nprivate Callable&lt;V&gt; callable;\n//\nprivate Object outcome;\n//\nprivate volatile Thread runner;\n/**\nfutureTask.getgetfutureTask.runfor\n**/\nprivate volatile WaitNode waiters;\n</code></pre>\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><pre><code class=\"java\">public void run() {\n       //NEWNEWTask\n       //UNSAFE.compareAndSwapObjectrunCASrunnerOffset\n       //CASrunnerOffset = null runnerOffset,turefalse\n        if (state != NEW ||\n            !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                         null, Thread.currentThread()))\n            return;\n        try {\n            //callable\n            Callable&lt;V&gt; c = callable;\n            //c!=null \n            //? cancel\n            if (c != null &amp;&amp; state == NEW) {\n                V result;\n                boolean ran;\n                try {\n                    //\n                    result = c.call();\n                    ran = true;\n                } catch (Throwable ex) {\n                    result = null;\n                    ran = false;\n                    //\n                    setException(ex);\n                }\n                if (ran)\n                    //\n                    set(result);\n            }\n        } finally {\n            // runner must be non-null until state is settled to\n            // prevent concurrent calls to run()\n            runner = null;\n            // state must be re-read after nulling runner to prevent\n            // leaked interrupts\n            int s = state;\n            //\n            if (s &gt;= INTERRUPTING)\n                //\n                handlePossibleCancellationInterrupt(s);\n        }\n    }</code></pre>\n<p>FutureTask#set()</p>\n<pre><code class=\"java\">    protected void set(V v) {\n        //CASNEWCOMPLETINGCAS\n        //\n        if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n            //outcome\n            outcome = v;\n            //outcomeNORMAL\n            //putOrderedInt \n            UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state\n            //TODO\n            finishCompletion();\n        }\n    }</code></pre>\n<h3 id=\"FutureTask-get\"><a href=\"#FutureTask-get\" class=\"headerlink\" title=\"FutureTask#get\"></a>FutureTask#get</h3><p>getWaitNodes</p>\n<pre><code class=\"java\">static final class WaitNode {\n    volatile Thread thread;\n    volatile WaitNode next;\n    WaitNode() { thread = Thread.currentThread(); }\n}</code></pre>\n<pre><code class=\"java\">\n\npublic V get() throws InterruptedException, ExecutionException {\n    //\n    int s = state;\n    //COMPLETINGawaitDone\n    if (s &lt;= COMPLETING)\n        s = awaitDone(false, 0L);\n    return report(s);\n}\n//get -- \nprivate int awaitDone(boolean timed, long nanos)\n    throws InterruptedException {\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    //WaitNode\n    WaitNode q = null;\n    //WaitNode\n    boolean queued = false;\n    //\n    for (;;) {\n        //\n        //ture \n        if (Thread.interrupted()) {\n            //node\n            removeWaiter(q);\n            //\n            throw new InterruptedException();\n        }\n        int s = state;\n        //unparkCOMPLETING\n        //\n        if (s &gt; COMPLETING) {\n            if (q != null)\n                q.thread = null;\n            //\n            return s;\n        }\n        else if (s == COMPLETING) // cannot time out yet\n            Thread.yield();\n        else if (q == null) //WaitNode\n            q = new WaitNode();\n        else if (!queued){ //WaitNodenode\n            //\n            //q.next = waiters #next\n            //queued = UNSAFE.compareAndSwapObject(this, waitersOffset, waiters, q);\n            //# CASwaitersnode,    \n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,\n                                                 q.next = waiters, q);\n        }else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos &lt;= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            LockSupport.parkNanos(this, nanos);\n        }\n        else\n            //\n            LockSupport.park(this);\n           //\n    }\n}\n\n//\nprivate V report(int s) throws ExecutionException {\n    Object x = outcome;\n    //\n    if (s == NORMAL)\n        return (V)x;\n    //\n    if (s &gt;= CANCELLED)\n        throw new CancellationException();\n    throw new ExecutionException((Throwable)x);\n}</code></pre>\n<p>getgetWaitNodeLockSupport.park(this)(WaitNoderun)</p>\n<h3 id=\"FutureTask-finishCompletion\"><a href=\"#FutureTask-finishCompletion\" class=\"headerlink\" title=\"FutureTask#finishCompletion\"></a>FutureTask#finishCompletion</h3><p>getLockSupport.parkWaitNoderun</p>\n<pre><code class=\"java\">private void finishCompletion() {\n    // assert state &gt; COMPLETING;\n    //waitNodeLockSupport.unpark\n    for (WaitNode q; (q = waiters) != null;) {\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                Thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    //\n                    LockSupport.unpark(t);\n                }\n                WaitNode next = q.next;\n                if (next == null)\n                    break;\n                q.next = null; // unlink to help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done(); //\n    callable = null;        // to reduce footprint\n}</code></pre>"},{"title":"IO","description":"IO","date":"2020-12-10T01:05:24.000Z","_content":"\n### \nCPU````\n\n### IO\n\n\n\n#### **IO**\n1. sys_read\n2. CPUDMAIO\n3. DMA<font color=red></font>read\n4. CPUread<font color=red></font>\n5. socket_write\n6. CPU<font color=red></font>socket\n7. DMAsocket<font color=red></font>\nIO\n\n![IO/](io/1.png)\n\n#### **IO**\n1. sys_read\n2. CPUDMAIO\n3. DMA<font color=red></font>read\n4. CPUread<font color=red></font>socket\n5. DMAsocket<font color=red></font>\nIO\n\n![IO/](io/2.png)\n\n : DMACPUIOCPUDMA\n\n### IO\n\n#### **IO**\nrecv()/recvfrom()kernelIOIOUDPkernelkernelkernelkernelblock\n\n<img src=\"io/3.png\" style=\"zoom:50%;\" />\n\n```java\nimport java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            socket.getInputStream().read(bs); // \n            System.out.println(bs);\n        }\n    }\n}\n```\nIOTCPreadTCP`IO` + ``\n\n\n\n```java\nimport java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            //TCP\n            Thread t = new Thread(() -> {\n                try {\n                    socket.getInputStream().read(bs);\n                } catch (IOException e) {\n                    e.printStackTrace();\n                }\n            });\n            t.start();\n        }\n    }\n}\n```\n\n#### **IO**\nreadkernelblockerrorreaderrorreadkernelsystem call\n\n<img src=\"io/4.png\" style=\"zoom:50%;\" />\n\naccept()read()TCPaccept()read()TCPfor\n1WTCP10**forCPU**\n```java\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.net.SocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.ArrayList;\nimport java.util.List;\n\npublic class OtherTest {\n    static List<SocketChannel> socketChannelList = new ArrayList<>();\n    static ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocket = ServerSocketChannel.open();\n        SocketAddress socketAddress = new InetSocketAddress(\"loaclhost\",6379);\n        serverSocket.bind(socketAddress);\n        serverSocket.configureBlocking(false); //\n        while (true){\n            for(SocketChannel socketChannel: socketChannelList){\n                int read = socketChannel.read(byteBuffer);\n                if(read > 0){\n                    byte[] bs = new byte[read];\n                    byteBuffer.get(bs);\n                    byteBuffer.flip();\n                }\n            }\n            SocketChannel socket = serverSocket.accept();\n            if(socket != null){\n                socket.configureBlocking(false); //\n                socketChannelList.add(socket);\n            }\n        }\n    }\n}\n```\n#### **IO**\nCPU<font color=red></font>UNIX/Linux  selectpollepoll \n\n- selectIOI/OfdIO\n- pollselect****\n- epollepollI/O****\n\n```java\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.SelectionKey;\nimport java.nio.channels.Selector;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.Iterator;\nimport java.util.Set;\n\npublic class OtherTest {\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        Selector selector = Selector.open();\n        serverSocketChannel.socket().bind(new InetSocketAddress(6379));\n        //\n        serverSocketChannel.configureBlocking(false);\n        //ServerSocketChannelselectorOP_ACCEPT()\n        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n        //\n        while (true) {\n            if (selector.select(1000) == 0) { //select select,poll,epoll\n                System.out.println(\"========1s,=======\");\n                continue;\n            }\n            Set<SelectionKey> selectionKeys = selector.selectedKeys();\n            Iterator<SelectionKey> iterator = selectionKeys.iterator();\n            while (iterator.hasNext()) {\n                SelectionKey key = iterator.next();\n                //key\n                if (key.isAcceptable()) { //OP_ACCEPT\n                    //SoecktChannel\n                    try {\n                        SocketChannel socketChannel = serverSocketChannel.accept();\n                        socketChannel.configureBlocking(false);\n                        //socketChannelselector,socketChannelbuffer\n                        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n                //\n                if (key.isReadable()) {\n                    //keychannel\n                    SocketChannel channel = (SocketChannel) key.channel();\n                    //buffer\n                    ByteBuffer buffer = (ByteBuffer) key.attachment();\n                    try {\n                        channel.read(buffer);\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                    System.out.println(\":\" + new String(buffer.array()));\n                }\n                //selectionKey,\n                iterator.remove();\n\n            }\n        }\n    }\n}\n```\n\n\n\n### \n\n- https://www.jianshu.com/p/486b0965c296","source":"_posts/io.md","raw":"---\ntitle: IO\ntags:\n  - linux\ncategories:  linux\ndescription : IO\ndate: 2020-12-10 09:05:24\n---\n\n### \nCPU````\n\n### IO\n\n\n\n#### **IO**\n1. sys_read\n2. CPUDMAIO\n3. DMA<font color=red></font>read\n4. CPUread<font color=red></font>\n5. socket_write\n6. CPU<font color=red></font>socket\n7. DMAsocket<font color=red></font>\nIO\n\n![IO/](io/1.png)\n\n#### **IO**\n1. sys_read\n2. CPUDMAIO\n3. DMA<font color=red></font>read\n4. CPUread<font color=red></font>socket\n5. DMAsocket<font color=red></font>\nIO\n\n![IO/](io/2.png)\n\n : DMACPUIOCPUDMA\n\n### IO\n\n#### **IO**\nrecv()/recvfrom()kernelIOIOUDPkernelkernelkernelkernelblock\n\n<img src=\"io/3.png\" style=\"zoom:50%;\" />\n\n```java\nimport java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            socket.getInputStream().read(bs); // \n            System.out.println(bs);\n        }\n    }\n}\n```\nIOTCPreadTCP`IO` + ``\n\n\n\n```java\nimport java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            //TCP\n            Thread t = new Thread(() -> {\n                try {\n                    socket.getInputStream().read(bs);\n                } catch (IOException e) {\n                    e.printStackTrace();\n                }\n            });\n            t.start();\n        }\n    }\n}\n```\n\n#### **IO**\nreadkernelblockerrorreaderrorreadkernelsystem call\n\n<img src=\"io/4.png\" style=\"zoom:50%;\" />\n\naccept()read()TCPaccept()read()TCPfor\n1WTCP10**forCPU**\n```java\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.net.SocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.ArrayList;\nimport java.util.List;\n\npublic class OtherTest {\n    static List<SocketChannel> socketChannelList = new ArrayList<>();\n    static ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocket = ServerSocketChannel.open();\n        SocketAddress socketAddress = new InetSocketAddress(\"loaclhost\",6379);\n        serverSocket.bind(socketAddress);\n        serverSocket.configureBlocking(false); //\n        while (true){\n            for(SocketChannel socketChannel: socketChannelList){\n                int read = socketChannel.read(byteBuffer);\n                if(read > 0){\n                    byte[] bs = new byte[read];\n                    byteBuffer.get(bs);\n                    byteBuffer.flip();\n                }\n            }\n            SocketChannel socket = serverSocket.accept();\n            if(socket != null){\n                socket.configureBlocking(false); //\n                socketChannelList.add(socket);\n            }\n        }\n    }\n}\n```\n#### **IO**\nCPU<font color=red></font>UNIX/Linux  selectpollepoll \n\n- selectIOI/OfdIO\n- pollselect****\n- epollepollI/O****\n\n```java\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.SelectionKey;\nimport java.nio.channels.Selector;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.Iterator;\nimport java.util.Set;\n\npublic class OtherTest {\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        Selector selector = Selector.open();\n        serverSocketChannel.socket().bind(new InetSocketAddress(6379));\n        //\n        serverSocketChannel.configureBlocking(false);\n        //ServerSocketChannelselectorOP_ACCEPT()\n        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n        //\n        while (true) {\n            if (selector.select(1000) == 0) { //select select,poll,epoll\n                System.out.println(\"========1s,=======\");\n                continue;\n            }\n            Set<SelectionKey> selectionKeys = selector.selectedKeys();\n            Iterator<SelectionKey> iterator = selectionKeys.iterator();\n            while (iterator.hasNext()) {\n                SelectionKey key = iterator.next();\n                //key\n                if (key.isAcceptable()) { //OP_ACCEPT\n                    //SoecktChannel\n                    try {\n                        SocketChannel socketChannel = serverSocketChannel.accept();\n                        socketChannel.configureBlocking(false);\n                        //socketChannelselector,socketChannelbuffer\n                        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n                //\n                if (key.isReadable()) {\n                    //keychannel\n                    SocketChannel channel = (SocketChannel) key.channel();\n                    //buffer\n                    ByteBuffer buffer = (ByteBuffer) key.attachment();\n                    try {\n                        channel.read(buffer);\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                    System.out.println(\":\" + new String(buffer.array()));\n                }\n                //selectionKey,\n                iterator.remove();\n\n            }\n        }\n    }\n}\n```\n\n\n\n### \n\n- https://www.jianshu.com/p/486b0965c296","slug":"io","published":1,"updated":"2021-04-08T00:47:06.757Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhuq000hqwv2d2ae5br4","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CPU<code></code><code></code></p>\n<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><p></p>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><ol>\n<li>sys_read</li>\n<li>CPUDMAIO</li>\n<li>DMA<font color=\"red\"></font>read</li>\n<li>CPUread<font color=\"red\"></font></li>\n<li>socket_write</li>\n<li>CPU<font color=\"red\"></font>socket</li>\n<li>DMAsocket<font color=\"red\"></font><br>IO</li>\n</ol>\n<p><img src=\"/2020/12/10/io/1.png\" alt=\"IO/\"></p>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><ol>\n<li>sys_read</li>\n<li>CPUDMAIO</li>\n<li>DMA<font color=\"red\"></font>read</li>\n<li>CPUread<font color=\"red\"></font>socket</li>\n<li>DMAsocket<font color=\"red\"></font><br>IO</li>\n</ol>\n<p><img src=\"/2020/12/10/io/2.png\" alt=\"IO/\"></p>\n<p> : DMACPUIOCPUDMA</p>\n<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>recv()/recvfrom()kernelIOIOUDPkernelkernelkernelkernelblock</p>\n<img src=\"/2020/12/10/io/3.png\" style=\"zoom:50%;\">\n\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>IOException<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>ServerSocket<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>Socket<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException <span class=\"token punctuation\">{</span>\n        ServerSocket serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            Socket socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// </span>\n            socket<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// </span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>IOTCPreadTCP<code>IO</code> + <code></code></p>\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>IOException<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>ServerSocket<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>Socket<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException <span class=\"token punctuation\">{</span>\n        ServerSocket serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            Socket socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// </span>\n            <span class=\"token comment\" spellcheck=\"true\">//TCP</span>\n            Thread t <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    socket<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            t<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>readkernelblockerrorreaderrorreadkernelsystem call</p>\n<img src=\"/2020/12/10/io/4.png\" style=\"zoom:50%;\">\n\n<p>accept()read()TCPaccept()read()TCPfor<br>1WTCP10<strong>forCPU</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>IOException<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>InetSocketAddress<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>SocketAddress<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>ByteBuffer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>ServerSocketChannel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>SocketChannel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>ArrayList<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>List<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> List<span class=\"token operator\">&lt;</span>SocketChannel<span class=\"token operator\">></span> socketChannelList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> ByteBuffer byteBuffer <span class=\"token operator\">=</span> ByteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException <span class=\"token punctuation\">{</span>\n        ServerSocketChannel serverSocket <span class=\"token operator\">=</span> ServerSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        SocketAddress socketAddress <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"loaclhost\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>socketAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>SocketChannel socketChannel<span class=\"token operator\">:</span> socketChannelList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">int</span> read <span class=\"token operator\">=</span> socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>byteBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>read <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">byte</span><span class=\"token punctuation\">[</span>read<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    byteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    byteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            SocketChannel socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>socket <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                socket<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                socketChannelList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>CPU<font color=\"red\"></font>UNIX/Linux  selectpollepoll </p>\n<ul>\n<li>selectIOI/OfdIO</li>\n<li>pollselect<strong></strong></li>\n<li>epollepollI/O<strong></strong></li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>IOException<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>InetSocketAddress<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>ByteBuffer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>SelectionKey<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>Selector<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>ServerSocketChannel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>SocketChannel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>Iterator<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>Set<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> IOException <span class=\"token punctuation\">{</span>\n        ServerSocketChannel serverSocketChannel <span class=\"token operator\">=</span> ServerSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Selector selector <span class=\"token operator\">=</span> Selector<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        serverSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//ServerSocketChannelselectorOP_ACCEPT()</span>\n        serverSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> SelectionKey<span class=\"token punctuation\">.</span>OP_ACCEPT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">//select select,poll,epoll</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"========1s,=======\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            Set<span class=\"token operator\">&lt;</span>SelectionKey<span class=\"token operator\">></span> selectionKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Iterator<span class=\"token operator\">&lt;</span>SelectionKey<span class=\"token operator\">></span> iterator <span class=\"token operator\">=</span> selectionKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                SelectionKey key <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//key</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">//OP_ACCEPT</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//SoecktChannel</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        SocketChannel socketChannel <span class=\"token operator\">=</span> serverSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token comment\" spellcheck=\"true\">//socketChannelselector,socketChannelbuffer</span>\n                        socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> SelectionKey<span class=\"token punctuation\">.</span>OP_READ<span class=\"token punctuation\">,</span> ByteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//keychannel</span>\n                    SocketChannel channel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SocketChannel<span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//buffer</span>\n                    ByteBuffer buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ByteBuffer<span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        channel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token comment\" spellcheck=\"true\">//selectionKey,</span>\n                iterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><a href=\"https://www.jianshu.com/p/486b0965c296\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/486b0965c296</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CPU<code></code><code></code></p>\n<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><p></p>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><ol>\n<li>sys_read</li>\n<li>CPUDMAIO</li>\n<li>DMA<font color=\"red\"></font>read</li>\n<li>CPUread<font color=\"red\"></font></li>\n<li>socket_write</li>\n<li>CPU<font color=\"red\"></font>socket</li>\n<li>DMAsocket<font color=\"red\"></font><br>IO</li>\n</ol>\n<p><img src=\"/2020/12/10/io/1.png\" alt=\"IO/\"></p>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><ol>\n<li>sys_read</li>\n<li>CPUDMAIO</li>\n<li>DMA<font color=\"red\"></font>read</li>\n<li>CPUread<font color=\"red\"></font>socket</li>\n<li>DMAsocket<font color=\"red\"></font><br>IO</li>\n</ol>\n<p><img src=\"/2020/12/10/io/2.png\" alt=\"IO/\"></p>\n<p> : DMACPUIOCPUDMA</p>\n<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>recv()/recvfrom()kernelIOIOUDPkernelkernelkernelkernelblock</p>\n<img src=\"/2020/12/10/io/3.png\" style=\"zoom:50%;\">\n\n<pre><code class=\"java\">import java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            socket.getInputStream().read(bs); // \n            System.out.println(bs);\n        }\n    }\n}</code></pre>\n<p>IOTCPreadTCP<code>IO</code> + <code></code></p>\n<p></p>\n<pre><code class=\"java\">import java.io.IOException;\nimport java.net.ServerSocket;\nimport java.net.Socket;\npublic class OtherTest {\n    static byte[] bs = new byte[1024];\n    public static void main(String[] args) throws IOException {\n        ServerSocket serverSocket = new ServerSocket(6379);\n        while (true){\n            Socket socket = serverSocket.accept(); // \n            //TCP\n            Thread t = new Thread(() -&gt; {\n                try {\n                    socket.getInputStream().read(bs);\n                } catch (IOException e) {\n                    e.printStackTrace();\n                }\n            });\n            t.start();\n        }\n    }\n}</code></pre>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>readkernelblockerrorreaderrorreadkernelsystem call</p>\n<img src=\"/2020/12/10/io/4.png\" style=\"zoom:50%;\">\n\n<p>accept()read()TCPaccept()read()TCPfor<br>1WTCP10<strong>forCPU</strong></p>\n<pre><code class=\"java\">import java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.net.SocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.ArrayList;\nimport java.util.List;\n\npublic class OtherTest {\n    static List&lt;SocketChannel&gt; socketChannelList = new ArrayList&lt;&gt;();\n    static ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocket = ServerSocketChannel.open();\n        SocketAddress socketAddress = new InetSocketAddress(&quot;loaclhost&quot;,6379);\n        serverSocket.bind(socketAddress);\n        serverSocket.configureBlocking(false); //\n        while (true){\n            for(SocketChannel socketChannel: socketChannelList){\n                int read = socketChannel.read(byteBuffer);\n                if(read &gt; 0){\n                    byte[] bs = new byte[read];\n                    byteBuffer.get(bs);\n                    byteBuffer.flip();\n                }\n            }\n            SocketChannel socket = serverSocket.accept();\n            if(socket != null){\n                socket.configureBlocking(false); //\n                socketChannelList.add(socket);\n            }\n        }\n    }\n}</code></pre>\n<h4 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a><strong>IO</strong></h4><p>CPU<font color=\"red\"></font>UNIX/Linux  selectpollepoll </p>\n<ul>\n<li>selectIOI/OfdIO</li>\n<li>pollselect<strong></strong></li>\n<li>epollepollI/O<strong></strong></li>\n</ul>\n<pre><code class=\"java\">import java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.SelectionKey;\nimport java.nio.channels.Selector;\nimport java.nio.channels.ServerSocketChannel;\nimport java.nio.channels.SocketChannel;\nimport java.util.Iterator;\nimport java.util.Set;\n\npublic class OtherTest {\n    public static void main(String[] args) throws IOException {\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        Selector selector = Selector.open();\n        serverSocketChannel.socket().bind(new InetSocketAddress(6379));\n        //\n        serverSocketChannel.configureBlocking(false);\n        //ServerSocketChannelselectorOP_ACCEPT()\n        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n        //\n        while (true) {\n            if (selector.select(1000) == 0) { //select select,poll,epoll\n                System.out.println(&quot;========1s,=======&quot;);\n                continue;\n            }\n            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();\n            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();\n            while (iterator.hasNext()) {\n                SelectionKey key = iterator.next();\n                //key\n                if (key.isAcceptable()) { //OP_ACCEPT\n                    //SoecktChannel\n                    try {\n                        SocketChannel socketChannel = serverSocketChannel.accept();\n                        socketChannel.configureBlocking(false);\n                        //socketChannelselector,socketChannelbuffer\n                        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n                //\n                if (key.isReadable()) {\n                    //keychannel\n                    SocketChannel channel = (SocketChannel) key.channel();\n                    //buffer\n                    ByteBuffer buffer = (ByteBuffer) key.attachment();\n                    try {\n                        channel.read(buffer);\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                    System.out.println(&quot;:&quot; + new String(buffer.array()));\n                }\n                //selectionKey,\n                iterator.remove();\n\n            }\n        }\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><a href=\"https://www.jianshu.com/p/486b0965c296\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/486b0965c296</a></li>\n</ul>\n"},{"title":"HashMap","description":"HashMap","date":"2020-07-27T16:00:00.000Z","_content":"## \n### \n- \n- \n\n### \n\n- \n- \n\n### HashMap\n\nHashMap\n\n![HashMap](hashmap/1.png)\n<!--more-->\n### \n\nHash<font color=red></font>Hash<font color=red></font><font color=red>Hash</font><font color=red></font>\n\nHash\n\n- hash\n- hash\n- \n- hash\n\nhashhashhash\n\n## HashMap\n### HahMap\n\nHashMapMapCloneableSerializable\n\n![HashMap](hashmap/2.png)\n\n### Node\n\nHashMapNodeHashhashNode\n\n```java\nstatic class Node<K,V> implements Map.Entry<K,V> {\n    final int hash; //hashkeyhashCode\"\"\n    final K key;\n    V value;\n    Node<K,V> next;\n\n    Node(int hash, K key, V value, Node<K,V> next) {\n        this.hash = hash;\n        this.key = key;\n        this.value = value;\n        this.next = next;\n    }\n\n    public final int hashCode() {\n        return Objects.hashCode(key) ^ Objects.hashCode(value);\n    }\n}\n```\n\n### \n\n<font color=red>++</font>\n\n?<font color=red>864</font>\n\n![HashMap](hashmap/3.png)\n\n### put\n\n![put](hashmap/4.png)\n\n### JDK8\n\nhash\n\n## Hash\n\n### HashMap\n\n```java\n//,16\nstatic final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16\n//\nstatic final int MAXIMUM_CAPACITY = 1 << 30;\n//\nstatic final float DEFAULT_LOAD_FACTOR = 0.75f;\n//\nstatic final int TREEIFY_THRESHOLD = 8;\n//\nstatic final int UNTREEIFY_THRESHOLD = 6;\n//\nstatic final int MIN_TREEIFY_CAPACITY = 64;\n//hash\ntransient Node<K,V>[] table;\n//hash\ntransient int size;\n//hash\ntransient int modCount;\n//\nint threshold;\n//, threshold = capacity() * loadFactor\nfinal float loadFactor;\n```\n\n### \n\n```java\n\npublic HashMap() {\n    this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted\n}\n\npublic HashMap(int initialCapacity) {\n    this(initialCapacity, DEFAULT_LOAD_FACTOR);\n}\n\npublic HashMap(int initialCapacity, float loadFactor) {\n    //0\n    if (initialCapacity < 0)\n        throw new IllegalArgumentException(\"Illegal initial capacity: \" +\n                                           initialCapacity);\n    //\n    if (initialCapacity > MAXIMUM_CAPACITY)\n        initialCapacity = MAXIMUM_CAPACITY;\n    //0\n    if (loadFactor <= 0 || Float.isNaN(loadFactor))\n        throw new IllegalArgumentException(\"Illegal load factor: \" +\n                                           loadFactor);\n    //\n    this.loadFactor = loadFactor;\n    //  \n    //thresholdHashMap\n    this.threshold = tableSizeFor(initialCapacity);\n}\n\n//initialCapacityHashmap2\n// : cap2\nstatic final int tableSizeFor(int cap) {\n        int n = cap - 1; \n        n |= n >>> 1; \n        n |= n >>> 2; \n        n |= n >>> 4; \n        n |= n >>> 8; \n        n |= n >>> 16;\n        return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n}\n```\n\n### put\n\n```java\npublic V put(K key, V value) {\n        return putVal(hash(key), key, value, false, true);\n}\n```\n\n```java\n//hashhash\n//:keyhash16\nstatic final int hash(Object key) {\n        int h;\n        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n\n```java\n\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,\n                   boolean evict) {\n    \t//tab -- hashMap\n    \t//p -- \n    \t//n --  i -- \n        Node<K,V>[] tab; Node<K,V> p; int n, i;\n    \t//==nullresize\n    \t//hashMap\n        if ((tab = table) == null || (n = tab.length) == 0)\n            n = (tab = resize()).length;\n    \n    \t// (n - 1) & hash \n    \t// null,newNode\n        if ((p = tab[i = (n - 1) & hash]) == null)\n            tab[i] = newNode(hash, key, value, null);\n        else {\n            //e -- nodek -- key\n            Node<K,V> e; K k;\n            //p\n            //keye = p,\n            //equal,hashMapequal\n            if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k))))\n                e = p;\n            \n            //p\n            else if (p instanceof TreeNode)\n                e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);\n            \n            else {\n                //forkey\n                //keykey\n                for (int binCount = 0; ; ++binCount) {\n                    //\n                    if ((e = p.next) == null) {\n                        //key-value\n                        p.next = newNode(hash, key, value, null);\n                        //>=8\n                        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                            treeifyBin(tab, hash);\n                        break;\n                    }\n                    //key\n                    if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k))))\n                        break;\n                    p = e;\n                }\n            }\n            \n            //value\n            if (e != null) { // existing mapping for key\n                V oldValue = e.value;\n                if (!onlyIfAbsent || oldValue == null)\n                    e.value = value;\n                afterNodeAccess(e);\n                return oldValue;\n            }\n        }\n        ++modCount; //\n    \t// >   \n        if (++size > threshold)\n            resize();\n        afterNodeInsertion(evict);\n        return null;\n}\n```\n\n### \n\n![1632](hashmap/5.png)\n\n<font color=red>1531</font>\n\nhash & (table.length - 1)<font color=red>+</font>\n\n16 15153115 + 16\n\n```java\n//\nfinal Node<K,V>[] resize() {\n    //oldTab -- \n    Node<K,V>[] oldTab = table;\n    //oldCap -- \n    int oldCap = (oldTab == null) ? 0 : oldTab.length;\n    //oldThr -- \n    int oldThr = threshold;\n    //newCap -- \n    //newThr -- \n    int newCap, newThr = 0;\n    \n    //===================newCapnewThr=============================\n    //\n    if (oldCap > 0) {\n        //,int\n        if (oldCap >= MAXIMUM_CAPACITY) {\n            threshold = Integer.MAX_VALUE;\n            return oldTab;\n        }\n        //newCap = oldCap << 1 \n        //   >= 16 \n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY && oldCap >= DEFAULT_INITIAL_CAPACITY)\n            newThr = oldThr << 1;\n    }\n    //oldCap = 0 , hashmapnew HashMap(15)\n    //oldThrnew hashmapnew HashMap0\n    else if (oldThr > 0)\n        newCap = oldThr;\n    else {\n        //oldThr = 0 16 16 * 0.75\n        //new HashMap()\n        newCap = DEFAULT_INITIAL_CAPACITY;\n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n    }\n    //newThr == 0,newCap  loadFactornewThr\n    if (newThr == 0) {\n        float ft = (float)newCap * loadFactor;\n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?\n                  (int)ft : Integer.MAX_VALUE);\n    }\n    //==========================================================================\n   \n    threshold = newThr; //\n    // \n    Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap]; \n    table = newTab;\n    //oldTab =! null hashmaptablenull,\n    if (oldTab != null) {\n        //\n        for (int j = 0; j < oldCap; ++j) {\n            //e -- Node\n            Node<K,V> e;\n            // \n            if ((e = oldTab[j]) != null) {\n                oldTab[j] = null;\n                //\n                if (e.next == null){\n                    //\n                    newTab[e.hash & (newCap - 1)] = e;\n                }\n                else if (e instanceof TreeNode){\n                    //\n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);\n                }else {\n                    // \n                    //:\n                    Node<K,V> loHead = null, loTail = null;\n                    //: + \n                    Node<K,V> hiHead = null, hiTail = null;\n                    Node<K,V> next;\n                    \n                    do {\n                        next = e.next;\n                        //(e.hash & oldCap) == 0 \n                        if ((e.hash & oldCap) == 0) {\n                            if (loTail == null)\n                                loHead = e;\n                            else\n                                loTail.next = e;\n                            loTail = e;\n                        }\n                        else {\n                            if (hiTail == null)\n                                hiHead = e;\n                            else\n                                hiTail.next = e;\n                            hiTail = e;\n                        }\n                    } while ((e = next) != null);\n                    \n                    //\n                    if (loTail != null) {\n                        loTail.next = null;\n                        newTab[j] = loHead;\n                    }\n                     //\n                    if (hiTail != null) {\n                        hiTail.next = null;\n                        newTab[j + oldCap] = hiHead;\n                    }\n                }\n            }\n        }\n    }\n    return newTab;\n}\n```\n\n### get\n\n```java\npublic V get(Object key) {\n    Node<K,V> e;\n    return (e = getNode(hash(key), key)) == null ? null : e.value;\n}\n\nfinal Node<K,V> getNode(int hash, Object key) {\n    // tab : hashMap\n    //first : \n    //n : \n    //e : node\n    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;\n    \n    if ((tab = table) != null && (n = tab.length) > 0 && (first = tab[(n - 1) & hash]) != null) {\n        //:\n        if (first.hash == hash && ((k = first.key) == key || (key != null && key.equals(k))))\n            return first;\n        //:\n        if ((e = first.next) != null) {\n            if (first instanceof TreeNode)\n                return ((TreeNode<K,V>)first).getTreeNode(hash, key);\n            //for\n            do {\n                if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k))) )\n                    return e;\n            } while ((e = e.next) != null);\n        }\n    }\n    return null;\n}\n```\n\n### remove\n\n```java\npublic V remove(Object key) {\n    Node<K,V> e;\n    return (e = removeNode(hash(key), key, null, false, true)) == null ?\n        null : e.value;\n}\n\nfinal Node<K,V> removeNode(int hash, Object key, Object value,\n                           boolean matchValue, boolean movable) {\n    //tab : hashmap\n    //p : node\n    //n : \n    //index \n    Node<K,V>[] tab; Node<K,V> p; int n, index;\n    //\n    if ((tab = table) != null && (n = tab.length) > 0 && (p = tab[index = (n - 1) & hash]) != null ) {\n        //node : \n        //e : Node\n        Node<K,V> node = null, e; K k; V v;\n        //\n        if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))){\n            node = p;\n        }else if ((e = p.next) != null) {\n            if (p instanceof TreeNode){\n                //\n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);\n            }else {\n                //\n                do {\n                    if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k)))) {\n                        node = e;\n                        break;\n                    }\n                    p = e;\n                } while ((e = e.next) != null);\n            }\n        }\n        //\n        if (node != null && (!matchValue || (v = node.value) == value ||\n                             (value != null && value.equals(v)))) {\n            if (node instanceof TreeNode)\n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);\n            else if (node == p)\n                tab[index] = node.next;\n            else\n                p.next = node.next;\n            ++modCount;\n            --size;\n            afterNodeRemoval(node);\n            return node;\n        }\n    }\n    return null;\n}\n```\n\n\n\n## \n\n- 864\n- HashMapHash<font color=red></font>\n- HashMap16 16  * 0.75 = 12\n- \n- HashMap : hash[<font color=red>hash</font>] & (table.length[<font color=red>2</font>] - 1) \n- +\n\n## HashMap\n\n### hashCodeequals()\n\nhashCodeequals\n\n- equalshashCode**equalshashCode**\n- equalshashCode\n- hashCodeequals\n\nHashMaphashCode()equals\n\n** hashCode equals()**\n\nhashcodehashcode\n\nhashcodehashcode**hashcodehash**hashcode\n\n()hashhashcode**hashcodehashhash hashcode1hashcode2()345678AA17()17%8=1Ahashcode1Ahash1**\n\n**hashcode** 1000999hashCodeAhashhashcode1BEGABEG\n\nhashCodeequalshashCodeequals\n\n### HashMap()\n\n```java\n^ :  01\n(h = key.hashCode()) ^ (h >>> 16)\n```\n\nJDK1.8hashCode()161616hash\n\n**** hashCode  32  hash() \n\n### HashMap\n\n\n\nnew HashMap()1616 * 0.75 = 12HashMap123224\n\n### JDK1.71.8\n\n- JDK1.7\n- JDK1.8\n  - `hash & ( - 1)`\n  - `hash &  == 0 ?`00=  + 1.8hash```+`\n- 1.71.8\n\n### JDK1.8\n\n**JDK8+**\n\n  `hash & (n - 1)`n2`n-1`2-11<font color=red></font>\n\n```java\n16 - 1   1111\n32 - 1   11111\nint[] number = {19,20,12,34,343,123,33,45,66,234,545};\nfor(int i : number){\n     System.out.println(      (i & (32 -1))         -          (i & (16 -1))           );\n}\n//  0  16    \n```\n\n\n\n### \n\n- \n- \n\n## \n\n- \n- HashMap","source":"_posts/hashmap.md","raw":"---\ntitle: HashMap\ntags:\n  - java\ncategories:  java\ndescription :  HashMap\ndate: 2020-07-28\n---\n## \n### \n- \n- \n\n### \n\n- \n- \n\n### HashMap\n\nHashMap\n\n![HashMap](hashmap/1.png)\n<!--more-->\n### \n\nHash<font color=red></font>Hash<font color=red></font><font color=red>Hash</font><font color=red></font>\n\nHash\n\n- hash\n- hash\n- \n- hash\n\nhashhashhash\n\n## HashMap\n### HahMap\n\nHashMapMapCloneableSerializable\n\n![HashMap](hashmap/2.png)\n\n### Node\n\nHashMapNodeHashhashNode\n\n```java\nstatic class Node<K,V> implements Map.Entry<K,V> {\n    final int hash; //hashkeyhashCode\"\"\n    final K key;\n    V value;\n    Node<K,V> next;\n\n    Node(int hash, K key, V value, Node<K,V> next) {\n        this.hash = hash;\n        this.key = key;\n        this.value = value;\n        this.next = next;\n    }\n\n    public final int hashCode() {\n        return Objects.hashCode(key) ^ Objects.hashCode(value);\n    }\n}\n```\n\n### \n\n<font color=red>++</font>\n\n?<font color=red>864</font>\n\n![HashMap](hashmap/3.png)\n\n### put\n\n![put](hashmap/4.png)\n\n### JDK8\n\nhash\n\n## Hash\n\n### HashMap\n\n```java\n//,16\nstatic final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16\n//\nstatic final int MAXIMUM_CAPACITY = 1 << 30;\n//\nstatic final float DEFAULT_LOAD_FACTOR = 0.75f;\n//\nstatic final int TREEIFY_THRESHOLD = 8;\n//\nstatic final int UNTREEIFY_THRESHOLD = 6;\n//\nstatic final int MIN_TREEIFY_CAPACITY = 64;\n//hash\ntransient Node<K,V>[] table;\n//hash\ntransient int size;\n//hash\ntransient int modCount;\n//\nint threshold;\n//, threshold = capacity() * loadFactor\nfinal float loadFactor;\n```\n\n### \n\n```java\n\npublic HashMap() {\n    this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted\n}\n\npublic HashMap(int initialCapacity) {\n    this(initialCapacity, DEFAULT_LOAD_FACTOR);\n}\n\npublic HashMap(int initialCapacity, float loadFactor) {\n    //0\n    if (initialCapacity < 0)\n        throw new IllegalArgumentException(\"Illegal initial capacity: \" +\n                                           initialCapacity);\n    //\n    if (initialCapacity > MAXIMUM_CAPACITY)\n        initialCapacity = MAXIMUM_CAPACITY;\n    //0\n    if (loadFactor <= 0 || Float.isNaN(loadFactor))\n        throw new IllegalArgumentException(\"Illegal load factor: \" +\n                                           loadFactor);\n    //\n    this.loadFactor = loadFactor;\n    //  \n    //thresholdHashMap\n    this.threshold = tableSizeFor(initialCapacity);\n}\n\n//initialCapacityHashmap2\n// : cap2\nstatic final int tableSizeFor(int cap) {\n        int n = cap - 1; \n        n |= n >>> 1; \n        n |= n >>> 2; \n        n |= n >>> 4; \n        n |= n >>> 8; \n        n |= n >>> 16;\n        return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n}\n```\n\n### put\n\n```java\npublic V put(K key, V value) {\n        return putVal(hash(key), key, value, false, true);\n}\n```\n\n```java\n//hashhash\n//:keyhash16\nstatic final int hash(Object key) {\n        int h;\n        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);\n}\n```\n\n```java\n\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,\n                   boolean evict) {\n    \t//tab -- hashMap\n    \t//p -- \n    \t//n --  i -- \n        Node<K,V>[] tab; Node<K,V> p; int n, i;\n    \t//==nullresize\n    \t//hashMap\n        if ((tab = table) == null || (n = tab.length) == 0)\n            n = (tab = resize()).length;\n    \n    \t// (n - 1) & hash \n    \t// null,newNode\n        if ((p = tab[i = (n - 1) & hash]) == null)\n            tab[i] = newNode(hash, key, value, null);\n        else {\n            //e -- nodek -- key\n            Node<K,V> e; K k;\n            //p\n            //keye = p,\n            //equal,hashMapequal\n            if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k))))\n                e = p;\n            \n            //p\n            else if (p instanceof TreeNode)\n                e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);\n            \n            else {\n                //forkey\n                //keykey\n                for (int binCount = 0; ; ++binCount) {\n                    //\n                    if ((e = p.next) == null) {\n                        //key-value\n                        p.next = newNode(hash, key, value, null);\n                        //>=8\n                        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                            treeifyBin(tab, hash);\n                        break;\n                    }\n                    //key\n                    if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k))))\n                        break;\n                    p = e;\n                }\n            }\n            \n            //value\n            if (e != null) { // existing mapping for key\n                V oldValue = e.value;\n                if (!onlyIfAbsent || oldValue == null)\n                    e.value = value;\n                afterNodeAccess(e);\n                return oldValue;\n            }\n        }\n        ++modCount; //\n    \t// >   \n        if (++size > threshold)\n            resize();\n        afterNodeInsertion(evict);\n        return null;\n}\n```\n\n### \n\n![1632](hashmap/5.png)\n\n<font color=red>1531</font>\n\nhash & (table.length - 1)<font color=red>+</font>\n\n16 15153115 + 16\n\n```java\n//\nfinal Node<K,V>[] resize() {\n    //oldTab -- \n    Node<K,V>[] oldTab = table;\n    //oldCap -- \n    int oldCap = (oldTab == null) ? 0 : oldTab.length;\n    //oldThr -- \n    int oldThr = threshold;\n    //newCap -- \n    //newThr -- \n    int newCap, newThr = 0;\n    \n    //===================newCapnewThr=============================\n    //\n    if (oldCap > 0) {\n        //,int\n        if (oldCap >= MAXIMUM_CAPACITY) {\n            threshold = Integer.MAX_VALUE;\n            return oldTab;\n        }\n        //newCap = oldCap << 1 \n        //   >= 16 \n        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY && oldCap >= DEFAULT_INITIAL_CAPACITY)\n            newThr = oldThr << 1;\n    }\n    //oldCap = 0 , hashmapnew HashMap(15)\n    //oldThrnew hashmapnew HashMap0\n    else if (oldThr > 0)\n        newCap = oldThr;\n    else {\n        //oldThr = 0 16 16 * 0.75\n        //new HashMap()\n        newCap = DEFAULT_INITIAL_CAPACITY;\n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n    }\n    //newThr == 0,newCap  loadFactornewThr\n    if (newThr == 0) {\n        float ft = (float)newCap * loadFactor;\n        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?\n                  (int)ft : Integer.MAX_VALUE);\n    }\n    //==========================================================================\n   \n    threshold = newThr; //\n    // \n    Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap]; \n    table = newTab;\n    //oldTab =! null hashmaptablenull,\n    if (oldTab != null) {\n        //\n        for (int j = 0; j < oldCap; ++j) {\n            //e -- Node\n            Node<K,V> e;\n            // \n            if ((e = oldTab[j]) != null) {\n                oldTab[j] = null;\n                //\n                if (e.next == null){\n                    //\n                    newTab[e.hash & (newCap - 1)] = e;\n                }\n                else if (e instanceof TreeNode){\n                    //\n                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);\n                }else {\n                    // \n                    //:\n                    Node<K,V> loHead = null, loTail = null;\n                    //: + \n                    Node<K,V> hiHead = null, hiTail = null;\n                    Node<K,V> next;\n                    \n                    do {\n                        next = e.next;\n                        //(e.hash & oldCap) == 0 \n                        if ((e.hash & oldCap) == 0) {\n                            if (loTail == null)\n                                loHead = e;\n                            else\n                                loTail.next = e;\n                            loTail = e;\n                        }\n                        else {\n                            if (hiTail == null)\n                                hiHead = e;\n                            else\n                                hiTail.next = e;\n                            hiTail = e;\n                        }\n                    } while ((e = next) != null);\n                    \n                    //\n                    if (loTail != null) {\n                        loTail.next = null;\n                        newTab[j] = loHead;\n                    }\n                     //\n                    if (hiTail != null) {\n                        hiTail.next = null;\n                        newTab[j + oldCap] = hiHead;\n                    }\n                }\n            }\n        }\n    }\n    return newTab;\n}\n```\n\n### get\n\n```java\npublic V get(Object key) {\n    Node<K,V> e;\n    return (e = getNode(hash(key), key)) == null ? null : e.value;\n}\n\nfinal Node<K,V> getNode(int hash, Object key) {\n    // tab : hashMap\n    //first : \n    //n : \n    //e : node\n    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;\n    \n    if ((tab = table) != null && (n = tab.length) > 0 && (first = tab[(n - 1) & hash]) != null) {\n        //:\n        if (first.hash == hash && ((k = first.key) == key || (key != null && key.equals(k))))\n            return first;\n        //:\n        if ((e = first.next) != null) {\n            if (first instanceof TreeNode)\n                return ((TreeNode<K,V>)first).getTreeNode(hash, key);\n            //for\n            do {\n                if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k))) )\n                    return e;\n            } while ((e = e.next) != null);\n        }\n    }\n    return null;\n}\n```\n\n### remove\n\n```java\npublic V remove(Object key) {\n    Node<K,V> e;\n    return (e = removeNode(hash(key), key, null, false, true)) == null ?\n        null : e.value;\n}\n\nfinal Node<K,V> removeNode(int hash, Object key, Object value,\n                           boolean matchValue, boolean movable) {\n    //tab : hashmap\n    //p : node\n    //n : \n    //index \n    Node<K,V>[] tab; Node<K,V> p; int n, index;\n    //\n    if ((tab = table) != null && (n = tab.length) > 0 && (p = tab[index = (n - 1) & hash]) != null ) {\n        //node : \n        //e : Node\n        Node<K,V> node = null, e; K k; V v;\n        //\n        if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))){\n            node = p;\n        }else if ((e = p.next) != null) {\n            if (p instanceof TreeNode){\n                //\n                node = ((TreeNode<K,V>)p).getTreeNode(hash, key);\n            }else {\n                //\n                do {\n                    if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k)))) {\n                        node = e;\n                        break;\n                    }\n                    p = e;\n                } while ((e = e.next) != null);\n            }\n        }\n        //\n        if (node != null && (!matchValue || (v = node.value) == value ||\n                             (value != null && value.equals(v)))) {\n            if (node instanceof TreeNode)\n                ((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);\n            else if (node == p)\n                tab[index] = node.next;\n            else\n                p.next = node.next;\n            ++modCount;\n            --size;\n            afterNodeRemoval(node);\n            return node;\n        }\n    }\n    return null;\n}\n```\n\n\n\n## \n\n- 864\n- HashMapHash<font color=red></font>\n- HashMap16 16  * 0.75 = 12\n- \n- HashMap : hash[<font color=red>hash</font>] & (table.length[<font color=red>2</font>] - 1) \n- +\n\n## HashMap\n\n### hashCodeequals()\n\nhashCodeequals\n\n- equalshashCode**equalshashCode**\n- equalshashCode\n- hashCodeequals\n\nHashMaphashCode()equals\n\n** hashCode equals()**\n\nhashcodehashcode\n\nhashcodehashcode**hashcodehash**hashcode\n\n()hashhashcode**hashcodehashhash hashcode1hashcode2()345678AA17()17%8=1Ahashcode1Ahash1**\n\n**hashcode** 1000999hashCodeAhashhashcode1BEGABEG\n\nhashCodeequalshashCodeequals\n\n### HashMap()\n\n```java\n^ :  01\n(h = key.hashCode()) ^ (h >>> 16)\n```\n\nJDK1.8hashCode()161616hash\n\n**** hashCode  32  hash() \n\n### HashMap\n\n\n\nnew HashMap()1616 * 0.75 = 12HashMap123224\n\n### JDK1.71.8\n\n- JDK1.7\n- JDK1.8\n  - `hash & ( - 1)`\n  - `hash &  == 0 ?`00=  + 1.8hash```+`\n- 1.71.8\n\n### JDK1.8\n\n**JDK8+**\n\n  `hash & (n - 1)`n2`n-1`2-11<font color=red></font>\n\n```java\n16 - 1   1111\n32 - 1   11111\nint[] number = {19,20,12,34,343,123,33,45,66,234,545};\nfor(int i : number){\n     System.out.println(      (i & (32 -1))         -          (i & (16 -1))           );\n}\n//  0  16    \n```\n\n\n\n### \n\n- \n- \n\n## \n\n- \n- HashMap","slug":"hashmap","published":1,"updated":"2021-11-23T06:25:51.471Z","_id":"ckn9yvhur000kqwv2a85nbo4u","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><p>HashMap</p>\n<p><img src=\"/2020/07/28/hashmap/1.png\" alt=\"HashMap\"></p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Hash<font color=\"red\"></font>Hash<font color=\"red\"></font><font color=\"red\">Hash</font><font color=\"red\"></font></p>\n<p>Hash</p>\n<ul>\n<li>hash</li>\n<li>hash</li>\n<li></li>\n<li>hash</li>\n</ul>\n<p>hashhashhash</p>\n<h2 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h2><h3 id=\"HahMap\"><a href=\"#HahMap\" class=\"headerlink\" title=\"HahMap\"></a>HahMap</h3><p>HashMapMapCloneableSerializable</p>\n<p><img src=\"/2020/07/28/hashmap/2.png\" alt=\"HashMap\"></p>\n<h3 id=\"Node\"><a href=\"#Node\" class=\"headerlink\" title=\"Node\"></a>Node</h3><p>HashMapNodeHashhashNode</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//hashkeyhashCode\"\"</span>\n    <span class=\"token keyword\">final</span> K key<span class=\"token punctuation\">;</span>\n    V value<span class=\"token punctuation\">;</span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> next<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">Node</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> K key<span class=\"token punctuation\">,</span> V value<span class=\"token punctuation\">,</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>hash <span class=\"token operator\">=</span> hash<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> key<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Objects<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> Objects<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><font color=\"red\">++</font></p>\n<p>?<font color=\"red\">864</font></p>\n<p><img src=\"/2020/07/28/hashmap/3.png\" alt=\"HashMap\"></p>\n<h3 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h3><p><img src=\"/2020/07/28/hashmap/4.png\" alt=\"put\"></p>\n<h3 id=\"JDK8\"><a href=\"#JDK8\" class=\"headerlink\" title=\"JDK8\"></a>JDK8</h3><p>hash</p>\n<h2 id=\"Hash\"><a href=\"#Hash\" class=\"headerlink\" title=\"Hash\"></a>Hash</h2><h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//,16</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> DEFAULT_INITIAL_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// aka 16</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> MAXIMUM_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">float</span> DEFAULT_LOAD_FACTOR <span class=\"token operator\">=</span> <span class=\"token number\">0.75f</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> TREEIFY_THRESHOLD <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> UNTREEIFY_THRESHOLD <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> MIN_TREEIFY_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//hash</span>\n<span class=\"token keyword\">transient</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> table<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//hash</span>\n<span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//hash</span>\n<span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> modCount<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">int</span> threshold<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//, threshold = capacity() * loadFactor</span>\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">float</span> loadFactor<span class=\"token punctuation\">;</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\">\n<span class=\"token keyword\">public</span> <span class=\"token function\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loadFactor <span class=\"token operator\">=</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// all other fields defaulted</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token function\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>initialCapacity<span class=\"token punctuation\">,</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token function\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> loadFactor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//0</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialCapacity <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal initial capacity: \"</span> <span class=\"token operator\">+</span>\n                                           initialCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialCapacity <span class=\"token operator\">></span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span>\n        initialCapacity <span class=\"token operator\">=</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//0</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loadFactor <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> Float<span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal load factor: \"</span> <span class=\"token operator\">+</span>\n                                           loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loadFactor <span class=\"token operator\">=</span> loadFactor<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//  </span>\n    <span class=\"token comment\" spellcheck=\"true\">//thresholdHashMap</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>threshold <span class=\"token operator\">=</span> <span class=\"token function\">tableSizeFor</span><span class=\"token punctuation\">(</span>initialCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//initialCapacityHashmap2</span>\n<span class=\"token comment\" spellcheck=\"true\">// : cap2</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">tableSizeFor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> cap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> cap <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n        n <span class=\"token operator\">|=</span> n <span class=\"token operator\">>>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n        n <span class=\"token operator\">|=</span> n <span class=\"token operator\">>>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> \n        n <span class=\"token operator\">|=</span> n <span class=\"token operator\">>>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> \n        n <span class=\"token operator\">|=</span> n <span class=\"token operator\">>>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> \n        n <span class=\"token operator\">|=</span> n <span class=\"token operator\">>>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">>=</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> MAXIMUM_CAPACITY <span class=\"token operator\">:</span> n <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> V <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>K key<span class=\"token punctuation\">,</span> V value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">putVal</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//hashhash</span>\n<span class=\"token comment\" spellcheck=\"true\">//:keyhash16</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>Object key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> h<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\">\n<span class=\"token keyword\">final</span> V <span class=\"token function\">putVal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> K key<span class=\"token punctuation\">,</span> V value<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> onlyIfAbsent<span class=\"token punctuation\">,</span>\n                   <span class=\"token keyword\">boolean</span> evict<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//tab -- hashMap</span>\n        <span class=\"token comment\" spellcheck=\"true\">//p -- </span>\n        <span class=\"token comment\" spellcheck=\"true\">//n --  i -- </span>\n        Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab<span class=\"token punctuation\">;</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> p<span class=\"token punctuation\">;</span> <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//==nullresize</span>\n        <span class=\"token comment\" spellcheck=\"true\">//hashMap</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            n <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tab <span class=\"token operator\">=</span> <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">// (n - 1) &amp; hash </span>\n        <span class=\"token comment\" spellcheck=\"true\">// null,newNode</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>i <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> hash<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n            tab<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">newNode</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//e -- nodek -- key</span>\n            Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> e<span class=\"token punctuation\">;</span> K k<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//p</span>\n            <span class=\"token comment\" spellcheck=\"true\">//keye = p,</span>\n            <span class=\"token comment\" spellcheck=\"true\">//equal,hashMapequal</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                e <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\" spellcheck=\"true\">//p</span>\n            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TreeNode</span><span class=\"token punctuation\">)</span>\n                e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TreeNode<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">putTreeVal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> tab<span class=\"token punctuation\">,</span> hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//forkey</span>\n                <span class=\"token comment\" spellcheck=\"true\">//keykey</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> binCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>binCount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token comment\" spellcheck=\"true\">//key-value</span>\n                        p<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token function\">newNode</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token comment\" spellcheck=\"true\">//>=8</span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binCount <span class=\"token operator\">>=</span> TREEIFY_THRESHOLD <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">// -1 for 1st</span>\n                            <span class=\"token function\">treeifyBin</span><span class=\"token punctuation\">(</span>tab<span class=\"token punctuation\">,</span> hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//key</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                    p <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\" spellcheck=\"true\">//value</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">// existing mapping for key</span>\n                V oldValue <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>onlyIfAbsent <span class=\"token operator\">||</span> oldValue <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n                    e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n                <span class=\"token function\">afterNodeAccess</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">++</span>modCount<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token comment\" spellcheck=\"true\">// >   </span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>size <span class=\"token operator\">></span> threshold<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">afterNodeInsertion</span><span class=\"token punctuation\">(</span>evict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/07/28/hashmap/5.png\" alt=\"1632\"></p>\n<p><font color=\"red\">1531</font></p>\n<p>hash &amp; (table.length - 1)<font color=\"red\">+</font></p>\n<p>16 15153115 + 16</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">final</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldTab -- </span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> oldTab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldCap -- </span>\n    <span class=\"token keyword\">int</span> oldCap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>oldTab <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> oldTab<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldThr -- </span>\n    <span class=\"token keyword\">int</span> oldThr <span class=\"token operator\">=</span> threshold<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//newCap -- </span>\n    <span class=\"token comment\" spellcheck=\"true\">//newThr -- </span>\n    <span class=\"token keyword\">int</span> newCap<span class=\"token punctuation\">,</span> newThr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//===================newCapnewThr=============================</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldCap <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//,int</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldCap <span class=\"token operator\">>=</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            threshold <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> oldTab<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//newCap = oldCap &lt;&lt; 1 </span>\n        <span class=\"token comment\" spellcheck=\"true\">//   >= 16 </span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>newCap <span class=\"token operator\">=</span> oldCap <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> MAXIMUM_CAPACITY <span class=\"token operator\">&amp;&amp;</span> oldCap <span class=\"token operator\">>=</span> DEFAULT_INITIAL_CAPACITY<span class=\"token punctuation\">)</span>\n            newThr <span class=\"token operator\">=</span> oldThr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldCap = 0 , hashmapnew HashMap(15)</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldThrnew hashmapnew HashMap0</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldThr <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        newCap <span class=\"token operator\">=</span> oldThr<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//oldThr = 0 16 16 * 0.75</span>\n        <span class=\"token comment\" spellcheck=\"true\">//new HashMap()</span>\n        newCap <span class=\"token operator\">=</span> DEFAULT_INITIAL_CAPACITY<span class=\"token punctuation\">;</span>\n        newThr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>DEFAULT_LOAD_FACTOR <span class=\"token operator\">*</span> DEFAULT_INITIAL_CAPACITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//newThr == 0,newCap  loadFactornewThr</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newThr <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">float</span> ft <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>newCap <span class=\"token operator\">*</span> loadFactor<span class=\"token punctuation\">;</span>\n        newThr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>newCap <span class=\"token operator\">&lt;</span> MAXIMUM_CAPACITY <span class=\"token operator\">&amp;&amp;</span> ft <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>MAXIMUM_CAPACITY <span class=\"token operator\">?</span>\n                  <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>ft <span class=\"token operator\">:</span> Integer<span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//==========================================================================</span>\n\n    threshold <span class=\"token operator\">=</span> newThr<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token comment\" spellcheck=\"true\">// </span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> newTab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">[</span>newCap<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n    table <span class=\"token operator\">=</span> newTab<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//oldTab =! null hashmaptablenull,</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldTab <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> oldCap<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>j<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//e -- Node</span>\n            Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> e<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">// </span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> oldTab<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                oldTab<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>next <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    newTab<span class=\"token punctuation\">[</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>newCap <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TreeNode</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TreeNode<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> newTab<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> oldCap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">// </span>\n                    <span class=\"token comment\" spellcheck=\"true\">//:</span>\n                    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> loHead <span class=\"token operator\">=</span> null<span class=\"token punctuation\">,</span> loTail <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//: + </span>\n                    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> hiHead <span class=\"token operator\">=</span> null<span class=\"token punctuation\">,</span> hiTail <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> next<span class=\"token punctuation\">;</span>\n\n                    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                        next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n                        <span class=\"token comment\" spellcheck=\"true\">//(e.hash &amp; oldCap) == 0 </span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">&amp;</span> oldCap<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loTail <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n                                loHead <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">else</span>\n                                loTail<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                            loTail <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hiTail <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span>\n                                hiHead <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">else</span>\n                                hiTail<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                            hiTail <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loTail <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        loTail<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                        newTab<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> loHead<span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                     <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hiTail <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        hiTail<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n                        newTab<span class=\"token punctuation\">[</span>j <span class=\"token operator\">+</span> oldCap<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hiHead<span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> newTab<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> V <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>Object key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> e<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> <span class=\"token function\">getNode</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null <span class=\"token operator\">?</span> null <span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">final</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> <span class=\"token function\">getNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> Object key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">// tab : hashMap</span>\n    <span class=\"token comment\" spellcheck=\"true\">//first : </span>\n    <span class=\"token comment\" spellcheck=\"true\">//n : </span>\n    <span class=\"token comment\" spellcheck=\"true\">//e : node</span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab<span class=\"token punctuation\">;</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> first<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">;</span> <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">;</span> K k<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>first <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> hash<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> first<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> first<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> first<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TreeNode</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TreeNode<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTreeNode</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//for</span>\n            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> V <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>Object key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> e<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> <span class=\"token function\">removeNode</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> null <span class=\"token operator\">?</span>\n        null <span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">final</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> <span class=\"token function\">removeNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> Object key<span class=\"token punctuation\">,</span> Object value<span class=\"token punctuation\">,</span>\n                           <span class=\"token keyword\">boolean</span> matchValue<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> movable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//tab : hashmap</span>\n    <span class=\"token comment\" spellcheck=\"true\">//p : node</span>\n    <span class=\"token comment\" spellcheck=\"true\">//n : </span>\n    <span class=\"token comment\" spellcheck=\"true\">//index </span>\n    Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab<span class=\"token punctuation\">;</span> Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> p<span class=\"token punctuation\">;</span> <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>index <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> hash<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//node : </span>\n        <span class=\"token comment\" spellcheck=\"true\">//e : Node</span>\n        Node<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> null<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">;</span> K k<span class=\"token punctuation\">;</span> V v<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            node <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TreeNode</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                node <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TreeNode<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTreeNode</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        node <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    p <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>matchValue <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>v <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> value <span class=\"token operator\">||</span>\n                             <span class=\"token punctuation\">(</span>value <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">TreeNode</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TreeNode<span class=\"token operator\">&lt;</span>K<span class=\"token punctuation\">,</span>V<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeTreeNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> tab<span class=\"token punctuation\">,</span> movable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">==</span> p<span class=\"token punctuation\">)</span>\n                tab<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">else</span>\n                p<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">++</span>modCount<span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">--</span>size<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">afterNodeRemoval</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>864</li>\n<li>HashMapHash<font color=\"red\"></font></li>\n<li>HashMap16 16  * 0.75 = 12</li>\n<li></li>\n<li>HashMap : hash[<font color=\"red\">hash</font>] &amp; (table.length[<font color=\"red\">2</font>] - 1) </li>\n<li>+</li>\n</ul>\n<h2 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h2><h3 id=\"hashCodeequals-\"><a href=\"#hashCodeequals-\" class=\"headerlink\" title=\"hashCodeequals()\"></a>hashCodeequals()</h3><p>hashCodeequals</p>\n<ul>\n<li>equalshashCode<strong>equalshashCode</strong></li>\n<li>equalshashCode</li>\n<li>hashCodeequals</li>\n</ul>\n<p>HashMaphashCode()equals</p>\n<p><strong> hashCode equals()</strong></p>\n<p>hashcodehashcode</p>\n<p>hashcodehashcode<strong>hashcodehash</strong>hashcode</p>\n<p>()hashhashcode<strong>hashcodehashhash hashcode1hashcode2()345678AA17()17%8=1Ahashcode1Ahash1</strong></p>\n<p><strong>hashcode</strong> 1000999hashCodeAhashhashcode1BEGABEG</p>\n<p>hashCodeequalshashCodeequals</p>\n<h3 id=\"HashMap--\"><a href=\"#HashMap--\" class=\"headerlink\" title=\"HashMap()\"></a>HashMap()</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token operator\">^</span> <span class=\"token operator\">:</span>  <span class=\"token number\">0</span><span class=\"token function\">1</span>\n<span class=\"token punctuation\">(</span>h <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></code></pre>\n<p>JDK1.8hashCode()161616hash</p>\n<p><strong></strong> hashCode  32  hash() </p>\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><p></p>\n<p>new HashMap()1616 * 0.75 = 12HashMap123224</p>\n<h3 id=\"JDK1-71-8\"><a href=\"#JDK1-71-8\" class=\"headerlink\" title=\"JDK1.71.8\"></a>JDK1.71.8</h3><ul>\n<li>JDK1.7</li>\n<li>JDK1.8<ul>\n<li><code>hash &amp; ( - 1)</code></li>\n<li><code>hash &amp;  == 0 ?</code>00=  + 1.8hash<code></code><code>+</code></li>\n</ul>\n</li>\n<li>1.71.8</li>\n</ul>\n<h3 id=\"JDK1-8\"><a href=\"#JDK1-8\" class=\"headerlink\" title=\"JDK1.8\"></a>JDK1.8</h3><p><strong>JDK8+</strong></p>\n<p>  <code>hash &amp; (n - 1)</code>n2<code>n-1</code>2-11<font color=\"red\"></font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token number\">16</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span>   <span class=\"token number\">1111</span>\n<span class=\"token number\">32</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span>   <span class=\"token number\">11111</span>\n<span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> number <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token number\">19</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">34</span><span class=\"token punctuation\">,</span><span class=\"token number\">343</span><span class=\"token punctuation\">,</span><span class=\"token number\">123</span><span class=\"token punctuation\">,</span><span class=\"token number\">33</span><span class=\"token punctuation\">,</span><span class=\"token number\">45</span><span class=\"token punctuation\">,</span><span class=\"token number\">66</span><span class=\"token punctuation\">,</span><span class=\"token number\">234</span><span class=\"token punctuation\">,</span><span class=\"token number\">545</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n     System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>      <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">32</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>         <span class=\"token operator\">-</span>          <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>           <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//  0  16    </span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li></li>\n<li>HashMap</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><p>HashMap</p>\n<p><img src=\"/2020/07/28/hashmap/1.png\" alt=\"HashMap\"></p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Hash<font color=\"red\"></font>Hash<font color=\"red\"></font><font color=\"red\">Hash</font><font color=\"red\"></font></p>\n<p>Hash</p>\n<ul>\n<li>hash</li>\n<li>hash</li>\n<li></li>\n<li>hash</li>\n</ul>\n<p>hashhashhash</p>\n<h2 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h2><h3 id=\"HahMap\"><a href=\"#HahMap\" class=\"headerlink\" title=\"HahMap\"></a>HahMap</h3><p>HashMapMapCloneableSerializable</p>\n<p><img src=\"/2020/07/28/hashmap/2.png\" alt=\"HashMap\"></p>\n<h3 id=\"Node\"><a href=\"#Node\" class=\"headerlink\" title=\"Node\"></a>Node</h3><p>HashMapNodeHashhashNode</p>\n<pre><code class=\"java\">static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {\n    final int hash; //hashkeyhashCode&quot;&quot;\n    final K key;\n    V value;\n    Node&lt;K,V&gt; next;\n\n    Node(int hash, K key, V value, Node&lt;K,V&gt; next) {\n        this.hash = hash;\n        this.key = key;\n        this.value = value;\n        this.next = next;\n    }\n\n    public final int hashCode() {\n        return Objects.hashCode(key) ^ Objects.hashCode(value);\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><font color=\"red\">++</font></p>\n<p>?<font color=\"red\">864</font></p>\n<p><img src=\"/2020/07/28/hashmap/3.png\" alt=\"HashMap\"></p>\n<h3 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h3><p><img src=\"/2020/07/28/hashmap/4.png\" alt=\"put\"></p>\n<h3 id=\"JDK8\"><a href=\"#JDK8\" class=\"headerlink\" title=\"JDK8\"></a>JDK8</h3><p>hash</p>\n<h2 id=\"Hash\"><a href=\"#Hash\" class=\"headerlink\" title=\"Hash\"></a>Hash</h2><h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><pre><code class=\"java\">//,16\nstatic final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16\n//\nstatic final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;\n//\nstatic final float DEFAULT_LOAD_FACTOR = 0.75f;\n//\nstatic final int TREEIFY_THRESHOLD = 8;\n//\nstatic final int UNTREEIFY_THRESHOLD = 6;\n//\nstatic final int MIN_TREEIFY_CAPACITY = 64;\n//hash\ntransient Node&lt;K,V&gt;[] table;\n//hash\ntransient int size;\n//hash\ntransient int modCount;\n//\nint threshold;\n//, threshold = capacity() * loadFactor\nfinal float loadFactor;</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">\npublic HashMap() {\n    this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted\n}\n\npublic HashMap(int initialCapacity) {\n    this(initialCapacity, DEFAULT_LOAD_FACTOR);\n}\n\npublic HashMap(int initialCapacity, float loadFactor) {\n    //0\n    if (initialCapacity &lt; 0)\n        throw new IllegalArgumentException(&quot;Illegal initial capacity: &quot; +\n                                           initialCapacity);\n    //\n    if (initialCapacity &gt; MAXIMUM_CAPACITY)\n        initialCapacity = MAXIMUM_CAPACITY;\n    //0\n    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))\n        throw new IllegalArgumentException(&quot;Illegal load factor: &quot; +\n                                           loadFactor);\n    //\n    this.loadFactor = loadFactor;\n    //  \n    //thresholdHashMap\n    this.threshold = tableSizeFor(initialCapacity);\n}\n\n//initialCapacityHashmap2\n// : cap2\nstatic final int tableSizeFor(int cap) {\n        int n = cap - 1; \n        n |= n &gt;&gt;&gt; 1; \n        n |= n &gt;&gt;&gt; 2; \n        n |= n &gt;&gt;&gt; 4; \n        n |= n &gt;&gt;&gt; 8; \n        n |= n &gt;&gt;&gt; 16;\n        return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n}</code></pre>\n<h3 id=\"put\"><a href=\"#put\" class=\"headerlink\" title=\"put\"></a>put</h3><pre><code class=\"java\">public V put(K key, V value) {\n        return putVal(hash(key), key, value, false, true);\n}</code></pre>\n<pre><code class=\"java\">//hashhash\n//:keyhash16\nstatic final int hash(Object key) {\n        int h;\n        return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);\n}</code></pre>\n<pre><code class=\"java\">\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent,\n                   boolean evict) {\n        //tab -- hashMap\n        //p -- \n        //n --  i -- \n        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i;\n        //==nullresize\n        //hashMap\n        if ((tab = table) == null || (n = tab.length) == 0)\n            n = (tab = resize()).length;\n\n        // (n - 1) &amp; hash \n        // null,newNode\n        if ((p = tab[i = (n - 1) &amp; hash]) == null)\n            tab[i] = newNode(hash, key, value, null);\n        else {\n            //e -- nodek -- key\n            Node&lt;K,V&gt; e; K k;\n            //p\n            //keye = p,\n            //equal,hashMapequal\n            if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))\n                e = p;\n\n            //p\n            else if (p instanceof TreeNode)\n                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value);\n\n            else {\n                //forkey\n                //keykey\n                for (int binCount = 0; ; ++binCount) {\n                    //\n                    if ((e = p.next) == null) {\n                        //key-value\n                        p.next = newNode(hash, key, value, null);\n                        //&gt;=8\n                        if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st\n                            treeifyBin(tab, hash);\n                        break;\n                    }\n                    //key\n                    if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))\n                        break;\n                    p = e;\n                }\n            }\n\n            //value\n            if (e != null) { // existing mapping for key\n                V oldValue = e.value;\n                if (!onlyIfAbsent || oldValue == null)\n                    e.value = value;\n                afterNodeAccess(e);\n                return oldValue;\n            }\n        }\n        ++modCount; //\n        // &gt;   \n        if (++size &gt; threshold)\n            resize();\n        afterNodeInsertion(evict);\n        return null;\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/07/28/hashmap/5.png\" alt=\"1632\"></p>\n<p><font color=\"red\">1531</font></p>\n<p>hash &amp; (table.length - 1)<font color=\"red\">+</font></p>\n<p>16 15153115 + 16</p>\n<pre><code class=\"java\">//\nfinal Node&lt;K,V&gt;[] resize() {\n    //oldTab -- \n    Node&lt;K,V&gt;[] oldTab = table;\n    //oldCap -- \n    int oldCap = (oldTab == null) ? 0 : oldTab.length;\n    //oldThr -- \n    int oldThr = threshold;\n    //newCap -- \n    //newThr -- \n    int newCap, newThr = 0;\n\n    //===================newCapnewThr=============================\n    //\n    if (oldCap &gt; 0) {\n        //,int\n        if (oldCap &gt;= MAXIMUM_CAPACITY) {\n            threshold = Integer.MAX_VALUE;\n            return oldTab;\n        }\n        //newCap = oldCap &lt;&lt; 1 \n        //   &gt;= 16 \n        else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY)\n            newThr = oldThr &lt;&lt; 1;\n    }\n    //oldCap = 0 , hashmapnew HashMap(15)\n    //oldThrnew hashmapnew HashMap0\n    else if (oldThr &gt; 0)\n        newCap = oldThr;\n    else {\n        //oldThr = 0 16 16 * 0.75\n        //new HashMap()\n        newCap = DEFAULT_INITIAL_CAPACITY;\n        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);\n    }\n    //newThr == 0,newCap  loadFactornewThr\n    if (newThr == 0) {\n        float ft = (float)newCap * loadFactor;\n        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ?\n                  (int)ft : Integer.MAX_VALUE);\n    }\n    //==========================================================================\n\n    threshold = newThr; //\n    // \n    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap]; \n    table = newTab;\n    //oldTab =! null hashmaptablenull,\n    if (oldTab != null) {\n        //\n        for (int j = 0; j &lt; oldCap; ++j) {\n            //e -- Node\n            Node&lt;K,V&gt; e;\n            // \n            if ((e = oldTab[j]) != null) {\n                oldTab[j] = null;\n                //\n                if (e.next == null){\n                    //\n                    newTab[e.hash &amp; (newCap - 1)] = e;\n                }\n                else if (e instanceof TreeNode){\n                    //\n                    ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap);\n                }else {\n                    // \n                    //:\n                    Node&lt;K,V&gt; loHead = null, loTail = null;\n                    //: + \n                    Node&lt;K,V&gt; hiHead = null, hiTail = null;\n                    Node&lt;K,V&gt; next;\n\n                    do {\n                        next = e.next;\n                        //(e.hash &amp; oldCap) == 0 \n                        if ((e.hash &amp; oldCap) == 0) {\n                            if (loTail == null)\n                                loHead = e;\n                            else\n                                loTail.next = e;\n                            loTail = e;\n                        }\n                        else {\n                            if (hiTail == null)\n                                hiHead = e;\n                            else\n                                hiTail.next = e;\n                            hiTail = e;\n                        }\n                    } while ((e = next) != null);\n\n                    //\n                    if (loTail != null) {\n                        loTail.next = null;\n                        newTab[j] = loHead;\n                    }\n                     //\n                    if (hiTail != null) {\n                        hiTail.next = null;\n                        newTab[j + oldCap] = hiHead;\n                    }\n                }\n            }\n        }\n    }\n    return newTab;\n}</code></pre>\n<h3 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h3><pre><code class=\"java\">public V get(Object key) {\n    Node&lt;K,V&gt; e;\n    return (e = getNode(hash(key), key)) == null ? null : e.value;\n}\n\nfinal Node&lt;K,V&gt; getNode(int hash, Object key) {\n    // tab : hashMap\n    //first : \n    //n : \n    //e : node\n    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; int n; K k;\n\n    if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (first = tab[(n - 1) &amp; hash]) != null) {\n        //:\n        if (first.hash == hash &amp;&amp; ((k = first.key) == key || (key != null &amp;&amp; key.equals(k))))\n            return first;\n        //:\n        if ((e = first.next) != null) {\n            if (first instanceof TreeNode)\n                return ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);\n            //for\n            do {\n                if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))) )\n                    return e;\n            } while ((e = e.next) != null);\n        }\n    }\n    return null;\n}</code></pre>\n<h3 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h3><pre><code class=\"java\">public V remove(Object key) {\n    Node&lt;K,V&gt; e;\n    return (e = removeNode(hash(key), key, null, false, true)) == null ?\n        null : e.value;\n}\n\nfinal Node&lt;K,V&gt; removeNode(int hash, Object key, Object value,\n                           boolean matchValue, boolean movable) {\n    //tab : hashmap\n    //p : node\n    //n : \n    //index \n    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, index;\n    //\n    if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (p = tab[index = (n - 1) &amp; hash]) != null ) {\n        //node : \n        //e : Node\n        Node&lt;K,V&gt; node = null, e; K k; V v;\n        //\n        if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))){\n            node = p;\n        }else if ((e = p.next) != null) {\n            if (p instanceof TreeNode){\n                //\n                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);\n            }else {\n                //\n                do {\n                    if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) {\n                        node = e;\n                        break;\n                    }\n                    p = e;\n                } while ((e = e.next) != null);\n            }\n        }\n        //\n        if (node != null &amp;&amp; (!matchValue || (v = node.value) == value ||\n                             (value != null &amp;&amp; value.equals(v)))) {\n            if (node instanceof TreeNode)\n                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(this, tab, movable);\n            else if (node == p)\n                tab[index] = node.next;\n            else\n                p.next = node.next;\n            ++modCount;\n            --size;\n            afterNodeRemoval(node);\n            return node;\n        }\n    }\n    return null;\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>864</li>\n<li>HashMapHash<font color=\"red\"></font></li>\n<li>HashMap16 16  * 0.75 = 12</li>\n<li></li>\n<li>HashMap : hash[<font color=\"red\">hash</font>] &amp; (table.length[<font color=\"red\">2</font>] - 1) </li>\n<li>+</li>\n</ul>\n<h2 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h2><h3 id=\"hashCodeequals-\"><a href=\"#hashCodeequals-\" class=\"headerlink\" title=\"hashCodeequals()\"></a>hashCodeequals()</h3><p>hashCodeequals</p>\n<ul>\n<li>equalshashCode<strong>equalshashCode</strong></li>\n<li>equalshashCode</li>\n<li>hashCodeequals</li>\n</ul>\n<p>HashMaphashCode()equals</p>\n<p><strong> hashCode equals()</strong></p>\n<p>hashcodehashcode</p>\n<p>hashcodehashcode<strong>hashcodehash</strong>hashcode</p>\n<p>()hashhashcode<strong>hashcodehashhash hashcode1hashcode2()345678AA17()17%8=1Ahashcode1Ahash1</strong></p>\n<p><strong>hashcode</strong> 1000999hashCodeAhashhashcode1BEGABEG</p>\n<p>hashCodeequalshashCodeequals</p>\n<h3 id=\"HashMap--\"><a href=\"#HashMap--\" class=\"headerlink\" title=\"HashMap()\"></a>HashMap()</h3><pre><code class=\"java\">^ :  01\n(h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code></pre>\n<p>JDK1.8hashCode()161616hash</p>\n<p><strong></strong> hashCode  32  hash() </p>\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><p></p>\n<p>new HashMap()1616 * 0.75 = 12HashMap123224</p>\n<h3 id=\"JDK1-71-8\"><a href=\"#JDK1-71-8\" class=\"headerlink\" title=\"JDK1.71.8\"></a>JDK1.71.8</h3><ul>\n<li>JDK1.7</li>\n<li>JDK1.8<ul>\n<li><code>hash &amp; ( - 1)</code></li>\n<li><code>hash &amp;  == 0 ?</code>00=  + 1.8hash<code></code><code>+</code></li>\n</ul>\n</li>\n<li>1.71.8</li>\n</ul>\n<h3 id=\"JDK1-8\"><a href=\"#JDK1-8\" class=\"headerlink\" title=\"JDK1.8\"></a>JDK1.8</h3><p><strong>JDK8+</strong></p>\n<p>  <code>hash &amp; (n - 1)</code>n2<code>n-1</code>2-11<font color=\"red\"></font></p>\n<pre><code class=\"java\">16 - 1   1111\n32 - 1   11111\nint[] number = {19,20,12,34,343,123,33,45,66,234,545};\nfor(int i : number){\n     System.out.println(      (i &amp; (32 -1))         -          (i &amp; (16 -1))           );\n}\n//  0  16    </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li></li>\n<li>HashMap</li>\n</ul>"},{"title":"javaAQS()","description":"AQS()","date":"2020-09-06T01:19:19.000Z","_content":"\n## \n\nJavaAbstractQueuedSynchronizer**ReentrantLock**AQS\n\n### AQS\n\nAQS**<font color=red>state</font>**`state```````\n\n****\n\nstate0state==00**CAS**state1state!=0Nodestate0\n\n****\n\nstate`10`state10state1state0\n<!--more-->\n## \n\n### AQS\n\n```java\nimport com.google.common.collect.Maps;\n\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.locks.AbstractQueuedSynchronizer;\n\n/***\n * AQS\n */\npublic class PlainLock {\n    private Sync sync = new Sync();\n\n    public void lock() {\n        sync.acquire(1);\n    }\n\n    public void unlock() {\n        sync.release(1);\n    }\n   /****\n     * AQS\n     */\n    private static class Sync extends AbstractQueuedSynchronizer {\n        @Override\n        protected boolean tryAcquire(int arg) {\n            return compareAndSetState(0, 1);\n        }\n\n        @Override\n        protected boolean tryRelease(int arg) {\n            setState(0);\n            return true;\n        }\n\n        @Override\n        protected boolean isHeldExclusively() {\n            return getState() == 1;\n        }\n    }\n\n\n    public static void main(String[] args) throws InterruptedException {\n        int NUMBER = 100;\n        PlainLock lock = new PlainLock();\n        Map<String,String> myMap = Maps.newHashMap();\n        for (int i = 0; i < NUMBER; i++) {\n            new Thread(new Runner(lock,myMap),\"\" + i).start();\n        }\n        TimeUnit.SECONDS.sleep(20);\n        System.out.println(myMap.entrySet().size());\n\n    }\n\n    private static class Runner implements Runnable {\n        PlainLock lock;\n        Map<String, String> myMap;\n\n        public Runner(PlainLock plainLock, Map<String, String> myMap) {\n            this.lock = plainLock;\n            this.myMap = myMap;\n        }\n\n        @Override\n        public void run() {\n            try {\n                lock.lock();\n                System.out.println(Thread.currentThread().getName() + \"..\");\n                for (int i = 0; i < 1000; i++) {\n                    myMap.put(UUID.randomUUID().toString(), \"1\");\n                }\n            } catch (Exception e) {\n\n            } finally {\n                lock.unlock();\n            }\n        }\n    }\n\n}\n```\n\n****\n\n![](java-aqs/1.png)\n\n\n\n### \n\nAbstractQueuedSynchronizerstatevoatite\n\n```java\nprivate volatile int state;\n```\n\n<font color=red>final</font>AQSstate\n\n|                                                        |                      |\n| ------------------------------------------------------------ | ------------------------ |\n| protected final int getState()                               | state            |\n| protected final void setState(int newState)                  | state            |\n| protected final boolean compareAndSetState(int expect,int update) | CASstate |\n\n### \n\nAbstractQueuedSynchronizer<font color=red></font>Sync\n\n|                                       |                                      |\n| ------------------------------------------- | ---------------------------------------- |\n| protected boolean tryAcquire(int arg)       | true,false |\n| protected boolean tryRelease(int arg)       | true,false |\n| protected boolean tryAcquireShared(int arg) | true,false |\n| protected boolean tryReleaseShared(int arg) | true,false |\n\n### \n\nNodeAbstractQueuedSynchronizerNode\n\n`Node```\n\n![](java-aqs/2.png)\n\n```java\nprivate transient volatile Node head; //\nprivate transient volatile Node tail; //\nstatic final class Node {\n    static final Node SHARED = new Node();\n    static final Node EXCLUSIVE = null;\n    static final int CANCELLED =  1;\n    static final int SIGNAL    = -1;\n    static final int CONDITION = -2;\n    static final int PROPAGATE = -3;\n    volatile int waitStatus; //Node\n    volatile Node prev; //Node\n    volatile Node next; //Node\n    volatile Thread thread;  // \n    Node nextWaiter;\n    Node() {\n    }\n    Node(Thread thread, Node mode) {\n        this.thread = thread;\n    }\n\n    Node(Thread thread, int waitStatus) {\n        this.waitStatus = waitStatus;\n        this.thread = thread;\n    }\n}\n```\n\n### \n\n#### ****\n\nAQSacquireAQS\n\n|                                          |                                                          |\n| ---------------------------------------------- | ------------------------------------------------------------ |\n| public void acquire(int arg)                   | Node |\n| public void acquireInterruptibly(int arg)      |  |\n| public void tryAcqureNanos(int arg.long nanos) |                                  |\n| boolean release(int arg)                       |                                      |\n\n**acquire**\n\n```java\npublic final void acquire(int arg) {\n    //tryAcquire(arg) \n    //addWaiter(Node.EXCLUSIVE) tryAcquire\n    //acquireQueued \n    //Node.EXCLUSIVE \n    if (!tryAcquire(arg) &&\n       acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n       selfInterrupt();\n}\n```\n\ntryAcquire\n\n```java\nprotected boolean tryAcquire(int arg) {\n    //CASstate,true,false\n    return compareAndSetState(0, 1);\n}\n protected final boolean compareAndSetState(int expect, int update) {\n    // See below for intrinsics setup to support this\n    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);\n}\n```\n\n**addWaiter**tryAcquire\n\n```java\nprivate Node addWaiter(Node mode) {\n\t//,\n    Node node = new Node(Thread.currentThread(), mode);  \n    //node\n    Node pred = tail;\n    if (pred != null) { //\n        node.prev = pred;\n        if (compareAndSetTail(pred, node)) {  //tail\n            pred.next = node;\n            return node;\n        }\n    }\n    enq(node); //\n    return node;\n}\n\n//\n//\nprivate Node enq(final Node node) {\n    for (;;) {\n        Node t = tail;\n        if (t == null) {    //tail\n            if (compareAndSetHead(new Node()))  //head\n                tail = head;\n        } else {    //tail\n            node.prev = t;\n            if (compareAndSetTail(t, node)) {\n                t.next = node;\n                return t;\n            }\n        }\n    }\n}\n```\n\n\n\n1. \n2. Nodeheadtail\n\n\n\n![](java-aqs/1.jpg)\n\n\n\n**acquireQueued**\n\n```java\nfinal boolean acquireQueued(final Node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            final Node p = node.predecessor();  //\n            //\n            //\n            //,\n            //\n            //setHead\n            if (p == head && tryAcquire(arg)) {\n                setHead(node);\n                p.next = null; // help GC\n                failed = false;\n                return interrupted;\n            }\n            //ifnode\n            //tryAcquire(arg)\n            if (shouldParkAfterFailedAcquire(p, node) &&\n                parkAndCheckInterrupt())\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n//NodewaitStatus\n//prod --  node -- \nprivate static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\n    int ws = pred.waitStatus;   //\n    //Node.SIGNAL-1,\n    if (ws == Node.SIGNAL)  \n        return true;\n    //\n    if (ws > 0) {  \n        do {\n            node.prev = pred = pred.prev;\n        } while (pred.waitStatus > 0);\n        pred.next = node;\n    } else {    \n        //-1\n        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);\n    }\n    return false;\n}\n\n//\nprivate final boolean parkAndCheckInterrupt() {\n    LockSupport.park(this);\n    return Thread.interrupted();\n}\n```\n\n**waitStatus**\n\n|        |    |                                            |\n| -------------- | ---- | ---------------------------------------------- |\n| Node.CANCELLED | 1    |                          |\n| Node.SIGNAL    | -1   |            |\n| Node.CONDITION | -2   |                            |\n| Node.PROPAGATE | -3   |  |\n|              | 0    |                                        |\n\nacquireQueued1`Node``waitStatus``0``shouldParkAfterFailedAcquire``0``waitStatus``Node.SIGNAL``false``0`\n\n![](java-aqs/2.jpg)\n\nacquireQueued0-1trueparkAndCheckInterrupt12121-1\n\n![](java-aqs/3.jpg)\n\n#### ****\n\n\n\n```java\npublic final boolean release(int arg) {\n    //true\n    if (tryRelease(arg)) {\n        Node h = head;\n        //\n        if (h != null && h.waitStatus != 0)\n            unparkSuccessor(h);\n        return true;\n    }\n    return false;\n}\n//\n//node - head\nprivate void unparkSuccessor(Node node) {\n        int ws = node.waitStatus;   //\n        if (ws < 0)\n            compareAndSetWaitStatus(node, ws, 0);\n    \t//head\n        Node s = node.next; \n        if (s == null || s.waitStatus > 0) {    //nodenode\n            s = null;\n            for (Node t = tail; t != null && t != node; t = t.prev)   \n                if (t.waitStatus <= 0)  //waitStatus\n                    s = t;\n        }\n        if (s != null)\n            LockSupport.unpark(s.thread);   //\n}\n```\n\n## ReentrantLock\n\nReentrantLockAQS\n\n```java\n \n static final class NonfairSync extends Sync {\n     private static final long serialVersionUID = 7316153563782823691L;\n     final void lock() {\n         //CAS\n         if (compareAndSetState(0, 1))\n             setExclusiveOwnerThread(Thread.currentThread());\n         else\n             //AQS\n             acquire(1);\n     }\n\n     protected final boolean tryAcquire(int acquires) {\n         return nonfairTryAcquire(acquires);\n     }\n }\n\n\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();\n    if (c == 0) {\n        //tryAcquire00CAS\n        //state\n        //state\n        if (compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    //+1\n    else if (current == getExclusiveOwnerThread()) {\n        int nextc = c + acquires;\n        if (nextc < 0) // overflow\n            throw new Error(\"Maximum lock count exceeded\");\n        setState(nextc);\n        return true;\n    }\n    return false;\n}\n```\n\n","source":"_posts/java-aqs.md","raw":"---\ntitle: javaAQS()\ntags:\n  - java\ncategories:  java\ndescription : AQS()\ndate: 2020-09-06 09:19:19\n---\n\n## \n\nJavaAbstractQueuedSynchronizer**ReentrantLock**AQS\n\n### AQS\n\nAQS**<font color=red>state</font>**`state```````\n\n****\n\nstate0state==00**CAS**state1state!=0Nodestate0\n\n****\n\nstate`10`state10state1state0\n<!--more-->\n## \n\n### AQS\n\n```java\nimport com.google.common.collect.Maps;\n\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.locks.AbstractQueuedSynchronizer;\n\n/***\n * AQS\n */\npublic class PlainLock {\n    private Sync sync = new Sync();\n\n    public void lock() {\n        sync.acquire(1);\n    }\n\n    public void unlock() {\n        sync.release(1);\n    }\n   /****\n     * AQS\n     */\n    private static class Sync extends AbstractQueuedSynchronizer {\n        @Override\n        protected boolean tryAcquire(int arg) {\n            return compareAndSetState(0, 1);\n        }\n\n        @Override\n        protected boolean tryRelease(int arg) {\n            setState(0);\n            return true;\n        }\n\n        @Override\n        protected boolean isHeldExclusively() {\n            return getState() == 1;\n        }\n    }\n\n\n    public static void main(String[] args) throws InterruptedException {\n        int NUMBER = 100;\n        PlainLock lock = new PlainLock();\n        Map<String,String> myMap = Maps.newHashMap();\n        for (int i = 0; i < NUMBER; i++) {\n            new Thread(new Runner(lock,myMap),\"\" + i).start();\n        }\n        TimeUnit.SECONDS.sleep(20);\n        System.out.println(myMap.entrySet().size());\n\n    }\n\n    private static class Runner implements Runnable {\n        PlainLock lock;\n        Map<String, String> myMap;\n\n        public Runner(PlainLock plainLock, Map<String, String> myMap) {\n            this.lock = plainLock;\n            this.myMap = myMap;\n        }\n\n        @Override\n        public void run() {\n            try {\n                lock.lock();\n                System.out.println(Thread.currentThread().getName() + \"..\");\n                for (int i = 0; i < 1000; i++) {\n                    myMap.put(UUID.randomUUID().toString(), \"1\");\n                }\n            } catch (Exception e) {\n\n            } finally {\n                lock.unlock();\n            }\n        }\n    }\n\n}\n```\n\n****\n\n![](java-aqs/1.png)\n\n\n\n### \n\nAbstractQueuedSynchronizerstatevoatite\n\n```java\nprivate volatile int state;\n```\n\n<font color=red>final</font>AQSstate\n\n|                                                        |                      |\n| ------------------------------------------------------------ | ------------------------ |\n| protected final int getState()                               | state            |\n| protected final void setState(int newState)                  | state            |\n| protected final boolean compareAndSetState(int expect,int update) | CASstate |\n\n### \n\nAbstractQueuedSynchronizer<font color=red></font>Sync\n\n|                                       |                                      |\n| ------------------------------------------- | ---------------------------------------- |\n| protected boolean tryAcquire(int arg)       | true,false |\n| protected boolean tryRelease(int arg)       | true,false |\n| protected boolean tryAcquireShared(int arg) | true,false |\n| protected boolean tryReleaseShared(int arg) | true,false |\n\n### \n\nNodeAbstractQueuedSynchronizerNode\n\n`Node```\n\n![](java-aqs/2.png)\n\n```java\nprivate transient volatile Node head; //\nprivate transient volatile Node tail; //\nstatic final class Node {\n    static final Node SHARED = new Node();\n    static final Node EXCLUSIVE = null;\n    static final int CANCELLED =  1;\n    static final int SIGNAL    = -1;\n    static final int CONDITION = -2;\n    static final int PROPAGATE = -3;\n    volatile int waitStatus; //Node\n    volatile Node prev; //Node\n    volatile Node next; //Node\n    volatile Thread thread;  // \n    Node nextWaiter;\n    Node() {\n    }\n    Node(Thread thread, Node mode) {\n        this.thread = thread;\n    }\n\n    Node(Thread thread, int waitStatus) {\n        this.waitStatus = waitStatus;\n        this.thread = thread;\n    }\n}\n```\n\n### \n\n#### ****\n\nAQSacquireAQS\n\n|                                          |                                                          |\n| ---------------------------------------------- | ------------------------------------------------------------ |\n| public void acquire(int arg)                   | Node |\n| public void acquireInterruptibly(int arg)      |  |\n| public void tryAcqureNanos(int arg.long nanos) |                                  |\n| boolean release(int arg)                       |                                      |\n\n**acquire**\n\n```java\npublic final void acquire(int arg) {\n    //tryAcquire(arg) \n    //addWaiter(Node.EXCLUSIVE) tryAcquire\n    //acquireQueued \n    //Node.EXCLUSIVE \n    if (!tryAcquire(arg) &&\n       acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n       selfInterrupt();\n}\n```\n\ntryAcquire\n\n```java\nprotected boolean tryAcquire(int arg) {\n    //CASstate,true,false\n    return compareAndSetState(0, 1);\n}\n protected final boolean compareAndSetState(int expect, int update) {\n    // See below for intrinsics setup to support this\n    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);\n}\n```\n\n**addWaiter**tryAcquire\n\n```java\nprivate Node addWaiter(Node mode) {\n\t//,\n    Node node = new Node(Thread.currentThread(), mode);  \n    //node\n    Node pred = tail;\n    if (pred != null) { //\n        node.prev = pred;\n        if (compareAndSetTail(pred, node)) {  //tail\n            pred.next = node;\n            return node;\n        }\n    }\n    enq(node); //\n    return node;\n}\n\n//\n//\nprivate Node enq(final Node node) {\n    for (;;) {\n        Node t = tail;\n        if (t == null) {    //tail\n            if (compareAndSetHead(new Node()))  //head\n                tail = head;\n        } else {    //tail\n            node.prev = t;\n            if (compareAndSetTail(t, node)) {\n                t.next = node;\n                return t;\n            }\n        }\n    }\n}\n```\n\n\n\n1. \n2. Nodeheadtail\n\n\n\n![](java-aqs/1.jpg)\n\n\n\n**acquireQueued**\n\n```java\nfinal boolean acquireQueued(final Node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            final Node p = node.predecessor();  //\n            //\n            //\n            //,\n            //\n            //setHead\n            if (p == head && tryAcquire(arg)) {\n                setHead(node);\n                p.next = null; // help GC\n                failed = false;\n                return interrupted;\n            }\n            //ifnode\n            //tryAcquire(arg)\n            if (shouldParkAfterFailedAcquire(p, node) &&\n                parkAndCheckInterrupt())\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n//NodewaitStatus\n//prod --  node -- \nprivate static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\n    int ws = pred.waitStatus;   //\n    //Node.SIGNAL-1,\n    if (ws == Node.SIGNAL)  \n        return true;\n    //\n    if (ws > 0) {  \n        do {\n            node.prev = pred = pred.prev;\n        } while (pred.waitStatus > 0);\n        pred.next = node;\n    } else {    \n        //-1\n        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);\n    }\n    return false;\n}\n\n//\nprivate final boolean parkAndCheckInterrupt() {\n    LockSupport.park(this);\n    return Thread.interrupted();\n}\n```\n\n**waitStatus**\n\n|        |    |                                            |\n| -------------- | ---- | ---------------------------------------------- |\n| Node.CANCELLED | 1    |                          |\n| Node.SIGNAL    | -1   |            |\n| Node.CONDITION | -2   |                            |\n| Node.PROPAGATE | -3   |  |\n|              | 0    |                                        |\n\nacquireQueued1`Node``waitStatus``0``shouldParkAfterFailedAcquire``0``waitStatus``Node.SIGNAL``false``0`\n\n![](java-aqs/2.jpg)\n\nacquireQueued0-1trueparkAndCheckInterrupt12121-1\n\n![](java-aqs/3.jpg)\n\n#### ****\n\n\n\n```java\npublic final boolean release(int arg) {\n    //true\n    if (tryRelease(arg)) {\n        Node h = head;\n        //\n        if (h != null && h.waitStatus != 0)\n            unparkSuccessor(h);\n        return true;\n    }\n    return false;\n}\n//\n//node - head\nprivate void unparkSuccessor(Node node) {\n        int ws = node.waitStatus;   //\n        if (ws < 0)\n            compareAndSetWaitStatus(node, ws, 0);\n    \t//head\n        Node s = node.next; \n        if (s == null || s.waitStatus > 0) {    //nodenode\n            s = null;\n            for (Node t = tail; t != null && t != node; t = t.prev)   \n                if (t.waitStatus <= 0)  //waitStatus\n                    s = t;\n        }\n        if (s != null)\n            LockSupport.unpark(s.thread);   //\n}\n```\n\n## ReentrantLock\n\nReentrantLockAQS\n\n```java\n \n static final class NonfairSync extends Sync {\n     private static final long serialVersionUID = 7316153563782823691L;\n     final void lock() {\n         //CAS\n         if (compareAndSetState(0, 1))\n             setExclusiveOwnerThread(Thread.currentThread());\n         else\n             //AQS\n             acquire(1);\n     }\n\n     protected final boolean tryAcquire(int acquires) {\n         return nonfairTryAcquire(acquires);\n     }\n }\n\n\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();\n    if (c == 0) {\n        //tryAcquire00CAS\n        //state\n        //state\n        if (compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    //+1\n    else if (current == getExclusiveOwnerThread()) {\n        int nextc = c + acquires;\n        if (nextc < 0) // overflow\n            throw new Error(\"Maximum lock count exceeded\");\n        setState(nextc);\n        return true;\n    }\n    return false;\n}\n```\n\n","slug":"java-aqs","published":1,"updated":"2021-04-08T00:47:06.767Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhut000pqwv2cy3f903v","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JavaAbstractQueuedSynchronizer<strong>ReentrantLock</strong>AQS</p>\n<h3 id=\"AQS\"><a href=\"#AQS\" class=\"headerlink\" title=\"AQS\"></a>AQS</h3><p>AQS<strong><font color=\"red\">state</font></strong><code>state</code><code></code><code></code><code></code></p>\n<p><strong></strong></p>\n<p>state0state==00<strong>CAS</strong>state1state!=0Nodestate0</p>\n<p><strong></strong></p>\n<p>state<code>10</code>state10state1state0</p>\n<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"AQS\"><a href=\"#AQS\" class=\"headerlink\" title=\"AQS\"></a>AQS</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">.</span>Maps<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>Map<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>UUID<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>TimeUnit<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>locks<span class=\"token punctuation\">.</span>AbstractQueuedSynchronizer<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">/***\n * AQS\n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlainLock</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> Sync sync <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sync<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sync<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n   <span class=\"token comment\" spellcheck=\"true\">/****\n     * AQS\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Sync</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractQueuedSynchronizer</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryRelease</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isHeldExclusively</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> NUMBER <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n        PlainLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PlainLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>String<span class=\"token operator\">></span> myMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> NUMBER<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runner</span><span class=\"token punctuation\">(</span>lock<span class=\"token punctuation\">,</span>myMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>myMap<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Runner</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n        PlainLock lock<span class=\"token punctuation\">;</span>\n        Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span> myMap<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token function\">Runner</span><span class=\"token punctuation\">(</span>PlainLock plainLock<span class=\"token punctuation\">,</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span> myMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lock <span class=\"token operator\">=</span> plainLock<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>myMap <span class=\"token operator\">=</span> myMap<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"..\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    myMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong></strong></p>\n<p><img src=\"/2020/09/06/java-aqs/1.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AbstractQueuedSynchronizerstatevoatite</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> state<span class=\"token punctuation\">;</span></code></pre>\n<p><font color=\"red\">final</font>AQSstate</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>protected final int getState()</td>\n<td>state</td>\n</tr>\n<tr>\n<td>protected final void setState(int newState)</td>\n<td>state</td>\n</tr>\n<tr>\n<td>protected final boolean compareAndSetState(int expect,int update)</td>\n<td>CASstate</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AbstractQueuedSynchronizer<font color=\"red\"></font>Sync</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>protected boolean tryAcquire(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryRelease(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryAcquireShared(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryReleaseShared(int arg)</td>\n<td>true,false</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NodeAbstractQueuedSynchronizerNode</p>\n<p><code>Node</code><code></code></p>\n<p><img src=\"/2020/09/06/java-aqs/2.png\" alt></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">volatile</span> Node head<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">volatile</span> Node tail<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Node SHARED <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Node EXCLUSIVE <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CANCELLED <span class=\"token operator\">=</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> SIGNAL    <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CONDITION <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> PROPAGATE <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> waitStatus<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//Node</span>\n    <span class=\"token keyword\">volatile</span> Node prev<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//Node</span>\n    <span class=\"token keyword\">volatile</span> Node next<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//Node</span>\n    <span class=\"token keyword\">volatile</span> Thread thread<span class=\"token punctuation\">;</span>  <span class=\"token comment\" spellcheck=\"true\">// </span>\n    Node nextWaiter<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">Node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">Node</span><span class=\"token punctuation\">(</span>Thread thread<span class=\"token punctuation\">,</span> Node mode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> thread<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">Node</span><span class=\"token punctuation\">(</span>Thread thread<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> waitStatus<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">=</span> waitStatus<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> thread<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>AQSacquireAQS</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>public void acquire(int arg)</td>\n<td>Node</td>\n</tr>\n<tr>\n<td>public void acquireInterruptibly(int arg)</td>\n<td></td>\n</tr>\n<tr>\n<td>public void tryAcqureNanos(int arg.long nanos)</td>\n<td></td>\n</tr>\n<tr>\n<td>boolean release(int arg)</td>\n<td></td>\n</tr>\n</tbody></table>\n<p><strong>acquire</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//tryAcquire(arg) </span>\n    <span class=\"token comment\" spellcheck=\"true\">//addWaiter(Node.EXCLUSIVE) tryAcquire</span>\n    <span class=\"token comment\" spellcheck=\"true\">//acquireQueued </span>\n    <span class=\"token comment\" spellcheck=\"true\">//Node.EXCLUSIVE </span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n       <span class=\"token function\">acquireQueued</span><span class=\"token punctuation\">(</span><span class=\"token function\">addWaiter</span><span class=\"token punctuation\">(</span>Node<span class=\"token punctuation\">.</span>EXCLUSIVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token function\">selfInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>tryAcquire</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//CASstate,true,false</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">protected</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> expect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">// See below for intrinsics setup to support this</span>\n    <span class=\"token keyword\">return</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSwapInt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> stateOffset<span class=\"token punctuation\">,</span> expect<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>addWaiter</strong>tryAcquire</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> Node <span class=\"token function\">addWaiter</span><span class=\"token punctuation\">(</span>Node mode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//,</span>\n    Node node <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token comment\" spellcheck=\"true\">//node</span>\n    Node pred <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pred <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        node<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetTail</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\" spellcheck=\"true\">//tail</span>\n            pred<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">enq</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> Node <span class=\"token function\">enq</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> Node node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Node t <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    <span class=\"token comment\" spellcheck=\"true\">//tail</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetHead</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\" spellcheck=\"true\">//head</span>\n                tail <span class=\"token operator\">=</span> head<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>    <span class=\"token comment\" spellcheck=\"true\">//tail</span>\n            node<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetTail</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                t<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<ol>\n<li></li>\n<li>Nodeheadtail</li>\n</ol>\n<p></p>\n<p><img src=\"/2020/09/06/java-aqs/1.jpg\" alt></p>\n<p><strong>acquireQueued</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">acquireQueued</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> Node node<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">boolean</span> failed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">boolean</span> interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">final</span> Node p <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span><span class=\"token function\">predecessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//,</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//setHead</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> head <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">setHead</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                p<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// help GC</span>\n                failed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> interrupted<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\" spellcheck=\"true\">//ifnode</span>\n            <span class=\"token comment\" spellcheck=\"true\">//tryAcquire(arg)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldParkAfterFailedAcquire</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n                <span class=\"token function\">parkAndCheckInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failed<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">cancelAcquire</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//NodewaitStatus</span>\n<span class=\"token comment\" spellcheck=\"true\">//prod --  node -- </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldParkAfterFailedAcquire</span><span class=\"token punctuation\">(</span>Node pred<span class=\"token punctuation\">,</span> Node node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> ws <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">.</span>waitStatus<span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Node.SIGNAL-1,</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">==</span> Node<span class=\"token punctuation\">.</span>SIGNAL<span class=\"token punctuation\">)</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            node<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> pred <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">.</span>prev<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pred<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>    \n        <span class=\"token comment\" spellcheck=\"true\">//-1</span>\n        <span class=\"token function\">compareAndSetWaitStatus</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> ws<span class=\"token punctuation\">,</span> Node<span class=\"token punctuation\">.</span>SIGNAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">parkAndCheckInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    LockSupport<span class=\"token punctuation\">.</span><span class=\"token function\">park</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>waitStatus</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Node.CANCELLED</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.SIGNAL</td>\n<td>-1</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.CONDITION</td>\n<td>-2</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.PROPAGATE</td>\n<td>-3</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>0</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>acquireQueued1<code>Node</code><code>waitStatus</code><code>0</code><code>shouldParkAfterFailedAcquire</code><code>0</code><code>waitStatus</code><code>Node.SIGNAL</code><code>false</code><code>0</code></p>\n<p><img src=\"/2020/09/06/java-aqs/2.jpg\" alt></p>\n<p>acquireQueued0-1trueparkAndCheckInterrupt12121-1</p>\n<p><img src=\"/2020/09/06/java-aqs/3.jpg\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//true</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">tryRelease</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Node h <span class=\"token operator\">=</span> head<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> h<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">unparkSuccessor</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//node - head</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unparkSuccessor</span><span class=\"token punctuation\">(</span>Node node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> ws <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>waitStatus<span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">compareAndSetWaitStatus</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> ws<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//head</span>\n        Node s <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span> \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> null <span class=\"token operator\">||</span> s<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    <span class=\"token comment\" spellcheck=\"true\">//nodenode</span>\n            s <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Node t <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">;</span> t <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> t <span class=\"token operator\">!=</span> node<span class=\"token punctuation\">;</span> t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>prev<span class=\"token punctuation\">)</span>   \n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\" spellcheck=\"true\">//waitStatus</span>\n                    s <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n            LockSupport<span class=\"token punctuation\">.</span><span class=\"token function\">unpark</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"ReentrantLock\"><a href=\"#ReentrantLock\" class=\"headerlink\" title=\"ReentrantLock\"></a>ReentrantLock</h2><p>ReentrantLockAQS</p>\n<pre class=\" language-java\"><code class=\"language-java\">\n <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NonfairSync</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Sync</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> 7316153563782823691L<span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token comment\" spellcheck=\"true\">//CAS</span>\n         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n             <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token keyword\">else</span>\n             <span class=\"token comment\" spellcheck=\"true\">//AQS</span>\n             <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n\n     <span class=\"token keyword\">protected</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> acquires<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token keyword\">return</span> <span class=\"token function\">nonfairTryAcquire</span><span class=\"token punctuation\">(</span>acquires<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">nonfairTryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> acquires<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> Thread current <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//tryAcquire00CAS</span>\n        <span class=\"token comment\" spellcheck=\"true\">//state</span>\n        <span class=\"token comment\" spellcheck=\"true\">//state</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> acquires<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//+1</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token function\">getExclusiveOwnerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> nextc <span class=\"token operator\">=</span> c <span class=\"token operator\">+</span> acquires<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextc <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">// overflow</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Maximum lock count exceeded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>nextc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JavaAbstractQueuedSynchronizer<strong>ReentrantLock</strong>AQS</p>\n<h3 id=\"AQS\"><a href=\"#AQS\" class=\"headerlink\" title=\"AQS\"></a>AQS</h3><p>AQS<strong><font color=\"red\">state</font></strong><code>state</code><code></code><code></code><code></code></p>\n<p><strong></strong></p>\n<p>state0state==00<strong>CAS</strong>state1state!=0Nodestate0</p>\n<p><strong></strong></p>\n<p>state<code>10</code>state10state1state0</p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"AQS\"><a href=\"#AQS\" class=\"headerlink\" title=\"AQS\"></a>AQS</h3><pre><code class=\"java\">import com.google.common.collect.Maps;\n\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.locks.AbstractQueuedSynchronizer;\n\n/***\n * AQS\n */\npublic class PlainLock {\n    private Sync sync = new Sync();\n\n    public void lock() {\n        sync.acquire(1);\n    }\n\n    public void unlock() {\n        sync.release(1);\n    }\n   /****\n     * AQS\n     */\n    private static class Sync extends AbstractQueuedSynchronizer {\n        @Override\n        protected boolean tryAcquire(int arg) {\n            return compareAndSetState(0, 1);\n        }\n\n        @Override\n        protected boolean tryRelease(int arg) {\n            setState(0);\n            return true;\n        }\n\n        @Override\n        protected boolean isHeldExclusively() {\n            return getState() == 1;\n        }\n    }\n\n\n    public static void main(String[] args) throws InterruptedException {\n        int NUMBER = 100;\n        PlainLock lock = new PlainLock();\n        Map&lt;String,String&gt; myMap = Maps.newHashMap();\n        for (int i = 0; i &lt; NUMBER; i++) {\n            new Thread(new Runner(lock,myMap),&quot;&quot; + i).start();\n        }\n        TimeUnit.SECONDS.sleep(20);\n        System.out.println(myMap.entrySet().size());\n\n    }\n\n    private static class Runner implements Runnable {\n        PlainLock lock;\n        Map&lt;String, String&gt; myMap;\n\n        public Runner(PlainLock plainLock, Map&lt;String, String&gt; myMap) {\n            this.lock = plainLock;\n            this.myMap = myMap;\n        }\n\n        @Override\n        public void run() {\n            try {\n                lock.lock();\n                System.out.println(Thread.currentThread().getName() + &quot;..&quot;);\n                for (int i = 0; i &lt; 1000; i++) {\n                    myMap.put(UUID.randomUUID().toString(), &quot;1&quot;);\n                }\n            } catch (Exception e) {\n\n            } finally {\n                lock.unlock();\n            }\n        }\n    }\n\n}</code></pre>\n<p><strong></strong></p>\n<p><img src=\"/2020/09/06/java-aqs/1.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AbstractQueuedSynchronizerstatevoatite</p>\n<pre><code class=\"java\">private volatile int state;</code></pre>\n<p><font color=\"red\">final</font>AQSstate</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>protected final int getState()</td>\n<td>state</td>\n</tr>\n<tr>\n<td>protected final void setState(int newState)</td>\n<td>state</td>\n</tr>\n<tr>\n<td>protected final boolean compareAndSetState(int expect,int update)</td>\n<td>CASstate</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AbstractQueuedSynchronizer<font color=\"red\"></font>Sync</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>protected boolean tryAcquire(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryRelease(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryAcquireShared(int arg)</td>\n<td>true,false</td>\n</tr>\n<tr>\n<td>protected boolean tryReleaseShared(int arg)</td>\n<td>true,false</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NodeAbstractQueuedSynchronizerNode</p>\n<p><code>Node</code><code></code></p>\n<p><img src=\"/2020/09/06/java-aqs/2.png\" alt></p>\n<pre><code class=\"java\">private transient volatile Node head; //\nprivate transient volatile Node tail; //\nstatic final class Node {\n    static final Node SHARED = new Node();\n    static final Node EXCLUSIVE = null;\n    static final int CANCELLED =  1;\n    static final int SIGNAL    = -1;\n    static final int CONDITION = -2;\n    static final int PROPAGATE = -3;\n    volatile int waitStatus; //Node\n    volatile Node prev; //Node\n    volatile Node next; //Node\n    volatile Thread thread;  // \n    Node nextWaiter;\n    Node() {\n    }\n    Node(Thread thread, Node mode) {\n        this.thread = thread;\n    }\n\n    Node(Thread thread, int waitStatus) {\n        this.waitStatus = waitStatus;\n        this.thread = thread;\n    }\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>AQSacquireAQS</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>public void acquire(int arg)</td>\n<td>Node</td>\n</tr>\n<tr>\n<td>public void acquireInterruptibly(int arg)</td>\n<td></td>\n</tr>\n<tr>\n<td>public void tryAcqureNanos(int arg.long nanos)</td>\n<td></td>\n</tr>\n<tr>\n<td>boolean release(int arg)</td>\n<td></td>\n</tr>\n</tbody></table>\n<p><strong>acquire</strong></p>\n<pre><code class=\"java\">public final void acquire(int arg) {\n    //tryAcquire(arg) \n    //addWaiter(Node.EXCLUSIVE) tryAcquire\n    //acquireQueued \n    //Node.EXCLUSIVE \n    if (!tryAcquire(arg) &amp;&amp;\n       acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n       selfInterrupt();\n}</code></pre>\n<p>tryAcquire</p>\n<pre><code class=\"java\">protected boolean tryAcquire(int arg) {\n    //CASstate,true,false\n    return compareAndSetState(0, 1);\n}\n protected final boolean compareAndSetState(int expect, int update) {\n    // See below for intrinsics setup to support this\n    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);\n}</code></pre>\n<p><strong>addWaiter</strong>tryAcquire</p>\n<pre><code class=\"java\">private Node addWaiter(Node mode) {\n    //,\n    Node node = new Node(Thread.currentThread(), mode);  \n    //node\n    Node pred = tail;\n    if (pred != null) { //\n        node.prev = pred;\n        if (compareAndSetTail(pred, node)) {  //tail\n            pred.next = node;\n            return node;\n        }\n    }\n    enq(node); //\n    return node;\n}\n\n//\n//\nprivate Node enq(final Node node) {\n    for (;;) {\n        Node t = tail;\n        if (t == null) {    //tail\n            if (compareAndSetHead(new Node()))  //head\n                tail = head;\n        } else {    //tail\n            node.prev = t;\n            if (compareAndSetTail(t, node)) {\n                t.next = node;\n                return t;\n            }\n        }\n    }\n}</code></pre>\n<p></p>\n<ol>\n<li></li>\n<li>Nodeheadtail</li>\n</ol>\n<p></p>\n<p><img src=\"/2020/09/06/java-aqs/1.jpg\" alt></p>\n<p><strong>acquireQueued</strong></p>\n<pre><code class=\"java\">final boolean acquireQueued(final Node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            final Node p = node.predecessor();  //\n            //\n            //\n            //,\n            //\n            //setHead\n            if (p == head &amp;&amp; tryAcquire(arg)) {\n                setHead(node);\n                p.next = null; // help GC\n                failed = false;\n                return interrupted;\n            }\n            //ifnode\n            //tryAcquire(arg)\n            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;\n                parkAndCheckInterrupt())\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n//NodewaitStatus\n//prod --  node -- \nprivate static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\n    int ws = pred.waitStatus;   //\n    //Node.SIGNAL-1,\n    if (ws == Node.SIGNAL)  \n        return true;\n    //\n    if (ws &gt; 0) {  \n        do {\n            node.prev = pred = pred.prev;\n        } while (pred.waitStatus &gt; 0);\n        pred.next = node;\n    } else {    \n        //-1\n        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);\n    }\n    return false;\n}\n\n//\nprivate final boolean parkAndCheckInterrupt() {\n    LockSupport.park(this);\n    return Thread.interrupted();\n}</code></pre>\n<p><strong>waitStatus</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Node.CANCELLED</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.SIGNAL</td>\n<td>-1</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.CONDITION</td>\n<td>-2</td>\n<td></td>\n</tr>\n<tr>\n<td>Node.PROPAGATE</td>\n<td>-3</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>0</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>acquireQueued1<code>Node</code><code>waitStatus</code><code>0</code><code>shouldParkAfterFailedAcquire</code><code>0</code><code>waitStatus</code><code>Node.SIGNAL</code><code>false</code><code>0</code></p>\n<p><img src=\"/2020/09/06/java-aqs/2.jpg\" alt></p>\n<p>acquireQueued0-1trueparkAndCheckInterrupt12121-1</p>\n<p><img src=\"/2020/09/06/java-aqs/3.jpg\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p></p>\n<pre><code class=\"java\">public final boolean release(int arg) {\n    //true\n    if (tryRelease(arg)) {\n        Node h = head;\n        //\n        if (h != null &amp;&amp; h.waitStatus != 0)\n            unparkSuccessor(h);\n        return true;\n    }\n    return false;\n}\n//\n//node - head\nprivate void unparkSuccessor(Node node) {\n        int ws = node.waitStatus;   //\n        if (ws &lt; 0)\n            compareAndSetWaitStatus(node, ws, 0);\n        //head\n        Node s = node.next; \n        if (s == null || s.waitStatus &gt; 0) {    //nodenode\n            s = null;\n            for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)   \n                if (t.waitStatus &lt;= 0)  //waitStatus\n                    s = t;\n        }\n        if (s != null)\n            LockSupport.unpark(s.thread);   //\n}</code></pre>\n<h2 id=\"ReentrantLock\"><a href=\"#ReentrantLock\" class=\"headerlink\" title=\"ReentrantLock\"></a>ReentrantLock</h2><p>ReentrantLockAQS</p>\n<pre><code class=\"java\">\n static final class NonfairSync extends Sync {\n     private static final long serialVersionUID = 7316153563782823691L;\n     final void lock() {\n         //CAS\n         if (compareAndSetState(0, 1))\n             setExclusiveOwnerThread(Thread.currentThread());\n         else\n             //AQS\n             acquire(1);\n     }\n\n     protected final boolean tryAcquire(int acquires) {\n         return nonfairTryAcquire(acquires);\n     }\n }\n\n\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();\n    if (c == 0) {\n        //tryAcquire00CAS\n        //state\n        //state\n        if (compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    //+1\n    else if (current == getExclusiveOwnerThread()) {\n        int nextc = c + acquires;\n        if (nextc &lt; 0) // overflow\n            throw new Error(&quot;Maximum lock count exceeded&quot;);\n        setState(nextc);\n        return true;\n    }\n    return false;\n}</code></pre>"},{"title":"Kafka","description":"Kafka","date":"2020-10-09T11:44:41.000Z","_content":"\n## \n### \n\nKafka**************-****zookeeper**MQ\n\n### \n\n- BrokerKafkaBrokerBroker\n- TopicKafkaTopic\n- PartitionTopicKafka\n- Producertopic\n- ConsumertopicTopicPartition\n- Consumer GroupConsumerConsumer Group\n- ReplicaReplicaKafka\n- Leaderpartition\n- FollowerLeaderLeaderFollowerLeader\n- LogSegemnt\n- ARAssigned RepllicasAR\n- ISRin-sync ReplicaleaderLeaderISR\n- Controller\n<!--more-->\n### \n\n**Topic Partition**\n\nKafka`Test`33KafkakeyTestVIPVIP01\n\n**Partition Replica  Leader  Follower**\n\nleaderfollowerleaderfollowerleaderkafka\n\n**Consumer Consumer Group**\n\n34\n\n![kafka](kafka-base/1.png)\n\n**Controller Broker**\n\nKafkabrokerController leaderControllerpartitionleader controller partitionleader ISRcontrollerbrokerMetadataCachetopiccontroller\n\n## \n\n### \n\nKafka--\n\n![](kafka-base/2.png)\n\n********kafka\n\nKafka\n\n### \n\nOffsetKafkaLogAppend-only<font color=red>I/OI/OKafka</font>\n\n![](kafka-base/3.png)\n\nLogLog,kafkaLogSegemnt LogLogSegementkafka.log.xxxindex\n\n![](kafka-base/4.png)\n\n### \n\nKafkaKafkaLeader ReplicaFollower Replica<font color=red></font>\n\n**Replica**\n\nKafkaPartition3Broker362BrokerBrokerKafkaReplica \n\n1. BrokernBrokerPartition\n2. iPartitioni mod nBroker\n3. iPartitionjReplica(i + j) mode nBroker\n\n### \n\nProducerPartitionZooKeeperPartitionLeaderTopicReplication FactorProducerPartitionLeaderLeaderLogFollowerLeader pullFollowerLeaderFollowerLogLeaderACKLeaderISRReplicaACKcommitLeaderHWProducerACK\n\nFollowerLeaderACKLogcommitKafkaReplicaConsumer\n\n## \n\n- Kafkaos","source":"_posts/kafka-base.md","raw":"---\ntitle: Kafka\ntags:\n  - kafka\ncategories:  kafka\ndescription : Kafka\ndate: 2020-10-09 19:44:41\n---\n\n## \n### \n\nKafka**************-****zookeeper**MQ\n\n### \n\n- BrokerKafkaBrokerBroker\n- TopicKafkaTopic\n- PartitionTopicKafka\n- Producertopic\n- ConsumertopicTopicPartition\n- Consumer GroupConsumerConsumer Group\n- ReplicaReplicaKafka\n- Leaderpartition\n- FollowerLeaderLeaderFollowerLeader\n- LogSegemnt\n- ARAssigned RepllicasAR\n- ISRin-sync ReplicaleaderLeaderISR\n- Controller\n<!--more-->\n### \n\n**Topic Partition**\n\nKafka`Test`33KafkakeyTestVIPVIP01\n\n**Partition Replica  Leader  Follower**\n\nleaderfollowerleaderfollowerleaderkafka\n\n**Consumer Consumer Group**\n\n34\n\n![kafka](kafka-base/1.png)\n\n**Controller Broker**\n\nKafkabrokerController leaderControllerpartitionleader controller partitionleader ISRcontrollerbrokerMetadataCachetopiccontroller\n\n## \n\n### \n\nKafka--\n\n![](kafka-base/2.png)\n\n********kafka\n\nKafka\n\n### \n\nOffsetKafkaLogAppend-only<font color=red>I/OI/OKafka</font>\n\n![](kafka-base/3.png)\n\nLogLog,kafkaLogSegemnt LogLogSegementkafka.log.xxxindex\n\n![](kafka-base/4.png)\n\n### \n\nKafkaKafkaLeader ReplicaFollower Replica<font color=red></font>\n\n**Replica**\n\nKafkaPartition3Broker362BrokerBrokerKafkaReplica \n\n1. BrokernBrokerPartition\n2. iPartitioni mod nBroker\n3. iPartitionjReplica(i + j) mode nBroker\n\n### \n\nProducerPartitionZooKeeperPartitionLeaderTopicReplication FactorProducerPartitionLeaderLeaderLogFollowerLeader pullFollowerLeaderFollowerLogLeaderACKLeaderISRReplicaACKcommitLeaderHWProducerACK\n\nFollowerLeaderACKLogcommitKafkaReplicaConsumer\n\n## \n\n- Kafkaos","slug":"kafka-base","published":1,"updated":"2021-04-08T00:47:06.787Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhuv000rqwv23h4c5d88","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Kafka<strong></strong><strong></strong><strong></strong><strong>-</strong><strong>zookeeper</strong>MQ</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>BrokerKafkaBrokerBroker</li>\n<li>TopicKafkaTopic</li>\n<li>PartitionTopicKafka</li>\n<li>Producertopic</li>\n<li>ConsumertopicTopicPartition</li>\n<li>Consumer GroupConsumerConsumer Group</li>\n<li>ReplicaReplicaKafka</li>\n<li>Leaderpartition</li>\n<li>FollowerLeaderLeaderFollowerLeader</li>\n<li>LogSegemnt</li>\n<li>ARAssigned RepllicasAR</li>\n<li>ISRin-sync ReplicaleaderLeaderISR</li>\n<li>Controller<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3></li>\n</ul>\n<p><strong>Topic Partition</strong></p>\n<p>Kafka<code>Test</code>33KafkakeyTestVIPVIP01</p>\n<p><strong>Partition Replica  Leader  Follower</strong></p>\n<p>leaderfollowerleaderfollowerleaderkafka</p>\n<p><strong>Consumer Consumer Group</strong></p>\n<p>34</p>\n<p><img src=\"/2020/10/09/kafka-base/1.png\" alt=\"kafka\"></p>\n<p><strong>Controller Broker</strong></p>\n<p>KafkabrokerController leaderControllerpartitionleader controller partitionleader ISRcontrollerbrokerMetadataCachetopiccontroller</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Kafka--</p>\n<p><img src=\"/2020/10/09/kafka-base/2.png\" alt></p>\n<p><strong></strong><strong></strong>kafka</p>\n<p>Kafka</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>OffsetKafkaLogAppend-only<font color=\"red\">I/OI/OKafka</font></p>\n<p><img src=\"/2020/10/09/kafka-base/3.png\" alt></p>\n<p>LogLog,kafkaLogSegemnt LogLogSegementkafka.log.xxxindex</p>\n<p><img src=\"/2020/10/09/kafka-base/4.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>KafkaKafkaLeader ReplicaFollower Replica<font color=\"red\"></font></p>\n<p><strong>Replica</strong></p>\n<p>KafkaPartition3Broker362BrokerBrokerKafkaReplica </p>\n<ol>\n<li>BrokernBrokerPartition</li>\n<li>iPartitioni mod nBroker</li>\n<li>iPartitionjReplica(i + j) mode nBroker</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ProducerPartitionZooKeeperPartitionLeaderTopicReplication FactorProducerPartitionLeaderLeaderLogFollowerLeader pullFollowerLeaderFollowerLogLeaderACKLeaderISRReplicaACKcommitLeaderHWProducerACK</p>\n<p>FollowerLeaderACKLogcommitKafkaReplicaConsumer</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>Kafkaos</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Kafka<strong></strong><strong></strong><strong></strong><strong>-</strong><strong>zookeeper</strong>MQ</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>BrokerKafkaBrokerBroker</li>\n<li>TopicKafkaTopic</li>\n<li>PartitionTopicKafka</li>\n<li>Producertopic</li>\n<li>ConsumertopicTopicPartition</li>\n<li>Consumer GroupConsumerConsumer Group</li>\n<li>ReplicaReplicaKafka</li>\n<li>Leaderpartition</li>\n<li>FollowerLeaderLeaderFollowerLeader</li>\n<li>LogSegemnt</li>\n<li>ARAssigned RepllicasAR</li>\n<li>ISRin-sync ReplicaleaderLeaderISR</li>\n<li>Controller</li></ul>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3>\n\n<p><strong>Topic Partition</strong></p>\n<p>Kafka<code>Test</code>33KafkakeyTestVIPVIP01</p>\n<p><strong>Partition Replica  Leader  Follower</strong></p>\n<p>leaderfollowerleaderfollowerleaderkafka</p>\n<p><strong>Consumer Consumer Group</strong></p>\n<p>34</p>\n<p><img src=\"/2020/10/09/kafka-base/1.png\" alt=\"kafka\"></p>\n<p><strong>Controller Broker</strong></p>\n<p>KafkabrokerController leaderControllerpartitionleader controller partitionleader ISRcontrollerbrokerMetadataCachetopiccontroller</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Kafka--</p>\n<p><img src=\"/2020/10/09/kafka-base/2.png\" alt></p>\n<p><strong></strong><strong></strong>kafka</p>\n<p>Kafka</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>OffsetKafkaLogAppend-only<font color=\"red\">I/OI/OKafka</font></p>\n<p><img src=\"/2020/10/09/kafka-base/3.png\" alt></p>\n<p>LogLog,kafkaLogSegemnt LogLogSegementkafka.log.xxxindex</p>\n<p><img src=\"/2020/10/09/kafka-base/4.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>KafkaKafkaLeader ReplicaFollower Replica<font color=\"red\"></font></p>\n<p><strong>Replica</strong></p>\n<p>KafkaPartition3Broker362BrokerBrokerKafkaReplica </p>\n<ol>\n<li>BrokernBrokerPartition</li>\n<li>iPartitioni mod nBroker</li>\n<li>iPartitionjReplica(i + j) mode nBroker</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ProducerPartitionZooKeeperPartitionLeaderTopicReplication FactorProducerPartitionLeaderLeaderLogFollowerLeader pullFollowerLeaderFollowerLogLeaderACKLeaderISRReplicaACKcommitLeaderHWProducerACK</p>\n<p>FollowerLeaderACKLogcommitKafkaReplicaConsumer</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>Kafkaos</li>\n</ul>"},{"title":"JVM","description":"JVM","date":"2020-05-07T07:25:44.000Z","_content":"## JVM\n### \n\n```shell\n-Xms1024M: \n-Xmx1024M: \n-Xmn512M:\n-XX:newSize:(-Xms)\n-XX:MaxnewSize:(-Xmx)\n-Xmn:(eden + 2 survivor,-XX:NewSize-XX:MaxNewSize)\n-XX:NewRatio=n: :3131/4\n-XX:SurvivorRatio=n: EdenSurvivorSurvivor3EdenSurvivor=32Survivor1/5\n-Xss256K: \n-XX:MetaspaceSize=n \n-XX:MaxMetaspaceSize=n \n```\n<!--more-->\n\n\n```shell\njava -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxTenuringThreshold=0\n#-XX:NewRatio=4:EdenSurvivor4141/5\n#-XX:SurvivorRatio=4EdenSurvivor4SurvivorEden2:4Survivor1/6\n#-XX:MaxTenuringThreshold=0 0Survivor()\n```\n\n### \n\nJVM\n\n- GC\n- GC\n- (CMS)GC\n\n\n\n1CPU : -XX:+UseSerialGC\n\n2CPU-XX:+UseParallelGC  -XX:+UseParallelOldGC\n\n3CPU-XX:+UseParNewGC  -XX:+UseConcMarkSweepGC\n\nC/S****CMS\n\n```shell\n-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+UseCMSCompactAtFullCollection\n#-XX:+UseConcMarkSweepGC \n#-XX:+UseParNewGC: \n#-XX:+UseCMSCompactAtFullCollection \n```\n\n### \n\n[GC](https://xuzyblog.top/2019/02/18/gc-log/)\n\n\n\n : **-XX:+ -XX:- **\n\n```shell\n-XX:+DisableExplicitGC #System.gc()System.gc()FullGC\n-XX:+UseCompressedOops #\n-XX:+CMSParallelRemarkEnabled #\n-XX:CMSInitiatingOccupancyFraction=70 #cms,70CMS\n```\n\n## JVM\n\n### \n\n**GCGCGCGC1-3GC**\n\nGC\n\n- Minor GC100ms\n- Minor GC5\n- Full GC1s\n- Full GC11\n\n### \n\n- GC\n- GC\n- Full GC\n\n\n\n- \n- JavaGC\n-  ()\n- \n- =21\n- GC\n- \n\nFull GC\n\n- YGCTo SurvivorSurvivor\n- YGC\n- To Survivor To SurvivorSurvivor\n\n### \n\n- IO RPCMQHTTP  TP9999  Young \n-  Hadoop HBaseCassandraOld \n\n## \n\n### \n\nMinor GCJVM****\n\n- **Minor GC**\n- **HandlePromotionFailure**HandlePromotionFailure=true****Minor GCMinor GCHandlePromotionFailure=falseFull GC\n\n****\n\n****Minor GCSurvivorSurvivor********Full GC\n\n![](jvm-optimization/1.png)\n\n### \n\n- YGCTo Survivor\n- YGC-XXMaxTenuringThreshold = 15\n- -XXPretenureSizeThreshold\n- To Survivor To Survivor\n\n### FGC\n\n- FGCMajor GC**FGC**\n- FGC(-XX:CMSInitiatingOccupancyFraction=70 CMS70%GC\n- YGCYGC HandlePromotionFailure Full GC Full GC\n- Metaspace-XX:MetaspaceSize FGC\n- System.gc() Runtime.gc() FGC\n\n### \n\n Java  3 \n\n- -\n  - \n- \n  - \n  -  11 \n  - \n- -\n  - -\n\n### CMS\n\nCMS*<font color=red>-</font>*GC<font color=red>Stop The World</font>B/S\n\n**CMS**\n\nCMS**-**\n\n- (<font color=red>Stop The World</font>)GC Roots\n- - GcRoots\n  - \n- ****Card()Dirty()Dirty Card\n- *CMSPrecleaningEnabled*****\n-  --- <font color=red>Stop The World</font>\n- \n\n****\n\n- \n- CMS\n- CMSCMS GC\n\n****\n\n- -XX:+UseCMSInitiatingOccupancyOnly  -XXCMSInitiatingOccupancyFractionCMSFullGC\n- -XX:+UseCMSCompactAtFullCollectionFull GC\n- -XX:CMSFullGCsBeforeCompaction Full GCFull GC\n- CMSScavengeBeforeRemark minor gc\n- CMSMaxAbortablePrecleanTime = 5 5minor gc\n\n**CMSConcurrent mode failure**\n\n- CMSconcurrent mode failureCMSFull GC\n- minor gcCMSconcurrent mode failure\n- Java8,CMSFull GC\n\n \n\n- \n- CMS*CMSInitiatingOccupancyFraction*Java** GC  CMS  CMS **\n- CMS*CPU + 3/4*-XX:ParallelCMSThreads\n\n### JVM\n\n-XX:MaxTenuringThreshold=3GC(**SurvivorSurvivorMaxTenuringThreshold**)\n\n### \n\n![](jvm-optimization/3.png)\n\n### JVM\n\n![jvm](jvm-optimization/4.png)\n\n### \n\n![]()![5](jvm-optimization/5.png)\n\n### JAVA\n\n![JAVA](jvm-optimization/6.png)\n\n```java\npackage xzy;\nimport org.openjdk.jol.info.ClassLayout;\npublic class OtherTest {\n    public static void main(String[] args){\n        Object obj = new Object();\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//===================================================================\n# -XX:-UseCompressedOops\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           00 1c 95 1e (00000000 00011100 10010101 00011110) (513088512)\n     12     4        (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total\n//===================================================================\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)\n     12     4        (loss due to the next object alignment)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total\n    \n    \npublic class OtherTest {\n    public static void main(String[] args){\n        Object[] obj = new Object[10];\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//==========================================================\n[Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           60 c7 b1 1e (01100000 11000111 10110001 00011110) (514967392)\n     12     4                    (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n     16     4                    (object header)Class Pointer                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     20     4                    (alignment/padding gap)                  \n     24    80   java.lang.Object Object;.<elements>(8 * 10)                        N/A\nInstance size: 104 bytes\nSpace losses: 4 bytes internal + 0 bytes external = 4 bytes total\n//=========================================================\n [Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           3c 23 00 f8 (00111100 00100011 00000000 11111000) (-134208708)\n     12     4                    (object header)                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     16    40   java.lang.Object Object;.<elements>(4 * 10)                        N/A\nInstance size: 56 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total\n```\n\n### \n\nGC\n\n- GC\n- GC\n- \n\n****\n\n1. GC\n2. GCRoots\n3. ","source":"_posts/jvm-optimization.md","raw":"---\ntitle: JVM\ntags:\n  - java\ncategories:  java\ndescription : JVM\ndate: 2020-05-07 15:25:44\n---\n## JVM\n### \n\n```shell\n-Xms1024M: \n-Xmx1024M: \n-Xmn512M:\n-XX:newSize:(-Xms)\n-XX:MaxnewSize:(-Xmx)\n-Xmn:(eden + 2 survivor,-XX:NewSize-XX:MaxNewSize)\n-XX:NewRatio=n: :3131/4\n-XX:SurvivorRatio=n: EdenSurvivorSurvivor3EdenSurvivor=32Survivor1/5\n-Xss256K: \n-XX:MetaspaceSize=n \n-XX:MaxMetaspaceSize=n \n```\n<!--more-->\n\n\n```shell\njava -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxTenuringThreshold=0\n#-XX:NewRatio=4:EdenSurvivor4141/5\n#-XX:SurvivorRatio=4EdenSurvivor4SurvivorEden2:4Survivor1/6\n#-XX:MaxTenuringThreshold=0 0Survivor()\n```\n\n### \n\nJVM\n\n- GC\n- GC\n- (CMS)GC\n\n\n\n1CPU : -XX:+UseSerialGC\n\n2CPU-XX:+UseParallelGC  -XX:+UseParallelOldGC\n\n3CPU-XX:+UseParNewGC  -XX:+UseConcMarkSweepGC\n\nC/S****CMS\n\n```shell\n-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+UseCMSCompactAtFullCollection\n#-XX:+UseConcMarkSweepGC \n#-XX:+UseParNewGC: \n#-XX:+UseCMSCompactAtFullCollection \n```\n\n### \n\n[GC](https://xuzyblog.top/2019/02/18/gc-log/)\n\n\n\n : **-XX:+ -XX:- **\n\n```shell\n-XX:+DisableExplicitGC #System.gc()System.gc()FullGC\n-XX:+UseCompressedOops #\n-XX:+CMSParallelRemarkEnabled #\n-XX:CMSInitiatingOccupancyFraction=70 #cms,70CMS\n```\n\n## JVM\n\n### \n\n**GCGCGCGC1-3GC**\n\nGC\n\n- Minor GC100ms\n- Minor GC5\n- Full GC1s\n- Full GC11\n\n### \n\n- GC\n- GC\n- Full GC\n\n\n\n- \n- JavaGC\n-  ()\n- \n- =21\n- GC\n- \n\nFull GC\n\n- YGCTo SurvivorSurvivor\n- YGC\n- To Survivor To SurvivorSurvivor\n\n### \n\n- IO RPCMQHTTP  TP9999  Young \n-  Hadoop HBaseCassandraOld \n\n## \n\n### \n\nMinor GCJVM****\n\n- **Minor GC**\n- **HandlePromotionFailure**HandlePromotionFailure=true****Minor GCMinor GCHandlePromotionFailure=falseFull GC\n\n****\n\n****Minor GCSurvivorSurvivor********Full GC\n\n![](jvm-optimization/1.png)\n\n### \n\n- YGCTo Survivor\n- YGC-XXMaxTenuringThreshold = 15\n- -XXPretenureSizeThreshold\n- To Survivor To Survivor\n\n### FGC\n\n- FGCMajor GC**FGC**\n- FGC(-XX:CMSInitiatingOccupancyFraction=70 CMS70%GC\n- YGCYGC HandlePromotionFailure Full GC Full GC\n- Metaspace-XX:MetaspaceSize FGC\n- System.gc() Runtime.gc() FGC\n\n### \n\n Java  3 \n\n- -\n  - \n- \n  - \n  -  11 \n  - \n- -\n  - -\n\n### CMS\n\nCMS*<font color=red>-</font>*GC<font color=red>Stop The World</font>B/S\n\n**CMS**\n\nCMS**-**\n\n- (<font color=red>Stop The World</font>)GC Roots\n- - GcRoots\n  - \n- ****Card()Dirty()Dirty Card\n- *CMSPrecleaningEnabled*****\n-  --- <font color=red>Stop The World</font>\n- \n\n****\n\n- \n- CMS\n- CMSCMS GC\n\n****\n\n- -XX:+UseCMSInitiatingOccupancyOnly  -XXCMSInitiatingOccupancyFractionCMSFullGC\n- -XX:+UseCMSCompactAtFullCollectionFull GC\n- -XX:CMSFullGCsBeforeCompaction Full GCFull GC\n- CMSScavengeBeforeRemark minor gc\n- CMSMaxAbortablePrecleanTime = 5 5minor gc\n\n**CMSConcurrent mode failure**\n\n- CMSconcurrent mode failureCMSFull GC\n- minor gcCMSconcurrent mode failure\n- Java8,CMSFull GC\n\n \n\n- \n- CMS*CMSInitiatingOccupancyFraction*Java** GC  CMS  CMS **\n- CMS*CPU + 3/4*-XX:ParallelCMSThreads\n\n### JVM\n\n-XX:MaxTenuringThreshold=3GC(**SurvivorSurvivorMaxTenuringThreshold**)\n\n### \n\n![](jvm-optimization/3.png)\n\n### JVM\n\n![jvm](jvm-optimization/4.png)\n\n### \n\n![]()![5](jvm-optimization/5.png)\n\n### JAVA\n\n![JAVA](jvm-optimization/6.png)\n\n```java\npackage xzy;\nimport org.openjdk.jol.info.ClassLayout;\npublic class OtherTest {\n    public static void main(String[] args){\n        Object obj = new Object();\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//===================================================================\n# -XX:-UseCompressedOops\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           00 1c 95 1e (00000000 00011100 10010101 00011110) (513088512)\n     12     4        (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total\n//===================================================================\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)\n     12     4        (loss due to the next object alignment)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total\n    \n    \npublic class OtherTest {\n    public static void main(String[] args){\n        Object[] obj = new Object[10];\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//==========================================================\n[Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           60 c7 b1 1e (01100000 11000111 10110001 00011110) (514967392)\n     12     4                    (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n     16     4                    (object header)Class Pointer                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     20     4                    (alignment/padding gap)                  \n     24    80   java.lang.Object Object;.<elements>(8 * 10)                        N/A\nInstance size: 104 bytes\nSpace losses: 4 bytes internal + 0 bytes external = 4 bytes total\n//=========================================================\n [Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           3c 23 00 f8 (00111100 00100011 00000000 11111000) (-134208708)\n     12     4                    (object header)                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     16    40   java.lang.Object Object;.<elements>(4 * 10)                        N/A\nInstance size: 56 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total\n```\n\n### \n\nGC\n\n- GC\n- GC\n- \n\n****\n\n1. GC\n2. GCRoots\n3. ","slug":"jvm-optimization","published":1,"updated":"2021-04-08T00:47:06.777Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhuy000vqwv29m0m7m80","content":"<h2 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-shell\"><code class=\"language-shell\">-Xms1024M: \n-Xmx1024M: \n-Xmn512M:\n-XX:newSize:(-Xms)\n-XX:MaxnewSize:(-Xmx)\n-Xmn:(eden + 2 survivor,-XX:NewSize-XX:MaxNewSize)\n-XX:NewRatio=n: :3131/4\n-XX:SurvivorRatio=n: EdenSurvivorSurvivor3EdenSurvivor=32Survivor1/5\n-Xss256K: \n-XX:MetaspaceSize=n \n-XX:MaxMetaspaceSize=n </code></pre>\n<a id=\"more\"></a>\n<p></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">java -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxTenuringThreshold=0\n#-XX:NewRatio=4:EdenSurvivor4141/5\n#-XX:SurvivorRatio=4EdenSurvivor4SurvivorEden2:4Survivor1/6\n#-XX:MaxTenuringThreshold=0 0Survivor()</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JVM</p>\n<ul>\n<li>GC</li>\n<li>GC</li>\n<li>(CMS)GC</li>\n</ul>\n<p></p>\n<p>1CPU : -XX:+UseSerialGC</p>\n<p>2CPU-XX:+UseParallelGC  -XX:+UseParallelOldGC</p>\n<p>3CPU-XX:+UseParNewGC  -XX:+UseConcMarkSweepGC</p>\n<p>C/S<strong></strong>CMS</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+UseCMSCompactAtFullCollection\n#-XX:+UseConcMarkSweepGC \n#-XX:+UseParNewGC: \n#-XX:+UseCMSCompactAtFullCollection </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://xuzyblog.top/2019/02/18/gc-log/\" target=\"_blank\" rel=\"noopener\">GC</a></p>\n<p></p>\n<p> : <strong>-XX:+ -XX:- </strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">-XX:+DisableExplicitGC #System.gc()System.gc()FullGC\n-XX:+UseCompressedOops #\n-XX:+CMSParallelRemarkEnabled #\n-XX:CMSInitiatingOccupancyFraction=70 #cms,70CMS</code></pre>\n<h2 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>GCGCGCGC1-3GC</strong></p>\n<p>GC</p>\n<ul>\n<li>Minor GC100ms</li>\n<li>Minor GC5</li>\n<li>Full GC1s</li>\n<li>Full GC11</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>GC</li>\n<li>GC</li>\n<li>Full GC</li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li>JavaGC</li>\n<li> ()</li>\n<li></li>\n<li>=21</li>\n<li>GC</li>\n<li></li>\n</ul>\n<p>Full GC</p>\n<ul>\n<li>YGCTo SurvivorSurvivor</li>\n<li>YGC</li>\n<li>To Survivor To SurvivorSurvivor</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>IO RPCMQHTTP  TP9999  Young </li>\n<li> Hadoop HBaseCassandraOld </li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Minor GCJVM<strong></strong></p>\n<ul>\n<li><strong>Minor GC</strong></li>\n<li><strong>HandlePromotionFailure</strong>HandlePromotionFailure=true<strong></strong>Minor GCMinor GCHandlePromotionFailure=falseFull GC</li>\n</ul>\n<p><strong></strong></p>\n<p><strong></strong>Minor GCSurvivorSurvivor<strong></strong><strong></strong>Full GC</p>\n<p><img src=\"/2020/05/07/jvm-optimization/1.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>YGCTo Survivor</li>\n<li>YGC-XXMaxTenuringThreshold = 15</li>\n<li>-XXPretenureSizeThreshold</li>\n<li>To Survivor To Survivor</li>\n</ul>\n<h3 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h3><ul>\n<li>FGCMajor GC<strong>FGC</strong></li>\n<li>FGC(-XX:CMSInitiatingOccupancyFraction=70 CMS70%GC</li>\n<li>YGCYGC HandlePromotionFailure Full GC Full GC</li>\n<li>Metaspace-XX:MetaspaceSize FGC</li>\n<li>System.gc() Runtime.gc() FGC</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> Java  3 </p>\n<ul>\n<li>-<ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li></li>\n<li> 11 </li>\n<li></li>\n</ul>\n</li>\n<li>-<ul>\n<li>-</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"CMS\"><a href=\"#CMS\" class=\"headerlink\" title=\"CMS\"></a>CMS</h3><p>CMS*<font color=\"red\">-</font>*GC<font color=\"red\">Stop The World</font>B/S</p>\n<p><strong>CMS</strong></p>\n<p>CMS<strong>-</strong></p>\n<ul>\n<li>(<font color=\"red\">Stop The World</font>)GC Roots</li>\n<li><ul>\n<li>GcRoots</li>\n<li></li>\n</ul>\n</li>\n<li><strong></strong>Card()Dirty()Dirty Card</li>\n<li><em>CMSPrecleaningEnabled</em><strong></strong></li>\n<li>  <font color=\"red\">Stop The World</font></li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li>CMS</li>\n<li>CMSCMS GC</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>-XX:+UseCMSInitiatingOccupancyOnly  -XXCMSInitiatingOccupancyFractionCMSFullGC</li>\n<li>-XX:+UseCMSCompactAtFullCollectionFull GC</li>\n<li>-XX:CMSFullGCsBeforeCompaction Full GCFull GC</li>\n<li>CMSScavengeBeforeRemark minor gc</li>\n<li>CMSMaxAbortablePrecleanTime = 5 5minor gc</li>\n</ul>\n<p><strong>CMSConcurrent mode failure</strong></p>\n<ul>\n<li>CMSconcurrent mode failureCMSFull GC</li>\n<li>minor gcCMSconcurrent mode failure</li>\n<li>Java8,CMSFull GC</li>\n</ul>\n<p> </p>\n<ul>\n<li></li>\n<li>CMS<em>CMSInitiatingOccupancyFraction</em>Java<strong> GC  CMS  CMS </strong></li>\n<li>CMS<em>CPU + 3/4</em>-XX:ParallelCMSThreads</li>\n</ul>\n<h3 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h3><p>-XX:MaxTenuringThreshold=3GC(<strong>SurvivorSurvivorMaxTenuringThreshold</strong>)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/05/07/jvm-optimization/3.png\" alt=\"\"></p>\n<h3 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h3><p><img src=\"/2020/05/07/jvm-optimization/4.png\" alt=\"jvm\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src alt>)<img src=\"/2020/05/07/jvm-optimization/5.png\" alt=\"5\"></p>\n<h3 id=\"JAVA\"><a href=\"#JAVA\" class=\"headerlink\" title=\"JAVA\"></a>JAVA</h3><p><img src=\"/2020/05/07/jvm-optimization/6.png\" alt=\"JAVA\"></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> xzy<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>openjdk<span class=\"token punctuation\">.</span>jol<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">.</span>ClassLayout<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        Object obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>ClassLayout<span class=\"token punctuation\">.</span><span class=\"token function\">parseInstance</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toPrintable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//===================================================================</span>\n# <span class=\"token operator\">-</span>XX<span class=\"token operator\">:</span><span class=\"token operator\">-</span>UseCompressedOops\njava<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object object internals<span class=\"token operator\">:</span>\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      <span class=\"token number\">0</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">01</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000001</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">4</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">8</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           <span class=\"token number\">00</span> 1c <span class=\"token number\">95</span> <span class=\"token function\">1e</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00011100</span> <span class=\"token number\">10010101</span> <span class=\"token number\">00011110</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">513088512</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">12</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nInstance size<span class=\"token operator\">:</span> <span class=\"token number\">16</span> bytes\nSpace losses<span class=\"token operator\">:</span> <span class=\"token number\">0</span> bytes internal <span class=\"token operator\">+</span> <span class=\"token number\">0</span> bytes external <span class=\"token operator\">=</span> <span class=\"token number\">0</span> bytes total\n<span class=\"token comment\" spellcheck=\"true\">//===================================================================</span>\njava<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object object internals<span class=\"token operator\">:</span>\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      <span class=\"token number\">0</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">01</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000001</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">4</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">8</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           e5 <span class=\"token number\">01</span> <span class=\"token number\">00</span> <span class=\"token function\">f8</span> <span class=\"token punctuation\">(</span><span class=\"token number\">11100101</span> <span class=\"token number\">00000001</span> <span class=\"token number\">00000000</span> <span class=\"token number\">11111000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">134217243</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">12</span>     <span class=\"token function\">4</span>        <span class=\"token punctuation\">(</span>loss due to the next object alignment<span class=\"token punctuation\">)</span>\nInstance size<span class=\"token operator\">:</span> <span class=\"token number\">16</span> bytes\nSpace losses<span class=\"token operator\">:</span> <span class=\"token number\">0</span> bytes internal <span class=\"token operator\">+</span> <span class=\"token number\">4</span> bytes external <span class=\"token operator\">=</span> <span class=\"token number\">4</span> bytes total\n\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>ClassLayout<span class=\"token punctuation\">.</span><span class=\"token function\">parseInstance</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toPrintable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//==========================================================</span>\n<span class=\"token punctuation\">[</span>Ljava<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object<span class=\"token punctuation\">;</span> object internals<span class=\"token operator\">:</span>\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      <span class=\"token number\">0</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">01</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000001</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">4</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">8</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           <span class=\"token number\">60</span> c7 b1 <span class=\"token function\">1e</span> <span class=\"token punctuation\">(</span><span class=\"token number\">01100000</span> <span class=\"token number\">11000111</span> <span class=\"token number\">10110001</span> <span class=\"token number\">00011110</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">514967392</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">12</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">16</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           0a <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00001010</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">20</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>alignment<span class=\"token operator\">/</span>padding gap<span class=\"token punctuation\">)</span>                  \n     <span class=\"token number\">24</span>    <span class=\"token number\">80</span>   java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object Object<span class=\"token punctuation\">;</span><span class=\"token punctuation\">.</span>&lt;elements<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>                        N<span class=\"token operator\">/</span>A\nInstance size<span class=\"token operator\">:</span> <span class=\"token number\">104</span> bytes\nSpace losses<span class=\"token operator\">:</span> <span class=\"token number\">4</span> bytes internal <span class=\"token operator\">+</span> <span class=\"token number\">0</span> bytes external <span class=\"token operator\">=</span> <span class=\"token number\">4</span> bytes total\n<span class=\"token comment\" spellcheck=\"true\">//=========================================================</span>\n <span class=\"token punctuation\">[</span>Ljava<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object<span class=\"token punctuation\">;</span> object internals<span class=\"token operator\">:</span>\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      <span class=\"token number\">0</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">01</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000001</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">4</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token number\">8</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>Class <span class=\"token class-name\">Pointer</span>                           3c <span class=\"token number\">23</span> <span class=\"token number\">00</span> <span class=\"token function\">f8</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00111100</span> <span class=\"token number\">00100011</span> <span class=\"token number\">00000000</span> <span class=\"token number\">11111000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">134208708</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">12</span>     <span class=\"token function\">4</span>                    <span class=\"token punctuation\">(</span>object header<span class=\"token punctuation\">)</span>                           0a <span class=\"token number\">00</span> <span class=\"token number\">00</span> <span class=\"token function\">00</span> <span class=\"token punctuation\">(</span><span class=\"token number\">00001010</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n     <span class=\"token number\">16</span>    <span class=\"token number\">40</span>   java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Object Object<span class=\"token punctuation\">;</span><span class=\"token punctuation\">.</span>&lt;elements<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>                        N<span class=\"token operator\">/</span>A\nInstance size<span class=\"token operator\">:</span> <span class=\"token number\">56</span> bytes\nSpace losses<span class=\"token operator\">:</span> <span class=\"token number\">0</span> bytes internal <span class=\"token operator\">+</span> <span class=\"token number\">0</span> bytes external <span class=\"token operator\">=</span> <span class=\"token number\">0</span> bytes total</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>GC</p>\n<ul>\n<li>GC</li>\n<li>GC</li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<ol>\n<li>GC</li>\n<li>GCRoots</li>\n<li></li>\n</ol>\n","site":{"data":{}},"excerpt":"<h2 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"shell\">-Xms1024M: \n-Xmx1024M: \n-Xmn512M:\n-XX:newSize:(-Xms)\n-XX:MaxnewSize:(-Xmx)\n-Xmn:(eden + 2 survivor,-XX:NewSize-XX:MaxNewSize)\n-XX:NewRatio=n: :3131/4\n-XX:SurvivorRatio=n: EdenSurvivorSurvivor3EdenSurvivor=32Survivor1/5\n-Xss256K: \n-XX:MetaspaceSize=n \n-XX:MaxMetaspaceSize=n </code></pre>","more":"<p></p>\n<pre><code class=\"shell\">java -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxTenuringThreshold=0\n#-XX:NewRatio=4:EdenSurvivor4141/5\n#-XX:SurvivorRatio=4EdenSurvivor4SurvivorEden2:4Survivor1/6\n#-XX:MaxTenuringThreshold=0 0Survivor()</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JVM</p>\n<ul>\n<li>GC</li>\n<li>GC</li>\n<li>(CMS)GC</li>\n</ul>\n<p></p>\n<p>1CPU : -XX:+UseSerialGC</p>\n<p>2CPU-XX:+UseParallelGC  -XX:+UseParallelOldGC</p>\n<p>3CPU-XX:+UseParNewGC  -XX:+UseConcMarkSweepGC</p>\n<p>C/S<strong></strong>CMS</p>\n<pre><code class=\"shell\">-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+UseCMSCompactAtFullCollection\n#-XX:+UseConcMarkSweepGC \n#-XX:+UseParNewGC: \n#-XX:+UseCMSCompactAtFullCollection </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://xuzyblog.top/2019/02/18/gc-log/\" target=\"_blank\" rel=\"noopener\">GC</a></p>\n<p></p>\n<p> : <strong>-XX:+ -XX:- </strong></p>\n<pre><code class=\"shell\">-XX:+DisableExplicitGC #System.gc()System.gc()FullGC\n-XX:+UseCompressedOops #\n-XX:+CMSParallelRemarkEnabled #\n-XX:CMSInitiatingOccupancyFraction=70 #cms,70CMS</code></pre>\n<h2 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>GCGCGCGC1-3GC</strong></p>\n<p>GC</p>\n<ul>\n<li>Minor GC100ms</li>\n<li>Minor GC5</li>\n<li>Full GC1s</li>\n<li>Full GC11</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>GC</li>\n<li>GC</li>\n<li>Full GC</li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li>JavaGC</li>\n<li> ()</li>\n<li></li>\n<li>=21</li>\n<li>GC</li>\n<li></li>\n</ul>\n<p>Full GC</p>\n<ul>\n<li>YGCTo SurvivorSurvivor</li>\n<li>YGC</li>\n<li>To Survivor To SurvivorSurvivor</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>IO RPCMQHTTP  TP9999  Young </li>\n<li> Hadoop HBaseCassandraOld </li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Minor GCJVM<strong></strong></p>\n<ul>\n<li><strong>Minor GC</strong></li>\n<li><strong>HandlePromotionFailure</strong>HandlePromotionFailure=true<strong></strong>Minor GCMinor GCHandlePromotionFailure=falseFull GC</li>\n</ul>\n<p><strong></strong></p>\n<p><strong></strong>Minor GCSurvivorSurvivor<strong></strong><strong></strong>Full GC</p>\n<p><img src=\"/2020/05/07/jvm-optimization/1.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>YGCTo Survivor</li>\n<li>YGC-XXMaxTenuringThreshold = 15</li>\n<li>-XXPretenureSizeThreshold</li>\n<li>To Survivor To Survivor</li>\n</ul>\n<h3 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h3><ul>\n<li>FGCMajor GC<strong>FGC</strong></li>\n<li>FGC(-XX:CMSInitiatingOccupancyFraction=70 CMS70%GC</li>\n<li>YGCYGC HandlePromotionFailure Full GC Full GC</li>\n<li>Metaspace-XX:MetaspaceSize FGC</li>\n<li>System.gc() Runtime.gc() FGC</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> Java  3 </p>\n<ul>\n<li>-<ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li></li>\n<li> 11 </li>\n<li></li>\n</ul>\n</li>\n<li>-<ul>\n<li>-</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"CMS\"><a href=\"#CMS\" class=\"headerlink\" title=\"CMS\"></a>CMS</h3><p>CMS*<font color=\"red\">-</font>*GC<font color=\"red\">Stop The World</font>B/S</p>\n<p><strong>CMS</strong></p>\n<p>CMS<strong>-</strong></p>\n<ul>\n<li>(<font color=\"red\">Stop The World</font>)GC Roots</li>\n<li><ul>\n<li>GcRoots</li>\n<li></li>\n</ul>\n</li>\n<li><strong></strong>Card()Dirty()Dirty Card</li>\n<li><em>CMSPrecleaningEnabled</em><strong></strong></li>\n<li>  <font color=\"red\">Stop The World</font></li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li>CMS</li>\n<li>CMSCMS GC</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>-XX:+UseCMSInitiatingOccupancyOnly  -XXCMSInitiatingOccupancyFractionCMSFullGC</li>\n<li>-XX:+UseCMSCompactAtFullCollectionFull GC</li>\n<li>-XX:CMSFullGCsBeforeCompaction Full GCFull GC</li>\n<li>CMSScavengeBeforeRemark minor gc</li>\n<li>CMSMaxAbortablePrecleanTime = 5 5minor gc</li>\n</ul>\n<p><strong>CMSConcurrent mode failure</strong></p>\n<ul>\n<li>CMSconcurrent mode failureCMSFull GC</li>\n<li>minor gcCMSconcurrent mode failure</li>\n<li>Java8,CMSFull GC</li>\n</ul>\n<p> </p>\n<ul>\n<li></li>\n<li>CMS<em>CMSInitiatingOccupancyFraction</em>Java<strong> GC  CMS  CMS </strong></li>\n<li>CMS<em>CPU + 3/4</em>-XX:ParallelCMSThreads</li>\n</ul>\n<h3 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h3><p>-XX:MaxTenuringThreshold=3GC(<strong>SurvivorSurvivorMaxTenuringThreshold</strong>)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/05/07/jvm-optimization/3.png\" alt=\"\"></p>\n<h3 id=\"JVM\"><a href=\"#JVM\" class=\"headerlink\" title=\"JVM\"></a>JVM</h3><p><img src=\"/2020/05/07/jvm-optimization/4.png\" alt=\"jvm\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src alt>)<img src=\"/2020/05/07/jvm-optimization/5.png\" alt=\"5\"></p>\n<h3 id=\"JAVA\"><a href=\"#JAVA\" class=\"headerlink\" title=\"JAVA\"></a>JAVA</h3><p><img src=\"/2020/05/07/jvm-optimization/6.png\" alt=\"JAVA\"></p>\n<pre><code class=\"java\">package xzy;\nimport org.openjdk.jol.info.ClassLayout;\npublic class OtherTest {\n    public static void main(String[] args){\n        Object obj = new Object();\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//===================================================================\n# -XX:-UseCompressedOops\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           00 1c 95 1e (00000000 00011100 10010101 00011110) (513088512)\n     12     4        (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total\n//===================================================================\njava.lang.Object object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)Class Pointer                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)\n     12     4        (loss due to the next object alignment)\nInstance size: 16 bytes\nSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total\n\n\npublic class OtherTest {\n    public static void main(String[] args){\n        Object[] obj = new Object[10];\n        System.out.println(ClassLayout.parseInstance(obj).toPrintable());\n    }\n}\n//==========================================================\n[Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           60 c7 b1 1e (01100000 11000111 10110001 00011110) (514967392)\n     12     4                    (object header)Class Pointer                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n     16     4                    (object header)Class Pointer                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     20     4                    (alignment/padding gap)                  \n     24    80   java.lang.Object Object;.&lt;elements&gt;(8 * 10)                        N/A\nInstance size: 104 bytes\nSpace losses: 4 bytes internal + 0 bytes external = 4 bytes total\n//=========================================================\n [Ljava.lang.Object; object internals:\n OFFSET  SIZE               TYPE DESCRIPTION                               VALUE\n      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4                    (object header)Class Pointer                           3c 23 00 f8 (00111100 00100011 00000000 11111000) (-134208708)\n     12     4                    (object header)                           0a 00 00 00 (00001010 00000000 00000000 00000000) (10)\n     16    40   java.lang.Object Object;.&lt;elements&gt;(4 * 10)                        N/A\nInstance size: 56 bytes\nSpace losses: 0 bytes internal + 0 bytes external = 0 bytes total</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>GC</p>\n<ul>\n<li>GC</li>\n<li>GC</li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<ol>\n<li>GC</li>\n<li>GCRoots</li>\n<li></li>\n</ol>"},{"title":"Kafka100%","description":"Kafka100%","date":"2020-12-02T09:35:09.000Z","_content":"## Kafka\n\nKafkaBrokerProducer\n\n### Broker\n\nBrokerKafkakafkakafkalinuxlinuxPage cachepage cachefilefsyncpage cache\n\n![BrokerlinuxReplica](kafka-messge-complete/1.png)\n\nBrokerLinuxflusher<font color=red>syncfsync</font><font color=red></font><font color=red>dirty data</font> Broker\n\nkafkaproducerbrokerbrokerproducerbrokerretryproducerBroker `ack`\n\n- acks=0producerbroker\n- acks=1leaderfollowerackPageCacheproducerfollowers\n- ackas=allleaderISRfollowerleaderpagecacheackISRack\n\n### Producer\n\nIOproducerbufferbuffer\n\n![producerBroker](kafka-messge-complete/2.png)\n\n## \n\nBrokerProducer100%\n\n- Brokderack=all\n- Producerbuffer\n\n<font color=red>100%</font>\n\n** + **\n\n![](kafka-messge-complete/3.png)\n\n\n\n1. RedisDBredis\n2. RedisRedis\n3. Redis\n\n****MQack","source":"_posts/kafka-messge-complete.md","raw":"---\ntitle: Kafka100%\ntags:\n  - kafka\ncategories:  kafka\ndescription : Kafka100%\ndate: 2020-12-02 17:35:09\n---\n## Kafka\n\nKafkaBrokerProducer\n\n### Broker\n\nBrokerKafkakafkakafkalinuxlinuxPage cachepage cachefilefsyncpage cache\n\n![BrokerlinuxReplica](kafka-messge-complete/1.png)\n\nBrokerLinuxflusher<font color=red>syncfsync</font><font color=red></font><font color=red>dirty data</font> Broker\n\nkafkaproducerbrokerbrokerproducerbrokerretryproducerBroker `ack`\n\n- acks=0producerbroker\n- acks=1leaderfollowerackPageCacheproducerfollowers\n- ackas=allleaderISRfollowerleaderpagecacheackISRack\n\n### Producer\n\nIOproducerbufferbuffer\n\n![producerBroker](kafka-messge-complete/2.png)\n\n## \n\nBrokerProducer100%\n\n- Brokderack=all\n- Producerbuffer\n\n<font color=red>100%</font>\n\n** + **\n\n![](kafka-messge-complete/3.png)\n\n\n\n1. RedisDBredis\n2. RedisRedis\n3. Redis\n\n****MQack","slug":"kafka-messge-complete","published":1,"updated":"2021-04-08T00:47:06.787Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv3000zqwv2940fawon","content":"<h2 id=\"Kafka\"><a href=\"#Kafka\" class=\"headerlink\" title=\"Kafka\"></a>Kafka</h2><p>KafkaBrokerProducer</p>\n<h3 id=\"Broker\"><a href=\"#Broker\" class=\"headerlink\" title=\"Broker\"></a>Broker</h3><p>BrokerKafkakafkakafkalinuxlinuxPage cachepage cachefilefsyncpage cache</p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/1.png\" alt=\"BrokerlinuxReplica\"></p>\n<p>BrokerLinuxflusher<font color=\"red\">syncfsync</font><font color=\"red\"></font><font color=\"red\">dirty data</font> Broker</p>\n<p>kafkaproducerbrokerbrokerproducerbrokerretryproducerBroker <code>ack</code></p>\n<ul>\n<li>acks=0producerbroker</li>\n<li>acks=1leaderfollowerackPageCacheproducerfollowers</li>\n<li>ackas=allleaderISRfollowerleaderpagecacheackISRack</li>\n</ul>\n<h3 id=\"Producer\"><a href=\"#Producer\" class=\"headerlink\" title=\"Producer\"></a>Producer</h3><p>IOproducerbufferbuffer</p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/2.png\" alt=\"producerBroker\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>BrokerProducer100%</p>\n<ul>\n<li>Brokderack=all</li>\n<li>Producerbuffer</li>\n</ul>\n<p><font color=\"red\">100%</font></p>\n<p><strong> + </strong></p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/3.png\" alt></p>\n<p></p>\n<ol>\n<li>RedisDBredis</li>\n<li>RedisRedis</li>\n<li>Redis</li>\n</ol>\n<p><strong></strong>MQack</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Kafka\"><a href=\"#Kafka\" class=\"headerlink\" title=\"Kafka\"></a>Kafka</h2><p>KafkaBrokerProducer</p>\n<h3 id=\"Broker\"><a href=\"#Broker\" class=\"headerlink\" title=\"Broker\"></a>Broker</h3><p>BrokerKafkakafkakafkalinuxlinuxPage cachepage cachefilefsyncpage cache</p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/1.png\" alt=\"BrokerlinuxReplica\"></p>\n<p>BrokerLinuxflusher<font color=\"red\">syncfsync</font><font color=\"red\"></font><font color=\"red\">dirty data</font> Broker</p>\n<p>kafkaproducerbrokerbrokerproducerbrokerretryproducerBroker <code>ack</code></p>\n<ul>\n<li>acks=0producerbroker</li>\n<li>acks=1leaderfollowerackPageCacheproducerfollowers</li>\n<li>ackas=allleaderISRfollowerleaderpagecacheackISRack</li>\n</ul>\n<h3 id=\"Producer\"><a href=\"#Producer\" class=\"headerlink\" title=\"Producer\"></a>Producer</h3><p>IOproducerbufferbuffer</p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/2.png\" alt=\"producerBroker\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>BrokerProducer100%</p>\n<ul>\n<li>Brokderack=all</li>\n<li>Producerbuffer</li>\n</ul>\n<p><font color=\"red\">100%</font></p>\n<p><strong> + </strong></p>\n<p><img src=\"/2020/12/02/kafka-messge-complete/3.png\" alt></p>\n<p></p>\n<ol>\n<li>RedisDBredis</li>\n<li>RedisRedis</li>\n<li>Redis</li>\n</ol>\n<p><strong></strong>MQack</p>\n"},{"title":"Kafka","description":"Kafka","date":"2019-11-16T01:22:03.000Z","_content":"\n### \n\n****\n\n```shell\n#window\n.\\bin\\windows\\kafka-topics.bat --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n#shell\nsh kafka-topics.sh --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n```\n\n### \n\n","source":"_posts/kafka-operation.md","raw":"---\ntitle: Kafka\ntags:\n  - kafka\ncategories:  kafka\ndescription : Kafka\ndate: 2019-11-16 09:22:03\n---\n\n### \n\n****\n\n```shell\n#window\n.\\bin\\windows\\kafka-topics.bat --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n#shell\nsh kafka-topics.sh --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n```\n\n### \n\n","slug":"kafka-operation","published":1,"updated":"2021-04-08T00:47:06.797Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv50013qwv20sa97ixg","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#window\n.\\bin\\windows\\kafka-topics.bat --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n#shell\nsh kafka-topics.sh --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<pre><code class=\"shell\">#window\n.\\bin\\windows\\kafka-topics.bat --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001\n#shell\nsh kafka-topics.sh --create  --zookeeper localhost:2181 --replication-factor 1 --partitions 6 --topic test001</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n"},{"title":"Kafka","description":"Kafka","date":"2019-11-15T09:35:09.000Z","_content":"","source":"_posts/kafka-muticustomerthread.md","raw":"---\ntitle: Kafka\ntags:\n  - kafka\ncategories:  kafka\ndescription : Kafka\ndate: 2019-11-15 17:35:09\n---\n","slug":"kafka-muticustomerthread","published":1,"updated":"2021-04-08T00:47:06.797Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv70016qwv27dy1djjx","content":"<p></p>\n","site":{"data":{}},"excerpt":"","more":"<p></p>\n"},{"title":"MySQLcount(*)count(1)count()","description":"MySQLcount(*)count(1)count()","date":"2020-01-26T00:30:14.000Z","_content":"## \ncount()  count  NULL 1\n<!--more-->\n### InnoDBcount\n\ncount(*)count( id)  count(1) count() NULL \n- **count(id)**InnoDBidserverserver  id NULLcount(id)NULL\n\n  \n\n- ** count(1) **InnoDB <font color=red></font>server\"1\"count(id)NULL\n\n  \n\n- ** count() **count()not nullNULL\n  \n  -  not null  null\n  -  null null null \n  \n  \n  \n- ** count(\\*) **count(*)  null\n\n<font size=5 color=red>count() < count( id) < count(1)  count(\\*)</font>  count(\\*)\n\n### MyISAMcount\n\nMyISAM  count(*) \n\n## \n\n- MYSQL45","source":"_posts/mysql-count.md","raw":"---\ntitle: MySQLcount(*)count(1)count()\ntags:\n  - mysql\ncategories:  mysql\ndescription : MySQLcount(*)count(1)count()\ndate: 2020-01-26 08:30:14\n---\n## \ncount()  count  NULL 1\n<!--more-->\n### InnoDBcount\n\ncount(*)count( id)  count(1) count() NULL \n- **count(id)**InnoDBidserverserver  id NULLcount(id)NULL\n\n  \n\n- ** count(1) **InnoDB <font color=red></font>server\"1\"count(id)NULL\n\n  \n\n- ** count() **count()not nullNULL\n  \n  -  not null  null\n  -  null null null \n  \n  \n  \n- ** count(\\*) **count(*)  null\n\n<font size=5 color=red>count() < count( id) < count(1)  count(\\*)</font>  count(\\*)\n\n### MyISAMcount\n\nMyISAM  count(*) \n\n## \n\n- MYSQL45","slug":"mysql-count","published":1,"updated":"2021-04-08T00:47:06.837Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv8001bqwv2a2f8989q","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>count()  count  NULL 1</p>\n<a id=\"more\"></a>\n<h3 id=\"InnoDBcount\"><a href=\"#InnoDBcount\" class=\"headerlink\" title=\"InnoDBcount\"></a>InnoDBcount</h3><p>count(*)count( id)  count(1) count() NULL </p>\n<ul>\n<li><strong>count(id)</strong>InnoDBidserverserver  id NULLcount(id)NULL</li>\n</ul>\n<ul>\n<li><strong> count(1) </strong>InnoDB <font color=\"red\"></font>server1count(id)NULL</li>\n</ul>\n<ul>\n<li><p><strong> count() </strong>count()not nullNULL</p>\n<ul>\n<li> not null  null</li>\n<li> null null null </li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><strong> count(*) </strong>count(*)  null</li>\n</ul>\n<p><font size=\"5\" color=\"red\">count() &lt; count( id) &lt; count(1)  count(*)</font>  count(*)</p>\n<h3 id=\"MyISAMcount\"><a href=\"#MyISAMcount\" class=\"headerlink\" title=\"MyISAMcount\"></a>MyISAMcount</h3><p>MyISAM  count(*) </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQL45</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>count()  count  NULL 1</p>","more":"<h3 id=\"InnoDBcount\"><a href=\"#InnoDBcount\" class=\"headerlink\" title=\"InnoDBcount\"></a>InnoDBcount</h3><p>count(*)count( id)  count(1) count() NULL </p>\n<ul>\n<li><strong>count(id)</strong>InnoDBidserverserver  id NULLcount(id)NULL</li>\n</ul>\n<ul>\n<li><strong> count(1) </strong>InnoDB <font color=\"red\"></font>server1count(id)NULL</li>\n</ul>\n<ul>\n<li><p><strong> count() </strong>count()not nullNULL</p>\n<ul>\n<li> not null  null</li>\n<li> null null null </li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><strong> count(*) </strong>count(*)  null</li>\n</ul>\n<p><font size=\"5\" color=\"red\">count() &lt; count( id) &lt; count(1)  count(*)</font>  count(*)</p>\n<h3 id=\"MyISAMcount\"><a href=\"#MyISAMcount\" class=\"headerlink\" title=\"MyISAMcount\"></a>MyISAMcount</h3><p>MyISAM  count(*) </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQL45</li>\n</ul>"},{"title":"guava","description":"(/)guava","date":"2019-02-18T09:14:00.000Z","_content":"## \n\n<!--more-->\n### \n#### \n\n\n- \n- \n- \n- \n\n![](limit-single/1.png)\n\n\n()()\n,,(burst),(rate)\n\n#### \n\n### \n#### \n\n- 2r/s500\n- b\n- nn\n- n\n![](limit-single/2.png)\n\n#### \n34\n\n## Guava \nGuava RateLimiter(SmoothBursty)(SmoothWarmingUp)\n```\n//permits,0.0,\nlimiter.acquire(int permits)\n//permitstimeoutfalse\nlimiter.tryAcquire(int permits,long timeout, TimeUnit unit)\n```\n\n### \n\n```\n//55200\nRateLimiter limiter = RateLimiter.create(5);\n```\n\n```\nRateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\n//\n0.0\n0.185957\n0.19372\n0.197661\n0.199752\n0.174605\n```\n5r/s200ms0.19=200ms\n\n\n```\nRateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire(200));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.acquire(1));\nSystem.out.println((System.currentTimeMillis() - start) + \" ms\");\n//\n//0.0\n//39.973065\n//39980 ms\n```\n55200\nacquire(200)200200acquire(1)1540****\n\n**tryAcquire**\n\n```\n//RateLimiter.create(5) 55200\nRateLimiter limiter = RateLimiter.create(5);\n//10020\nSystem.out.println(limiter.tryAcquire(100));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.tryAcquire(5,60,TimeUnit.SECONDS));\nSystem.out.println((System.currentTimeMillis() - start) + \" ms\");\n//,false\nSystem.out.println(limiter.tryAcquire(1));\nTimeUnit.SECONDS.sleep(1);\n//15true\nSystem.out.println(limiter.tryAcquire(5));\n\ntrue\ntrue\n19999 ms\nfalse\ntrue\n```\n\n\nGuava****\n### \n\n```\npermitsPerSecondwarmupPeriod\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\n```\n\n```\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\nfor(int i = 0; i < 5;i++) {\n    System.out.println(limiter.acquire());\n}\nThread.sleep(1000L);\nfor(int i = 0; i < 5;i++) {\n    System.out.println(limiter.acquire());\n}\n//:\n0.0\n0.5156\n0.353969\n0.219001\n0.200086\n0.0\n0.3806\n0.229003\n0.199237\n0.200266\n```\nwarmupPeriod\n\n## \n- https://blog.csdn.net/John8169/article/details/81125706\n- https://my.oschina.net/hanchao/blog/1833612?appinstall=0","source":"_posts/limit-single.md","raw":"---\ntitle: guava\ntags:\n  - \ncategories:  java\ndescription : (/)guava\ndate: 2019-02-18 17:14:00\n---\n## \n\n<!--more-->\n### \n#### \n\n\n- \n- \n- \n- \n\n![](limit-single/1.png)\n\n\n()()\n,,(burst),(rate)\n\n#### \n\n### \n#### \n\n- 2r/s500\n- b\n- nn\n- n\n![](limit-single/2.png)\n\n#### \n34\n\n## Guava \nGuava RateLimiter(SmoothBursty)(SmoothWarmingUp)\n```\n//permits,0.0,\nlimiter.acquire(int permits)\n//permitstimeoutfalse\nlimiter.tryAcquire(int permits,long timeout, TimeUnit unit)\n```\n\n### \n\n```\n//55200\nRateLimiter limiter = RateLimiter.create(5);\n```\n\n```\nRateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\n//\n0.0\n0.185957\n0.19372\n0.197661\n0.199752\n0.174605\n```\n5r/s200ms0.19=200ms\n\n\n```\nRateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire(200));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.acquire(1));\nSystem.out.println((System.currentTimeMillis() - start) + \" ms\");\n//\n//0.0\n//39.973065\n//39980 ms\n```\n55200\nacquire(200)200200acquire(1)1540****\n\n**tryAcquire**\n\n```\n//RateLimiter.create(5) 55200\nRateLimiter limiter = RateLimiter.create(5);\n//10020\nSystem.out.println(limiter.tryAcquire(100));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.tryAcquire(5,60,TimeUnit.SECONDS));\nSystem.out.println((System.currentTimeMillis() - start) + \" ms\");\n//,false\nSystem.out.println(limiter.tryAcquire(1));\nTimeUnit.SECONDS.sleep(1);\n//15true\nSystem.out.println(limiter.tryAcquire(5));\n\ntrue\ntrue\n19999 ms\nfalse\ntrue\n```\n\n\nGuava****\n### \n\n```\npermitsPerSecondwarmupPeriod\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\n```\n\n```\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\nfor(int i = 0; i < 5;i++) {\n    System.out.println(limiter.acquire());\n}\nThread.sleep(1000L);\nfor(int i = 0; i < 5;i++) {\n    System.out.println(limiter.acquire());\n}\n//:\n0.0\n0.5156\n0.353969\n0.219001\n0.200086\n0.0\n0.3806\n0.229003\n0.199237\n0.200266\n```\nwarmupPeriod\n\n## \n- https://blog.csdn.net/John8169/article/details/81125706\n- https://my.oschina.net/hanchao/blog/1833612?appinstall=0","slug":"limit-single","published":1,"updated":"2021-04-08T00:47:06.797Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv9001eqwv28yb05t1b","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><img src=\"/2019/02/18/limit-single/1.png\" alt></p>\n<p><br>()()<br>,,(burst),(rate)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>2r/s500</li>\n<li>b</li>\n<li>nn</li>\n<li>n<br><img src=\"/2019/02/18/limit-single/2.png\" alt></li>\n</ul>\n<h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p>34</p>\n<h2 id=\"Guava-\"><a href=\"#Guava-\" class=\"headerlink\" title=\"Guava \"></a>Guava </h2><p>Guava RateLimiter(SmoothBursty)(SmoothWarmingUp)</p>\n<pre><code>//permits,0.0,\nlimiter.acquire(int permits)\n//permitstimeoutfalse\nlimiter.tryAcquire(int permits,long timeout, TimeUnit unit)</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code>//55200\nRateLimiter limiter = RateLimiter.create(5);</code></pre><pre><code>RateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\n//\n0.0\n0.185957\n0.19372\n0.197661\n0.199752\n0.174605</code></pre><p>5r/s200ms0.19=200ms</p>\n<pre><code>RateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire(200));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.acquire(1));\nSystem.out.println((System.currentTimeMillis() - start) + &quot; ms&quot;);\n//\n//0.0\n//39.973065\n//39980 ms</code></pre><p>55200<br>acquire(200)200200acquire(1)1540<strong></strong></p>\n<p><strong>tryAcquire</strong></p>\n<pre><code>//RateLimiter.create(5) 55200\nRateLimiter limiter = RateLimiter.create(5);\n//10020\nSystem.out.println(limiter.tryAcquire(100));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.tryAcquire(5,60,TimeUnit.SECONDS));\nSystem.out.println((System.currentTimeMillis() - start) + &quot; ms&quot;);\n//,false\nSystem.out.println(limiter.tryAcquire(1));\nTimeUnit.SECONDS.sleep(1);\n//15true\nSystem.out.println(limiter.tryAcquire(5));\n\ntrue\ntrue\n19999 ms\nfalse\ntrue</code></pre><p>Guava<strong></strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>permitsPerSecondwarmupPeriod\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);</code></pre><pre><code>RateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\nfor(int i = 0; i &lt; 5;i++) {\n    System.out.println(limiter.acquire());\n}\nThread.sleep(1000L);\nfor(int i = 0; i &lt; 5;i++) {\n    System.out.println(limiter.acquire());\n}\n//:\n0.0\n0.5156\n0.353969\n0.219001\n0.200086\n0.0\n0.3806\n0.229003\n0.199237\n0.200266</code></pre><p>warmupPeriod</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://blog.csdn.net/John8169/article/details/81125706\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/John8169/article/details/81125706</a></li>\n<li><a href=\"https://my.oschina.net/hanchao/blog/1833612?appinstall=0\" target=\"_blank\" rel=\"noopener\">https://my.oschina.net/hanchao/blog/1833612?appinstall=0</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><img src=\"/2019/02/18/limit-single/1.png\" alt></p>\n<p><br>()()<br>,,(burst),(rate)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>2r/s500</li>\n<li>b</li>\n<li>nn</li>\n<li>n<br><img src=\"/2019/02/18/limit-single/2.png\" alt></li>\n</ul>\n<h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p>34</p>\n<h2 id=\"Guava-\"><a href=\"#Guava-\" class=\"headerlink\" title=\"Guava \"></a>Guava </h2><p>Guava RateLimiter(SmoothBursty)(SmoothWarmingUp)</p>\n<pre><code>//permits,0.0,\nlimiter.acquire(int permits)\n//permitstimeoutfalse\nlimiter.tryAcquire(int permits,long timeout, TimeUnit unit)</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code>//55200\nRateLimiter limiter = RateLimiter.create(5);</code></pre><pre><code>RateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\nSystem.out.println(limiter.acquire());\n//\n0.0\n0.185957\n0.19372\n0.197661\n0.199752\n0.174605</code></pre><p>5r/s200ms0.19=200ms</p>\n<pre><code>RateLimiter limiter = RateLimiter.create(5);\nSystem.out.println(limiter.acquire(200));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.acquire(1));\nSystem.out.println((System.currentTimeMillis() - start) + &quot; ms&quot;);\n//\n//0.0\n//39.973065\n//39980 ms</code></pre><p>55200<br>acquire(200)200200acquire(1)1540<strong></strong></p>\n<p><strong>tryAcquire</strong></p>\n<pre><code>//RateLimiter.create(5) 55200\nRateLimiter limiter = RateLimiter.create(5);\n//10020\nSystem.out.println(limiter.tryAcquire(100));\nlong start = System.currentTimeMillis();\nSystem.out.println(limiter.tryAcquire(5,60,TimeUnit.SECONDS));\nSystem.out.println((System.currentTimeMillis() - start) + &quot; ms&quot;);\n//,false\nSystem.out.println(limiter.tryAcquire(1));\nTimeUnit.SECONDS.sleep(1);\n//15true\nSystem.out.println(limiter.tryAcquire(5));\n\ntrue\ntrue\n19999 ms\nfalse\ntrue</code></pre><p>Guava<strong></strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>permitsPerSecondwarmupPeriod\nRateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);</code></pre><pre><code>RateLimiter limiter = RateLimiter.create(5, 1000, TimeUnit.MILLISECONDS);\nfor(int i = 0; i &lt; 5;i++) {\n    System.out.println(limiter.acquire());\n}\nThread.sleep(1000L);\nfor(int i = 0; i &lt; 5;i++) {\n    System.out.println(limiter.acquire());\n}\n//:\n0.0\n0.5156\n0.353969\n0.219001\n0.200086\n0.0\n0.3806\n0.229003\n0.199237\n0.200266</code></pre><p>warmupPeriod</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://blog.csdn.net/John8169/article/details/81125706\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/John8169/article/details/81125706</a></li>\n<li><a href=\"https://my.oschina.net/hanchao/blog/1833612?appinstall=0\" target=\"_blank\" rel=\"noopener\">https://my.oschina.net/hanchao/blog/1833612?appinstall=0</a></li>\n</ul>"},{"title":"LinuxnetstatTCP","description":"LinuxnetstatTCP","_content":"## TCP\n\n*TCP*Transmission Control Protocol<font color=red></font><font color=red></font><font color=red></font>\n\n/TCPTCP\n\n<font color=red></font>\n\n- ACKACK\n- ACKACK\n-  TCP\n- TCPMSS\n-  ACKACKACK()ACKACK\n- TCP\n- 1MSSACK1\n\n## TCP\n\nTCP:\n\n- TCP\n- \n- TCP\n\n![](linux-netstat/1.png)\n\n### \n\n![](linux-netstat/2.png)\n\n****\n\n1. TCPSYN=1TCPseqx`SYN_SENT`\n2. TCPseq=yy,SYN=1TCPackackseq1TCPack1\n3. TCP1ACKseq1SYN=1ACK=y+1seq=x+1\n\nSYNseqack\n\n- SYNTCP1\n- seqackseq=100ack=100+1seq=200200yack=200+1\n- seqack\n\n### \n\n![](linux-netstat/3.png)\n\n1. TCPFIN=1seqx\n2. ackseq=y\n3. FIN=1seq=y\n4.TCPseqACKACKTCPseq1\n\n### TCP11\n\n![](linux-netstat/4.png)\n\n1. CLOSED\n2. socketLISTEN\n3. SYNSYN_SENT\n4. ACKSYNSYN_RCVD\n5. ACKSYNACKESTABLISHED\n6. ACKESTABLISHED3\n\n![](linux-netstat/5.png)\n\nTCP \n1. FINFIN_WAIT1 \n2. FINACKCLOSE_WAIT \n3. ACKFIN_WAIT2 \n4. FINLAST_ACK \n5. FINACKTIME_WAIT \n6. 2MSLCLOSEDACKCLOSED \nCLOSING \n\n****\n\n|          |                                                          |\n| ------------ | ------------------------------------------------------------ |\n| LISTEN       | TCP                            |\n| SYN_SENT     |                    |\n| SYN_RECEIVED |      |\n| ESTABLISHED  |                        |\n| FIN_WAIT_1   | TCP |\n| FIN_WAIT_2   | TCP                                    |\n| CLOSE_WAIT   |                                    |\n| CLOSING      | TCP                                |\n| LAST_ACK     | TCP                    |\n| TIME_WAIT    | TCP  |\n\n### \n\nhttps://juejin.cn/post/6900439208641921038\n\n**TCP4**\n\nTCPTCP  \n\nhttps://blog.csdn.net/lengxiao1993/article/details/82771768\n\n****\n\n1. ASYN + sequence\n2. BA SYN +  sequence + ACKA\n\nABBAABBACKAAB\n\n**TCP**\n\n![](linux-netstat/6.png)\n\n\n\n- \n- seqackTCP1\n- 6URGACK:PSH:RST:SYN:FIN\n- 16bit65535\n\n**TCP**\n\nTCPACK()\n\n**TIME_WAIT2MSL**\n\n1. TIME_WAITACKACKFINACKTIME_WAITFINRSTRST\n2. MSL\"\"\n\n**TIME_WAITCLOSE_WAIT**\n\nCLOSE_WAITFINACKCLOSE_WAITFINLAST_ACKACK\n\nTIME_WAITFIN_WAIT_2FINTIME_WAITMSL(Maximum Segment Lifetime:)\n\n**TCPUDP**\n\n1. udptcp\n2. udptcp\n3. udptcp\n4. udptcp\n\n**TCP**\n\n(socket)()pag1=100pag2=200300pag1,pag2MSSTCP\n\n:\n\n1. \n2. \n3. \n\nhttps://zhuanlan.zhihu.com/p/90057929\n\n**LinuxTCP**\n\nhttps://zhuanlan.zhihu.com/p/138263151\n\nhttps://blog.csdn.net/sqlquan/article/details/111561959\n\n**nagle**\n\n## netstat\n\nnetstatIPTCPUDPICMPnetstatTCPTCPUDP\n\nTCP\n\n```shell\n[root@Master1 ~]# netstat -ant #tTCP\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address               Foreign Address             State      \ntcp        0      0 0.0.0.0:63501               0.0.0.0:*                   LISTEN    \ntcp        1      0 127.0.0.1:44176             127.0.0.1:60047             CLOSE_WAIT  \ntcp        0      0 10.8.198.151:60884          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:55672          10.8.2.27:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:60882          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:63501          10.8.133.245:59893          ESTABLISHED \ntcp        0      0 10.8.198.151:60976          10.8.2.30:61235             TIME_WAIT    \ntcp        0      0 ::ffff:127.0.0.1:9600       :::*                        LISTEN      \ntcp        0      0 :::63501                    :::*                        LISTEN          \ntcp        0      0 ::ffff:10.8.198.151:60061   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:60050   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        1      0 ::1:60047                   ::1:43724                   CLOSE_WAIT  \ntcp        0      0 ::ffff:10.8.198.151:45024   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:43592   ::ffff:10.8.215.65:34710    TIME_WAIT  \n#Local Address - IP/\n#Foreign Address - IP/\n#State  - TCP11\n```\n\nnetstatTCPMySQL\n\n```\nnetstat -ant | grep 3306\n```\n\n## tcpdump\n\ntcp\n\n```shell\ntcpdump -n port 3306 #3306TCP -n\n#  3\n11:38:15.679863 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [S], seq 4065722321, win 29200, options [mss 1460,sackOK,TS val 2997352 ecr 0,nop,wscale 7], length 0\n11:38:15.679923 IP 172.18.0.3.3306 > 172.18.0.5.38822: Flags [S.], seq 780487619, ack 4065722322, win 28960, options [mss 1460,sackOK,TS val 2997352 ecr 2997352,nop,wscale 7], length 0\n11:38:15.679936 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [.], ack 1, win 229, options [nop,nop,TS val 2997352 ecr 2997352], length 0\n```\n\n```shell\n# 3306TCP10.8.152.162 \ntcpdump -n port 3306 and host 10.8.152.162 \n# 210.27.48.1 210.27.48.2 210.27.48.3\ntcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\) \n# 210.27.48.1telnet\ntcpdump tcp port 23 and host 210.27.48.1\n```\n\n## \n\n- https://juejin.cn/post/6844903734300901390\n- [Linux tcpdump](https://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html)\n- [wireshark](https://www.cnblogs.com/mq0036/p/11187138.html)","source":"_posts/linux-netstat.md","raw":"---\ntitle: LinuxnetstatTCP\ntags:\n  - linux\n  - \ncategories:  linux\ndescription: LinuxnetstatTCP\n---\n## TCP\n\n*TCP*Transmission Control Protocol<font color=red></font><font color=red></font><font color=red></font>\n\n/TCPTCP\n\n<font color=red></font>\n\n- ACKACK\n- ACKACK\n-  TCP\n- TCPMSS\n-  ACKACKACK()ACKACK\n- TCP\n- 1MSSACK1\n\n## TCP\n\nTCP:\n\n- TCP\n- \n- TCP\n\n![](linux-netstat/1.png)\n\n### \n\n![](linux-netstat/2.png)\n\n****\n\n1. TCPSYN=1TCPseqx`SYN_SENT`\n2. TCPseq=yy,SYN=1TCPackackseq1TCPack1\n3. TCP1ACKseq1SYN=1ACK=y+1seq=x+1\n\nSYNseqack\n\n- SYNTCP1\n- seqackseq=100ack=100+1seq=200200yack=200+1\n- seqack\n\n### \n\n![](linux-netstat/3.png)\n\n1. TCPFIN=1seqx\n2. ackseq=y\n3. FIN=1seq=y\n4.TCPseqACKACKTCPseq1\n\n### TCP11\n\n![](linux-netstat/4.png)\n\n1. CLOSED\n2. socketLISTEN\n3. SYNSYN_SENT\n4. ACKSYNSYN_RCVD\n5. ACKSYNACKESTABLISHED\n6. ACKESTABLISHED3\n\n![](linux-netstat/5.png)\n\nTCP \n1. FINFIN_WAIT1 \n2. FINACKCLOSE_WAIT \n3. ACKFIN_WAIT2 \n4. FINLAST_ACK \n5. FINACKTIME_WAIT \n6. 2MSLCLOSEDACKCLOSED \nCLOSING \n\n****\n\n|          |                                                          |\n| ------------ | ------------------------------------------------------------ |\n| LISTEN       | TCP                            |\n| SYN_SENT     |                    |\n| SYN_RECEIVED |      |\n| ESTABLISHED  |                        |\n| FIN_WAIT_1   | TCP |\n| FIN_WAIT_2   | TCP                                    |\n| CLOSE_WAIT   |                                    |\n| CLOSING      | TCP                                |\n| LAST_ACK     | TCP                    |\n| TIME_WAIT    | TCP  |\n\n### \n\nhttps://juejin.cn/post/6900439208641921038\n\n**TCP4**\n\nTCPTCP  \n\nhttps://blog.csdn.net/lengxiao1993/article/details/82771768\n\n****\n\n1. ASYN + sequence\n2. BA SYN +  sequence + ACKA\n\nABBAABBACKAAB\n\n**TCP**\n\n![](linux-netstat/6.png)\n\n\n\n- \n- seqackTCP1\n- 6URGACK:PSH:RST:SYN:FIN\n- 16bit65535\n\n**TCP**\n\nTCPACK()\n\n**TIME_WAIT2MSL**\n\n1. TIME_WAITACKACKFINACKTIME_WAITFINRSTRST\n2. MSL\"\"\n\n**TIME_WAITCLOSE_WAIT**\n\nCLOSE_WAITFINACKCLOSE_WAITFINLAST_ACKACK\n\nTIME_WAITFIN_WAIT_2FINTIME_WAITMSL(Maximum Segment Lifetime:)\n\n**TCPUDP**\n\n1. udptcp\n2. udptcp\n3. udptcp\n4. udptcp\n\n**TCP**\n\n(socket)()pag1=100pag2=200300pag1,pag2MSSTCP\n\n:\n\n1. \n2. \n3. \n\nhttps://zhuanlan.zhihu.com/p/90057929\n\n**LinuxTCP**\n\nhttps://zhuanlan.zhihu.com/p/138263151\n\nhttps://blog.csdn.net/sqlquan/article/details/111561959\n\n**nagle**\n\n## netstat\n\nnetstatIPTCPUDPICMPnetstatTCPTCPUDP\n\nTCP\n\n```shell\n[root@Master1 ~]# netstat -ant #tTCP\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address               Foreign Address             State      \ntcp        0      0 0.0.0.0:63501               0.0.0.0:*                   LISTEN    \ntcp        1      0 127.0.0.1:44176             127.0.0.1:60047             CLOSE_WAIT  \ntcp        0      0 10.8.198.151:60884          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:55672          10.8.2.27:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:60882          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:63501          10.8.133.245:59893          ESTABLISHED \ntcp        0      0 10.8.198.151:60976          10.8.2.30:61235             TIME_WAIT    \ntcp        0      0 ::ffff:127.0.0.1:9600       :::*                        LISTEN      \ntcp        0      0 :::63501                    :::*                        LISTEN          \ntcp        0      0 ::ffff:10.8.198.151:60061   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:60050   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        1      0 ::1:60047                   ::1:43724                   CLOSE_WAIT  \ntcp        0      0 ::ffff:10.8.198.151:45024   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:43592   ::ffff:10.8.215.65:34710    TIME_WAIT  \n#Local Address - IP/\n#Foreign Address - IP/\n#State  - TCP11\n```\n\nnetstatTCPMySQL\n\n```\nnetstat -ant | grep 3306\n```\n\n## tcpdump\n\ntcp\n\n```shell\ntcpdump -n port 3306 #3306TCP -n\n#  3\n11:38:15.679863 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [S], seq 4065722321, win 29200, options [mss 1460,sackOK,TS val 2997352 ecr 0,nop,wscale 7], length 0\n11:38:15.679923 IP 172.18.0.3.3306 > 172.18.0.5.38822: Flags [S.], seq 780487619, ack 4065722322, win 28960, options [mss 1460,sackOK,TS val 2997352 ecr 2997352,nop,wscale 7], length 0\n11:38:15.679936 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [.], ack 1, win 229, options [nop,nop,TS val 2997352 ecr 2997352], length 0\n```\n\n```shell\n# 3306TCP10.8.152.162 \ntcpdump -n port 3306 and host 10.8.152.162 \n# 210.27.48.1 210.27.48.2 210.27.48.3\ntcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\) \n# 210.27.48.1telnet\ntcpdump tcp port 23 and host 210.27.48.1\n```\n\n## \n\n- https://juejin.cn/post/6844903734300901390\n- [Linux tcpdump](https://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html)\n- [wireshark](https://www.cnblogs.com/mq0036/p/11187138.html)","slug":"linux-netstat","published":1,"date":"2021-04-08T00:47:06.807Z","updated":"2021-04-08T00:47:06.807Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhv9001iqwv27jp34xc9","content":"<h2 id=\"TCP\"><a href=\"#TCP\" class=\"headerlink\" title=\"TCP\"></a>TCP</h2><p><em>TCP</em>Transmission Control Protocol<font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font></p>\n<p>/TCPTCP</p>\n<p><font color=\"red\"></font></p>\n<ul>\n<li>ACKACK</li>\n<li>ACKACK</li>\n<li>TCP</li>\n<li>TCPMSS</li>\n<li>ACKACKACK()ACKACK</li>\n<li>TCP</li>\n<li>1MSSACK1</li>\n</ul>\n<h2 id=\"TCP\"><a href=\"#TCP\" class=\"headerlink\" title=\"TCP\"></a>TCP</h2><p>TCP:</p>\n<ul>\n<li>TCP</li>\n<li></li>\n<li>TCP</li>\n</ul>\n<p><img src=\"/2021/04/08/linux-netstat/1.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-netstat/2.png\" alt=\"\"></p>\n<p><strong></strong></p>\n<ol>\n<li>TCPSYN=1TCPseqx<code>SYN_SENT</code></li>\n<li>TCPseq=yy,SYN=1TCPackackseq1TCPack1</li>\n<li>TCP1ACKseq1SYN=1ACK=y+1seq=x+1</li>\n</ol>\n<p>SYNseqack</p>\n<ul>\n<li>SYNTCP1</li>\n<li>seqackseq=100ack=100+1seq=200200yack=200+1</li>\n<li>seqack</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-netstat/3.png\" alt=\"\"></p>\n<ol>\n<li>TCPFIN=1seqx</li>\n<li>ackseq=y</li>\n<li>FIN=1seq=y</li>\n<li>TCPseqACKACKTCPseq1</li>\n</ol>\n<h3 id=\"TCP11\"><a href=\"#TCP11\" class=\"headerlink\" title=\"TCP11\"></a>TCP11</h3><p><img src=\"/2021/04/08/linux-netstat/4.png\" alt></p>\n<ol>\n<li>CLOSED</li>\n<li>socketLISTEN</li>\n<li>SYNSYN_SENT</li>\n<li>ACKSYNSYN_RCVD</li>\n<li>ACKSYNACKESTABLISHED</li>\n<li>ACKESTABLISHED3</li>\n</ol>\n<p><img src=\"/2021/04/08/linux-netstat/5.png\" alt></p>\n<p>TCP </p>\n<ol>\n<li>FINFIN_WAIT1 </li>\n<li>FINACKCLOSE_WAIT </li>\n<li>ACKFIN_WAIT2 </li>\n<li>FINLAST_ACK </li>\n<li>FINACKTIME_WAIT </li>\n<li>2MSLCLOSEDACKCLOSED<br>CLOSING </li>\n</ol>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>LISTEN</td>\n<td>TCP </td>\n</tr>\n<tr>\n<td>SYN_SENT</td>\n<td></td>\n</tr>\n<tr>\n<td>SYN_RECEIVED</td>\n<td></td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td></td>\n</tr>\n<tr>\n<td>FIN_WAIT_1</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>FIN_WAIT_2</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>CLOSE_WAIT</td>\n<td></td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>LAST_ACK</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>TIME_WAIT</td>\n<td>TCP </td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://juejin.cn/post/6900439208641921038\" target=\"_blank\" rel=\"noopener\">https://juejin.cn/post/6900439208641921038</a></p>\n<p><strong>TCP4</strong></p>\n<p>TCPTCP  </p>\n<p><a href=\"https://blog.csdn.net/lengxiao1993/article/details/82771768\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/lengxiao1993/article/details/82771768</a></p>\n<p><strong></strong></p>\n<ol>\n<li>ASYN + sequence</li>\n<li>BA SYN +  sequence + ACKA</li>\n</ol>\n<p>ABBAABBACKAAB</p>\n<p><strong>TCP</strong></p>\n<p><img src=\"/2021/04/08/linux-netstat/6.png\" alt></p>\n<p></p>\n<ul>\n<li></li>\n<li>seqackTCP1</li>\n<li>6URGACK:PSH:RST:SYN:FIN</li>\n<li>16bit65535</li>\n</ul>\n<p><strong>TCP</strong></p>\n<p>TCPACK()</p>\n<p><strong>TIME_WAIT2MSL</strong></p>\n<ol>\n<li>TIME_WAITACKACKFINACKTIME_WAITFINRSTRST</li>\n<li>MSL</li>\n</ol>\n<p><strong>TIME_WAITCLOSE_WAIT</strong></p>\n<p>CLOSE_WAITFINACKCLOSE_WAITFINLAST_ACKACK</p>\n<p>TIME_WAITFIN_WAIT_2FINTIME_WAITMSL(Maximum Segment Lifetime:)</p>\n<p><strong>TCPUDP</strong></p>\n<ol>\n<li>udptcp</li>\n<li>udptcp</li>\n<li>udptcp</li>\n<li>udptcp</li>\n</ol>\n<p><strong>TCP</strong></p>\n<p>(socket)()pag1=100pag2=200300pag1,pag2MSSTCP</p>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p><a href=\"https://zhuanlan.zhihu.com/p/90057929\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/90057929</a></p>\n<p><strong>LinuxTCP</strong></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/138263151\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/138263151</a></p>\n<p><a href=\"https://blog.csdn.net/sqlquan/article/details/111561959\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/sqlquan/article/details/111561959</a></p>\n<p><strong>nagle</strong></p>\n<h2 id=\"netstat\"><a href=\"#netstat\" class=\"headerlink\" title=\"netstat\"></a>netstat</h2><p>netstatIPTCPUDPICMPnetstatTCPTCPUDP</p>\n<p>TCP</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@Master1 ~]# netstat -ant #tTCP\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address               Foreign Address             State      \ntcp        0      0 0.0.0.0:63501               0.0.0.0:*                   LISTEN    \ntcp        1      0 127.0.0.1:44176             127.0.0.1:60047             CLOSE_WAIT  \ntcp        0      0 10.8.198.151:60884          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:55672          10.8.2.27:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:60882          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:63501          10.8.133.245:59893          ESTABLISHED \ntcp        0      0 10.8.198.151:60976          10.8.2.30:61235             TIME_WAIT    \ntcp        0      0 ::ffff:127.0.0.1:9600       :::*                        LISTEN      \ntcp        0      0 :::63501                    :::*                        LISTEN          \ntcp        0      0 ::ffff:10.8.198.151:60061   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:60050   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        1      0 ::1:60047                   ::1:43724                   CLOSE_WAIT  \ntcp        0      0 ::ffff:10.8.198.151:45024   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:43592   ::ffff:10.8.215.65:34710    TIME_WAIT  \n#Local Address - IP/\n#Foreign Address - IP/\n#State  - TCP11</code></pre>\n<p>netstatTCPMySQL</p>\n<pre><code>netstat -ant | grep 3306</code></pre><h2 id=\"tcpdump\"><a href=\"#tcpdump\" class=\"headerlink\" title=\"tcpdump\"></a>tcpdump</h2><p>tcp</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">tcpdump -n port 3306 #3306TCP -n\n#  3\n11:38:15.679863 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [S], seq 4065722321, win 29200, options [mss 1460,sackOK,TS val 2997352 ecr 0,nop,wscale 7], length 0\n11:38:15.679923 IP 172.18.0.3.3306 > 172.18.0.5.38822: Flags [S.], seq 780487619, ack 4065722322, win 28960, options [mss 1460,sackOK,TS val 2997352 ecr 2997352,nop,wscale 7], length 0\n11:38:15.679936 IP 172.18.0.5.38822 > 172.18.0.3.3306: Flags [.], ack 1, win 229, options [nop,nop,TS val 2997352 ecr 2997352], length 0</code></pre>\n<pre class=\" language-shell\"><code class=\"language-shell\"># 3306TCP10.8.152.162 \ntcpdump -n port 3306 and host 10.8.152.162 \n# 210.27.48.1 210.27.48.2 210.27.48.3\ntcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\) \n# 210.27.48.1telnet\ntcpdump tcp port 23 and host 210.27.48.1</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://juejin.cn/post/6844903734300901390\" target=\"_blank\" rel=\"noopener\">https://juejin.cn/post/6844903734300901390</a></li>\n<li><a href=\"https://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html\" target=\"_blank\" rel=\"noopener\">Linux tcpdump</a></li>\n<li><a href=\"https://www.cnblogs.com/mq0036/p/11187138.html\" target=\"_blank\" rel=\"noopener\">wireshark</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"TCP\"><a href=\"#TCP\" class=\"headerlink\" title=\"TCP\"></a>TCP</h2><p><em>TCP</em>Transmission Control Protocol<font color=\"red\"></font><font color=\"red\"></font><font color=\"red\"></font></p>\n<p>/TCPTCP</p>\n<p><font color=\"red\"></font></p>\n<ul>\n<li>ACKACK</li>\n<li>ACKACK</li>\n<li>TCP</li>\n<li>TCPMSS</li>\n<li>ACKACKACK()ACKACK</li>\n<li>TCP</li>\n<li>1MSSACK1</li>\n</ul>\n<h2 id=\"TCP\"><a href=\"#TCP\" class=\"headerlink\" title=\"TCP\"></a>TCP</h2><p>TCP:</p>\n<ul>\n<li>TCP</li>\n<li></li>\n<li>TCP</li>\n</ul>\n<p><img src=\"/2021/04/08/linux-netstat/1.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-netstat/2.png\" alt=\"\"></p>\n<p><strong></strong></p>\n<ol>\n<li>TCPSYN=1TCPseqx<code>SYN_SENT</code></li>\n<li>TCPseq=yy,SYN=1TCPackackseq1TCPack1</li>\n<li>TCP1ACKseq1SYN=1ACK=y+1seq=x+1</li>\n</ol>\n<p>SYNseqack</p>\n<ul>\n<li>SYNTCP1</li>\n<li>seqackseq=100ack=100+1seq=200200yack=200+1</li>\n<li>seqack</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-netstat/3.png\" alt=\"\"></p>\n<ol>\n<li>TCPFIN=1seqx</li>\n<li>ackseq=y</li>\n<li>FIN=1seq=y</li>\n<li>TCPseqACKACKTCPseq1</li>\n</ol>\n<h3 id=\"TCP11\"><a href=\"#TCP11\" class=\"headerlink\" title=\"TCP11\"></a>TCP11</h3><p><img src=\"/2021/04/08/linux-netstat/4.png\" alt></p>\n<ol>\n<li>CLOSED</li>\n<li>socketLISTEN</li>\n<li>SYNSYN_SENT</li>\n<li>ACKSYNSYN_RCVD</li>\n<li>ACKSYNACKESTABLISHED</li>\n<li>ACKESTABLISHED3</li>\n</ol>\n<p><img src=\"/2021/04/08/linux-netstat/5.png\" alt></p>\n<p>TCP </p>\n<ol>\n<li>FINFIN_WAIT1 </li>\n<li>FINACKCLOSE_WAIT </li>\n<li>ACKFIN_WAIT2 </li>\n<li>FINLAST_ACK </li>\n<li>FINACKTIME_WAIT </li>\n<li>2MSLCLOSEDACKCLOSED<br>CLOSING </li>\n</ol>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>LISTEN</td>\n<td>TCP </td>\n</tr>\n<tr>\n<td>SYN_SENT</td>\n<td></td>\n</tr>\n<tr>\n<td>SYN_RECEIVED</td>\n<td></td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td></td>\n</tr>\n<tr>\n<td>FIN_WAIT_1</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>FIN_WAIT_2</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>CLOSE_WAIT</td>\n<td></td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>LAST_ACK</td>\n<td>TCP</td>\n</tr>\n<tr>\n<td>TIME_WAIT</td>\n<td>TCP </td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://juejin.cn/post/6900439208641921038\" target=\"_blank\" rel=\"noopener\">https://juejin.cn/post/6900439208641921038</a></p>\n<p><strong>TCP4</strong></p>\n<p>TCPTCP  </p>\n<p><a href=\"https://blog.csdn.net/lengxiao1993/article/details/82771768\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/lengxiao1993/article/details/82771768</a></p>\n<p><strong></strong></p>\n<ol>\n<li>ASYN + sequence</li>\n<li>BA SYN +  sequence + ACKA</li>\n</ol>\n<p>ABBAABBACKAAB</p>\n<p><strong>TCP</strong></p>\n<p><img src=\"/2021/04/08/linux-netstat/6.png\" alt></p>\n<p></p>\n<ul>\n<li></li>\n<li>seqackTCP1</li>\n<li>6URGACK:PSH:RST:SYN:FIN</li>\n<li>16bit65535</li>\n</ul>\n<p><strong>TCP</strong></p>\n<p>TCPACK()</p>\n<p><strong>TIME_WAIT2MSL</strong></p>\n<ol>\n<li>TIME_WAITACKACKFINACKTIME_WAITFINRSTRST</li>\n<li>MSL</li>\n</ol>\n<p><strong>TIME_WAITCLOSE_WAIT</strong></p>\n<p>CLOSE_WAITFINACKCLOSE_WAITFINLAST_ACKACK</p>\n<p>TIME_WAITFIN_WAIT_2FINTIME_WAITMSL(Maximum Segment Lifetime:)</p>\n<p><strong>TCPUDP</strong></p>\n<ol>\n<li>udptcp</li>\n<li>udptcp</li>\n<li>udptcp</li>\n<li>udptcp</li>\n</ol>\n<p><strong>TCP</strong></p>\n<p>(socket)()pag1=100pag2=200300pag1,pag2MSSTCP</p>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p><a href=\"https://zhuanlan.zhihu.com/p/90057929\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/90057929</a></p>\n<p><strong>LinuxTCP</strong></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/138263151\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/138263151</a></p>\n<p><a href=\"https://blog.csdn.net/sqlquan/article/details/111561959\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/sqlquan/article/details/111561959</a></p>\n<p><strong>nagle</strong></p>\n<h2 id=\"netstat\"><a href=\"#netstat\" class=\"headerlink\" title=\"netstat\"></a>netstat</h2><p>netstatIPTCPUDPICMPnetstatTCPTCPUDP</p>\n<p>TCP</p>\n<pre><code class=\"shell\">[root@Master1 ~]# netstat -ant #tTCP\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address               Foreign Address             State      \ntcp        0      0 0.0.0.0:63501               0.0.0.0:*                   LISTEN    \ntcp        1      0 127.0.0.1:44176             127.0.0.1:60047             CLOSE_WAIT  \ntcp        0      0 10.8.198.151:60884          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:55672          10.8.2.27:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:60882          10.8.2.30:61235             TIME_WAIT   \ntcp        0      0 10.8.198.151:63501          10.8.133.245:59893          ESTABLISHED \ntcp        0      0 10.8.198.151:60976          10.8.2.30:61235             TIME_WAIT    \ntcp        0      0 ::ffff:127.0.0.1:9600       :::*                        LISTEN      \ntcp        0      0 :::63501                    :::*                        LISTEN          \ntcp        0      0 ::ffff:10.8.198.151:60061   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:60050   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        1      0 ::1:60047                   ::1:43724                   CLOSE_WAIT  \ntcp        0      0 ::ffff:10.8.198.151:45024   ::ffff:10.8.198.135:63751   ESTABLISHED \ntcp        0      0 ::ffff:10.8.198.151:43592   ::ffff:10.8.215.65:34710    TIME_WAIT  \n#Local Address - IP/\n#Foreign Address - IP/\n#State  - TCP11</code></pre>\n<p>netstatTCPMySQL</p>\n<pre><code>netstat -ant | grep 3306</code></pre><h2 id=\"tcpdump\"><a href=\"#tcpdump\" class=\"headerlink\" title=\"tcpdump\"></a>tcpdump</h2><p>tcp</p>\n<pre><code class=\"shell\">tcpdump -n port 3306 #3306TCP -n\n#  3\n11:38:15.679863 IP 172.18.0.5.38822 &gt; 172.18.0.3.3306: Flags [S], seq 4065722321, win 29200, options [mss 1460,sackOK,TS val 2997352 ecr 0,nop,wscale 7], length 0\n11:38:15.679923 IP 172.18.0.3.3306 &gt; 172.18.0.5.38822: Flags [S.], seq 780487619, ack 4065722322, win 28960, options [mss 1460,sackOK,TS val 2997352 ecr 2997352,nop,wscale 7], length 0\n11:38:15.679936 IP 172.18.0.5.38822 &gt; 172.18.0.3.3306: Flags [.], ack 1, win 229, options [nop,nop,TS val 2997352 ecr 2997352], length 0</code></pre>\n<pre><code class=\"shell\"># 3306TCP10.8.152.162 \ntcpdump -n port 3306 and host 10.8.152.162 \n# 210.27.48.1 210.27.48.2 210.27.48.3\ntcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\) \n# 210.27.48.1telnet\ntcpdump tcp port 23 and host 210.27.48.1</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://juejin.cn/post/6844903734300901390\" target=\"_blank\" rel=\"noopener\">https://juejin.cn/post/6844903734300901390</a></li>\n<li><a href=\"https://www.cnblogs.com/ggjucheng/archive/2012/01/14/2322659.html\" target=\"_blank\" rel=\"noopener\">Linux tcpdump</a></li>\n<li><a href=\"https://www.cnblogs.com/mq0036/p/11187138.html\" target=\"_blank\" rel=\"noopener\">wireshark</a></li>\n</ul>\n"},{"title":"Linux(topiostatvmstatnetstatfreedfiotop)","description":"LinuxJVM(jstatjpsjmapjstack)","_content":"## top\n### \n![top](linux-top/1.png)\n\n#### \n```shell\ntop - 14:46:47 up 909 days,  3:15,  1 user,  load average: 1.80, 1.50, 1.37\n```\n- 14:46:47 \n- up 909 days 909\n- 1 user \n- load average: 1.80, 1.50, 1.37 5;10;15\n<font color=red>load average5CPU5</font>\n<!--more-->\n#### \n```shell\nTasks: 652 total,   1 running, 651 sleeping,   0 stopped,   0 zombie\n```\n- total : \n- runnning : \n- sleeping : \n- stopped : \n- zombie : \n\nrunning cpusleepingIOsleepingrunningcpu.\n\n#### CPU\n```shell\nCpu(s):  3.8%us,  0.4%sy,  0.0%ni, 95.7%id,  0.1%wa,  0.0%hi,  0.0%si,  0.0%st\n```\n- us  CPU\n- sy  CPU\n- ni  CPU\n- id  CPU\n- wa  IOCPU\n- hi  Hardware IRQCPU\n- si  Software InterruptsCPU\n\n\n- \n- \n\n#### \n```shell\nMem:  231349636k total, 72512612k used, 158837024k free,   299360k buffers\nSwap:  8388600k total,        0k used,  8388600k free,  3648000k cached\n```\n- Mem\n - total \n - used \n - free \n - buffers \n- swap Mem,\n\n#### \n```\n   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n   10840 tomcat  20   0 68.0g  21g  14m S  0.3  9.8  71:32.92 jsvc     \n```\n- PIDID\n- USER\n- PR'rt'\n- NInice\n- VIRTkbVIRT=SWAP+RES\n- RESkbRES=CODE+DATA\n- SHRSHRkb\n- S:\n - D - \n - R  \n - S  \n - T  \n - Z  \n- %CPUCPU\n- %MEM\n- TIME+CPU\n- COMMAND/\n\n### top \n- top -p PID \n- top -c c\n- top -Hp PID  <font>jstackCPU</font>\n- top -u tomcat tomcat\n\n### top \ntop\n\n![1CPU](linux-top/2.png)\n\n#### \n- P CPU\n- M \n- c \n- T /\n- q \n- 1 CPU\n- u \n\n## vmstat - CPU,,IO\n### IO\n\nI/OInput/OutputIOIOIO\n\n- IO\n\n- IO\n\n### \n\nvmstatLinux/Unix,CPU,IO\ntop<font color=red>CPU,,IO</font>CPU\n\nvmstat 3 2  32\n\n```shell\n[ssh~]$ vmstat 3 2\nprocs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st\n 1  0      0 163756688 272168 3186404    0    0     0    11    0    0  4  0 96  0  0\t\n 1  0      0 163758912 272168 3186424    0    0     0    72 8156 4923 14  0 85  0  0\t\n```\n### \n\n|              |                                                          |\n| ---------------- | ------------------------------------------------------------ |\n| r                | CPU,CPUCPU     |\n| b                |                                                |\n| swpd ()  | 0  |\n| free ()  | ,163758M       |\n| buff ()  | buff                       |\n| cache () | cachecache                             |\n| si (swap)    | kb/s                     |\n| so (swap)    |                                    |\n| bi (IO)      |  |\n| bo (IO)      | bo0bibo0IO |\n| in               | CPU                              |\n| cs               | . |\n| us (CPU)     | cpu                                      |\n| sy (CPU)     | cpu                                          |\n| id (CPU)     | (IO)                                     |\n| wa (CPU)     | IO.                                                  |\n\n### \n\n- bi  bo (1024k)CPUIO\n- cs<font color=red>CPUCPU</font>\n- uscpu50%\n- syIO\n\n## iostat -  IO\n\n### \n\niostatCPU\n\n<font>iostatIO</font>\n\n```shell\n-c CPU\n-d \n-k K\n-m M\n-N (LVM) \n-n NFS\n-p \n-t CPU\n-x \n```\n\niostat -d -k -x 20 # 20\n\n![iostat](linux-top/3.png)\n\n### \n\n- %userCPU\n- %niceCPUNICE\n- %systemCPU\n- %iowaitCPU\n- %stealCPU\n- %idleCPU\n- Device \n- rrqm/s \n- wrqm/s \n- r/s \n- w/s \n- rkB/s K\n- wkB/s:K\n- avgrq-sz I/O\n- avgqu-sz I/O\n- await I/O ()<font color=red>I/O5ms 10ms</font>\n- r_await kernel\n- w_await kernel\n- svctm I/O ()\n- %util I/OIOCPU<font color=red>100%</font>\n\n%iowaitI/O\n%idleCPU\n%idleCPU\n%idle10CPUCPU\n## free -- \n\ntop  vmstat  \n\n```shell\n[watch@localhost ~]$ free -g  # -g GB\n             total       used       free     shared    buffers     cached\nMem:           220         64        156          0          0          3\n-/+ buffers/cache:         61        159\nSwap:            7          0          7\n```\n\n## df -- \n\n```shell\n[watch@localhost ~]$ df -h #-hGBMBKB\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda3       909G   57G  844G   7% /\ntmpfs           111G   16K  111G   1% /dev/shm\n/dev/sda1       485M  125M  335M  28% /boot\n/dev/sdb1       1.5T   16G  1.5T   2% /cache1\n```\n\n## iotop -- IO\n\nLinuxIOiostat,top, IO.\n\niotop topIO\niotop -p PID PID\n```shell\n[watch@localhost ~]$ iotop\nTotal DISK READ:       6.01 M/s | Total DISK WRITE:       3.85 K/s\n  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND                                                                                                          \n20074 be/4 hadoop      6.01 M/s    0.00 B/s  0.00 %  4.54 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 6371 be/4 hadoop      0.00 B/s    3.25 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 8497 be/4 hadoop      0.00 B/s    3.67 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % init\n    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]\n```\n## netstat - \n\n\n\n```shell\nnetstat -na |wc -l\nnetstat -anp | grep 3306 | wc -l # 3306\nnetstat -ant|awk '/^tcp/ {++S[$NF]} END {for(a in S) print (a,S[a])}'  #TCP\nnetstat -nat | awk '{print $6}' |sort|uniq -c|sort -rn  #TCP\nnetstat -nat | grep 'ESTABLISHED' |awk -F : '{print $1}' |sort|uniq -c|sort -rn # ESTABLISHEDIP\nnetstat -ant | awk '/tcp/ {print $6}'|sort |uniq -c |sort -nr #\nnetstat -ant | grep \"ESTABLISHED\"|awk '/tcp/ {print $5}'|cut -d \":\" -f1|sort |uniq -c |sort -nr |head -10 #ESTABLISHEDip\n```\n\nNetstat,TCP/IP\n\n```\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address()      Foreign Address()    State      \ntcp        0      0 127.0.0.1:2111              0.0.0.0:*                   LISTEN              \ntcp        0      0 127.0.0.1:20122             0.0.0.0:*                   LISTEN      \ntcp        0      0 0.0.0.0:2012                0.0.0.0:*                   LISTEN      \ntcp        0      0 127.0.0.1:50355             127.0.0.1:62016             TIME_WAIT      \ntcp        0      0 180.101.26.19:39669         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 180.101.26.19:39663         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 157.0.125.19:25119          218.98.49.27:65381          ESTABLISHED \n```\n\n\n\n## Arthas\n\nArthasJava\n\n  https://arthas.aliyun.com/zh-cn/\n\n### \n\n\n\n```java\nlong start = System.currentTimeMillis();\ndoSome();\nSystem.out.println(\"doSome :\" + (System.currentTimeMillis() - start) );\n```\n\nArthastraceController\n\n```shell\ntrace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\n# com.xzy.springboot.springbootproject.controller.CommonController \n# echo \n```\n\n\n\n```shell\n[arthas@16028]$ trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\nPress Q or Ctrl+C to abort.\nAffect(class count: 1 , method count: 1) cost in 303 ms, listenerId: 1\n`---ts=2020-10-09 09:24:41;thread_name=http-nio-8080-exec-1;id=92;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@4e93dcb9\n    `---[1.736869ms] com.xzy.springboot.springbootproject.controller.CommonController:echo()\n        `---[1.110086ms] org.slf4j.Logger:info() #14 \n```\n\n## JVM - jps\n\njavapid.\n jps -v  -v \n\n![jps](linux-top/4.png)\n\n## JVM - jstat\nGC\n : jstat -gc PID 1000 20 # -gcPID1000ms20\n\n![ jstat -gc](linux-top/5.png)\n\n-gc \n\n- S0C:survivor\n- S1C:survivor()\n- S0U:survivor()\n- S1U:survivor()\n- EC:Eden()\n- EU:Eden()\n- OC:Old()\n- OU:Old()\n- MC:metaspace()()\n- MU:metaspace()()\n- YGC:gc\n- YGCT:gc(s)\n- FGC:old(gc)gc\n- FGCT:old(gc)gc(s)\n- GCT:gc(s)\n\n-gcjstat\n\n- class:ClassLoad\n- compiler:JIT\n- gc:gc\n- gccapacity:\n- gcmetacapacity:metaspace\n- gcnew:\n- gcnewcapacity:\n- gcold:\n- gcoldcapacity:\n- gcutil:\n- gccause:-gcutil,\n\nGC <font color=red>FGCYGCFGCYGC</font>\n\n[jdkjstat(Java Virtual Machine Statistics Monitoring Tool)](https://www.cnblogs.com/duanxz/archive/2012/11/03/2752166.html)\n\n## JVM - jmap\njmapdump\n<font color=red>dumpJVM</font>\n```shell\njmap -heap PID # \njmap -histo:live PID | head -50 #class,,. live,. \njmap -dump:live,format=b,file=/tmp/xxxx.hprof PID #dumplive\n```\n\n\n\n![](linux-top/6.png)\n\n## JVM - jstack\n\njstackjavaCPU\n\n :\n\n```properties\njstack PID\njstack PID > /temp/PID.txt #\n```\n\n**Java6**\n\n- ****Newstart\n- ****\n  - ReadyStartCPU\n  - RUNNINGCPU\n- **** BLOCKED\n- **** WAITINGwait()join()\n- **** TIMED_WAITING\n- **** DIED\n\n**1:tomcatCPU**\n\nCPUCPUCPU\n\n1. topCPUtomcatPID=10086\n2. top -Hp 10086 CPU4519\n3. 451916printf %x 4519 = 11a7\n4. `jstack 1893 |grep -A 200 11a7` jstack\n\n**2:**\n\n```shell\njstack PID | grep 'deadlock' #PID\n```\n\n## \n\n### FGC\n- SQL\n- IOcloseFGCOOM.\n- FGC. \n- BUG Metaspace FGCOOM.\n- gc\n- JVMEdenS\n### IO\n- JVMCPU\n- \n\n## \n\n- https://www.cnblogs.com/Diyo/p/11411157.html\n- https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ","source":"_posts/linux-top.md","raw":"---\ntitle: Linux(topiostatvmstatnetstatfreedfiotop)\ntags:\n  - linux\ncategories:  linux\ndescription: LinuxJVM(jstatjpsjmapjstack)\n---\n## top\n### \n![top](linux-top/1.png)\n\n#### \n```shell\ntop - 14:46:47 up 909 days,  3:15,  1 user,  load average: 1.80, 1.50, 1.37\n```\n- 14:46:47 \n- up 909 days 909\n- 1 user \n- load average: 1.80, 1.50, 1.37 5;10;15\n<font color=red>load average5CPU5</font>\n<!--more-->\n#### \n```shell\nTasks: 652 total,   1 running, 651 sleeping,   0 stopped,   0 zombie\n```\n- total : \n- runnning : \n- sleeping : \n- stopped : \n- zombie : \n\nrunning cpusleepingIOsleepingrunningcpu.\n\n#### CPU\n```shell\nCpu(s):  3.8%us,  0.4%sy,  0.0%ni, 95.7%id,  0.1%wa,  0.0%hi,  0.0%si,  0.0%st\n```\n- us  CPU\n- sy  CPU\n- ni  CPU\n- id  CPU\n- wa  IOCPU\n- hi  Hardware IRQCPU\n- si  Software InterruptsCPU\n\n\n- \n- \n\n#### \n```shell\nMem:  231349636k total, 72512612k used, 158837024k free,   299360k buffers\nSwap:  8388600k total,        0k used,  8388600k free,  3648000k cached\n```\n- Mem\n - total \n - used \n - free \n - buffers \n- swap Mem,\n\n#### \n```\n   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n   10840 tomcat  20   0 68.0g  21g  14m S  0.3  9.8  71:32.92 jsvc     \n```\n- PIDID\n- USER\n- PR'rt'\n- NInice\n- VIRTkbVIRT=SWAP+RES\n- RESkbRES=CODE+DATA\n- SHRSHRkb\n- S:\n - D - \n - R  \n - S  \n - T  \n - Z  \n- %CPUCPU\n- %MEM\n- TIME+CPU\n- COMMAND/\n\n### top \n- top -p PID \n- top -c c\n- top -Hp PID  <font>jstackCPU</font>\n- top -u tomcat tomcat\n\n### top \ntop\n\n![1CPU](linux-top/2.png)\n\n#### \n- P CPU\n- M \n- c \n- T /\n- q \n- 1 CPU\n- u \n\n## vmstat - CPU,,IO\n### IO\n\nI/OInput/OutputIOIOIO\n\n- IO\n\n- IO\n\n### \n\nvmstatLinux/Unix,CPU,IO\ntop<font color=red>CPU,,IO</font>CPU\n\nvmstat 3 2  32\n\n```shell\n[ssh~]$ vmstat 3 2\nprocs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st\n 1  0      0 163756688 272168 3186404    0    0     0    11    0    0  4  0 96  0  0\t\n 1  0      0 163758912 272168 3186424    0    0     0    72 8156 4923 14  0 85  0  0\t\n```\n### \n\n|              |                                                          |\n| ---------------- | ------------------------------------------------------------ |\n| r                | CPU,CPUCPU     |\n| b                |                                                |\n| swpd ()  | 0  |\n| free ()  | ,163758M       |\n| buff ()  | buff                       |\n| cache () | cachecache                             |\n| si (swap)    | kb/s                     |\n| so (swap)    |                                    |\n| bi (IO)      |  |\n| bo (IO)      | bo0bibo0IO |\n| in               | CPU                              |\n| cs               | . |\n| us (CPU)     | cpu                                      |\n| sy (CPU)     | cpu                                          |\n| id (CPU)     | (IO)                                     |\n| wa (CPU)     | IO.                                                  |\n\n### \n\n- bi  bo (1024k)CPUIO\n- cs<font color=red>CPUCPU</font>\n- uscpu50%\n- syIO\n\n## iostat -  IO\n\n### \n\niostatCPU\n\n<font>iostatIO</font>\n\n```shell\n-c CPU\n-d \n-k K\n-m M\n-N (LVM) \n-n NFS\n-p \n-t CPU\n-x \n```\n\niostat -d -k -x 20 # 20\n\n![iostat](linux-top/3.png)\n\n### \n\n- %userCPU\n- %niceCPUNICE\n- %systemCPU\n- %iowaitCPU\n- %stealCPU\n- %idleCPU\n- Device \n- rrqm/s \n- wrqm/s \n- r/s \n- w/s \n- rkB/s K\n- wkB/s:K\n- avgrq-sz I/O\n- avgqu-sz I/O\n- await I/O ()<font color=red>I/O5ms 10ms</font>\n- r_await kernel\n- w_await kernel\n- svctm I/O ()\n- %util I/OIOCPU<font color=red>100%</font>\n\n%iowaitI/O\n%idleCPU\n%idleCPU\n%idle10CPUCPU\n## free -- \n\ntop  vmstat  \n\n```shell\n[watch@localhost ~]$ free -g  # -g GB\n             total       used       free     shared    buffers     cached\nMem:           220         64        156          0          0          3\n-/+ buffers/cache:         61        159\nSwap:            7          0          7\n```\n\n## df -- \n\n```shell\n[watch@localhost ~]$ df -h #-hGBMBKB\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda3       909G   57G  844G   7% /\ntmpfs           111G   16K  111G   1% /dev/shm\n/dev/sda1       485M  125M  335M  28% /boot\n/dev/sdb1       1.5T   16G  1.5T   2% /cache1\n```\n\n## iotop -- IO\n\nLinuxIOiostat,top, IO.\n\niotop topIO\niotop -p PID PID\n```shell\n[watch@localhost ~]$ iotop\nTotal DISK READ:       6.01 M/s | Total DISK WRITE:       3.85 K/s\n  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND                                                                                                          \n20074 be/4 hadoop      6.01 M/s    0.00 B/s  0.00 %  4.54 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 6371 be/4 hadoop      0.00 B/s    3.25 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 8497 be/4 hadoop      0.00 B/s    3.67 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % init\n    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]\n```\n## netstat - \n\n\n\n```shell\nnetstat -na |wc -l\nnetstat -anp | grep 3306 | wc -l # 3306\nnetstat -ant|awk '/^tcp/ {++S[$NF]} END {for(a in S) print (a,S[a])}'  #TCP\nnetstat -nat | awk '{print $6}' |sort|uniq -c|sort -rn  #TCP\nnetstat -nat | grep 'ESTABLISHED' |awk -F : '{print $1}' |sort|uniq -c|sort -rn # ESTABLISHEDIP\nnetstat -ant | awk '/tcp/ {print $6}'|sort |uniq -c |sort -nr #\nnetstat -ant | grep \"ESTABLISHED\"|awk '/tcp/ {print $5}'|cut -d \":\" -f1|sort |uniq -c |sort -nr |head -10 #ESTABLISHEDip\n```\n\nNetstat,TCP/IP\n\n```\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address()      Foreign Address()    State      \ntcp        0      0 127.0.0.1:2111              0.0.0.0:*                   LISTEN              \ntcp        0      0 127.0.0.1:20122             0.0.0.0:*                   LISTEN      \ntcp        0      0 0.0.0.0:2012                0.0.0.0:*                   LISTEN      \ntcp        0      0 127.0.0.1:50355             127.0.0.1:62016             TIME_WAIT      \ntcp        0      0 180.101.26.19:39669         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 180.101.26.19:39663         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 157.0.125.19:25119          218.98.49.27:65381          ESTABLISHED \n```\n\n\n\n## Arthas\n\nArthasJava\n\n  https://arthas.aliyun.com/zh-cn/\n\n### \n\n\n\n```java\nlong start = System.currentTimeMillis();\ndoSome();\nSystem.out.println(\"doSome :\" + (System.currentTimeMillis() - start) );\n```\n\nArthastraceController\n\n```shell\ntrace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\n# com.xzy.springboot.springbootproject.controller.CommonController \n# echo \n```\n\n\n\n```shell\n[arthas@16028]$ trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\nPress Q or Ctrl+C to abort.\nAffect(class count: 1 , method count: 1) cost in 303 ms, listenerId: 1\n`---ts=2020-10-09 09:24:41;thread_name=http-nio-8080-exec-1;id=92;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@4e93dcb9\n    `---[1.736869ms] com.xzy.springboot.springbootproject.controller.CommonController:echo()\n        `---[1.110086ms] org.slf4j.Logger:info() #14 \n```\n\n## JVM - jps\n\njavapid.\n jps -v  -v \n\n![jps](linux-top/4.png)\n\n## JVM - jstat\nGC\n : jstat -gc PID 1000 20 # -gcPID1000ms20\n\n![ jstat -gc](linux-top/5.png)\n\n-gc \n\n- S0C:survivor\n- S1C:survivor()\n- S0U:survivor()\n- S1U:survivor()\n- EC:Eden()\n- EU:Eden()\n- OC:Old()\n- OU:Old()\n- MC:metaspace()()\n- MU:metaspace()()\n- YGC:gc\n- YGCT:gc(s)\n- FGC:old(gc)gc\n- FGCT:old(gc)gc(s)\n- GCT:gc(s)\n\n-gcjstat\n\n- class:ClassLoad\n- compiler:JIT\n- gc:gc\n- gccapacity:\n- gcmetacapacity:metaspace\n- gcnew:\n- gcnewcapacity:\n- gcold:\n- gcoldcapacity:\n- gcutil:\n- gccause:-gcutil,\n\nGC <font color=red>FGCYGCFGCYGC</font>\n\n[jdkjstat(Java Virtual Machine Statistics Monitoring Tool)](https://www.cnblogs.com/duanxz/archive/2012/11/03/2752166.html)\n\n## JVM - jmap\njmapdump\n<font color=red>dumpJVM</font>\n```shell\njmap -heap PID # \njmap -histo:live PID | head -50 #class,,. live,. \njmap -dump:live,format=b,file=/tmp/xxxx.hprof PID #dumplive\n```\n\n\n\n![](linux-top/6.png)\n\n## JVM - jstack\n\njstackjavaCPU\n\n :\n\n```properties\njstack PID\njstack PID > /temp/PID.txt #\n```\n\n**Java6**\n\n- ****Newstart\n- ****\n  - ReadyStartCPU\n  - RUNNINGCPU\n- **** BLOCKED\n- **** WAITINGwait()join()\n- **** TIMED_WAITING\n- **** DIED\n\n**1:tomcatCPU**\n\nCPUCPUCPU\n\n1. topCPUtomcatPID=10086\n2. top -Hp 10086 CPU4519\n3. 451916printf %x 4519 = 11a7\n4. `jstack 1893 |grep -A 200 11a7` jstack\n\n**2:**\n\n```shell\njstack PID | grep 'deadlock' #PID\n```\n\n## \n\n### FGC\n- SQL\n- IOcloseFGCOOM.\n- FGC. \n- BUG Metaspace FGCOOM.\n- gc\n- JVMEdenS\n### IO\n- JVMCPU\n- \n\n## \n\n- https://www.cnblogs.com/Diyo/p/11411157.html\n- https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ","slug":"linux-top","published":1,"date":"2021-04-08T00:47:06.827Z","updated":"2021-04-30T00:58:39.974Z","_id":"ckn9yvhva001mqwv2hanmfrzj","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-top/1.png\" alt=\"top\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-shell\"><code class=\"language-shell\">top - 14:46:47 up 909 days,  3:15,  1 user,  load average: 1.80, 1.50, 1.37</code></pre>\n<ul>\n<li>14:46:47 </li>\n<li>up 909 days 909</li>\n<li>1 user </li>\n<li>load average: 1.80, 1.50, 1.37 5;10;15<br><font color=\"red\">load average5CPU5</font><a id=\"more\"></a>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-shell\"><code class=\"language-shell\">Tasks: 652 total,   1 running, 651 sleeping,   0 stopped,   0 zombie</code></pre>\n</li>\n<li>total : </li>\n<li>runnning : </li>\n<li>sleeping : </li>\n<li>stopped : </li>\n<li>zombie : </li>\n</ul>\n<p>running cpusleepingIOsleepingrunningcpu.</p>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h4><pre class=\" language-shell\"><code class=\"language-shell\">Cpu(s):  3.8%us,  0.4%sy,  0.0%ni, 95.7%id,  0.1%wa,  0.0%hi,  0.0%si,  0.0%st</code></pre>\n<ul>\n<li>us  CPU</li>\n<li>sy  CPU</li>\n<li>ni  CPU</li>\n<li>id  CPU</li>\n<li>wa  IOCPU</li>\n<li>hi  Hardware IRQCPU</li>\n<li>si  Software InterruptsCPU</li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-shell\"><code class=\"language-shell\">Mem:  231349636k total, 72512612k used, 158837024k free,   299360k buffers\nSwap:  8388600k total,        0k used,  8388600k free,  3648000k cached</code></pre>\n<ul>\n<li>Mem<ul>\n<li>total </li>\n<li>used </li>\n<li>free </li>\n<li>buffers </li>\n</ul>\n</li>\n<li>swap Mem,</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n   10840 tomcat  20   0 68.0g  21g  14m S  0.3  9.8  71:32.92 jsvc     </code></pre><ul>\n<li>PIDID</li>\n<li>USER</li>\n<li>PRrt</li>\n<li>NInice</li>\n<li>VIRTkbVIRT=SWAP+RES</li>\n<li>RESkbRES=CODE+DATA</li>\n<li>SHRSHRkb</li>\n<li>S:<ul>\n<li>D - </li>\n<li>R  </li>\n<li>S  </li>\n<li>T  </li>\n<li>Z  </li>\n</ul>\n</li>\n<li>%CPUCPU</li>\n<li>%MEM</li>\n<li>TIME+CPU</li>\n<li>COMMAND/</li>\n</ul>\n<h3 id=\"top-\"><a href=\"#top-\" class=\"headerlink\" title=\"top \"></a>top </h3><ul>\n<li>top -p PID </li>\n<li>top -c c</li>\n<li>top -Hp PID  <font>jstackCPU</font></li>\n<li>top -u tomcat tomcat</li>\n</ul>\n<h3 id=\"top-\"><a href=\"#top-\" class=\"headerlink\" title=\"top \"></a>top </h3><p>top</p>\n<p><img src=\"/2021/04/08/linux-top/2.png\" alt=\"1CPU\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>P CPU</li>\n<li>M </li>\n<li>c </li>\n<li>T /</li>\n<li>q </li>\n<li>1 CPU</li>\n<li>u </li>\n</ul>\n<h2 id=\"vmstat-CPU--IO\"><a href=\"#vmstat-CPU--IO\" class=\"headerlink\" title=\"vmstat - CPU,,IO\"></a>vmstat - CPU,,IO</h2><h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><p>I/OInput/OutputIOIOIO</p>\n<ul>\n<li><p>IO</p>\n</li>\n<li><p>IO</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vmstatLinux/Unix,CPU,IO<br>top<font color=\"red\">CPU,,IO</font>CPU</p>\n<p>vmstat 3 2  32</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[ssh~]$ vmstat 3 2\nprocs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st\n 1  0      0 163756688 272168 3186404    0    0     0    11    0    0  4  0 96  0  0    \n 1  0      0 163758912 272168 3186424    0    0     0    72 8156 4923 14  0 85  0  0    </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>r</td>\n<td>CPU,CPUCPU</td>\n</tr>\n<tr>\n<td>b</td>\n<td></td>\n</tr>\n<tr>\n<td>swpd ()</td>\n<td>0</td>\n</tr>\n<tr>\n<td>free ()</td>\n<td>,163758M</td>\n</tr>\n<tr>\n<td>buff ()</td>\n<td>buff</td>\n</tr>\n<tr>\n<td>cache ()</td>\n<td>cachecache</td>\n</tr>\n<tr>\n<td>si (swap)</td>\n<td>kb/s</td>\n</tr>\n<tr>\n<td>so (swap)</td>\n<td></td>\n</tr>\n<tr>\n<td>bi (IO)</td>\n<td></td>\n</tr>\n<tr>\n<td>bo (IO)</td>\n<td>bo0bibo0IO</td>\n</tr>\n<tr>\n<td>in</td>\n<td>CPU</td>\n</tr>\n<tr>\n<td>cs</td>\n<td>.</td>\n</tr>\n<tr>\n<td>us (CPU)</td>\n<td>cpu</td>\n</tr>\n<tr>\n<td>sy (CPU)</td>\n<td>cpu</td>\n</tr>\n<tr>\n<td>id (CPU)</td>\n<td>(IO)</td>\n</tr>\n<tr>\n<td>wa (CPU)</td>\n<td>IO.</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>bi  bo (1024k)CPUIO</li>\n<li>cs<font color=\"red\">CPUCPU</font></li>\n<li>uscpu50%</li>\n<li>syIO</li>\n</ul>\n<h2 id=\"iostat-IO\"><a href=\"#iostat-IO\" class=\"headerlink\" title=\"iostat -  IO\"></a>iostat -  IO</h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><p>iostatCPU</p>\n<p><font>iostatIO</font></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">-c CPU\n-d \n-k K\n-m M\n-N (LVM) \n-n NFS\n-p \n-t CPU\n-x </code></pre>\n<p>iostat -d -k -x 20 # 20</p>\n<p><img src=\"/2021/04/08/linux-top/3.png\" alt=\"iostat\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>%userCPU</li>\n<li>%niceCPUNICE</li>\n<li>%systemCPU</li>\n<li>%iowaitCPU</li>\n<li>%stealCPU</li>\n<li>%idleCPU</li>\n<li>Device </li>\n<li>rrqm/s </li>\n<li>wrqm/s </li>\n<li>r/s </li>\n<li>w/s </li>\n<li>rkB/s K</li>\n<li>wkB/s:K</li>\n<li>avgrq-sz I/O</li>\n<li>avgqu-sz I/O</li>\n<li>await I/O ()<font color=\"red\">I/O5ms 10ms</font></li>\n<li>r_await kernel</li>\n<li>w_await kernel</li>\n<li>svctm I/O ()</li>\n<li>%util I/OIOCPU<font color=\"red\">100%</font></li>\n</ul>\n<p>%iowaitI/O<br>%idleCPU<br>%idleCPU<br>%idle10CPUCPU</p>\n<h2 id=\"free--\"><a href=\"#free--\" class=\"headerlink\" title=\"free  \"></a>free  </h2><p>top  vmstat  </p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[watch@localhost ~]$ free -g  # -g GB\n             total       used       free     shared    buffers     cached\nMem:           220         64        156          0          0          3\n-/+ buffers/cache:         61        159\nSwap:            7          0          7</code></pre>\n<h2 id=\"df--\"><a href=\"#df--\" class=\"headerlink\" title=\"df  \"></a>df  </h2><pre class=\" language-shell\"><code class=\"language-shell\">[watch@localhost ~]$ df -h #-hGBMBKB\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda3       909G   57G  844G   7% /\ntmpfs           111G   16K  111G   1% /dev/shm\n/dev/sda1       485M  125M  335M  28% /boot\n/dev/sdb1       1.5T   16G  1.5T   2% /cache1</code></pre>\n<h2 id=\"iotop--IO\"><a href=\"#iotop--IO\" class=\"headerlink\" title=\"iotop  IO\"></a>iotop  IO</h2><p>LinuxIOiostat,top, IO.</p>\n<p>iotop topIO<br>iotop -p PID PID</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[watch@localhost ~]$ iotop\nTotal DISK READ:       6.01 M/s | Total DISK WRITE:       3.85 K/s\n  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND                                                                                                          \n20074 be/4 hadoop      6.01 M/s    0.00 B/s  0.00 %  4.54 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 6371 be/4 hadoop      0.00 B/s    3.25 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 8497 be/4 hadoop      0.00 B/s    3.67 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % init\n    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]</code></pre>\n<h2 id=\"netstat-\"><a href=\"#netstat-\" class=\"headerlink\" title=\"netstat - \"></a>netstat - </h2><p></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">netstat -na |wc -l\nnetstat -anp | grep 3306 | wc -l # 3306\nnetstat -ant|awk '/^tcp/ {++S[$NF]} END {for(a in S) print (a,S[a])}'  #TCP\nnetstat -nat | awk '{print $6}' |sort|uniq -c|sort -rn  #TCP\nnetstat -nat | grep 'ESTABLISHED' |awk -F : '{print $1}' |sort|uniq -c|sort -rn # ESTABLISHEDIP\nnetstat -ant | awk '/tcp/ {print $6}'|sort |uniq -c |sort -nr #\nnetstat -ant | grep \"ESTABLISHED\"|awk '/tcp/ {print $5}'|cut -d \":\" -f1|sort |uniq -c |sort -nr |head -10 #ESTABLISHEDip</code></pre>\n<p>Netstat,TCP/IP</p>\n<pre><code>Active Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address()      Foreign Address()    State      \ntcp        0      0 127.0.0.1:2111              0.0.0.0:*                   LISTEN              \ntcp        0      0 127.0.0.1:20122             0.0.0.0:*                   LISTEN      \ntcp        0      0 0.0.0.0:2012                0.0.0.0:*                   LISTEN      \ntcp        0      0 127.0.0.1:50355             127.0.0.1:62016             TIME_WAIT      \ntcp        0      0 180.101.26.19:39669         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 180.101.26.19:39663         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 157.0.125.19:25119          218.98.49.27:65381          ESTABLISHED </code></pre><h2 id=\"Arthas\"><a href=\"#Arthas\" class=\"headerlink\" title=\"Arthas\"></a>Arthas</h2><p>ArthasJava</p>\n<p>  <a href=\"https://arthas.aliyun.com/zh-cn/\" target=\"_blank\" rel=\"noopener\">https://arthas.aliyun.com/zh-cn/</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">doSome</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nSystem<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"doSome :\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>ArthastraceController</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\n# com.xzy.springboot.springbootproject.controller.CommonController \n# echo </code></pre>\n<p></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[arthas@16028]$ trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\nPress Q or Ctrl+C to abort.\nAffect(class count: 1 , method count: 1) cost in 303 ms, listenerId: 1\n`---ts=2020-10-09 09:24:41;thread_name=http-nio-8080-exec-1;id=92;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@4e93dcb9\n    `---[1.736869ms] com.xzy.springboot.springbootproject.controller.CommonController:echo()\n        `---[1.110086ms] org.slf4j.Logger:info() #14 </code></pre>\n<h2 id=\"JVM-jps\"><a href=\"#JVM-jps\" class=\"headerlink\" title=\"JVM - jps\"></a>JVM - jps</h2><p>javapid.<br> jps -v  -v </p>\n<p><img src=\"/2021/04/08/linux-top/4.png\" alt=\"jps\"></p>\n<h2 id=\"JVM-jstat\"><a href=\"#JVM-jstat\" class=\"headerlink\" title=\"JVM - jstat\"></a>JVM - jstat</h2><p>GC<br> : jstat -gc PID 1000 20 # -gcPID1000ms20</p>\n<p><img src=\"/2021/04/08/linux-top/5.png\" alt=\" jstat -gc\"></p>\n<p>-gc </p>\n<ul>\n<li>S0C:survivor</li>\n<li>S1C:survivor()</li>\n<li>S0U:survivor()</li>\n<li>S1U:survivor()</li>\n<li>EC:Eden()</li>\n<li>EU:Eden()</li>\n<li>OC:Old()</li>\n<li>OU:Old()</li>\n<li>MC:metaspace()()</li>\n<li>MU:metaspace()()</li>\n<li>YGC:gc</li>\n<li>YGCT:gc(s)</li>\n<li>FGC:old(gc)gc</li>\n<li>FGCT:old(gc)gc(s)</li>\n<li>GCT:gc(s)</li>\n</ul>\n<p>-gcjstat</p>\n<ul>\n<li>class:ClassLoad</li>\n<li>compiler:JIT</li>\n<li>gc:gc</li>\n<li>gccapacity:</li>\n<li>gcmetacapacity:metaspace</li>\n<li>gcnew:</li>\n<li>gcnewcapacity:</li>\n<li>gcold:</li>\n<li>gcoldcapacity:</li>\n<li>gcutil:</li>\n<li>gccause:-gcutil,</li>\n</ul>\n<p>GC <font color=\"red\">FGCYGCFGCYGC</font></p>\n<p><a href=\"https://www.cnblogs.com/duanxz/archive/2012/11/03/2752166.html\" target=\"_blank\" rel=\"noopener\">jdkjstat(Java Virtual Machine Statistics Monitoring Tool)</a></p>\n<h2 id=\"JVM-jmap\"><a href=\"#JVM-jmap\" class=\"headerlink\" title=\"JVM - jmap\"></a>JVM - jmap</h2><p>jmapdump<br><font color=\"red\">dumpJVM</font></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">jmap -heap PID # \njmap -histo:live PID | head -50 #class,,. live,. \njmap -dump:live,format=b,file=/tmp/xxxx.hprof PID #dumplive</code></pre>\n<p></p>\n<p><img src=\"/2021/04/08/linux-top/6.png\" alt=\"\"></p>\n<h2 id=\"JVM-jstack\"><a href=\"#JVM-jstack\" class=\"headerlink\" title=\"JVM - jstack\"></a>JVM - jstack</h2><p>jstackjavaCPU</p>\n<p> :</p>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token attr-name\">jstack</span> <span class=\"token attr-value\">PID</span>\n<span class=\"token attr-name\">jstack</span> <span class=\"token attr-value\">PID > /temp/PID.txt #</span></code></pre>\n<p><strong>Java6</strong></p>\n<ul>\n<li><strong></strong>Newstart</li>\n<li><strong></strong><ul>\n<li>ReadyStartCPU</li>\n<li>RUNNINGCPU</li>\n</ul>\n</li>\n<li><strong></strong> BLOCKED</li>\n<li><strong></strong> WAITINGwait()join()</li>\n<li><strong></strong> TIMED_WAITING</li>\n<li><strong></strong> DIED</li>\n</ul>\n<p><strong>1:tomcatCPU</strong></p>\n<p>CPUCPUCPU</p>\n<ol>\n<li>topCPUtomcatPID=10086</li>\n<li>top -Hp 10086 CPU4519</li>\n<li>451916printf %x 4519 = 11a7</li>\n<li><code>jstack 1893 |grep -A 200 11a7</code> jstack</li>\n</ol>\n<p><strong>2:</strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">jstack PID | grep 'deadlock' #PID</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h3><ul>\n<li>SQL</li>\n<li>IOcloseFGCOOM.</li>\n<li>FGC. </li>\n<li>BUG Metaspace FGCOOM.</li>\n<li>gc</li>\n<li>JVMEdenS<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3></li>\n<li>JVMCPU</li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.cnblogs.com/Diyo/p/11411157.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/Diyo/p/11411157.html</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2021/04/08/linux-top/1.png\" alt=\"top\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"shell\">top - 14:46:47 up 909 days,  3:15,  1 user,  load average: 1.80, 1.50, 1.37</code></pre>\n<ul>\n<li>14:46:47 </li>\n<li>up 909 days 909</li>\n<li>1 user </li>\n<li>load average: 1.80, 1.50, 1.37 5;10;15<br><font color=\"red\">load average5CPU5</font></li></ul>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"shell\">Tasks: 652 total,   1 running, 651 sleeping,   0 stopped,   0 zombie</code></pre>\n\n<li>total : </li>\n<li>runnning : </li>\n<li>sleeping : </li>\n<li>stopped : </li>\n<li>zombie : </li>\n\n<p>running cpusleepingIOsleepingrunningcpu.</p>\n<h4 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h4><pre><code class=\"shell\">Cpu(s):  3.8%us,  0.4%sy,  0.0%ni, 95.7%id,  0.1%wa,  0.0%hi,  0.0%si,  0.0%st</code></pre>\n<ul>\n<li>us  CPU</li>\n<li>sy  CPU</li>\n<li>ni  CPU</li>\n<li>id  CPU</li>\n<li>wa  IOCPU</li>\n<li>hi  Hardware IRQCPU</li>\n<li>si  Software InterruptsCPU</li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"shell\">Mem:  231349636k total, 72512612k used, 158837024k free,   299360k buffers\nSwap:  8388600k total,        0k used,  8388600k free,  3648000k cached</code></pre>\n<ul>\n<li>Mem<ul>\n<li>total </li>\n<li>used </li>\n<li>free </li>\n<li>buffers </li>\n</ul>\n</li>\n<li>swap Mem,</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code>   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n   10840 tomcat  20   0 68.0g  21g  14m S  0.3  9.8  71:32.92 jsvc     </code></pre><ul>\n<li>PIDID</li>\n<li>USER</li>\n<li>PRrt</li>\n<li>NInice</li>\n<li>VIRTkbVIRT=SWAP+RES</li>\n<li>RESkbRES=CODE+DATA</li>\n<li>SHRSHRkb</li>\n<li>S:<ul>\n<li>D - </li>\n<li>R  </li>\n<li>S  </li>\n<li>T  </li>\n<li>Z  </li>\n</ul>\n</li>\n<li>%CPUCPU</li>\n<li>%MEM</li>\n<li>TIME+CPU</li>\n<li>COMMAND/</li>\n</ul>\n<h3 id=\"top-\"><a href=\"#top-\" class=\"headerlink\" title=\"top \"></a>top </h3><ul>\n<li>top -p PID </li>\n<li>top -c c</li>\n<li>top -Hp PID  <font>jstackCPU</font></li>\n<li>top -u tomcat tomcat</li>\n</ul>\n<h3 id=\"top-\"><a href=\"#top-\" class=\"headerlink\" title=\"top \"></a>top </h3><p>top</p>\n<p><img src=\"/2021/04/08/linux-top/2.png\" alt=\"1CPU\"></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>P CPU</li>\n<li>M </li>\n<li>c </li>\n<li>T /</li>\n<li>q </li>\n<li>1 CPU</li>\n<li>u </li>\n</ul>\n<h2 id=\"vmstat-CPU--IO\"><a href=\"#vmstat-CPU--IO\" class=\"headerlink\" title=\"vmstat - CPU,,IO\"></a>vmstat - CPU,,IO</h2><h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3><p>I/OInput/OutputIOIOIO</p>\n<ul>\n<li><p>IO</p>\n</li>\n<li><p>IO</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>vmstatLinux/Unix,CPU,IO<br>top<font color=\"red\">CPU,,IO</font>CPU</p>\n<p>vmstat 3 2  32</p>\n<pre><code class=\"shell\">[ssh~]$ vmstat 3 2\nprocs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----\n r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st\n 1  0      0 163756688 272168 3186404    0    0     0    11    0    0  4  0 96  0  0    \n 1  0      0 163758912 272168 3186424    0    0     0    72 8156 4923 14  0 85  0  0    </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>r</td>\n<td>CPU,CPUCPU</td>\n</tr>\n<tr>\n<td>b</td>\n<td></td>\n</tr>\n<tr>\n<td>swpd ()</td>\n<td>0</td>\n</tr>\n<tr>\n<td>free ()</td>\n<td>,163758M</td>\n</tr>\n<tr>\n<td>buff ()</td>\n<td>buff</td>\n</tr>\n<tr>\n<td>cache ()</td>\n<td>cachecache</td>\n</tr>\n<tr>\n<td>si (swap)</td>\n<td>kb/s</td>\n</tr>\n<tr>\n<td>so (swap)</td>\n<td></td>\n</tr>\n<tr>\n<td>bi (IO)</td>\n<td></td>\n</tr>\n<tr>\n<td>bo (IO)</td>\n<td>bo0bibo0IO</td>\n</tr>\n<tr>\n<td>in</td>\n<td>CPU</td>\n</tr>\n<tr>\n<td>cs</td>\n<td>.</td>\n</tr>\n<tr>\n<td>us (CPU)</td>\n<td>cpu</td>\n</tr>\n<tr>\n<td>sy (CPU)</td>\n<td>cpu</td>\n</tr>\n<tr>\n<td>id (CPU)</td>\n<td>(IO)</td>\n</tr>\n<tr>\n<td>wa (CPU)</td>\n<td>IO.</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>bi  bo (1024k)CPUIO</li>\n<li>cs<font color=\"red\">CPUCPU</font></li>\n<li>uscpu50%</li>\n<li>syIO</li>\n</ul>\n<h2 id=\"iostat-IO\"><a href=\"#iostat-IO\" class=\"headerlink\" title=\"iostat -  IO\"></a>iostat -  IO</h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><p>iostatCPU</p>\n<p><font>iostatIO</font></p>\n<pre><code class=\"shell\">-c CPU\n-d \n-k K\n-m M\n-N (LVM) \n-n NFS\n-p \n-t CPU\n-x </code></pre>\n<p>iostat -d -k -x 20 # 20</p>\n<p><img src=\"/2021/04/08/linux-top/3.png\" alt=\"iostat\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>%userCPU</li>\n<li>%niceCPUNICE</li>\n<li>%systemCPU</li>\n<li>%iowaitCPU</li>\n<li>%stealCPU</li>\n<li>%idleCPU</li>\n<li>Device </li>\n<li>rrqm/s </li>\n<li>wrqm/s </li>\n<li>r/s </li>\n<li>w/s </li>\n<li>rkB/s K</li>\n<li>wkB/s:K</li>\n<li>avgrq-sz I/O</li>\n<li>avgqu-sz I/O</li>\n<li>await I/O ()<font color=\"red\">I/O5ms 10ms</font></li>\n<li>r_await kernel</li>\n<li>w_await kernel</li>\n<li>svctm I/O ()</li>\n<li>%util I/OIOCPU<font color=\"red\">100%</font></li>\n</ul>\n<p>%iowaitI/O<br>%idleCPU<br>%idleCPU<br>%idle10CPUCPU</p>\n<h2 id=\"free--\"><a href=\"#free--\" class=\"headerlink\" title=\"free  \"></a>free  </h2><p>top  vmstat  </p>\n<pre><code class=\"shell\">[watch@localhost ~]$ free -g  # -g GB\n             total       used       free     shared    buffers     cached\nMem:           220         64        156          0          0          3\n-/+ buffers/cache:         61        159\nSwap:            7          0          7</code></pre>\n<h2 id=\"df--\"><a href=\"#df--\" class=\"headerlink\" title=\"df  \"></a>df  </h2><pre><code class=\"shell\">[watch@localhost ~]$ df -h #-hGBMBKB\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/sda3       909G   57G  844G   7% /\ntmpfs           111G   16K  111G   1% /dev/shm\n/dev/sda1       485M  125M  335M  28% /boot\n/dev/sdb1       1.5T   16G  1.5T   2% /cache1</code></pre>\n<h2 id=\"iotop--IO\"><a href=\"#iotop--IO\" class=\"headerlink\" title=\"iotop  IO\"></a>iotop  IO</h2><p>LinuxIOiostat,top, IO.</p>\n<p>iotop topIO<br>iotop -p PID PID</p>\n<pre><code class=\"shell\">[watch@localhost ~]$ iotop\nTotal DISK READ:       6.01 M/s | Total DISK WRITE:       3.85 K/s\n  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND                                                                                                          \n20074 be/4 hadoop      6.01 M/s    0.00 B/s  0.00 %  4.54 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 6371 be/4 hadoop      0.00 B/s    3.25 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n 8497 be/4 hadoop      0.00 B/s    3.67 M/s  0.00 %  0.00 % java -Dproc_datanode -Xmx8192m -server  org.apache.hadoop.hdfs.server.datanode.DataNode\n    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % init\n    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]</code></pre>\n<h2 id=\"netstat-\"><a href=\"#netstat-\" class=\"headerlink\" title=\"netstat - \"></a>netstat - </h2><p></p>\n<pre><code class=\"shell\">netstat -na |wc -l\nnetstat -anp | grep 3306 | wc -l # 3306\nnetstat -ant|awk &#39;/^tcp/ {++S[$NF]} END {for(a in S) print (a,S[a])}&#39;  #TCP\nnetstat -nat | awk &#39;{print $6}&#39; |sort|uniq -c|sort -rn  #TCP\nnetstat -nat | grep &#39;ESTABLISHED&#39; |awk -F : &#39;{print $1}&#39; |sort|uniq -c|sort -rn # ESTABLISHEDIP\nnetstat -ant | awk &#39;/tcp/ {print $6}&#39;|sort |uniq -c |sort -nr #\nnetstat -ant | grep &quot;ESTABLISHED&quot;|awk &#39;/tcp/ {print $5}&#39;|cut -d &quot;:&quot; -f1|sort |uniq -c |sort -nr |head -10 #ESTABLISHEDip</code></pre>\n<p>Netstat,TCP/IP</p>\n<pre><code>Active Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address()      Foreign Address()    State      \ntcp        0      0 127.0.0.1:2111              0.0.0.0:*                   LISTEN              \ntcp        0      0 127.0.0.1:20122             0.0.0.0:*                   LISTEN      \ntcp        0      0 0.0.0.0:2012                0.0.0.0:*                   LISTEN      \ntcp        0      0 127.0.0.1:50355             127.0.0.1:62016             TIME_WAIT      \ntcp        0      0 180.101.26.19:39669         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 180.101.26.19:39663         180.101.26.26:63751         TIME_WAIT   \ntcp        0      0 157.0.125.19:25119          218.98.49.27:65381          ESTABLISHED </code></pre><h2 id=\"Arthas\"><a href=\"#Arthas\" class=\"headerlink\" title=\"Arthas\"></a>Arthas</h2><p>ArthasJava</p>\n<p>  <a href=\"https://arthas.aliyun.com/zh-cn/\" target=\"_blank\" rel=\"noopener\">https://arthas.aliyun.com/zh-cn/</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"java\">long start = System.currentTimeMillis();\ndoSome();\nSystem.out.println(&quot;doSome :&quot; + (System.currentTimeMillis() - start) );</code></pre>\n<p>ArthastraceController</p>\n<pre><code class=\"shell\">trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\n# com.xzy.springboot.springbootproject.controller.CommonController \n# echo </code></pre>\n<p></p>\n<pre><code class=\"shell\">[arthas@16028]$ trace --skipJDKMethod false com.xzy.springboot.springbootproject.controller.CommonController echo\nPress Q or Ctrl+C to abort.\nAffect(class count: 1 , method count: 1) cost in 303 ms, listenerId: 1\n`---ts=2020-10-09 09:24:41;thread_name=http-nio-8080-exec-1;id=92;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@4e93dcb9\n    `---[1.736869ms] com.xzy.springboot.springbootproject.controller.CommonController:echo()\n        `---[1.110086ms] org.slf4j.Logger:info() #14 </code></pre>\n<h2 id=\"JVM-jps\"><a href=\"#JVM-jps\" class=\"headerlink\" title=\"JVM - jps\"></a>JVM - jps</h2><p>javapid.<br> jps -v  -v </p>\n<p><img src=\"/2021/04/08/linux-top/4.png\" alt=\"jps\"></p>\n<h2 id=\"JVM-jstat\"><a href=\"#JVM-jstat\" class=\"headerlink\" title=\"JVM - jstat\"></a>JVM - jstat</h2><p>GC<br> : jstat -gc PID 1000 20 # -gcPID1000ms20</p>\n<p><img src=\"/2021/04/08/linux-top/5.png\" alt=\" jstat -gc\"></p>\n<p>-gc </p>\n<ul>\n<li>S0C:survivor</li>\n<li>S1C:survivor()</li>\n<li>S0U:survivor()</li>\n<li>S1U:survivor()</li>\n<li>EC:Eden()</li>\n<li>EU:Eden()</li>\n<li>OC:Old()</li>\n<li>OU:Old()</li>\n<li>MC:metaspace()()</li>\n<li>MU:metaspace()()</li>\n<li>YGC:gc</li>\n<li>YGCT:gc(s)</li>\n<li>FGC:old(gc)gc</li>\n<li>FGCT:old(gc)gc(s)</li>\n<li>GCT:gc(s)</li>\n</ul>\n<p>-gcjstat</p>\n<ul>\n<li>class:ClassLoad</li>\n<li>compiler:JIT</li>\n<li>gc:gc</li>\n<li>gccapacity:</li>\n<li>gcmetacapacity:metaspace</li>\n<li>gcnew:</li>\n<li>gcnewcapacity:</li>\n<li>gcold:</li>\n<li>gcoldcapacity:</li>\n<li>gcutil:</li>\n<li>gccause:-gcutil,</li>\n</ul>\n<p>GC <font color=\"red\">FGCYGCFGCYGC</font></p>\n<p><a href=\"https://www.cnblogs.com/duanxz/archive/2012/11/03/2752166.html\" target=\"_blank\" rel=\"noopener\">jdkjstat(Java Virtual Machine Statistics Monitoring Tool)</a></p>\n<h2 id=\"JVM-jmap\"><a href=\"#JVM-jmap\" class=\"headerlink\" title=\"JVM - jmap\"></a>JVM - jmap</h2><p>jmapdump<br><font color=\"red\">dumpJVM</font></p>\n<pre><code class=\"shell\">jmap -heap PID # \njmap -histo:live PID | head -50 #class,,. live,. \njmap -dump:live,format=b,file=/tmp/xxxx.hprof PID #dumplive</code></pre>\n<p></p>\n<p><img src=\"/2021/04/08/linux-top/6.png\" alt=\"\"></p>\n<h2 id=\"JVM-jstack\"><a href=\"#JVM-jstack\" class=\"headerlink\" title=\"JVM - jstack\"></a>JVM - jstack</h2><p>jstackjavaCPU</p>\n<p> :</p>\n<pre><code class=\"properties\">jstack PID\njstack PID &gt; /temp/PID.txt #</code></pre>\n<p><strong>Java6</strong></p>\n<ul>\n<li><strong></strong>Newstart</li>\n<li><strong></strong><ul>\n<li>ReadyStartCPU</li>\n<li>RUNNINGCPU</li>\n</ul>\n</li>\n<li><strong></strong> BLOCKED</li>\n<li><strong></strong> WAITINGwait()join()</li>\n<li><strong></strong> TIMED_WAITING</li>\n<li><strong></strong> DIED</li>\n</ul>\n<p><strong>1:tomcatCPU</strong></p>\n<p>CPUCPUCPU</p>\n<ol>\n<li>topCPUtomcatPID=10086</li>\n<li>top -Hp 10086 CPU4519</li>\n<li>451916printf %x 4519 = 11a7</li>\n<li><code>jstack 1893 |grep -A 200 11a7</code> jstack</li>\n</ol>\n<p><strong>2:</strong></p>\n<pre><code class=\"shell\">jstack PID | grep &#39;deadlock&#39; #PID</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"FGC\"><a href=\"#FGC\" class=\"headerlink\" title=\"FGC\"></a>FGC</h3><ul>\n<li>SQL</li>\n<li>IOcloseFGCOOM.</li>\n<li>FGC. </li>\n<li>BUG Metaspace FGCOOM.</li>\n<li>gc</li>\n<li>JVMEdenS<h3 id=\"IO\"><a href=\"#IO\" class=\"headerlink\" title=\"IO\"></a>IO</h3></li>\n<li>JVMCPU</li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.cnblogs.com/Diyo/p/11411157.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/Diyo/p/11411157.html</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/Vw63MUA0Zt80cU8_mvu7QQ</a></li>\n</ul>"},{"title":"Mysql-InnoDB()","description":"Mysql-InnoDB()","date":"2019-07-18T02:00:00.000Z","_content":"\n## \n1. \n2. \n3. \n4. \n5. \n<!--more-->\n## \nMysql-InnoDB()B+<font color=#FF0000 >InnoDB</font><font color=#FF0000 ></font>B+\n\n### \n\nB+B+16KBB+\n\n### \n\nB+B+\n\n<font color=#FF0000 ></font>\n\n## \n\n\n\n```sql\nCREATE TABLE person_info (\n\t id INT NOT NULL auto_increment,\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t PRIMARY KEY (id),\n\t KEY idx_name_birthday_phone_number (NAME, birthday, phone_number)\n);\n```\n\nSQLperson_info\n\n- idInnoDB<font color=#FF0000 ></font>B+<font color=#FF0000 ></font>\n- idx_name_birthday_phone_number,namebirthdayphone_numberB+namebirthdayphone_numbeid<font color=#FF0000 >country</font>\n\n![](mysql-index-use/1.png)\n\nB+name,birthday,phone_numberB+\n\n- <font color=red>name</font>\n- <font color=red>name</font><font color=red>birthday</font>\n- <font color=red>birthday</font><font color=red>phone_number</font>\n\n### ID\n\n```SQL\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tID = 10;\n```\n\nIDB+\n\n### \n\n```sql\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n```\n\nSQLidx_name_birthday_phone_number\n\n1. B+namenameAshburn\n2. namebirthdaynameAshburnbirthday'1990-09-27'\n3. namebirthdayphone_number\n\nid,name,birthday,phone_number*,idx_name_birthday_phone_numberB+countrycountry\n\n### \n\ncountryB+IDID\n\nidB+<font color=red></font>\n\n#### \n\n<font color=red></font>name = 'Ashburn' AND birthday = '1990-09-27' AND phone_number = '15123983239' 90%ID+\n\n\n\n- 1 id,name,birthday,phone_numbercountryselect * , \n- 2 \n\n### \n\n<font color=red></font>\n\n```sql\nSELECT\n\tID,NAME,birthday,phone_number\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n```\n\n<font color=red></font>\n\n### \n\nSQL\n\n```sql\n-- SQL 1\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n-- SQL 2\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tbirthday = '1990-09-27'\nAND NAME = 'Ashburn'\nAND phone_number = '15123983239';\n```\n\nidx_name_birthday_phone_numbername -> birthday - > phone_numberSQL2birthday->NAME->phone_numbernameSQL2\n\n<font color=red></font>\n\n### \n\nORDER BY\n\n\n\n```sql\nSELECT\n\tID,NAME,birthday,phone_number\nFROM\n\tperson_info\nORDER BY\n\tNAME,\n\tbirthday,\n\tphone_number;\n```\n\n\n\n#### \n1. ASC,DESCASCDESC\n2. WHERE\n3. \n4. \n\n## \n### \nWHEREORDER BYGROUP BY\n### \n\n\n<font color=red></font>\n\n### \n\n- \n- I/O \n\n### \n\n- B+\n- B+\n\n<font color=red></font>\n\n```sql\nCREATE TABLE person_info (\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number)\n);\n```\n\nname(10)B+10\n\n### \n\n\n\n```sql\nWHERE my_col * 2 < 4 -- \nWHERE my_col < 4 / 2 -- \n```\n\n### \n\n```sql\nCREATE TABLE person_info (\n\t id INT UNSIGNED NOT NULL AUTO_INCREMENT,\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t PRIMARY KEY (id),\n\t KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number),\n\t KEY idx_name (NAME(10))\n);\n```\n\nNAME\n\n## \n\n- B+\n- B+\n  - \n  - \n  - \n  - \n  - \n  - \n- \n  - \n  -  \n  - \n  -  \n  - \n  - AUTO_INCREMENT\n  - \n  - \n\n## \n\n- MYSQLMySQL  MySQL","source":"_posts/mysql-index-use.md","raw":"---\ntitle: Mysql-InnoDB()\ntags:\n  - mysql\ncategories:  mysql\ndescription : Mysql-InnoDB()\ndate: 2019-07-18 10:00:00\n---\n\n## \n1. \n2. \n3. \n4. \n5. \n<!--more-->\n## \nMysql-InnoDB()B+<font color=#FF0000 >InnoDB</font><font color=#FF0000 ></font>B+\n\n### \n\nB+B+16KBB+\n\n### \n\nB+B+\n\n<font color=#FF0000 ></font>\n\n## \n\n\n\n```sql\nCREATE TABLE person_info (\n\t id INT NOT NULL auto_increment,\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t PRIMARY KEY (id),\n\t KEY idx_name_birthday_phone_number (NAME, birthday, phone_number)\n);\n```\n\nSQLperson_info\n\n- idInnoDB<font color=#FF0000 ></font>B+<font color=#FF0000 ></font>\n- idx_name_birthday_phone_number,namebirthdayphone_numberB+namebirthdayphone_numbeid<font color=#FF0000 >country</font>\n\n![](mysql-index-use/1.png)\n\nB+name,birthday,phone_numberB+\n\n- <font color=red>name</font>\n- <font color=red>name</font><font color=red>birthday</font>\n- <font color=red>birthday</font><font color=red>phone_number</font>\n\n### ID\n\n```SQL\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tID = 10;\n```\n\nIDB+\n\n### \n\n```sql\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n```\n\nSQLidx_name_birthday_phone_number\n\n1. B+namenameAshburn\n2. namebirthdaynameAshburnbirthday'1990-09-27'\n3. namebirthdayphone_number\n\nid,name,birthday,phone_number*,idx_name_birthday_phone_numberB+countrycountry\n\n### \n\ncountryB+IDID\n\nidB+<font color=red></font>\n\n#### \n\n<font color=red></font>name = 'Ashburn' AND birthday = '1990-09-27' AND phone_number = '15123983239' 90%ID+\n\n\n\n- 1 id,name,birthday,phone_numbercountryselect * , \n- 2 \n\n### \n\n<font color=red></font>\n\n```sql\nSELECT\n\tID,NAME,birthday,phone_number\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n```\n\n<font color=red></font>\n\n### \n\nSQL\n\n```sql\n-- SQL 1\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tNAME = 'Ashburn'\nAND birthday = '1990-09-27'\nAND phone_number = '15123983239';\n-- SQL 2\nSELECT\n\t*\nFROM\n\tperson_info\nWHERE\n\tbirthday = '1990-09-27'\nAND NAME = 'Ashburn'\nAND phone_number = '15123983239';\n```\n\nidx_name_birthday_phone_numbername -> birthday - > phone_numberSQL2birthday->NAME->phone_numbernameSQL2\n\n<font color=red></font>\n\n### \n\nORDER BY\n\n\n\n```sql\nSELECT\n\tID,NAME,birthday,phone_number\nFROM\n\tperson_info\nORDER BY\n\tNAME,\n\tbirthday,\n\tphone_number;\n```\n\n\n\n#### \n1. ASC,DESCASCDESC\n2. WHERE\n3. \n4. \n\n## \n### \nWHEREORDER BYGROUP BY\n### \n\n\n<font color=red></font>\n\n### \n\n- \n- I/O \n\n### \n\n- B+\n- B+\n\n<font color=red></font>\n\n```sql\nCREATE TABLE person_info (\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number)\n);\n```\n\nname(10)B+10\n\n### \n\n\n\n```sql\nWHERE my_col * 2 < 4 -- \nWHERE my_col < 4 / 2 -- \n```\n\n### \n\n```sql\nCREATE TABLE person_info (\n\t id INT UNSIGNED NOT NULL AUTO_INCREMENT,\n\t NAME VARCHAR (100) NOT NULL,\n\t birthday DATE NOT NULL,\n\t phone_number CHAR (11) NOT NULL,\n\t country VARCHAR (100) NOT NULL,\n\t PRIMARY KEY (id),\n\t KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number),\n\t KEY idx_name (NAME(10))\n);\n```\n\nNAME\n\n## \n\n- B+\n- B+\n  - \n  - \n  - \n  - \n  - \n  - \n- \n  - \n  -  \n  - \n  -  \n  - \n  - AUTO_INCREMENT\n  - \n  - \n\n## \n\n- MYSQLMySQL  MySQL","slug":"mysql-index-use","published":1,"updated":"2021-04-08T00:47:06.867Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvb001oqwv22g36hv60","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li><a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>Mysql-InnoDB()B+<font color=\"#FF0000\">InnoDB</font><font color=\"#FF0000\"></font>B+</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>B+B+16KBB+</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>B+B+</p>\n<p><font color=\"#FF0000\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> person_info <span class=\"token punctuation\">(</span>\n        id <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n        NAME <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        birthday <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        phone_number CHAR <span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        country <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">KEY</span> idx_name_birthday_phone_number <span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span> birthday<span class=\"token punctuation\">,</span> phone_number<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>SQLperson_info</p>\n<ul>\n<li>idInnoDB<font color=\"#FF0000\"></font>B+<font color=\"#FF0000\"></font></li>\n<li>idx_name_birthday_phone_number,namebirthdayphone_numberB+namebirthdayphone_numbeid<font color=\"#FF0000\">country</font></li>\n</ul>\n<p><img src=\"/2019/07/18/mysql-index-use/1.png\" alt></p>\n<p>B+name,birthday,phone_numberB+</p>\n<ul>\n<li><font color=\"red\">name</font></li>\n<li><font color=\"red\">name</font><font color=\"red\">birthday</font></li>\n<li><font color=\"red\">birthday</font><font color=\"red\">phone_number</font></li>\n</ul>\n<h3 id=\"ID\"><a href=\"#ID\" class=\"headerlink\" title=\"ID\"></a>ID</h3><pre class=\" language-SQL\"><code class=\"language-SQL\">SELECT\n    *\nFROM\n    person_info\nWHERE\n    ID = 10;</code></pre>\n<p>IDB+</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n    <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span>\n    person_info\n<span class=\"token keyword\">WHERE</span>\n    NAME <span class=\"token operator\">=</span> <span class=\"token string\">'Ashburn'</span>\n<span class=\"token operator\">AND</span> birthday <span class=\"token operator\">=</span> <span class=\"token string\">'1990-09-27'</span>\n<span class=\"token operator\">AND</span> phone_number <span class=\"token operator\">=</span> <span class=\"token string\">'15123983239'</span><span class=\"token punctuation\">;</span></code></pre>\n<p>SQLidx_name_birthday_phone_number</p>\n<ol>\n<li>B+namenameAshburn</li>\n<li>namebirthdaynameAshburnbirthday1990-09-27</li>\n<li>namebirthdayphone_number</li>\n</ol>\n<p>id,name,birthday,phone_number*,idx_name_birthday_phone_numberB+countrycountry</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>countryB+IDID</p>\n<p>idB+<font color=\"red\"></font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><font color=\"red\"></font>name = Ashburn AND birthday = 1990-09-27 AND phone_number = 15123983239 90%ID+</p>\n<p></p>\n<ul>\n<li>1 id,name,birthday,phone_numbercountryselect * , </li>\n<li>2 </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><font color=\"red\"></font></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n    ID<span class=\"token punctuation\">,</span>NAME<span class=\"token punctuation\">,</span>birthday<span class=\"token punctuation\">,</span>phone_number\n<span class=\"token keyword\">FROM</span>\n    person_info\n<span class=\"token keyword\">WHERE</span>\n    NAME <span class=\"token operator\">=</span> <span class=\"token string\">'Ashburn'</span>\n<span class=\"token operator\">AND</span> birthday <span class=\"token operator\">=</span> <span class=\"token string\">'1990-09-27'</span>\n<span class=\"token operator\">AND</span> phone_number <span class=\"token operator\">=</span> <span class=\"token string\">'15123983239'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">-- SQL 1</span>\n<span class=\"token keyword\">SELECT</span>\n    <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span>\n    person_info\n<span class=\"token keyword\">WHERE</span>\n    NAME <span class=\"token operator\">=</span> <span class=\"token string\">'Ashburn'</span>\n<span class=\"token operator\">AND</span> birthday <span class=\"token operator\">=</span> <span class=\"token string\">'1990-09-27'</span>\n<span class=\"token operator\">AND</span> phone_number <span class=\"token operator\">=</span> <span class=\"token string\">'15123983239'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- SQL 2</span>\n<span class=\"token keyword\">SELECT</span>\n    <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span>\n    person_info\n<span class=\"token keyword\">WHERE</span>\n    birthday <span class=\"token operator\">=</span> <span class=\"token string\">'1990-09-27'</span>\n<span class=\"token operator\">AND</span> NAME <span class=\"token operator\">=</span> <span class=\"token string\">'Ashburn'</span>\n<span class=\"token operator\">AND</span> phone_number <span class=\"token operator\">=</span> <span class=\"token string\">'15123983239'</span><span class=\"token punctuation\">;</span></code></pre>\n<p>idx_name_birthday_phone_numbername -&gt; birthday - &gt; phone_numberSQL2birthday-&gt;NAME-&gt;phone_numbernameSQL2</p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ORDER BY</p>\n<p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n    ID<span class=\"token punctuation\">,</span>NAME<span class=\"token punctuation\">,</span>birthday<span class=\"token punctuation\">,</span>phone_number\n<span class=\"token keyword\">FROM</span>\n    person_info\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span>\n    NAME<span class=\"token punctuation\">,</span>\n    birthday<span class=\"token punctuation\">,</span>\n    phone_number<span class=\"token punctuation\">;</span></code></pre>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li>ASC,DESCASCDESC</li>\n<li>WHERE</li>\n<li></li>\n<li></li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>WHEREORDER BYGROUP BY</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><br><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li>I/O </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>B+</li>\n<li>B+</li>\n</ul>\n<p><font color=\"red\"></font></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> person_info <span class=\"token punctuation\">(</span>\n        NAME <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        birthday <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        phone_number CHAR <span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        country <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">KEY</span> idx_name_birthday_phone_number <span class=\"token punctuation\">(</span>NAME <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>birthday<span class=\"token punctuation\">,</span>phone_number<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>name(10)B+10</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">WHERE</span> my_col <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span> <span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token keyword\">WHERE</span> my_col <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token comment\" spellcheck=\"true\">-- </span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> person_info <span class=\"token punctuation\">(</span>\n        id <span class=\"token keyword\">INT</span> UNSIGNED <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n        NAME <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        birthday <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        phone_number CHAR <span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        country <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">KEY</span> idx_name_birthday_phone_number <span class=\"token punctuation\">(</span>NAME <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>birthday<span class=\"token punctuation\">,</span>phone_number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">KEY</span> idx_name <span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>NAME</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>B+</li>\n<li>B+<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li></li>\n<li> </li>\n<li></li>\n<li> </li>\n<li></li>\n<li>AUTO_INCREMENT</li>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQLMySQL  MySQL</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li></ol>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>Mysql-InnoDB()B+<font color=\"#FF0000\">InnoDB</font><font color=\"#FF0000\"></font>B+\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>B+B+16KBB+</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>B+B+</p>\n<p><font color=\"#FF0000\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<pre><code class=\"sql\">CREATE TABLE person_info (\n        id INT NOT NULL auto_increment,\n        NAME VARCHAR (100) NOT NULL,\n        birthday DATE NOT NULL,\n        phone_number CHAR (11) NOT NULL,\n        country VARCHAR (100) NOT NULL,\n        PRIMARY KEY (id),\n        KEY idx_name_birthday_phone_number (NAME, birthday, phone_number)\n);</code></pre>\n<p>SQLperson_info</p>\n<ul>\n<li>idInnoDB<font color=\"#FF0000\"></font>B+<font color=\"#FF0000\"></font></li>\n<li>idx_name_birthday_phone_number,namebirthdayphone_numberB+namebirthdayphone_numbeid<font color=\"#FF0000\">country</font></li>\n</ul>\n<p><img src=\"/2019/07/18/mysql-index-use/1.png\" alt></p>\n<p>B+name,birthday,phone_numberB+</p>\n<ul>\n<li><font color=\"red\">name</font></li>\n<li><font color=\"red\">name</font><font color=\"red\">birthday</font></li>\n<li><font color=\"red\">birthday</font><font color=\"red\">phone_number</font></li>\n</ul>\n<h3 id=\"ID\"><a href=\"#ID\" class=\"headerlink\" title=\"ID\"></a>ID</h3><pre><code class=\"SQL\">SELECT\n    *\nFROM\n    person_info\nWHERE\n    ID = 10;</code></pre>\n<p>IDB+</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"sql\">SELECT\n    *\nFROM\n    person_info\nWHERE\n    NAME = &#39;Ashburn&#39;\nAND birthday = &#39;1990-09-27&#39;\nAND phone_number = &#39;15123983239&#39;;</code></pre>\n<p>SQLidx_name_birthday_phone_number</p>\n<ol>\n<li>B+namenameAshburn</li>\n<li>namebirthdaynameAshburnbirthday1990-09-27</li>\n<li>namebirthdayphone_number</li>\n</ol>\n<p>id,name,birthday,phone_number*,idx_name_birthday_phone_numberB+countrycountry</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>countryB+IDID</p>\n<p>idB+<font color=\"red\"></font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><font color=\"red\"></font>name = Ashburn AND birthday = 1990-09-27 AND phone_number = 15123983239 90%ID+</p>\n<p></p>\n<ul>\n<li>1 id,name,birthday,phone_numbercountryselect * , </li>\n<li>2 </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><font color=\"red\"></font></p>\n<pre><code class=\"sql\">SELECT\n    ID,NAME,birthday,phone_number\nFROM\n    person_info\nWHERE\n    NAME = &#39;Ashburn&#39;\nAND birthday = &#39;1990-09-27&#39;\nAND phone_number = &#39;15123983239&#39;;</code></pre>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL</p>\n<pre><code class=\"sql\">-- SQL 1\nSELECT\n    *\nFROM\n    person_info\nWHERE\n    NAME = &#39;Ashburn&#39;\nAND birthday = &#39;1990-09-27&#39;\nAND phone_number = &#39;15123983239&#39;;\n-- SQL 2\nSELECT\n    *\nFROM\n    person_info\nWHERE\n    birthday = &#39;1990-09-27&#39;\nAND NAME = &#39;Ashburn&#39;\nAND phone_number = &#39;15123983239&#39;;</code></pre>\n<p>idx_name_birthday_phone_numbername -&gt; birthday - &gt; phone_numberSQL2birthday-&gt;NAME-&gt;phone_numbernameSQL2</p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ORDER BY</p>\n<p></p>\n<pre><code class=\"sql\">SELECT\n    ID,NAME,birthday,phone_number\nFROM\n    person_info\nORDER BY\n    NAME,\n    birthday,\n    phone_number;</code></pre>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li>ASC,DESCASCDESC</li>\n<li>WHERE</li>\n<li></li>\n<li></li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>WHEREORDER BYGROUP BY</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><br><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li>I/O </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>B+</li>\n<li>B+</li>\n</ul>\n<p><font color=\"red\"></font></p>\n<pre><code class=\"sql\">CREATE TABLE person_info (\n        NAME VARCHAR (100) NOT NULL,\n        birthday DATE NOT NULL,\n        phone_number CHAR (11) NOT NULL,\n        country VARCHAR (100) NOT NULL,\n        KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number)\n);</code></pre>\n<p>name(10)B+10</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"sql\">WHERE my_col * 2 &lt; 4 -- \nWHERE my_col &lt; 4 / 2 -- </code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"sql\">CREATE TABLE person_info (\n        id INT UNSIGNED NOT NULL AUTO_INCREMENT,\n        NAME VARCHAR (100) NOT NULL,\n        birthday DATE NOT NULL,\n        phone_number CHAR (11) NOT NULL,\n        country VARCHAR (100) NOT NULL,\n        PRIMARY KEY (id),\n        KEY idx_name_birthday_phone_number (NAME (10),birthday,phone_number),\n        KEY idx_name (NAME(10))\n);</code></pre>\n<p>NAME</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>B+</li>\n<li>B+<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li></li>\n<li> </li>\n<li></li>\n<li> </li>\n<li></li>\n<li>AUTO_INCREMENT</li>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQLMySQL  MySQL</li>\n</ul>"},{"title":"MySQLEXPLAIN","description":"MySQLEXPLAIN","date":"2020-07-31T09:34:03.000Z","_content":"## \n\n### EXPLAIN\n\n![1](mysql-explain/1.png)\n\n| **``**    | **``**                                             |\n| ------------- | ------------------------------------------------------ |\n| id            | SELECTid             |\n| select_type   | SELECT                             |\n| table         |                                                    |\n| partitions    |                                          |\n| type          |                                          |\n| possible_keys |                                          |\n| key           |                                        |\n| key_len       |                                    |\n| ref           |  |\n| rows          |                                  |\n| filtered      |                |\n| Extra         |                                          |\n\n...\n<!--more-->\n```sql\nCREATE TABLE `s1` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4;\n-- s2\n```\n### id\n\n`id`  `SELECT`  id  `SELECT` idid id  NULL \n\n<font color=red>IDID</font>\n\nid = 2  id = 1 \n\n![](mysql-explain/2.png)\n\n derived SELECT \n\n![derived2](mysql-explain/3.png)\n\nIDSQLs1\n\n![ID](mysql-explain/4.png)\n\n### select_type \nSQL\n\n|                |                                                          |\n| ------------------ | ------------------------------------------------------------ |\n| SIMPLE             |   `UNION`                      |\n| PRIMARY            | UNIONUNION ALLselect_typePRIMARY |\n| UNION              | UNIONUNION ALLselect_typeUNION |\n| UNION RESULT       | MySQLUNIONselect_typeUNION RESULT |\n| SUBQUERY           | semi-join,SELECTselect_typeSUBQUERY |\n| DEPENDENT SUBQUERY | semi-joinSELECT select_typeDEPENDENT SUBQUERY |\n| DEPENDENT UNION    | UNIONUNION ALLselect_typeDEPENDENT UNION |\n| DERIVED            | select_typeDERIVED |\n\n\n\n### table\n\ntable  EXPLAIN \n\n `FROM` table \\<derivenN> `id=N`  `id=N` \n\n### partitions \n\n\n\n### type \n\nMySQL\n : <font color=red> system > const > eq_ref > ref > range > index > ALL</font>\n\n<font size=4 color=red>range</font>\n\n#### system\nMyISAMMemorysystem\n\n#### const\nconst\n\n```sql\nEXPLAIN select * from s1 WHERE key2 = 256;\n```\n\n![](mysql-explain/5.png)\n\n#### eq_ref\n eq_ref\n\n```sql\nEXPLAIN SELECT * FROM s1 JOIN s2 on s1.id = s2.id;\n```\n![eq_ref](mysql-explain/6.png)\n\nMySQLs1s2s2eq_refs2 \n\n#### ref\nref\n```sql\nEXPLAIN select * from s1 WHERE key1 = 'rkm';\n```\n\n![ref](mysql-explain/7.png)\n\nkey1req\nreq_eq   eq_refref\n\n#### ref_or_null\n(<font color=red>,NULLNULL</font>)NULL\n\n```sql\nEXPLAIN select * from s1 WHERE key1 = 'rkm' or key1 is null;\n```\n\n![ref_or_null](mysql-explain/8.png)\n\n#### index_merge\nMySQL\n  where (join) AND  OR index merge index merge (intersect/union)Mysql-InnoDB()\n\n```sql\nEXPLAIN select * from s1 WHERE key2 = 2354 or key1 = 'rkm'\n```\n\n![index_merge](mysql-explain/9.png)\n\n#### range\n in, between ,> ,<, >= \n```sql\nEXPLAIN SELECT * FROM s1 where key2 BETWEEN 100 and 200;\n```\n\n![range](mysql-explain/10.png)\n\n#### index\nALLindex ALL \nALLB+\n```sql\nEXPLAIN\tSELECT\tkey_part2\tFROM\ts1\tWHERE\tkey_part3\t=\t'a';\n```\n\n![](mysql-explain/11.png)\n\nSQL,key_part2key_part3key_part2\n key_part3\n\n#### ALL\n\n### possible_keys \npossible_keys <font color=red></font>\n\npossible_keys NULL\n\n  <font color=red></font>\n\n### key \nkey \n\n### key_len \nkey_len \n\n### ref \nconsteq_refrefref_or_nullunique_subqueryindex_subquery ref\n```sql\nEXPLAIN\tSELECT\t*\tFROM\ts1\tWHERE\tkey1\t=\t'a';\n```\n\n![](mysql-explain/12.png)\n\nrefconstidx_key1key1\n### rows \nrows \nSQL\n\n### filtered \n\n filtered  filtered  rows * filtered/100 \n\n### Extra \nExtraMySQL\n\n####  Using index\n WHERE ()\n\n```sql\nEXPLAIN\tSELECT\tkey1\tFROM\ts1\tWHERE\tkey1\t=\t'a';\nEXPLAIN\tSELECT\t*\tFROM\ts1\tWHERE\tkey1\t=\t'a';\n```\n#### Using index condition\nSQL\n```sql\nEXPLAIN\tSELECT * FROM s1 WHERE key1 > 'z' AND key1 LIKE '%a';\n```\n\n![](mysql-explain/13.png)\n\nkey1 LIKE '%a' <font color=red></font>\n#### Using temporary\nMySQL \n#### Using filesort\n\n<font color=red></font>\n#### Using join buffer(Block Nested Loop)\n\n\n**joinjoinjoin?**\n\n**join()on**\n\n1001000\n\n```sql\nSELECT * from  left join  on .a = .b;\n```\n\na\n\n1. 100join_buffer\n2. a1\n3.  100 + 100 = 200\n\na:\n\n1. 100join_buffer\n2. 1000join_buffer\n3. join1000 100 * 1000 = 100000\n\n M+NM * Njoin_buffer****Block Nested LoopBlock Nested Loop joinjoin\n\n\n\n## SQL\n1. SQL\n\n2. \n\n3.  `SELECT *` \n\n4. IS NOT NULL NOT NULLIS NOT NULL\n\n5. \n\n   ```sql\n   like '%xx' -- \n   like '%xx%' -- \n   like 'xx%' -- \n   ```\n\n6. OROR\n\n   ```sql\n   SELECT * FROM TABLE KEY1 = 'XXX' OR KEY2 = 'XXX'; \n   --key1key2SQLORUNION KEY1\n   ```\n\n7. `!=<>NOT INNOT EXISTSNOT LIKE` \n\n8. ORDER BY\n\n9. INEXIST\n\n   1. SELECT * FROM a WHERE id IN (SELECT id from b) -  IN`ba`bA10000,B100,10000*100,,\n   2. SELECT a.* FROM A a  WHERE EXISTS(SELECT 1 FROM B b WHERE a.id=b.id) - EXISTE`ba`\n\n## \n\n```sql\n-- \nshow variables like 'optimizer_trace';\n-- \nset session optimizer_trace=\"enabled=on\",end_markers_in_json=on;\n-- \nset OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000;\n-- SQL\n-- \nSELECT trace FROM information_schema.OPTIMIZER_TRACE;\n```\n\n\n\n## \n\n![](mysql-explain/1.jpg)\n\n## \n\n- [MySQLEXPLAIN](https://mp.weixin.qq.com/s/rem7Ds_QSnyhlrtNPByQcg)\n\n","source":"_posts/mysql-explain.md","raw":"---\n\ntitle: MySQLEXPLAIN\ntags:\n  - mysql\ncategories:  mysql\ndescription : MySQLEXPLAIN\ndate: 2020-07-31 17:34:03\n---\n## \n\n### EXPLAIN\n\n![1](mysql-explain/1.png)\n\n| **``**    | **``**                                             |\n| ------------- | ------------------------------------------------------ |\n| id            | SELECTid             |\n| select_type   | SELECT                             |\n| table         |                                                    |\n| partitions    |                                          |\n| type          |                                          |\n| possible_keys |                                          |\n| key           |                                        |\n| key_len       |                                    |\n| ref           |  |\n| rows          |                                  |\n| filtered      |                |\n| Extra         |                                          |\n\n...\n<!--more-->\n```sql\nCREATE TABLE `s1` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4;\n-- s2\n```\n### id\n\n`id`  `SELECT`  id  `SELECT` idid id  NULL \n\n<font color=red>IDID</font>\n\nid = 2  id = 1 \n\n![](mysql-explain/2.png)\n\n derived SELECT \n\n![derived2](mysql-explain/3.png)\n\nIDSQLs1\n\n![ID](mysql-explain/4.png)\n\n### select_type \nSQL\n\n|                |                                                          |\n| ------------------ | ------------------------------------------------------------ |\n| SIMPLE             |   `UNION`                      |\n| PRIMARY            | UNIONUNION ALLselect_typePRIMARY |\n| UNION              | UNIONUNION ALLselect_typeUNION |\n| UNION RESULT       | MySQLUNIONselect_typeUNION RESULT |\n| SUBQUERY           | semi-join,SELECTselect_typeSUBQUERY |\n| DEPENDENT SUBQUERY | semi-joinSELECT select_typeDEPENDENT SUBQUERY |\n| DEPENDENT UNION    | UNIONUNION ALLselect_typeDEPENDENT UNION |\n| DERIVED            | select_typeDERIVED |\n\n\n\n### table\n\ntable  EXPLAIN \n\n `FROM` table \\<derivenN> `id=N`  `id=N` \n\n### partitions \n\n\n\n### type \n\nMySQL\n : <font color=red> system > const > eq_ref > ref > range > index > ALL</font>\n\n<font size=4 color=red>range</font>\n\n#### system\nMyISAMMemorysystem\n\n#### const\nconst\n\n```sql\nEXPLAIN select * from s1 WHERE key2 = 256;\n```\n\n![](mysql-explain/5.png)\n\n#### eq_ref\n eq_ref\n\n```sql\nEXPLAIN SELECT * FROM s1 JOIN s2 on s1.id = s2.id;\n```\n![eq_ref](mysql-explain/6.png)\n\nMySQLs1s2s2eq_refs2 \n\n#### ref\nref\n```sql\nEXPLAIN select * from s1 WHERE key1 = 'rkm';\n```\n\n![ref](mysql-explain/7.png)\n\nkey1req\nreq_eq   eq_refref\n\n#### ref_or_null\n(<font color=red>,NULLNULL</font>)NULL\n\n```sql\nEXPLAIN select * from s1 WHERE key1 = 'rkm' or key1 is null;\n```\n\n![ref_or_null](mysql-explain/8.png)\n\n#### index_merge\nMySQL\n  where (join) AND  OR index merge index merge (intersect/union)Mysql-InnoDB()\n\n```sql\nEXPLAIN select * from s1 WHERE key2 = 2354 or key1 = 'rkm'\n```\n\n![index_merge](mysql-explain/9.png)\n\n#### range\n in, between ,> ,<, >= \n```sql\nEXPLAIN SELECT * FROM s1 where key2 BETWEEN 100 and 200;\n```\n\n![range](mysql-explain/10.png)\n\n#### index\nALLindex ALL \nALLB+\n```sql\nEXPLAIN\tSELECT\tkey_part2\tFROM\ts1\tWHERE\tkey_part3\t=\t'a';\n```\n\n![](mysql-explain/11.png)\n\nSQL,key_part2key_part3key_part2\n key_part3\n\n#### ALL\n\n### possible_keys \npossible_keys <font color=red></font>\n\npossible_keys NULL\n\n  <font color=red></font>\n\n### key \nkey \n\n### key_len \nkey_len \n\n### ref \nconsteq_refrefref_or_nullunique_subqueryindex_subquery ref\n```sql\nEXPLAIN\tSELECT\t*\tFROM\ts1\tWHERE\tkey1\t=\t'a';\n```\n\n![](mysql-explain/12.png)\n\nrefconstidx_key1key1\n### rows \nrows \nSQL\n\n### filtered \n\n filtered  filtered  rows * filtered/100 \n\n### Extra \nExtraMySQL\n\n####  Using index\n WHERE ()\n\n```sql\nEXPLAIN\tSELECT\tkey1\tFROM\ts1\tWHERE\tkey1\t=\t'a';\nEXPLAIN\tSELECT\t*\tFROM\ts1\tWHERE\tkey1\t=\t'a';\n```\n#### Using index condition\nSQL\n```sql\nEXPLAIN\tSELECT * FROM s1 WHERE key1 > 'z' AND key1 LIKE '%a';\n```\n\n![](mysql-explain/13.png)\n\nkey1 LIKE '%a' <font color=red></font>\n#### Using temporary\nMySQL \n#### Using filesort\n\n<font color=red></font>\n#### Using join buffer(Block Nested Loop)\n\n\n**joinjoinjoin?**\n\n**join()on**\n\n1001000\n\n```sql\nSELECT * from  left join  on .a = .b;\n```\n\na\n\n1. 100join_buffer\n2. a1\n3.  100 + 100 = 200\n\na:\n\n1. 100join_buffer\n2. 1000join_buffer\n3. join1000 100 * 1000 = 100000\n\n M+NM * Njoin_buffer****Block Nested LoopBlock Nested Loop joinjoin\n\n\n\n## SQL\n1. SQL\n\n2. \n\n3.  `SELECT *` \n\n4. IS NOT NULL NOT NULLIS NOT NULL\n\n5. \n\n   ```sql\n   like '%xx' -- \n   like '%xx%' -- \n   like 'xx%' -- \n   ```\n\n6. OROR\n\n   ```sql\n   SELECT * FROM TABLE KEY1 = 'XXX' OR KEY2 = 'XXX'; \n   --key1key2SQLORUNION KEY1\n   ```\n\n7. `!=<>NOT INNOT EXISTSNOT LIKE` \n\n8. ORDER BY\n\n9. INEXIST\n\n   1. SELECT * FROM a WHERE id IN (SELECT id from b) -  IN`ba`bA10000,B100,10000*100,,\n   2. SELECT a.* FROM A a  WHERE EXISTS(SELECT 1 FROM B b WHERE a.id=b.id) - EXISTE`ba`\n\n## \n\n```sql\n-- \nshow variables like 'optimizer_trace';\n-- \nset session optimizer_trace=\"enabled=on\",end_markers_in_json=on;\n-- \nset OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000;\n-- SQL\n-- \nSELECT trace FROM information_schema.OPTIMIZER_TRACE;\n```\n\n\n\n## \n\n![](mysql-explain/1.jpg)\n\n## \n\n- [MySQLEXPLAIN](https://mp.weixin.qq.com/s/rem7Ds_QSnyhlrtNPByQcg)\n\n","slug":"mysql-explain","published":1,"updated":"2021-08-24T00:55:50.559Z","_id":"ckn9yvhvb001sqwv2fa488nq5","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"EXPLAIN\"><a href=\"#EXPLAIN\" class=\"headerlink\" title=\"EXPLAIN\"></a>EXPLAIN</h3><p><img src=\"/2020/07/31/mysql-explain/1.png\" alt=\"1\"></p>\n<table>\n<thead>\n<tr>\n<th><strong><code></code></strong></th>\n<th><strong><code></code></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>id</td>\n<td>SELECTid</td>\n</tr>\n<tr>\n<td>select_type</td>\n<td>SELECT</td>\n</tr>\n<tr>\n<td>table</td>\n<td></td>\n</tr>\n<tr>\n<td>partitions</td>\n<td></td>\n</tr>\n<tr>\n<td>type</td>\n<td></td>\n</tr>\n<tr>\n<td>possible_keys</td>\n<td></td>\n</tr>\n<tr>\n<td>key</td>\n<td></td>\n</tr>\n<tr>\n<td>key_len</td>\n<td></td>\n</tr>\n<tr>\n<td>ref</td>\n<td></td>\n</tr>\n<tr>\n<td>rows</td>\n<td></td>\n</tr>\n<tr>\n<td>filtered</td>\n<td></td>\n</tr>\n<tr>\n<td>Extra</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>\n<a id=\"more\"></a>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>s1<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key1<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key2<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key3<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part1<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part2<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part3<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>common_field<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key2<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key2<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key1<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key1<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key3<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key3<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key_part<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key_part1<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>key_part2<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>key_part3<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">10</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- s2</span></code></pre>\n<h3 id=\"id\"><a href=\"#id\" class=\"headerlink\" title=\"id\"></a>id</h3><p><code>id</code>  <code>SELECT</code>  id  <code>SELECT</code> idid id  NULL </p>\n<p><font color=\"red\">IDID</font></p>\n<p>id = 2  id = 1 </p>\n<p><img src=\"/2020/07/31/mysql-explain/2.png\" alt></p>\n<p> derived SELECT </p>\n<p><img src=\"/2020/07/31/mysql-explain/3.png\" alt=\"derived2\"></p>\n<p>IDSQLs1</p>\n<p><img src=\"/2020/07/31/mysql-explain/4.png\" alt=\"ID\"></p>\n<h3 id=\"select-type-\"><a href=\"#select-type-\" class=\"headerlink\" title=\"select_type \"></a>select_type </h3><p>SQL</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SIMPLE</td>\n<td>  <code>UNION</code></td>\n</tr>\n<tr>\n<td>PRIMARY</td>\n<td>UNIONUNION ALLselect_typePRIMARY</td>\n</tr>\n<tr>\n<td>UNION</td>\n<td>UNIONUNION ALLselect_typeUNION</td>\n</tr>\n<tr>\n<td>UNION RESULT</td>\n<td>MySQLUNIONselect_typeUNION RESULT</td>\n</tr>\n<tr>\n<td>SUBQUERY</td>\n<td>semi-join,SELECTselect_typeSUBQUERY</td>\n</tr>\n<tr>\n<td>DEPENDENT SUBQUERY</td>\n<td>semi-joinSELECT select_typeDEPENDENT SUBQUERY</td>\n</tr>\n<tr>\n<td>DEPENDENT UNION</td>\n<td>UNIONUNION ALLselect_typeDEPENDENT UNION</td>\n</tr>\n<tr>\n<td>DERIVED</td>\n<td>select_typeDERIVED</td>\n</tr>\n</tbody></table>\n<h3 id=\"table\"><a href=\"#table\" class=\"headerlink\" title=\"table\"></a>table</h3><p>table  EXPLAIN </p>\n<p> <code>FROM</code> table &lt;derivenN&gt; <code>id=N</code>  <code>id=N</code> </p>\n<h3 id=\"partitions-\"><a href=\"#partitions-\" class=\"headerlink\" title=\"partitions \"></a>partitions </h3><p></p>\n<h3 id=\"type-\"><a href=\"#type-\" class=\"headerlink\" title=\"type \"></a>type </h3><p>MySQL<br> : <font color=\"red\"> system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</font></p>\n<p><font size=\"4\" color=\"red\">range</font></p>\n<h4 id=\"system\"><a href=\"#system\" class=\"headerlink\" title=\"system\"></a>system</h4><p>MyISAMMemorysystem</p>\n<h4 id=\"const\"><a href=\"#const\" class=\"headerlink\" title=\"const\"></a>const</h4><p>const</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> s1 <span class=\"token keyword\">WHERE</span> key2 <span class=\"token operator\">=</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/5.png\" alt=\"\"></p>\n<h4 id=\"eq-ref\"><a href=\"#eq-ref\" class=\"headerlink\" title=\"eq_ref\"></a>eq_ref</h4><p> eq_ref</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> s1 <span class=\"token keyword\">JOIN</span> s2 <span class=\"token keyword\">on</span> s1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/6.png\" alt=\"eq_ref\"></p>\n<p>MySQLs1s2s2eq_refs2 </p>\n<h4 id=\"ref\"><a href=\"#ref\" class=\"headerlink\" title=\"ref\"></a>ref</h4><p>ref</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> s1 <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'rkm'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/7.png\" alt=\"ref\"></p>\n<p>key1req<br>req_eq   eq_refref</p>\n<h4 id=\"ref-or-null\"><a href=\"#ref-or-null\" class=\"headerlink\" title=\"ref_or_null\"></a>ref_or_null</h4><p>(<font color=\"red\">,NULLNULL</font>)NULL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> s1 <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'rkm'</span> <span class=\"token operator\">or</span> key1 <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/8.png\" alt=\"ref_or_null\"></p>\n<h4 id=\"index-merge\"><a href=\"#index-merge\" class=\"headerlink\" title=\"index_merge\"></a>index_merge</h4><p>MySQL<br>  where (join) AND  OR index merge index merge (intersect/union)Mysql-InnoDB()</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> s1 <span class=\"token keyword\">WHERE</span> key2 <span class=\"token operator\">=</span> <span class=\"token number\">2354</span> <span class=\"token operator\">or</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'rkm'</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/9.png\" alt=\"index_merge\"></p>\n<h4 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a>range</h4><p> in, between ,&gt; ,&lt;, &gt;= </p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> s1 <span class=\"token keyword\">where</span> key2 <span class=\"token operator\">BETWEEN</span> <span class=\"token number\">100</span> <span class=\"token operator\">and</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/10.png\" alt=\"range\"></p>\n<h4 id=\"index\"><a href=\"#index\" class=\"headerlink\" title=\"index\"></a>index</h4><p>ALLindex ALL <br>ALLB+</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span>    <span class=\"token keyword\">SELECT</span>    key_part2    <span class=\"token keyword\">FROM</span>    s1    <span class=\"token keyword\">WHERE</span>    key_part3    <span class=\"token operator\">=</span>    <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/11.png\" alt></p>\n<p>SQL,key_part2key_part3key_part2<br> key_part3</p>\n<h4 id=\"ALL\"><a href=\"#ALL\" class=\"headerlink\" title=\"ALL\"></a>ALL</h4><p></p>\n<h3 id=\"possible-keys-\"><a href=\"#possible-keys-\" class=\"headerlink\" title=\"possible_keys \"></a>possible_keys </h3><p>possible_keys <font color=\"red\"></font></p>\n<p>possible_keys NULL</p>\n<p>  <font color=\"red\"></font></p>\n<h3 id=\"key-\"><a href=\"#key-\" class=\"headerlink\" title=\"key \"></a>key </h3><p>key </p>\n<h3 id=\"key-len-\"><a href=\"#key-len-\" class=\"headerlink\" title=\"key_len \"></a>key_len </h3><p>key_len </p>\n<h3 id=\"ref-\"><a href=\"#ref-\" class=\"headerlink\" title=\"ref \"></a>ref </h3><p>consteq_refrefref_or_nullunique_subqueryindex_subquery ref</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span>    <span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    s1    <span class=\"token keyword\">WHERE</span>    key1    <span class=\"token operator\">=</span>    <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/12.png\" alt></p>\n<p>refconstidx_key1key1</p>\n<h3 id=\"rows-\"><a href=\"#rows-\" class=\"headerlink\" title=\"rows \"></a>rows </h3><p>rows <br>SQL</p>\n<h3 id=\"filtered-\"><a href=\"#filtered-\" class=\"headerlink\" title=\"filtered \"></a>filtered </h3><p><br> filtered  filtered  rows * filtered/100 </p>\n<h3 id=\"Extra-\"><a href=\"#Extra-\" class=\"headerlink\" title=\"Extra \"></a>Extra </h3><p>ExtraMySQL<br></p>\n<h4 id=\"Using-index\"><a href=\"#Using-index\" class=\"headerlink\" title=\"Using index\"></a>Using index</h4><p> WHERE ()<br></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span>    <span class=\"token keyword\">SELECT</span>    key1    <span class=\"token keyword\">FROM</span>    s1    <span class=\"token keyword\">WHERE</span>    key1    <span class=\"token operator\">=</span>    <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">EXPLAIN</span>    <span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    s1    <span class=\"token keyword\">WHERE</span>    key1    <span class=\"token operator\">=</span>    <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></code></pre>\n<h4 id=\"Using-index-condition\"><a href=\"#Using-index-condition\" class=\"headerlink\" title=\"Using index condition\"></a>Using index condition</h4><p>SQL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span>    <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> s1 <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">></span> <span class=\"token string\">'z'</span> <span class=\"token operator\">AND</span> key1 <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%a'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/13.png\" alt></p>\n<p>key1 LIKE %a <font color=\"red\"></font></p>\n<h4 id=\"Using-temporary\"><a href=\"#Using-temporary\" class=\"headerlink\" title=\"Using temporary\"></a>Using temporary</h4><p>MySQL </p>\n<h4 id=\"Using-filesort\"><a href=\"#Using-filesort\" class=\"headerlink\" title=\"Using filesort\"></a>Using filesort</h4><p><br><font color=\"red\"></font></p>\n<h4 id=\"Using-join-buffer-Block-Nested-Loop\"><a href=\"#Using-join-buffer-Block-Nested-Loop\" class=\"headerlink\" title=\"Using join buffer(Block Nested Loop)\"></a>Using join buffer(Block Nested Loop)</h4><p></p>\n<p><strong>joinjoinjoin?</strong></p>\n<p><strong>join()on</strong></p>\n<p>1001000</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span>  <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>  <span class=\"token keyword\">on</span> <span class=\"token punctuation\">.</span><span class=\"token number\">a</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token number\">b</span><span class=\"token punctuation\">;</span></code></pre>\n<p>a</p>\n<ol>\n<li>100join_buffer</li>\n<li>a1</li>\n<li> 100 + 100 = 200</li>\n</ol>\n<p>a:</p>\n<ol>\n<li>100join_buffer</li>\n<li>1000join_buffer</li>\n<li>join1000 100 * 1000 = 100000</li>\n</ol>\n<p> M+NM * Njoin_buffer<strong></strong>Block Nested LoopBlock Nested Loop joinjoin</p>\n<h2 id=\"SQL\"><a href=\"#SQL\" class=\"headerlink\" title=\"SQL\"></a>SQL</h2><ol>\n<li><p>SQL</p>\n</li>\n<li><p></p>\n</li>\n<li><p> <code>SELECT *</code> </p>\n</li>\n<li><p>IS NOT NULL NOT NULLIS NOT NULL</p>\n</li>\n<li><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token operator\">like</span> <span class=\"token string\">'%xx'</span> <span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token operator\">like</span> <span class=\"token string\">'%xx%'</span> <span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token operator\">like</span> <span class=\"token string\">'xx%'</span> <span class=\"token comment\" spellcheck=\"true\">-- </span></code></pre>\n</li>\n<li><p>OROR</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">TABLE</span> KEY1 <span class=\"token operator\">=</span> <span class=\"token string\">'XXX'</span> <span class=\"token operator\">OR</span> KEY2 <span class=\"token operator\">=</span> <span class=\"token string\">'XXX'</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\" spellcheck=\"true\">--key1key2SQLORUNION KEY1</span></code></pre>\n</li>\n<li><p><code>!=&lt;&gt;NOT INNOT EXISTSNOT LIKE</code> </p>\n</li>\n<li><p>ORDER BY</p>\n</li>\n<li><p>INEXIST</p>\n<ol>\n<li>SELECT * FROM a WHERE id IN (SELECT id from b) -  IN<code>ba</code>bA10000,B100,10000*100,,</li>\n<li>SELECT a.* FROM A a  WHERE EXISTS(SELECT 1 FROM B b WHERE a.id=b.id) - EXISTE<code>ba</code></li>\n</ol>\n</li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'optimizer_trace'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">session</span> optimizer_trace<span class=\"token operator\">=</span><span class=\"token string\">\"enabled=on\"</span><span class=\"token punctuation\">,</span>end_markers_in_json<span class=\"token operator\">=</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token keyword\">set</span> OPTIMIZER_TRACE_MAX_MEM_SIZE<span class=\"token operator\">=</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">-- SQL</span>\n<span class=\"token comment\" spellcheck=\"true\">-- </span>\n<span class=\"token keyword\">SELECT</span> trace <span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>OPTIMIZER_TRACE<span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/2020/07/31/mysql-explain/1.jpg\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/rem7Ds_QSnyhlrtNPByQcg\" target=\"_blank\" rel=\"noopener\">MySQLEXPLAIN</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"EXPLAIN\"><a href=\"#EXPLAIN\" class=\"headerlink\" title=\"EXPLAIN\"></a>EXPLAIN</h3><p><img src=\"/2020/07/31/mysql-explain/1.png\" alt=\"1\"></p>\n<table>\n<thead>\n<tr>\n<th><strong><code></code></strong></th>\n<th><strong><code></code></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>id</td>\n<td>SELECTid</td>\n</tr>\n<tr>\n<td>select_type</td>\n<td>SELECT</td>\n</tr>\n<tr>\n<td>table</td>\n<td></td>\n</tr>\n<tr>\n<td>partitions</td>\n<td></td>\n</tr>\n<tr>\n<td>type</td>\n<td></td>\n</tr>\n<tr>\n<td>possible_keys</td>\n<td></td>\n</tr>\n<tr>\n<td>key</td>\n<td></td>\n</tr>\n<tr>\n<td>key_len</td>\n<td></td>\n</tr>\n<tr>\n<td>ref</td>\n<td></td>\n</tr>\n<tr>\n<td>rows</td>\n<td></td>\n</tr>\n<tr>\n<td>filtered</td>\n<td></td>\n</tr>\n<tr>\n<td>Extra</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>","more":"<pre><code class=\"sql\">CREATE TABLE `s1` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4;\n-- s2</code></pre>\n<h3 id=\"id\"><a href=\"#id\" class=\"headerlink\" title=\"id\"></a>id</h3><p><code>id</code>  <code>SELECT</code>  id  <code>SELECT</code> idid id  NULL </p>\n<p><font color=\"red\">IDID</font></p>\n<p>id = 2  id = 1 </p>\n<p><img src=\"/2020/07/31/mysql-explain/2.png\" alt></p>\n<p> derived SELECT </p>\n<p><img src=\"/2020/07/31/mysql-explain/3.png\" alt=\"derived2\"></p>\n<p>IDSQLs1</p>\n<p><img src=\"/2020/07/31/mysql-explain/4.png\" alt=\"ID\"></p>\n<h3 id=\"select-type-\"><a href=\"#select-type-\" class=\"headerlink\" title=\"select_type \"></a>select_type </h3><p>SQL</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SIMPLE</td>\n<td>  <code>UNION</code></td>\n</tr>\n<tr>\n<td>PRIMARY</td>\n<td>UNIONUNION ALLselect_typePRIMARY</td>\n</tr>\n<tr>\n<td>UNION</td>\n<td>UNIONUNION ALLselect_typeUNION</td>\n</tr>\n<tr>\n<td>UNION RESULT</td>\n<td>MySQLUNIONselect_typeUNION RESULT</td>\n</tr>\n<tr>\n<td>SUBQUERY</td>\n<td>semi-join,SELECTselect_typeSUBQUERY</td>\n</tr>\n<tr>\n<td>DEPENDENT SUBQUERY</td>\n<td>semi-joinSELECT select_typeDEPENDENT SUBQUERY</td>\n</tr>\n<tr>\n<td>DEPENDENT UNION</td>\n<td>UNIONUNION ALLselect_typeDEPENDENT UNION</td>\n</tr>\n<tr>\n<td>DERIVED</td>\n<td>select_typeDERIVED</td>\n</tr>\n</tbody></table>\n<h3 id=\"table\"><a href=\"#table\" class=\"headerlink\" title=\"table\"></a>table</h3><p>table  EXPLAIN </p>\n<p> <code>FROM</code> table &lt;derivenN&gt; <code>id=N</code>  <code>id=N</code> </p>\n<h3 id=\"partitions-\"><a href=\"#partitions-\" class=\"headerlink\" title=\"partitions \"></a>partitions </h3><p></p>\n<h3 id=\"type-\"><a href=\"#type-\" class=\"headerlink\" title=\"type \"></a>type </h3><p>MySQL<br> : <font color=\"red\"> system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</font></p>\n<p><font size=\"4\" color=\"red\">range</font></p>\n<h4 id=\"system\"><a href=\"#system\" class=\"headerlink\" title=\"system\"></a>system</h4><p>MyISAMMemorysystem</p>\n<h4 id=\"const\"><a href=\"#const\" class=\"headerlink\" title=\"const\"></a>const</h4><p>const</p>\n<pre><code class=\"sql\">EXPLAIN select * from s1 WHERE key2 = 256;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/5.png\" alt=\"\"></p>\n<h4 id=\"eq-ref\"><a href=\"#eq-ref\" class=\"headerlink\" title=\"eq_ref\"></a>eq_ref</h4><p> eq_ref</p>\n<pre><code class=\"sql\">EXPLAIN SELECT * FROM s1 JOIN s2 on s1.id = s2.id;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/6.png\" alt=\"eq_ref\"></p>\n<p>MySQLs1s2s2eq_refs2 </p>\n<h4 id=\"ref\"><a href=\"#ref\" class=\"headerlink\" title=\"ref\"></a>ref</h4><p>ref</p>\n<pre><code class=\"sql\">EXPLAIN select * from s1 WHERE key1 = &#39;rkm&#39;;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/7.png\" alt=\"ref\"></p>\n<p>key1req<br>req_eq   eq_refref</p>\n<h4 id=\"ref-or-null\"><a href=\"#ref-or-null\" class=\"headerlink\" title=\"ref_or_null\"></a>ref_or_null</h4><p>(<font color=\"red\">,NULLNULL</font>)NULL</p>\n<pre><code class=\"sql\">EXPLAIN select * from s1 WHERE key1 = &#39;rkm&#39; or key1 is null;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/8.png\" alt=\"ref_or_null\"></p>\n<h4 id=\"index-merge\"><a href=\"#index-merge\" class=\"headerlink\" title=\"index_merge\"></a>index_merge</h4><p>MySQL<br>  where (join) AND  OR index merge index merge (intersect/union)Mysql-InnoDB()</p>\n<pre><code class=\"sql\">EXPLAIN select * from s1 WHERE key2 = 2354 or key1 = &#39;rkm&#39;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/9.png\" alt=\"index_merge\"></p>\n<h4 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a>range</h4><p> in, between ,&gt; ,&lt;, &gt;= </p>\n<pre><code class=\"sql\">EXPLAIN SELECT * FROM s1 where key2 BETWEEN 100 and 200;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/10.png\" alt=\"range\"></p>\n<h4 id=\"index\"><a href=\"#index\" class=\"headerlink\" title=\"index\"></a>index</h4><p>ALLindex ALL <br>ALLB+</p>\n<pre><code class=\"sql\">EXPLAIN    SELECT    key_part2    FROM    s1    WHERE    key_part3    =    &#39;a&#39;;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/11.png\" alt></p>\n<p>SQL,key_part2key_part3key_part2<br> key_part3</p>\n<h4 id=\"ALL\"><a href=\"#ALL\" class=\"headerlink\" title=\"ALL\"></a>ALL</h4><p></p>\n<h3 id=\"possible-keys-\"><a href=\"#possible-keys-\" class=\"headerlink\" title=\"possible_keys \"></a>possible_keys </h3><p>possible_keys <font color=\"red\"></font></p>\n<p>possible_keys NULL</p>\n<p>  <font color=\"red\"></font></p>\n<h3 id=\"key-\"><a href=\"#key-\" class=\"headerlink\" title=\"key \"></a>key </h3><p>key </p>\n<h3 id=\"key-len-\"><a href=\"#key-len-\" class=\"headerlink\" title=\"key_len \"></a>key_len </h3><p>key_len </p>\n<h3 id=\"ref-\"><a href=\"#ref-\" class=\"headerlink\" title=\"ref \"></a>ref </h3><p>consteq_refrefref_or_nullunique_subqueryindex_subquery ref</p>\n<pre><code class=\"sql\">EXPLAIN    SELECT    *    FROM    s1    WHERE    key1    =    &#39;a&#39;;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/12.png\" alt></p>\n<p>refconstidx_key1key1</p>\n<h3 id=\"rows-\"><a href=\"#rows-\" class=\"headerlink\" title=\"rows \"></a>rows </h3><p>rows <br>SQL</p>\n<h3 id=\"filtered-\"><a href=\"#filtered-\" class=\"headerlink\" title=\"filtered \"></a>filtered </h3><p><br> filtered  filtered  rows * filtered/100 </p>\n<h3 id=\"Extra-\"><a href=\"#Extra-\" class=\"headerlink\" title=\"Extra \"></a>Extra </h3><p>ExtraMySQL<br></p>\n<h4 id=\"Using-index\"><a href=\"#Using-index\" class=\"headerlink\" title=\"Using index\"></a>Using index</h4><p> WHERE ()<br></p>\n<pre><code class=\"sql\">EXPLAIN    SELECT    key1    FROM    s1    WHERE    key1    =    &#39;a&#39;;\nEXPLAIN    SELECT    *    FROM    s1    WHERE    key1    =    &#39;a&#39;;</code></pre>\n<h4 id=\"Using-index-condition\"><a href=\"#Using-index-condition\" class=\"headerlink\" title=\"Using index condition\"></a>Using index condition</h4><p>SQL</p>\n<pre><code class=\"sql\">EXPLAIN    SELECT * FROM s1 WHERE key1 &gt; &#39;z&#39; AND key1 LIKE &#39;%a&#39;;</code></pre>\n<p><img src=\"/2020/07/31/mysql-explain/13.png\" alt></p>\n<p>key1 LIKE %a <font color=\"red\"></font></p>\n<h4 id=\"Using-temporary\"><a href=\"#Using-temporary\" class=\"headerlink\" title=\"Using temporary\"></a>Using temporary</h4><p>MySQL </p>\n<h4 id=\"Using-filesort\"><a href=\"#Using-filesort\" class=\"headerlink\" title=\"Using filesort\"></a>Using filesort</h4><p><br><font color=\"red\"></font></p>\n<h4 id=\"Using-join-buffer-Block-Nested-Loop\"><a href=\"#Using-join-buffer-Block-Nested-Loop\" class=\"headerlink\" title=\"Using join buffer(Block Nested Loop)\"></a>Using join buffer(Block Nested Loop)</h4><p></p>\n<p><strong>joinjoinjoin?</strong></p>\n<p><strong>join()on</strong></p>\n<p>1001000</p>\n<pre><code class=\"sql\">SELECT * from  left join  on .a = .b;</code></pre>\n<p>a</p>\n<ol>\n<li>100join_buffer</li>\n<li>a1</li>\n<li> 100 + 100 = 200</li>\n</ol>\n<p>a:</p>\n<ol>\n<li>100join_buffer</li>\n<li>1000join_buffer</li>\n<li>join1000 100 * 1000 = 100000</li>\n</ol>\n<p> M+NM * Njoin_buffer<strong></strong>Block Nested LoopBlock Nested Loop joinjoin</p>\n<h2 id=\"SQL\"><a href=\"#SQL\" class=\"headerlink\" title=\"SQL\"></a>SQL</h2><ol>\n<li><p>SQL</p>\n</li>\n<li><p></p>\n</li>\n<li><p> <code>SELECT *</code> </p>\n</li>\n<li><p>IS NOT NULL NOT NULLIS NOT NULL</p>\n</li>\n<li><p></p>\n<pre><code class=\"sql\">like &#39;%xx&#39; -- \nlike &#39;%xx%&#39; -- \nlike &#39;xx%&#39; -- </code></pre>\n</li>\n<li><p>OROR</p>\n<pre><code class=\"sql\">SELECT * FROM TABLE KEY1 = &#39;XXX&#39; OR KEY2 = &#39;XXX&#39;; \n--key1key2SQLORUNION KEY1</code></pre>\n</li>\n<li><p><code>!=&lt;&gt;NOT INNOT EXISTSNOT LIKE</code> </p>\n</li>\n<li><p>ORDER BY</p>\n</li>\n<li><p>INEXIST</p>\n<ol>\n<li>SELECT * FROM a WHERE id IN (SELECT id from b) -  IN<code>ba</code>bA10000,B100,10000*100,,</li>\n<li>SELECT a.* FROM A a  WHERE EXISTS(SELECT 1 FROM B b WHERE a.id=b.id) - EXISTE<code>ba</code></li>\n</ol>\n</li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><pre><code class=\"sql\">-- \nshow variables like &#39;optimizer_trace&#39;;\n-- \nset session optimizer_trace=&quot;enabled=on&quot;,end_markers_in_json=on;\n-- \nset OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000;\n-- SQL\n-- \nSELECT trace FROM information_schema.OPTIMIZER_TRACE;</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/2020/07/31/mysql-explain/1.jpg\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/rem7Ds_QSnyhlrtNPByQcg\" target=\"_blank\" rel=\"noopener\">MySQLEXPLAIN</a></li>\n</ul>"},{"title":"MySQLInnoDB","description":"MySQLInnoDB","date":"2020-11-11T09:56:53.000Z","_content":"\n### \n\nMysql\n\n- \n- \n- InnodbMVCC\n\nInnoDB [InnoDB Locking Doc](https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-shared-exclusive-locks)MySQL\n### \n\nMySQL \n\nMySQLSX\n\n![](mysql-lock/2.png)\n\n<!--more-->\n\n<font color=red>****</font>MySQL\"Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.\"XXXXX\n\n- IS\n- IX\n\n**MySQL**\n\n### \n\nRecord LocksGap LocksNext-Key Locks+Insert Intention Locks\n\n\n\n```sql\nCREATE TABLE HERO(\nid INT, \nname VARCAHR(100),\nPRIMARY KEY(id),\nKEY `INDEX_NAME` (`name`) USING BIREE\n) Engine=InnoDB CHARSET=utf8;\n```\n\n\n\n#### Record Locks\n\nSX**record lockinnodbsqlX**\n\n- SSX\n\n- XS X \n\n![Record Locks](mysql-lock/3.png)\n\n#### Gap Locks\n\n<font color=red>insertupdate</font>GapGap<font color=red>RR</font>RC<font color=red>RCGap</font>\n\n![Gap Locks](mysql-lock/4.png)\n\n**Gap**\n\n- RRGapgapnext-key[MySQLgap](https://www.cnblogs.com/crazylqy/p/7821481.html?spm=a2c6h.12873639.0.0.47a21bf4qroWrl)\n- RCGap[RC](https://cloud.tencent.com/developer/article/1678599)\n\nIDname\n\n```SQL\n-- XGap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '3';\n-- 57,9X(3,5),(5,7),(7,9),(9,+)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID > '3';\n-- (1,3)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '2';\n```\n\n#### NextKey Locks\n\nGapRecordrecord135next-key lock(-,1],(1,3],(3,5],(5,+]<font color=red>next-key lockRRinsertNext-key lock</font>\n\n#### Insert Intention Locks\n\nGap<font color=red>GapBCInsert Intention LockGapInsert Intention LocksGapInsert Intention Locks</font>******\n\n### \n\n#### \n\n**<font color=red></font>**RCinsert on duplicate key updateinsert on duplicate key updateDeadlock found when trying to get lock\n\n```sql\n--- ----\nCREATE TABLE `flow_data` (\n  `time` varchar(8) NOT NULL DEFAULT '',\n  `domain` varchar(256) NOT NULL DEFAULT '',\n  `v1` bigint(20) DEFAULT '0',\n  `v2` bigint(20) DEFAULT '0',\n  `v3` bigint(20) DEFAULT '0',\n  `v4` bigint(20) DEFAULT '0',\n  PRIMARY KEY (`time`,`domain`),\n  KEY `index_domain` (`domain`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n--- ----\nINSERT INTO flow_data (time, domain, v1, v2, v3, v4) VALUES\n  ('20201111','a.com',26420278,27235006,26189728,29158467),\n  ('20201111','b.com',26420278,27235006,26189728,29158467),\n  ('20201111','c.com',26420278,27235006,26189728,29158467) \nON DUPLICATE KEY UPDATE \n  v1=VALUES(v1),v2 =VALUES(v2),v3=VALUES(v3),v4 =VALUES(v4);\n```\n\n![](mysql-lock/6.png)\n\n#### \n\n![](mysql-lock/7.png)\n\n\n\n1lock_mode X locks gap before rec insert intention waiting<font color=red>gap</font>\n\n2Xlock_mode X locks gap before rec insert intention waiting\"\n\n#### \n\n\n\n- RCGap\n- insert on duplicate key update\n\nMySQL\n\n- insert on duplicate key update <font color=red></font>domian=a.coma.comINSERTdomaindomainUPDATE\n- RC<font color=red></font>Gap\n- next-key lockRRinsert<font color=red></font>Next-key lock\n- <font color=red></font>\n\n<font color=red>X Next-keynext-key</font>\n\n![](mysql-lock/8.png)\n\n#### \n\n\n\n- insert on duplicate key update\n- Mysql5.7,Mysql5.6\n- insert on duplicate key update\n- \n\ndomain + \n\ndoaminInnoDBdomian","source":"_posts/mysql-lock.md","raw":"---\ntitle: MySQLInnoDB\ntags:\n  - mysql\ncategories:  mysql\ndescription : MySQLInnoDB\ndate: 2020-11-11 17:56:53\n---\n\n### \n\nMysql\n\n- \n- \n- InnodbMVCC\n\nInnoDB [InnoDB Locking Doc](https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-shared-exclusive-locks)MySQL\n### \n\nMySQL \n\nMySQLSX\n\n![](mysql-lock/2.png)\n\n<!--more-->\n\n<font color=red>****</font>MySQL\"Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.\"XXXXX\n\n- IS\n- IX\n\n**MySQL**\n\n### \n\nRecord LocksGap LocksNext-Key Locks+Insert Intention Locks\n\n\n\n```sql\nCREATE TABLE HERO(\nid INT, \nname VARCAHR(100),\nPRIMARY KEY(id),\nKEY `INDEX_NAME` (`name`) USING BIREE\n) Engine=InnoDB CHARSET=utf8;\n```\n\n\n\n#### Record Locks\n\nSX**record lockinnodbsqlX**\n\n- SSX\n\n- XS X \n\n![Record Locks](mysql-lock/3.png)\n\n#### Gap Locks\n\n<font color=red>insertupdate</font>GapGap<font color=red>RR</font>RC<font color=red>RCGap</font>\n\n![Gap Locks](mysql-lock/4.png)\n\n**Gap**\n\n- RRGapgapnext-key[MySQLgap](https://www.cnblogs.com/crazylqy/p/7821481.html?spm=a2c6h.12873639.0.0.47a21bf4qroWrl)\n- RCGap[RC](https://cloud.tencent.com/developer/article/1678599)\n\nIDname\n\n```SQL\n-- XGap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '3';\n-- 57,9X(3,5),(5,7),(7,9),(9,+)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID > '3';\n-- (1,3)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '2';\n```\n\n#### NextKey Locks\n\nGapRecordrecord135next-key lock(-,1],(1,3],(3,5],(5,+]<font color=red>next-key lockRRinsertNext-key lock</font>\n\n#### Insert Intention Locks\n\nGap<font color=red>GapBCInsert Intention LockGapInsert Intention LocksGapInsert Intention Locks</font>******\n\n### \n\n#### \n\n**<font color=red></font>**RCinsert on duplicate key updateinsert on duplicate key updateDeadlock found when trying to get lock\n\n```sql\n--- ----\nCREATE TABLE `flow_data` (\n  `time` varchar(8) NOT NULL DEFAULT '',\n  `domain` varchar(256) NOT NULL DEFAULT '',\n  `v1` bigint(20) DEFAULT '0',\n  `v2` bigint(20) DEFAULT '0',\n  `v3` bigint(20) DEFAULT '0',\n  `v4` bigint(20) DEFAULT '0',\n  PRIMARY KEY (`time`,`domain`),\n  KEY `index_domain` (`domain`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n--- ----\nINSERT INTO flow_data (time, domain, v1, v2, v3, v4) VALUES\n  ('20201111','a.com',26420278,27235006,26189728,29158467),\n  ('20201111','b.com',26420278,27235006,26189728,29158467),\n  ('20201111','c.com',26420278,27235006,26189728,29158467) \nON DUPLICATE KEY UPDATE \n  v1=VALUES(v1),v2 =VALUES(v2),v3=VALUES(v3),v4 =VALUES(v4);\n```\n\n![](mysql-lock/6.png)\n\n#### \n\n![](mysql-lock/7.png)\n\n\n\n1lock_mode X locks gap before rec insert intention waiting<font color=red>gap</font>\n\n2Xlock_mode X locks gap before rec insert intention waiting\"\n\n#### \n\n\n\n- RCGap\n- insert on duplicate key update\n\nMySQL\n\n- insert on duplicate key update <font color=red></font>domian=a.coma.comINSERTdomaindomainUPDATE\n- RC<font color=red></font>Gap\n- next-key lockRRinsert<font color=red></font>Next-key lock\n- <font color=red></font>\n\n<font color=red>X Next-keynext-key</font>\n\n![](mysql-lock/8.png)\n\n#### \n\n\n\n- insert on duplicate key update\n- Mysql5.7,Mysql5.6\n- insert on duplicate key update\n- \n\ndomain + \n\ndoaminInnoDBdomian","slug":"mysql-lock","published":1,"updated":"2021-04-08T00:47:06.887Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvc001vqwv2huefgvah","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Mysql</p>\n<ul>\n<li></li>\n<li></li>\n<li>InnodbMVCC</li>\n</ul>\n<p>InnoDB <a href=\"https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-shared-exclusive-locks\" target=\"_blank\" rel=\"noopener\">InnoDB Locking Doc</a>MySQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MySQL </p>\n<p>MySQLSX</p>\n<p><img src=\"/2020/11/11/mysql-lock/2.png\" alt></p>\n<a id=\"more\"></a>\n\n<p><font color=\"red\"><strong></strong></font>MySQLIntention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.XXXXX</p>\n<ul>\n<li>IS</li>\n<li>IX</li>\n</ul>\n<p><strong>MySQL</strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Record LocksGap LocksNext-Key Locks+Insert Intention Locks</p>\n<p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> HERO<span class=\"token punctuation\">(</span>\nid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span> \nname VARCAHR<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>INDEX_NAME<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> BIREE\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">Engine</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span></code></pre>\n<h4 id=\"Record-Locks\"><a href=\"#Record-Locks\" class=\"headerlink\" title=\"Record Locks\"></a>Record Locks</h4><p>SX<strong>record lockinnodbsqlX</strong></p>\n<ul>\n<li><p>SSX</p>\n</li>\n<li><p>XS X </p>\n</li>\n</ul>\n<p><img src=\"/2020/11/11/mysql-lock/3.png\" alt=\"Record Locks\"></p>\n<h4 id=\"Gap-Locks\"><a href=\"#Gap-Locks\" class=\"headerlink\" title=\"Gap Locks\"></a>Gap Locks</h4><p><font color=\"red\">insertupdate</font>GapGap<font color=\"red\">RR</font>RC<font color=\"red\">RCGap</font></p>\n<p><img src=\"/2020/11/11/mysql-lock/4.png\" alt=\"Gap Locks\"></p>\n<p><strong>Gap</strong></p>\n<ul>\n<li>RRGapgapnext-key<a href=\"https://www.cnblogs.com/crazylqy/p/7821481.html?spm=a2c6h.12873639.0.0.47a21bf4qroWrl\" target=\"_blank\" rel=\"noopener\">MySQLgap</a></li>\n<li>RCGap<a href=\"https://cloud.tencent.com/developer/article/1678599\" target=\"_blank\" rel=\"noopener\">RC</a></li>\n</ul>\n<p>IDname</p>\n<pre class=\" language-SQL\"><code class=\"language-SQL\">-- XGap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '3';\n-- 57,9X(3,5),(5,7),(7,9),(9,+)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID > '3';\n-- (1,3)Gap\nUPDATE `HERO` SET name = 'xxx' WHERE ID = '2';</code></pre>\n<h4 id=\"NextKey-Locks\"><a href=\"#NextKey-Locks\" class=\"headerlink\" title=\"NextKey Locks\"></a>NextKey Locks</h4><p>GapRecordrecord135next-key lock(-,1],(1,3],(3,5],(5,+]<font color=\"red\">next-key lockRRinsertNext-key lock</font></p>\n<h4 id=\"Insert-Intention-Locks\"><a href=\"#Insert-Intention-Locks\" class=\"headerlink\" title=\"Insert Intention Locks\"></a>Insert Intention Locks</h4><p>Gap<font color=\"red\">GapBCInsert Intention LockGapInsert Intention LocksGapInsert Intention Locks</font><strong><em></em></strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong><font color=\"red\"></font></strong>RCinsert on duplicate key updateinsert on duplicate key updateDeadlock found when trying to get lock</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">--- ----</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>flow_data<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span>time<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>domain<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>v1<span class=\"token punctuation\">`</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>v2<span class=\"token punctuation\">`</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>v3<span class=\"token punctuation\">`</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>v4<span class=\"token punctuation\">`</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>time<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>domain<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>index_domain<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>domain<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--- ----</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> flow_data <span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">,</span> v1<span class=\"token punctuation\">,</span> v2<span class=\"token punctuation\">,</span> v3<span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'20201111'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a.com'</span><span class=\"token punctuation\">,</span><span class=\"token number\">26420278</span><span class=\"token punctuation\">,</span><span class=\"token number\">27235006</span><span class=\"token punctuation\">,</span><span class=\"token number\">26189728</span><span class=\"token punctuation\">,</span><span class=\"token number\">29158467</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'20201111'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b.com'</span><span class=\"token punctuation\">,</span><span class=\"token number\">26420278</span><span class=\"token punctuation\">,</span><span class=\"token number\">27235006</span><span class=\"token punctuation\">,</span><span class=\"token number\">26189728</span><span class=\"token punctuation\">,</span><span class=\"token number\">29158467</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'20201111'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c.com'</span><span class=\"token punctuation\">,</span><span class=\"token number\">26420278</span><span class=\"token punctuation\">,</span><span class=\"token number\">27235006</span><span class=\"token punctuation\">,</span><span class=\"token number\">26189728</span><span class=\"token punctuation\">,</span><span class=\"token number\">29158467</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">DUPLICATE KEY</span> <span class=\"token keyword\">UPDATE</span> \n  v1<span class=\"token operator\">=</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>v2 <span class=\"token operator\">=</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>v2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>v3<span class=\"token operator\">=</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>v4 <span class=\"token operator\">=</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>v4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/11/11/mysql-lock/6.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2020/11/11/mysql-lock/7.png\" alt></p>\n<p></p>\n<p>1lock_mode X locks gap before rec insert intention waiting<font color=\"red\">gap</font></p>\n<p>2Xlock_mode X locks gap before rec insert intention waiting</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>RCGap</li>\n<li>insert on duplicate key update</li>\n</ul>\n<p>MySQL</p>\n<ul>\n<li>insert on duplicate key update <font color=\"red\"></font>domian=a.coma.comINSERTdomaindomainUPDATE</li>\n<li>RC<font color=\"red\"></font>Gap</li>\n<li>next-key lockRRinsert<font color=\"red\"></font>Next-key lock</li>\n<li><font color=\"red\"></font></li>\n</ul>\n<p><font color=\"red\">X Next-keynext-key</font></p>\n<p><img src=\"/2020/11/11/mysql-lock/8.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>insert on duplicate key update</li>\n<li>Mysql5.7,Mysql5.6</li>\n<li>insert on duplicate key update</li>\n<li></li>\n</ul>\n<p>domain + </p>\n<p>doaminInnoDBdomian</p>\n","site":{"data":{}},"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Mysql</p>\n<ul>\n<li></li>\n<li></li>\n<li>InnodbMVCC</li>\n</ul>\n<p>InnoDB <a href=\"https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-shared-exclusive-locks\" target=\"_blank\" rel=\"noopener\">InnoDB Locking Doc</a>MySQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MySQL </p>\n<p>MySQLSX</p>\n<p><img src=\"/2020/11/11/mysql-lock/2.png\" alt></p>","more":"<p><font color=\"red\"><strong></strong></font>MySQLIntention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.XXXXX</p>\n<ul>\n<li>IS</li>\n<li>IX</li>\n</ul>\n<p><strong>MySQL</strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Record LocksGap LocksNext-Key Locks+Insert Intention Locks</p>\n<p></p>\n<pre><code class=\"sql\">CREATE TABLE HERO(\nid INT, \nname VARCAHR(100),\nPRIMARY KEY(id),\nKEY `INDEX_NAME` (`name`) USING BIREE\n) Engine=InnoDB CHARSET=utf8;</code></pre>\n<h4 id=\"Record-Locks\"><a href=\"#Record-Locks\" class=\"headerlink\" title=\"Record Locks\"></a>Record Locks</h4><p>SX<strong>record lockinnodbsqlX</strong></p>\n<ul>\n<li><p>SSX</p>\n</li>\n<li><p>XS X </p>\n</li>\n</ul>\n<p><img src=\"/2020/11/11/mysql-lock/3.png\" alt=\"Record Locks\"></p>\n<h4 id=\"Gap-Locks\"><a href=\"#Gap-Locks\" class=\"headerlink\" title=\"Gap Locks\"></a>Gap Locks</h4><p><font color=\"red\">insertupdate</font>GapGap<font color=\"red\">RR</font>RC<font color=\"red\">RCGap</font></p>\n<p><img src=\"/2020/11/11/mysql-lock/4.png\" alt=\"Gap Locks\"></p>\n<p><strong>Gap</strong></p>\n<ul>\n<li>RRGapgapnext-key<a href=\"https://www.cnblogs.com/crazylqy/p/7821481.html?spm=a2c6h.12873639.0.0.47a21bf4qroWrl\" target=\"_blank\" rel=\"noopener\">MySQLgap</a></li>\n<li>RCGap<a href=\"https://cloud.tencent.com/developer/article/1678599\" target=\"_blank\" rel=\"noopener\">RC</a></li>\n</ul>\n<p>IDname</p>\n<pre><code class=\"SQL\">-- XGap\nUPDATE `HERO` SET name = &#39;xxx&#39; WHERE ID = &#39;3&#39;;\n-- 57,9X(3,5),(5,7),(7,9),(9,+)Gap\nUPDATE `HERO` SET name = &#39;xxx&#39; WHERE ID &gt; &#39;3&#39;;\n-- (1,3)Gap\nUPDATE `HERO` SET name = &#39;xxx&#39; WHERE ID = &#39;2&#39;;</code></pre>\n<h4 id=\"NextKey-Locks\"><a href=\"#NextKey-Locks\" class=\"headerlink\" title=\"NextKey Locks\"></a>NextKey Locks</h4><p>GapRecordrecord135next-key lock(-,1],(1,3],(3,5],(5,+]<font color=\"red\">next-key lockRRinsertNext-key lock</font></p>\n<h4 id=\"Insert-Intention-Locks\"><a href=\"#Insert-Intention-Locks\" class=\"headerlink\" title=\"Insert Intention Locks\"></a>Insert Intention Locks</h4><p>Gap<font color=\"red\">GapBCInsert Intention LockGapInsert Intention LocksGapInsert Intention Locks</font><strong><em></em></strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong><font color=\"red\"></font></strong>RCinsert on duplicate key updateinsert on duplicate key updateDeadlock found when trying to get lock</p>\n<pre><code class=\"sql\">--- ----\nCREATE TABLE `flow_data` (\n  `time` varchar(8) NOT NULL DEFAULT &#39;&#39;,\n  `domain` varchar(256) NOT NULL DEFAULT &#39;&#39;,\n  `v1` bigint(20) DEFAULT &#39;0&#39;,\n  `v2` bigint(20) DEFAULT &#39;0&#39;,\n  `v3` bigint(20) DEFAULT &#39;0&#39;,\n  `v4` bigint(20) DEFAULT &#39;0&#39;,\n  PRIMARY KEY (`time`,`domain`),\n  KEY `index_domain` (`domain`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n--- ----\nINSERT INTO flow_data (time, domain, v1, v2, v3, v4) VALUES\n  (&#39;20201111&#39;,&#39;a.com&#39;,26420278,27235006,26189728,29158467),\n  (&#39;20201111&#39;,&#39;b.com&#39;,26420278,27235006,26189728,29158467),\n  (&#39;20201111&#39;,&#39;c.com&#39;,26420278,27235006,26189728,29158467) \nON DUPLICATE KEY UPDATE \n  v1=VALUES(v1),v2 =VALUES(v2),v3=VALUES(v3),v4 =VALUES(v4);</code></pre>\n<p><img src=\"/2020/11/11/mysql-lock/6.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2020/11/11/mysql-lock/7.png\" alt></p>\n<p></p>\n<p>1lock_mode X locks gap before rec insert intention waiting<font color=\"red\">gap</font></p>\n<p>2Xlock_mode X locks gap before rec insert intention waiting</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>RCGap</li>\n<li>insert on duplicate key update</li>\n</ul>\n<p>MySQL</p>\n<ul>\n<li>insert on duplicate key update <font color=\"red\"></font>domian=a.coma.comINSERTdomaindomainUPDATE</li>\n<li>RC<font color=\"red\"></font>Gap</li>\n<li>next-key lockRRinsert<font color=\"red\"></font>Next-key lock</li>\n<li><font color=\"red\"></font></li>\n</ul>\n<p><font color=\"red\">X Next-keynext-key</font></p>\n<p><img src=\"/2020/11/11/mysql-lock/8.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>insert on duplicate key update</li>\n<li>Mysql5.7,Mysql5.6</li>\n<li>insert on duplicate key update</li>\n<li></li>\n</ul>\n<p>domain + </p>\n<p>doaminInnoDBdomian</p>"},{"title":"Mysql-InnoDB()","description":"constref","date":"2020-07-31T06:43:52.000Z","_content":"## \nMysql\n- \n- \n  - \n  - \n  - \n  - \n<!--more-->\n## \n\n### \n\n\n\n```sql\nCREATE TABLE `single_table` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;\n```\n\n|                             |      |\n| ----------------------------- | ------------ |\n| id                            |      |\n| key1                          |      |\n| key2                          |      |\n| key3                          |      |\n| key_part1,key_part2,key_part3 |  |\n\n### \n\n#### \n\nSQLid<font color=red></font>Mysql<font color=red></font>\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tid\t=\t3;\n```\n\n\n\n![](mysql-index-single/1.png)\n\nEXPLAINtype = const const<font color=green>1</font>\n\nconstconst\n\n![](mysql-index-single/2.png)\n\n\n#### \n\nidx_key2B+key2id<font color=red>const</font>\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tkey2\t=\t4;\n```\n\n![](mysql-index-single/4.png)\n\n![](mysql-index-single/3.png)\n\n### \n#### \n\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tkey1\t=\t'abc';\n```\n\n![](mysql-index-single/5.png)\n\n![](mysql-index-single/6.png)\n\nEXPLAINtype = refref\n\n#### NULL\nNULL\n```sql\nSELECT\t*\tFROM\tsingle_demo\tWHERE\tkey1\t=\t'abc'\tOR\tkey1\tIS\tNULL;\n```\n\n![NULL](mysql-index-single/9.png)\n\n#### NULL\nNULLkey IS NULLref const\n\n![](mysql-index-single/7.png)\n![](mysql-index-single/8.png)\n\n### \nEXPLAINtype = range\n\n![](mysql-index-single/10.png)\n\n#### range\nSQL=<=>INNOT INIS NULLIS NOT NULL><>=<=BETWEEN!=<>LIKE AND  OR \n##### \n\n\n### AND\n\n```sql\nSELECT * FROM single_table WHERE key1 = 'abc' AND key2 > 1000;\n```\n\n\n- key1 = 'abc'  key1\n- key2 > 1000 key2\n\nsingle_table WHERE\n\n- 1 key1 = 'abc'  ref rangekey1\n- 2 key1idx_key1B+\n- 3 2<font color=red></font>key2 > 1000 \n\n key2  = 'abc' AND key1 >1000 \nkey2 = 'abc'  constkey2key1 \n\n### \n#### \nB+(+)\nB+(+)\n```sql\nSELECT * FROM single_table WHERE key1 =\t'a'\tAND\tkey3 = 'b';\n```\n- 1idx_key1B+key1 = 'a'\n- 2idx_key3B+key3 = 'b'\n- 3 + id\n- 4idid\n\n**Mysql**\n- \n\n```sql\n//\nSELECT * FROM single_table WHERE key1 = 'a' AND key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c'; \n\n//\nSELECT * FROM single_table WHERE key1 > 'a' AND key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c';\n\n//\nSELECT * FROM single_table WHERE key1 = 'a' AND key_part2 = 'a'; \n```\n- \n\n**MysqlIO**\n\n#### \nOR\n```sql\nSELECT * FROM single_table WHERE key1 = 'a' OR key3 = 'b'\n```\nMySQLUnion\n- 1\n- 2\n- 3Intersection\n\n3\n```sql\nSELECT * FROM single_table WHERE key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c' OR (key1 = 'a' AND key3 = 'b');\n```\n\n- key1 = 'a' AND key3 = 'b'idx_key1idx_key3Intersection\n- key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c'idx_key_part\n- Union\n\n## \nMysqlSQLrefconstref\nSQL\nSQLEXPLAIN","source":"_posts/mysql-index-single.md","raw":"---\ntitle: Mysql-InnoDB()\ntags:\n  - mysql\ncategories:  mysql\ndescription : constref\ndate: 2020-07-31 14:43:52\n---\n## \nMysql\n- \n- \n  - \n  - \n  - \n  - \n<!--more-->\n## \n\n### \n\n\n\n```sql\nCREATE TABLE `single_table` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;\n```\n\n|                             |      |\n| ----------------------------- | ------------ |\n| id                            |      |\n| key1                          |      |\n| key2                          |      |\n| key3                          |      |\n| key_part1,key_part2,key_part3 |  |\n\n### \n\n#### \n\nSQLid<font color=red></font>Mysql<font color=red></font>\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tid\t=\t3;\n```\n\n\n\n![](mysql-index-single/1.png)\n\nEXPLAINtype = const const<font color=green>1</font>\n\nconstconst\n\n![](mysql-index-single/2.png)\n\n\n#### \n\nidx_key2B+key2id<font color=red>const</font>\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tkey2\t=\t4;\n```\n\n![](mysql-index-single/4.png)\n\n![](mysql-index-single/3.png)\n\n### \n#### \n\n\n```sql\nSELECT\t*\tFROM\tsingle_table\tWHERE\tkey1\t=\t'abc';\n```\n\n![](mysql-index-single/5.png)\n\n![](mysql-index-single/6.png)\n\nEXPLAINtype = refref\n\n#### NULL\nNULL\n```sql\nSELECT\t*\tFROM\tsingle_demo\tWHERE\tkey1\t=\t'abc'\tOR\tkey1\tIS\tNULL;\n```\n\n![NULL](mysql-index-single/9.png)\n\n#### NULL\nNULLkey IS NULLref const\n\n![](mysql-index-single/7.png)\n![](mysql-index-single/8.png)\n\n### \nEXPLAINtype = range\n\n![](mysql-index-single/10.png)\n\n#### range\nSQL=<=>INNOT INIS NULLIS NOT NULL><>=<=BETWEEN!=<>LIKE AND  OR \n##### \n\n\n### AND\n\n```sql\nSELECT * FROM single_table WHERE key1 = 'abc' AND key2 > 1000;\n```\n\n\n- key1 = 'abc'  key1\n- key2 > 1000 key2\n\nsingle_table WHERE\n\n- 1 key1 = 'abc'  ref rangekey1\n- 2 key1idx_key1B+\n- 3 2<font color=red></font>key2 > 1000 \n\n key2  = 'abc' AND key1 >1000 \nkey2 = 'abc'  constkey2key1 \n\n### \n#### \nB+(+)\nB+(+)\n```sql\nSELECT * FROM single_table WHERE key1 =\t'a'\tAND\tkey3 = 'b';\n```\n- 1idx_key1B+key1 = 'a'\n- 2idx_key3B+key3 = 'b'\n- 3 + id\n- 4idid\n\n**Mysql**\n- \n\n```sql\n//\nSELECT * FROM single_table WHERE key1 = 'a' AND key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c'; \n\n//\nSELECT * FROM single_table WHERE key1 > 'a' AND key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c';\n\n//\nSELECT * FROM single_table WHERE key1 = 'a' AND key_part2 = 'a'; \n```\n- \n\n**MysqlIO**\n\n#### \nOR\n```sql\nSELECT * FROM single_table WHERE key1 = 'a' OR key3 = 'b'\n```\nMySQLUnion\n- 1\n- 2\n- 3Intersection\n\n3\n```sql\nSELECT * FROM single_table WHERE key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c' OR (key1 = 'a' AND key3 = 'b');\n```\n\n- key1 = 'a' AND key3 = 'b'idx_key1idx_key3Intersection\n- key_part1 = 'a' AND key_part2 = 'b' AND key_part3 = 'c'idx_key_part\n- Union\n\n## \nMysqlSQLrefconstref\nSQL\nSQLEXPLAIN","slug":"mysql-index-single","published":1,"updated":"2021-04-08T00:47:06.847Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvd001zqwv29xvu66f7","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Mysql</p>\n<ul>\n<li></li>\n<li><ul>\n<li></li>\n<li></li>\n<li></li>\n<li><a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>single_table<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key1<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key2<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key3<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part1<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part2<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>key_part3<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>common_field<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key2<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key2<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key1<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key1<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key3<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key3<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">`</span>idx_key_part<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>key_part1<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>key_part2<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>key_part3<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></code></pre>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>id</td>\n<td></td>\n</tr>\n<tr>\n<td>key1</td>\n<td></td>\n</tr>\n<tr>\n<td>key2</td>\n<td></td>\n</tr>\n<tr>\n<td>key3</td>\n<td></td>\n</tr>\n<tr>\n<td>key_part1,key_part2,key_part3</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLid<font color=\"red\"></font>Mysql<font color=\"red\"></font></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    single_table    <span class=\"token keyword\">WHERE</span>    id    <span class=\"token operator\">=</span>    <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></code></pre>\n<p></p>\n<p><img src=\"/2020/07/31/mysql-index-single/1.png\" alt=\"\"></p>\n<p>EXPLAINtype = const const<font color=\"green\">1</font></p>\n<p>constconst</p>\n<p><img src=\"/2020/07/31/mysql-index-single/2.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>idx_key2B+key2id<font color=\"red\">const</font></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    single_table    <span class=\"token keyword\">WHERE</span>    key2    <span class=\"token operator\">=</span>    <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/4.png\" alt=\"\"></p>\n<p><img src=\"/2020/07/31/mysql-index-single/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    single_table    <span class=\"token keyword\">WHERE</span>    key1    <span class=\"token operator\">=</span>    <span class=\"token string\">'abc'</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/5.png\" alt=\"\"></p>\n<p><img src=\"/2020/07/31/mysql-index-single/6.png\" alt></p>\n<p>EXPLAINtype = refref</p>\n<h4 id=\"NULL\"><a href=\"#NULL\" class=\"headerlink\" title=\"NULL\"></a>NULL</h4><p>NULL</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>    <span class=\"token operator\">*</span>    <span class=\"token keyword\">FROM</span>    single_demo    <span class=\"token keyword\">WHERE</span>    key1    <span class=\"token operator\">=</span>    <span class=\"token string\">'abc'</span>    <span class=\"token operator\">OR</span>    key1    <span class=\"token operator\">IS</span>    <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/9.png\" alt=\"NULL\"></p>\n<h4 id=\"NULL\"><a href=\"#NULL\" class=\"headerlink\" title=\"NULL\"></a>NULL</h4><p>NULLkey IS NULLref const</p>\n<p><img src=\"/2020/07/31/mysql-index-single/7.png\" alt><br><img src=\"/2020/07/31/mysql-index-single/8.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>EXPLAINtype = range</p>\n<p><img src=\"/2020/07/31/mysql-index-single/10.png\" alt></p>\n<h4 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a>range</h4><p>SQL=&lt;=&gt;INNOT INIS NULLIS NOT NULL&gt;&lt;&gt;=&lt;=BETWEEN!=&lt;&gt;LIKE AND  OR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<h3 id=\"AND\"><a href=\"#AND\" class=\"headerlink\" title=\"AND\"></a>AND</h3><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'abc'</span> <span class=\"token operator\">AND</span> key2 <span class=\"token operator\">></span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></code></pre>\n<p></p>\n<ul>\n<li>key1 = abc  key1</li>\n<li>key2 &gt; 1000 key2</li>\n</ul>\n<p>single_table WHERE<br></p>\n<ul>\n<li>1 key1 = abc  ref rangekey1</li>\n<li>2 key1idx_key1B+</li>\n<li>3 2<font color=\"red\"></font>key2 &gt; 1000 </li>\n</ul>\n<p> key2  = abc AND key1 &gt;1000 <br>key2 = abc  constkey2key1 </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>B+(+)<br>B+(+)</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span>    <span class=\"token string\">'a'</span>    <span class=\"token operator\">AND</span>    key3 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">;</span></code></pre>\n<ul>\n<li>1idx_key1B+key1 = a</li>\n<li>2idx_key3B+key3 = b</li>\n<li>3 + id</li>\n<li>4idid</li>\n</ul>\n<p><strong>Mysql</strong></p>\n<ul>\n<li></li>\n</ul>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part2 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span> <span class=\"token operator\">AND</span> key_part3 <span class=\"token operator\">=</span> <span class=\"token string\">'c'</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">></span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part2 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span> <span class=\"token operator\">AND</span> key_part3 <span class=\"token operator\">=</span> <span class=\"token string\">'c'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part2 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span> </code></pre>\n<ul>\n<li></li>\n</ul>\n<p><strong>MysqlIO</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>OR</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">OR</span> key3 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span></code></pre>\n<p>MySQLUnion</p>\n<ul>\n<li>1</li>\n<li>2</li>\n<li>3Intersection</li>\n</ul>\n<p>3</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> single_table <span class=\"token keyword\">WHERE</span> key_part1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key_part2 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span> <span class=\"token operator\">AND</span> key_part3 <span class=\"token operator\">=</span> <span class=\"token string\">'c'</span> <span class=\"token operator\">OR</span> <span class=\"token punctuation\">(</span>key1 <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">AND</span> key3 <span class=\"token operator\">=</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p></p>\n<ul>\n<li>key1 = a AND key3 = bidx_key1idx_key3Intersection</li>\n<li>key_part1 = a AND key_part2 = b AND key_part3 = cidx_key_part</li>\n<li>Union</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>MysqlSQLrefconstref<br>SQL<br>SQLEXPLAIN</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Mysql</p>\n<ul>\n<li></li>\n<li><ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li></ul></li></ul>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>\n\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"sql\">CREATE TABLE `single_table` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `key1` varchar(100) DEFAULT NULL,\n  `key2` int(11) DEFAULT NULL,\n  `key3` varchar(100) DEFAULT NULL,\n  `key_part1` varchar(100) DEFAULT NULL,\n  `key_part2` varchar(100) DEFAULT NULL,\n  `key_part3` varchar(100) DEFAULT NULL,\n  `common_field` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `idx_key2` (`key2`),\n  KEY `idx_key1` (`key1`),\n  KEY `idx_key3` (`key3`),\n  KEY `idx_key_part` (`key_part1`,`key_part2`,`key_part3`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;</code></pre>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>id</td>\n<td></td>\n</tr>\n<tr>\n<td>key1</td>\n<td></td>\n</tr>\n<tr>\n<td>key2</td>\n<td></td>\n</tr>\n<tr>\n<td>key3</td>\n<td></td>\n</tr>\n<tr>\n<td>key_part1,key_part2,key_part3</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLid<font color=\"red\"></font>Mysql<font color=\"red\"></font></p>\n<pre><code class=\"sql\">SELECT    *    FROM    single_table    WHERE    id    =    3;</code></pre>\n<p></p>\n<p><img src=\"/2020/07/31/mysql-index-single/1.png\" alt=\"\"></p>\n<p>EXPLAINtype = const const<font color=\"green\">1</font></p>\n<p>constconst</p>\n<p><img src=\"/2020/07/31/mysql-index-single/2.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>idx_key2B+key2id<font color=\"red\">const</font></p>\n<pre><code class=\"sql\">SELECT    *    FROM    single_table    WHERE    key2    =    4;</code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/4.png\" alt=\"\"></p>\n<p><img src=\"/2020/07/31/mysql-index-single/3.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<pre><code class=\"sql\">SELECT    *    FROM    single_table    WHERE    key1    =    &#39;abc&#39;;</code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/5.png\" alt=\"\"></p>\n<p><img src=\"/2020/07/31/mysql-index-single/6.png\" alt></p>\n<p>EXPLAINtype = refref</p>\n<h4 id=\"NULL\"><a href=\"#NULL\" class=\"headerlink\" title=\"NULL\"></a>NULL</h4><p>NULL</p>\n<pre><code class=\"sql\">SELECT    *    FROM    single_demo    WHERE    key1    =    &#39;abc&#39;    OR    key1    IS    NULL;</code></pre>\n<p><img src=\"/2020/07/31/mysql-index-single/9.png\" alt=\"NULL\"></p>\n<h4 id=\"NULL\"><a href=\"#NULL\" class=\"headerlink\" title=\"NULL\"></a>NULL</h4><p>NULLkey IS NULLref const</p>\n<p><img src=\"/2020/07/31/mysql-index-single/7.png\" alt><br><img src=\"/2020/07/31/mysql-index-single/8.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>EXPLAINtype = range</p>\n<p><img src=\"/2020/07/31/mysql-index-single/10.png\" alt></p>\n<h4 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a>range</h4><p>SQL=&lt;=&gt;INNOT INIS NULLIS NOT NULL&gt;&lt;&gt;=&lt;=BETWEEN!=&lt;&gt;LIKE AND  OR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<h3 id=\"AND\"><a href=\"#AND\" class=\"headerlink\" title=\"AND\"></a>AND</h3><p></p>\n<pre><code class=\"sql\">SELECT * FROM single_table WHERE key1 = &#39;abc&#39; AND key2 &gt; 1000;</code></pre>\n<p></p>\n<ul>\n<li>key1 = abc  key1</li>\n<li>key2 &gt; 1000 key2</li>\n</ul>\n<p>single_table WHERE<br></p>\n<ul>\n<li>1 key1 = abc  ref rangekey1</li>\n<li>2 key1idx_key1B+</li>\n<li>3 2<font color=\"red\"></font>key2 &gt; 1000 </li>\n</ul>\n<p> key2  = abc AND key1 &gt;1000 <br>key2 = abc  constkey2key1 </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>B+(+)<br>B+(+)</p>\n<pre><code class=\"sql\">SELECT * FROM single_table WHERE key1 =    &#39;a&#39;    AND    key3 = &#39;b&#39;;</code></pre>\n<ul>\n<li>1idx_key1B+key1 = a</li>\n<li>2idx_key3B+key3 = b</li>\n<li>3 + id</li>\n<li>4idid</li>\n</ul>\n<p><strong>Mysql</strong></p>\n<ul>\n<li></li>\n</ul>\n<pre><code class=\"sql\">//\nSELECT * FROM single_table WHERE key1 = &#39;a&#39; AND key_part1 = &#39;a&#39; AND key_part2 = &#39;b&#39; AND key_part3 = &#39;c&#39;; \n\n//\nSELECT * FROM single_table WHERE key1 &gt; &#39;a&#39; AND key_part1 = &#39;a&#39; AND key_part2 = &#39;b&#39; AND key_part3 = &#39;c&#39;;\n\n//\nSELECT * FROM single_table WHERE key1 = &#39;a&#39; AND key_part2 = &#39;a&#39;; </code></pre>\n<ul>\n<li></li>\n</ul>\n<p><strong>MysqlIO</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>OR</p>\n<pre><code class=\"sql\">SELECT * FROM single_table WHERE key1 = &#39;a&#39; OR key3 = &#39;b&#39;</code></pre>\n<p>MySQLUnion</p>\n<ul>\n<li>1</li>\n<li>2</li>\n<li>3Intersection</li>\n</ul>\n<p>3</p>\n<pre><code class=\"sql\">SELECT * FROM single_table WHERE key_part1 = &#39;a&#39; AND key_part2 = &#39;b&#39; AND key_part3 = &#39;c&#39; OR (key1 = &#39;a&#39; AND key3 = &#39;b&#39;);</code></pre>\n<p></p>\n<ul>\n<li>key1 = a AND key3 = bidx_key1idx_key3Intersection</li>\n<li>key_part1 = a AND key_part2 = b AND key_part3 = cidx_key_part</li>\n<li>Union</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>MysqlSQLrefconstref<br>SQL<br>SQLEXPLAIN</p>"},{"title":"MySQL-binlogredologundolog","description":"Mysqlbinlogredoundo","date":"2018-08-07T01:32:25.000Z","_content":"## MySQL\nMySQL binlog()redolog()redolog()\n- binlog\n- redolog<font color=red>Innodb</font><font color=red></font>\n- undologMVCC \n\n### binlog\nbinlogMySQL<font color=red>SQL</font>(mysqlbin\n\nbinlogSTATEMENTROWMIXED my.conf\n\n```properties\n###binlogROW/STATEMENT/MIXED\nbinlog_format=ROW\n```\n\n- STATMENT(,)SQLsqlbinlog\n  - SQLbinlogIO\n  - master-slave(sleep() last_insert_id()user-defined functions(udf))\n- ROW()SQL\n  - functiontrigger\n  - \n- Mixed()STATEMENTbinlogSTATEMENTROWbinlogMySQLSQL\n\n**binlog**\n\n![](mysql-log/2.png)\n\nbinlogbinlog cache binlog cachefile page\n\nmysqlsync_binlog\n\n- sync_binlog=0  writefile page fsync\n- sync_binlog=1  fsync\n- sync_binlog=N(N>1)  write N  fsync\n\n**binlog_cache_size**\n\n```\nshow variables like 'binlog_cache_size';\n```\n\n**binlog_cache_size**\n\n```\nmysql> show global status like 'binlog_cache_%';\n+-----------------------+-------+\n| Variable_name         | Value |\n+-----------------------+-------+\n| Binlog_cache_disk_use | 1008  | #\n| Binlog_cache_use      | 5721  | #\n+-----------------------+-------+\n2 rows in set (0.00 sec)\n```\n\n\n\n### redo\n\nbinlog<font color=red>binlogredo</font>\n\n\n\n#### \n\n![](mysql-log/1.png)\n\n1. (Innodb) ID=2 ID=2<font color=red>MySQL</font>\n2. \n3.  redolog  redolog  prepare \n4.  binlog binlog \n5.  redo log commit\n\n\nMySQLIO<font color=red>MySQL</font> <font color=red> redo</font>\n\n#### redolog?\nWAFwrite ahead logredo log <font color=red>InnoDB  redo logInnoDB </font>\nredoMySQLredo\n\n#### redo\nInnoDB  redo log <font color=red></font>innodb_log_file_size<font color=red>,</font>\n\n redo log redo log  redo log buffer(<font color=red>buffer</font>) redo log buffer redo log  redo log buffer redo log buffer \n- MySQL master   redo log buffer ()\n- MySQL master  10 redo log buffer \n- redo log buffer size 1/2(innodb_log_buffer_size) redo log buffer \n-  redo log file \"\" async/sync flush checkpointredo log bufferredo log file  log sequence number\n\n#### redo\nredo log buffer  <font color=red>innodb_flush_log_at_trx_commit</font> 012\n- 0 : redo log redo log buffer mysql\n- 1 : redo log redo log \n- 2 :  redo  os cache  1  os cache \n\n<font color=red>1</font> fsync()  MySQL 02\n\n### binlogredo\n- redo log  InnoDB binlog  MySQL  Server \n- redo log binlog  ID=2  c  1 \n- redo log binlog \n\n### undo\nundo(MVCC)\nundolog<font color=red></font>deleteundo loginsertupdateupdate\n\n## \n- MYSQL45\n\n","source":"_posts/mysql-log.md","raw":"---\ntitle: MySQL-binlogredologundolog\ntags:\n  - mysql\ncategories:  mysql\ndescription : Mysqlbinlogredoundo\ndate: 2018-08-07 09:32:25\n---\n## MySQL\nMySQL binlog()redolog()redolog()\n- binlog\n- redolog<font color=red>Innodb</font><font color=red></font>\n- undologMVCC \n\n### binlog\nbinlogMySQL<font color=red>SQL</font>(mysqlbin\n\nbinlogSTATEMENTROWMIXED my.conf\n\n```properties\n###binlogROW/STATEMENT/MIXED\nbinlog_format=ROW\n```\n\n- STATMENT(,)SQLsqlbinlog\n  - SQLbinlogIO\n  - master-slave(sleep() last_insert_id()user-defined functions(udf))\n- ROW()SQL\n  - functiontrigger\n  - \n- Mixed()STATEMENTbinlogSTATEMENTROWbinlogMySQLSQL\n\n**binlog**\n\n![](mysql-log/2.png)\n\nbinlogbinlog cache binlog cachefile page\n\nmysqlsync_binlog\n\n- sync_binlog=0  writefile page fsync\n- sync_binlog=1  fsync\n- sync_binlog=N(N>1)  write N  fsync\n\n**binlog_cache_size**\n\n```\nshow variables like 'binlog_cache_size';\n```\n\n**binlog_cache_size**\n\n```\nmysql> show global status like 'binlog_cache_%';\n+-----------------------+-------+\n| Variable_name         | Value |\n+-----------------------+-------+\n| Binlog_cache_disk_use | 1008  | #\n| Binlog_cache_use      | 5721  | #\n+-----------------------+-------+\n2 rows in set (0.00 sec)\n```\n\n\n\n### redo\n\nbinlog<font color=red>binlogredo</font>\n\n\n\n#### \n\n![](mysql-log/1.png)\n\n1. (Innodb) ID=2 ID=2<font color=red>MySQL</font>\n2. \n3.  redolog  redolog  prepare \n4.  binlog binlog \n5.  redo log commit\n\n\nMySQLIO<font color=red>MySQL</font> <font color=red> redo</font>\n\n#### redolog?\nWAFwrite ahead logredo log <font color=red>InnoDB  redo logInnoDB </font>\nredoMySQLredo\n\n#### redo\nInnoDB  redo log <font color=red></font>innodb_log_file_size<font color=red>,</font>\n\n redo log redo log  redo log buffer(<font color=red>buffer</font>) redo log buffer redo log  redo log buffer redo log buffer \n- MySQL master   redo log buffer ()\n- MySQL master  10 redo log buffer \n- redo log buffer size 1/2(innodb_log_buffer_size) redo log buffer \n-  redo log file \"\" async/sync flush checkpointredo log bufferredo log file  log sequence number\n\n#### redo\nredo log buffer  <font color=red>innodb_flush_log_at_trx_commit</font> 012\n- 0 : redo log redo log buffer mysql\n- 1 : redo log redo log \n- 2 :  redo  os cache  1  os cache \n\n<font color=red>1</font> fsync()  MySQL 02\n\n### binlogredo\n- redo log  InnoDB binlog  MySQL  Server \n- redo log binlog  ID=2  c  1 \n- redo log binlog \n\n### undo\nundo(MVCC)\nundolog<font color=red></font>deleteundo loginsertupdateupdate\n\n## \n- MYSQL45\n\n","slug":"mysql-log","published":1,"updated":"2021-04-08T00:47:06.897Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvf0022qwv2gwed7t7d","content":"<h2 id=\"MySQL\"><a href=\"#MySQL\" class=\"headerlink\" title=\"MySQL\"></a>MySQL</h2><p>MySQL binlog()redolog()redolog()</p>\n<ul>\n<li>binlog</li>\n<li>redolog<font color=\"red\">Innodb</font><font color=\"red\"></font></li>\n<li>undologMVCC </li>\n</ul>\n<h3 id=\"binlog\"><a href=\"#binlog\" class=\"headerlink\" title=\"binlog\"></a>binlog</h3><p>binlogMySQL<font color=\"red\">SQL</font>(mysqlbin</p>\n<p>binlogSTATEMENTROWMIXED my.conf</p>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\">###binlogROW/STATEMENT/MIXED</span>\n<span class=\"token attr-name\">binlog_format</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">ROW</span></code></pre>\n<ul>\n<li>STATMENT(,)SQLsqlbinlog<ul>\n<li>SQLbinlogIO</li>\n<li>master-slave(sleep() last_insert_id()user-defined functions(udf))</li>\n</ul>\n</li>\n<li>ROW()SQL<ul>\n<li>functiontrigger</li>\n<li></li>\n</ul>\n</li>\n<li>Mixed()STATEMENTbinlogSTATEMENTROWbinlogMySQLSQL</li>\n</ul>\n<p><strong>binlog</strong></p>\n<p><img src=\"/2018/08/07/mysql-log/2.png\" alt></p>\n<p>binlogbinlog cache binlog cachefile page</p>\n<p>mysqlsync_binlog</p>\n<ul>\n<li>sync_binlog=0  writefile page fsync</li>\n<li>sync_binlog=1  fsync</li>\n<li>sync_binlog=N(N&gt;1)  write N  fsync</li>\n</ul>\n<p><strong>binlog_cache_size</strong></p>\n<pre><code>show variables like &#39;binlog_cache_size&#39;;</code></pre><p><strong>binlog_cache_size</strong></p>\n<pre><code>mysql&gt; show global status like &#39;binlog_cache_%&#39;;\n+-----------------------+-------+\n| Variable_name         | Value |\n+-----------------------+-------+\n| Binlog_cache_disk_use | 1008  | #\n| Binlog_cache_use      | 5721  | #\n+-----------------------+-------+\n2 rows in set (0.00 sec)</code></pre><h3 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h3><p>binlog<font color=\"red\">binlogredo</font></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2018/08/07/mysql-log/1.png\" alt=\"\"></p>\n<ol>\n<li>(Innodb) ID=2 ID=2<font color=\"red\">MySQL</font></li>\n<li></li>\n<li> redolog  redolog  prepare </li>\n<li> binlog binlog </li>\n<li> redo log commit<br></li>\n</ol>\n<p>MySQLIO<font color=\"red\">MySQL</font> <font color=\"red\"> redo</font></p>\n<h4 id=\"redolog\"><a href=\"#redolog\" class=\"headerlink\" title=\"redolog?\"></a>redolog?</h4><p>WAFwrite ahead logredo log <font color=\"red\">InnoDB  redo logInnoDB </font><br>redoMySQLredo</p>\n<h4 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h4><p>InnoDB  redo log <font color=\"red\"></font>innodb_log_file_size<font color=\"red\">,</font></p>\n<p> redo log redo log  redo log buffer(<font color=\"red\">buffer</font>) redo log buffer redo log  redo log buffer redo log buffer </p>\n<ul>\n<li>MySQL master   redo log buffer ()</li>\n<li>MySQL master  10 redo log buffer </li>\n<li>redo log buffer size 1/2(innodb_log_buffer_size) redo log buffer </li>\n<li> redo log file  async/sync flush checkpointredo log bufferredo log file  log sequence number</li>\n</ul>\n<h4 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h4><p>redo log buffer  <font color=\"red\">innodb_flush_log_at_trx_commit</font> 012</p>\n<ul>\n<li>0 : redo log redo log buffer mysql</li>\n<li>1 : redo log redo log </li>\n<li>2 :  redo  os cache  1  os cache </li>\n</ul>\n<p><font color=\"red\">1</font> fsync()  MySQL 02</p>\n<h3 id=\"binlogredo\"><a href=\"#binlogredo\" class=\"headerlink\" title=\"binlogredo\"></a>binlogredo</h3><ul>\n<li>redo log  InnoDB binlog  MySQL  Server </li>\n<li>redo log binlog  ID=2  c  1 </li>\n<li>redo log binlog </li>\n</ul>\n<h3 id=\"undo\"><a href=\"#undo\" class=\"headerlink\" title=\"undo\"></a>undo</h3><p>undo(MVCC)<br>undolog<font color=\"red\"></font>deleteundo loginsertupdateupdate</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQL45</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"MySQL\"><a href=\"#MySQL\" class=\"headerlink\" title=\"MySQL\"></a>MySQL</h2><p>MySQL binlog()redolog()redolog()</p>\n<ul>\n<li>binlog</li>\n<li>redolog<font color=\"red\">Innodb</font><font color=\"red\"></font></li>\n<li>undologMVCC </li>\n</ul>\n<h3 id=\"binlog\"><a href=\"#binlog\" class=\"headerlink\" title=\"binlog\"></a>binlog</h3><p>binlogMySQL<font color=\"red\">SQL</font>(mysqlbin</p>\n<p>binlogSTATEMENTROWMIXED my.conf</p>\n<pre><code class=\"properties\">###binlogROW/STATEMENT/MIXED\nbinlog_format=ROW</code></pre>\n<ul>\n<li>STATMENT(,)SQLsqlbinlog<ul>\n<li>SQLbinlogIO</li>\n<li>master-slave(sleep() last_insert_id()user-defined functions(udf))</li>\n</ul>\n</li>\n<li>ROW()SQL<ul>\n<li>functiontrigger</li>\n<li></li>\n</ul>\n</li>\n<li>Mixed()STATEMENTbinlogSTATEMENTROWbinlogMySQLSQL</li>\n</ul>\n<p><strong>binlog</strong></p>\n<p><img src=\"/2018/08/07/mysql-log/2.png\" alt></p>\n<p>binlogbinlog cache binlog cachefile page</p>\n<p>mysqlsync_binlog</p>\n<ul>\n<li>sync_binlog=0  writefile page fsync</li>\n<li>sync_binlog=1  fsync</li>\n<li>sync_binlog=N(N&gt;1)  write N  fsync</li>\n</ul>\n<p><strong>binlog_cache_size</strong></p>\n<pre><code>show variables like &#39;binlog_cache_size&#39;;</code></pre><p><strong>binlog_cache_size</strong></p>\n<pre><code>mysql&gt; show global status like &#39;binlog_cache_%&#39;;\n+-----------------------+-------+\n| Variable_name         | Value |\n+-----------------------+-------+\n| Binlog_cache_disk_use | 1008  | #\n| Binlog_cache_use      | 5721  | #\n+-----------------------+-------+\n2 rows in set (0.00 sec)</code></pre><h3 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h3><p>binlog<font color=\"red\">binlogredo</font></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2018/08/07/mysql-log/1.png\" alt=\"\"></p>\n<ol>\n<li>(Innodb) ID=2 ID=2<font color=\"red\">MySQL</font></li>\n<li></li>\n<li> redolog  redolog  prepare </li>\n<li> binlog binlog </li>\n<li> redo log commit<br></li>\n</ol>\n<p>MySQLIO<font color=\"red\">MySQL</font> <font color=\"red\"> redo</font></p>\n<h4 id=\"redolog\"><a href=\"#redolog\" class=\"headerlink\" title=\"redolog?\"></a>redolog?</h4><p>WAFwrite ahead logredo log <font color=\"red\">InnoDB  redo logInnoDB </font><br>redoMySQLredo</p>\n<h4 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h4><p>InnoDB  redo log <font color=\"red\"></font>innodb_log_file_size<font color=\"red\">,</font></p>\n<p> redo log redo log  redo log buffer(<font color=\"red\">buffer</font>) redo log buffer redo log  redo log buffer redo log buffer </p>\n<ul>\n<li>MySQL master   redo log buffer ()</li>\n<li>MySQL master  10 redo log buffer </li>\n<li>redo log buffer size 1/2(innodb_log_buffer_size) redo log buffer </li>\n<li> redo log file  async/sync flush checkpointredo log bufferredo log file  log sequence number</li>\n</ul>\n<h4 id=\"redo\"><a href=\"#redo\" class=\"headerlink\" title=\"redo\"></a>redo</h4><p>redo log buffer  <font color=\"red\">innodb_flush_log_at_trx_commit</font> 012</p>\n<ul>\n<li>0 : redo log redo log buffer mysql</li>\n<li>1 : redo log redo log </li>\n<li>2 :  redo  os cache  1  os cache </li>\n</ul>\n<p><font color=\"red\">1</font> fsync()  MySQL 02</p>\n<h3 id=\"binlogredo\"><a href=\"#binlogredo\" class=\"headerlink\" title=\"binlogredo\"></a>binlogredo</h3><ul>\n<li>redo log  InnoDB binlog  MySQL  Server </li>\n<li>redo log binlog  ID=2  c  1 </li>\n<li>redo log binlog </li>\n</ul>\n<h3 id=\"undo\"><a href=\"#undo\" class=\"headerlink\" title=\"undo\"></a>undo</h3><p>undo(MVCC)<br>undolog<font color=\"red\"></font>deleteundo loginsertupdateupdate</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQL45</li>\n</ul>\n"},{"title":"Mysql-InnoDB()","description":"Mysql-InnoDB()","date":"2019-07-18T02:00:00.000Z","_content":"\n## InnoDB\n\nInnoDB16KBInfimum + SupremumUser Records\n![InnoDB](mysql-index/1.png)\n\n|                |                                                          |\n| ------------------ | ------------------------------------------------------------ |\n| File Header        | 38                         |\n| Page Header        | 56                   |\n| Infimum + Supremum | 26 |\n| User Records       |                      |\n| Free Space         |                              |\n| Page Directory     |  |\n| File Trailer       | 8                  |\n\n**InnoDB**\n\n![InnoDB](mysql-index/8.png)\n\nInnoDB<font color=red></font>\n\n- \n- next_record\n\n![InnoDB](mysql-index/2.png)\n\n- \n- 16KB\n- \n\n## \n### ?\n\n```\nSELECT\t[]\tFROM\t\tWHERE\t\t=\txxx;\n```\n ****\n\n### InnoDB\n\n```sql\nCREATE TABLE `index_demo` (\n  `c1` int(11) NOT NULL,\n  `c2` int(11) DEFAULT NULL,\n  `c3` char(11) DEFAULT NULL,\n  PRIMARY KEY (`c1`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\nINSERT INTO index_demo VALUES(1,4,'u'),(3,9,'d'),(5,3,'y');\n....\n```\n\nInnoDBB+\n![](mysql-index/4.png)\n\n\n\n**B+**\n\n![](mysql-index/5.png)\n\n-  2 0 3 record_type(record_type2-;3-;0-;1-)\n- (1,4,u),(3,9,d),(4,4,a)\n- B+\n\n****\n\nB+\n\n![](mysql-index/6.png)\n-  1 record_type(record_type2-;3-;0-;1-)\n- (1,10)10101\n- \n\n****\n\nB+B+1001000,\n\n- B+11100\n- B+21000100=100000\n- B+310001000100=100000000\n- B+4100010001000100=100000000000\n\nB+4\n\n### \n\n20(9)\n- (33)20(1,30)(320,32)1 < 20 < 32030\n- 12 < 20 < 2099\n- 920\n\n## \n\nB+,\n1. \n  - \n  - \n  - \n2. B+\n\nB+****MySQLINDEX **InnoDB**InnoDB<font color=#FF0000 ></font>\n\n## \n****B+ \nInnoDB\n\nc2c2\n\n![](mysql-index/7.png)\n\n**B+**\n\n1. c2\n - c2\n - c2\n - c2\n2. B+c2+\n3. +c2+\n\n****\n\n```\nSELECT * FROM index_demo WHERE C2 = 4\n```\n1. ,44422 < 4 < 9\n2. 42c2c242 < 4  4 3435\n3. 3435\n4. B+c2c1****<font color=#FF0000 ></font>\n\n## \n\nc2,c3c2c3\n\n## \n\n**MySQLB+B-**\n\nBB<font color=red></font>IO**B34**IO\n\nB+B-B-dataIO**IOIOIO**B-dataIOIOB+\n\n## \n\n- MYSQLMySQL  MySQL","source":"_posts/mysql-index.md","raw":"---\ntitle: Mysql-InnoDB()\ntags:\n  - mysql\ncategories:  mysql\ndescription : Mysql-InnoDB()\ndate: 2019-07-18 10:00:00\n---\n\n## InnoDB\n\nInnoDB16KBInfimum + SupremumUser Records\n![InnoDB](mysql-index/1.png)\n\n|                |                                                          |\n| ------------------ | ------------------------------------------------------------ |\n| File Header        | 38                         |\n| Page Header        | 56                   |\n| Infimum + Supremum | 26 |\n| User Records       |                      |\n| Free Space         |                              |\n| Page Directory     |  |\n| File Trailer       | 8                  |\n\n**InnoDB**\n\n![InnoDB](mysql-index/8.png)\n\nInnoDB<font color=red></font>\n\n- \n- next_record\n\n![InnoDB](mysql-index/2.png)\n\n- \n- 16KB\n- \n\n## \n### ?\n\n```\nSELECT\t[]\tFROM\t\tWHERE\t\t=\txxx;\n```\n ****\n\n### InnoDB\n\n```sql\nCREATE TABLE `index_demo` (\n  `c1` int(11) NOT NULL,\n  `c2` int(11) DEFAULT NULL,\n  `c3` char(11) DEFAULT NULL,\n  PRIMARY KEY (`c1`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\nINSERT INTO index_demo VALUES(1,4,'u'),(3,9,'d'),(5,3,'y');\n....\n```\n\nInnoDBB+\n![](mysql-index/4.png)\n\n\n\n**B+**\n\n![](mysql-index/5.png)\n\n-  2 0 3 record_type(record_type2-;3-;0-;1-)\n- (1,4,u),(3,9,d),(4,4,a)\n- B+\n\n****\n\nB+\n\n![](mysql-index/6.png)\n-  1 record_type(record_type2-;3-;0-;1-)\n- (1,10)10101\n- \n\n****\n\nB+B+1001000,\n\n- B+11100\n- B+21000100=100000\n- B+310001000100=100000000\n- B+4100010001000100=100000000000\n\nB+4\n\n### \n\n20(9)\n- (33)20(1,30)(320,32)1 < 20 < 32030\n- 12 < 20 < 2099\n- 920\n\n## \n\nB+,\n1. \n  - \n  - \n  - \n2. B+\n\nB+****MySQLINDEX **InnoDB**InnoDB<font color=#FF0000 ></font>\n\n## \n****B+ \nInnoDB\n\nc2c2\n\n![](mysql-index/7.png)\n\n**B+**\n\n1. c2\n - c2\n - c2\n - c2\n2. B+c2+\n3. +c2+\n\n****\n\n```\nSELECT * FROM index_demo WHERE C2 = 4\n```\n1. ,44422 < 4 < 9\n2. 42c2c242 < 4  4 3435\n3. 3435\n4. B+c2c1****<font color=#FF0000 ></font>\n\n## \n\nc2,c3c2c3\n\n## \n\n**MySQLB+B-**\n\nBB<font color=red></font>IO**B34**IO\n\nB+B-B-dataIO**IOIOIO**B-dataIOIOB+\n\n## \n\n- MYSQLMySQL  MySQL","slug":"mysql-index","published":1,"updated":"2021-04-08T00:47:06.867Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvg0026qwv29cdy8q8h","content":"<h2 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h2><p>InnoDB16KBInfimum + SupremumUser Records<br><img src=\"/2019/07/18/mysql-index/1.png\" alt=\"InnoDB\"></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>File Header</td>\n<td>38</td>\n</tr>\n<tr>\n<td>Page Header</td>\n<td>56</td>\n</tr>\n<tr>\n<td>Infimum + Supremum</td>\n<td>26</td>\n</tr>\n<tr>\n<td>User Records</td>\n<td></td>\n</tr>\n<tr>\n<td>Free Space</td>\n<td></td>\n</tr>\n<tr>\n<td>Page Directory</td>\n<td></td>\n</tr>\n<tr>\n<td>File Trailer</td>\n<td>8</td>\n</tr>\n</tbody></table>\n<p><strong>InnoDB</strong></p>\n<p><img src=\"/2019/07/18/mysql-index/8.png\" alt=\"InnoDB\"></p>\n<p>InnoDB<font color=\"red\"></font></p>\n<ul>\n<li></li>\n<li>next_record</li>\n</ul>\n<p><img src=\"/2019/07/18/mysql-index/2.png\" alt=\"InnoDB\"></p>\n<ul>\n<li></li>\n<li>16KB</li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"?\"></a>?</h3><p></p>\n<pre><code>SELECT    []    FROM        WHERE        =    xxx;</code></pre><p> <strong></strong></p>\n<h3 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h3><pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>index_demo<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span><span class=\"token number\">c1</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span><span class=\"token number\">c2</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span><span class=\"token number\">c3</span><span class=\"token punctuation\">`</span> char<span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span><span class=\"token number\">c1</span><span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> index_demo <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'u'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre>\n<p>InnoDBB+<br><img src=\"/2019/07/18/mysql-index/4.png\" alt></p>\n<p></p>\n<p><strong>B+</strong></p>\n<p><img src=\"/2019/07/18/mysql-index/5.png\" alt></p>\n<ul>\n<li> 2 0 3 record_type(record_type2-;3-;0-;1-)</li>\n<li>(1,4,u),(3,9,d),(4,4,a)</li>\n<li>B+</li>\n</ul>\n<p><strong></strong></p>\n<p>B+</p>\n<p><img src=\"/2019/07/18/mysql-index/6.png\" alt></p>\n<ul>\n<li> 1 record_type(record_type2-;3-;0-;1-)</li>\n<li>(1,10)10101</li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<p>B+B+1001000,</p>\n<ul>\n<li>B+11100</li>\n<li>B+21000100=100000</li>\n<li>B+310001000100=100000000</li>\n<li>B+4100010001000100=100000000000</li>\n</ul>\n<p>B+4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>20(9)</p>\n<ul>\n<li>(33)20(1,30)(320,32)1 &lt; 20 &lt; 32030</li>\n<li>12 &lt; 20 &lt; 2099</li>\n<li>920</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>B+,</p>\n<ol>\n<li><ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li>B+</li>\n</ol>\n<p>B+<strong></strong>MySQLINDEX <strong>InnoDB</strong>InnoDB<font color=\"#FF0000\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong></strong>B+ <br>InnoDB</p>\n<p>c2c2</p>\n<p><img src=\"/2019/07/18/mysql-index/7.png\" alt></p>\n<p><strong>B+</strong></p>\n<ol>\n<li>c2<ul>\n<li>c2</li>\n<li>c2</li>\n<li>c2</li>\n</ul>\n</li>\n<li>B+c2+</li>\n<li>+c2+</li>\n</ol>\n<p><strong></strong></p>\n<pre><code>SELECT * FROM index_demo WHERE C2 = 4</code></pre><ol>\n<li>,44422 &lt; 4 &lt; 9</li>\n<li>42c2c242 &lt; 4  4 3435</li>\n<li>3435</li>\n<li>B+c2c1<strong></strong><font color=\"#FF0000\"></font></li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>c2,c3c2c3</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>MySQLB+B-</strong></p>\n<p>BB<font color=\"red\"></font>IO<strong>B34</strong>IO</p>\n<p>B+B-B-dataIO<strong>IOIOIO</strong>B-dataIOIOB+</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQLMySQL  MySQL</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h2><p>InnoDB16KBInfimum + SupremumUser Records<br><img src=\"/2019/07/18/mysql-index/1.png\" alt=\"InnoDB\"></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>File Header</td>\n<td>38</td>\n</tr>\n<tr>\n<td>Page Header</td>\n<td>56</td>\n</tr>\n<tr>\n<td>Infimum + Supremum</td>\n<td>26</td>\n</tr>\n<tr>\n<td>User Records</td>\n<td></td>\n</tr>\n<tr>\n<td>Free Space</td>\n<td></td>\n</tr>\n<tr>\n<td>Page Directory</td>\n<td></td>\n</tr>\n<tr>\n<td>File Trailer</td>\n<td>8</td>\n</tr>\n</tbody></table>\n<p><strong>InnoDB</strong></p>\n<p><img src=\"/2019/07/18/mysql-index/8.png\" alt=\"InnoDB\"></p>\n<p>InnoDB<font color=\"red\"></font></p>\n<ul>\n<li></li>\n<li>next_record</li>\n</ul>\n<p><img src=\"/2019/07/18/mysql-index/2.png\" alt=\"InnoDB\"></p>\n<ul>\n<li></li>\n<li>16KB</li>\n<li></li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"?\"></a>?</h3><p></p>\n<pre><code>SELECT    []    FROM        WHERE        =    xxx;</code></pre><p> <strong></strong></p>\n<h3 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h3><pre><code class=\"sql\">CREATE TABLE `index_demo` (\n  `c1` int(11) NOT NULL,\n  `c2` int(11) DEFAULT NULL,\n  `c3` char(11) DEFAULT NULL,\n  PRIMARY KEY (`c1`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\nINSERT INTO index_demo VALUES(1,4,&#39;u&#39;),(3,9,&#39;d&#39;),(5,3,&#39;y&#39;);\n....</code></pre>\n<p>InnoDBB+<br><img src=\"/2019/07/18/mysql-index/4.png\" alt></p>\n<p></p>\n<p><strong>B+</strong></p>\n<p><img src=\"/2019/07/18/mysql-index/5.png\" alt></p>\n<ul>\n<li> 2 0 3 record_type(record_type2-;3-;0-;1-)</li>\n<li>(1,4,u),(3,9,d),(4,4,a)</li>\n<li>B+</li>\n</ul>\n<p><strong></strong></p>\n<p>B+</p>\n<p><img src=\"/2019/07/18/mysql-index/6.png\" alt></p>\n<ul>\n<li> 1 record_type(record_type2-;3-;0-;1-)</li>\n<li>(1,10)10101</li>\n<li></li>\n</ul>\n<p><strong></strong></p>\n<p>B+B+1001000,</p>\n<ul>\n<li>B+11100</li>\n<li>B+21000100=100000</li>\n<li>B+310001000100=100000000</li>\n<li>B+4100010001000100=100000000000</li>\n</ul>\n<p>B+4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>20(9)</p>\n<ul>\n<li>(33)20(1,30)(320,32)1 &lt; 20 &lt; 32030</li>\n<li>12 &lt; 20 &lt; 2099</li>\n<li>920</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>B+,</p>\n<ol>\n<li><ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li>B+</li>\n</ol>\n<p>B+<strong></strong>MySQLINDEX <strong>InnoDB</strong>InnoDB<font color=\"#FF0000\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong></strong>B+ <br>InnoDB</p>\n<p>c2c2</p>\n<p><img src=\"/2019/07/18/mysql-index/7.png\" alt></p>\n<p><strong>B+</strong></p>\n<ol>\n<li>c2<ul>\n<li>c2</li>\n<li>c2</li>\n<li>c2</li>\n</ul>\n</li>\n<li>B+c2+</li>\n<li>+c2+</li>\n</ol>\n<p><strong></strong></p>\n<pre><code>SELECT * FROM index_demo WHERE C2 = 4</code></pre><ol>\n<li>,44422 &lt; 4 &lt; 9</li>\n<li>42c2c242 &lt; 4  4 3435</li>\n<li>3435</li>\n<li>B+c2c1<strong></strong><font color=\"#FF0000\"></font></li>\n</ol>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>c2,c3c2c3</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>MySQLB+B-</strong></p>\n<p>BB<font color=\"red\"></font>IO<strong>B34</strong>IO</p>\n<p>B+B-B-dataIO<strong>IOIOIO</strong>B-dataIOIOB+</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MYSQLMySQL  MySQL</li>\n</ul>\n"},{"title":"MySQL","description":"MySQL","date":"2020-08-19T07:25:29.000Z","_content":"\n## \n\n4\n\n### \n\n![](mysql-masterslave-solve/1.jpg)\n\n1. DDLDMLbinlog\n2.  log dump I/Obinlog\n3. I/O Threadbinlogbinlogrelay log\n4. SQL Threadrelay logDDLDML\n<!--more-->\n****\n\n1. SlaveIOMaster\n2. MasterSlaveIOSlaveIO******Masterbinlog****binlog**\n3. SlaveIOSlaverelay-log**Master bin-logmaster-info**\n4. SlaveSQLrelay-logrelay-logMaster\n\nSQLDQLDCLDMLDD\n\n- DQLSELECT\n- DCLGRANTROLLBACKCOMMIT\n- DMLCREATE\n- DDLINSERTUPDATEDELETE\n\n### \n\n- binlog\n- DDL\n- queryDDL\n- \n\n\n\n- delete100w\n- QPS1001000\n- OLAPbaidu\n- \n- SSDSSDSSD\n\n<font color=red>DDL</font>\n\n## \n\n\n\n```\nmysql -h IP -u  -p -P \n```\n\n```\n#\nshow slave status\\G;\n*************************** 1. row ***************************\n\t\t\t  #slave I/O\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: IP\n                  Master_User: repl_user\n                  Master_Port: \n                # 60\n                Connect_Retry: 60\n              #I/O\n              Master_Log_File: mysql-bin.000231\n          #Exec_Master_Log_Pos\n          Read_Master_Log_Pos: 211281725\n          \t   #slave SQLrelay log\n               Relay_Log_File: mysql-relay-bin.000230\n                #slave SQLrelay log\n                Relay_Log_Pos: 10270447\n        Relay_Master_Log_File: mysql-bin.000231\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: wsportal\n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: root.domain_info,root.certificate\n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          #slave SQLmasterposition\n          Exec_Master_Log_Pos: 211281725\n              Relay_Log_Space: 10270667\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        #slavemaster\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n                #sql\n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 12918051\n                  Master_UUID: 8ef54a4c-d0e5-11e7-aa5f-047d7bb918b6\n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n```\n\n\n\n- Slave_IO_State \n- Read_Master_Log_Pos  Exec_Master_Log_Pos  \n- Seconds_Behind_Master salvemaster\n\n**show slave status**\n\n1. ioMaster_Log_FileRead_Master_Log_PosRelay_Log_FileRelay_Log_Pos\n2. sqlRelay_Log_FilesqlRelay_Master_Log_FileExec_Master_Log_Pos\n\nshow slave status44DDLbinlog4\n\n mysql-bin.000231binlog4DDL\n\n4:00~4:02binlog\n\n```\n#--base64-output=decode-rows -v DDLbinlog\nmysqlbinlog --base64-output=decode-rows -v --start-datetime='2020-08-17 04:00:00' --stop-datetime='2020-08-17 04:02:00' -d wsportal mysql-bin.000231 > /home/xuzy/log/mysql_bin_231_4.log\n```\n\n```\ncat mysql_bin_231_4.log | grep 'INSERT' | wc -l\n : 99412\ncat mysql_bin_231_4.log | grep 'INSERT' | grep 'dir_visit_report' | wc -l\n : 43695\n```\n\nbinlog2dir_visit_report44\n\n## \n\n- MySQL5.7\n- Slave\n- \n- \n- binlogsync_binloginnodb_flush_log_at_trx_commit (redo)\n- binlog-format[MYSQLBINLOG_FORMAT](https://www.cnblogs.com/xingyunfashi/p/8431780.html)\n\n### sync_binlog\n\n- sync_binlog = 0 MySQLbinlog\n\n- sync_binlog > 0 \n\n- sync_binlog = 1 MySQLbinlog\n\n### innodb_flush_log_at_trx_commit\n\n0   redo log buffer  InnoDB \n\n1   redo log  redo log \n\n2  redo  os cache  1  os cache \n\n## Mysql\n\n\n\n### \n\n\n\n**binlog**\n\nmysqlmaster-bin.0010binlogmysqlmaster-bin.0010\n\nMysqlPosition\n\n```shell\nstart slave;\n```\n\nbinlogbinlog\n\n```\nmysql> show slave status\\G; #\nmysql> show master status;  #binlog\n```\n\n**binlog**\n\nbinlogposition****\n\n1.  flush tables with read lock;\n2. mysql.bak.sqlbinlog,binlogposition\n3. mysql.bak.sql\n4. \n\n```sql\nchange master to master_host = 'IP', master_user = 'root', master_port=3306, master_password='', master_log_file = 'mysqld-bin.000001', master_log_pos=3260;\n```","source":"_posts/mysql-masterslave-solve.md","raw":"---\ntitle: MySQL\ntags:\n  - mysql\ncategories:  mysql\ndescription : MySQL\ndate: 2020-08-19 15:25:29\n---\n\n## \n\n4\n\n### \n\n![](mysql-masterslave-solve/1.jpg)\n\n1. DDLDMLbinlog\n2.  log dump I/Obinlog\n3. I/O Threadbinlogbinlogrelay log\n4. SQL Threadrelay logDDLDML\n<!--more-->\n****\n\n1. SlaveIOMaster\n2. MasterSlaveIOSlaveIO******Masterbinlog****binlog**\n3. SlaveIOSlaverelay-log**Master bin-logmaster-info**\n4. SlaveSQLrelay-logrelay-logMaster\n\nSQLDQLDCLDMLDD\n\n- DQLSELECT\n- DCLGRANTROLLBACKCOMMIT\n- DMLCREATE\n- DDLINSERTUPDATEDELETE\n\n### \n\n- binlog\n- DDL\n- queryDDL\n- \n\n\n\n- delete100w\n- QPS1001000\n- OLAPbaidu\n- \n- SSDSSDSSD\n\n<font color=red>DDL</font>\n\n## \n\n\n\n```\nmysql -h IP -u  -p -P \n```\n\n```\n#\nshow slave status\\G;\n*************************** 1. row ***************************\n\t\t\t  #slave I/O\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: IP\n                  Master_User: repl_user\n                  Master_Port: \n                # 60\n                Connect_Retry: 60\n              #I/O\n              Master_Log_File: mysql-bin.000231\n          #Exec_Master_Log_Pos\n          Read_Master_Log_Pos: 211281725\n          \t   #slave SQLrelay log\n               Relay_Log_File: mysql-relay-bin.000230\n                #slave SQLrelay log\n                Relay_Log_Pos: 10270447\n        Relay_Master_Log_File: mysql-bin.000231\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: wsportal\n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: root.domain_info,root.certificate\n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          #slave SQLmasterposition\n          Exec_Master_Log_Pos: 211281725\n              Relay_Log_Space: 10270667\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        #slavemaster\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n                #sql\n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 12918051\n                  Master_UUID: 8ef54a4c-d0e5-11e7-aa5f-047d7bb918b6\n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n```\n\n\n\n- Slave_IO_State \n- Read_Master_Log_Pos  Exec_Master_Log_Pos  \n- Seconds_Behind_Master salvemaster\n\n**show slave status**\n\n1. ioMaster_Log_FileRead_Master_Log_PosRelay_Log_FileRelay_Log_Pos\n2. sqlRelay_Log_FilesqlRelay_Master_Log_FileExec_Master_Log_Pos\n\nshow slave status44DDLbinlog4\n\n mysql-bin.000231binlog4DDL\n\n4:00~4:02binlog\n\n```\n#--base64-output=decode-rows -v DDLbinlog\nmysqlbinlog --base64-output=decode-rows -v --start-datetime='2020-08-17 04:00:00' --stop-datetime='2020-08-17 04:02:00' -d wsportal mysql-bin.000231 > /home/xuzy/log/mysql_bin_231_4.log\n```\n\n```\ncat mysql_bin_231_4.log | grep 'INSERT' | wc -l\n : 99412\ncat mysql_bin_231_4.log | grep 'INSERT' | grep 'dir_visit_report' | wc -l\n : 43695\n```\n\nbinlog2dir_visit_report44\n\n## \n\n- MySQL5.7\n- Slave\n- \n- \n- binlogsync_binloginnodb_flush_log_at_trx_commit (redo)\n- binlog-format[MYSQLBINLOG_FORMAT](https://www.cnblogs.com/xingyunfashi/p/8431780.html)\n\n### sync_binlog\n\n- sync_binlog = 0 MySQLbinlog\n\n- sync_binlog > 0 \n\n- sync_binlog = 1 MySQLbinlog\n\n### innodb_flush_log_at_trx_commit\n\n0   redo log buffer  InnoDB \n\n1   redo log  redo log \n\n2  redo  os cache  1  os cache \n\n## Mysql\n\n\n\n### \n\n\n\n**binlog**\n\nmysqlmaster-bin.0010binlogmysqlmaster-bin.0010\n\nMysqlPosition\n\n```shell\nstart slave;\n```\n\nbinlogbinlog\n\n```\nmysql> show slave status\\G; #\nmysql> show master status;  #binlog\n```\n\n**binlog**\n\nbinlogposition****\n\n1.  flush tables with read lock;\n2. mysql.bak.sqlbinlog,binlogposition\n3. mysql.bak.sql\n4. \n\n```sql\nchange master to master_host = 'IP', master_user = 'root', master_port=3306, master_password='', master_log_file = 'mysqld-bin.000001', master_log_pos=3260;\n```","slug":"mysql-masterslave-solve","published":1,"updated":"2021-04-08T00:47:06.907Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvh0029qwv21eef5q0l","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/08/19/mysql-masterslave-solve/1.jpg\" alt></p>\n<ol>\n<li>DDLDMLbinlog</li>\n<li> log dump I/Obinlog</li>\n<li>I/O Threadbinlogbinlogrelay log</li>\n<li>SQL Threadrelay logDDLDML<a id=\"more\"></a></li>\n</ol>\n<p><strong></strong></p>\n<ol>\n<li>SlaveIOMaster</li>\n<li>MasterSlaveIOSlaveIO<strong></strong><strong>Masterbinlog</strong><strong>binlog</strong></li>\n<li>SlaveIOSlaverelay-log<strong>Master bin-logmaster-info</strong></li>\n<li>SlaveSQLrelay-logrelay-logMaster</li>\n</ol>\n<p>SQLDQLDCLDMLDD</p>\n<ul>\n<li>DQLSELECT</li>\n<li>DCLGRANTROLLBACKCOMMIT</li>\n<li>DMLCREATE</li>\n<li>DDLINSERTUPDATEDELETE</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li>binlog</li>\n<li>DDL</li>\n<li>queryDDL</li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li>delete100w</li>\n<li>QPS1001000</li>\n<li>OLAPbaidu</li>\n<li></li>\n<li>SSDSSDSSD</li>\n</ul>\n<p><font color=\"red\">DDL</font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<pre><code>mysql -h IP -u  -p -P </code></pre><pre><code>#\nshow slave status\\G;\n*************************** 1. row ***************************\n              #slave I/O\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: IP\n                  Master_User: repl_user\n                  Master_Port: \n                # 60\n                Connect_Retry: 60\n              #I/O\n              Master_Log_File: mysql-bin.000231\n          #Exec_Master_Log_Pos\n          Read_Master_Log_Pos: 211281725\n                 #slave SQLrelay log\n               Relay_Log_File: mysql-relay-bin.000230\n                #slave SQLrelay log\n                Relay_Log_Pos: 10270447\n        Relay_Master_Log_File: mysql-bin.000231\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: wsportal\n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: root.domain_info,root.certificate\n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          #slave SQLmasterposition\n          Exec_Master_Log_Pos: 211281725\n              Relay_Log_Space: 10270667\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        #slavemaster\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n                #sql\n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 12918051\n                  Master_UUID: 8ef54a4c-d0e5-11e7-aa5f-047d7bb918b6\n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0</code></pre><p></p>\n<ul>\n<li>Slave_IO_State </li>\n<li>Read_Master_Log_Pos  Exec_Master_Log_Pos  </li>\n<li>Seconds_Behind_Master salvemaster</li>\n</ul>\n<p><strong>show slave status</strong></p>\n<ol>\n<li>ioMaster_Log_FileRead_Master_Log_PosRelay_Log_FileRelay_Log_Pos</li>\n<li>sqlRelay_Log_FilesqlRelay_Master_Log_FileExec_Master_Log_Pos</li>\n</ol>\n<p>show slave status44DDLbinlog4</p>\n<p> mysql-bin.000231binlog4DDL</p>\n<p>4:00~4:02binlog</p>\n<pre><code>#--base64-output=decode-rows -v DDLbinlog\nmysqlbinlog --base64-output=decode-rows -v --start-datetime=&#39;2020-08-17 04:00:00&#39; --stop-datetime=&#39;2020-08-17 04:02:00&#39; -d wsportal mysql-bin.000231 &gt; /home/xuzy/log/mysql_bin_231_4.log</code></pre><pre><code>cat mysql_bin_231_4.log | grep &#39;INSERT&#39; | wc -l\n : 99412\ncat mysql_bin_231_4.log | grep &#39;INSERT&#39; | grep &#39;dir_visit_report&#39; | wc -l\n : 43695</code></pre><p>binlog2dir_visit_report44</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MySQL5.7</li>\n<li>Slave</li>\n<li></li>\n<li></li>\n<li>binlogsync_binloginnodb_flush_log_at_trx_commit (redo)</li>\n<li>binlog-format<a href=\"https://www.cnblogs.com/xingyunfashi/p/8431780.html\" target=\"_blank\" rel=\"noopener\">MYSQLBINLOG_FORMAT</a></li>\n</ul>\n<h3 id=\"sync-binlog\"><a href=\"#sync-binlog\" class=\"headerlink\" title=\"sync_binlog\"></a>sync_binlog</h3><ul>\n<li><p>sync_binlog = 0 MySQLbinlog</p>\n</li>\n<li><p>sync_binlog &gt; 0 </p>\n</li>\n<li><p>sync_binlog = 1 MySQLbinlog</p>\n</li>\n</ul>\n<h3 id=\"innodb-flush-log-at-trx-commit\"><a href=\"#innodb-flush-log-at-trx-commit\" class=\"headerlink\" title=\"innodb_flush_log_at_trx_commit\"></a>innodb_flush_log_at_trx_commit</h3><p>0   redo log buffer  InnoDB </p>\n<p>1   redo log  redo log </p>\n<p>2  redo  os cache  1  os cache </p>\n<h2 id=\"Mysql\"><a href=\"#Mysql\" class=\"headerlink\" title=\"Mysql\"></a>Mysql</h2><p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong>binlog</strong></p>\n<p>mysqlmaster-bin.0010binlogmysqlmaster-bin.0010</p>\n<p>MysqlPosition</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">start slave;</code></pre>\n<p>binlogbinlog</p>\n<pre><code>mysql&gt; show slave status\\G; #\nmysql&gt; show master status;  #binlog</code></pre><p><strong>binlog</strong></p>\n<p>binlogposition<strong></strong></p>\n<ol>\n<li> flush tables with read lock;</li>\n<li>mysql.bak.sqlbinlog,binlogposition</li>\n<li>mysql.bak.sql</li>\n<li></li>\n</ol>\n<pre class=\" language-sql\"><code class=\"language-sql\">change master <span class=\"token keyword\">to</span> master_host <span class=\"token operator\">=</span> <span class=\"token string\">'IP'</span><span class=\"token punctuation\">,</span> master_user <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span> master_port<span class=\"token operator\">=</span><span class=\"token number\">3306</span><span class=\"token punctuation\">,</span> master_password<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span> master_log_file <span class=\"token operator\">=</span> <span class=\"token string\">'mysqld-bin.000001'</span><span class=\"token punctuation\">,</span> master_log_pos<span class=\"token operator\">=</span><span class=\"token number\">3260</span><span class=\"token punctuation\">;</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/08/19/mysql-masterslave-solve/1.jpg\" alt></p>\n<ol>\n<li>DDLDMLbinlog</li>\n<li> log dump I/Obinlog</li>\n<li>I/O Threadbinlogbinlogrelay log</li>\n<li>SQL Threadrelay logDDLDML</li></ol>","more":"\n\n<p><strong></strong></p>\n<ol>\n<li>SlaveIOMaster</li>\n<li>MasterSlaveIOSlaveIO<strong></strong><strong>Masterbinlog</strong><strong>binlog</strong></li>\n<li>SlaveIOSlaverelay-log<strong>Master bin-logmaster-info</strong></li>\n<li>SlaveSQLrelay-logrelay-logMaster</li>\n</ol>\n<p>SQLDQLDCLDMLDD</p>\n<ul>\n<li>DQLSELECT</li>\n<li>DCLGRANTROLLBACKCOMMIT</li>\n<li>DMLCREATE</li>\n<li>DDLINSERTUPDATEDELETE</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li>binlog</li>\n<li>DDL</li>\n<li>queryDDL</li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li>delete100w</li>\n<li>QPS1001000</li>\n<li>OLAPbaidu</li>\n<li></li>\n<li>SSDSSDSSD</li>\n</ul>\n<p><font color=\"red\">DDL</font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<pre><code>mysql -h IP -u  -p -P </code></pre><pre><code>#\nshow slave status\\G;\n*************************** 1. row ***************************\n              #slave I/O\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: IP\n                  Master_User: repl_user\n                  Master_Port: \n                # 60\n                Connect_Retry: 60\n              #I/O\n              Master_Log_File: mysql-bin.000231\n          #Exec_Master_Log_Pos\n          Read_Master_Log_Pos: 211281725\n                 #slave SQLrelay log\n               Relay_Log_File: mysql-relay-bin.000230\n                #slave SQLrelay log\n                Relay_Log_Pos: 10270447\n        Relay_Master_Log_File: mysql-bin.000231\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: wsportal\n          Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: root.domain_info,root.certificate\n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          #slave SQLmasterposition\n          Exec_Master_Log_Pos: 211281725\n              Relay_Log_Space: 10270667\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        #slavemaster\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n                #sql\n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 12918051\n                  Master_UUID: 8ef54a4c-d0e5-11e7-aa5f-047d7bb918b6\n             Master_Info_File: mysql.slave_master_info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0</code></pre><p></p>\n<ul>\n<li>Slave_IO_State </li>\n<li>Read_Master_Log_Pos  Exec_Master_Log_Pos  </li>\n<li>Seconds_Behind_Master salvemaster</li>\n</ul>\n<p><strong>show slave status</strong></p>\n<ol>\n<li>ioMaster_Log_FileRead_Master_Log_PosRelay_Log_FileRelay_Log_Pos</li>\n<li>sqlRelay_Log_FilesqlRelay_Master_Log_FileExec_Master_Log_Pos</li>\n</ol>\n<p>show slave status44DDLbinlog4</p>\n<p> mysql-bin.000231binlog4DDL</p>\n<p>4:00~4:02binlog</p>\n<pre><code>#--base64-output=decode-rows -v DDLbinlog\nmysqlbinlog --base64-output=decode-rows -v --start-datetime=&#39;2020-08-17 04:00:00&#39; --stop-datetime=&#39;2020-08-17 04:02:00&#39; -d wsportal mysql-bin.000231 &gt; /home/xuzy/log/mysql_bin_231_4.log</code></pre><pre><code>cat mysql_bin_231_4.log | grep &#39;INSERT&#39; | wc -l\n : 99412\ncat mysql_bin_231_4.log | grep &#39;INSERT&#39; | grep &#39;dir_visit_report&#39; | wc -l\n : 43695</code></pre><p>binlog2dir_visit_report44</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MySQL5.7</li>\n<li>Slave</li>\n<li></li>\n<li></li>\n<li>binlogsync_binloginnodb_flush_log_at_trx_commit (redo)</li>\n<li>binlog-format<a href=\"https://www.cnblogs.com/xingyunfashi/p/8431780.html\" target=\"_blank\" rel=\"noopener\">MYSQLBINLOG_FORMAT</a></li>\n</ul>\n<h3 id=\"sync-binlog\"><a href=\"#sync-binlog\" class=\"headerlink\" title=\"sync_binlog\"></a>sync_binlog</h3><ul>\n<li><p>sync_binlog = 0 MySQLbinlog</p>\n</li>\n<li><p>sync_binlog &gt; 0 </p>\n</li>\n<li><p>sync_binlog = 1 MySQLbinlog</p>\n</li>\n</ul>\n<h3 id=\"innodb-flush-log-at-trx-commit\"><a href=\"#innodb-flush-log-at-trx-commit\" class=\"headerlink\" title=\"innodb_flush_log_at_trx_commit\"></a>innodb_flush_log_at_trx_commit</h3><p>0   redo log buffer  InnoDB </p>\n<p>1   redo log  redo log </p>\n<p>2  redo  os cache  1  os cache </p>\n<h2 id=\"Mysql\"><a href=\"#Mysql\" class=\"headerlink\" title=\"Mysql\"></a>Mysql</h2><p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong>binlog</strong></p>\n<p>mysqlmaster-bin.0010binlogmysqlmaster-bin.0010</p>\n<p>MysqlPosition</p>\n<pre><code class=\"shell\">start slave;</code></pre>\n<p>binlogbinlog</p>\n<pre><code>mysql&gt; show slave status\\G; #\nmysql&gt; show master status;  #binlog</code></pre><p><strong>binlog</strong></p>\n<p>binlogposition<strong></strong></p>\n<ol>\n<li> flush tables with read lock;</li>\n<li>mysql.bak.sqlbinlog,binlogposition</li>\n<li>mysql.bak.sql</li>\n<li></li>\n</ol>\n<pre><code class=\"sql\">change master to master_host = &#39;IP&#39;, master_user = &#39;root&#39;, master_port=3306, master_password=&#39;&#39;, master_log_file = &#39;mysqld-bin.000001&#39;, master_log_pos=3260;</code></pre>"},{"title":"MySQLMVCC","description":"(MVCC)","date":"2020-08-30T08:04:21.000Z","_content":"\n## \n\n### \n\n\n\n```sql\nCREATE\tTABLE hero(\n\tnumber\tINT,\n\tname\tVARCHAR(100),\n\tcountry\tvarchar(100),\n\tPRIMARY\tKEY\t(number)\n)\tEngine=InnoDB\tCHARSET=utf8;\nINSERT INTO\thero VALUES(1,\t'','cn');\n```\n\nMySQL/MySQLSession<font color=red></font>\n\n- \n- \n- \n- \n\n<font color=red>()</font>\n<!--more-->\n### \n\n#### \n\n\n\n|  | Session A                                      | Session B                                      |\n| -------- | ---------------------------------------------- | ---------------------------------------------- |\n| 1        | begin;                                         |                                                |\n| 2        |                                                | begin;                                         |\n| 3        |                                                | UPDAE hero SET name = '' WHERE number = 1; |\n| 4        | UPDAE hero SET name = '' WHERE number = 1; |                                                |\n| 5        | commit;                                        |                                                |\n| 6        |                                                | rollback;                                      |\n\nBAAB<font color=red>A</font>\n\n#### \n\n\n\n|  | Session A                          | Session B                                      |\n| -------- | ---------------------------------- | ---------------------------------------------- |\n| 1        | begin;                             |                                                |\n| 2        |                                    | begin;                                         |\n| 3        |                                    | UPDAE hero SET name = '' WHERE number = 1; |\n| 4        | SELECT * FROM hero WHERE hero = 1; |                                                |\n| 5        | commit;                            |                                                |\n| 6        |                                    | rollback;                                      |\n\nA4name=''BA\n\n#### \n\n\n\n|  | Session A                                                    | Session B                                                    |\n| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 1        | begin;                                                       |                                                              |\n| 2        | SELECT * FROM hero WHERE hero = 1;<br />('''') |                                                              |\n| 3        |                                                              | begin;<br />UPDAE hero SET name = '' WHERE number = 1;<br />commit; |\n| 4        | SELECT * FROM hero WHERE hero = 1;<br />('') |                                                              |\n| 5        |                                                              | begin;<br />UPDAE hero SET name = '' WHERE number = 1;<br />commit; |\n| 6        | SELECT * FROM hero WHERE hero = 1;<br />('') |                                                              |\n\n#### \n\n\n\n|  | Session A                                                    | Session B                             |\n| -------- | ------------------------------------------------------------ | ------------------------------------- |\n| 1        | begin;                                                       |                                       |\n| 2        | SELECT * FROM hero WHERE hero > 0;<br />('''') |                                       |\n| 3        |                                                              | INSERT INTO hero VALUE(2,'','cn') |\n| 4        | SELECT * FROM hero WHERE hero > 0;<br />('''') |                                       |\n\n### ()\n\n#### \n\n4 \n\nMySQL44<font color=red></font>\n\n- READ UNCOMMITTED<font color=blue></font>\n- READ COMMITTED<font color=blue></font>\n- REPEATABLE READ<font color=blue></font>\n- SERIALIZABLE<font color=blue></font>\n\n****\n\n|                      |      |  |      |\n| ---------------------------- | -------- | ---------- | -------- |\n| READ UNCOMMITTED |  |    |  |\n| READ COMMITTED   |    |    |  |\n| REPEATABLE READ  |    |      |  |\n| SERIALIZABLE     |    |      |    |\n\n- READ UNCOMMITTED   \n- READ COMMITTED \n- REPEATABLE READ \n- SERIALIZABLE \n\n****\"\"number = 1'number = 1\n\n- \"\"\n- \n- <font color=red></font>\n\n#### \n\nMVCC()<font color=red>UndoMVCCMySQLIDID</font>\n\n##### \n\nInnoDB\n\n- trx_id  ID\n- roll_pointer undo\n\n(**ID=80**)\n\n|  | trx_id = 100                                   | trx_id = 200                                   |\n| -------- | ---------------------------------------------- | ---------------------------------------------- |\n| 1        | begin                                          |                                                |\n| 2        |                                                | begin                                          |\n| 3        | update hexo set name = '' where number = 1 |                                                |\n| 4        | update hexo set name = '' where number = 1 |                                                |\n| 5        | commit                                         |                                                |\n| 6        |                                                | update hexo set name = '' where number = 1 |\n| 7        |                                                | update hexo set name = '' where number = 1 |\n| 8        |                                                | commit                                         |\n\n** : ? InnoDB(<font color=red></font>)**\n\n\n\n![](mysql-mvcc/1.png)\n\nundoroll_pointer<font color=red></font>\n\n**READ UNCOMMITTEDSERIALIZABLE**\n\n****InnoDB\n\n##### ReadView\n\nREAD COMMITTEDREPEATABLE READ<font color=red></font>ReadViewReadView4\n\n- m_idsReadViewid \n- min_trx_idReadViewidm_ids\n- max_trx_idReadViewid\n- creator_trx_idReadViewid\n\n**INSERTDELETEUPDATEidid0**\n\nReadView\n\n- trx_idReadViewcreator_trx_id<font color=red></font>\n- trx_idmin_trx_id<font color=red></font>\n- trx_idmax_trx_id<font color=red></font>\n- min_trx_idmax_trx_idtrx_idm_ids\n  - <font color=green>ReadView</font>\n  - <font color=green>ReadView</font>\n\n\n\n**READ COMMITTEDREPEATABLE READ**\n\n- <font color=blue></font>\n- <font color=blue></font>\n\nMREAD COMMITTEDREPEATABLE READReadView\n\n**READ COMMITTED  ReadView**\n\n**1**100200number=1\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/2.png)\n\nReadViewReadView\n\n- m_ids = [100,200]\n- min_trx_id = 100\n- max_trx_id = 201\n- creator_trx_id = 0 ID0\n\ntrx_id=100m_Idstrx_id=80m_ids\n\n**2**1002001\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/1.png)\n\nReadViewReadView\n\n- m_ids = [200]100200\n- min_trx_id = 200 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_id = 200m_idstrx_id=100m_ids\n\n**REPEATABLE READ  ReadView**\n\n**1**100200100200number=1300\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/2.png)\n\nReadView\n\n- m_ids = [100200]\n- min_trx_id = 100 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_id = 100 , m_ids\n\n**2**1002001300number = 1\n\n![](mysql-mvcc/1.png)\n\nReadView\n\n- m_ids = [100200]\n- min_trx_id = 100 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_idm_idstrx_id=100m_ids\n\n#### \n\n****\n\n****\n\n```sql\nCREATE TABLE `dept` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `name` varchar(20) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8\ninsert into dept(name) values(\"\");\n```\n\n**1**\n\n| 1              | 2                                    |\n| ------------------ | ---------------------------------------- |\n| begin              | begin                                    |\n| select * from dept |                                          |\n|                    | insert into dept(name) values ('') |\n|                    | commit                                   |\n| select * from dept |                                          |\n| commit             |                                          |\n\n\n\n**2**\n\n| 1                           | 2                                    |\n| ------------------------------- | ---------------------------------------- |\n| begin                           | begin                                    |\n| select * from dept              |                                          |\n|                                 | insert into dept(name) values ('') |\n|                                 | commit                                   |\n| update dept set name = '' |                                          |\n| commit                          |                                          |\n\n\n\n**?** RRMVCCUpdate\n\n****\n\n\n\n- \n- MVCC+next-key locksnext-key locksrecord locks()  gap locks()\n\nnext-key locks(gap)REPEATABLE READgap locknextkey lock\n\n\n\n## \n\n- MVCC READ COMMITTD  REPEATABLE READ SEELCT  -  - \n- MVCCundo\n- \n- ","source":"_posts/mysql-mvcc.md","raw":"---\ntitle: MySQLMVCC\ntags:\n  - mysql\ncategories:  mysql\ndescription : (MVCC)\ndate: 2020-08-30 16:04:21\n---\n\n## \n\n### \n\n\n\n```sql\nCREATE\tTABLE hero(\n\tnumber\tINT,\n\tname\tVARCHAR(100),\n\tcountry\tvarchar(100),\n\tPRIMARY\tKEY\t(number)\n)\tEngine=InnoDB\tCHARSET=utf8;\nINSERT INTO\thero VALUES(1,\t'','cn');\n```\n\nMySQL/MySQLSession<font color=red></font>\n\n- \n- \n- \n- \n\n<font color=red>()</font>\n<!--more-->\n### \n\n#### \n\n\n\n|  | Session A                                      | Session B                                      |\n| -------- | ---------------------------------------------- | ---------------------------------------------- |\n| 1        | begin;                                         |                                                |\n| 2        |                                                | begin;                                         |\n| 3        |                                                | UPDAE hero SET name = '' WHERE number = 1; |\n| 4        | UPDAE hero SET name = '' WHERE number = 1; |                                                |\n| 5        | commit;                                        |                                                |\n| 6        |                                                | rollback;                                      |\n\nBAAB<font color=red>A</font>\n\n#### \n\n\n\n|  | Session A                          | Session B                                      |\n| -------- | ---------------------------------- | ---------------------------------------------- |\n| 1        | begin;                             |                                                |\n| 2        |                                    | begin;                                         |\n| 3        |                                    | UPDAE hero SET name = '' WHERE number = 1; |\n| 4        | SELECT * FROM hero WHERE hero = 1; |                                                |\n| 5        | commit;                            |                                                |\n| 6        |                                    | rollback;                                      |\n\nA4name=''BA\n\n#### \n\n\n\n|  | Session A                                                    | Session B                                                    |\n| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| 1        | begin;                                                       |                                                              |\n| 2        | SELECT * FROM hero WHERE hero = 1;<br />('''') |                                                              |\n| 3        |                                                              | begin;<br />UPDAE hero SET name = '' WHERE number = 1;<br />commit; |\n| 4        | SELECT * FROM hero WHERE hero = 1;<br />('') |                                                              |\n| 5        |                                                              | begin;<br />UPDAE hero SET name = '' WHERE number = 1;<br />commit; |\n| 6        | SELECT * FROM hero WHERE hero = 1;<br />('') |                                                              |\n\n#### \n\n\n\n|  | Session A                                                    | Session B                             |\n| -------- | ------------------------------------------------------------ | ------------------------------------- |\n| 1        | begin;                                                       |                                       |\n| 2        | SELECT * FROM hero WHERE hero > 0;<br />('''') |                                       |\n| 3        |                                                              | INSERT INTO hero VALUE(2,'','cn') |\n| 4        | SELECT * FROM hero WHERE hero > 0;<br />('''') |                                       |\n\n### ()\n\n#### \n\n4 \n\nMySQL44<font color=red></font>\n\n- READ UNCOMMITTED<font color=blue></font>\n- READ COMMITTED<font color=blue></font>\n- REPEATABLE READ<font color=blue></font>\n- SERIALIZABLE<font color=blue></font>\n\n****\n\n|                      |      |  |      |\n| ---------------------------- | -------- | ---------- | -------- |\n| READ UNCOMMITTED |  |    |  |\n| READ COMMITTED   |    |    |  |\n| REPEATABLE READ  |    |      |  |\n| SERIALIZABLE     |    |      |    |\n\n- READ UNCOMMITTED   \n- READ COMMITTED \n- REPEATABLE READ \n- SERIALIZABLE \n\n****\"\"number = 1'number = 1\n\n- \"\"\n- \n- <font color=red></font>\n\n#### \n\nMVCC()<font color=red>UndoMVCCMySQLIDID</font>\n\n##### \n\nInnoDB\n\n- trx_id  ID\n- roll_pointer undo\n\n(**ID=80**)\n\n|  | trx_id = 100                                   | trx_id = 200                                   |\n| -------- | ---------------------------------------------- | ---------------------------------------------- |\n| 1        | begin                                          |                                                |\n| 2        |                                                | begin                                          |\n| 3        | update hexo set name = '' where number = 1 |                                                |\n| 4        | update hexo set name = '' where number = 1 |                                                |\n| 5        | commit                                         |                                                |\n| 6        |                                                | update hexo set name = '' where number = 1 |\n| 7        |                                                | update hexo set name = '' where number = 1 |\n| 8        |                                                | commit                                         |\n\n** : ? InnoDB(<font color=red></font>)**\n\n\n\n![](mysql-mvcc/1.png)\n\nundoroll_pointer<font color=red></font>\n\n**READ UNCOMMITTEDSERIALIZABLE**\n\n****InnoDB\n\n##### ReadView\n\nREAD COMMITTEDREPEATABLE READ<font color=red></font>ReadViewReadView4\n\n- m_idsReadViewid \n- min_trx_idReadViewidm_ids\n- max_trx_idReadViewid\n- creator_trx_idReadViewid\n\n**INSERTDELETEUPDATEidid0**\n\nReadView\n\n- trx_idReadViewcreator_trx_id<font color=red></font>\n- trx_idmin_trx_id<font color=red></font>\n- trx_idmax_trx_id<font color=red></font>\n- min_trx_idmax_trx_idtrx_idm_ids\n  - <font color=green>ReadView</font>\n  - <font color=green>ReadView</font>\n\n\n\n**READ COMMITTEDREPEATABLE READ**\n\n- <font color=blue></font>\n- <font color=blue></font>\n\nMREAD COMMITTEDREPEATABLE READReadView\n\n**READ COMMITTED  ReadView**\n\n**1**100200number=1\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/2.png)\n\nReadViewReadView\n\n- m_ids = [100,200]\n- min_trx_id = 100\n- max_trx_id = 201\n- creator_trx_id = 0 ID0\n\ntrx_id=100m_Idstrx_id=80m_ids\n\n**2**1002001\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/1.png)\n\nReadViewReadView\n\n- m_ids = [200]100200\n- min_trx_id = 200 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_id = 200m_idstrx_id=100m_ids\n\n**REPEATABLE READ  ReadView**\n\n**1**100200100200number=1300\n\n```sql\nSELECT * FROM hero WHERE number = 1;\n```\n\n![](mysql-mvcc/2.png)\n\nReadView\n\n- m_ids = [100200]\n- min_trx_id = 100 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_id = 100 , m_ids\n\n**2**1002001300number = 1\n\n![](mysql-mvcc/1.png)\n\nReadView\n\n- m_ids = [100200]\n- min_trx_id = 100 (ID)\n- max_trx_id = 201\n- creator_trx_id = 0ID0\n\ntrx_idm_idstrx_id=100m_ids\n\n#### \n\n****\n\n****\n\n```sql\nCREATE TABLE `dept` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `name` varchar(20) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8\ninsert into dept(name) values(\"\");\n```\n\n**1**\n\n| 1              | 2                                    |\n| ------------------ | ---------------------------------------- |\n| begin              | begin                                    |\n| select * from dept |                                          |\n|                    | insert into dept(name) values ('') |\n|                    | commit                                   |\n| select * from dept |                                          |\n| commit             |                                          |\n\n\n\n**2**\n\n| 1                           | 2                                    |\n| ------------------------------- | ---------------------------------------- |\n| begin                           | begin                                    |\n| select * from dept              |                                          |\n|                                 | insert into dept(name) values ('') |\n|                                 | commit                                   |\n| update dept set name = '' |                                          |\n| commit                          |                                          |\n\n\n\n**?** RRMVCCUpdate\n\n****\n\n\n\n- \n- MVCC+next-key locksnext-key locksrecord locks()  gap locks()\n\nnext-key locks(gap)REPEATABLE READgap locknextkey lock\n\n\n\n## \n\n- MVCC READ COMMITTD  REPEATABLE READ SEELCT  -  - \n- MVCCundo\n- \n- ","slug":"mysql-mvcc","published":1,"updated":"2021-04-08T00:47:06.907Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvi002dqwv2a6o1e3ab","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span>    <span class=\"token keyword\">TABLE</span> hero<span class=\"token punctuation\">(</span>\n       number    <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n       name    <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       country    <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">PRIMARY</span>    <span class=\"token keyword\">KEY</span>    <span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>    <span class=\"token keyword\">Engine</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span>    <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span>    hero <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>    <span class=\"token string\">''</span><span class=\"token punctuation\">,</span><span class=\"token string\">'cn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>MySQL/MySQLSession<font color=\"red\"></font></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><font color=\"red\">()</font></p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin;</td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit;</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>rollback;</td>\n</tr>\n</tbody></table>\n<p>BAAB<font color=\"red\">A</font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin;</td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero = 1;</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit;</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>rollback;</td>\n</tr>\n</tbody></table>\n<p>A4name=BA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>begin;<br>UPDAE hero SET name =  WHERE number = 1;<br>commit;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>begin;<br>UPDAE hero SET name =  WHERE number = 1;<br>commit;</td>\n</tr>\n<tr>\n<td>6</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>SELECT * FROM hero WHERE hero &gt; 0;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>INSERT INTO hero VALUE(2,,cn)</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero &gt; 0;<br>()</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"()\"></a>()</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>4 </p>\n<p>MySQL44<font color=\"red\"></font></p>\n<ul>\n<li>READ UNCOMMITTED<font color=\"blue\"></font></li>\n<li>READ COMMITTED<font color=\"blue\"></font></li>\n<li>REPEATABLE READ<font color=\"blue\"></font></li>\n<li>SERIALIZABLE<font color=\"blue\"></font></li>\n</ul>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>READ UNCOMMITTED</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>READ COMMITTED</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>REPEATABLE READ</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>SERIALIZABLE</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>READ UNCOMMITTED   </li>\n<li>READ COMMITTED </li>\n<li>REPEATABLE READ </li>\n<li>SERIALIZABLE </li>\n</ul>\n<p><strong></strong>number = 1number = 1</p>\n<ul>\n<li></li>\n<li></li>\n<li><font color=\"red\"></font></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>MVCC()<font color=\"red\">UndoMVCCMySQLIDID</font></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>InnoDB</p>\n<ul>\n<li>trx_id  ID</li>\n<li>roll_pointer undo</li>\n</ul>\n<p>(<strong>ID=80</strong>)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>trx_id = 100</th>\n<th>trx_id = 200</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin</td>\n</tr>\n<tr>\n<td>3</td>\n<td>update hexo set name =  where number = 1</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>update hexo set name =  where number = 1</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>update hexo set name =  where number = 1</td>\n</tr>\n<tr>\n<td>7</td>\n<td></td>\n<td>update hexo set name =  where number = 1</td>\n</tr>\n<tr>\n<td>8</td>\n<td></td>\n<td>commit</td>\n</tr>\n</tbody></table>\n<p><strong> : ? InnoDB(<font color=\"red\"></font>)</strong></p>\n<p></p>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>undoroll_pointer<font color=\"red\"></font></p>\n<p><strong>READ UNCOMMITTEDSERIALIZABLE</strong></p>\n<p><strong></strong>InnoDB</p>\n<h5 id=\"ReadView\"><a href=\"#ReadView\" class=\"headerlink\" title=\"ReadView\"></a>ReadView</h5><p>READ COMMITTEDREPEATABLE READ<font color=\"red\"></font>ReadViewReadView4</p>\n<ul>\n<li>m_idsReadViewid </li>\n<li>min_trx_idReadViewidm_ids</li>\n<li>max_trx_idReadViewid</li>\n<li>creator_trx_idReadViewid</li>\n</ul>\n<p><strong>INSERTDELETEUPDATEidid0</strong></p>\n<p>ReadView</p>\n<ul>\n<li>trx_idReadViewcreator_trx_id<font color=\"red\"></font></li>\n<li>trx_idmin_trx_id<font color=\"red\"></font></li>\n<li>trx_idmax_trx_id<font color=\"red\"></font></li>\n<li>min_trx_idmax_trx_idtrx_idm_ids<ul>\n<li><font color=\"green\">ReadView</font></li>\n<li><font color=\"green\">ReadView</font></li>\n</ul>\n</li>\n</ul>\n<p></p>\n<p><strong>READ COMMITTEDREPEATABLE READ</strong></p>\n<ul>\n<li><font color=\"blue\"></font></li>\n<li><font color=\"blue\"></font></li>\n</ul>\n<p>MREAD COMMITTEDREPEATABLE READReadView</p>\n<p><strong>READ COMMITTED  ReadView</strong></p>\n<p><strong>1</strong>100200number=1</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> hero <span class=\"token keyword\">WHERE</span> number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/2.png\" alt></p>\n<p>ReadViewReadView</p>\n<ul>\n<li>m_ids = [100,200]</li>\n<li>min_trx_id = 100</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0 ID0</li>\n</ul>\n<p>trx_id=100m_Idstrx_id=80m_ids</p>\n<p><strong>2</strong>1002001</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> hero <span class=\"token keyword\">WHERE</span> number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>ReadViewReadView</p>\n<ul>\n<li>m_ids = [200]100200</li>\n<li>min_trx_id = 200 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_id = 200m_idstrx_id=100m_ids</p>\n<p><strong>REPEATABLE READ  ReadView</strong></p>\n<p><strong>1</strong>100200100200number=1300</p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> hero <span class=\"token keyword\">WHERE</span> number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/2.png\" alt=\"\"></p>\n<p>ReadView</p>\n<ul>\n<li>m_ids = [100200]</li>\n<li>min_trx_id = 100 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_id = 100 , m_ids</p>\n<p><strong>2</strong>1002001300number = 1</p>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>ReadView</p>\n<ul>\n<li>m_ids = [100200]</li>\n<li>min_trx_id = 100 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_idm_idstrx_id=100m_ids</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p><strong></strong></p>\n<pre class=\" language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>dept<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">12</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> dept<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><strong>1</strong></p>\n<table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>begin</td>\n<td>begin</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into dept(name) values ()</td>\n</tr>\n<tr>\n<td></td>\n<td>commit</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td>commit</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>\n<p><strong>2</strong></p>\n<table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>begin</td>\n<td>begin</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into dept(name) values ()</td>\n</tr>\n<tr>\n<td></td>\n<td>commit</td>\n</tr>\n<tr>\n<td>update dept set name = </td>\n<td></td>\n</tr>\n<tr>\n<td>commit</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>\n<p><strong>?</strong> RRMVCCUpdate</p>\n<p><strong></strong></p>\n<p></p>\n<ul>\n<li></li>\n<li>MVCC+next-key locksnext-key locksrecord locks()  gap locks()</li>\n</ul>\n<p>next-key locks(gap)REPEATABLE READgap locknextkey lock</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MVCC READ COMMITTD  REPEATABLE READ SEELCT  -  - </li>\n<li>MVCCundo</li>\n<li></li>\n<li></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<pre><code class=\"sql\">CREATE    TABLE hero(\n       number    INT,\n       name    VARCHAR(100),\n       country    varchar(100),\n       PRIMARY    KEY    (number)\n)    Engine=InnoDB    CHARSET=utf8;\nINSERT INTO    hero VALUES(1,    &#39;&#39;,&#39;cn&#39;);</code></pre>\n<p>MySQL/MySQLSession<font color=\"red\"></font></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p><font color=\"red\">()</font></p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin;</td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit;</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>rollback;</td>\n</tr>\n</tbody></table>\n<p>BAAB<font color=\"red\">A</font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin;</td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>UPDAE hero SET name =  WHERE number = 1;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero = 1;</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit;</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>rollback;</td>\n</tr>\n</tbody></table>\n<p>A4name=BA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>begin;<br>UPDAE hero SET name =  WHERE number = 1;<br>commit;</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>begin;<br>UPDAE hero SET name =  WHERE number = 1;<br>commit;</td>\n</tr>\n<tr>\n<td>6</td>\n<td>SELECT * FROM hero WHERE hero = 1;<br>()</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Session A</th>\n<th>Session B</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin;</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>SELECT * FROM hero WHERE hero &gt; 0;<br>()</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td></td>\n<td>INSERT INTO hero VALUE(2,,cn)</td>\n</tr>\n<tr>\n<td>4</td>\n<td>SELECT * FROM hero WHERE hero &gt; 0;<br>()</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"()\"></a>()</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>4 </p>\n<p>MySQL44<font color=\"red\"></font></p>\n<ul>\n<li>READ UNCOMMITTED<font color=\"blue\"></font></li>\n<li>READ COMMITTED<font color=\"blue\"></font></li>\n<li>REPEATABLE READ<font color=\"blue\"></font></li>\n<li>SERIALIZABLE<font color=\"blue\"></font></li>\n</ul>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>READ UNCOMMITTED</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>READ COMMITTED</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>REPEATABLE READ</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>SERIALIZABLE</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>READ UNCOMMITTED   </li>\n<li>READ COMMITTED </li>\n<li>REPEATABLE READ </li>\n<li>SERIALIZABLE </li>\n</ul>\n<p><strong></strong>number = 1number = 1</p>\n<ul>\n<li></li>\n<li></li>\n<li><font color=\"red\"></font></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>MVCC()<font color=\"red\">UndoMVCCMySQLIDID</font></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>InnoDB</p>\n<ul>\n<li>trx_id  ID</li>\n<li>roll_pointer undo</li>\n</ul>\n<p>(<strong>ID=80</strong>)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>trx_id = 100</th>\n<th>trx_id = 200</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>begin</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>begin</td>\n</tr>\n<tr>\n<td>3</td>\n<td>update hexo set name =  where number = 1</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>update hexo set name =  where number = 1</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>commit</td>\n<td></td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>update hexo set name =  where number = 1</td>\n</tr>\n<tr>\n<td>7</td>\n<td></td>\n<td>update hexo set name =  where number = 1</td>\n</tr>\n<tr>\n<td>8</td>\n<td></td>\n<td>commit</td>\n</tr>\n</tbody></table>\n<p><strong> : ? InnoDB(<font color=\"red\"></font>)</strong></p>\n<p></p>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>undoroll_pointer<font color=\"red\"></font></p>\n<p><strong>READ UNCOMMITTEDSERIALIZABLE</strong></p>\n<p><strong></strong>InnoDB</p>\n<h5 id=\"ReadView\"><a href=\"#ReadView\" class=\"headerlink\" title=\"ReadView\"></a>ReadView</h5><p>READ COMMITTEDREPEATABLE READ<font color=\"red\"></font>ReadViewReadView4</p>\n<ul>\n<li>m_idsReadViewid </li>\n<li>min_trx_idReadViewidm_ids</li>\n<li>max_trx_idReadViewid</li>\n<li>creator_trx_idReadViewid</li>\n</ul>\n<p><strong>INSERTDELETEUPDATEidid0</strong></p>\n<p>ReadView</p>\n<ul>\n<li>trx_idReadViewcreator_trx_id<font color=\"red\"></font></li>\n<li>trx_idmin_trx_id<font color=\"red\"></font></li>\n<li>trx_idmax_trx_id<font color=\"red\"></font></li>\n<li>min_trx_idmax_trx_idtrx_idm_ids<ul>\n<li><font color=\"green\">ReadView</font></li>\n<li><font color=\"green\">ReadView</font></li>\n</ul>\n</li>\n</ul>\n<p></p>\n<p><strong>READ COMMITTEDREPEATABLE READ</strong></p>\n<ul>\n<li><font color=\"blue\"></font></li>\n<li><font color=\"blue\"></font></li>\n</ul>\n<p>MREAD COMMITTEDREPEATABLE READReadView</p>\n<p><strong>READ COMMITTED  ReadView</strong></p>\n<p><strong>1</strong>100200number=1</p>\n<pre><code class=\"sql\">SELECT * FROM hero WHERE number = 1;</code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/2.png\" alt></p>\n<p>ReadViewReadView</p>\n<ul>\n<li>m_ids = [100,200]</li>\n<li>min_trx_id = 100</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0 ID0</li>\n</ul>\n<p>trx_id=100m_Idstrx_id=80m_ids</p>\n<p><strong>2</strong>1002001</p>\n<pre><code class=\"sql\">SELECT * FROM hero WHERE number = 1;</code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>ReadViewReadView</p>\n<ul>\n<li>m_ids = [200]100200</li>\n<li>min_trx_id = 200 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_id = 200m_idstrx_id=100m_ids</p>\n<p><strong>REPEATABLE READ  ReadView</strong></p>\n<p><strong>1</strong>100200100200number=1300</p>\n<pre><code class=\"sql\">SELECT * FROM hero WHERE number = 1;</code></pre>\n<p><img src=\"/2020/08/30/mysql-mvcc/2.png\" alt=\"\"></p>\n<p>ReadView</p>\n<ul>\n<li>m_ids = [100200]</li>\n<li>min_trx_id = 100 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_id = 100 , m_ids</p>\n<p><strong>2</strong>1002001300number = 1</p>\n<p><img src=\"/2020/08/30/mysql-mvcc/1.png\" alt></p>\n<p>ReadView</p>\n<ul>\n<li>m_ids = [100200]</li>\n<li>min_trx_id = 100 (ID)</li>\n<li>max_trx_id = 201</li>\n<li>creator_trx_id = 0ID0</li>\n</ul>\n<p>trx_idm_idstrx_id=100m_ids</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p><strong></strong></p>\n<pre><code class=\"sql\">CREATE TABLE `dept` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `name` varchar(20) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8\ninsert into dept(name) values(&quot;&quot;);</code></pre>\n<p><strong>1</strong></p>\n<table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>begin</td>\n<td>begin</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into dept(name) values ()</td>\n</tr>\n<tr>\n<td></td>\n<td>commit</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td>commit</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>\n<p><strong>2</strong></p>\n<table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>begin</td>\n<td>begin</td>\n</tr>\n<tr>\n<td>select * from dept</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>insert into dept(name) values ()</td>\n</tr>\n<tr>\n<td></td>\n<td>commit</td>\n</tr>\n<tr>\n<td>update dept set name = </td>\n<td></td>\n</tr>\n<tr>\n<td>commit</td>\n<td></td>\n</tr>\n</tbody></table>\n<p></p>\n<p><strong>?</strong> RRMVCCUpdate</p>\n<p><strong></strong></p>\n<p></p>\n<ul>\n<li></li>\n<li>MVCC+next-key locksnext-key locksrecord locks()  gap locks()</li>\n</ul>\n<p>next-key locks(gap)REPEATABLE READgap locknextkey lock</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>MVCC READ COMMITTD  REPEATABLE READ SEELCT  -  - </li>\n<li>MVCCundo</li>\n<li></li>\n<li></li>\n</ul>"},{"title":"Redis5.0","description":"Redis5.0","date":"2020-09-01T07:46:34.000Z","_content":"\n## \n\nredis<font color=red></font>\n\n- RedisKEY **** KEY\n- Redissentinel****\n- (1000)\n- Redis0 -163832^4 * 2^10\n\n![RedisCluster](redis-cluster-build/1.png)\n<!--more-->\nredismastermastersalve\n- master\n- masterredis\n\n## Redis5.0\n\n### Redis\n + 3 985198529853\n\n![Redis](redis-cluster-build/2.png)\n\nRedisredis\n\n```shell\n#\nrpm -qa|grep redis #redis\nrpm -e redis-3.0.7.ws4-1.el6.x86_64 redis\n## \ncd /usr/local/src/\ntar -zxvf redis-5.0.7.tar.gz\ncd redis-5.0.7/\nmake\nmake install\n```\n### Redis\n9851~98566Redis\n\n![](redis-cluster-build/3.png)\n\nredis.conf****redis\n```shell\n#\ndaemonize yes\n#redisPID\npidfile \"/etc/redis/9851/redis.pid\"\n#\nport 9851\n#\nlogfile \"/etc/redis/9851/redis.log\"\n#dump aof\ndir \"/etc/redis/9851\"\ndatabases 16\n#rdb\nsave 900 1\nrepl-backlog-size 64mb\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename \"dump.rdb\"\n#\ncluster-enabled yes\n#\ncluster-config-file node.conf\n# timeout  ()\ncluster-node-timeout 15000\n```\n### Redis\n6Redis6\n\n```shell\nredis-server /etc/redis/9851/redis.conf\nredis-server /etc/redis/9852/redis.conf\nredis-server /etc/redis/9853/redis.conf\nredis-server /etc/redis/9854/redis.conf\nredis-server /etc/redis/9855/redis.conf\nredis-server /etc/redis/9856/redis.conf\n```\n\n![](redis-cluster-build/4.png)\n\n### \n\nRedisRedis--cluster\n\n```shell\nredis-cli --cluster create 10.8.198.152:9851 10.8.198.152:9852 10.8.198.152:9853 10.8.198.152:9854 10.8.198.152:9855 10.8.198.152:9856 --cluster-replicas 1\n```\n\n![](redis-cluster-build/5.png)\n\nMasterSlave****'YES'\n\n<font color=red>Redis</font>\n\n\n\n**redis-cli --cluster check IP:PORT**\n\n\n\n![](redis-cluster-build/7.png)\n\n**cluster slots**\n\n\n\n- 0 ~ 5460 98519854\n- 5461 ~ 10922 98529855\n- 10923 ~ 16383 98539856\n\n![](redis-cluster-build/6.png)\n\n**key**\n\n```java\nredisTemplate.opsForValue().set(\"name\",\"myLive\");\n```\n\n![](redis-cluster-build/8.png)\n\n\n\n**9852**\n\n9852\n\n```shell\n[root@Slave3 redis]# kill -9 PID(9852PID)\n```\n\n![9855master](redis-cluster-build/9.png)\n\n9852\n\n![98529855](redis-cluster-build/10.png)","source":"_posts/redis-cluster-build.md","raw":"---\ntitle: Redis5.0\ntags:\n  - redis\ncategories: redis\ndescription : Redis5.0\ndate: 2020-09-01 15:46:34\n---\n\n## \n\nredis<font color=red></font>\n\n- RedisKEY **** KEY\n- Redissentinel****\n- (1000)\n- Redis0 -163832^4 * 2^10\n\n![RedisCluster](redis-cluster-build/1.png)\n<!--more-->\nredismastermastersalve\n- master\n- masterredis\n\n## Redis5.0\n\n### Redis\n + 3 985198529853\n\n![Redis](redis-cluster-build/2.png)\n\nRedisredis\n\n```shell\n#\nrpm -qa|grep redis #redis\nrpm -e redis-3.0.7.ws4-1.el6.x86_64 redis\n## \ncd /usr/local/src/\ntar -zxvf redis-5.0.7.tar.gz\ncd redis-5.0.7/\nmake\nmake install\n```\n### Redis\n9851~98566Redis\n\n![](redis-cluster-build/3.png)\n\nredis.conf****redis\n```shell\n#\ndaemonize yes\n#redisPID\npidfile \"/etc/redis/9851/redis.pid\"\n#\nport 9851\n#\nlogfile \"/etc/redis/9851/redis.log\"\n#dump aof\ndir \"/etc/redis/9851\"\ndatabases 16\n#rdb\nsave 900 1\nrepl-backlog-size 64mb\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename \"dump.rdb\"\n#\ncluster-enabled yes\n#\ncluster-config-file node.conf\n# timeout  ()\ncluster-node-timeout 15000\n```\n### Redis\n6Redis6\n\n```shell\nredis-server /etc/redis/9851/redis.conf\nredis-server /etc/redis/9852/redis.conf\nredis-server /etc/redis/9853/redis.conf\nredis-server /etc/redis/9854/redis.conf\nredis-server /etc/redis/9855/redis.conf\nredis-server /etc/redis/9856/redis.conf\n```\n\n![](redis-cluster-build/4.png)\n\n### \n\nRedisRedis--cluster\n\n```shell\nredis-cli --cluster create 10.8.198.152:9851 10.8.198.152:9852 10.8.198.152:9853 10.8.198.152:9854 10.8.198.152:9855 10.8.198.152:9856 --cluster-replicas 1\n```\n\n![](redis-cluster-build/5.png)\n\nMasterSlave****'YES'\n\n<font color=red>Redis</font>\n\n\n\n**redis-cli --cluster check IP:PORT**\n\n\n\n![](redis-cluster-build/7.png)\n\n**cluster slots**\n\n\n\n- 0 ~ 5460 98519854\n- 5461 ~ 10922 98529855\n- 10923 ~ 16383 98539856\n\n![](redis-cluster-build/6.png)\n\n**key**\n\n```java\nredisTemplate.opsForValue().set(\"name\",\"myLive\");\n```\n\n![](redis-cluster-build/8.png)\n\n\n\n**9852**\n\n9852\n\n```shell\n[root@Slave3 redis]# kill -9 PID(9852PID)\n```\n\n![9855master](redis-cluster-build/9.png)\n\n9852\n\n![98529855](redis-cluster-build/10.png)","slug":"redis-cluster-build","published":1,"updated":"2021-04-08T00:47:06.937Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvi002gqwv259jp3j0j","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>redis<font color=\"red\"></font></p>\n<ul>\n<li>RedisKEY <strong></strong> KEY</li>\n<li>Redissentinel<strong></strong></li>\n<li>(1000)</li>\n<li>Redis0 -163832^4 * 2^10</li>\n</ul>\n<p><img src=\"/2020/09/01/redis-cluster-build/1.png\" alt=\"RedisCluster\"></p>\n<a id=\"more\"></a>\n<p>redismastermastersalve</p>\n<ul>\n<li>master</li>\n<li>masterredis</li>\n</ul>\n<h2 id=\"Redis5-0\"><a href=\"#Redis5-0\" class=\"headerlink\" title=\"Redis5.0\"></a>Redis5.0</h2><h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p> + 3 985198529853</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/2.png\" alt=\"Redis\"></p>\n<p>Redisredis</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#\nrpm -qa|grep redis #redis\nrpm -e redis-3.0.7.ws4-1.el6.x86_64 redis\n## \ncd /usr/local/src/\ntar -zxvf redis-5.0.7.tar.gz\ncd redis-5.0.7/\nmake\nmake install</code></pre>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>9851~98566Redis</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/3.png\" alt></p>\n<p>redis.conf<strong></strong>redis</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#\ndaemonize yes\n#redisPID\npidfile \"/etc/redis/9851/redis.pid\"\n#\nport 9851\n#\nlogfile \"/etc/redis/9851/redis.log\"\n#dump aof\ndir \"/etc/redis/9851\"\ndatabases 16\n#rdb\nsave 900 1\nrepl-backlog-size 64mb\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename \"dump.rdb\"\n#\ncluster-enabled yes\n#\ncluster-config-file node.conf\n# timeout  ()\ncluster-node-timeout 15000</code></pre>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>6Redis6</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-server /etc/redis/9851/redis.conf\nredis-server /etc/redis/9852/redis.conf\nredis-server /etc/redis/9853/redis.conf\nredis-server /etc/redis/9854/redis.conf\nredis-server /etc/redis/9855/redis.conf\nredis-server /etc/redis/9856/redis.conf</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/4.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>RedisRediscluster</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-cli --cluster create 10.8.198.152:9851 10.8.198.152:9852 10.8.198.152:9853 10.8.198.152:9854 10.8.198.152:9855 10.8.198.152:9856 --cluster-replicas 1</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/5.png\" alt></p>\n<p>MasterSlave<strong></strong>YES</p>\n<p><font color=\"red\">Redis</font></p>\n<p></p>\n<p><strong>redis-cli cluster check IP:PORT</strong></p>\n<p></p>\n<p><img src=\"/2020/09/01/redis-cluster-build/7.png\" alt></p>\n<p><strong>cluster slots</strong></p>\n<p></p>\n<ul>\n<li>0 ~ 5460 98519854</li>\n<li>5461 ~ 10922 98529855</li>\n<li>10923 ~ 16383 98539856</li>\n</ul>\n<p><img src=\"/2020/09/01/redis-cluster-build/6.png\" alt></p>\n<p><strong>key</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\">redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"myLive\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/8.png\" alt></p>\n<p></p>\n<p><strong>9852</strong></p>\n<p>9852</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@Slave3 redis]# kill -9 PID(9852PID)</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/9.png\" alt=\"9855master\"></p>\n<p>9852</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/10.png\" alt=\"98529855\"></p>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>redis<font color=\"red\"></font></p>\n<ul>\n<li>RedisKEY <strong></strong> KEY</li>\n<li>Redissentinel<strong></strong></li>\n<li>(1000)</li>\n<li>Redis0 -163832^4 * 2^10</li>\n</ul>\n<p><img src=\"/2020/09/01/redis-cluster-build/1.png\" alt=\"RedisCluster\"></p>","more":"<p>redismastermastersalve</p>\n<ul>\n<li>master</li>\n<li>masterredis</li>\n</ul>\n<h2 id=\"Redis5-0\"><a href=\"#Redis5-0\" class=\"headerlink\" title=\"Redis5.0\"></a>Redis5.0</h2><h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p> + 3 985198529853</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/2.png\" alt=\"Redis\"></p>\n<p>Redisredis</p>\n<pre><code class=\"shell\">#\nrpm -qa|grep redis #redis\nrpm -e redis-3.0.7.ws4-1.el6.x86_64 redis\n## \ncd /usr/local/src/\ntar -zxvf redis-5.0.7.tar.gz\ncd redis-5.0.7/\nmake\nmake install</code></pre>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>9851~98566Redis</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/3.png\" alt></p>\n<p>redis.conf<strong></strong>redis</p>\n<pre><code class=\"shell\">#\ndaemonize yes\n#redisPID\npidfile &quot;/etc/redis/9851/redis.pid&quot;\n#\nport 9851\n#\nlogfile &quot;/etc/redis/9851/redis.log&quot;\n#dump aof\ndir &quot;/etc/redis/9851&quot;\ndatabases 16\n#rdb\nsave 900 1\nrepl-backlog-size 64mb\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename &quot;dump.rdb&quot;\n#\ncluster-enabled yes\n#\ncluster-config-file node.conf\n# timeout  ()\ncluster-node-timeout 15000</code></pre>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>6Redis6</p>\n<pre><code class=\"shell\">redis-server /etc/redis/9851/redis.conf\nredis-server /etc/redis/9852/redis.conf\nredis-server /etc/redis/9853/redis.conf\nredis-server /etc/redis/9854/redis.conf\nredis-server /etc/redis/9855/redis.conf\nredis-server /etc/redis/9856/redis.conf</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/4.png\" alt></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>RedisRediscluster</p>\n<pre><code class=\"shell\">redis-cli --cluster create 10.8.198.152:9851 10.8.198.152:9852 10.8.198.152:9853 10.8.198.152:9854 10.8.198.152:9855 10.8.198.152:9856 --cluster-replicas 1</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/5.png\" alt></p>\n<p>MasterSlave<strong></strong>YES</p>\n<p><font color=\"red\">Redis</font></p>\n<p></p>\n<p><strong>redis-cli cluster check IP:PORT</strong></p>\n<p></p>\n<p><img src=\"/2020/09/01/redis-cluster-build/7.png\" alt></p>\n<p><strong>cluster slots</strong></p>\n<p></p>\n<ul>\n<li>0 ~ 5460 98519854</li>\n<li>5461 ~ 10922 98529855</li>\n<li>10923 ~ 16383 98539856</li>\n</ul>\n<p><img src=\"/2020/09/01/redis-cluster-build/6.png\" alt></p>\n<p><strong>key</strong></p>\n<pre><code class=\"java\">redisTemplate.opsForValue().set(&quot;name&quot;,&quot;myLive&quot;);</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/8.png\" alt></p>\n<p></p>\n<p><strong>9852</strong></p>\n<p>9852</p>\n<pre><code class=\"shell\">[root@Slave3 redis]# kill -9 PID(9852PID)</code></pre>\n<p><img src=\"/2020/09/01/redis-cluster-build/9.png\" alt=\"9855master\"></p>\n<p>9852</p>\n<p><img src=\"/2020/09/01/redis-cluster-build/10.png\" alt=\"98529855\"></p>"},{"title":"springBoot-aopredis","description":"springBoot+redis+aop+","date":"2019-02-18T09:14:00.000Z","_content":"## \n### \napi-urlredis-keyurlkeyredis\n<!--more-->\naop+controlleraop**@RateLimiter**\n### \n\n```java\n//testoneurl105\n@RequestMapping(\"/testone\")\n@RateLimiter(key = \"ratelimit:testOne\", limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return \"\";\n}\n```\n\n105\n\n```json\n{\"code\":\"400\",\"msg\":\"FAIL\",\"desc\":\"\"}\n```\n\n## \n\n### MAVEN\n```xml\n<dependencies>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\n\t\t<!--aop-->\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-aop</artifactId>\n\t\t</dependency>\n\t\t<!--redis-->\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-data-redis</artifactId>\n\t\t</dependency>\n\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-devtools</artifactId>\n\t\t\t<scope>runtime</scope>\n\t\t\t<optional>true</optional>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-test</artifactId>\n\t\t\t<scope>test</scope>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.apache.commons</groupId>\n\t\t\t<artifactId>commons-pool2</artifactId>\n\t\t\t<version>2.6.0</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.apache.commons</groupId>\n\t\t\t<artifactId>commons-lang3</artifactId>\n\t\t\t<version>3.7</version>\n\t\t</dependency>\n\n\t\t<dependency>\n\t\t\t<groupId>com.google.guava</groupId>\n\t\t\t<artifactId>guava</artifactId>\n\t\t\t<version>26.0-jre</version>\n\t\t</dependency>\n\n\t</dependencies>\n````\n\n### SpringBoot\n\n```yaml\nspring:\n  redis:\n    database: 0\n    host: 127.0.0.1\n    jedis:\n      pool:\n        #, 0 \n        max-active: 8\n        #, 0 \n        max-idle: 8\n        #-1\n        max-wait: -1ms\n        #, 0 \n        min-idle: 0\n    lettuce:\n      pool:\n        max-active: 8\n        max-idle: 8\n        max-wait: -1ms\n        min-idle: 0\n      shutdown-timeout: 100ms\n    password: ''\n    port: 6379\n```\n\n### \n#### \n\n```java\npackage com.xzy.springbootredisdemo.annotation;\n\nimport java.lang.annotation.*;\n\n/***\n * \n * key--::ip::\n * limit--\n * expire--incr\n * isLimiterIp -- IPtruekeyratelimit:url:ipip\n */\n@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface RateLimiter {\n    /**\n     * key\n     * @return\n     */\n    String key() default \"rate:limiter\";\n    /**\n     * \n     * @return\n     */\n    long limit() default 10;\n    /**\n     * \n     * @return\n     */\n    long expire() default 1;\n    String message() default \"\";\n    /***\n     * ip\n     * * @return\n     */\n    boolean isLimiterIp() default false;\n}\n\n```\n#### Redis\n\n```java\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.cache.CacheManager;\nimport org.springframework.cache.annotation.CachingConfigurerSupport;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.RedisSerializer;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;\n@Configuration\n@EnableCaching\npublic class RedisCacheConfig extends CachingConfigurerSupport {\n    private static final Logger logger = LoggerFactory.getLogger(RedisCacheConfig.class);\n    @Bean\n    public CacheManager cacheManager(RedisConnectionFactory factory) {\n        RedisSerializer<String> redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        //\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        // ,30\n        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()\n                .entryTtl(Duration.ofSeconds(30))\n                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))\n                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))\n                .disableCachingNullValues();\n        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)\n                .cacheDefaults(config)\n                .build();\n        return cacheManager;\n    }\n    @Bean\n    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {\n        RedisTemplate<String, Object> template = new RedisTemplate<>();\n        RedisSerializer<String> redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        template.setConnectionFactory(factory);\n        //key\n        template.setKeySerializer(redisSerializer);\n        //value\n        template.setValueSerializer(jackson2JsonRedisSerializer);\n        //value hashmap\n        template.setHashValueSerializer(jackson2JsonRedisSerializer);\n        return template;\n    }\n}\n```\n\n#### AOP\n\n@RateLimiter\n\n```java\nimport com.google.common.base.Preconditions;\nimport com.google.common.collect.Lists;\nimport com.google.common.collect.Maps;\nimport com.xzy.springbootredisdemo.annotation.RateLimiter;\nimport com.xzy.springbootredisdemo.util.IpUtil;\nimport com.xzy.springbootredisdemo.util.ResultVo;\nimport org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.Signature;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.scripting.support.ResourceScriptSource;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.PostConstruct;\nimport javax.servlet.http.HttpServletRequest;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Type;\nimport java.util.List;\nimport java.util.Map;\n\n//aop\n@Aspect\n@Component\npublic class RateLimterHandler {\n    private static final Logger logger = LoggerFactory.getLogger(RateLimterHandler.class);\n\n    @Autowired\n    private RedisTemplate redisTemplate;\n    \n    private DefaultRedisScript<Long> redisScript;\n\n    //@PostConstructServletSercletinti()\n    @PostConstruct\n    public void init() {\n        redisScript = new DefaultRedisScript<>();\n        redisScript.setResultType(Long.class);\n        redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(\"rateLimter.lua\")));\n        logger.info(\"RateLimterHandler[]\");\n    }\n\n    //RateLimiterrateLimiter\n    @Pointcut(\"@annotation(com.xzy.springbootredisdemo.annotation.RateLimiter)\")\n    public void rateLimiter() {\n    }\n\n    @Around(\"@annotation(rateLimiter)\")\n    public Object around(ProceedingJoinPoint proceedingJoinPoint, RateLimiter rateLimiter) throws Throwable {\n        Signature signature = proceedingJoinPoint.getSignature();\n        if (!(signature instanceof MethodSignature)) {\n            throw new IllegalArgumentException(\"\");\n        }\n        //\n        HttpServletRequest request = getArgsRequest(proceedingJoinPoint);\n        //\n        // key\n        String limitKey = rateLimiter.key();\n        Preconditions.checkNotNull(limitKey); //\n        //ip\n        boolean isLimiterIp = rateLimiter.isLimiterIp();\n        if (isLimiterIp && request != null) {\n            if (request != null) {\n                String ip = IpUtil.getIpAddr(request);\n                limitKey += \":\" + ip;\n            }\n        }\n        //\n        long limitTimes = rateLimiter.limit();\n        // \n        long expireTime = rateLimiter.expire();\n        if (logger.isDebugEnabled()) {\n            logger.debug(\"RateLimterHandler[]-limitTimes={},limitTimeout={}\", limitTimes, expireTime);\n        }\n        //\n        String message = rateLimiter.message();\n        //lua\n        List<String> keyList = Lists.newArrayList();\n        keyList.add(limitKey);\n        Long result = (Long) redisTemplate.execute(redisScript, keyList, expireTime, limitTimes);\n        if (result == 0) {\n            Type type = getMethodReturnType(proceedingJoinPoint);\n            logger.info(\"=\" + expireTime + \"-=\" + limitTimes + \"[]\");\n            return limitErrorReturn(type, message);\n        }\n        return proceedingJoinPoint.proceed();\n    }\n\n\n    public Object limitErrorReturn(Type type, String msg) {\n        switch (type.getTypeName()) {\n            case \"java.lang.String\":\n                return msg;\n            case \"java.util.Map\":\n                Map<String, String> resultMap = Maps.newHashMap();\n                resultMap.put(\"code\", \"-1\");\n                resultMap.put(\"message\", msg);\n                return resultMap;\n            case \"com.xzy.springbootredisdemo.util.ResultVo\":\n                return ResultVo.getErrorResultVo(msg);\n            default:\n                return msg;\n        }\n    }\n\n\n    public HttpServletRequest getArgsRequest(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        //\n        Object[] args = proceedingJoinPoint.getArgs();\n        HttpServletRequest request = null;\n        for (Object o : args) {\n            if (o instanceof HttpServletRequest) {\n                request = (HttpServletRequest) o;\n            }\n        }\n        return request;\n    }\n\n    /***\n     * \n     * @param proceedingJoinPoint\n     * @return\n     * @throws NoSuchMethodException\n     */\n    public Type getMethodReturnType(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        Signature signature = proceedingJoinPoint.getSignature();\n        MethodSignature methodSignature = (MethodSignature) signature;\n        Object target = proceedingJoinPoint.getTarget();\n        Method currentMethod = target.getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());\n        return currentMethod.getAnnotatedReturnType().getType();\n    }\n\n}\n\n```\n\n#### \n\n```java\npublic interface BaseEnum {\n    public String getCode();\n    public String getMsg();\n}\npublic enum SystemResultEnum implements BaseEnum {\n    SUCCESS(\"1\", \"\"),\n    FAIL(\"0\", \"\"),\n    NO_AUTH_USER(\"2\", \"\"),\n    NO_AD_USER(\"3\", \"\");\n    SystemResultEnum(String code, String msg) {\n        this.code = code;\n        this.msg = msg;\n    }\n    private String code;\n    private String msg;\n    public String getCode() {\n        return code;\n    }\n    public void setCode(String code) {\n        this.code = code;\n    }\n    public String getMsg() {\n        return msg;\n    }\n    public void setMsg(String msg) {\n        this.msg = msg;\n    }\n}\n```\n\n#### Lua\n\n```lua\n-- KEY\nlocal key1 = KEYS[1]\n-- incrkey1\nlocal val = redis.call('incr', key1)\n-- key1\nlocal ttl = redis.call('ttl',key1)\n\n--ARGV\n-- ARGV[1]\nlocal expire = ARGV[1]\n-- ARGV[2]\nlocal times = ARGV[2]\n\n--  \n-- redis.log(redis.LOG_DEBUG,tostring(times))\n-- redis.log(redis.LOG_DEBUG,tostring(expire))\n-- redis.log(redis.LOG_NOTICE, \"incr \"..key1..\" \"..val);\n-- val == 1 \nif val == 1 then\n    redis.call('expire',key1,tonumber(expire))\nelse\n    if ttl == -1 then\n        redis.call('expire',key1,tonumber(expire))\n    end\nend\n\nif val > tonumber(times) then\n    return 0\nend\n    return 1\n```\n\n\n\n#### \n\n```java\n@RestController\npublic class TestController {\n    private static final String MESSAGE = \"{\\\"code\\\":\\\"400\\\",\\\"msg\\\":\\\"FAIL\\\",\\\"desc\\\":\\\"\\\"}\";\n\n    @RequestMapping(\"/testone\")\n    @RateLimiter(key = \"ratelimit:testOne\", limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return \"\";\n    }\n    @RequestMapping(\"/testtwo\")\n    @RateLimiter(key = \"ratelimit:testTwo\", limit = 5, expire = 10, isLimiterIp = false)\n    public Map testTow(HttpServletRequest request){\n        Map<String,String> resultMap = Maps.newHashMap();\n        resultMap.put(\"code\", \"1\");\n        resultMap.put(\"message\" , \"success\");\n        return resultMap;\n    }\n    @RequestMapping(\"/testthree\")\n    @RateLimiter(key = \"ratelimit:testThree\", limit = 5, expire = 10, isLimiterIp = false)\n    public ResultVo testThree(HttpServletRequest request){\n        return ResultVo.getSuccessResultVo();\n    }\n}\n```","source":"_posts/redis-aop-limit-boot.md","raw":"---\ntitle: springBoot-aopredis\ntags:\n  - redis\n  - \ncategories: redis\ndescription : springBoot+redis+aop+\ndate: 2019-02-18 17:14:00\n---\n## \n### \napi-urlredis-keyurlkeyredis\n<!--more-->\naop+controlleraop**@RateLimiter**\n### \n\n```java\n//testoneurl105\n@RequestMapping(\"/testone\")\n@RateLimiter(key = \"ratelimit:testOne\", limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return \"\";\n}\n```\n\n105\n\n```json\n{\"code\":\"400\",\"msg\":\"FAIL\",\"desc\":\"\"}\n```\n\n## \n\n### MAVEN\n```xml\n<dependencies>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\n\t\t<!--aop-->\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-aop</artifactId>\n\t\t</dependency>\n\t\t<!--redis-->\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-data-redis</artifactId>\n\t\t</dependency>\n\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-devtools</artifactId>\n\t\t\t<scope>runtime</scope>\n\t\t\t<optional>true</optional>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-test</artifactId>\n\t\t\t<scope>test</scope>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.apache.commons</groupId>\n\t\t\t<artifactId>commons-pool2</artifactId>\n\t\t\t<version>2.6.0</version>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.apache.commons</groupId>\n\t\t\t<artifactId>commons-lang3</artifactId>\n\t\t\t<version>3.7</version>\n\t\t</dependency>\n\n\t\t<dependency>\n\t\t\t<groupId>com.google.guava</groupId>\n\t\t\t<artifactId>guava</artifactId>\n\t\t\t<version>26.0-jre</version>\n\t\t</dependency>\n\n\t</dependencies>\n````\n\n### SpringBoot\n\n```yaml\nspring:\n  redis:\n    database: 0\n    host: 127.0.0.1\n    jedis:\n      pool:\n        #, 0 \n        max-active: 8\n        #, 0 \n        max-idle: 8\n        #-1\n        max-wait: -1ms\n        #, 0 \n        min-idle: 0\n    lettuce:\n      pool:\n        max-active: 8\n        max-idle: 8\n        max-wait: -1ms\n        min-idle: 0\n      shutdown-timeout: 100ms\n    password: ''\n    port: 6379\n```\n\n### \n#### \n\n```java\npackage com.xzy.springbootredisdemo.annotation;\n\nimport java.lang.annotation.*;\n\n/***\n * \n * key--::ip::\n * limit--\n * expire--incr\n * isLimiterIp -- IPtruekeyratelimit:url:ipip\n */\n@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface RateLimiter {\n    /**\n     * key\n     * @return\n     */\n    String key() default \"rate:limiter\";\n    /**\n     * \n     * @return\n     */\n    long limit() default 10;\n    /**\n     * \n     * @return\n     */\n    long expire() default 1;\n    String message() default \"\";\n    /***\n     * ip\n     * * @return\n     */\n    boolean isLimiterIp() default false;\n}\n\n```\n#### Redis\n\n```java\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.cache.CacheManager;\nimport org.springframework.cache.annotation.CachingConfigurerSupport;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.RedisSerializer;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;\n@Configuration\n@EnableCaching\npublic class RedisCacheConfig extends CachingConfigurerSupport {\n    private static final Logger logger = LoggerFactory.getLogger(RedisCacheConfig.class);\n    @Bean\n    public CacheManager cacheManager(RedisConnectionFactory factory) {\n        RedisSerializer<String> redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        //\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        // ,30\n        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()\n                .entryTtl(Duration.ofSeconds(30))\n                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))\n                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))\n                .disableCachingNullValues();\n        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)\n                .cacheDefaults(config)\n                .build();\n        return cacheManager;\n    }\n    @Bean\n    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {\n        RedisTemplate<String, Object> template = new RedisTemplate<>();\n        RedisSerializer<String> redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        template.setConnectionFactory(factory);\n        //key\n        template.setKeySerializer(redisSerializer);\n        //value\n        template.setValueSerializer(jackson2JsonRedisSerializer);\n        //value hashmap\n        template.setHashValueSerializer(jackson2JsonRedisSerializer);\n        return template;\n    }\n}\n```\n\n#### AOP\n\n@RateLimiter\n\n```java\nimport com.google.common.base.Preconditions;\nimport com.google.common.collect.Lists;\nimport com.google.common.collect.Maps;\nimport com.xzy.springbootredisdemo.annotation.RateLimiter;\nimport com.xzy.springbootredisdemo.util.IpUtil;\nimport com.xzy.springbootredisdemo.util.ResultVo;\nimport org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.Signature;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.scripting.support.ResourceScriptSource;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.PostConstruct;\nimport javax.servlet.http.HttpServletRequest;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Type;\nimport java.util.List;\nimport java.util.Map;\n\n//aop\n@Aspect\n@Component\npublic class RateLimterHandler {\n    private static final Logger logger = LoggerFactory.getLogger(RateLimterHandler.class);\n\n    @Autowired\n    private RedisTemplate redisTemplate;\n    \n    private DefaultRedisScript<Long> redisScript;\n\n    //@PostConstructServletSercletinti()\n    @PostConstruct\n    public void init() {\n        redisScript = new DefaultRedisScript<>();\n        redisScript.setResultType(Long.class);\n        redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(\"rateLimter.lua\")));\n        logger.info(\"RateLimterHandler[]\");\n    }\n\n    //RateLimiterrateLimiter\n    @Pointcut(\"@annotation(com.xzy.springbootredisdemo.annotation.RateLimiter)\")\n    public void rateLimiter() {\n    }\n\n    @Around(\"@annotation(rateLimiter)\")\n    public Object around(ProceedingJoinPoint proceedingJoinPoint, RateLimiter rateLimiter) throws Throwable {\n        Signature signature = proceedingJoinPoint.getSignature();\n        if (!(signature instanceof MethodSignature)) {\n            throw new IllegalArgumentException(\"\");\n        }\n        //\n        HttpServletRequest request = getArgsRequest(proceedingJoinPoint);\n        //\n        // key\n        String limitKey = rateLimiter.key();\n        Preconditions.checkNotNull(limitKey); //\n        //ip\n        boolean isLimiterIp = rateLimiter.isLimiterIp();\n        if (isLimiterIp && request != null) {\n            if (request != null) {\n                String ip = IpUtil.getIpAddr(request);\n                limitKey += \":\" + ip;\n            }\n        }\n        //\n        long limitTimes = rateLimiter.limit();\n        // \n        long expireTime = rateLimiter.expire();\n        if (logger.isDebugEnabled()) {\n            logger.debug(\"RateLimterHandler[]-limitTimes={},limitTimeout={}\", limitTimes, expireTime);\n        }\n        //\n        String message = rateLimiter.message();\n        //lua\n        List<String> keyList = Lists.newArrayList();\n        keyList.add(limitKey);\n        Long result = (Long) redisTemplate.execute(redisScript, keyList, expireTime, limitTimes);\n        if (result == 0) {\n            Type type = getMethodReturnType(proceedingJoinPoint);\n            logger.info(\"=\" + expireTime + \"-=\" + limitTimes + \"[]\");\n            return limitErrorReturn(type, message);\n        }\n        return proceedingJoinPoint.proceed();\n    }\n\n\n    public Object limitErrorReturn(Type type, String msg) {\n        switch (type.getTypeName()) {\n            case \"java.lang.String\":\n                return msg;\n            case \"java.util.Map\":\n                Map<String, String> resultMap = Maps.newHashMap();\n                resultMap.put(\"code\", \"-1\");\n                resultMap.put(\"message\", msg);\n                return resultMap;\n            case \"com.xzy.springbootredisdemo.util.ResultVo\":\n                return ResultVo.getErrorResultVo(msg);\n            default:\n                return msg;\n        }\n    }\n\n\n    public HttpServletRequest getArgsRequest(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        //\n        Object[] args = proceedingJoinPoint.getArgs();\n        HttpServletRequest request = null;\n        for (Object o : args) {\n            if (o instanceof HttpServletRequest) {\n                request = (HttpServletRequest) o;\n            }\n        }\n        return request;\n    }\n\n    /***\n     * \n     * @param proceedingJoinPoint\n     * @return\n     * @throws NoSuchMethodException\n     */\n    public Type getMethodReturnType(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        Signature signature = proceedingJoinPoint.getSignature();\n        MethodSignature methodSignature = (MethodSignature) signature;\n        Object target = proceedingJoinPoint.getTarget();\n        Method currentMethod = target.getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());\n        return currentMethod.getAnnotatedReturnType().getType();\n    }\n\n}\n\n```\n\n#### \n\n```java\npublic interface BaseEnum {\n    public String getCode();\n    public String getMsg();\n}\npublic enum SystemResultEnum implements BaseEnum {\n    SUCCESS(\"1\", \"\"),\n    FAIL(\"0\", \"\"),\n    NO_AUTH_USER(\"2\", \"\"),\n    NO_AD_USER(\"3\", \"\");\n    SystemResultEnum(String code, String msg) {\n        this.code = code;\n        this.msg = msg;\n    }\n    private String code;\n    private String msg;\n    public String getCode() {\n        return code;\n    }\n    public void setCode(String code) {\n        this.code = code;\n    }\n    public String getMsg() {\n        return msg;\n    }\n    public void setMsg(String msg) {\n        this.msg = msg;\n    }\n}\n```\n\n#### Lua\n\n```lua\n-- KEY\nlocal key1 = KEYS[1]\n-- incrkey1\nlocal val = redis.call('incr', key1)\n-- key1\nlocal ttl = redis.call('ttl',key1)\n\n--ARGV\n-- ARGV[1]\nlocal expire = ARGV[1]\n-- ARGV[2]\nlocal times = ARGV[2]\n\n--  \n-- redis.log(redis.LOG_DEBUG,tostring(times))\n-- redis.log(redis.LOG_DEBUG,tostring(expire))\n-- redis.log(redis.LOG_NOTICE, \"incr \"..key1..\" \"..val);\n-- val == 1 \nif val == 1 then\n    redis.call('expire',key1,tonumber(expire))\nelse\n    if ttl == -1 then\n        redis.call('expire',key1,tonumber(expire))\n    end\nend\n\nif val > tonumber(times) then\n    return 0\nend\n    return 1\n```\n\n\n\n#### \n\n```java\n@RestController\npublic class TestController {\n    private static final String MESSAGE = \"{\\\"code\\\":\\\"400\\\",\\\"msg\\\":\\\"FAIL\\\",\\\"desc\\\":\\\"\\\"}\";\n\n    @RequestMapping(\"/testone\")\n    @RateLimiter(key = \"ratelimit:testOne\", limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return \"\";\n    }\n    @RequestMapping(\"/testtwo\")\n    @RateLimiter(key = \"ratelimit:testTwo\", limit = 5, expire = 10, isLimiterIp = false)\n    public Map testTow(HttpServletRequest request){\n        Map<String,String> resultMap = Maps.newHashMap();\n        resultMap.put(\"code\", \"1\");\n        resultMap.put(\"message\" , \"success\");\n        return resultMap;\n    }\n    @RequestMapping(\"/testthree\")\n    @RateLimiter(key = \"ratelimit:testThree\", limit = 5, expire = 10, isLimiterIp = false)\n    public ResultVo testThree(HttpServletRequest request){\n        return ResultVo.getSuccessResultVo();\n    }\n}\n```","slug":"redis-aop-limit-boot","published":1,"updated":"2021-04-08T00:47:06.917Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvj002kqwv229tjfcf0","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>api-urlredis-keyurlkeyredis</p>\n<a id=\"more\"></a>\n<p>aop+controlleraop<strong>@RateLimiter</strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//testoneurl105</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/testone\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RateLimiter</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"ratelimit:testOne\"</span><span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> expire <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> message <span class=\"token operator\">=</span> MESSAGE<span class=\"token punctuation\">,</span> isLimiterIp <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">testOne</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>105</p>\n<pre class=\" language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"code\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"400\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"msg\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"FAIL\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"desc\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"MAVEN\"><a href=\"#MAVEN\" class=\"headerlink\" title=\"MAVEN\"></a>MAVEN</h3><pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-web<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token comment\" spellcheck=\"true\">&lt;!--aop--></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-aop<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\" spellcheck=\"true\">&lt;!--redis--></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-data-redis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-devtools<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">></span></span>runtime<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>optional</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>optional</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-test<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">></span></span>test<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.apache.commons<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>commons-pool2<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>2.6.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.apache.commons<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>commons-lang3<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.7<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.google.guava<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>guava<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>26.0-jre<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">></span></span></code></pre>\n<h3 id=\"SpringBoot\"><a href=\"#SpringBoot\" class=\"headerlink\" title=\"SpringBoot\"></a>SpringBoot</h3><pre class=\" language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 127.0.0.1\n    <span class=\"token key atrule\">jedis</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\" spellcheck=\"true\">#, 0 </span>\n        <span class=\"token key atrule\">max-active</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span>\n        <span class=\"token comment\" spellcheck=\"true\">#, 0 </span>\n        <span class=\"token key atrule\">max-idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span>\n        <span class=\"token comment\" spellcheck=\"true\">#-1</span>\n        <span class=\"token key atrule\">max-wait</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span>1ms\n        <span class=\"token comment\" spellcheck=\"true\">#, 0 </span>\n        <span class=\"token key atrule\">min-idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">lettuce</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-active</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span>\n        <span class=\"token key atrule\">max-idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span>\n        <span class=\"token key atrule\">max-wait</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span>1ms\n        <span class=\"token key atrule\">min-idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n      <span class=\"token key atrule\">shutdown-timeout</span><span class=\"token punctuation\">:</span> 100ms\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> com<span class=\"token punctuation\">.</span>xzy<span class=\"token punctuation\">.</span>springbootredisdemo<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>*<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">/***\n * \n * key--::ip::\n * limit--\n * expire--incr\n * isLimiterIp -- IPtruekeyratelimit:url:ipip\n */</span>\n<span class=\"token annotation punctuation\">@Target</span><span class=\"token punctuation\">(</span>ElementType<span class=\"token punctuation\">.</span>METHOD<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Retention</span><span class=\"token punctuation\">(</span>RetentionPolicy<span class=\"token punctuation\">.</span>RUNTIME<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Documented</span>\n<span class=\"token keyword\">public</span> @<span class=\"token keyword\">interface</span> <span class=\"token class-name\">RateLimiter</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">/**\n     * key\n     * @return\n     */</span>\n    String <span class=\"token function\">key</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"rate:limiter\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">/**\n     * \n     * @return\n     */</span>\n    <span class=\"token keyword\">long</span> <span class=\"token function\">limit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">/**\n     * \n     * @return\n     */</span>\n    <span class=\"token keyword\">long</span> <span class=\"token function\">expire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    String <span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * ip\n     * * @return\n     */</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">isLimiterIp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>fasterxml<span class=\"token punctuation\">.</span>jackson<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>JsonAutoDetect<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>fasterxml<span class=\"token punctuation\">.</span>jackson<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>PropertyAccessor<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>fasterxml<span class=\"token punctuation\">.</span>jackson<span class=\"token punctuation\">.</span>databind<span class=\"token punctuation\">.</span>ObjectMapper<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>CacheManager<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>CachingConfigurerSupport<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>EnableCaching<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Bean<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Configuration<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>RedisCacheConfiguration<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>RedisCacheManager<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span>RedisConnectionFactory<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>RedisTemplate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span>Jackson2JsonRedisSerializer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span>RedisSerializationContext<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span>RedisSerializer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span>StringRedisSerializer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisCacheConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">CachingConfigurerSupport</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Logger logger <span class=\"token operator\">=</span> LoggerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span>RedisCacheConfig<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> CacheManager <span class=\"token function\">cacheManager</span><span class=\"token punctuation\">(</span>RedisConnectionFactory factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        RedisSerializer<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> redisSerializer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        ObjectMapper om <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        om<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span>PropertyAccessor<span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">,</span> JsonAutoDetect<span class=\"token punctuation\">.</span>Visibility<span class=\"token punctuation\">.</span>ANY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        om<span class=\"token punctuation\">.</span><span class=\"token function\">enableDefaultTyping</span><span class=\"token punctuation\">(</span>ObjectMapper<span class=\"token punctuation\">.</span>DefaultTyping<span class=\"token punctuation\">.</span>NON_FINAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        jackson2JsonRedisSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">setObjectMapper</span><span class=\"token punctuation\">(</span>om<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// ,30</span>\n        RedisCacheConfiguration config <span class=\"token operator\">=</span> RedisCacheConfiguration<span class=\"token punctuation\">.</span><span class=\"token function\">defaultCacheConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">entryTtl</span><span class=\"token punctuation\">(</span>Duration<span class=\"token punctuation\">.</span><span class=\"token function\">ofSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">serializeKeysWith</span><span class=\"token punctuation\">(</span>RedisSerializationContext<span class=\"token punctuation\">.</span>SerializationPair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span>redisSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">serializeValuesWith</span><span class=\"token punctuation\">(</span>RedisSerializationContext<span class=\"token punctuation\">.</span>SerializationPair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span>jackson2JsonRedisSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">disableCachingNullValues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        RedisCacheManager cacheManager <span class=\"token operator\">=</span> RedisCacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">cacheDefaults</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> cacheManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> RedisTemplate<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span>RedisConnectionFactory factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        RedisTemplate<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> template <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        RedisSerializer<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> redisSerializer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ObjectMapper om <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        om<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span>PropertyAccessor<span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">,</span> JsonAutoDetect<span class=\"token punctuation\">.</span>Visibility<span class=\"token punctuation\">.</span>ANY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        om<span class=\"token punctuation\">.</span><span class=\"token function\">enableDefaultTyping</span><span class=\"token punctuation\">(</span>ObjectMapper<span class=\"token punctuation\">.</span>DefaultTyping<span class=\"token punctuation\">.</span>NON_FINAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        jackson2JsonRedisSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">setObjectMapper</span><span class=\"token punctuation\">(</span>om<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//key</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span>redisSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//value</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span>jackson2JsonRedisSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//value hashmap</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setHashValueSerializer</span><span class=\"token punctuation\">(</span>jackson2JsonRedisSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> template<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"AOP\"><a href=\"#AOP\" class=\"headerlink\" title=\"AOP\"></a>AOP</h4><p>@RateLimiter</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span>Preconditions<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">.</span>Lists<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">.</span>Maps<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>xzy<span class=\"token punctuation\">.</span>springbootredisdemo<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>RateLimiter<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>xzy<span class=\"token punctuation\">.</span>springbootredisdemo<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>IpUtil<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>xzy<span class=\"token punctuation\">.</span>springbootredisdemo<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>ResultVo<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>ProceedingJoinPoint<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>Signature<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Around<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Aspect<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Pointcut<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span>MethodSignature<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>Autowired<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>ClassPathResource<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>RedisTemplate<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>script<span class=\"token punctuation\">.</span>DefaultRedisScript<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>scripting<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>ResourceScriptSource<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>stereotype<span class=\"token punctuation\">.</span>Component<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span>PostConstruct<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>servlet<span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span>HttpServletRequest<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span>Type<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>List<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>Map<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//aop</span>\n<span class=\"token annotation punctuation\">@Aspect</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RateLimterHandler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Logger logger <span class=\"token operator\">=</span> LoggerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span>RateLimterHandler<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> RedisTemplate redisTemplate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> DefaultRedisScript<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> redisScript<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//@PostConstructServletSercletinti()</span>\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        redisScript <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultRedisScript</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisScript<span class=\"token punctuation\">.</span><span class=\"token function\">setResultType</span><span class=\"token punctuation\">(</span>Long<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisScript<span class=\"token punctuation\">.</span><span class=\"token function\">setScriptSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ResourceScriptSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rateLimter.lua\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RateLimterHandler[]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//RateLimiterrateLimiter</span>\n    <span class=\"token annotation punctuation\">@Pointcut</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@annotation(com.xzy.springbootredisdemo.annotation.RateLimiter)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">rateLimiter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Around</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@annotation(rateLimiter)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> Object <span class=\"token function\">around</span><span class=\"token punctuation\">(</span>ProceedingJoinPoint proceedingJoinPoint<span class=\"token punctuation\">,</span> RateLimiter rateLimiter<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Throwable <span class=\"token punctuation\">{</span>\n        Signature signature <span class=\"token operator\">=</span> proceedingJoinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>signature <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MethodSignature</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        HttpServletRequest request <span class=\"token operator\">=</span> <span class=\"token function\">getArgsRequest</span><span class=\"token punctuation\">(</span>proceedingJoinPoint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token comment\" spellcheck=\"true\">// key</span>\n        String limitKey <span class=\"token operator\">=</span> rateLimiter<span class=\"token punctuation\">.</span><span class=\"token function\">key</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Preconditions<span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>limitKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token comment\" spellcheck=\"true\">//ip</span>\n        <span class=\"token keyword\">boolean</span> isLimiterIp <span class=\"token operator\">=</span> rateLimiter<span class=\"token punctuation\">.</span><span class=\"token function\">isLimiterIp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isLimiterIp <span class=\"token operator\">&amp;&amp;</span> request <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                String ip <span class=\"token operator\">=</span> IpUtil<span class=\"token punctuation\">.</span><span class=\"token function\">getIpAddr</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                limitKey <span class=\"token operator\">+=</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> ip<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">long</span> limitTimes <span class=\"token operator\">=</span> rateLimiter<span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">// </span>\n        <span class=\"token keyword\">long</span> expireTime <span class=\"token operator\">=</span> rateLimiter<span class=\"token punctuation\">.</span><span class=\"token function\">expire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RateLimterHandler[]-limitTimes={},limitTimeout={}\"</span><span class=\"token punctuation\">,</span> limitTimes<span class=\"token punctuation\">,</span> expireTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        String message <span class=\"token operator\">=</span> rateLimiter<span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//lua</span>\n        List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> keyList <span class=\"token operator\">=</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        keyList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>limitKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Long result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Long<span class=\"token punctuation\">)</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>redisScript<span class=\"token punctuation\">,</span> keyList<span class=\"token punctuation\">,</span> expireTime<span class=\"token punctuation\">,</span> limitTimes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Type type <span class=\"token operator\">=</span> <span class=\"token function\">getMethodReturnType</span><span class=\"token punctuation\">(</span>proceedingJoinPoint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=\"</span> <span class=\"token operator\">+</span> expireTime <span class=\"token operator\">+</span> <span class=\"token string\">\"-=\"</span> <span class=\"token operator\">+</span> limitTimes <span class=\"token operator\">+</span> <span class=\"token string\">\"[]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">limitErrorReturn</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> proceedingJoinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">proceed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> Object <span class=\"token function\">limitErrorReturn</span><span class=\"token punctuation\">(</span>Type type<span class=\"token punctuation\">,</span> String msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">.</span><span class=\"token function\">getTypeName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">\"java.lang.String\"</span><span class=\"token operator\">:</span>\n                <span class=\"token keyword\">return</span> msg<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">\"java.util.Map\"</span><span class=\"token operator\">:</span>\n                Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span> resultMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> resultMap<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">\"com.xzy.springbootredisdemo.util.ResultVo\"</span><span class=\"token operator\">:</span>\n                <span class=\"token keyword\">return</span> ResultVo<span class=\"token punctuation\">.</span><span class=\"token function\">getErrorResultVo</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n                <span class=\"token keyword\">return</span> msg<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> HttpServletRequest <span class=\"token function\">getArgsRequest</span><span class=\"token punctuation\">(</span>ProceedingJoinPoint proceedingJoinPoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> NoSuchMethodException <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args <span class=\"token operator\">=</span> proceedingJoinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">getArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        HttpServletRequest request <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Object o <span class=\"token operator\">:</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>o <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">HttpServletRequest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                request <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HttpServletRequest<span class=\"token punctuation\">)</span> o<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @param proceedingJoinPoint\n     * @return\n     * @throws NoSuchMethodException\n     */</span>\n    <span class=\"token keyword\">public</span> Type <span class=\"token function\">getMethodReturnType</span><span class=\"token punctuation\">(</span>ProceedingJoinPoint proceedingJoinPoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> NoSuchMethodException <span class=\"token punctuation\">{</span>\n        Signature signature <span class=\"token operator\">=</span> proceedingJoinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        MethodSignature methodSignature <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>MethodSignature<span class=\"token punctuation\">)</span> signature<span class=\"token punctuation\">;</span>\n        Object target <span class=\"token operator\">=</span> proceedingJoinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">getTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Method currentMethod <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span>methodSignature<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> methodSignature<span class=\"token punctuation\">.</span><span class=\"token function\">getParameterTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> currentMethod<span class=\"token punctuation\">.</span><span class=\"token function\">getAnnotatedReturnType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BaseEnum</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">getCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">getMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> SystemResultEnum <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BaseEnum</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">SUCCESS</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">FAIL</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">NO_AUTH_USER</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">NO_AD_USER</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">SystemResultEnum</span><span class=\"token punctuation\">(</span>String code<span class=\"token punctuation\">,</span> String msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>code <span class=\"token operator\">=</span> code<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>msg <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> String code<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String msg<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">getCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> code<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setCode</span><span class=\"token punctuation\">(</span>String code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>code <span class=\"token operator\">=</span> code<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">getMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> msg<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setMsg</span><span class=\"token punctuation\">(</span>String msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>msg <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"Lua\"><a href=\"#Lua\" class=\"headerlink\" title=\"Lua\"></a>Lua</h4><pre class=\" language-lua\"><code class=\"language-lua\"><span class=\"token comment\" spellcheck=\"true\">-- KEY</span>\n<span class=\"token keyword\">local</span> key1 <span class=\"token operator\">=</span> KEYS<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\" spellcheck=\"true\">-- incrkey1</span>\n<span class=\"token keyword\">local</span> val <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">'incr'</span><span class=\"token punctuation\">,</span> key1<span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">-- key1</span>\n<span class=\"token keyword\">local</span> ttl <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ttl'</span><span class=\"token punctuation\">,</span>key1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--ARGV</span>\n<span class=\"token comment\" spellcheck=\"true\">-- ARGV[1]</span>\n<span class=\"token keyword\">local</span> expire <span class=\"token operator\">=</span> ARGV<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\" spellcheck=\"true\">-- ARGV[2]</span>\n<span class=\"token keyword\">local</span> times <span class=\"token operator\">=</span> ARGV<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\" spellcheck=\"true\">--  </span>\n<span class=\"token comment\" spellcheck=\"true\">-- redis.log(redis.LOG_DEBUG,tostring(times))</span>\n<span class=\"token comment\" spellcheck=\"true\">-- redis.log(redis.LOG_DEBUG,tostring(expire))</span>\n<span class=\"token comment\" spellcheck=\"true\">-- redis.log(redis.LOG_NOTICE, \"incr \"..key1..\" \"..val);</span>\n<span class=\"token comment\" spellcheck=\"true\">-- val == 1 </span>\n<span class=\"token keyword\">if</span> val <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token keyword\">then</span>\n    redis<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">'expire'</span><span class=\"token punctuation\">,</span>key1<span class=\"token punctuation\">,</span><span class=\"token function\">tonumber</span><span class=\"token punctuation\">(</span>expire<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">if</span> ttl <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">then</span>\n        redis<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">'expire'</span><span class=\"token punctuation\">,</span>key1<span class=\"token punctuation\">,</span><span class=\"token function\">tonumber</span><span class=\"token punctuation\">(</span>expire<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">if</span> val <span class=\"token operator\">></span> <span class=\"token function\">tonumber</span><span class=\"token punctuation\">(</span>times<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span></code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String MESSAGE <span class=\"token operator\">=</span> <span class=\"token string\">\"{\\\"code\\\":\\\"400\\\",\\\"msg\\\":\\\"FAIL\\\",\\\"desc\\\":\\\"\\\"}\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/testone\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@RateLimiter</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"ratelimit:testOne\"</span><span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> expire <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> message <span class=\"token operator\">=</span> MESSAGE<span class=\"token punctuation\">,</span> isLimiterIp <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">testOne</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/testtwo\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@RateLimiter</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"ratelimit:testTwo\"</span><span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> expire <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> isLimiterIp <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> Map <span class=\"token function\">testTow</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>String<span class=\"token operator\">></span> resultMap <span class=\"token operator\">=</span> Maps<span class=\"token punctuation\">.</span><span class=\"token function\">newHashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        resultMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> resultMap<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/testthree\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@RateLimiter</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"ratelimit:testThree\"</span><span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> expire <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> isLimiterIp <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> ResultVo <span class=\"token function\">testThree</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> ResultVo<span class=\"token punctuation\">.</span><span class=\"token function\">getSuccessResultVo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>api-urlredis-keyurlkeyredis</p>","more":"<p>aop+controlleraop<strong>@RateLimiter</strong></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">//testoneurl105\n@RequestMapping(&quot;/testone&quot;)\n@RateLimiter(key = &quot;ratelimit:testOne&quot;, limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return &quot;&quot;;\n}</code></pre>\n<p>105</p>\n<pre><code class=\"json\">{&quot;code&quot;:&quot;400&quot;,&quot;msg&quot;:&quot;FAIL&quot;,&quot;desc&quot;:&quot;&quot;}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"MAVEN\"><a href=\"#MAVEN\" class=\"headerlink\" title=\"MAVEN\"></a>MAVEN</h3><pre><code class=\"xml\">&lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;!--aop--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;!--redis--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;\n            &lt;scope&gt;runtime&lt;/scope&gt;\n            &lt;optional&gt;true&lt;/optional&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;\n            &lt;version&gt;2.6.0&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;\n            &lt;version&gt;3.7&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.google.guava&lt;/groupId&gt;\n            &lt;artifactId&gt;guava&lt;/artifactId&gt;\n            &lt;version&gt;26.0-jre&lt;/version&gt;\n        &lt;/dependency&gt;\n\n    &lt;/dependencies&gt;</code></pre>\n<h3 id=\"SpringBoot\"><a href=\"#SpringBoot\" class=\"headerlink\" title=\"SpringBoot\"></a>SpringBoot</h3><pre><code class=\"yaml\">spring:\n  redis:\n    database: 0\n    host: 127.0.0.1\n    jedis:\n      pool:\n        #, 0 \n        max-active: 8\n        #, 0 \n        max-idle: 8\n        #-1\n        max-wait: -1ms\n        #, 0 \n        min-idle: 0\n    lettuce:\n      pool:\n        max-active: 8\n        max-idle: 8\n        max-wait: -1ms\n        min-idle: 0\n      shutdown-timeout: 100ms\n    password: &#39;&#39;\n    port: 6379</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">package com.xzy.springbootredisdemo.annotation;\n\nimport java.lang.annotation.*;\n\n/***\n * \n * key--::ip::\n * limit--\n * expire--incr\n * isLimiterIp -- IPtruekeyratelimit:url:ipip\n */\n@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface RateLimiter {\n    /**\n     * key\n     * @return\n     */\n    String key() default &quot;rate:limiter&quot;;\n    /**\n     * \n     * @return\n     */\n    long limit() default 10;\n    /**\n     * \n     * @return\n     */\n    long expire() default 1;\n    String message() default &quot;&quot;;\n    /***\n     * ip\n     * * @return\n     */\n    boolean isLimiterIp() default false;\n}\n</code></pre>\n<h4 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h4><pre><code class=\"java\">import com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.cache.CacheManager;\nimport org.springframework.cache.annotation.CachingConfigurerSupport;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.RedisSerializer;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;\n@Configuration\n@EnableCaching\npublic class RedisCacheConfig extends CachingConfigurerSupport {\n    private static final Logger logger = LoggerFactory.getLogger(RedisCacheConfig.class);\n    @Bean\n    public CacheManager cacheManager(RedisConnectionFactory factory) {\n        RedisSerializer&lt;String&gt; redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        //\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        // ,30\n        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()\n                .entryTtl(Duration.ofSeconds(30))\n                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))\n                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))\n                .disableCachingNullValues();\n        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)\n                .cacheDefaults(config)\n                .build();\n        return cacheManager;\n    }\n    @Bean\n    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) {\n        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();\n        RedisSerializer&lt;String&gt; redisSerializer = new StringRedisSerializer();\n        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);\n        ObjectMapper om = new ObjectMapper();\n        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);\n        jackson2JsonRedisSerializer.setObjectMapper(om);\n        template.setConnectionFactory(factory);\n        //key\n        template.setKeySerializer(redisSerializer);\n        //value\n        template.setValueSerializer(jackson2JsonRedisSerializer);\n        //value hashmap\n        template.setHashValueSerializer(jackson2JsonRedisSerializer);\n        return template;\n    }\n}</code></pre>\n<h4 id=\"AOP\"><a href=\"#AOP\" class=\"headerlink\" title=\"AOP\"></a>AOP</h4><p>@RateLimiter</p>\n<pre><code class=\"java\">import com.google.common.base.Preconditions;\nimport com.google.common.collect.Lists;\nimport com.google.common.collect.Maps;\nimport com.xzy.springbootredisdemo.annotation.RateLimiter;\nimport com.xzy.springbootredisdemo.util.IpUtil;\nimport com.xzy.springbootredisdemo.util.ResultVo;\nimport org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.Signature;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.scripting.support.ResourceScriptSource;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.PostConstruct;\nimport javax.servlet.http.HttpServletRequest;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Type;\nimport java.util.List;\nimport java.util.Map;\n\n//aop\n@Aspect\n@Component\npublic class RateLimterHandler {\n    private static final Logger logger = LoggerFactory.getLogger(RateLimterHandler.class);\n\n    @Autowired\n    private RedisTemplate redisTemplate;\n\n    private DefaultRedisScript&lt;Long&gt; redisScript;\n\n    //@PostConstructServletSercletinti()\n    @PostConstruct\n    public void init() {\n        redisScript = new DefaultRedisScript&lt;&gt;();\n        redisScript.setResultType(Long.class);\n        redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(&quot;rateLimter.lua&quot;)));\n        logger.info(&quot;RateLimterHandler[]&quot;);\n    }\n\n    //RateLimiterrateLimiter\n    @Pointcut(&quot;@annotation(com.xzy.springbootredisdemo.annotation.RateLimiter)&quot;)\n    public void rateLimiter() {\n    }\n\n    @Around(&quot;@annotation(rateLimiter)&quot;)\n    public Object around(ProceedingJoinPoint proceedingJoinPoint, RateLimiter rateLimiter) throws Throwable {\n        Signature signature = proceedingJoinPoint.getSignature();\n        if (!(signature instanceof MethodSignature)) {\n            throw new IllegalArgumentException(&quot;&quot;);\n        }\n        //\n        HttpServletRequest request = getArgsRequest(proceedingJoinPoint);\n        //\n        // key\n        String limitKey = rateLimiter.key();\n        Preconditions.checkNotNull(limitKey); //\n        //ip\n        boolean isLimiterIp = rateLimiter.isLimiterIp();\n        if (isLimiterIp &amp;&amp; request != null) {\n            if (request != null) {\n                String ip = IpUtil.getIpAddr(request);\n                limitKey += &quot;:&quot; + ip;\n            }\n        }\n        //\n        long limitTimes = rateLimiter.limit();\n        // \n        long expireTime = rateLimiter.expire();\n        if (logger.isDebugEnabled()) {\n            logger.debug(&quot;RateLimterHandler[]-limitTimes={},limitTimeout={}&quot;, limitTimes, expireTime);\n        }\n        //\n        String message = rateLimiter.message();\n        //lua\n        List&lt;String&gt; keyList = Lists.newArrayList();\n        keyList.add(limitKey);\n        Long result = (Long) redisTemplate.execute(redisScript, keyList, expireTime, limitTimes);\n        if (result == 0) {\n            Type type = getMethodReturnType(proceedingJoinPoint);\n            logger.info(&quot;=&quot; + expireTime + &quot;-=&quot; + limitTimes + &quot;[]&quot;);\n            return limitErrorReturn(type, message);\n        }\n        return proceedingJoinPoint.proceed();\n    }\n\n\n    public Object limitErrorReturn(Type type, String msg) {\n        switch (type.getTypeName()) {\n            case &quot;java.lang.String&quot;:\n                return msg;\n            case &quot;java.util.Map&quot;:\n                Map&lt;String, String&gt; resultMap = Maps.newHashMap();\n                resultMap.put(&quot;code&quot;, &quot;-1&quot;);\n                resultMap.put(&quot;message&quot;, msg);\n                return resultMap;\n            case &quot;com.xzy.springbootredisdemo.util.ResultVo&quot;:\n                return ResultVo.getErrorResultVo(msg);\n            default:\n                return msg;\n        }\n    }\n\n\n    public HttpServletRequest getArgsRequest(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        //\n        Object[] args = proceedingJoinPoint.getArgs();\n        HttpServletRequest request = null;\n        for (Object o : args) {\n            if (o instanceof HttpServletRequest) {\n                request = (HttpServletRequest) o;\n            }\n        }\n        return request;\n    }\n\n    /***\n     * \n     * @param proceedingJoinPoint\n     * @return\n     * @throws NoSuchMethodException\n     */\n    public Type getMethodReturnType(ProceedingJoinPoint proceedingJoinPoint) throws NoSuchMethodException {\n        Signature signature = proceedingJoinPoint.getSignature();\n        MethodSignature methodSignature = (MethodSignature) signature;\n        Object target = proceedingJoinPoint.getTarget();\n        Method currentMethod = target.getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());\n        return currentMethod.getAnnotatedReturnType().getType();\n    }\n\n}\n</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">public interface BaseEnum {\n    public String getCode();\n    public String getMsg();\n}\npublic enum SystemResultEnum implements BaseEnum {\n    SUCCESS(&quot;1&quot;, &quot;&quot;),\n    FAIL(&quot;0&quot;, &quot;&quot;),\n    NO_AUTH_USER(&quot;2&quot;, &quot;&quot;),\n    NO_AD_USER(&quot;3&quot;, &quot;&quot;);\n    SystemResultEnum(String code, String msg) {\n        this.code = code;\n        this.msg = msg;\n    }\n    private String code;\n    private String msg;\n    public String getCode() {\n        return code;\n    }\n    public void setCode(String code) {\n        this.code = code;\n    }\n    public String getMsg() {\n        return msg;\n    }\n    public void setMsg(String msg) {\n        this.msg = msg;\n    }\n}</code></pre>\n<h4 id=\"Lua\"><a href=\"#Lua\" class=\"headerlink\" title=\"Lua\"></a>Lua</h4><pre><code class=\"lua\">-- KEY\nlocal key1 = KEYS[1]\n-- incrkey1\nlocal val = redis.call(&#39;incr&#39;, key1)\n-- key1\nlocal ttl = redis.call(&#39;ttl&#39;,key1)\n\n--ARGV\n-- ARGV[1]\nlocal expire = ARGV[1]\n-- ARGV[2]\nlocal times = ARGV[2]\n\n--  \n-- redis.log(redis.LOG_DEBUG,tostring(times))\n-- redis.log(redis.LOG_DEBUG,tostring(expire))\n-- redis.log(redis.LOG_NOTICE, &quot;incr &quot;..key1..&quot; &quot;..val);\n-- val == 1 \nif val == 1 then\n    redis.call(&#39;expire&#39;,key1,tonumber(expire))\nelse\n    if ttl == -1 then\n        redis.call(&#39;expire&#39;,key1,tonumber(expire))\n    end\nend\n\nif val &gt; tonumber(times) then\n    return 0\nend\n    return 1</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"java\">@RestController\npublic class TestController {\n    private static final String MESSAGE = &quot;{\\&quot;code\\&quot;:\\&quot;400\\&quot;,\\&quot;msg\\&quot;:\\&quot;FAIL\\&quot;,\\&quot;desc\\&quot;:\\&quot;\\&quot;}&quot;;\n\n    @RequestMapping(&quot;/testone&quot;)\n    @RateLimiter(key = &quot;ratelimit:testOne&quot;, limit = 5, expire = 10, message = MESSAGE, isLimiterIp = true)\n    public String testOne(HttpServletRequest request) {\n        return &quot;&quot;;\n    }\n    @RequestMapping(&quot;/testtwo&quot;)\n    @RateLimiter(key = &quot;ratelimit:testTwo&quot;, limit = 5, expire = 10, isLimiterIp = false)\n    public Map testTow(HttpServletRequest request){\n        Map&lt;String,String&gt; resultMap = Maps.newHashMap();\n        resultMap.put(&quot;code&quot;, &quot;1&quot;);\n        resultMap.put(&quot;message&quot; , &quot;success&quot;);\n        return resultMap;\n    }\n    @RequestMapping(&quot;/testthree&quot;)\n    @RateLimiter(key = &quot;ratelimit:testThree&quot;, limit = 5, expire = 10, isLimiterIp = false)\n    public ResultVo testThree(HttpServletRequest request){\n        return ResultVo.getSuccessResultVo();\n    }\n}</code></pre>"},{"title":"Redis5.0","description":"Redis5.0","date":"2020-09-02T03:13:00.000Z","_content":"\n## Redis5.0\n\n98579858\n\n![](redis-cluster-build-2/2.png)\n<!--more-->\nRedis\n\n![](redis-cluster-build-2/1.png)\n\n- 0 - 5460           10.8.198.152:9851   10.8.198.152.9856\n- 5461 - 10922   10.8.198.152:9852   10.8.198.152.9854\n- 10923 - 16381 10.8.198.152:9853   10.8.198.152.9855\n\n### **98579858**\n\n98579858\n\n```shell\n[root@Slave3 redis]# mkdir 9857\n[root@Slave3 redis]# mkdir 9858\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9857/\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9858/\n##98579858\n[root@Slave3 redis]# redis-server /etc/redis/9857/redis.conf\n[root@Slave3 redis]# redis-server /etc/redis/9858/redis.conf\n```\n\n### **9857**\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/3.png)\n\n### **9857()**\n\n#### **1**\n\n985798573mastermasermaster\n\n**9857**\n\n```shell\nredis-cli --cluster reshard 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/4.png)\n\n**** \n\n\n- all\n- done\n\nall100033333333349857done985710009857\n\n#### **2**\n\n<font color=red></font>\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/3.png)\n\n19851KEY\n\n```shell\n#cluster getkeysinslot  \n10.8.198.152:9851>cluster getkeysinslot 1000 2000\n(empty list or set)\n```\n\n29857cluster setslot  importing id98571000importing\n\n```\n10.8.198.152:9857>cluster setslot 1000 importing 419ff0823f0ff4cfb1ffc4c002665ad077911cc2\n```\n\n![](redis-cluster-build-2/8.png)\n\n39851cluster setslot  migrating id9851460migrating\n\n```shell\n10.8.198.152:9851>cluster setslot 1000 migrating 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\n```\n\n![](redis-cluster-build-2/9.png)\n\n4**cluster setslot  node id**1000\n\n```shell\n# 9851idid\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n#9857idid\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n10.8.198.152:9857> cluster nodes\nf08cdba85763f71de3a1cbac8a45962594ab09aa 10.8.198.152:9852@19852 master - 0 1599038877000 2 connected 5461-10922\nb8cc9aeca57e1332b6f42b7e183cce686033c2d6 10.8.198.152:9854@19854 slave 419ff0823f0ff4cfb1ffc4c002665ad077911cc2 0 1599038878000 1 connected\n286fe16d33dbbafa9f13e9a11d4351c37e085155 10.8.198.152:9853@19853 master - 0 1599038879000 3 connected 10923-16383\naf6115f83a145c63a75916608084712f96d44c34 10.8.198.152:9855@19855 slave f08cdba85763f71de3a1cbac8a45962594ab09aa 0 1599038879489 2 connected\n5e2af503c816eeff7ed2cfb2249f0ceb1f5306da 10.8.198.152:9857@19857 myself,master - 0 1599038878000 7 connected 1000\n14901a2ff5242f302103bbca4bfa6e2dade0a95b 10.8.198.152:9856@19856 slave 286fe16d33dbbafa9f13e9a11d4351c37e085155 0 1599038880000 3 connected\n419ff0823f0ff4cfb1ffc4c002665ad077911cc2 10.8.198.152:9851@19851 master - 0 1599038880492 1 connected 0-999 1001-5460\n```\n\n\n\n### **9857()**\n\n<font color=red>9851100098579851key</font>\n\n![2](redis-cluster-build-2/5.png)\n\n#### **1**\n\n\n\n1. 9851keyflushdb\n2.  redis-cli \\--cluster fix 10.8.198.152:9851 \n3.  redis-cli \\--cluster reshard 10.8.198.152.9851 \n\n#### **2**\n\n98516549857\n\n9857\n\n```shell\n redis-cli --cluster add-node 10.8.198.1529857 10.8.198.1529851\n```\n\ncluster nodes\n\n```shell\n10.8.198.152:9851> cluster nodes\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040212180 5 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040210000 3 connected 10923-16383\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040210175 2 connected 5461-10922\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040212000 4 connected\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 myself,master - 0 1599040211000 1 connected 0-5460\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 master - 0 1599040211000 0 connected\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040213182 6 connected\n```\n\n1654\n\n```shell\n#cluster getkeysinslot  \n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster getkeysinslot 654 2000\n1) \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"\n```\n\n29857cluster setslot  importing id8000654importing\n\n```shell\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 654 importing 5015fbe7c523681a59e13f86f0ddc27b1ac542f8\nOK\n```\n\n39851cluster setslot  migrating id9851654migrating\n\n```shell\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 654 migrating 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n```\n\n4**9851**741key-valuekeymap{:[age,...]}9857\n\n- hostRedisIP\n- portRedis\n- key|\"\"Redis 3.0.6 \"\"\n- destination-dbRedis\n- timeout\n- copy\n- replace`migrate`Redis\n- keys`keys key1 key2 key3`\n\n```shell\n10.8.198.152:9851> migrate 10.8.198.152 9857 \"\" 0 1000 keys \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"\nOK\n```\n\n5\n\n```shell\n10.8.198.152:9851> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster nodes\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040905000 2 connected 5461-10922\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040909085 2 connected\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040906000 1 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040908083 3 connected 10923-16383\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 master - 0 1599040907082 1 connected 0-653 655-5460\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040907000 3 connected\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 myself,master - 0 1599040907000 7 connected 654\n```\n\n<font color=red>KEYmigrate</font>\n\n### **98579858**\n\n985798589857\n\n![](redis-cluster-build-2/6.png)\n\n:\n\n9858\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9858 10.8.198.152:9851\n```\n\n9858\n\n```shell\nredis-cli -p 9858 -h 10.8.198.152\n```\n\n98589857\n\n```shell\n10.8.198.152:9858> cluster replicate 9857ID\n```\n\n\n\n![](redis-cluster-build-2/7.png)\n\n## \n\n### KEY\n\n```shell\n10.8.198.152:9851> cluster keyslot keyname\n```","source":"_posts/redis-cluster-build-2.md","raw":"---\ntitle: Redis5.0\ntags:\n  - redis\ncategories: redis\ndescription : Redis5.0\ndate: 2020-09-02 11:13:00\n---\n\n## Redis5.0\n\n98579858\n\n![](redis-cluster-build-2/2.png)\n<!--more-->\nRedis\n\n![](redis-cluster-build-2/1.png)\n\n- 0 - 5460           10.8.198.152:9851   10.8.198.152.9856\n- 5461 - 10922   10.8.198.152:9852   10.8.198.152.9854\n- 10923 - 16381 10.8.198.152:9853   10.8.198.152.9855\n\n### **98579858**\n\n98579858\n\n```shell\n[root@Slave3 redis]# mkdir 9857\n[root@Slave3 redis]# mkdir 9858\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9857/\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9858/\n##98579858\n[root@Slave3 redis]# redis-server /etc/redis/9857/redis.conf\n[root@Slave3 redis]# redis-server /etc/redis/9858/redis.conf\n```\n\n### **9857**\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/3.png)\n\n### **9857()**\n\n#### **1**\n\n985798573mastermasermaster\n\n**9857**\n\n```shell\nredis-cli --cluster reshard 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/4.png)\n\n**** \n\n\n- all\n- done\n\nall100033333333349857done985710009857\n\n#### **2**\n\n<font color=red></font>\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851\n```\n\n![](redis-cluster-build-2/3.png)\n\n19851KEY\n\n```shell\n#cluster getkeysinslot  \n10.8.198.152:9851>cluster getkeysinslot 1000 2000\n(empty list or set)\n```\n\n29857cluster setslot  importing id98571000importing\n\n```\n10.8.198.152:9857>cluster setslot 1000 importing 419ff0823f0ff4cfb1ffc4c002665ad077911cc2\n```\n\n![](redis-cluster-build-2/8.png)\n\n39851cluster setslot  migrating id9851460migrating\n\n```shell\n10.8.198.152:9851>cluster setslot 1000 migrating 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\n```\n\n![](redis-cluster-build-2/9.png)\n\n4**cluster setslot  node id**1000\n\n```shell\n# 9851idid\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n#9857idid\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n10.8.198.152:9857> cluster nodes\nf08cdba85763f71de3a1cbac8a45962594ab09aa 10.8.198.152:9852@19852 master - 0 1599038877000 2 connected 5461-10922\nb8cc9aeca57e1332b6f42b7e183cce686033c2d6 10.8.198.152:9854@19854 slave 419ff0823f0ff4cfb1ffc4c002665ad077911cc2 0 1599038878000 1 connected\n286fe16d33dbbafa9f13e9a11d4351c37e085155 10.8.198.152:9853@19853 master - 0 1599038879000 3 connected 10923-16383\naf6115f83a145c63a75916608084712f96d44c34 10.8.198.152:9855@19855 slave f08cdba85763f71de3a1cbac8a45962594ab09aa 0 1599038879489 2 connected\n5e2af503c816eeff7ed2cfb2249f0ceb1f5306da 10.8.198.152:9857@19857 myself,master - 0 1599038878000 7 connected 1000\n14901a2ff5242f302103bbca4bfa6e2dade0a95b 10.8.198.152:9856@19856 slave 286fe16d33dbbafa9f13e9a11d4351c37e085155 0 1599038880000 3 connected\n419ff0823f0ff4cfb1ffc4c002665ad077911cc2 10.8.198.152:9851@19851 master - 0 1599038880492 1 connected 0-999 1001-5460\n```\n\n\n\n### **9857()**\n\n<font color=red>9851100098579851key</font>\n\n![2](redis-cluster-build-2/5.png)\n\n#### **1**\n\n\n\n1. 9851keyflushdb\n2.  redis-cli \\--cluster fix 10.8.198.152:9851 \n3.  redis-cli \\--cluster reshard 10.8.198.152.9851 \n\n#### **2**\n\n98516549857\n\n9857\n\n```shell\n redis-cli --cluster add-node 10.8.198.1529857 10.8.198.1529851\n```\n\ncluster nodes\n\n```shell\n10.8.198.152:9851> cluster nodes\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040212180 5 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040210000 3 connected 10923-16383\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040210175 2 connected 5461-10922\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040212000 4 connected\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 myself,master - 0 1599040211000 1 connected 0-5460\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 master - 0 1599040211000 0 connected\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040213182 6 connected\n```\n\n1654\n\n```shell\n#cluster getkeysinslot  \n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster getkeysinslot 654 2000\n1) \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"\n```\n\n29857cluster setslot  importing id8000654importing\n\n```shell\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 654 importing 5015fbe7c523681a59e13f86f0ddc27b1ac542f8\nOK\n```\n\n39851cluster setslot  migrating id9851654migrating\n\n```shell\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 654 migrating 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n```\n\n4**9851**741key-valuekeymap{:[age,...]}9857\n\n- hostRedisIP\n- portRedis\n- key|\"\"Redis 3.0.6 \"\"\n- destination-dbRedis\n- timeout\n- copy\n- replace`migrate`Redis\n- keys`keys key1 key2 key3`\n\n```shell\n10.8.198.152:9851> migrate 10.8.198.152 9857 \"\" 0 1000 keys \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"\nOK\n```\n\n5\n\n```shell\n10.8.198.152:9851> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster nodes\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040905000 2 connected 5461-10922\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040909085 2 connected\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040906000 1 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040908083 3 connected 10923-16383\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 master - 0 1599040907082 1 connected 0-653 655-5460\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040907000 3 connected\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 myself,master - 0 1599040907000 7 connected 654\n```\n\n<font color=red>KEYmigrate</font>\n\n### **98579858**\n\n985798589857\n\n![](redis-cluster-build-2/6.png)\n\n:\n\n9858\n\n```shell\nredis-cli --cluster add-node 10.8.198.152:9858 10.8.198.152:9851\n```\n\n9858\n\n```shell\nredis-cli -p 9858 -h 10.8.198.152\n```\n\n98589857\n\n```shell\n10.8.198.152:9858> cluster replicate 9857ID\n```\n\n\n\n![](redis-cluster-build-2/7.png)\n\n## \n\n### KEY\n\n```shell\n10.8.198.152:9851> cluster keyslot keyname\n```","slug":"redis-cluster-build-2","published":1,"updated":"2021-04-08T00:47:06.917Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvk002oqwv2f6a705s4","content":"<h2 id=\"Redis5-0\"><a href=\"#Redis5-0\" class=\"headerlink\" title=\"Redis5.0\"></a>Redis5.0</h2><p>98579858</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/2.png\" alt></p>\n<a id=\"more\"></a>\n<p>Redis</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/1.png\" alt></p>\n<ul>\n<li>0 - 5460           10.8.198.152:9851   10.8.198.152.9856</li>\n<li>5461 - 10922   10.8.198.152:9852   10.8.198.152.9854</li>\n<li>10923 - 16381 10.8.198.152:9853   10.8.198.152.9855</li>\n</ul>\n<h3 id=\"98579858\"><a href=\"#98579858\" class=\"headerlink\" title=\"98579858\"></a><strong>98579858</strong></h3><p>98579858</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@Slave3 redis]# mkdir 9857\n[root@Slave3 redis]# mkdir 9858\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9857/\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9858/\n##98579858\n[root@Slave3 redis]# redis-server /etc/redis/9857/redis.conf\n[root@Slave3 redis]# redis-server /etc/redis/9858/redis.conf</code></pre>\n<h3 id=\"9857\"><a href=\"#9857\" class=\"headerlink\" title=\"9857\"></a><strong>9857</strong></h3><pre class=\" language-shell\"><code class=\"language-shell\">redis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/3.png\" alt></p>\n<h3 id=\"9857-\"><a href=\"#9857-\" class=\"headerlink\" title=\"9857()\"></a><strong>9857()</strong></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a><strong>1</strong></h4><p>985798573mastermasermaster</p>\n<p><strong>9857</strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-cli --cluster reshard 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/4.png\" alt></p>\n<p><strong></strong> <br></p>\n<ul>\n<li>all</li>\n<li>done</li>\n</ul>\n<p>all100033333333349857done985710009857</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a><strong>2</strong></h4><p><font color=\"red\"></font></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/3.png\" alt></p>\n<p>19851KEY</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#cluster getkeysinslot  \n10.8.198.152:9851>cluster getkeysinslot 1000 2000\n(empty list or set)</code></pre>\n<p>29857cluster setslot  importing id98571000importing</p>\n<pre><code>10.8.198.152:9857&gt;cluster setslot 1000 importing 419ff0823f0ff4cfb1ffc4c002665ad077911cc2</code></pre><p><img src=\"/2020/09/02/redis-cluster-build-2/8.png\" alt></p>\n<p>39851cluster setslot  migrating id9851460migrating</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9851>cluster setslot 1000 migrating 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/9.png\" alt></p>\n<p>4<strong>cluster setslot  node id</strong>1000</p>\n<pre class=\" language-shell\"><code class=\"language-shell\"># 9851idid\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n#9857idid\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n10.8.198.152:9857> cluster nodes\nf08cdba85763f71de3a1cbac8a45962594ab09aa 10.8.198.152:9852@19852 master - 0 1599038877000 2 connected 5461-10922\nb8cc9aeca57e1332b6f42b7e183cce686033c2d6 10.8.198.152:9854@19854 slave 419ff0823f0ff4cfb1ffc4c002665ad077911cc2 0 1599038878000 1 connected\n286fe16d33dbbafa9f13e9a11d4351c37e085155 10.8.198.152:9853@19853 master - 0 1599038879000 3 connected 10923-16383\naf6115f83a145c63a75916608084712f96d44c34 10.8.198.152:9855@19855 slave f08cdba85763f71de3a1cbac8a45962594ab09aa 0 1599038879489 2 connected\n5e2af503c816eeff7ed2cfb2249f0ceb1f5306da 10.8.198.152:9857@19857 myself,master - 0 1599038878000 7 connected 1000\n14901a2ff5242f302103bbca4bfa6e2dade0a95b 10.8.198.152:9856@19856 slave 286fe16d33dbbafa9f13e9a11d4351c37e085155 0 1599038880000 3 connected\n419ff0823f0ff4cfb1ffc4c002665ad077911cc2 10.8.198.152:9851@19851 master - 0 1599038880492 1 connected 0-999 1001-5460</code></pre>\n<h3 id=\"9857-\"><a href=\"#9857-\" class=\"headerlink\" title=\"9857()\"></a><strong>9857()</strong></h3><p><font color=\"red\">9851100098579851key</font></p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/5.png\" alt=\"2\"></p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a><strong>1</strong></h4><p></p>\n<ol>\n<li>9851keyflushdb</li>\n<li> redis-cli --cluster fix 10.8.198.152:9851 </li>\n<li> redis-cli --cluster reshard 10.8.198.152.9851 </li>\n</ol>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a><strong>2</strong></h4><p>98516549857</p>\n<p>9857</p>\n<pre class=\" language-shell\"><code class=\"language-shell\"> redis-cli --cluster add-node 10.8.198.1529857 10.8.198.1529851</code></pre>\n<p>cluster nodes</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9851> cluster nodes\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040212180 5 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040210000 3 connected 10923-16383\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040210175 2 connected 5461-10922\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040212000 4 connected\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 myself,master - 0 1599040211000 1 connected 0-5460\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 master - 0 1599040211000 0 connected\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040213182 6 connected</code></pre>\n<p>1654</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#cluster getkeysinslot  \n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster getkeysinslot 654 2000\n1) \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"</code></pre>\n<p>29857cluster setslot  importing id8000654importing</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857> cluster setslot 654 importing 5015fbe7c523681a59e13f86f0ddc27b1ac542f8\nOK</code></pre>\n<p>39851cluster setslot  migrating id9851654migrating</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851> cluster setslot 654 migrating 0a286334e831f426de9e30c7990cffb40a1e4102\nOK</code></pre>\n<p>4<strong>9851</strong>741key-valuekeymap{:[age,]}9857</p>\n<ul>\n<li>hostRedisIP</li>\n<li>portRedis</li>\n<li>key|Redis 3.0.6 </li>\n<li>destination-dbRedis</li>\n<li>timeout</li>\n<li>copy</li>\n<li>replace<code>migrate</code>Redis</li>\n<li>keys<code>keys key1 key2 key3</code></li>\n</ul>\n<pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9851> migrate 10.8.198.152 9857 \"\" 0 1000 keys \"\\xac\\xed\\x00\\x05t\\x00\\tkey_45618\"\nOK</code></pre>\n<p>5</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9851> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857> cluster nodes\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040905000 2 connected 5461-10922\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040909085 2 connected\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040906000 1 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040908083 3 connected 10923-16383\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 master - 0 1599040907082 1 connected 0-653 655-5460\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040907000 3 connected\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 myself,master - 0 1599040907000 7 connected 654</code></pre>\n<p><font color=\"red\">KEYmigrate</font></p>\n<h3 id=\"98579858\"><a href=\"#98579858\" class=\"headerlink\" title=\"98579858\"></a><strong>98579858</strong></h3><p>985798589857</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/6.png\" alt></p>\n<p>:</p>\n<p>9858</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-cli --cluster add-node 10.8.198.152:9858 10.8.198.152:9851</code></pre>\n<p>9858</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">redis-cli -p 9858 -h 10.8.198.152</code></pre>\n<p>98589857</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9858> cluster replicate 9857ID</code></pre>\n<p></p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/7.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"KEY\"><a href=\"#KEY\" class=\"headerlink\" title=\"KEY\"></a>KEY</h3><pre class=\" language-shell\"><code class=\"language-shell\">10.8.198.152:9851> cluster keyslot keyname</code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"Redis5-0\"><a href=\"#Redis5-0\" class=\"headerlink\" title=\"Redis5.0\"></a>Redis5.0</h2><p>98579858</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/2.png\" alt></p>","more":"<p>Redis</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/1.png\" alt></p>\n<ul>\n<li>0 - 5460           10.8.198.152:9851   10.8.198.152.9856</li>\n<li>5461 - 10922   10.8.198.152:9852   10.8.198.152.9854</li>\n<li>10923 - 16381 10.8.198.152:9853   10.8.198.152.9855</li>\n</ul>\n<h3 id=\"98579858\"><a href=\"#98579858\" class=\"headerlink\" title=\"98579858\"></a><strong>98579858</strong></h3><p>98579858</p>\n<pre><code class=\"shell\">[root@Slave3 redis]# mkdir 9857\n[root@Slave3 redis]# mkdir 9858\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9857/\n[root@Slave3 redis]# cp /etc/redis/9851/redis.conf /etc/redis/9858/\n##98579858\n[root@Slave3 redis]# redis-server /etc/redis/9857/redis.conf\n[root@Slave3 redis]# redis-server /etc/redis/9858/redis.conf</code></pre>\n<h3 id=\"9857\"><a href=\"#9857\" class=\"headerlink\" title=\"9857\"></a><strong>9857</strong></h3><pre><code class=\"shell\">redis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/3.png\" alt></p>\n<h3 id=\"9857-\"><a href=\"#9857-\" class=\"headerlink\" title=\"9857()\"></a><strong>9857()</strong></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a><strong>1</strong></h4><p>985798573mastermasermaster</p>\n<p><strong>9857</strong></p>\n<pre><code class=\"shell\">redis-cli --cluster reshard 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/4.png\" alt></p>\n<p><strong></strong> <br></p>\n<ul>\n<li>all</li>\n<li>done</li>\n</ul>\n<p>all100033333333349857done985710009857</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a><strong>2</strong></h4><p><font color=\"red\"></font></p>\n<pre><code class=\"shell\">redis-cli --cluster add-node 10.8.198.152:9857 10.8.198.152:9851</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/3.png\" alt></p>\n<p>19851KEY</p>\n<pre><code class=\"shell\">#cluster getkeysinslot  \n10.8.198.152:9851&gt;cluster getkeysinslot 1000 2000\n(empty list or set)</code></pre>\n<p>29857cluster setslot  importing id98571000importing</p>\n<pre><code>10.8.198.152:9857&gt;cluster setslot 1000 importing 419ff0823f0ff4cfb1ffc4c002665ad077911cc2</code></pre><p><img src=\"/2020/09/02/redis-cluster-build-2/8.png\" alt></p>\n<p>39851cluster setslot  migrating id9851460migrating</p>\n<pre><code class=\"shell\">10.8.198.152:9851&gt;cluster setslot 1000 migrating 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da</code></pre>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/9.png\" alt></p>\n<p>4<strong>cluster setslot  node id</strong>1000</p>\n<pre><code class=\"shell\"># 9851idid\n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851&gt; cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n#9857idid\n[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857&gt; cluster setslot 1000 node 5e2af503c816eeff7ed2cfb2249f0ceb1f5306da\nOK\n10.8.198.152:9857&gt; cluster nodes\nf08cdba85763f71de3a1cbac8a45962594ab09aa 10.8.198.152:9852@19852 master - 0 1599038877000 2 connected 5461-10922\nb8cc9aeca57e1332b6f42b7e183cce686033c2d6 10.8.198.152:9854@19854 slave 419ff0823f0ff4cfb1ffc4c002665ad077911cc2 0 1599038878000 1 connected\n286fe16d33dbbafa9f13e9a11d4351c37e085155 10.8.198.152:9853@19853 master - 0 1599038879000 3 connected 10923-16383\naf6115f83a145c63a75916608084712f96d44c34 10.8.198.152:9855@19855 slave f08cdba85763f71de3a1cbac8a45962594ab09aa 0 1599038879489 2 connected\n5e2af503c816eeff7ed2cfb2249f0ceb1f5306da 10.8.198.152:9857@19857 myself,master - 0 1599038878000 7 connected 1000\n14901a2ff5242f302103bbca4bfa6e2dade0a95b 10.8.198.152:9856@19856 slave 286fe16d33dbbafa9f13e9a11d4351c37e085155 0 1599038880000 3 connected\n419ff0823f0ff4cfb1ffc4c002665ad077911cc2 10.8.198.152:9851@19851 master - 0 1599038880492 1 connected 0-999 1001-5460</code></pre>\n<h3 id=\"9857-\"><a href=\"#9857-\" class=\"headerlink\" title=\"9857()\"></a><strong>9857()</strong></h3><p><font color=\"red\">9851100098579851key</font></p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/5.png\" alt=\"2\"></p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a><strong>1</strong></h4><p></p>\n<ol>\n<li>9851keyflushdb</li>\n<li> redis-cli --cluster fix 10.8.198.152:9851 </li>\n<li> redis-cli --cluster reshard 10.8.198.152.9851 </li>\n</ol>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a><strong>2</strong></h4><p>98516549857</p>\n<p>9857</p>\n<pre><code class=\"shell\"> redis-cli --cluster add-node 10.8.198.1529857 10.8.198.1529851</code></pre>\n<p>cluster nodes</p>\n<pre><code class=\"shell\">10.8.198.152:9851&gt; cluster nodes\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040212180 5 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040210000 3 connected 10923-16383\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040210175 2 connected 5461-10922\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040212000 4 connected\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 myself,master - 0 1599040211000 1 connected 0-5460\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 master - 0 1599040211000 0 connected\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040213182 6 connected</code></pre>\n<p>1654</p>\n<pre><code class=\"shell\">#cluster getkeysinslot  \n[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851&gt; cluster getkeysinslot 654 2000\n1) &quot;\\xac\\xed\\x00\\x05t\\x00\\tkey_45618&quot;</code></pre>\n<p>29857cluster setslot  importing id8000654importing</p>\n<pre><code class=\"shell\">[root@Slave3 redis]# redis-cli -p 9857 -h 10.8.198.152\n10.8.198.152:9857&gt; cluster setslot 654 importing 5015fbe7c523681a59e13f86f0ddc27b1ac542f8\nOK</code></pre>\n<p>39851cluster setslot  migrating id9851654migrating</p>\n<pre><code class=\"shell\">[root@Slave3 redis]# redis-cli -p 9851 -h 10.8.198.152\n10.8.198.152:9851&gt; cluster setslot 654 migrating 0a286334e831f426de9e30c7990cffb40a1e4102\nOK</code></pre>\n<p>4<strong>9851</strong>741key-valuekeymap{:[age,]}9857</p>\n<ul>\n<li>hostRedisIP</li>\n<li>portRedis</li>\n<li>key|Redis 3.0.6 </li>\n<li>destination-dbRedis</li>\n<li>timeout</li>\n<li>copy</li>\n<li>replace<code>migrate</code>Redis</li>\n<li>keys<code>keys key1 key2 key3</code></li>\n</ul>\n<pre><code class=\"shell\">10.8.198.152:9851&gt; migrate 10.8.198.152 9857 &quot;&quot; 0 1000 keys &quot;\\xac\\xed\\x00\\x05t\\x00\\tkey_45618&quot;\nOK</code></pre>\n<p>5</p>\n<pre><code class=\"shell\">10.8.198.152:9851&gt; cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857&gt; cluster setslot 654 node 0a286334e831f426de9e30c7990cffb40a1e4102\nOK\n10.8.198.152:9857&gt; cluster nodes\nbb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 10.8.198.152:9852@19852 master - 0 1599040905000 2 connected 5461-10922\n5bc658cd4d8cc35097e0a79e140069262161b827 10.8.198.152:9855@19855 slave bb3900b30983e0b41ed48ffe4be0e2d52b4d89b4 0 1599040909085 2 connected\n1f797b67ba0ae4966610d8596431980f5cce4858 10.8.198.152:9854@19854 slave 5015fbe7c523681a59e13f86f0ddc27b1ac542f8 0 1599040906000 1 connected\na26317d89a7b09c0c9d77139cd8be94588c9b127 10.8.198.152:9853@19853 master - 0 1599040908083 3 connected 10923-16383\n5015fbe7c523681a59e13f86f0ddc27b1ac542f8 10.8.198.152:9851@19851 master - 0 1599040907082 1 connected 0-653 655-5460\n150ef7fd331f57f3d11e8b2372ba991c41c850d7 10.8.198.152:9856@19856 slave a26317d89a7b09c0c9d77139cd8be94588c9b127 0 1599040907000 3 connected\n0a286334e831f426de9e30c7990cffb40a1e4102 10.8.198.152:9857@19857 myself,master - 0 1599040907000 7 connected 654</code></pre>\n<p><font color=\"red\">KEYmigrate</font></p>\n<h3 id=\"98579858\"><a href=\"#98579858\" class=\"headerlink\" title=\"98579858\"></a><strong>98579858</strong></h3><p>985798589857</p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/6.png\" alt></p>\n<p>:</p>\n<p>9858</p>\n<pre><code class=\"shell\">redis-cli --cluster add-node 10.8.198.152:9858 10.8.198.152:9851</code></pre>\n<p>9858</p>\n<pre><code class=\"shell\">redis-cli -p 9858 -h 10.8.198.152</code></pre>\n<p>98589857</p>\n<pre><code class=\"shell\">10.8.198.152:9858&gt; cluster replicate 9857ID</code></pre>\n<p></p>\n<p><img src=\"/2020/09/02/redis-cluster-build-2/7.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"KEY\"><a href=\"#KEY\" class=\"headerlink\" title=\"KEY\"></a>KEY</h3><pre><code class=\"shell\">10.8.198.152:9851&gt; cluster keyslot keyname</code></pre>"},{"title":"Redis","description":"Redis","date":"2019-10-03T00:32:58.000Z","_content":"\n### key\n\n```properties\n# key\n$ localhost:6379> EXISTS hash1\n(integer) 1\n$ localhost:6379> EXISTS jjj\n(integer) 0\n\n# key\n$ localhost:6379> DEL hash1\n(integer) 1\n$ localhost:6379> EXISTS hash1\n(integer) 0\n\n# key\n$ localhost:6379> set t1 value ex 5\nOK\n\n# key\n$ localhost:6379> TTL t1\n(integer) 7\n\n# key\n$ localhost:6379> type t1\nstring\n```\n<!--more-->\n### kv\n\n```properties\n# key value\n$ localhost:6379> set key1 value1\nOK\n\n# keyvalue\n$ localhost:6379> get key1\n\"value1\"\n\n# Redis Setex  key  key  SETEX \n$ localhost:6379> SETEX mykey 60 redis\nOK\n\n#  key  key \n$ localhost:6379> setnx key3 vlaue3\nOK\n$ localhost:6379> setnx key3 value3\n(nil)\n```\n\n### list\n\n```properties\n# \n$ localhost:6379> LPUSH list1 1\n(integer) 1\n\n# \n$ localhost:6379> RPUSH list1 2\n(integer) 2\n\n# -1 \n$ localhost:6379> LRANGE list1 0 -1\n1) \"1\"\n2) \"2\"\n\n# list\n$ localhost:6379> LLEN list1\n(integer) 2\n\n# 'nil'\n$ localhost:6379> LINDEX list1 0\n\"2\"\n\n# \n$ 127.0.0.1:6379> LPOP list1\n\"5\"\n\n# \n$ 127.0.0.1:6379> RPOP list1\n\"1\"\n\n# \n$ localhost:6379> LRANGE list1 0 -1\n1) \"three\"\n2) \"two\"\n3) \"one\"\n$ localhost:6379> RPOPLPUSH list1 list2\n\"one\"\n$ localhost:6379> LRANGE list2 0 -1\n1) \"one\"\n```\n\n### set\n\n```properties\n# set\n$ localhost:6379> SADD set1 'one' 'two' 'three'\n(integer) 3\n\n# set\n$ localhost:6379> SMEMBERS set1\n1) \"one\"\n2) \"three\"\n3) \"two\n\n# set\n$ localhost:6379> SREM set1 'one'\n(integer) 1\n\n# set\n$ localhost:6379> SPOP set1 1\n1) \"three\"\n\n# set\n$ localhost:6379> SCARD set1\n(integer) 3\n\n# set\n$ localhost:6379> SRANDMEMBER set1 1\n1) \"one\"\n$ localhost:6379> SMEMBERS set1\n1) \"three\"\n2) \"two\"\n3) \"one\"\n\n# set10\n$ localhost:6379> SISMEMBER set1 'one'\n(integer) 1\n$ localhost:6379> SISMEMBER set1 '4'\n(integer) 0\n```\n\n### sorted set  \n\n```properties\n# \n$ localhost:6379> ZADD zset1 1 'one'\n(integer) 1\n\n# \n$ localhost:6379> ZRANGE zset1 0 -1\n1) \"one\"\n2) \"two\"\n3) \"three\"\n\n# \n$ localhost:6379> ZREM zset1 'one'\n(integer) 1\n\n# \n$ localhost:6379> ZCARD zset1\n(integer) 2\n\n# \n$ localhost:6379> ZINCRBY zset1 2 \"one\"\n\"4\"\n$ localhost:6379> ZRANGE zset1 0 -1 WITHSCORES\n1) \"two\"\n2) \"2\"\n3) \"three\"\n4) \"3\"\n5) \"one\"\n6) \"4\"\n\n# \n$ localhost:6379> ZCOUNT zset1 0 2\n(integer) 1\n\n# \n$ localhost:6379> ZRANK zset1 'one'\n(integer) 2\n\n# \n$ localhost:6379> ZREVRANK zset1 'one'\n(integer) 0\n\n# \n$ localhost:6379> ZSCORE zset1 'one'\n\"4\"\n```\n\n### hash\n\n```properties\n# hash\n$ localhost:6379> HSET hash1 field1 1\n(integer) 1\n\n# hash\n$ localhost:6379> HMSET hash1 field2 2 field3 3\nOK\n\n# fieldvalue\n$ localhost:6379> HGET hash1 field1\n\"1\"\n\n# fieldvalue\n$ localhost:6379> HMGET hash1 field1 field2 field3\n1) \"1\"\n2) \"2\"\n3) \"3\"\n\n# hash\n$ localhost:6379> HGETALL hash1\n1) \"filed1\"\n2) \"1\"\n3) \"filed2\"\n4) \"2\"\n5) \"filed3\"\n6) \"3\"\n7) \"field3\"\n8) \"3\"\n\n# filedHash\n$ localhost:6379> HEXISTS hash1 field1\n(integer) 1\n$ localhost:6379> HEXISTS hash1 field5\n(integer) 0\n\n# hashfield\n$ localhost:6379> HDEL hash1 field1 field2\n(integer) 2\n\n# hashfieldvalue\n$ localhost:6379> HINCRBY hash1 field1 2\n(integer) 3\n$ localhost:6379> HGET hash1 field1\n\"3\"\n\n# hashkey\n$ localhost:6379> HKEYS hash1\n1) \"filed1\"\n2) \"filed2\"\n3) \"filed3\"\n4) \"field3\"\n5) \"field1\"\n\n$ hashvalue\n$ localhost:6379> HVALS hash1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"3\"\n5) \"3\"\n\n# hash\n$ localhost:6379> HLEN hash1\n(integer) 5\n```\n\n### \n\n : http://redis.cn/commands.html","source":"_posts/redis-commons.md","raw":"---\ntitle: Redis\ntags:\n  - redis\ncategories: redis\ndescription : Redis\ndate: 2019-10-03 08:32:58\n---\n\n### key\n\n```properties\n# key\n$ localhost:6379> EXISTS hash1\n(integer) 1\n$ localhost:6379> EXISTS jjj\n(integer) 0\n\n# key\n$ localhost:6379> DEL hash1\n(integer) 1\n$ localhost:6379> EXISTS hash1\n(integer) 0\n\n# key\n$ localhost:6379> set t1 value ex 5\nOK\n\n# key\n$ localhost:6379> TTL t1\n(integer) 7\n\n# key\n$ localhost:6379> type t1\nstring\n```\n<!--more-->\n### kv\n\n```properties\n# key value\n$ localhost:6379> set key1 value1\nOK\n\n# keyvalue\n$ localhost:6379> get key1\n\"value1\"\n\n# Redis Setex  key  key  SETEX \n$ localhost:6379> SETEX mykey 60 redis\nOK\n\n#  key  key \n$ localhost:6379> setnx key3 vlaue3\nOK\n$ localhost:6379> setnx key3 value3\n(nil)\n```\n\n### list\n\n```properties\n# \n$ localhost:6379> LPUSH list1 1\n(integer) 1\n\n# \n$ localhost:6379> RPUSH list1 2\n(integer) 2\n\n# -1 \n$ localhost:6379> LRANGE list1 0 -1\n1) \"1\"\n2) \"2\"\n\n# list\n$ localhost:6379> LLEN list1\n(integer) 2\n\n# 'nil'\n$ localhost:6379> LINDEX list1 0\n\"2\"\n\n# \n$ 127.0.0.1:6379> LPOP list1\n\"5\"\n\n# \n$ 127.0.0.1:6379> RPOP list1\n\"1\"\n\n# \n$ localhost:6379> LRANGE list1 0 -1\n1) \"three\"\n2) \"two\"\n3) \"one\"\n$ localhost:6379> RPOPLPUSH list1 list2\n\"one\"\n$ localhost:6379> LRANGE list2 0 -1\n1) \"one\"\n```\n\n### set\n\n```properties\n# set\n$ localhost:6379> SADD set1 'one' 'two' 'three'\n(integer) 3\n\n# set\n$ localhost:6379> SMEMBERS set1\n1) \"one\"\n2) \"three\"\n3) \"two\n\n# set\n$ localhost:6379> SREM set1 'one'\n(integer) 1\n\n# set\n$ localhost:6379> SPOP set1 1\n1) \"three\"\n\n# set\n$ localhost:6379> SCARD set1\n(integer) 3\n\n# set\n$ localhost:6379> SRANDMEMBER set1 1\n1) \"one\"\n$ localhost:6379> SMEMBERS set1\n1) \"three\"\n2) \"two\"\n3) \"one\"\n\n# set10\n$ localhost:6379> SISMEMBER set1 'one'\n(integer) 1\n$ localhost:6379> SISMEMBER set1 '4'\n(integer) 0\n```\n\n### sorted set  \n\n```properties\n# \n$ localhost:6379> ZADD zset1 1 'one'\n(integer) 1\n\n# \n$ localhost:6379> ZRANGE zset1 0 -1\n1) \"one\"\n2) \"two\"\n3) \"three\"\n\n# \n$ localhost:6379> ZREM zset1 'one'\n(integer) 1\n\n# \n$ localhost:6379> ZCARD zset1\n(integer) 2\n\n# \n$ localhost:6379> ZINCRBY zset1 2 \"one\"\n\"4\"\n$ localhost:6379> ZRANGE zset1 0 -1 WITHSCORES\n1) \"two\"\n2) \"2\"\n3) \"three\"\n4) \"3\"\n5) \"one\"\n6) \"4\"\n\n# \n$ localhost:6379> ZCOUNT zset1 0 2\n(integer) 1\n\n# \n$ localhost:6379> ZRANK zset1 'one'\n(integer) 2\n\n# \n$ localhost:6379> ZREVRANK zset1 'one'\n(integer) 0\n\n# \n$ localhost:6379> ZSCORE zset1 'one'\n\"4\"\n```\n\n### hash\n\n```properties\n# hash\n$ localhost:6379> HSET hash1 field1 1\n(integer) 1\n\n# hash\n$ localhost:6379> HMSET hash1 field2 2 field3 3\nOK\n\n# fieldvalue\n$ localhost:6379> HGET hash1 field1\n\"1\"\n\n# fieldvalue\n$ localhost:6379> HMGET hash1 field1 field2 field3\n1) \"1\"\n2) \"2\"\n3) \"3\"\n\n# hash\n$ localhost:6379> HGETALL hash1\n1) \"filed1\"\n2) \"1\"\n3) \"filed2\"\n4) \"2\"\n5) \"filed3\"\n6) \"3\"\n7) \"field3\"\n8) \"3\"\n\n# filedHash\n$ localhost:6379> HEXISTS hash1 field1\n(integer) 1\n$ localhost:6379> HEXISTS hash1 field5\n(integer) 0\n\n# hashfield\n$ localhost:6379> HDEL hash1 field1 field2\n(integer) 2\n\n# hashfieldvalue\n$ localhost:6379> HINCRBY hash1 field1 2\n(integer) 3\n$ localhost:6379> HGET hash1 field1\n\"3\"\n\n# hashkey\n$ localhost:6379> HKEYS hash1\n1) \"filed1\"\n2) \"filed2\"\n3) \"filed3\"\n4) \"field3\"\n5) \"field1\"\n\n$ hashvalue\n$ localhost:6379> HVALS hash1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"3\"\n5) \"3\"\n\n# hash\n$ localhost:6379> HLEN hash1\n(integer) 5\n```\n\n### \n\n : http://redis.cn/commands.html","slug":"redis-commons","published":1,"updated":"2021-04-08T00:47:06.947Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvl002sqwv2gc3fal4k","content":"<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># key</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> EXISTS hash1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> EXISTS jjj</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">0</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># key</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> DEL hash1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> EXISTS hash1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">0</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># key</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> set t1 value ex 5</span>\nOK\n\n<span class=\"token comment\" spellcheck=\"true\"># key</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> TTL t1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">7</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># key</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> type t1</span>\nstring</code></pre>\n<a id=\"more\"></a>\n<h3 id=\"kv\"><a href=\"#kv\" class=\"headerlink\" title=\"kv\"></a>kv</h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># key value</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> set key1 value1</span>\nOK\n\n<span class=\"token comment\" spellcheck=\"true\"># keyvalue</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> get key1</span>\n\"value1\"\n\n<span class=\"token comment\" spellcheck=\"true\"># Redis Setex  key  key  SETEX </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SETEX mykey 60 redis</span>\nOK\n\n<span class=\"token comment\" spellcheck=\"true\">#  key  key </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> setnx key3 vlaue3</span>\nOK\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> setnx key3 value3</span>\n(nil)</code></pre>\n<h3 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LPUSH list1 1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> RPUSH list1 2</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">2</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># -1 </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LRANGE list1 0 -1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"1\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"2\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># list</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LLEN list1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">2</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># 'nil'</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LINDEX list1 0</span>\n\"2\"\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">127.0.0.1:6379> LPOP list1</span>\n\"5\"\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">127.0.0.1:6379> RPOP list1</span>\n\"1\"\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LRANGE list1 0 -1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"three\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"two\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"one\"</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> RPOPLPUSH list1 list2</span>\n\"one\"\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> LRANGE list2 0 -1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"one\"</span></code></pre>\n<h3 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"set\"></a>set</h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SADD set1 'one' 'two' 'three'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">3</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SMEMBERS set1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"one\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"three\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"two</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SREM set1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SPOP set1 1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"three\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SCARD set1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">3</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SRANDMEMBER set1 1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"one\"</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SMEMBERS set1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"three\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"two\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"one\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># set10</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SISMEMBER set1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> SISMEMBER set1 '4'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">0</span></code></pre>\n<h3 id=\"sorted-set-\"><a href=\"#sorted-set-\" class=\"headerlink\" title=\"sorted set  \"></a>sorted set  </h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZADD zset1 1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZRANGE zset1 0 -1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"one\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"two\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"three\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZREM zset1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZCARD zset1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">2</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZINCRBY zset1 2 \"one\"</span>\n\"4\"\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZRANGE zset1 0 -1 WITHSCORES</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"two\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"2\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"three\"</span>\n<span class=\"token attr-name\">4)</span> <span class=\"token attr-value\">\"3\"</span>\n<span class=\"token attr-name\">5)</span> <span class=\"token attr-value\">\"one\"</span>\n<span class=\"token attr-name\">6)</span> <span class=\"token attr-value\">\"4\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZCOUNT zset1 0 2</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZRANK zset1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">2</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZREVRANK zset1 'one'</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">0</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># </span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> ZSCORE zset1 'one'</span>\n\"4\"</code></pre>\n<h3 id=\"hash\"><a href=\"#hash\" class=\"headerlink\" title=\"hash\"></a>hash</h3><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># hash</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HSET hash1 field1 1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># hash</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HMSET hash1 field2 2 field3 3</span>\nOK\n\n<span class=\"token comment\" spellcheck=\"true\"># fieldvalue</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HGET hash1 field1</span>\n\"1\"\n\n<span class=\"token comment\" spellcheck=\"true\"># fieldvalue</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HMGET hash1 field1 field2 field3</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"1\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"2\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"3\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># hash</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HGETALL hash1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"filed1\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"1\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"filed2\"</span>\n<span class=\"token attr-name\">4)</span> <span class=\"token attr-value\">\"2\"</span>\n<span class=\"token attr-name\">5)</span> <span class=\"token attr-value\">\"filed3\"</span>\n<span class=\"token attr-name\">6)</span> <span class=\"token attr-value\">\"3\"</span>\n<span class=\"token attr-name\">7)</span> <span class=\"token attr-value\">\"field3\"</span>\n<span class=\"token attr-name\">8)</span> <span class=\"token attr-value\">\"3\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># filedHash</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HEXISTS hash1 field1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">1</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HEXISTS hash1 field5</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">0</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># hashfield</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HDEL hash1 field1 field2</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">2</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># hashfieldvalue</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HINCRBY hash1 field1 2</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">3</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HGET hash1 field1</span>\n\"3\"\n\n<span class=\"token comment\" spellcheck=\"true\"># hashkey</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HKEYS hash1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"filed1\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"filed2\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"filed3\"</span>\n<span class=\"token attr-name\">4)</span> <span class=\"token attr-value\">\"field3\"</span>\n<span class=\"token attr-name\">5)</span> <span class=\"token attr-value\">\"field1\"</span>\n\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">hashvalue</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HVALS hash1</span>\n<span class=\"token attr-name\">1)</span> <span class=\"token attr-value\">\"1\"</span>\n<span class=\"token attr-name\">2)</span> <span class=\"token attr-value\">\"2\"</span>\n<span class=\"token attr-name\">3)</span> <span class=\"token attr-value\">\"3\"</span>\n<span class=\"token attr-name\">4)</span> <span class=\"token attr-value\">\"3\"</span>\n<span class=\"token attr-name\">5)</span> <span class=\"token attr-value\">\"3\"</span>\n\n<span class=\"token comment\" spellcheck=\"true\"># hash</span>\n<span class=\"token attr-name\">$</span> <span class=\"token attr-value\">localhost:6379> HLEN hash1</span>\n<span class=\"token attr-name\">(integer)</span> <span class=\"token attr-value\">5</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> : <a href=\"http://redis.cn/commands.html\" target=\"_blank\" rel=\"noopener\">http://redis.cn/commands.html</a></p>\n","site":{"data":{}},"excerpt":"<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><pre><code class=\"properties\"># key\n$ localhost:6379&gt; EXISTS hash1\n(integer) 1\n$ localhost:6379&gt; EXISTS jjj\n(integer) 0\n\n# key\n$ localhost:6379&gt; DEL hash1\n(integer) 1\n$ localhost:6379&gt; EXISTS hash1\n(integer) 0\n\n# key\n$ localhost:6379&gt; set t1 value ex 5\nOK\n\n# key\n$ localhost:6379&gt; TTL t1\n(integer) 7\n\n# key\n$ localhost:6379&gt; type t1\nstring</code></pre>","more":"<h3 id=\"kv\"><a href=\"#kv\" class=\"headerlink\" title=\"kv\"></a>kv</h3><pre><code class=\"properties\"># key value\n$ localhost:6379&gt; set key1 value1\nOK\n\n# keyvalue\n$ localhost:6379&gt; get key1\n&quot;value1&quot;\n\n# Redis Setex  key  key  SETEX \n$ localhost:6379&gt; SETEX mykey 60 redis\nOK\n\n#  key  key \n$ localhost:6379&gt; setnx key3 vlaue3\nOK\n$ localhost:6379&gt; setnx key3 value3\n(nil)</code></pre>\n<h3 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h3><pre><code class=\"properties\"># \n$ localhost:6379&gt; LPUSH list1 1\n(integer) 1\n\n# \n$ localhost:6379&gt; RPUSH list1 2\n(integer) 2\n\n# -1 \n$ localhost:6379&gt; LRANGE list1 0 -1\n1) &quot;1&quot;\n2) &quot;2&quot;\n\n# list\n$ localhost:6379&gt; LLEN list1\n(integer) 2\n\n# &#39;nil&#39;\n$ localhost:6379&gt; LINDEX list1 0\n&quot;2&quot;\n\n# \n$ 127.0.0.1:6379&gt; LPOP list1\n&quot;5&quot;\n\n# \n$ 127.0.0.1:6379&gt; RPOP list1\n&quot;1&quot;\n\n# \n$ localhost:6379&gt; LRANGE list1 0 -1\n1) &quot;three&quot;\n2) &quot;two&quot;\n3) &quot;one&quot;\n$ localhost:6379&gt; RPOPLPUSH list1 list2\n&quot;one&quot;\n$ localhost:6379&gt; LRANGE list2 0 -1\n1) &quot;one&quot;</code></pre>\n<h3 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"set\"></a>set</h3><pre><code class=\"properties\"># set\n$ localhost:6379&gt; SADD set1 &#39;one&#39; &#39;two&#39; &#39;three&#39;\n(integer) 3\n\n# set\n$ localhost:6379&gt; SMEMBERS set1\n1) &quot;one&quot;\n2) &quot;three&quot;\n3) &quot;two\n\n# set\n$ localhost:6379&gt; SREM set1 &#39;one&#39;\n(integer) 1\n\n# set\n$ localhost:6379&gt; SPOP set1 1\n1) &quot;three&quot;\n\n# set\n$ localhost:6379&gt; SCARD set1\n(integer) 3\n\n# set\n$ localhost:6379&gt; SRANDMEMBER set1 1\n1) &quot;one&quot;\n$ localhost:6379&gt; SMEMBERS set1\n1) &quot;three&quot;\n2) &quot;two&quot;\n3) &quot;one&quot;\n\n# set10\n$ localhost:6379&gt; SISMEMBER set1 &#39;one&#39;\n(integer) 1\n$ localhost:6379&gt; SISMEMBER set1 &#39;4&#39;\n(integer) 0</code></pre>\n<h3 id=\"sorted-set-\"><a href=\"#sorted-set-\" class=\"headerlink\" title=\"sorted set  \"></a>sorted set  </h3><pre><code class=\"properties\"># \n$ localhost:6379&gt; ZADD zset1 1 &#39;one&#39;\n(integer) 1\n\n# \n$ localhost:6379&gt; ZRANGE zset1 0 -1\n1) &quot;one&quot;\n2) &quot;two&quot;\n3) &quot;three&quot;\n\n# \n$ localhost:6379&gt; ZREM zset1 &#39;one&#39;\n(integer) 1\n\n# \n$ localhost:6379&gt; ZCARD zset1\n(integer) 2\n\n# \n$ localhost:6379&gt; ZINCRBY zset1 2 &quot;one&quot;\n&quot;4&quot;\n$ localhost:6379&gt; ZRANGE zset1 0 -1 WITHSCORES\n1) &quot;two&quot;\n2) &quot;2&quot;\n3) &quot;three&quot;\n4) &quot;3&quot;\n5) &quot;one&quot;\n6) &quot;4&quot;\n\n# \n$ localhost:6379&gt; ZCOUNT zset1 0 2\n(integer) 1\n\n# \n$ localhost:6379&gt; ZRANK zset1 &#39;one&#39;\n(integer) 2\n\n# \n$ localhost:6379&gt; ZREVRANK zset1 &#39;one&#39;\n(integer) 0\n\n# \n$ localhost:6379&gt; ZSCORE zset1 &#39;one&#39;\n&quot;4&quot;</code></pre>\n<h3 id=\"hash\"><a href=\"#hash\" class=\"headerlink\" title=\"hash\"></a>hash</h3><pre><code class=\"properties\"># hash\n$ localhost:6379&gt; HSET hash1 field1 1\n(integer) 1\n\n# hash\n$ localhost:6379&gt; HMSET hash1 field2 2 field3 3\nOK\n\n# fieldvalue\n$ localhost:6379&gt; HGET hash1 field1\n&quot;1&quot;\n\n# fieldvalue\n$ localhost:6379&gt; HMGET hash1 field1 field2 field3\n1) &quot;1&quot;\n2) &quot;2&quot;\n3) &quot;3&quot;\n\n# hash\n$ localhost:6379&gt; HGETALL hash1\n1) &quot;filed1&quot;\n2) &quot;1&quot;\n3) &quot;filed2&quot;\n4) &quot;2&quot;\n5) &quot;filed3&quot;\n6) &quot;3&quot;\n7) &quot;field3&quot;\n8) &quot;3&quot;\n\n# filedHash\n$ localhost:6379&gt; HEXISTS hash1 field1\n(integer) 1\n$ localhost:6379&gt; HEXISTS hash1 field5\n(integer) 0\n\n# hashfield\n$ localhost:6379&gt; HDEL hash1 field1 field2\n(integer) 2\n\n# hashfieldvalue\n$ localhost:6379&gt; HINCRBY hash1 field1 2\n(integer) 3\n$ localhost:6379&gt; HGET hash1 field1\n&quot;3&quot;\n\n# hashkey\n$ localhost:6379&gt; HKEYS hash1\n1) &quot;filed1&quot;\n2) &quot;filed2&quot;\n3) &quot;filed3&quot;\n4) &quot;field3&quot;\n5) &quot;field1&quot;\n\n$ hashvalue\n$ localhost:6379&gt; HVALS hash1\n1) &quot;1&quot;\n2) &quot;2&quot;\n3) &quot;3&quot;\n4) &quot;3&quot;\n5) &quot;3&quot;\n\n# hash\n$ localhost:6379&gt; HLEN hash1\n(integer) 5</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> : <a href=\"http://redis.cn/commands.html\" target=\"_blank\" rel=\"noopener\">http://redis.cn/commands.html</a></p>"},{"title":"Redis","description":"Redis","date":"2020-10-03T00:32:58.000Z","_content":"### \n\nRedisRedisRedis\n\n### \n\n#### \n\nRedis6<font color=red></font>Redis\n\n`SET msg \"helloWorld\"`msgRedishelloWorld``6Redis\n<!--more-->\n#### \n\n```c\nstruct sdshdr{\n    //bufSDS\n\tint len;\n    //buf\n    int free;\n    //\n    char buf[];\n}\n```\n\n![](redis-data-type/2.png)\n\nRedislenfreebufC\n\n****\n\nlenlen`strlen`key\n\nRedisCCstrlen(str)O(N) SDS  `len`  **O(1)**\n\n```reStructuredText\n127.0.0.1:6379> strlen msg\n(integer) 11\n```\n\n****\n\nCN+1CRedis\n\nSDSbufN+1freeRedisfree\n\nSDS``  ``\n\n#### \n\n\n\n```c\ntypedef struct dict {\n    dictType *type;\n    void *privdata;\n    //\n    dictht ht[2];\n    int trehashidx;\n}\ntypedef struct dictht {\n    //\n\tdictEntry **table;\n    //\n    unsigned long size;\n    // size - 1\n    unsigned long sizemask;\n    //\n    unsigned long used;\n} dictht;\n\n//\ntypedef struct dictEntry{\n    void *key;\n    union {\n        void *val;\n        uint64_tu64;\n        int64_ts64;\n    } v;\n    //\n    struct dictEntry *next;\n}\n\n```\n\n![](redis-data-type/1.png)\n\n- 4<font color=red></font>\n- ht[0]ht[1]rehash\n- RedisrehashrehashRedis****\n\n +\n\n#### \n\n********Redis****\n\n```c\ntypedef struct intset{\n    uint32_t encoding;\n    //\n    uint32_t length;\n    //\n    int8_t contents[];\n}\n```\n\n#### \n\n \n\n#### \n\nRedis````````****\n\n\n\n512**O(N)N**\n\n![](redis-data-type/3.png)\n\n|                   |                                       |\n| --------------------- | ----------------------------------------- |\n| zlbytes               |           |\n| zltail                |   |\n| zllen                 |                 |\n| entryN                |                                       |\n| zlend                 |                     |\n| previous_entry_length |                       |\n| encoding              | content |\n| content               |       |\n\n\n\n#### \n\n![](redis-data-type/4.png)\n\nRedis``value\n\n### Redis\n\nRedis556RedisredisObject\n\n```c\ntypedef struct redisObject{\n    //\n    //type key \n    unsigned type:4;\n    //\n    //object encoding key \n    unsigned encoding:4;\n    //\n    void *ptr;\n}\n```\n\n#### \n\nintrwaembstr\n\n- valueintlong\n- value39SDS()raw\n- value39SDS()embstr\n\n#### \n\n````\n\n- 64\n- 512\n\n\n\n#### \n\n````\n\n- 64\n- 512\n\n![ziplist](redis-data-type/5.png)\n\n\n\n#### \n\n````\n\n- \n- 512\n\n#### \n\n````\n\n- 128\n- 64\n\n### redis\n\n```\n127.0.0.1:6379> lpush list1 1\n(integer) 1\n127.0.0.1:6379> object encoding list1\n\"quicklist\"\n127.0.0.1:6379> sadd set1 one two three\n(integer) 3\n127.0.0.1:6379> object encoding set1\n\"hashtable\"\n127.0.0.1:6379> hset hash1 field1 1\n(integer) 1\n127.0.0.1:6379> object encoding hash1\n\"ziplist\"\n127.0.0.1:6379> set name xuzy\nOK\n127.0.0.1:6379> object encoding name\n\"embstr\"\n```\n\n\n\n### \n\n**RedisRedis**\n\n\n\n**1**\n\nRedisSDSSDSCSDSC\n\n****\n\n### \n\n- Redis\n- Redis[Redis()](https://www.cnblogs.com/hunternet/p/12742390.html)","source":"_posts/redis-data-type.md","raw":"---\ntitle: Redis\ntags:\n  - redis\ncategories: redis\ndescription : Redis\ndate: 2020-10-03 08:32:58\n---\n### \n\nRedisRedisRedis\n\n### \n\n#### \n\nRedis6<font color=red></font>Redis\n\n`SET msg \"helloWorld\"`msgRedishelloWorld``6Redis\n<!--more-->\n#### \n\n```c\nstruct sdshdr{\n    //bufSDS\n\tint len;\n    //buf\n    int free;\n    //\n    char buf[];\n}\n```\n\n![](redis-data-type/2.png)\n\nRedislenfreebufC\n\n****\n\nlenlen`strlen`key\n\nRedisCCstrlen(str)O(N) SDS  `len`  **O(1)**\n\n```reStructuredText\n127.0.0.1:6379> strlen msg\n(integer) 11\n```\n\n****\n\nCN+1CRedis\n\nSDSbufN+1freeRedisfree\n\nSDS``  ``\n\n#### \n\n\n\n```c\ntypedef struct dict {\n    dictType *type;\n    void *privdata;\n    //\n    dictht ht[2];\n    int trehashidx;\n}\ntypedef struct dictht {\n    //\n\tdictEntry **table;\n    //\n    unsigned long size;\n    // size - 1\n    unsigned long sizemask;\n    //\n    unsigned long used;\n} dictht;\n\n//\ntypedef struct dictEntry{\n    void *key;\n    union {\n        void *val;\n        uint64_tu64;\n        int64_ts64;\n    } v;\n    //\n    struct dictEntry *next;\n}\n\n```\n\n![](redis-data-type/1.png)\n\n- 4<font color=red></font>\n- ht[0]ht[1]rehash\n- RedisrehashrehashRedis****\n\n +\n\n#### \n\n********Redis****\n\n```c\ntypedef struct intset{\n    uint32_t encoding;\n    //\n    uint32_t length;\n    //\n    int8_t contents[];\n}\n```\n\n#### \n\n \n\n#### \n\nRedis````````****\n\n\n\n512**O(N)N**\n\n![](redis-data-type/3.png)\n\n|                   |                                       |\n| --------------------- | ----------------------------------------- |\n| zlbytes               |           |\n| zltail                |   |\n| zllen                 |                 |\n| entryN                |                                       |\n| zlend                 |                     |\n| previous_entry_length |                       |\n| encoding              | content |\n| content               |       |\n\n\n\n#### \n\n![](redis-data-type/4.png)\n\nRedis``value\n\n### Redis\n\nRedis556RedisredisObject\n\n```c\ntypedef struct redisObject{\n    //\n    //type key \n    unsigned type:4;\n    //\n    //object encoding key \n    unsigned encoding:4;\n    //\n    void *ptr;\n}\n```\n\n#### \n\nintrwaembstr\n\n- valueintlong\n- value39SDS()raw\n- value39SDS()embstr\n\n#### \n\n````\n\n- 64\n- 512\n\n\n\n#### \n\n````\n\n- 64\n- 512\n\n![ziplist](redis-data-type/5.png)\n\n\n\n#### \n\n````\n\n- \n- 512\n\n#### \n\n````\n\n- 128\n- 64\n\n### redis\n\n```\n127.0.0.1:6379> lpush list1 1\n(integer) 1\n127.0.0.1:6379> object encoding list1\n\"quicklist\"\n127.0.0.1:6379> sadd set1 one two three\n(integer) 3\n127.0.0.1:6379> object encoding set1\n\"hashtable\"\n127.0.0.1:6379> hset hash1 field1 1\n(integer) 1\n127.0.0.1:6379> object encoding hash1\n\"ziplist\"\n127.0.0.1:6379> set name xuzy\nOK\n127.0.0.1:6379> object encoding name\n\"embstr\"\n```\n\n\n\n### \n\n**RedisRedis**\n\n\n\n**1**\n\nRedisSDSSDSCSDSC\n\n****\n\n### \n\n- Redis\n- Redis[Redis()](https://www.cnblogs.com/hunternet/p/12742390.html)","slug":"redis-data-type","published":1,"updated":"2021-04-08T00:47:06.947Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvl002vqwv232lkay5s","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>RedisRedisRedis</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p>Redis6<font color=\"red\"></font>Redis</p>\n<p><code>SET msg &quot;helloWorld&quot;</code>msgRedishelloWorld<code></code>6Redis</p>\n<a id=\"more\"></a>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre class=\" language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> sdshdr<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//bufSDS</span>\n    <span class=\"token keyword\">int</span> len<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//buf</span>\n    <span class=\"token keyword\">int</span> free<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><img src=\"/2020/10/03/redis-data-type/2.png\" alt=\"\"></p>\n<p>RedislenfreebufC</p>\n<p><strong></strong></p>\n<p>lenlen<code>strlen</code>key</p>\n<p>RedisCCstrlen(str)O(N) SDS  <code>len</code>  <strong>O(1)</strong></p>\n<pre class=\" language-reStructuredText\"><code class=\"language-reStructuredText\">127.0.0.1:6379> strlen msg\n(integer) 11</code></pre>\n<p><strong></strong></p>\n<p>CN+1CRedis</p>\n<p>SDSbufN+1freeRedisfree</p>\n<p>SDS<code></code>  <code></code></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<pre class=\" language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> dict <span class=\"token punctuation\">{</span>\n    dictType <span class=\"token operator\">*</span>type<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>privdata<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    dictht ht<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> trehashidx<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> dictht <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    dictEntry <span class=\"token operator\">*</span><span class=\"token operator\">*</span>table<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> size<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// size - 1</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> sizemask<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> used<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> dictht<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> dictEntry<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>key<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>val<span class=\"token punctuation\">;</span>\n        uint64_tu64<span class=\"token punctuation\">;</span>\n        int64_ts64<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> v<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">struct</span> dictEntry <span class=\"token operator\">*</span>next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><img src=\"/2020/10/03/redis-data-type/1.png\" alt=\"\"></p>\n<ul>\n<li>4<font color=\"red\"></font></li>\n<li>ht[0]ht[1]rehash</li>\n<li>RedisrehashrehashRedis<strong></strong></li>\n</ul>\n<p> +</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong><strong></strong>Redis<strong></strong></p>\n<pre class=\" language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> intset<span class=\"token punctuation\">{</span>\n    uint32_t encoding<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    uint32_t length<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    int8_t contents<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Redis<code></code><code></code><code></code><code></code><strong></strong></p>\n<p></p>\n<p>512<strong>O(N)N</strong></p>\n<p><img src=\"/2020/10/03/redis-data-type/3.png\" alt=\"\"></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>zlbytes</td>\n<td></td>\n</tr>\n<tr>\n<td>zltail</td>\n<td></td>\n</tr>\n<tr>\n<td>zllen</td>\n<td></td>\n</tr>\n<tr>\n<td>entryN</td>\n<td></td>\n</tr>\n<tr>\n<td>zlend</td>\n<td></td>\n</tr>\n<tr>\n<td>previous_entry_length</td>\n<td></td>\n</tr>\n<tr>\n<td>encoding</td>\n<td>content</td>\n</tr>\n<tr>\n<td>content</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2020/10/03/redis-data-type/4.png\" alt=\"\"></p>\n<p>Redis<code></code>value</p>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>Redis556RedisredisObject</p>\n<pre class=\" language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> redisObject<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token comment\" spellcheck=\"true\">//type key </span>\n    <span class=\"token keyword\">unsigned</span> type<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token comment\" spellcheck=\"true\">//object encoding key </span>\n    <span class=\"token keyword\">unsigned</span> encoding<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>intrwaembstr</p>\n<ul>\n<li>valueintlong</li>\n<li>value39SDS()raw</li>\n<li>value39SDS()embstr</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>64</li>\n<li>512</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>64</li>\n<li>512</li>\n</ul>\n<p><img src=\"/2020/10/03/redis-data-type/5.png\" alt=\"ziplist\"></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li></li>\n<li>512</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>128</li>\n<li>64</li>\n</ul>\n<h3 id=\"redis\"><a href=\"#redis\" class=\"headerlink\" title=\"redis\"></a>redis</h3><pre><code>127.0.0.1:6379&gt; lpush list1 1\n(integer) 1\n127.0.0.1:6379&gt; object encoding list1\n&quot;quicklist&quot;\n127.0.0.1:6379&gt; sadd set1 one two three\n(integer) 3\n127.0.0.1:6379&gt; object encoding set1\n&quot;hashtable&quot;\n127.0.0.1:6379&gt; hset hash1 field1 1\n(integer) 1\n127.0.0.1:6379&gt; object encoding hash1\n&quot;ziplist&quot;\n127.0.0.1:6379&gt; set name xuzy\nOK\n127.0.0.1:6379&gt; object encoding name\n&quot;embstr&quot;</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>RedisRedis</strong></p>\n<p></p>\n<p><strong>1</strong></p>\n<p>RedisSDSSDSCSDSC</p>\n<hr>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>Redis</li>\n<li>Redis<a href=\"https://www.cnblogs.com/hunternet/p/12742390.html\" target=\"_blank\" rel=\"noopener\">Redis()</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>RedisRedisRedis</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h4><p>Redis6<font color=\"red\"></font>Redis</p>\n<p><code>SET msg &quot;helloWorld&quot;</code>msgRedishelloWorld<code></code>6Redis</p>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><pre><code class=\"c\">struct sdshdr{\n    //bufSDS\n    int len;\n    //buf\n    int free;\n    //\n    char buf[];\n}</code></pre>\n<p><img src=\"/2020/10/03/redis-data-type/2.png\" alt=\"\"></p>\n<p>RedislenfreebufC</p>\n<p><strong></strong></p>\n<p>lenlen<code>strlen</code>key</p>\n<p>RedisCCstrlen(str)O(N) SDS  <code>len</code>  <strong>O(1)</strong></p>\n<pre><code class=\"reStructuredText\">127.0.0.1:6379&gt; strlen msg\n(integer) 11</code></pre>\n<p><strong></strong></p>\n<p>CN+1CRedis</p>\n<p>SDSbufN+1freeRedisfree</p>\n<p>SDS<code></code>  <code></code></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<pre><code class=\"c\">typedef struct dict {\n    dictType *type;\n    void *privdata;\n    //\n    dictht ht[2];\n    int trehashidx;\n}\ntypedef struct dictht {\n    //\n    dictEntry **table;\n    //\n    unsigned long size;\n    // size - 1\n    unsigned long sizemask;\n    //\n    unsigned long used;\n} dictht;\n\n//\ntypedef struct dictEntry{\n    void *key;\n    union {\n        void *val;\n        uint64_tu64;\n        int64_ts64;\n    } v;\n    //\n    struct dictEntry *next;\n}\n</code></pre>\n<p><img src=\"/2020/10/03/redis-data-type/1.png\" alt=\"\"></p>\n<ul>\n<li>4<font color=\"red\"></font></li>\n<li>ht[0]ht[1]rehash</li>\n<li>RedisrehashrehashRedis<strong></strong></li>\n</ul>\n<p> +</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong><strong></strong>Redis<strong></strong></p>\n<pre><code class=\"c\">typedef struct intset{\n    uint32_t encoding;\n    //\n    uint32_t length;\n    //\n    int8_t contents[];\n}</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Redis<code></code><code></code><code></code><code></code><strong></strong></p>\n<p></p>\n<p>512<strong>O(N)N</strong></p>\n<p><img src=\"/2020/10/03/redis-data-type/3.png\" alt=\"\"></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>zlbytes</td>\n<td></td>\n</tr>\n<tr>\n<td>zltail</td>\n<td></td>\n</tr>\n<tr>\n<td>zllen</td>\n<td></td>\n</tr>\n<tr>\n<td>entryN</td>\n<td></td>\n</tr>\n<tr>\n<td>zlend</td>\n<td></td>\n</tr>\n<tr>\n<td>previous_entry_length</td>\n<td></td>\n</tr>\n<tr>\n<td>encoding</td>\n<td>content</td>\n</tr>\n<tr>\n<td>content</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><img src=\"/2020/10/03/redis-data-type/4.png\" alt=\"\"></p>\n<p>Redis<code></code>value</p>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p>Redis556RedisredisObject</p>\n<pre><code class=\"c\">typedef struct redisObject{\n    //\n    //type key \n    unsigned type:4;\n    //\n    //object encoding key \n    unsigned encoding:4;\n    //\n    void *ptr;\n}</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>intrwaembstr</p>\n<ul>\n<li>valueintlong</li>\n<li>value39SDS()raw</li>\n<li>value39SDS()embstr</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>64</li>\n<li>512</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>64</li>\n<li>512</li>\n</ul>\n<p><img src=\"/2020/10/03/redis-data-type/5.png\" alt=\"ziplist\"></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li></li>\n<li>512</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code></code><code></code></p>\n<ul>\n<li>128</li>\n<li>64</li>\n</ul>\n<h3 id=\"redis\"><a href=\"#redis\" class=\"headerlink\" title=\"redis\"></a>redis</h3><pre><code>127.0.0.1:6379&gt; lpush list1 1\n(integer) 1\n127.0.0.1:6379&gt; object encoding list1\n&quot;quicklist&quot;\n127.0.0.1:6379&gt; sadd set1 one two three\n(integer) 3\n127.0.0.1:6379&gt; object encoding set1\n&quot;hashtable&quot;\n127.0.0.1:6379&gt; hset hash1 field1 1\n(integer) 1\n127.0.0.1:6379&gt; object encoding hash1\n&quot;ziplist&quot;\n127.0.0.1:6379&gt; set name xuzy\nOK\n127.0.0.1:6379&gt; object encoding name\n&quot;embstr&quot;</code></pre><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>RedisRedis</strong></p>\n<p></p>\n<p><strong>1</strong></p>\n<p>RedisSDSSDSCSDSC</p>\n<hr>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>Redis</li>\n<li>Redis<a href=\"https://www.cnblogs.com/hunternet/p/12742390.html\" target=\"_blank\" rel=\"noopener\">Redis()</a></li>\n</ul>"},{"title":"redis","description":"redis","date":"2020-08-20T01:09:59.000Z","_content":"## Redis\n```\n127.0.0.1:6380> SLAVEOF 127.0.0.1 6379\n#ping10\nrepl-ping-replica-period\n#60\n#\n#1slaverepl-timeoutmaster SYNCrdb snapshot\n#2slaverepl-timeoutmasterping\n#3masterrepl-timeoutREPCONF ACK\nrepl-timeout\n#1M \nrepl-backlog-size\n#3600\nrepl-backlog-ttl\n#3slave(output-buffer)256M 64M 60output-buffer>256M256>output-buffer>6460\nclient-output-buffer-limit\n```\n\n## \n\nredis********\n- \n- ****\n<!--more-->\n### \n\n\n\n1. PSYNC\n2. SYNCBGSAVERDB\n3. BGSAVEBGSAVERDB\n4. RDB\n5. \n\n![](redis-master-slave/2.png)\n\n**replication buffer**master\n\n- masterRDB\n- masterRDBslave\n- slave load rdb\n\nreplication buffer<font color=red>slave</font>`client-output-buffer-limit slave 256mb 64mb 60`256M64M60s<font color=red></font>\n\n### \n\n\n\n- replication offset\n- replication backlog\n- IDrun ID\n\n![](redis-master-slave/3.png)\n\n****NNNN****PSYNCoffset\n\n- offsetoffset+1<font color=red></font>\n- offset<font color=red></font>SYNC\n\n### \n\n#### SYNC\n\nSYNCSYNC\n\n- BGSAVERDBCPUI/O\n- RDB\n- RDBRDB****\n\n<font color=red>SYNCRedisSYNC</font>\n\n#### \n\n<font color=red>fixed-sizeFIFO</font>1MBslavereplication buffer\n\n|  | ...  | 13512 | 13513 | 13514 | 13515 | 13516 | ...  |\n| ------ | ---- | ----- | ----- | ----- | ----- | ----- | ---- |\n|  | ...  | \\r    | \\n    | $     | S     | E     | ...  |\n\n**repl-backlog-size**\n\n```properties\n//bkkbmmbggbkmg1000\n//kbmbgb1024\nrepl-backlog-size 1mb\n//slavesrepl_backlog\nrepl-backlog-ttl 3600\n```\n\nkey-valuekey-value\n\nsecond * write_size_per_second\n\n- second\n- write_size_per_second\n\n#### ID\n\nIDrun IDRedis**ID**\n\nIDID**ID**\n\nID\n\n- IDID\n- IDID\n\n#### \n\n****\n\n`master_repl_offset``offset`\n\n```\n192.168.1.110:9852> info replication\n# Replication\nrole:master\nconnected_slaves:1\n#offset  salve0\nslave0:ip=192.168.1.120,port=9853,state=online,offset=375168999754,lag=1\n# master4016master\nmaster_replid:0ef80af291afbbb7e2f2d6fdbf150281ab1baa6f \nmaster_replid2:0000000000000000000000000000000000000000\n#master\nmaster_repl_offset:375168999754      \nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:67108864\nrepl_backlog_first_byte_offset:375101890891\nrepl_backlog_histlen:67108864\n```\n\n#### \n\nreplication buffermaster<font color=red>slave</font>masterRDBRDBslave<font color=red></font>\n\nreplication backlogmaster<font color=red></font>slavemasteroffsetreplication backlog1Mreplication backlog\n\n## \n\n- Redis\n- https://www.cnblogs.com/lukexwang/p/4711977.html\n- https://www.cnblogs.com/vansky/p/9293980.html\n- https://blog.csdn.net/a1076067274/article/details/109294208\n- https://www.cnblogs.com/any-way/p/10411567.html\n\n","source":"_posts/redis-master-slave.md","raw":"---\ntitle: redis\ntags:\n  - redis\ncategories: redis\ndescription : redis\ndate: 2020-08-20 09:09:59\n---\n## Redis\n```\n127.0.0.1:6380> SLAVEOF 127.0.0.1 6379\n#ping10\nrepl-ping-replica-period\n#60\n#\n#1slaverepl-timeoutmaster SYNCrdb snapshot\n#2slaverepl-timeoutmasterping\n#3masterrepl-timeoutREPCONF ACK\nrepl-timeout\n#1M \nrepl-backlog-size\n#3600\nrepl-backlog-ttl\n#3slave(output-buffer)256M 64M 60output-buffer>256M256>output-buffer>6460\nclient-output-buffer-limit\n```\n\n## \n\nredis********\n- \n- ****\n<!--more-->\n### \n\n\n\n1. PSYNC\n2. SYNCBGSAVERDB\n3. BGSAVEBGSAVERDB\n4. RDB\n5. \n\n![](redis-master-slave/2.png)\n\n**replication buffer**master\n\n- masterRDB\n- masterRDBslave\n- slave load rdb\n\nreplication buffer<font color=red>slave</font>`client-output-buffer-limit slave 256mb 64mb 60`256M64M60s<font color=red></font>\n\n### \n\n\n\n- replication offset\n- replication backlog\n- IDrun ID\n\n![](redis-master-slave/3.png)\n\n****NNNN****PSYNCoffset\n\n- offsetoffset+1<font color=red></font>\n- offset<font color=red></font>SYNC\n\n### \n\n#### SYNC\n\nSYNCSYNC\n\n- BGSAVERDBCPUI/O\n- RDB\n- RDBRDB****\n\n<font color=red>SYNCRedisSYNC</font>\n\n#### \n\n<font color=red>fixed-sizeFIFO</font>1MBslavereplication buffer\n\n|  | ...  | 13512 | 13513 | 13514 | 13515 | 13516 | ...  |\n| ------ | ---- | ----- | ----- | ----- | ----- | ----- | ---- |\n|  | ...  | \\r    | \\n    | $     | S     | E     | ...  |\n\n**repl-backlog-size**\n\n```properties\n//bkkbmmbggbkmg1000\n//kbmbgb1024\nrepl-backlog-size 1mb\n//slavesrepl_backlog\nrepl-backlog-ttl 3600\n```\n\nkey-valuekey-value\n\nsecond * write_size_per_second\n\n- second\n- write_size_per_second\n\n#### ID\n\nIDrun IDRedis**ID**\n\nIDID**ID**\n\nID\n\n- IDID\n- IDID\n\n#### \n\n****\n\n`master_repl_offset``offset`\n\n```\n192.168.1.110:9852> info replication\n# Replication\nrole:master\nconnected_slaves:1\n#offset  salve0\nslave0:ip=192.168.1.120,port=9853,state=online,offset=375168999754,lag=1\n# master4016master\nmaster_replid:0ef80af291afbbb7e2f2d6fdbf150281ab1baa6f \nmaster_replid2:0000000000000000000000000000000000000000\n#master\nmaster_repl_offset:375168999754      \nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:67108864\nrepl_backlog_first_byte_offset:375101890891\nrepl_backlog_histlen:67108864\n```\n\n#### \n\nreplication buffermaster<font color=red>slave</font>masterRDBRDBslave<font color=red></font>\n\nreplication backlogmaster<font color=red></font>slavemasteroffsetreplication backlog1Mreplication backlog\n\n## \n\n- Redis\n- https://www.cnblogs.com/lukexwang/p/4711977.html\n- https://www.cnblogs.com/vansky/p/9293980.html\n- https://blog.csdn.net/a1076067274/article/details/109294208\n- https://www.cnblogs.com/any-way/p/10411567.html\n\n","slug":"redis-master-slave","published":1,"updated":"2021-04-08T00:47:06.957Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvn002zqwv28sr9g006","content":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><pre><code>127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379\n#ping10\nrepl-ping-replica-period\n#60\n#\n#1slaverepl-timeoutmaster SYNCrdb snapshot\n#2slaverepl-timeoutmasterping\n#3masterrepl-timeoutREPCONF ACK\nrepl-timeout\n#1M \nrepl-backlog-size\n#3600\nrepl-backlog-ttl\n#3slave(output-buffer)256M 64M 60output-buffer&gt;256M256&gt;output-buffer&gt;6460\nclient-output-buffer-limit</code></pre><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>redis<strong></strong><strong></strong></p>\n<ul>\n<li></li>\n<li><strong></strong><a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3></li>\n</ul>\n<p></p>\n<ol>\n<li>PSYNC</li>\n<li>SYNCBGSAVERDB</li>\n<li>BGSAVEBGSAVERDB</li>\n<li>RDB</li>\n<li></li>\n</ol>\n<p><img src=\"/2020/08/20/redis-master-slave/2.png\" alt=\"\"></p>\n<p><strong>replication buffer</strong>master</p>\n<ul>\n<li>masterRDB</li>\n<li>masterRDBslave</li>\n<li>slave load rdb</li>\n</ul>\n<p>replication buffer<font color=\"red\">slave</font><code>client-output-buffer-limit slave 256mb 64mb 60</code>256M64M60s<font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li>replication offset</li>\n<li>replication backlog</li>\n<li>IDrun ID</li>\n</ul>\n<p><img src=\"/2020/08/20/redis-master-slave/3.png\" alt=\"\"></p>\n<p><strong></strong>NNNN<strong></strong>PSYNCoffset</p>\n<ul>\n<li>offsetoffset+1<font color=\"red\"></font></li>\n<li>offset<font color=\"red\"></font>SYNC</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"SYNC\"><a href=\"#SYNC\" class=\"headerlink\" title=\"SYNC\"></a>SYNC</h4><p>SYNCSYNC</p>\n<ul>\n<li>BGSAVERDBCPUI/O</li>\n<li>RDB</li>\n<li>RDBRDB<strong></strong></li>\n</ul>\n<p><font color=\"red\">SYNCRedisSYNC</font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><font color=\"red\">fixed-sizeFIFO</font>1MBslavereplication buffer</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th>13512</th>\n<th>13513</th>\n<th>13514</th>\n<th>13515</th>\n<th>13516</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td></td>\n<td>\\r</td>\n<td>\\n</td>\n<td>$</td>\n<td>S</td>\n<td>E</td>\n<td></td>\n</tr>\n</tbody></table>\n<p><strong>repl-backlog-size</strong></p>\n<pre class=\" language-properties\"><code class=\"language-properties\">//bkkbmmbggbkmg1000\n//kbmbgb1024\n<span class=\"token attr-name\">repl-backlog-size</span> <span class=\"token attr-value\">1mb</span>\n//slavesrepl_backlog\n<span class=\"token attr-name\">repl-backlog-ttl</span> <span class=\"token attr-value\">3600</span></code></pre>\n<p>key-valuekey-value</p>\n<p>second * write_size_per_second</p>\n<ul>\n<li>second</li>\n<li>write_size_per_second</li>\n</ul>\n<h4 id=\"ID\"><a href=\"#ID\" class=\"headerlink\" title=\"ID\"></a>ID</h4><p>IDrun IDRedis<strong>ID</strong></p>\n<p>IDID<strong>ID</strong></p>\n<p>ID</p>\n<ul>\n<li>IDID</li>\n<li>IDID</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p><code>master_repl_offset</code><code>offset</code></p>\n<pre><code>192.168.1.110:9852&gt; info replication\n# Replication\nrole:master\nconnected_slaves:1\n#offset  salve0\nslave0:ip=192.168.1.120,port=9853,state=online,offset=375168999754,lag=1\n# master4016master\nmaster_replid:0ef80af291afbbb7e2f2d6fdbf150281ab1baa6f \nmaster_replid2:0000000000000000000000000000000000000000\n#master\nmaster_repl_offset:375168999754      \nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:67108864\nrepl_backlog_first_byte_offset:375101890891\nrepl_backlog_histlen:67108864</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>replication buffermaster<font color=\"red\">slave</font>masterRDBRDBslave<font color=\"red\"></font></p>\n<p>replication backlogmaster<font color=\"red\"></font>slavemasteroffsetreplication backlog1Mreplication backlog</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>Redis</li>\n<li><a href=\"https://www.cnblogs.com/lukexwang/p/4711977.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/lukexwang/p/4711977.html</a></li>\n<li><a href=\"https://www.cnblogs.com/vansky/p/9293980.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/vansky/p/9293980.html</a></li>\n<li><a href=\"https://blog.csdn.net/a1076067274/article/details/109294208\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/a1076067274/article/details/109294208</a></li>\n<li><a href=\"https://www.cnblogs.com/any-way/p/10411567.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/any-way/p/10411567.html</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><pre><code>127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379\n#ping10\nrepl-ping-replica-period\n#60\n#\n#1slaverepl-timeoutmaster SYNCrdb snapshot\n#2slaverepl-timeoutmasterping\n#3masterrepl-timeoutREPCONF ACK\nrepl-timeout\n#1M \nrepl-backlog-size\n#3600\nrepl-backlog-ttl\n#3slave(output-buffer)256M 64M 60output-buffer&gt;256M256&gt;output-buffer&gt;6460\nclient-output-buffer-limit</code></pre><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>redis<strong></strong><strong></strong></p>\n<ul>\n<li></li>\n<li><strong></strong></li></ul>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3>\n\n<p></p>\n<ol>\n<li>PSYNC</li>\n<li>SYNCBGSAVERDB</li>\n<li>BGSAVEBGSAVERDB</li>\n<li>RDB</li>\n<li></li>\n</ol>\n<p><img src=\"/2020/08/20/redis-master-slave/2.png\" alt=\"\"></p>\n<p><strong>replication buffer</strong>master</p>\n<ul>\n<li>masterRDB</li>\n<li>masterRDBslave</li>\n<li>slave load rdb</li>\n</ul>\n<p>replication buffer<font color=\"red\">slave</font><code>client-output-buffer-limit slave 256mb 64mb 60</code>256M64M60s<font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ul>\n<li>replication offset</li>\n<li>replication backlog</li>\n<li>IDrun ID</li>\n</ul>\n<p><img src=\"/2020/08/20/redis-master-slave/3.png\" alt=\"\"></p>\n<p><strong></strong>NNNN<strong></strong>PSYNCoffset</p>\n<ul>\n<li>offsetoffset+1<font color=\"red\"></font></li>\n<li>offset<font color=\"red\"></font>SYNC</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"SYNC\"><a href=\"#SYNC\" class=\"headerlink\" title=\"SYNC\"></a>SYNC</h4><p>SYNCSYNC</p>\n<ul>\n<li>BGSAVERDBCPUI/O</li>\n<li>RDB</li>\n<li>RDBRDB<strong></strong></li>\n</ul>\n<p><font color=\"red\">SYNCRedisSYNC</font></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><font color=\"red\">fixed-sizeFIFO</font>1MBslavereplication buffer</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th>13512</th>\n<th>13513</th>\n<th>13514</th>\n<th>13515</th>\n<th>13516</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td></td>\n<td>\\r</td>\n<td>\\n</td>\n<td>$</td>\n<td>S</td>\n<td>E</td>\n<td></td>\n</tr>\n</tbody></table>\n<p><strong>repl-backlog-size</strong></p>\n<pre><code class=\"properties\">//bkkbmmbggbkmg1000\n//kbmbgb1024\nrepl-backlog-size 1mb\n//slavesrepl_backlog\nrepl-backlog-ttl 3600</code></pre>\n<p>key-valuekey-value</p>\n<p>second * write_size_per_second</p>\n<ul>\n<li>second</li>\n<li>write_size_per_second</li>\n</ul>\n<h4 id=\"ID\"><a href=\"#ID\" class=\"headerlink\" title=\"ID\"></a>ID</h4><p>IDrun IDRedis<strong>ID</strong></p>\n<p>IDID<strong>ID</strong></p>\n<p>ID</p>\n<ul>\n<li>IDID</li>\n<li>IDID</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong></strong></p>\n<p><code>master_repl_offset</code><code>offset</code></p>\n<pre><code>192.168.1.110:9852&gt; info replication\n# Replication\nrole:master\nconnected_slaves:1\n#offset  salve0\nslave0:ip=192.168.1.120,port=9853,state=online,offset=375168999754,lag=1\n# master4016master\nmaster_replid:0ef80af291afbbb7e2f2d6fdbf150281ab1baa6f \nmaster_replid2:0000000000000000000000000000000000000000\n#master\nmaster_repl_offset:375168999754      \nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:67108864\nrepl_backlog_first_byte_offset:375101890891\nrepl_backlog_histlen:67108864</code></pre><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>replication buffermaster<font color=\"red\">slave</font>masterRDBRDBslave<font color=\"red\"></font></p>\n<p>replication backlogmaster<font color=\"red\"></font>slavemasteroffsetreplication backlog1Mreplication backlog</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>Redis</li>\n<li><a href=\"https://www.cnblogs.com/lukexwang/p/4711977.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/lukexwang/p/4711977.html</a></li>\n<li><a href=\"https://www.cnblogs.com/vansky/p/9293980.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/vansky/p/9293980.html</a></li>\n<li><a href=\"https://blog.csdn.net/a1076067274/article/details/109294208\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/a1076067274/article/details/109294208</a></li>\n<li><a href=\"https://www.cnblogs.com/any-way/p/10411567.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/any-way/p/10411567.html</a></li>\n</ul>"},{"title":"Redis","description":"Redis","date":"2020-12-17T11:54:37.000Z","_content":"### Redis\n\n\n\n![Redis](redis-known/1.png)\n\n### Redis\n\n#### \n\nRedis5G10G5G?\n\nRedis**** + ****\n\n****Redis100msKeyKeyRedis100msKey100msKeyRedisKey\n\n****KeyRedisKey\n\n#### \n\nKeyKeyRedis\n\n```\nmaxmemory-policy volatile-lru\n```\n\n- Noeviction\n- Allkeys-lru<font color=red></font>Key\n- Allkeys-randomkey\n- Volatile-lruKeyRedis\n- Volatile-random<font color=red></font>Key\n- Volatile-ttlKey\n- volatite-lfu Redis4.0\n- allkeys-lfuRedis4.0\n\n### Redis\n\n![](redis-known/2.png)","source":"_posts/redis-known.md","raw":"---\ntitle: Redis\ntags:\n  - redis\ncategories: redis\ndescription : Redis\ndate: 2020-12-17 19:54:37\n---\n### Redis\n\n\n\n![Redis](redis-known/1.png)\n\n### Redis\n\n#### \n\nRedis5G10G5G?\n\nRedis**** + ****\n\n****Redis100msKeyKeyRedis100msKey100msKeyRedisKey\n\n****KeyRedisKey\n\n#### \n\nKeyKeyRedis\n\n```\nmaxmemory-policy volatile-lru\n```\n\n- Noeviction\n- Allkeys-lru<font color=red></font>Key\n- Allkeys-randomkey\n- Volatile-lruKeyRedis\n- Volatile-random<font color=red></font>Key\n- Volatile-ttlKey\n- volatite-lfu Redis4.0\n- allkeys-lfuRedis4.0\n\n### Redis\n\n![](redis-known/2.png)","slug":"redis-known","published":1,"updated":"2021-04-08T00:47:06.957Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvp0033qwv2cm36d9tz","content":"<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p></p>\n<p><img src=\"/2020/12/17/redis-known/1.png\" alt=\"Redis\"></p>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Redis5G10G5G?</p>\n<p>Redis<strong></strong> + <strong></strong></p>\n<p><strong></strong>Redis100msKeyKeyRedis100msKey100msKeyRedisKey</p>\n<p><strong></strong>KeyRedisKey</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>KeyKeyRedis</p>\n<pre><code>maxmemory-policy volatile-lru</code></pre><ul>\n<li>Noeviction</li>\n<li>Allkeys-lru<font color=\"red\"></font>Key</li>\n<li>Allkeys-randomkey</li>\n<li>Volatile-lruKeyRedis</li>\n<li>Volatile-random<font color=\"red\"></font>Key</li>\n<li>Volatile-ttlKey</li>\n<li>volatite-lfu Redis4.0</li>\n<li>allkeys-lfuRedis4.0</li>\n</ul>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p><img src=\"/2020/12/17/redis-known/2.png\" alt></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p></p>\n<p><img src=\"/2020/12/17/redis-known/1.png\" alt=\"Redis\"></p>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Redis5G10G5G?</p>\n<p>Redis<strong></strong> + <strong></strong></p>\n<p><strong></strong>Redis100msKeyKeyRedis100msKey100msKeyRedisKey</p>\n<p><strong></strong>KeyRedisKey</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>KeyKeyRedis</p>\n<pre><code>maxmemory-policy volatile-lru</code></pre><ul>\n<li>Noeviction</li>\n<li>Allkeys-lru<font color=\"red\"></font>Key</li>\n<li>Allkeys-randomkey</li>\n<li>Volatile-lruKeyRedis</li>\n<li>Volatile-random<font color=\"red\"></font>Key</li>\n<li>Volatile-ttlKey</li>\n<li>volatite-lfu Redis4.0</li>\n<li>allkeys-lfuRedis4.0</li>\n</ul>\n<h3 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h3><p><img src=\"/2020/12/17/redis-known/2.png\" alt></p>\n"},{"title":"redisRDB,AOP","description":"redisRDB,AOP","date":"2020-08-26T06:43:31.000Z","_content":"\n## Redis\n\n- RDB Redis  dumpr.rdb\n- AOF Redis \n<!--more-->\n## RDB\n\n### RDB\n- RDB<font color=red></font> key-value\n- RDB**save****bgsave**\n  - rdb\n  - forkrdb\n-  shutdown  AOF bgsave\n-  RDB shellRDB\n\nRedisRDBredis.conf\n\n```properties\nsave 900 1\nsave 300 10\nsave 60 10000\n#9001key\n#30010key\n#601key\n```\n\n### bgsave\n\n![](redis-master-slave/1.png)\n\n1. Redis  fork() \n2. RDB\n3.  RDB RedisRDBRDBRDB\n\n <font color=red>bgsaveKKredis</font>\n\nredis<font color=red>COW(Copy On Write)</font>Linux\n\nredisRDB\"\"4K2redis\"\"<font color=red></font>\n\n### \n\n****\n\n- \n- Redis  RDB  AOF\n\n****\n\n- \n-  fork  RDB \n\n### \n\n** 8gredis6gfork12g**\n\nforkRedisRDBCOW(Copy On Write)fork4K4Kfork\n\n## AOF\n\n### AOF\n\n- AOFwriteappendonly.aof\n- AOFappendfsync\n- AOF \n- AOF \n- AOFbgrewriteaof\n\nAOF\n\n```\n# AOF\nappendonly yes\n# AOF\nappendfsync no \n#AOF fsync \nappendfsync always \n#AOF OS write   redis  OS fsync \nappendfsync everysec \n```\n\n### aof\n\nredisredisAOFglibcfsync()\n\n### bgrewriteaof\n\n![](redis-rdb-aop/2.png)\n\n1. bgrewriteaofbgsave(RDB)/bgrewriteaof\n2. forkredis\n3. forkAOFappendfsyncAOFforkforkRedis(aof_rewrite_buf)forkAOFaof_buf(aof_rewrite_buf)\n4. AOF\n   - AOF\n   - aof_rewrite_bufAOF\n5. AOFAOFAOF\n\n Redis AOF AOF  AOF   AOF Redis  AOF  AOF  AOF \n\n**AOF**\n\n- bgrewriteaof\n- auto-aof-rewrite-min-size  auto-aof-rewrite-percentage\n\n```properties\n#AOFAOF4.064mb\nauto-aof-rewrite-min-size 64mb\n#AOF\n#100AOF\nauto-aof-rewrite-percentage 100\n```\n\n### \n\n- \n- AOF  RDB \n- \n\n### AOF\n\n![](redis-rdb-aop/3.png)\n\n## \n\nRedis 4.0bgrewriteaof\n\n****\n\n1. forkRDBAOF\n2. AOF\n3. AOFAOF\n\nRedis<font color=red>AOF</font>\n\n- AOFRDBRDBAOF\n- AOFRDBAOF\n\n\n\n```properties\n#yes\naof-use-rdb-preamble yes\n```\n\n## \n\n- https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&mid=2452965797&idx=1&sn=dc1cc6dad0d589148d5d6147705cfc38&chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&scene=21#wechat_redirect\n- https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&mid=2452965876&idx=1&sn=8e652ab31b628af89b275cf8f25544ef&chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&scene=21#wechat_redirect","source":"_posts/redis-rdb-aop.md","raw":"---\ntitle: redisRDB,AOP\ntags:\n  - redis\ncategories: redis\ndescription : redisRDB,AOP\ndate: 2020-08-26 14:43:31\n---\n\n## Redis\n\n- RDB Redis  dumpr.rdb\n- AOF Redis \n<!--more-->\n## RDB\n\n### RDB\n- RDB<font color=red></font> key-value\n- RDB**save****bgsave**\n  - rdb\n  - forkrdb\n-  shutdown  AOF bgsave\n-  RDB shellRDB\n\nRedisRDBredis.conf\n\n```properties\nsave 900 1\nsave 300 10\nsave 60 10000\n#9001key\n#30010key\n#601key\n```\n\n### bgsave\n\n![](redis-master-slave/1.png)\n\n1. Redis  fork() \n2. RDB\n3.  RDB RedisRDBRDBRDB\n\n <font color=red>bgsaveKKredis</font>\n\nredis<font color=red>COW(Copy On Write)</font>Linux\n\nredisRDB\"\"4K2redis\"\"<font color=red></font>\n\n### \n\n****\n\n- \n- Redis  RDB  AOF\n\n****\n\n- \n-  fork  RDB \n\n### \n\n** 8gredis6gfork12g**\n\nforkRedisRDBCOW(Copy On Write)fork4K4Kfork\n\n## AOF\n\n### AOF\n\n- AOFwriteappendonly.aof\n- AOFappendfsync\n- AOF \n- AOF \n- AOFbgrewriteaof\n\nAOF\n\n```\n# AOF\nappendonly yes\n# AOF\nappendfsync no \n#AOF fsync \nappendfsync always \n#AOF OS write   redis  OS fsync \nappendfsync everysec \n```\n\n### aof\n\nredisredisAOFglibcfsync()\n\n### bgrewriteaof\n\n![](redis-rdb-aop/2.png)\n\n1. bgrewriteaofbgsave(RDB)/bgrewriteaof\n2. forkredis\n3. forkAOFappendfsyncAOFforkforkRedis(aof_rewrite_buf)forkAOFaof_buf(aof_rewrite_buf)\n4. AOF\n   - AOF\n   - aof_rewrite_bufAOF\n5. AOFAOFAOF\n\n Redis AOF AOF  AOF   AOF Redis  AOF  AOF  AOF \n\n**AOF**\n\n- bgrewriteaof\n- auto-aof-rewrite-min-size  auto-aof-rewrite-percentage\n\n```properties\n#AOFAOF4.064mb\nauto-aof-rewrite-min-size 64mb\n#AOF\n#100AOF\nauto-aof-rewrite-percentage 100\n```\n\n### \n\n- \n- AOF  RDB \n- \n\n### AOF\n\n![](redis-rdb-aop/3.png)\n\n## \n\nRedis 4.0bgrewriteaof\n\n****\n\n1. forkRDBAOF\n2. AOF\n3. AOFAOF\n\nRedis<font color=red>AOF</font>\n\n- AOFRDBRDBAOF\n- AOFRDBAOF\n\n\n\n```properties\n#yes\naof-use-rdb-preamble yes\n```\n\n## \n\n- https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&mid=2452965797&idx=1&sn=dc1cc6dad0d589148d5d6147705cfc38&chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&scene=21#wechat_redirect\n- https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&mid=2452965876&idx=1&sn=8e652ab31b628af89b275cf8f25544ef&chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&scene=21#wechat_redirect","slug":"redis-rdb-aop","published":1,"updated":"2021-04-08T00:47:06.967Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvq0037qwv2e2q19khp","content":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><ul>\n<li>RDB Redis  dumpr.rdb</li>\n<li>AOF Redis <a id=\"more\"></a>\n<h2 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h2></li>\n</ul>\n<h3 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h3><ul>\n<li>RDB<font color=\"red\"></font> key-value</li>\n<li>RDB<strong>save</strong><strong>bgsave</strong><ul>\n<li>rdb</li>\n<li>forkrdb</li>\n</ul>\n</li>\n<li> shutdown  AOF bgsave</li>\n<li> RDB shellRDB</li>\n</ul>\n<p>RedisRDBredis.conf</p>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token attr-name\">save</span> <span class=\"token attr-value\">900 1</span>\n<span class=\"token attr-name\">save</span> <span class=\"token attr-value\">300 10</span>\n<span class=\"token attr-name\">save</span> <span class=\"token attr-value\">60 10000</span>\n<span class=\"token comment\" spellcheck=\"true\">#9001key</span>\n<span class=\"token comment\" spellcheck=\"true\">#30010key</span>\n<span class=\"token comment\" spellcheck=\"true\">#601key</span></code></pre>\n<h3 id=\"bgsave\"><a href=\"#bgsave\" class=\"headerlink\" title=\"bgsave\"></a>bgsave</h3><p><img src=\"/2020/08/26/redis-rdb-aop/1.png\" alt></p>\n<ol>\n<li>Redis  fork() </li>\n<li>RDB</li>\n<li> RDB RedisRDBRDBRDB</li>\n</ol>\n<p> <font color=\"red\">bgsaveKKredis</font></p>\n<p>redis<font color=\"red\">COW(Copy On Write)</font>Linux</p>\n<p>redisRDB4K2redis<font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<ul>\n<li></li>\n<li>Redis  RDB  AOF</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li> fork  RDB </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> 8gredis6gfork12g</strong></p>\n<p>forkRedisRDBCOW(Copy On Write)fork4K4Kfork</p>\n<h2 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h2><h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><ul>\n<li>AOFwriteappendonly.aof</li>\n<li>AOFappendfsync</li>\n<li>AOF </li>\n<li>AOF </li>\n<li>AOFbgrewriteaof</li>\n</ul>\n<p>AOF</p>\n<pre><code># AOF\nappendonly yes\n# AOF\nappendfsync no \n#AOF fsync \nappendfsync always \n#AOF OS write   redis  OS fsync \nappendfsync everysec </code></pre><h3 id=\"aof\"><a href=\"#aof\" class=\"headerlink\" title=\"aof\"></a>aof</h3><p>redisredisAOFglibcfsync()</p>\n<h3 id=\"bgrewriteaof\"><a href=\"#bgrewriteaof\" class=\"headerlink\" title=\"bgrewriteaof\"></a>bgrewriteaof</h3><p><img src=\"/2020/08/26/redis-rdb-aop/2.png\" alt></p>\n<ol>\n<li>bgrewriteaofbgsave(RDB)/bgrewriteaof</li>\n<li>forkredis</li>\n<li>forkAOFappendfsyncAOFforkforkRedis(aof_rewrite_buf)forkAOFaof_buf(aof_rewrite_buf)</li>\n<li>AOF<ul>\n<li>AOF</li>\n<li>aof_rewrite_bufAOF</li>\n</ul>\n</li>\n<li>AOFAOFAOF</li>\n</ol>\n<p> Redis AOF AOF  AOF   AOF Redis  AOF  AOF  AOF </p>\n<p><strong>AOF</strong></p>\n<ul>\n<li>bgrewriteaof</li>\n<li>auto-aof-rewrite-min-size  auto-aof-rewrite-percentage</li>\n</ul>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\">#AOFAOF4.064mb</span>\n<span class=\"token attr-name\">auto-aof-rewrite-min-size</span> <span class=\"token attr-value\">64mb</span>\n<span class=\"token comment\" spellcheck=\"true\">#AOF</span>\n<span class=\"token comment\" spellcheck=\"true\">#100AOF</span>\n<span class=\"token attr-name\">auto-aof-rewrite-percentage</span> <span class=\"token attr-value\">100</span></code></pre>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li>AOF  RDB </li>\n<li></li>\n</ul>\n<h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><p><img src=\"/2020/08/26/redis-rdb-aop/3.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Redis 4.0bgrewriteaof</p>\n<p><strong></strong></p>\n<ol>\n<li>forkRDBAOF</li>\n<li>AOF</li>\n<li>AOFAOF</li>\n</ol>\n<p>Redis<font color=\"red\">AOF</font></p>\n<ul>\n<li>AOFRDBRDBAOF</li>\n<li>AOFRDBAOF</li>\n</ul>\n<p></p>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\">#yes</span>\n<span class=\"token attr-name\">aof-use-rdb-preamble</span> <span class=\"token attr-value\">yes</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965797&amp;idx=1&amp;sn=dc1cc6dad0d589148d5d6147705cfc38&amp;chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&amp;scene=21#wechat_redirect\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965797&amp;idx=1&amp;sn=dc1cc6dad0d589148d5d6147705cfc38&amp;chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&amp;scene=21#wechat_redirect</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965876&amp;idx=1&amp;sn=8e652ab31b628af89b275cf8f25544ef&amp;chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&amp;scene=21#wechat_redirect\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965876&amp;idx=1&amp;sn=8e652ab31b628af89b275cf8f25544ef&amp;chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&amp;scene=21#wechat_redirect</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><ul>\n<li>RDB Redis  dumpr.rdb</li>\n<li>AOF Redis </li></ul>","more":"<h2 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h2>\n\n<h3 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h3><ul>\n<li>RDB<font color=\"red\"></font> key-value</li>\n<li>RDB<strong>save</strong><strong>bgsave</strong><ul>\n<li>rdb</li>\n<li>forkrdb</li>\n</ul>\n</li>\n<li> shutdown  AOF bgsave</li>\n<li> RDB shellRDB</li>\n</ul>\n<p>RedisRDBredis.conf</p>\n<pre><code class=\"properties\">save 900 1\nsave 300 10\nsave 60 10000\n#9001key\n#30010key\n#601key</code></pre>\n<h3 id=\"bgsave\"><a href=\"#bgsave\" class=\"headerlink\" title=\"bgsave\"></a>bgsave</h3><p><img src=\"/2020/08/26/redis-rdb-aop/1.png\" alt></p>\n<ol>\n<li>Redis  fork() </li>\n<li>RDB</li>\n<li> RDB RedisRDBRDBRDB</li>\n</ol>\n<p> <font color=\"red\">bgsaveKKredis</font></p>\n<p>redis<font color=\"red\">COW(Copy On Write)</font>Linux</p>\n<p>redisRDB4K2redis<font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<ul>\n<li></li>\n<li>Redis  RDB  AOF</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li> fork  RDB </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong> 8gredis6gfork12g</strong></p>\n<p>forkRedisRDBCOW(Copy On Write)fork4K4Kfork</p>\n<h2 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h2><h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><ul>\n<li>AOFwriteappendonly.aof</li>\n<li>AOFappendfsync</li>\n<li>AOF </li>\n<li>AOF </li>\n<li>AOFbgrewriteaof</li>\n</ul>\n<p>AOF</p>\n<pre><code># AOF\nappendonly yes\n# AOF\nappendfsync no \n#AOF fsync \nappendfsync always \n#AOF OS write   redis  OS fsync \nappendfsync everysec </code></pre><h3 id=\"aof\"><a href=\"#aof\" class=\"headerlink\" title=\"aof\"></a>aof</h3><p>redisredisAOFglibcfsync()</p>\n<h3 id=\"bgrewriteaof\"><a href=\"#bgrewriteaof\" class=\"headerlink\" title=\"bgrewriteaof\"></a>bgrewriteaof</h3><p><img src=\"/2020/08/26/redis-rdb-aop/2.png\" alt></p>\n<ol>\n<li>bgrewriteaofbgsave(RDB)/bgrewriteaof</li>\n<li>forkredis</li>\n<li>forkAOFappendfsyncAOFforkforkRedis(aof_rewrite_buf)forkAOFaof_buf(aof_rewrite_buf)</li>\n<li>AOF<ul>\n<li>AOF</li>\n<li>aof_rewrite_bufAOF</li>\n</ul>\n</li>\n<li>AOFAOFAOF</li>\n</ol>\n<p> Redis AOF AOF  AOF   AOF Redis  AOF  AOF  AOF </p>\n<p><strong>AOF</strong></p>\n<ul>\n<li>bgrewriteaof</li>\n<li>auto-aof-rewrite-min-size  auto-aof-rewrite-percentage</li>\n</ul>\n<pre><code class=\"properties\">#AOFAOF4.064mb\nauto-aof-rewrite-min-size 64mb\n#AOF\n#100AOF\nauto-aof-rewrite-percentage 100</code></pre>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li>AOF  RDB </li>\n<li></li>\n</ul>\n<h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><p><img src=\"/2020/08/26/redis-rdb-aop/3.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Redis 4.0bgrewriteaof</p>\n<p><strong></strong></p>\n<ol>\n<li>forkRDBAOF</li>\n<li>AOF</li>\n<li>AOFAOF</li>\n</ol>\n<p>Redis<font color=\"red\">AOF</font></p>\n<ul>\n<li>AOFRDBRDBAOF</li>\n<li>AOFRDBAOF</li>\n</ul>\n<p></p>\n<pre><code class=\"properties\">#yes\naof-use-rdb-preamble yes</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965797&amp;idx=1&amp;sn=dc1cc6dad0d589148d5d6147705cfc38&amp;chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&amp;scene=21#wechat_redirect\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965797&amp;idx=1&amp;sn=dc1cc6dad0d589148d5d6147705cfc38&amp;chksm=88ede4cdbf9a6ddb775e3861ce6fc9a50eefe2d00eed69877e5ecf9cef94a6342fecaa3979c2&amp;scene=21#wechat_redirect</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965876&amp;idx=1&amp;sn=8e652ab31b628af89b275cf8f25544ef&amp;chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&amp;scene=21#wechat_redirect\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s?__biz=MzA3MTUzOTcxOQ==&amp;mid=2452965876&amp;idx=1&amp;sn=8e652ab31b628af89b275cf8f25544ef&amp;chksm=88ede49cbf9a6d8a10231e1dde14976a6cfdfd08778783bfede076c935158895fa99159ec754&amp;scene=21#wechat_redirect</a></li>\n</ul>"},{"title":"redis","description":"redis","date":"2020-08-14T08:58:58.000Z","_content":"## Redis\n\nRedis SentinelRedis<font color=red></font>Redis()<font color=red></font>\n\nRedis Sentinel \n\n- Sentinel \n-  Redis SentinelAPI\n- \n  - \n  - \n\n![redis](redis-sentinel/1.png)\n\nredis<font color=red></font>\n<!--more-->\n\n## Redis\n\n```properties\n# sentinel monitor mymaster 127.0.0.1 6379 2\n#   <master-name>   IP  <ip>  <port> \n#quorum2\n#number(sentinel)/2 + 1\nsentinel monitor <master-name> <ip> <port> <quorum>\n\n#sentinel down-after-milliseconds mymaster 2000\n#pingRedispong\n#\nsentinel down-after-milliseconds <master-name> <times>\n\n#sentinel parallel-syncs mymaster 2\n#Redis\n#\n#?\nsentinel parallel-syncs <master-name> <nums>\n\n#sentinel failover-timeout mymaster 2000\n#<times>\nsentinel failover-timeout <master-name>  <times>\n\n#sentinel auth-pass mymaster 123456\n#\nsentinel auth-pass <master-name> <password>\n```\n\n\n\n- <font color=red></font>sentinelpingpongsentinelquorum()\n- \n\n## Redis\n\n### Leader\n\nLeaderLeader<font color=red>Raft</font>\n\n### \n\nsentinelleander sentinel\n\n1.  \n2. slave-priority\n3. \n4. run_id\n\nslaveof no oneslaveof\n\n### \n\n- 10infoinfo\n- 2redis\\_\\_sentinel\\_\\_:hello\n- 1ping\n\n### \n\n- SentinelMasterSlave Sentinel  PING \n- instance PING  down-after-milliseconds   Sentinel \n- MasterMaster Sentinel Master \n-  SentinelMaster Master \n-   Sentinel  10 MasterSlave INFO  \n- Master Sentinel Sentinel  Master  Slave  INFO  10  \n-  Sentinel  Master  Master  \n\n## Redis\n\nredisredis masterredis slavesentinelsentinelmasterslavemaster<font color=red></font>\n\n![redis](redis-sentinel/2.png)\n\n****  redis\n\n```properties\n#masterslave,master\nmin-replicas-to-write 3\n#slavemaster\nmin-replicas-max-lag 10\n```\n\n\n\n## Jedis\n\n#### Jedis\n\nRedisJedis\n\n<font color=red>JedisJedis</font>\n\n**Jedis**\n\n```java\n@Test\npublic void test02(){\n    JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n    jedisPoolConfig.setMaxTotal(10);\n    jedisPoolConfig.setMaxIdle(5);\n    jedisPoolConfig.setMinIdle(5);\n    // \n    Set<String> sentinels = \n        new HashSet<>(Arrays.asList(\"192.168.135.131:26379\",\"192.168.135.131:26380\",\"192.168.135.131:26381\"));\n    JedisSentinelPool pool = new JedisSentinelPool(\"mymaster\", sentinels,jedisPoolConfig);\n    Jedis jedis = pool.getResource();\n    jedis.set(\"mykey\", \"myvalue\");\n    String value = jedis.get(\"mykey\");\n    System.out.println(value);\n}\n```\n\n**JedisSentinelPool**\n\n\n\n- \n- MasterListener+switch-masterinitPool(master)\n\n<font color=red>Jedis</font>\n\n```java\npublic JedisSentinelPool(String masterName, Set<String> sentinels,\n    final GenericObjectPoolConfig poolConfig, final int connectionTimeout, final int soTimeout,\n    final String password, final int database, final String clientName) {\n  this.poolConfig = poolConfig;\n  this.connectionTimeout = connectionTimeout;\n  this.soTimeout = soTimeout;\n  this.password = password;\n  this.database = database;\n  this.clientName = clientName;\n  //\n  HostAndPort master = initSentinels(sentinels, masterName);\n  //master\n  initPool(master);\n}\n\n//\nprivate HostAndPort initSentinels(Set<String> sentinels, final String masterName) {\n  HostAndPort master = null;\n  boolean sentinelAvailable = false;\n  log.info(\"Trying to find master from available Sentinels...\");\n  //  \n  for (String sentinel : sentinels) {\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(\":\")));\n    log.fine(\"Connecting to Sentinel \" + hap);\n    Jedis jedis = null;\n    try {\n      //\n      jedis = new Jedis(hap.getHost(), hap.getPort());\n      //IpmasterName\n      List<String> masterAddr = jedis.sentinelGetMasterAddrByName(masterName);\n      //  \n      sentinelAvailable = true;\n      //\n      if (masterAddr == null || masterAddr.size() != 2) {\n        log.warning(\"Can not get master addr, master name: \" + masterName + \". Sentinel: \" + hap\n            + \".\");\n        continue;\n      }\n\t //HostAndPort\n      master = toHostAndPort(masterAddr);\n      log.fine(\"Found Redis master at \" + master);\n      break;\n    } catch (JedisConnectionException e) {\n      log.warning(\"Cannot connect to sentinel running @ \" + hap + \". Trying next one.\");\n    } finally {\n      if (jedis != null) {\n        jedis.close();\n      }\n    }\n  }\n\n  //\n  if (master == null) {\n    if (sentinelAvailable) {\n      throw new JedisException(\"Can connect to sentinel, but \" + masterName\n          + \" seems to be not monitored...\");\n    } else {\n      throw new JedisConnectionException(\"All sentinels down, cannot determine where is \"\n          + masterName + \" master is running...\");\n    }\n  }\n    \n  log.info(\"Redis master running at \" + master + \", starting Sentinel listeners...\");\n    \n  for (String sentinel : sentinels) {\n    //Ip\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(\":\")));\n    //\n    MasterListener masterListener = new MasterListener(masterName, hap.getHost(), hap.getPort());\n    masterListener.setDaemon(true);\n    masterListeners.add(masterListener);\n    masterListener.start();\n  }\n  return master;\n}\n```\n\n```java\nprotected class MasterListener extends Thread {\n   //... \n    public void run() {\n      running.set(true);\n      while (running.get()) {\n        j = new Jedis(host, port);\n        try {\n          if (!running.get()) {\n            break;\n          }\n          //+switch-master\n          j.subscribe(new JedisPubSub() {\n            @Override\n            public void onMessage(String channel, String message) {\n              log.fine(\"Sentinel \" + host + \":\" + port + \" published: \" + message + \".\");\n              String[] switchMasterMsg = message.split(\" \");\n\n              if (switchMasterMsg.length > 3) {\n                if (masterName.equals(switchMasterMsg[0])) {\n                  //\n                  initPool(toHostAndPort(Arrays.asList(switchMasterMsg[3], switchMasterMsg[4])));\n                } else {\n                  log.fine(\"Ignoring message on +switch-master for master name \"\n                      + switchMasterMsg[0] + \", our master name is \" + masterName);\n                }\n\n              } else {\n                log.severe(\"Invalid message received on Sentinel \" + host + \":\" + port\n                    + \" on channel +switch-master: \" + message);\n              }\n            }\n          }, \"+switch-master\");\n\n        } catch (JedisConnectionException e) {\n\t\t\t//... \n        } finally {\n             //... \n        }\n      }\n    }\n  }\n```\n\n#### \n\nJedisSentinelPoolcommons.pool2initPoolMasterJedis(JedisFactory)\n\n```java\n//Jedis  \nprivate void initPool(HostAndPort master) {\n    if (!master.equals(currentHostMaster)) {\n      currentHostMaster = master;\n      if (factory == null) {\n        //Master\n        factory = new JedisFactory(master.getHost(), master.getPort(), connectionTimeout,\n            soTimeout, password, database, clientName);\n        initPool(poolConfig, factory);\n      } else {\n        factory.setHostAndPort(currentHostMaster);\n        internalPool.clear();\n      }\n      log.info(\"Created JedisPool to master at \" + master);\n    }\n  }\n```\n\n```java\n//redis/clients/jedis/JedisFactory/class  \n@Override\n  public PooledObject<Jedis> makeObject() throws Exception {\n    final HostAndPort hostAndPort = this.hostAndPort.get();\n    //\n    final Jedis jedis = new Jedis(hostAndPort.getHost(), hostAndPort.getPort(), connectionTimeout,\n        soTimeout);\n\n    jedis.connect();\n    if (null != this.password) {\n      jedis.auth(this.password);\n    }\n    if (database != 0) {\n      jedis.select(database);\n    }\n    if (clientName != null) {\n      jedis.clientSetname(clientName);\n    }\n    return new DefaultPooledObject<Jedis>(jedis);\n  }\n```\n\n\n\n- JedisSlaveSentinelPoolJedisSentinelPoolinitPoolJedisFactoryJedisSlaveFactory()MasterListenerJedisSentinelPoolMasterListener\n- JedisSlaveFactoryJedisFactorymakeObject\n- JedisUtils\n\n\n\n","source":"_posts/redis-sentinel.md","raw":"---\ntitle: redis\ntags:\n  - redis\ncategories: redis\ndescription : redis\ndate: 2020-08-14 16:58:58\n---\n## Redis\n\nRedis SentinelRedis<font color=red></font>Redis()<font color=red></font>\n\nRedis Sentinel \n\n- Sentinel \n-  Redis SentinelAPI\n- \n  - \n  - \n\n![redis](redis-sentinel/1.png)\n\nredis<font color=red></font>\n<!--more-->\n\n## Redis\n\n```properties\n# sentinel monitor mymaster 127.0.0.1 6379 2\n#   <master-name>   IP  <ip>  <port> \n#quorum2\n#number(sentinel)/2 + 1\nsentinel monitor <master-name> <ip> <port> <quorum>\n\n#sentinel down-after-milliseconds mymaster 2000\n#pingRedispong\n#\nsentinel down-after-milliseconds <master-name> <times>\n\n#sentinel parallel-syncs mymaster 2\n#Redis\n#\n#?\nsentinel parallel-syncs <master-name> <nums>\n\n#sentinel failover-timeout mymaster 2000\n#<times>\nsentinel failover-timeout <master-name>  <times>\n\n#sentinel auth-pass mymaster 123456\n#\nsentinel auth-pass <master-name> <password>\n```\n\n\n\n- <font color=red></font>sentinelpingpongsentinelquorum()\n- \n\n## Redis\n\n### Leader\n\nLeaderLeader<font color=red>Raft</font>\n\n### \n\nsentinelleander sentinel\n\n1.  \n2. slave-priority\n3. \n4. run_id\n\nslaveof no oneslaveof\n\n### \n\n- 10infoinfo\n- 2redis\\_\\_sentinel\\_\\_:hello\n- 1ping\n\n### \n\n- SentinelMasterSlave Sentinel  PING \n- instance PING  down-after-milliseconds   Sentinel \n- MasterMaster Sentinel Master \n-  SentinelMaster Master \n-   Sentinel  10 MasterSlave INFO  \n- Master Sentinel Sentinel  Master  Slave  INFO  10  \n-  Sentinel  Master  Master  \n\n## Redis\n\nredisredis masterredis slavesentinelsentinelmasterslavemaster<font color=red></font>\n\n![redis](redis-sentinel/2.png)\n\n****  redis\n\n```properties\n#masterslave,master\nmin-replicas-to-write 3\n#slavemaster\nmin-replicas-max-lag 10\n```\n\n\n\n## Jedis\n\n#### Jedis\n\nRedisJedis\n\n<font color=red>JedisJedis</font>\n\n**Jedis**\n\n```java\n@Test\npublic void test02(){\n    JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n    jedisPoolConfig.setMaxTotal(10);\n    jedisPoolConfig.setMaxIdle(5);\n    jedisPoolConfig.setMinIdle(5);\n    // \n    Set<String> sentinels = \n        new HashSet<>(Arrays.asList(\"192.168.135.131:26379\",\"192.168.135.131:26380\",\"192.168.135.131:26381\"));\n    JedisSentinelPool pool = new JedisSentinelPool(\"mymaster\", sentinels,jedisPoolConfig);\n    Jedis jedis = pool.getResource();\n    jedis.set(\"mykey\", \"myvalue\");\n    String value = jedis.get(\"mykey\");\n    System.out.println(value);\n}\n```\n\n**JedisSentinelPool**\n\n\n\n- \n- MasterListener+switch-masterinitPool(master)\n\n<font color=red>Jedis</font>\n\n```java\npublic JedisSentinelPool(String masterName, Set<String> sentinels,\n    final GenericObjectPoolConfig poolConfig, final int connectionTimeout, final int soTimeout,\n    final String password, final int database, final String clientName) {\n  this.poolConfig = poolConfig;\n  this.connectionTimeout = connectionTimeout;\n  this.soTimeout = soTimeout;\n  this.password = password;\n  this.database = database;\n  this.clientName = clientName;\n  //\n  HostAndPort master = initSentinels(sentinels, masterName);\n  //master\n  initPool(master);\n}\n\n//\nprivate HostAndPort initSentinels(Set<String> sentinels, final String masterName) {\n  HostAndPort master = null;\n  boolean sentinelAvailable = false;\n  log.info(\"Trying to find master from available Sentinels...\");\n  //  \n  for (String sentinel : sentinels) {\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(\":\")));\n    log.fine(\"Connecting to Sentinel \" + hap);\n    Jedis jedis = null;\n    try {\n      //\n      jedis = new Jedis(hap.getHost(), hap.getPort());\n      //IpmasterName\n      List<String> masterAddr = jedis.sentinelGetMasterAddrByName(masterName);\n      //  \n      sentinelAvailable = true;\n      //\n      if (masterAddr == null || masterAddr.size() != 2) {\n        log.warning(\"Can not get master addr, master name: \" + masterName + \". Sentinel: \" + hap\n            + \".\");\n        continue;\n      }\n\t //HostAndPort\n      master = toHostAndPort(masterAddr);\n      log.fine(\"Found Redis master at \" + master);\n      break;\n    } catch (JedisConnectionException e) {\n      log.warning(\"Cannot connect to sentinel running @ \" + hap + \". Trying next one.\");\n    } finally {\n      if (jedis != null) {\n        jedis.close();\n      }\n    }\n  }\n\n  //\n  if (master == null) {\n    if (sentinelAvailable) {\n      throw new JedisException(\"Can connect to sentinel, but \" + masterName\n          + \" seems to be not monitored...\");\n    } else {\n      throw new JedisConnectionException(\"All sentinels down, cannot determine where is \"\n          + masterName + \" master is running...\");\n    }\n  }\n    \n  log.info(\"Redis master running at \" + master + \", starting Sentinel listeners...\");\n    \n  for (String sentinel : sentinels) {\n    //Ip\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(\":\")));\n    //\n    MasterListener masterListener = new MasterListener(masterName, hap.getHost(), hap.getPort());\n    masterListener.setDaemon(true);\n    masterListeners.add(masterListener);\n    masterListener.start();\n  }\n  return master;\n}\n```\n\n```java\nprotected class MasterListener extends Thread {\n   //... \n    public void run() {\n      running.set(true);\n      while (running.get()) {\n        j = new Jedis(host, port);\n        try {\n          if (!running.get()) {\n            break;\n          }\n          //+switch-master\n          j.subscribe(new JedisPubSub() {\n            @Override\n            public void onMessage(String channel, String message) {\n              log.fine(\"Sentinel \" + host + \":\" + port + \" published: \" + message + \".\");\n              String[] switchMasterMsg = message.split(\" \");\n\n              if (switchMasterMsg.length > 3) {\n                if (masterName.equals(switchMasterMsg[0])) {\n                  //\n                  initPool(toHostAndPort(Arrays.asList(switchMasterMsg[3], switchMasterMsg[4])));\n                } else {\n                  log.fine(\"Ignoring message on +switch-master for master name \"\n                      + switchMasterMsg[0] + \", our master name is \" + masterName);\n                }\n\n              } else {\n                log.severe(\"Invalid message received on Sentinel \" + host + \":\" + port\n                    + \" on channel +switch-master: \" + message);\n              }\n            }\n          }, \"+switch-master\");\n\n        } catch (JedisConnectionException e) {\n\t\t\t//... \n        } finally {\n             //... \n        }\n      }\n    }\n  }\n```\n\n#### \n\nJedisSentinelPoolcommons.pool2initPoolMasterJedis(JedisFactory)\n\n```java\n//Jedis  \nprivate void initPool(HostAndPort master) {\n    if (!master.equals(currentHostMaster)) {\n      currentHostMaster = master;\n      if (factory == null) {\n        //Master\n        factory = new JedisFactory(master.getHost(), master.getPort(), connectionTimeout,\n            soTimeout, password, database, clientName);\n        initPool(poolConfig, factory);\n      } else {\n        factory.setHostAndPort(currentHostMaster);\n        internalPool.clear();\n      }\n      log.info(\"Created JedisPool to master at \" + master);\n    }\n  }\n```\n\n```java\n//redis/clients/jedis/JedisFactory/class  \n@Override\n  public PooledObject<Jedis> makeObject() throws Exception {\n    final HostAndPort hostAndPort = this.hostAndPort.get();\n    //\n    final Jedis jedis = new Jedis(hostAndPort.getHost(), hostAndPort.getPort(), connectionTimeout,\n        soTimeout);\n\n    jedis.connect();\n    if (null != this.password) {\n      jedis.auth(this.password);\n    }\n    if (database != 0) {\n      jedis.select(database);\n    }\n    if (clientName != null) {\n      jedis.clientSetname(clientName);\n    }\n    return new DefaultPooledObject<Jedis>(jedis);\n  }\n```\n\n\n\n- JedisSlaveSentinelPoolJedisSentinelPoolinitPoolJedisFactoryJedisSlaveFactory()MasterListenerJedisSentinelPoolMasterListener\n- JedisSlaveFactoryJedisFactorymakeObject\n- JedisUtils\n\n\n\n","slug":"redis-sentinel","published":1,"updated":"2021-04-08T00:47:06.977Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvr003bqwv25nzk0l95","content":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><p>Redis SentinelRedis<font color=\"red\"></font>Redis()<font color=\"red\"></font></p>\n<p>Redis Sentinel </p>\n<ul>\n<li>Sentinel </li>\n<li> Redis SentinelAPI</li>\n<li><ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/2020/08/14/redis-sentinel/1.png\" alt=\"redis\"></p>\n<p>redis<font color=\"red\"></font></p>\n<a id=\"more\"></a>\n\n<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\"># sentinel monitor mymaster 127.0.0.1 6379 2</span>\n<span class=\"token comment\" spellcheck=\"true\">#   &lt;master-name>   IP  &lt;ip>  &lt;port> </span>\n<span class=\"token comment\" spellcheck=\"true\">#quorum2</span>\n<span class=\"token comment\" spellcheck=\"true\">#number(sentinel)/2 + 1</span>\n<span class=\"token attr-name\">sentinel</span> <span class=\"token attr-value\">monitor &lt;master-name> &lt;ip> &lt;port> &lt;quorum></span>\n\n<span class=\"token comment\" spellcheck=\"true\">#sentinel down-after-milliseconds mymaster 2000</span>\n<span class=\"token comment\" spellcheck=\"true\">#pingRedispong</span>\n<span class=\"token comment\" spellcheck=\"true\">#</span>\n<span class=\"token attr-name\">sentinel</span> <span class=\"token attr-value\">down-after-milliseconds &lt;master-name> &lt;times></span>\n\n<span class=\"token comment\" spellcheck=\"true\">#sentinel parallel-syncs mymaster 2</span>\n<span class=\"token comment\" spellcheck=\"true\">#Redis</span>\n<span class=\"token comment\" spellcheck=\"true\">#</span>\n<span class=\"token comment\" spellcheck=\"true\">#?</span>\n<span class=\"token attr-name\">sentinel</span> <span class=\"token attr-value\">parallel-syncs &lt;master-name> &lt;nums></span>\n\n<span class=\"token comment\" spellcheck=\"true\">#sentinel failover-timeout mymaster 2000</span>\n<span class=\"token comment\" spellcheck=\"true\">#&lt;times></span>\n<span class=\"token attr-name\">sentinel</span> <span class=\"token attr-value\">failover-timeout &lt;master-name>  &lt;times></span>\n\n<span class=\"token comment\" spellcheck=\"true\">#sentinel auth-pass mymaster 123456</span>\n<span class=\"token comment\" spellcheck=\"true\">#</span>\n<span class=\"token attr-name\">sentinel</span> <span class=\"token attr-value\">auth-pass &lt;master-name> &lt;password></span></code></pre>\n<p></p>\n<ul>\n<li><font color=\"red\"></font>sentinelpingpongsentinelquorum()</li>\n<li></li>\n</ul>\n<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><h3 id=\"Leader\"><a href=\"#Leader\" class=\"headerlink\" title=\"Leader\"></a>Leader</h3><p>LeaderLeader<font color=\"red\">Raft</font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>sentinelleander sentinel</p>\n<ol>\n<li> </li>\n<li>slave-priority</li>\n<li></li>\n<li>run_id</li>\n</ol>\n<p>slaveof no oneslaveof</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>10infoinfo</li>\n<li>2redis__sentinel__:hello</li>\n<li>1ping</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>SentinelMasterSlave Sentinel  PING </li>\n<li>instance PING  down-after-milliseconds   Sentinel </li>\n<li>MasterMaster Sentinel Master </li>\n<li> SentinelMaster Master </li>\n<li>  Sentinel  10 MasterSlave INFO  </li>\n<li>Master Sentinel Sentinel  Master  Slave  INFO  10  </li>\n<li> Sentinel  Master  Master  </li>\n</ul>\n<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><p>redisredis masterredis slavesentinelsentinelmasterslavemaster<font color=\"red\"></font></p>\n<p><img src=\"/2020/08/14/redis-sentinel/2.png\" alt=\"redis\"></p>\n<p><strong></strong>  redis</p>\n<pre class=\" language-properties\"><code class=\"language-properties\"><span class=\"token comment\" spellcheck=\"true\">#masterslave,master</span>\n<span class=\"token attr-name\">min-replicas-to-write</span> <span class=\"token attr-value\">3</span>\n<span class=\"token comment\" spellcheck=\"true\">#slavemaster</span>\n<span class=\"token attr-name\">min-replicas-max-lag</span> <span class=\"token attr-value\">10</span></code></pre>\n<h2 id=\"Jedis\"><a href=\"#Jedis\" class=\"headerlink\" title=\"Jedis\"></a>Jedis</h2><h4 id=\"Jedis\"><a href=\"#Jedis\" class=\"headerlink\" title=\"Jedis\"></a>Jedis</h4><p>RedisJedis</p>\n<p><font color=\"red\">JedisJedis</font></p>\n<p><strong>Jedis</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test02</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    JedisPoolConfig jedisPoolConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisPoolConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedisPoolConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxTotal</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedisPoolConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxIdle</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedisPoolConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setMinIdle</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// </span>\n    Set<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> sentinels <span class=\"token operator\">=</span> \n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.135.131:26379\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"192.168.135.131:26380\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"192.168.135.131:26381\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    JedisSentinelPool pool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisSentinelPool</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mymaster\"</span><span class=\"token punctuation\">,</span> sentinels<span class=\"token punctuation\">,</span>jedisPoolConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Jedis jedis <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mykey\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"myvalue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    String value <span class=\"token operator\">=</span> jedis<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mykey\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>JedisSentinelPool</strong></p>\n<p></p>\n<ul>\n<li></li>\n<li>MasterListener+switch-masterinitPool(master)</li>\n</ul>\n<p><font color=\"red\">Jedis</font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token function\">JedisSentinelPool</span><span class=\"token punctuation\">(</span>String masterName<span class=\"token punctuation\">,</span> Set<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> sentinels<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">final</span> GenericObjectPoolConfig poolConfig<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> connectionTimeout<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> soTimeout<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">final</span> String password<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> database<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> String clientName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>poolConfig <span class=\"token operator\">=</span> poolConfig<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connectionTimeout <span class=\"token operator\">=</span> connectionTimeout<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>soTimeout <span class=\"token operator\">=</span> soTimeout<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> password<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>database <span class=\"token operator\">=</span> database<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientName <span class=\"token operator\">=</span> clientName<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\" spellcheck=\"true\">//</span>\n  HostAndPort master <span class=\"token operator\">=</span> <span class=\"token function\">initSentinels</span><span class=\"token punctuation\">(</span>sentinels<span class=\"token punctuation\">,</span> masterName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\" spellcheck=\"true\">//master</span>\n  <span class=\"token function\">initPool</span><span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> HostAndPort <span class=\"token function\">initSentinels</span><span class=\"token punctuation\">(</span>Set<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> sentinels<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> String masterName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  HostAndPort master <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">boolean</span> sentinelAvailable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Trying to find master from available Sentinels...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\" spellcheck=\"true\">//  </span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>String sentinel <span class=\"token operator\">:</span> sentinels<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> HostAndPort hap <span class=\"token operator\">=</span> <span class=\"token function\">toHostAndPort</span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>sentinel<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">fine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Connecting to Sentinel \"</span> <span class=\"token operator\">+</span> hap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Jedis jedis <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\" spellcheck=\"true\">//</span>\n      jedis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jedis</span><span class=\"token punctuation\">(</span>hap<span class=\"token punctuation\">.</span><span class=\"token function\">getHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hap<span class=\"token punctuation\">.</span><span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\" spellcheck=\"true\">//IpmasterName</span>\n      List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> masterAddr <span class=\"token operator\">=</span> jedis<span class=\"token punctuation\">.</span><span class=\"token function\">sentinelGetMasterAddrByName</span><span class=\"token punctuation\">(</span>masterName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\" spellcheck=\"true\">//  </span>\n      sentinelAvailable <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\" spellcheck=\"true\">//</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>masterAddr <span class=\"token operator\">==</span> null <span class=\"token operator\">||</span> masterAddr<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">warning</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can not get master addr, master name: \"</span> <span class=\"token operator\">+</span> masterName <span class=\"token operator\">+</span> <span class=\"token string\">\". Sentinel: \"</span> <span class=\"token operator\">+</span> hap\n            <span class=\"token operator\">+</span> <span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n     <span class=\"token comment\" spellcheck=\"true\">//HostAndPort</span>\n      master <span class=\"token operator\">=</span> <span class=\"token function\">toHostAndPort</span><span class=\"token punctuation\">(</span>masterAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      log<span class=\"token punctuation\">.</span><span class=\"token function\">fine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Found Redis master at \"</span> <span class=\"token operator\">+</span> master<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JedisConnectionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      log<span class=\"token punctuation\">.</span><span class=\"token function\">warning</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot connect to sentinel running @ \"</span> <span class=\"token operator\">+</span> hap <span class=\"token operator\">+</span> <span class=\"token string\">\". Trying next one.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>jedis <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        jedis<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\" spellcheck=\"true\">//</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>master <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sentinelAvailable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can connect to sentinel, but \"</span> <span class=\"token operator\">+</span> masterName\n          <span class=\"token operator\">+</span> <span class=\"token string\">\" seems to be not monitored...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisConnectionException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All sentinels down, cannot determine where is \"</span>\n          <span class=\"token operator\">+</span> masterName <span class=\"token operator\">+</span> <span class=\"token string\">\" master is running...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Redis master running at \"</span> <span class=\"token operator\">+</span> master <span class=\"token operator\">+</span> <span class=\"token string\">\", starting Sentinel listeners...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>String sentinel <span class=\"token operator\">:</span> sentinels<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Ip</span>\n    <span class=\"token keyword\">final</span> HostAndPort hap <span class=\"token operator\">=</span> <span class=\"token function\">toHostAndPort</span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>sentinel<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    MasterListener masterListener <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MasterListener</span><span class=\"token punctuation\">(</span>masterName<span class=\"token punctuation\">,</span> hap<span class=\"token punctuation\">.</span><span class=\"token function\">getHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hap<span class=\"token punctuation\">.</span><span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    masterListener<span class=\"token punctuation\">.</span><span class=\"token function\">setDaemon</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    masterListeners<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>masterListener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    masterListener<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> master<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MasterListener</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\" spellcheck=\"true\">//... </span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      running<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        j <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jedis</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>running<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token comment\" spellcheck=\"true\">//+switch-master</span>\n          j<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisPubSub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span>String channel<span class=\"token punctuation\">,</span> String message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              log<span class=\"token punctuation\">.</span><span class=\"token function\">fine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sentinel \"</span> <span class=\"token operator\">+</span> host <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> port <span class=\"token operator\">+</span> <span class=\"token string\">\" published: \"</span> <span class=\"token operator\">+</span> message <span class=\"token operator\">+</span> <span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> switchMasterMsg <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>switchMasterMsg<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>masterName<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>switchMasterMsg<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token comment\" spellcheck=\"true\">//</span>\n                  <span class=\"token function\">initPool</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHostAndPort</span><span class=\"token punctuation\">(</span>Arrays<span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>switchMasterMsg<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> switchMasterMsg<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                  log<span class=\"token punctuation\">.</span><span class=\"token function\">fine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Ignoring message on +switch-master for master name \"</span>\n                      <span class=\"token operator\">+</span> switchMasterMsg<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\", our master name is \"</span> <span class=\"token operator\">+</span> masterName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n              <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                log<span class=\"token punctuation\">.</span><span class=\"token function\">severe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid message received on Sentinel \"</span> <span class=\"token operator\">+</span> host <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> port\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\" on channel +switch-master: \"</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"+switch-master\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JedisConnectionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//... </span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n             <span class=\"token comment\" spellcheck=\"true\">//... </span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>JedisSentinelPoolcommons.pool2initPoolMasterJedis(JedisFactory)</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//Jedis  </span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initPool</span><span class=\"token punctuation\">(</span>HostAndPort master<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>master<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>currentHostMaster<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      currentHostMaster <span class=\"token operator\">=</span> master<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>factory <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//Master</span>\n        factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JedisFactory</span><span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">.</span><span class=\"token function\">getHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> master<span class=\"token punctuation\">.</span><span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> connectionTimeout<span class=\"token punctuation\">,</span>\n            soTimeout<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> database<span class=\"token punctuation\">,</span> clientName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">initPool</span><span class=\"token punctuation\">(</span>poolConfig<span class=\"token punctuation\">,</span> factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setHostAndPort</span><span class=\"token punctuation\">(</span>currentHostMaster<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        internalPool<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Created JedisPool to master at \"</span> <span class=\"token operator\">+</span> master<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//redis/clients/jedis/JedisFactory/class  </span>\n<span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> PooledObject<span class=\"token operator\">&lt;</span>Jedis<span class=\"token operator\">></span> <span class=\"token function\">makeObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> HostAndPort hostAndPort <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>hostAndPort<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">final</span> Jedis jedis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Jedis</span><span class=\"token punctuation\">(</span>hostAndPort<span class=\"token punctuation\">.</span><span class=\"token function\">getHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hostAndPort<span class=\"token punctuation\">.</span><span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> connectionTimeout<span class=\"token punctuation\">,</span>\n        soTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    jedis<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>null <span class=\"token operator\">!=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      jedis<span class=\"token punctuation\">.</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>database <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      jedis<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>clientName <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      jedis<span class=\"token punctuation\">.</span><span class=\"token function\">clientSetname</span><span class=\"token punctuation\">(</span>clientName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultPooledObject</span><span class=\"token operator\">&lt;</span>Jedis<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>jedis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<ul>\n<li>JedisSlaveSentinelPoolJedisSentinelPoolinitPoolJedisFactoryJedisSlaveFactory()MasterListenerJedisSentinelPoolMasterListener</li>\n<li>JedisSlaveFactoryJedisFactorymakeObject</li>\n<li>JedisUtils</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><p>Redis SentinelRedis<font color=\"red\"></font>Redis()<font color=\"red\"></font></p>\n<p>Redis Sentinel </p>\n<ul>\n<li>Sentinel </li>\n<li> Redis SentinelAPI</li>\n<li><ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/2020/08/14/redis-sentinel/1.png\" alt=\"redis\"></p>\n<p>redis<font color=\"red\"></font></p>","more":"<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><pre><code class=\"properties\"># sentinel monitor mymaster 127.0.0.1 6379 2\n#   &lt;master-name&gt;   IP  &lt;ip&gt;  &lt;port&gt; \n#quorum2\n#number(sentinel)/2 + 1\nsentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;\n\n#sentinel down-after-milliseconds mymaster 2000\n#pingRedispong\n#\nsentinel down-after-milliseconds &lt;master-name&gt; &lt;times&gt;\n\n#sentinel parallel-syncs mymaster 2\n#Redis\n#\n#?\nsentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;\n\n#sentinel failover-timeout mymaster 2000\n#&lt;times&gt;\nsentinel failover-timeout &lt;master-name&gt;  &lt;times&gt;\n\n#sentinel auth-pass mymaster 123456\n#\nsentinel auth-pass &lt;master-name&gt; &lt;password&gt;</code></pre>\n<p></p>\n<ul>\n<li><font color=\"red\"></font>sentinelpingpongsentinelquorum()</li>\n<li></li>\n</ul>\n<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><h3 id=\"Leader\"><a href=\"#Leader\" class=\"headerlink\" title=\"Leader\"></a>Leader</h3><p>LeaderLeader<font color=\"red\">Raft</font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>sentinelleander sentinel</p>\n<ol>\n<li> </li>\n<li>slave-priority</li>\n<li></li>\n<li>run_id</li>\n</ol>\n<p>slaveof no oneslaveof</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>10infoinfo</li>\n<li>2redis__sentinel__:hello</li>\n<li>1ping</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>SentinelMasterSlave Sentinel  PING </li>\n<li>instance PING  down-after-milliseconds   Sentinel </li>\n<li>MasterMaster Sentinel Master </li>\n<li> SentinelMaster Master </li>\n<li>  Sentinel  10 MasterSlave INFO  </li>\n<li>Master Sentinel Sentinel  Master  Slave  INFO  10  </li>\n<li> Sentinel  Master  Master  </li>\n</ul>\n<h2 id=\"Redis\"><a href=\"#Redis\" class=\"headerlink\" title=\"Redis\"></a>Redis</h2><p>redisredis masterredis slavesentinelsentinelmasterslavemaster<font color=\"red\"></font></p>\n<p><img src=\"/2020/08/14/redis-sentinel/2.png\" alt=\"redis\"></p>\n<p><strong></strong>  redis</p>\n<pre><code class=\"properties\">#masterslave,master\nmin-replicas-to-write 3\n#slavemaster\nmin-replicas-max-lag 10</code></pre>\n<h2 id=\"Jedis\"><a href=\"#Jedis\" class=\"headerlink\" title=\"Jedis\"></a>Jedis</h2><h4 id=\"Jedis\"><a href=\"#Jedis\" class=\"headerlink\" title=\"Jedis\"></a>Jedis</h4><p>RedisJedis</p>\n<p><font color=\"red\">JedisJedis</font></p>\n<p><strong>Jedis</strong></p>\n<pre><code class=\"java\">@Test\npublic void test02(){\n    JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n    jedisPoolConfig.setMaxTotal(10);\n    jedisPoolConfig.setMaxIdle(5);\n    jedisPoolConfig.setMinIdle(5);\n    // \n    Set&lt;String&gt; sentinels = \n        new HashSet&lt;&gt;(Arrays.asList(&quot;192.168.135.131:26379&quot;,&quot;192.168.135.131:26380&quot;,&quot;192.168.135.131:26381&quot;));\n    JedisSentinelPool pool = new JedisSentinelPool(&quot;mymaster&quot;, sentinels,jedisPoolConfig);\n    Jedis jedis = pool.getResource();\n    jedis.set(&quot;mykey&quot;, &quot;myvalue&quot;);\n    String value = jedis.get(&quot;mykey&quot;);\n    System.out.println(value);\n}</code></pre>\n<p><strong>JedisSentinelPool</strong></p>\n<p></p>\n<ul>\n<li></li>\n<li>MasterListener+switch-masterinitPool(master)</li>\n</ul>\n<p><font color=\"red\">Jedis</font></p>\n<pre><code class=\"java\">public JedisSentinelPool(String masterName, Set&lt;String&gt; sentinels,\n    final GenericObjectPoolConfig poolConfig, final int connectionTimeout, final int soTimeout,\n    final String password, final int database, final String clientName) {\n  this.poolConfig = poolConfig;\n  this.connectionTimeout = connectionTimeout;\n  this.soTimeout = soTimeout;\n  this.password = password;\n  this.database = database;\n  this.clientName = clientName;\n  //\n  HostAndPort master = initSentinels(sentinels, masterName);\n  //master\n  initPool(master);\n}\n\n//\nprivate HostAndPort initSentinels(Set&lt;String&gt; sentinels, final String masterName) {\n  HostAndPort master = null;\n  boolean sentinelAvailable = false;\n  log.info(&quot;Trying to find master from available Sentinels...&quot;);\n  //  \n  for (String sentinel : sentinels) {\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(&quot;:&quot;)));\n    log.fine(&quot;Connecting to Sentinel &quot; + hap);\n    Jedis jedis = null;\n    try {\n      //\n      jedis = new Jedis(hap.getHost(), hap.getPort());\n      //IpmasterName\n      List&lt;String&gt; masterAddr = jedis.sentinelGetMasterAddrByName(masterName);\n      //  \n      sentinelAvailable = true;\n      //\n      if (masterAddr == null || masterAddr.size() != 2) {\n        log.warning(&quot;Can not get master addr, master name: &quot; + masterName + &quot;. Sentinel: &quot; + hap\n            + &quot;.&quot;);\n        continue;\n      }\n     //HostAndPort\n      master = toHostAndPort(masterAddr);\n      log.fine(&quot;Found Redis master at &quot; + master);\n      break;\n    } catch (JedisConnectionException e) {\n      log.warning(&quot;Cannot connect to sentinel running @ &quot; + hap + &quot;. Trying next one.&quot;);\n    } finally {\n      if (jedis != null) {\n        jedis.close();\n      }\n    }\n  }\n\n  //\n  if (master == null) {\n    if (sentinelAvailable) {\n      throw new JedisException(&quot;Can connect to sentinel, but &quot; + masterName\n          + &quot; seems to be not monitored...&quot;);\n    } else {\n      throw new JedisConnectionException(&quot;All sentinels down, cannot determine where is &quot;\n          + masterName + &quot; master is running...&quot;);\n    }\n  }\n\n  log.info(&quot;Redis master running at &quot; + master + &quot;, starting Sentinel listeners...&quot;);\n\n  for (String sentinel : sentinels) {\n    //Ip\n    final HostAndPort hap = toHostAndPort(Arrays.asList(sentinel.split(&quot;:&quot;)));\n    //\n    MasterListener masterListener = new MasterListener(masterName, hap.getHost(), hap.getPort());\n    masterListener.setDaemon(true);\n    masterListeners.add(masterListener);\n    masterListener.start();\n  }\n  return master;\n}</code></pre>\n<pre><code class=\"java\">protected class MasterListener extends Thread {\n   //... \n    public void run() {\n      running.set(true);\n      while (running.get()) {\n        j = new Jedis(host, port);\n        try {\n          if (!running.get()) {\n            break;\n          }\n          //+switch-master\n          j.subscribe(new JedisPubSub() {\n            @Override\n            public void onMessage(String channel, String message) {\n              log.fine(&quot;Sentinel &quot; + host + &quot;:&quot; + port + &quot; published: &quot; + message + &quot;.&quot;);\n              String[] switchMasterMsg = message.split(&quot; &quot;);\n\n              if (switchMasterMsg.length &gt; 3) {\n                if (masterName.equals(switchMasterMsg[0])) {\n                  //\n                  initPool(toHostAndPort(Arrays.asList(switchMasterMsg[3], switchMasterMsg[4])));\n                } else {\n                  log.fine(&quot;Ignoring message on +switch-master for master name &quot;\n                      + switchMasterMsg[0] + &quot;, our master name is &quot; + masterName);\n                }\n\n              } else {\n                log.severe(&quot;Invalid message received on Sentinel &quot; + host + &quot;:&quot; + port\n                    + &quot; on channel +switch-master: &quot; + message);\n              }\n            }\n          }, &quot;+switch-master&quot;);\n\n        } catch (JedisConnectionException e) {\n            //... \n        } finally {\n             //... \n        }\n      }\n    }\n  }</code></pre>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>JedisSentinelPoolcommons.pool2initPoolMasterJedis(JedisFactory)</p>\n<pre><code class=\"java\">//Jedis  \nprivate void initPool(HostAndPort master) {\n    if (!master.equals(currentHostMaster)) {\n      currentHostMaster = master;\n      if (factory == null) {\n        //Master\n        factory = new JedisFactory(master.getHost(), master.getPort(), connectionTimeout,\n            soTimeout, password, database, clientName);\n        initPool(poolConfig, factory);\n      } else {\n        factory.setHostAndPort(currentHostMaster);\n        internalPool.clear();\n      }\n      log.info(&quot;Created JedisPool to master at &quot; + master);\n    }\n  }</code></pre>\n<pre><code class=\"java\">//redis/clients/jedis/JedisFactory/class  \n@Override\n  public PooledObject&lt;Jedis&gt; makeObject() throws Exception {\n    final HostAndPort hostAndPort = this.hostAndPort.get();\n    //\n    final Jedis jedis = new Jedis(hostAndPort.getHost(), hostAndPort.getPort(), connectionTimeout,\n        soTimeout);\n\n    jedis.connect();\n    if (null != this.password) {\n      jedis.auth(this.password);\n    }\n    if (database != 0) {\n      jedis.select(database);\n    }\n    if (clientName != null) {\n      jedis.clientSetname(clientName);\n    }\n    return new DefaultPooledObject&lt;Jedis&gt;(jedis);\n  }</code></pre>\n<p></p>\n<ul>\n<li>JedisSlaveSentinelPoolJedisSentinelPoolinitPoolJedisFactoryJedisSlaveFactory()MasterListenerJedisSentinelPoolMasterListener</li>\n<li>JedisSlaveFactoryJedisFactorymakeObject</li>\n<li>JedisUtils</li>\n</ul>"},{"title":"ShardingJdbc","description":"ShardingJdbczookeeper","date":"2021-02-02T02:25:35.000Z","_content":"## \n\n## ShardingSphere\n\n### \n\nShardingSphere\nShardingSphereShardingJdcbymlxml100\n\n1. 100yml\n2. 100Tomcat\n\n  \n\nShardingSphereShardingSphere + Zookeeper  Etcd   ZookeeperWatch<font color=red></font>\n<!--more-->\n### \n\nMaven\n\n```xml\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-orchestration-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-orchestration-reg-zookeeper-curator</artifactId>\n            <version>3.0.0</version>\n</dependency>\n```\n\n\n\n```java\n@Test\npublic void testOrchestration2() throws Exception {\n\n    //zk\n    deleteZkDataSourceAndRule();\n    //DataSourcezk\n    initDataSourceZkData();\n    //ZK\n    initRuleZkData();\n\n    ZookeeperConfiguration regConfig = new ZookeeperConfiguration();\n    regConfig.setServerLists(\"localhost:2181\");\n    regConfig.setNamespace(\"sharding-data\");\n    OrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(\"xuzy\",regConfig,false, OrchestrationType.SHARDING);\n    //OrchestrationShardingDataSourceFactoryShardingDataSource\n    DataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);\n    //\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    // 2021\n    List<Map<String, Object>> list = jdbcTemplate.queryForList(\"select * from flow where flowtime in ('20170818','20190205')\");\n\n\n    //DataSourcedataSource_2021ZK\n    updateDataSourceZkData();\n    //(flow2021)ZK\n    updateRuleZkData();\n\n    TimeUnit.SECONDS.sleep(20);\n\n    // 2021\n    List<Map<String, Object>> listNew = jdbcTemplate.queryForList(\"select * from flow where flowtime in ('20170818','20190205','20210405')\");\n    System.out.println(listNew);\n}\n```\n\nzookeepersharding\n\n```java\n@Test\npublic void deleteZkDataSourceAndRule() throws Exception {\n    //zookeeperio.shardingsphere.jdbc.orchestration.internal.config.ConfigurationNode\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    Stat stat = cf.checkExists().forPath(\"/sharding-data/xuzy/config/datasource\");\n    if(stat != null){\n        cf.delete().forPath(\"/sharding-data/xuzy/config/datasource\");\n    }\n    Stat stat2 = cf.checkExists().forPath(\"/sharding-data/xuzy/config/sharding/rule\");\n    if(stat2 != null){\n        cf.delete().forPath(\"/sharding-data/xuzy/config/sharding/rule\");\n    }\n    cf.close();\n}\n```\n\nDataSourcezookeeper\n\n```java\n@Test\npublic void initDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    //datasource orchestration-sharding-data-source datasourceymal\n    //Map<String, DataSource> result = DataSourceConverter.dataSourceMapFromYaml(this.regCenter.getDirectly(this.configNode.getFullPath(\"config/datasource\")));\n    String dataSource = \"\" +\n            \"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\";\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(\"/sharding-data/xuzy/config/datasource\", dataSource.getBytes());\n    cf.close();\n}\n```\n\nZookeeper\n\n```java\n@Test\npublic void initRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = \"  tables:\\n\" +\n            \"    flow:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    ips:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    acca:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\" +\n            \"  bindingTables:\\n\" +\n            \"    - flow,ips,acca\\n\" +\n            \"  defaultDatabaseStrategy:\\n\" +\n            \"    none:\\n\" +\n            \"  defaultTableStrategy:\\n\" +\n            \"    none:\";\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(\"/sharding-data/xuzy/config/sharding/rule\", rule.getBytes());\n    cf.close();\n}\n```\n\nDataSourcedataSource_2021Zookeeper\n\n```java\n@Test\npublic void updateDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String dataSource = \"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2021: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2021?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\";\n    //\n    cf.setData().forPath(\"/sharding-data/xuzy/config/datasource\", dataSource.getBytes());\n}\n```\n\n(flow2021)Zookeeper\n\n```java\n@Test\npublic void updateRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = \"  tables:\\n\" +\n            \"    flow:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2021}.flow_0${1..9},dataSource_${2017..2021}.flow_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    ips:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    acca:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\" +\n            \"  bindingTables:\\n\" +\n            \"    - flow,ips,acca\\n\" +\n            \"  defaultDatabaseStrategy:\\n\" +\n            \"    none:\\n\" +\n            \"  defaultTableStrategy:\\n\" +\n            \"    none:\";\n    //\n    cf.setData().forPath(\"/sharding-data/xuzy/config/sharding/rule\", rule.getBytes());\n}\n```\n\n### \n\n```java\nZookeeperConfiguration regConfig = new ZookeeperConfiguration();\nregConfig.setServerLists(\"localhost:2181\");\n//namespace\nregConfig.setNamespace(\"sharding-data\");\nOrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(\"xuzy\",regConfig,false, OrchestrationType.SHARDING);\n//OrchestrationShardingDataSourceFactoryShardingDataSource\nDataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);\n```\n\n#### OrchestrationConfiguration\n\n```java\n@RequiredArgsConstructor\n@Getter\npublic final class OrchestrationConfiguration {\n    //\n    //zkname = prod\n    private final String name;\n    //zookeeperEtcd\n    private final RegistryCenterConfiguration regCenterConfig;\n    //\n    private final boolean overwrite;\n    //shardingsharding\n    private final OrchestrationType type;\n}\n```\n\n```java\n//zookeeper\n@RequiredArgsConstructor\npublic final class ConfigurationNode {\n    public static final String ROOT = \"config\";\n    public static final String PROXY_NODE_PATH = ROOT + \"/proxy\";\n    //namespace +  zookeeper\n    //namespace = sharding-data name() = xuzy \n    ///sharding-data/xuzy/config/datasource\n    public static final String DATA_SOURCE_NODE_PATH = ROOT + \"/datasource\";\n    public static final String SHARDING_NODE_PATH = ROOT + \"/sharding\";\n    public static final String MASTER_SLAVE_NODE_PATH = ROOT + \"/masterslave\";\n    public static final String RULE_NODE_PATH = \"/rule\";\n    public static final String CONFIG_MAP_NODE_PATH = \"/configmap\";\n    public static final String SHARDING_RULE_NODE_PATH = SHARDING_NODE_PATH + RULE_NODE_PATH;\n    public static final String SHARDING_CONFIG_MAP_NODE_PATH = SHARDING_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String SHARDING_PROPS_NODE_PATH = SHARDING_NODE_PATH + \"/props\";\n    public static final String MASTER_SLAVE_RULE_NODE_PATH = MASTER_SLAVE_NODE_PATH + RULE_NODE_PATH;\n    public static final String MASTER_SLAVE_CONFIG_MAP_NODE_PATH = MASTER_SLAVE_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String MASTER_SLAVE_PROPS_NODE_PATH = MASTER_SLAVE_NODE_PATH + \"/props\";\n    public static final String PROXY_RULE_NODE_PATH = PROXY_NODE_PATH + RULE_NODE_PATH;\n    private final String name;\n    /**\n     * Get node full path.\n     *\n     * @param node node name\n     * @return node full path\n     */\n    public String getFullPath(final String node) {\n        return String.format(\"/%s/%s\", name, node);\n    }\n}\n```\n\n#### shardingDataSource\n\nshardingDataSource\n\n- OrchestrationShardingDataSourceFactory shardingDataSource\n- OrchestrationMasterSlaveDataSourceFactory shardingDataSource\n\n```java\n@NoArgsConstructor(access = AccessLevel.PRIVATE)\npublic final class OrchestrationShardingDataSourceFactory {\n    public static DataSource createDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n        return new OrchestrationShardingDataSource(orchestrationConfig);\n    }\n}\n```\n\n#### ShardingDataSource\n\nOrchestrationShardingDataSourceDataSourcezookeeperShardingDataSource\n\n![](shardingjdbc-reg/1.png)\n\n\n\n1. OrchestrationFacadezookeeperetcd\n2. \n3. ShardingDataSource\n4. watchShardingDataSource\n\n```java\npublic OrchestrationShardingDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n    //OrchestrationFacadezookeeperetcd\n    super(new OrchestrationFacade(orchestrationConfig));\n    ConfigurationService configService = getOrchestrationFacade().getConfigService();\n    //\n    ShardingRuleConfiguration shardingRuleConfig = configService.loadShardingRuleConfiguration();\n    Preconditions.checkNotNull(shardingRuleConfig, \"Missing the sharding rule configuration on register center\");\n    //ShardingDataSource\n    dataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n            new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());\n    //watchShardingDataSource\n    initOrchestrationFacade(dataSource);\n}\n```\n\nOrchestrationFacadezookeeperetcd\n\n```java\npublic OrchestrationFacade(final OrchestrationConfiguration orchestrationConfig) {\n    //\n    regCenter = createRegistryCenter(orchestrationConfig.getRegCenterConfig());\n    isOverwrite = orchestrationConfig.isOverwrite();\n    //service\n    configService = new ConfigurationService(orchestrationConfig.getName(), regCenter);\n    //service\n    instanceStateService = new InstanceStateService(orchestrationConfig.getName(), regCenter);\n    //service\n    dataSourceService = new DataSourceService(orchestrationConfig.getName(), regCenter);\n    listenerManager = new ListenerFactory(orchestrationConfig.getName(), regCenter);\n}\n\nprivate RegistryCenter createRegistryCenter(final RegistryCenterConfiguration regCenterConfig) {\n    Preconditions.checkNotNull(regCenterConfig, \"Registry center configuration cannot be null.\");\n    //ZookeeperConfigurationzookeeper\n    if (regCenterConfig instanceof ZookeeperConfiguration) {\n        return getZookeeperRegistryCenter((ZookeeperConfiguration) regCenterConfig);\n    }\n    if (regCenterConfig instanceof EtcdConfiguration) {\n        return new EtcdRegistryCenter((EtcdConfiguration) regCenterConfig);\n    }\n    throw new UnsupportedOperationException(regCenterConfig.getClass().getName());\n}\n\nprivate RegistryCenter getZookeeperRegistryCenter(final ZookeeperConfiguration regCenterConfig) {\n    if (regCenterConfig.isUseNative()) {\n        //\n        return new NewZookeeperRegistryCenter(regCenterConfig);\n    } else {\n        // Curatorzookeeper\n        return new ZookeeperRegistryCenter(regCenterConfig);\n    }\n}\n```\n\n\n\n\n\n```java\npublic ShardingRuleConfiguration loadShardingRuleConfiguration() {\n    try {\n        // /namespace/name/config/sharding/rule ShardingRuleConfiguration\n        ShardingRuleConfiguration result = ShardingConfigurationConverter.shardingRuleConfigFromYaml(regCenter.getDirectly(configNode.getFullPath(ConfigurationNode.SHARDING_RULE_NODE_PATH)));\n        Preconditions.checkState(null != result && !result.getTableRuleConfigs().isEmpty(), \"No available sharding rule configuration to load.\");\n        return result;\n    } catch (final Exception ex) {\n        throw new ShardingConfigurationException(\"No available sharding rule configuration to load.\");\n    }\n}\n```\n\nshardingDataSource\n\n```java\ndataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n                new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());\n```\n\nwatchShardingDataSource\n\n```java\npublic void init(final Map<String, DataSource> dataSourceMap, final ShardingRuleConfiguration shardingRuleConfig, \n                 final Map<String, Object> configMap, final Properties props) {\n    //\n    if (shardingRuleConfig.getMasterSlaveRuleConfigs().isEmpty()) {\n        reviseShardingRuleConfigurationForMasterSlave(dataSourceMap, shardingRuleConfig);\n    }\n    //isOverwrite\n    //true\n    configService.persistShardingConfiguration(getActualDataSourceMapForMasterSlave(dataSourceMap), shardingRuleConfig, configMap, props, isOverwrite);\n    //sharingjdbc  /namespace/name/state/instances\n    //\n    instanceStateService.persistShardingInstanceOnline();\n    dataSourceService.persistDataSourcesNode();\n    //Watch\n    listenerManager.initShardingListeners();\n}\n```\n\n```java\npublic void initShardingListeners() {\n    //Watch\n    configurationListenerManager.watchSharding();\n    //Watch\n    instanceListenerManager.watchSharding();\n    //Watch\n    dataSourceListenerManager.watchSharding();\n    //configmapWatch\n    configMapListenerManager.watchSharding();\n}\n\n//\nwatchSharding(ConfigurationNode.SHARDING_RULE_NODE_PATH);\nprivate void watchSharding(final String node) {\n    String cachePath = configNode.getFullPath(node);\n    regCenter.watch(cachePath, new EventListener() {\n        \n        @Override\n        public void onChange(final DataChangedEvent event) {\n            ///sharding-data/xuzy/config/sharding/rule\n            if (DataChangedEvent.Type.UPDATED == event.getEventType()) {\n                //\n                Map<String, DataSource> dataSourceMap = dataSourceService.getAvailableDataSources();\n                //\n                ShardingConfigurationEventBusEvent shardingEvent = new ShardingConfigurationEventBusEvent(dataSourceMap,\n                        new ShardingRule(dataSourceService.getAvailableShardingRuleConfiguration(), dataSourceMap.keySet()), configService.loadShardingProperties());\n                //guavaEventBusshardingDataSource EventBus\n                ShardingEventBusInstance.getInstance().post(shardingEvent);\n            }\n        }\n    });\n}\n```\n\n#### EventBus\n\nEventBusguava\n\n```java\npublic class EventBusTest {\n\n    public static void main(String[] args){\n        final EventBus eventBus = new EventBus();\n        //\n        eventBus.register(new SimpleListener());\n        eventBus.register(new SimpleListener2());\n        //post\n        eventBus.post(\"Simple Event\");\n    }\n\n    static class SimpleListener {\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + \"_1\");\n        }\n    }\n\n    static class SimpleListener2{\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + \"_2\");\n        }\n    }\n}\n```\n\nWatch\n\n```java\nShardingEventBusInstance.getInstance().post(shardingEvent);\n```\n\n![](shardingjdbc-reg/2.png)\n\n## \n\nzookeeperWatchshardingjdbc","source":"_posts/shardingjdbc-reg.md","raw":"---\ntitle: ShardingJdbc\ntags:\n  - shardingjdbc\ncategories: \n  - shardingjdbc\ndescription : ShardingJdbczookeeper\ndate: 2021-02-02 10:25:35\n---\n## \n\n## ShardingSphere\n\n### \n\nShardingSphere\nShardingSphereShardingJdcbymlxml100\n\n1. 100yml\n2. 100Tomcat\n\n  \n\nShardingSphereShardingSphere + Zookeeper  Etcd   ZookeeperWatch<font color=red></font>\n<!--more-->\n### \n\nMaven\n\n```xml\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-orchestration-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-orchestration-reg-zookeeper-curator</artifactId>\n            <version>3.0.0</version>\n</dependency>\n```\n\n\n\n```java\n@Test\npublic void testOrchestration2() throws Exception {\n\n    //zk\n    deleteZkDataSourceAndRule();\n    //DataSourcezk\n    initDataSourceZkData();\n    //ZK\n    initRuleZkData();\n\n    ZookeeperConfiguration regConfig = new ZookeeperConfiguration();\n    regConfig.setServerLists(\"localhost:2181\");\n    regConfig.setNamespace(\"sharding-data\");\n    OrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(\"xuzy\",regConfig,false, OrchestrationType.SHARDING);\n    //OrchestrationShardingDataSourceFactoryShardingDataSource\n    DataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);\n    //\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    // 2021\n    List<Map<String, Object>> list = jdbcTemplate.queryForList(\"select * from flow where flowtime in ('20170818','20190205')\");\n\n\n    //DataSourcedataSource_2021ZK\n    updateDataSourceZkData();\n    //(flow2021)ZK\n    updateRuleZkData();\n\n    TimeUnit.SECONDS.sleep(20);\n\n    // 2021\n    List<Map<String, Object>> listNew = jdbcTemplate.queryForList(\"select * from flow where flowtime in ('20170818','20190205','20210405')\");\n    System.out.println(listNew);\n}\n```\n\nzookeepersharding\n\n```java\n@Test\npublic void deleteZkDataSourceAndRule() throws Exception {\n    //zookeeperio.shardingsphere.jdbc.orchestration.internal.config.ConfigurationNode\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    Stat stat = cf.checkExists().forPath(\"/sharding-data/xuzy/config/datasource\");\n    if(stat != null){\n        cf.delete().forPath(\"/sharding-data/xuzy/config/datasource\");\n    }\n    Stat stat2 = cf.checkExists().forPath(\"/sharding-data/xuzy/config/sharding/rule\");\n    if(stat2 != null){\n        cf.delete().forPath(\"/sharding-data/xuzy/config/sharding/rule\");\n    }\n    cf.close();\n}\n```\n\nDataSourcezookeeper\n\n```java\n@Test\npublic void initDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    //datasource orchestration-sharding-data-source datasourceymal\n    //Map<String, DataSource> result = DataSourceConverter.dataSourceMapFromYaml(this.regCenter.getDirectly(this.configNode.getFullPath(\"config/datasource\")));\n    String dataSource = \"\" +\n            \"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\";\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(\"/sharding-data/xuzy/config/datasource\", dataSource.getBytes());\n    cf.close();\n}\n```\n\nZookeeper\n\n```java\n@Test\npublic void initRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = \"  tables:\\n\" +\n            \"    flow:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    ips:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    acca:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\" +\n            \"  bindingTables:\\n\" +\n            \"    - flow,ips,acca\\n\" +\n            \"  defaultDatabaseStrategy:\\n\" +\n            \"    none:\\n\" +\n            \"  defaultTableStrategy:\\n\" +\n            \"    none:\";\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(\"/sharding-data/xuzy/config/sharding/rule\", rule.getBytes());\n    cf.close();\n}\n```\n\nDataSourcedataSource_2021Zookeeper\n\n```java\n@Test\npublic void updateDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String dataSource = \"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\\n\" +\n            \"  dataSource_2021: !!org.apache.commons.dbcp.BasicDataSource\\n\" +\n            \"    driverClassName: com.mysql.jdbc.Driver\\n\" +\n            \"    url: jdbc:mysql://localhost:3306/sharding_2021?useUnicode=true&amp;characterEncoding=utf-8\\n\" +\n            \"    username: root\\n\" +\n            \"    password: 123456\\n\" +\n            \"    initialSize : 0\\n\" +\n            \"    maxActive : 200\\n\" +\n            \"    maxIdle : 20\\n\" +\n            \"    minIdle : 1\\n\" +\n            \"    maxWait : 60000\";\n    //\n    cf.setData().forPath(\"/sharding-data/xuzy/config/datasource\", dataSource.getBytes());\n}\n```\n\n(flow2021)Zookeeper\n\n```java\n@Test\npublic void updateRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = \"  tables:\\n\" +\n            \"    flow:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2021}.flow_0${1..9},dataSource_${2017..2021}.flow_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    ips:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        standard:\\n\" +\n            \"          shardingColumn: flowtime\\n\" +\n            \"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\" +\n            \"    acca:\\n\" +\n            \"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\" +\n            \"      tableStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\" +\n            \"      databaseStrategy:\\n\" +\n            \"        complex:\\n\" +\n            \"          shardingColumns: flowtime,dataType\\n\" +\n            \"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\" +\n            \"  bindingTables:\\n\" +\n            \"    - flow,ips,acca\\n\" +\n            \"  defaultDatabaseStrategy:\\n\" +\n            \"    none:\\n\" +\n            \"  defaultTableStrategy:\\n\" +\n            \"    none:\";\n    //\n    cf.setData().forPath(\"/sharding-data/xuzy/config/sharding/rule\", rule.getBytes());\n}\n```\n\n### \n\n```java\nZookeeperConfiguration regConfig = new ZookeeperConfiguration();\nregConfig.setServerLists(\"localhost:2181\");\n//namespace\nregConfig.setNamespace(\"sharding-data\");\nOrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(\"xuzy\",regConfig,false, OrchestrationType.SHARDING);\n//OrchestrationShardingDataSourceFactoryShardingDataSource\nDataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);\n```\n\n#### OrchestrationConfiguration\n\n```java\n@RequiredArgsConstructor\n@Getter\npublic final class OrchestrationConfiguration {\n    //\n    //zkname = prod\n    private final String name;\n    //zookeeperEtcd\n    private final RegistryCenterConfiguration regCenterConfig;\n    //\n    private final boolean overwrite;\n    //shardingsharding\n    private final OrchestrationType type;\n}\n```\n\n```java\n//zookeeper\n@RequiredArgsConstructor\npublic final class ConfigurationNode {\n    public static final String ROOT = \"config\";\n    public static final String PROXY_NODE_PATH = ROOT + \"/proxy\";\n    //namespace +  zookeeper\n    //namespace = sharding-data name() = xuzy \n    ///sharding-data/xuzy/config/datasource\n    public static final String DATA_SOURCE_NODE_PATH = ROOT + \"/datasource\";\n    public static final String SHARDING_NODE_PATH = ROOT + \"/sharding\";\n    public static final String MASTER_SLAVE_NODE_PATH = ROOT + \"/masterslave\";\n    public static final String RULE_NODE_PATH = \"/rule\";\n    public static final String CONFIG_MAP_NODE_PATH = \"/configmap\";\n    public static final String SHARDING_RULE_NODE_PATH = SHARDING_NODE_PATH + RULE_NODE_PATH;\n    public static final String SHARDING_CONFIG_MAP_NODE_PATH = SHARDING_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String SHARDING_PROPS_NODE_PATH = SHARDING_NODE_PATH + \"/props\";\n    public static final String MASTER_SLAVE_RULE_NODE_PATH = MASTER_SLAVE_NODE_PATH + RULE_NODE_PATH;\n    public static final String MASTER_SLAVE_CONFIG_MAP_NODE_PATH = MASTER_SLAVE_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String MASTER_SLAVE_PROPS_NODE_PATH = MASTER_SLAVE_NODE_PATH + \"/props\";\n    public static final String PROXY_RULE_NODE_PATH = PROXY_NODE_PATH + RULE_NODE_PATH;\n    private final String name;\n    /**\n     * Get node full path.\n     *\n     * @param node node name\n     * @return node full path\n     */\n    public String getFullPath(final String node) {\n        return String.format(\"/%s/%s\", name, node);\n    }\n}\n```\n\n#### shardingDataSource\n\nshardingDataSource\n\n- OrchestrationShardingDataSourceFactory shardingDataSource\n- OrchestrationMasterSlaveDataSourceFactory shardingDataSource\n\n```java\n@NoArgsConstructor(access = AccessLevel.PRIVATE)\npublic final class OrchestrationShardingDataSourceFactory {\n    public static DataSource createDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n        return new OrchestrationShardingDataSource(orchestrationConfig);\n    }\n}\n```\n\n#### ShardingDataSource\n\nOrchestrationShardingDataSourceDataSourcezookeeperShardingDataSource\n\n![](shardingjdbc-reg/1.png)\n\n\n\n1. OrchestrationFacadezookeeperetcd\n2. \n3. ShardingDataSource\n4. watchShardingDataSource\n\n```java\npublic OrchestrationShardingDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n    //OrchestrationFacadezookeeperetcd\n    super(new OrchestrationFacade(orchestrationConfig));\n    ConfigurationService configService = getOrchestrationFacade().getConfigService();\n    //\n    ShardingRuleConfiguration shardingRuleConfig = configService.loadShardingRuleConfiguration();\n    Preconditions.checkNotNull(shardingRuleConfig, \"Missing the sharding rule configuration on register center\");\n    //ShardingDataSource\n    dataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n            new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());\n    //watchShardingDataSource\n    initOrchestrationFacade(dataSource);\n}\n```\n\nOrchestrationFacadezookeeperetcd\n\n```java\npublic OrchestrationFacade(final OrchestrationConfiguration orchestrationConfig) {\n    //\n    regCenter = createRegistryCenter(orchestrationConfig.getRegCenterConfig());\n    isOverwrite = orchestrationConfig.isOverwrite();\n    //service\n    configService = new ConfigurationService(orchestrationConfig.getName(), regCenter);\n    //service\n    instanceStateService = new InstanceStateService(orchestrationConfig.getName(), regCenter);\n    //service\n    dataSourceService = new DataSourceService(orchestrationConfig.getName(), regCenter);\n    listenerManager = new ListenerFactory(orchestrationConfig.getName(), regCenter);\n}\n\nprivate RegistryCenter createRegistryCenter(final RegistryCenterConfiguration regCenterConfig) {\n    Preconditions.checkNotNull(regCenterConfig, \"Registry center configuration cannot be null.\");\n    //ZookeeperConfigurationzookeeper\n    if (regCenterConfig instanceof ZookeeperConfiguration) {\n        return getZookeeperRegistryCenter((ZookeeperConfiguration) regCenterConfig);\n    }\n    if (regCenterConfig instanceof EtcdConfiguration) {\n        return new EtcdRegistryCenter((EtcdConfiguration) regCenterConfig);\n    }\n    throw new UnsupportedOperationException(regCenterConfig.getClass().getName());\n}\n\nprivate RegistryCenter getZookeeperRegistryCenter(final ZookeeperConfiguration regCenterConfig) {\n    if (regCenterConfig.isUseNative()) {\n        //\n        return new NewZookeeperRegistryCenter(regCenterConfig);\n    } else {\n        // Curatorzookeeper\n        return new ZookeeperRegistryCenter(regCenterConfig);\n    }\n}\n```\n\n\n\n\n\n```java\npublic ShardingRuleConfiguration loadShardingRuleConfiguration() {\n    try {\n        // /namespace/name/config/sharding/rule ShardingRuleConfiguration\n        ShardingRuleConfiguration result = ShardingConfigurationConverter.shardingRuleConfigFromYaml(regCenter.getDirectly(configNode.getFullPath(ConfigurationNode.SHARDING_RULE_NODE_PATH)));\n        Preconditions.checkState(null != result && !result.getTableRuleConfigs().isEmpty(), \"No available sharding rule configuration to load.\");\n        return result;\n    } catch (final Exception ex) {\n        throw new ShardingConfigurationException(\"No available sharding rule configuration to load.\");\n    }\n}\n```\n\nshardingDataSource\n\n```java\ndataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n                new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());\n```\n\nwatchShardingDataSource\n\n```java\npublic void init(final Map<String, DataSource> dataSourceMap, final ShardingRuleConfiguration shardingRuleConfig, \n                 final Map<String, Object> configMap, final Properties props) {\n    //\n    if (shardingRuleConfig.getMasterSlaveRuleConfigs().isEmpty()) {\n        reviseShardingRuleConfigurationForMasterSlave(dataSourceMap, shardingRuleConfig);\n    }\n    //isOverwrite\n    //true\n    configService.persistShardingConfiguration(getActualDataSourceMapForMasterSlave(dataSourceMap), shardingRuleConfig, configMap, props, isOverwrite);\n    //sharingjdbc  /namespace/name/state/instances\n    //\n    instanceStateService.persistShardingInstanceOnline();\n    dataSourceService.persistDataSourcesNode();\n    //Watch\n    listenerManager.initShardingListeners();\n}\n```\n\n```java\npublic void initShardingListeners() {\n    //Watch\n    configurationListenerManager.watchSharding();\n    //Watch\n    instanceListenerManager.watchSharding();\n    //Watch\n    dataSourceListenerManager.watchSharding();\n    //configmapWatch\n    configMapListenerManager.watchSharding();\n}\n\n//\nwatchSharding(ConfigurationNode.SHARDING_RULE_NODE_PATH);\nprivate void watchSharding(final String node) {\n    String cachePath = configNode.getFullPath(node);\n    regCenter.watch(cachePath, new EventListener() {\n        \n        @Override\n        public void onChange(final DataChangedEvent event) {\n            ///sharding-data/xuzy/config/sharding/rule\n            if (DataChangedEvent.Type.UPDATED == event.getEventType()) {\n                //\n                Map<String, DataSource> dataSourceMap = dataSourceService.getAvailableDataSources();\n                //\n                ShardingConfigurationEventBusEvent shardingEvent = new ShardingConfigurationEventBusEvent(dataSourceMap,\n                        new ShardingRule(dataSourceService.getAvailableShardingRuleConfiguration(), dataSourceMap.keySet()), configService.loadShardingProperties());\n                //guavaEventBusshardingDataSource EventBus\n                ShardingEventBusInstance.getInstance().post(shardingEvent);\n            }\n        }\n    });\n}\n```\n\n#### EventBus\n\nEventBusguava\n\n```java\npublic class EventBusTest {\n\n    public static void main(String[] args){\n        final EventBus eventBus = new EventBus();\n        //\n        eventBus.register(new SimpleListener());\n        eventBus.register(new SimpleListener2());\n        //post\n        eventBus.post(\"Simple Event\");\n    }\n\n    static class SimpleListener {\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + \"_1\");\n        }\n    }\n\n    static class SimpleListener2{\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + \"_2\");\n        }\n    }\n}\n```\n\nWatch\n\n```java\nShardingEventBusInstance.getInstance().post(shardingEvent);\n```\n\n![](shardingjdbc-reg/2.png)\n\n## \n\nzookeeperWatchshardingjdbc","slug":"shardingjdbc-reg","published":1,"updated":"2021-04-08T00:47:06.987Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvs003eqwv2b9h426cc","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"ShardingSphere\"><a href=\"#ShardingSphere\" class=\"headerlink\" title=\"ShardingSphere\"></a>ShardingSphere</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ShardingSphere<br>ShardingSphereShardingJdcbymlxml100</p>\n<ol>\n<li>100yml</li>\n<li>100Tomcat</li>\n</ol>\n<p>  </p>\n<p>ShardingSphereShardingSphere + Zookeeper  Etcd   ZookeeperWatch<font color=\"red\"></font></p>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Maven</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>io.shardingsphere<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sharding-jdbc-orchestration-spring-namespace<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.0.0.M3<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>io.shardingsphere<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sharding-orchestration-reg-zookeeper-curator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.0.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre>\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testOrchestration2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//zk</span>\n    <span class=\"token function\">deleteZkDataSourceAndRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//DataSourcezk</span>\n    <span class=\"token function\">initDataSourceZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ZK</span>\n    <span class=\"token function\">initRuleZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    ZookeeperConfiguration regConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZookeeperConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    regConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setServerLists</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    regConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setNamespace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sharding-data\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    OrchestrationConfiguration orchConcifg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrchestrationConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xuzy\"</span><span class=\"token punctuation\">,</span>regConfig<span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> OrchestrationType<span class=\"token punctuation\">.</span>SHARDING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//OrchestrationShardingDataSourceFactoryShardingDataSource</span>\n    DataSource dataSource <span class=\"token operator\">=</span> OrchestrationShardingDataSourceFactory<span class=\"token punctuation\">.</span><span class=\"token function\">createDataSource</span><span class=\"token punctuation\">(</span>orchConcifg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    JdbcTemplate jdbcTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JdbcTemplate</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// 2021</span>\n    List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">>></span> list <span class=\"token operator\">=</span> jdbcTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">queryForList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select * from flow where flowtime in ('20170818','20190205')\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\" spellcheck=\"true\">//DataSourcedataSource_2021ZK</span>\n    <span class=\"token function\">updateDataSourceZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//(flow2021)ZK</span>\n    <span class=\"token function\">updateRuleZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">// 2021</span>\n    List<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">>></span> listNew <span class=\"token operator\">=</span> jdbcTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">queryForList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select * from flow where flowtime in ('20170818','20190205','20210405')\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>listNew<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>zookeepersharding</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteZkDataSourceAndRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//zookeeperio.shardingsphere.jdbc.orchestration.internal.config.ConfigurationNode</span>\n    CuratorFramework cf <span class=\"token operator\">=</span> <span class=\"token function\">getCuratorFramework</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Stat stat <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">checkExists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/datasource\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>stat <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/datasource\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    Stat stat2 <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">checkExists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/sharding/rule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>stat2 <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/sharding/rule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>DataSourcezookeeper</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initDataSourceZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    CuratorFramework cf <span class=\"token operator\">=</span> <span class=\"token function\">getCuratorFramework</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//datasource orchestration-sharding-data-source datasourceymal</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Map&lt;String, DataSource> result = DataSourceConverter.dataSourceMapFromYaml(this.regCenter.getDirectly(this.configNode.getFullPath(\"config/datasource\")));</span>\n    String dataSource <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\"</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">creatingParentsIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withMode</span><span class=\"token punctuation\">(</span>CreateMode<span class=\"token punctuation\">.</span>PERSISTENT<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/datasource\"</span><span class=\"token punctuation\">,</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Zookeeper</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initRuleZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    CuratorFramework cf <span class=\"token operator\">=</span> <span class=\"token function\">getCuratorFramework</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    String rule <span class=\"token operator\">=</span> <span class=\"token string\">\"  tables:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    flow:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    ips:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    acca:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        complex:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumns: flowtime,dataType\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        complex:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumns: flowtime,dataType\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  bindingTables:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    - flow,ips,acca\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  defaultDatabaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    none:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  defaultTableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    none:\"</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">creatingParentsIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withMode</span><span class=\"token punctuation\">(</span>CreateMode<span class=\"token punctuation\">.</span>PERSISTENT<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/sharding/rule\"</span><span class=\"token punctuation\">,</span> rule<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>DataSourcedataSource_2021Zookeeper</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateDataSourceZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    CuratorFramework cf <span class=\"token operator\">=</span> <span class=\"token function\">getCuratorFramework</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    String dataSource <span class=\"token operator\">=</span> <span class=\"token string\">\"  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  dataSource_2021: !!org.apache.commons.dbcp.BasicDataSource\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    driverClassName: com.mysql.jdbc.Driver\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    url: jdbc:mysql://localhost:3306/sharding_2021?useUnicode=true&amp;amp;characterEncoding=utf-8\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    username: root\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    password: 123456\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    initialSize : 0\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxActive : 200\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxIdle : 20\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    minIdle : 1\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    maxWait : 60000\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/datasource\"</span><span class=\"token punctuation\">,</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>(flow2021)Zookeeper</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateRuleZkData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    CuratorFramework cf <span class=\"token operator\">=</span> <span class=\"token function\">getCuratorFramework</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    String rule <span class=\"token operator\">=</span> <span class=\"token string\">\"  tables:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    flow:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2021}.flow_0${1..9},dataSource_${2017..2021}.flow_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    ips:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        standard:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumn: flowtime\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    acca:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      tableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        complex:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumns: flowtime,dataType\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"      databaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        complex:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          shardingColumns: flowtime,dataType\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  bindingTables:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    - flow,ips,acca\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  defaultDatabaseStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    none:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"  defaultTableStrategy:\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    none:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    cf<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sharding-data/xuzy/config/sharding/rule\"</span><span class=\"token punctuation\">,</span> rule<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\">ZookeeperConfiguration regConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZookeeperConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nregConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setServerLists</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//namespace</span>\nregConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setNamespace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sharding-data\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nOrchestrationConfiguration orchConcifg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrchestrationConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xuzy\"</span><span class=\"token punctuation\">,</span>regConfig<span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> OrchestrationType<span class=\"token punctuation\">.</span>SHARDING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//OrchestrationShardingDataSourceFactoryShardingDataSource</span>\nDataSource dataSource <span class=\"token operator\">=</span> OrchestrationShardingDataSourceFactory<span class=\"token punctuation\">.</span><span class=\"token function\">createDataSource</span><span class=\"token punctuation\">(</span>orchConcifg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h4 id=\"OrchestrationConfiguration\"><a href=\"#OrchestrationConfiguration\" class=\"headerlink\" title=\"OrchestrationConfiguration\"></a>OrchestrationConfiguration</h4><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrchestrationConfiguration</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token comment\" spellcheck=\"true\">//zkname = prod</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> String name<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//zookeeperEtcd</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> RegistryCenterConfiguration regCenterConfig<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> overwrite<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//shardingsharding</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> OrchestrationType type<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//zookeeper</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ConfigurationNode</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String ROOT <span class=\"token operator\">=</span> <span class=\"token string\">\"config\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String PROXY_NODE_PATH <span class=\"token operator\">=</span> ROOT <span class=\"token operator\">+</span> <span class=\"token string\">\"/proxy\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//namespace +  zookeeper</span>\n    <span class=\"token comment\" spellcheck=\"true\">//namespace = sharding-data name() = xuzy </span>\n    <span class=\"token comment\" spellcheck=\"true\">///sharding-data/xuzy/config/datasource</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String DATA_SOURCE_NODE_PATH <span class=\"token operator\">=</span> ROOT <span class=\"token operator\">+</span> <span class=\"token string\">\"/datasource\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String SHARDING_NODE_PATH <span class=\"token operator\">=</span> ROOT <span class=\"token operator\">+</span> <span class=\"token string\">\"/sharding\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String MASTER_SLAVE_NODE_PATH <span class=\"token operator\">=</span> ROOT <span class=\"token operator\">+</span> <span class=\"token string\">\"/masterslave\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String RULE_NODE_PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"/rule\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String CONFIG_MAP_NODE_PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"/configmap\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String SHARDING_RULE_NODE_PATH <span class=\"token operator\">=</span> SHARDING_NODE_PATH <span class=\"token operator\">+</span> RULE_NODE_PATH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String SHARDING_CONFIG_MAP_NODE_PATH <span class=\"token operator\">=</span> SHARDING_NODE_PATH <span class=\"token operator\">+</span> CONFIG_MAP_NODE_PATH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String SHARDING_PROPS_NODE_PATH <span class=\"token operator\">=</span> SHARDING_NODE_PATH <span class=\"token operator\">+</span> <span class=\"token string\">\"/props\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String MASTER_SLAVE_RULE_NODE_PATH <span class=\"token operator\">=</span> MASTER_SLAVE_NODE_PATH <span class=\"token operator\">+</span> RULE_NODE_PATH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String MASTER_SLAVE_CONFIG_MAP_NODE_PATH <span class=\"token operator\">=</span> MASTER_SLAVE_NODE_PATH <span class=\"token operator\">+</span> CONFIG_MAP_NODE_PATH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String MASTER_SLAVE_PROPS_NODE_PATH <span class=\"token operator\">=</span> MASTER_SLAVE_NODE_PATH <span class=\"token operator\">+</span> <span class=\"token string\">\"/props\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> String PROXY_RULE_NODE_PATH <span class=\"token operator\">=</span> PROXY_NODE_PATH <span class=\"token operator\">+</span> RULE_NODE_PATH<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> String name<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">/**\n     * Get node full path.\n     *\n     * @param node node name\n     * @return node full path\n     */</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">getFullPath</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> String node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/%s/%s\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"shardingDataSource\"><a href=\"#shardingDataSource\" class=\"headerlink\" title=\"shardingDataSource\"></a>shardingDataSource</h4><p>shardingDataSource</p>\n<ul>\n<li>OrchestrationShardingDataSourceFactory shardingDataSource</li>\n<li>OrchestrationMasterSlaveDataSourceFactory shardingDataSource</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> AccessLevel<span class=\"token punctuation\">.</span>PRIVATE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrchestrationShardingDataSourceFactory</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> DataSource <span class=\"token function\">createDataSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> OrchestrationConfiguration orchestrationConfig<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> SQLException <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrchestrationShardingDataSource</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"ShardingDataSource\"><a href=\"#ShardingDataSource\" class=\"headerlink\" title=\"ShardingDataSource\"></a>ShardingDataSource</h4><p>OrchestrationShardingDataSourceDataSourcezookeeperShardingDataSource</p>\n<p><img src=\"/2021/02/02/shardingjdbc-reg/1.png\" alt></p>\n<p></p>\n<ol>\n<li>OrchestrationFacadezookeeperetcd</li>\n<li></li>\n<li>ShardingDataSource</li>\n<li>watchShardingDataSource</li>\n</ol>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token function\">OrchestrationShardingDataSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> OrchestrationConfiguration orchestrationConfig<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> SQLException <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//OrchestrationFacadezookeeperetcd</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrchestrationFacade</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ConfigurationService configService <span class=\"token operator\">=</span> <span class=\"token function\">getOrchestrationFacade</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getConfigService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    ShardingRuleConfiguration shardingRuleConfig <span class=\"token operator\">=</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingRuleConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Preconditions<span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>shardingRuleConfig<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Missing the sharding rule configuration on register center\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ShardingDataSource</span>\n    dataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingDataSource</span><span class=\"token punctuation\">(</span>configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadDataSourceMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingRule</span><span class=\"token punctuation\">(</span>shardingRuleConfig<span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadDataSourceMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingConfigMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//watchShardingDataSource</span>\n    <span class=\"token function\">initOrchestrationFacade</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>OrchestrationFacadezookeeperetcd</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token function\">OrchestrationFacade</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> OrchestrationConfiguration orchestrationConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    regCenter <span class=\"token operator\">=</span> <span class=\"token function\">createRegistryCenter</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getRegCenterConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    isOverwrite <span class=\"token operator\">=</span> orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">isOverwrite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//service</span>\n    configService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConfigurationService</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regCenter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//service</span>\n    instanceStateService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InstanceStateService</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regCenter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//service</span>\n    dataSourceService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataSourceService</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regCenter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    listenerManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ListenerFactory</span><span class=\"token punctuation\">(</span>orchestrationConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regCenter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> RegistryCenter <span class=\"token function\">createRegistryCenter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> RegistryCenterConfiguration regCenterConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Preconditions<span class=\"token punctuation\">.</span><span class=\"token function\">checkNotNull</span><span class=\"token punctuation\">(</span>regCenterConfig<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Registry center configuration cannot be null.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ZookeeperConfigurationzookeeper</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>regCenterConfig <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ZookeeperConfiguration</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">getZookeeperRegistryCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ZookeeperConfiguration<span class=\"token punctuation\">)</span> regCenterConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>regCenterConfig <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">EtcdConfiguration</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EtcdRegistryCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>EtcdConfiguration<span class=\"token punctuation\">)</span> regCenterConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnsupportedOperationException</span><span class=\"token punctuation\">(</span>regCenterConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> RegistryCenter <span class=\"token function\">getZookeeperRegistryCenter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> ZookeeperConfiguration regCenterConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>regCenterConfig<span class=\"token punctuation\">.</span><span class=\"token function\">isUseNative</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NewZookeeperRegistryCenter</span><span class=\"token punctuation\">(</span>regCenterConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">// Curatorzookeeper</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZookeeperRegistryCenter</span><span class=\"token punctuation\">(</span>regCenterConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p></p>\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> ShardingRuleConfiguration <span class=\"token function\">loadShardingRuleConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">// /namespace/name/config/sharding/rule ShardingRuleConfiguration</span>\n        ShardingRuleConfiguration result <span class=\"token operator\">=</span> ShardingConfigurationConverter<span class=\"token punctuation\">.</span><span class=\"token function\">shardingRuleConfigFromYaml</span><span class=\"token punctuation\">(</span>regCenter<span class=\"token punctuation\">.</span><span class=\"token function\">getDirectly</span><span class=\"token punctuation\">(</span>configNode<span class=\"token punctuation\">.</span><span class=\"token function\">getFullPath</span><span class=\"token punctuation\">(</span>ConfigurationNode<span class=\"token punctuation\">.</span>SHARDING_RULE_NODE_PATH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Preconditions<span class=\"token punctuation\">.</span><span class=\"token function\">checkState</span><span class=\"token punctuation\">(</span>null <span class=\"token operator\">!=</span> result <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">getTableRuleConfigs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"No available sharding rule configuration to load.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">final</span> Exception ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingConfigurationException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No available sharding rule configuration to load.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>shardingDataSource</p>\n<pre class=\" language-java\"><code class=\"language-java\">dataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingDataSource</span><span class=\"token punctuation\">(</span>configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadDataSourceMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingRule</span><span class=\"token punctuation\">(</span>shardingRuleConfig<span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadDataSourceMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingConfigMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>watchShardingDataSource</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> DataSource<span class=\"token operator\">></span> dataSourceMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> ShardingRuleConfiguration shardingRuleConfig<span class=\"token punctuation\">,</span> \n                 <span class=\"token keyword\">final</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> configMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> Properties props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shardingRuleConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getMasterSlaveRuleConfigs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reviseShardingRuleConfigurationForMasterSlave</span><span class=\"token punctuation\">(</span>dataSourceMap<span class=\"token punctuation\">,</span> shardingRuleConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//isOverwrite</span>\n    <span class=\"token comment\" spellcheck=\"true\">//true</span>\n    configService<span class=\"token punctuation\">.</span><span class=\"token function\">persistShardingConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token function\">getActualDataSourceMapForMasterSlave</span><span class=\"token punctuation\">(</span>dataSourceMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> shardingRuleConfig<span class=\"token punctuation\">,</span> configMap<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> isOverwrite<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//sharingjdbc  /namespace/name/state/instances</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    instanceStateService<span class=\"token punctuation\">.</span><span class=\"token function\">persistShardingInstanceOnline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dataSourceService<span class=\"token punctuation\">.</span><span class=\"token function\">persistDataSourcesNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Watch</span>\n    listenerManager<span class=\"token punctuation\">.</span><span class=\"token function\">initShardingListeners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initShardingListeners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Watch</span>\n    configurationListenerManager<span class=\"token punctuation\">.</span><span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Watch</span>\n    instanceListenerManager<span class=\"token punctuation\">.</span><span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//Watch</span>\n    dataSourceListenerManager<span class=\"token punctuation\">.</span><span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//configmapWatch</span>\n    configMapListenerManager<span class=\"token punctuation\">.</span><span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span>ConfigurationNode<span class=\"token punctuation\">.</span>SHARDING_RULE_NODE_PATH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">watchSharding</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> String node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    String cachePath <span class=\"token operator\">=</span> configNode<span class=\"token punctuation\">.</span><span class=\"token function\">getFullPath</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    regCenter<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>cachePath<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EventListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> DataChangedEvent event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">///sharding-data/xuzy/config/sharding/rule</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DataChangedEvent<span class=\"token punctuation\">.</span>Type<span class=\"token punctuation\">.</span>UPDATED <span class=\"token operator\">==</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getEventType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> DataSource<span class=\"token operator\">></span> dataSourceMap <span class=\"token operator\">=</span> dataSourceService<span class=\"token punctuation\">.</span><span class=\"token function\">getAvailableDataSources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//</span>\n                ShardingConfigurationEventBusEvent shardingEvent <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingConfigurationEventBusEvent</span><span class=\"token punctuation\">(</span>dataSourceMap<span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">ShardingRule</span><span class=\"token punctuation\">(</span>dataSourceService<span class=\"token punctuation\">.</span><span class=\"token function\">getAvailableShardingRuleConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dataSourceMap<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> configService<span class=\"token punctuation\">.</span><span class=\"token function\">loadShardingProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\" spellcheck=\"true\">//guavaEventBusshardingDataSource EventBus</span>\n                ShardingEventBusInstance<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>shardingEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"EventBus\"><a href=\"#EventBus\" class=\"headerlink\" title=\"EventBus\"></a>EventBus</h4><p>EventBusguava</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EventBusTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> EventBus eventBus <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EventBus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        eventBus<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        eventBus<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleListener2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//post</span>\n        eventBus<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Simple Event\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SimpleListener</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Subscribe</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doAction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> String event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>event <span class=\"token operator\">+</span> <span class=\"token string\">\"_1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SimpleListener2</span><span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Subscribe</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doAction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> String event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>event <span class=\"token operator\">+</span> <span class=\"token string\">\"_2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Watch</p>\n<pre class=\" language-java\"><code class=\"language-java\">ShardingEventBusInstance<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>shardingEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p><img src=\"/2021/02/02/shardingjdbc-reg/2.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>zookeeperWatchshardingjdbc</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"ShardingSphere\"><a href=\"#ShardingSphere\" class=\"headerlink\" title=\"ShardingSphere\"></a>ShardingSphere</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ShardingSphere<br>ShardingSphereShardingJdcbymlxml100</p>\n<ol>\n<li>100yml</li>\n<li>100Tomcat</li>\n</ol>\n<p>  </p>\n<p>ShardingSphereShardingSphere + Zookeeper  Etcd   ZookeeperWatch<font color=\"red\"></font></p>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Maven</p>\n<pre><code class=\"xml\">&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-orchestration-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0.M3&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-orchestration-reg-zookeeper-curator&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0&lt;/version&gt;\n&lt;/dependency&gt;</code></pre>\n<p></p>\n<pre><code class=\"java\">@Test\npublic void testOrchestration2() throws Exception {\n\n    //zk\n    deleteZkDataSourceAndRule();\n    //DataSourcezk\n    initDataSourceZkData();\n    //ZK\n    initRuleZkData();\n\n    ZookeeperConfiguration regConfig = new ZookeeperConfiguration();\n    regConfig.setServerLists(&quot;localhost:2181&quot;);\n    regConfig.setNamespace(&quot;sharding-data&quot;);\n    OrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(&quot;xuzy&quot;,regConfig,false, OrchestrationType.SHARDING);\n    //OrchestrationShardingDataSourceFactoryShardingDataSource\n    DataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);\n    //\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    // 2021\n    List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(&quot;select * from flow where flowtime in (&#39;20170818&#39;,&#39;20190205&#39;)&quot;);\n\n\n    //DataSourcedataSource_2021ZK\n    updateDataSourceZkData();\n    //(flow2021)ZK\n    updateRuleZkData();\n\n    TimeUnit.SECONDS.sleep(20);\n\n    // 2021\n    List&lt;Map&lt;String, Object&gt;&gt; listNew = jdbcTemplate.queryForList(&quot;select * from flow where flowtime in (&#39;20170818&#39;,&#39;20190205&#39;,&#39;20210405&#39;)&quot;);\n    System.out.println(listNew);\n}</code></pre>\n<p>zookeepersharding</p>\n<pre><code class=\"java\">@Test\npublic void deleteZkDataSourceAndRule() throws Exception {\n    //zookeeperio.shardingsphere.jdbc.orchestration.internal.config.ConfigurationNode\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    Stat stat = cf.checkExists().forPath(&quot;/sharding-data/xuzy/config/datasource&quot;);\n    if(stat != null){\n        cf.delete().forPath(&quot;/sharding-data/xuzy/config/datasource&quot;);\n    }\n    Stat stat2 = cf.checkExists().forPath(&quot;/sharding-data/xuzy/config/sharding/rule&quot;);\n    if(stat2 != null){\n        cf.delete().forPath(&quot;/sharding-data/xuzy/config/sharding/rule&quot;);\n    }\n    cf.close();\n}</code></pre>\n<p>DataSourcezookeeper</p>\n<pre><code class=\"java\">@Test\npublic void initDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    //datasource orchestration-sharding-data-source datasourceymal\n    //Map&lt;String, DataSource&gt; result = DataSourceConverter.dataSourceMapFromYaml(this.regCenter.getDirectly(this.configNode.getFullPath(&quot;config/datasource&quot;)));\n    String dataSource = &quot;&quot; +\n            &quot;  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000&quot;;\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(&quot;/sharding-data/xuzy/config/datasource&quot;, dataSource.getBytes());\n    cf.close();\n}</code></pre>\n<p>Zookeeper</p>\n<pre><code class=\"java\">@Test\npublic void initRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = &quot;  tables:\\n&quot; +\n            &quot;    flow:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;    ips:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;    acca:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        complex:\\n&quot; +\n            &quot;          shardingColumns: flowtime,dataType\\n&quot; +\n            &quot;          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        complex:\\n&quot; +\n            &quot;          shardingColumns: flowtime,dataType\\n&quot; +\n            &quot;          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;  bindingTables:\\n&quot; +\n            &quot;    - flow,ips,acca\\n&quot; +\n            &quot;  defaultDatabaseStrategy:\\n&quot; +\n            &quot;    none:\\n&quot; +\n            &quot;  defaultTableStrategy:\\n&quot; +\n            &quot;    none:&quot;;\n    cf.create()\n            .creatingParentsIfNeeded() //\n            .withMode(CreateMode.PERSISTENT) //\n            .forPath(&quot;/sharding-data/xuzy/config/sharding/rule&quot;, rule.getBytes());\n    cf.close();\n}</code></pre>\n<p>DataSourcedataSource_2021Zookeeper</p>\n<pre><code class=\"java\">@Test\npublic void updateDataSourceZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String dataSource = &quot;  dataSource_default: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2017: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2018: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2019: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2020: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000\\n&quot; +\n            &quot;  dataSource_2021: !!org.apache.commons.dbcp.BasicDataSource\\n&quot; +\n            &quot;    driverClassName: com.mysql.jdbc.Driver\\n&quot; +\n            &quot;    url: jdbc:mysql://localhost:3306/sharding_2021?useUnicode=true&amp;amp;characterEncoding=utf-8\\n&quot; +\n            &quot;    username: root\\n&quot; +\n            &quot;    password: 123456\\n&quot; +\n            &quot;    initialSize : 0\\n&quot; +\n            &quot;    maxActive : 200\\n&quot; +\n            &quot;    maxIdle : 20\\n&quot; +\n            &quot;    minIdle : 1\\n&quot; +\n            &quot;    maxWait : 60000&quot;;\n    //\n    cf.setData().forPath(&quot;/sharding-data/xuzy/config/datasource&quot;, dataSource.getBytes());\n}</code></pre>\n<p>(flow2021)Zookeeper</p>\n<pre><code class=\"java\">@Test\npublic void updateRuleZkData() throws Exception {\n    CuratorFramework cf = getCuratorFramework();\n    cf.start();\n    String rule = &quot;  tables:\\n&quot; +\n            &quot;    flow:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2021}.flow_0${1..9},dataSource_${2017..2021}.flow_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;    ips:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        standard:\\n&quot; +\n            &quot;          shardingColumn: flowtime\\n&quot; +\n            &quot;          preciseAlgorithmClassName: com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;    acca:\\n&quot; +\n            &quot;      actualDataNodes: dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\\n&quot; +\n            &quot;      tableStrategy:\\n&quot; +\n            &quot;        complex:\\n&quot; +\n            &quot;          shardingColumns: flowtime,dataType\\n&quot; +\n            &quot;          algorithmClassName: com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\\n&quot; +\n            &quot;      databaseStrategy:\\n&quot; +\n            &quot;        complex:\\n&quot; +\n            &quot;          shardingColumns: flowtime,dataType\\n&quot; +\n            &quot;          algorithmClassName: com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\\n&quot; +\n            &quot;  bindingTables:\\n&quot; +\n            &quot;    - flow,ips,acca\\n&quot; +\n            &quot;  defaultDatabaseStrategy:\\n&quot; +\n            &quot;    none:\\n&quot; +\n            &quot;  defaultTableStrategy:\\n&quot; +\n            &quot;    none:&quot;;\n    //\n    cf.setData().forPath(&quot;/sharding-data/xuzy/config/sharding/rule&quot;, rule.getBytes());\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">ZookeeperConfiguration regConfig = new ZookeeperConfiguration();\nregConfig.setServerLists(&quot;localhost:2181&quot;);\n//namespace\nregConfig.setNamespace(&quot;sharding-data&quot;);\nOrchestrationConfiguration orchConcifg = new OrchestrationConfiguration(&quot;xuzy&quot;,regConfig,false, OrchestrationType.SHARDING);\n//OrchestrationShardingDataSourceFactoryShardingDataSource\nDataSource dataSource = OrchestrationShardingDataSourceFactory.createDataSource(orchConcifg);</code></pre>\n<h4 id=\"OrchestrationConfiguration\"><a href=\"#OrchestrationConfiguration\" class=\"headerlink\" title=\"OrchestrationConfiguration\"></a>OrchestrationConfiguration</h4><pre><code class=\"java\">@RequiredArgsConstructor\n@Getter\npublic final class OrchestrationConfiguration {\n    //\n    //zkname = prod\n    private final String name;\n    //zookeeperEtcd\n    private final RegistryCenterConfiguration regCenterConfig;\n    //\n    private final boolean overwrite;\n    //shardingsharding\n    private final OrchestrationType type;\n}</code></pre>\n<pre><code class=\"java\">//zookeeper\n@RequiredArgsConstructor\npublic final class ConfigurationNode {\n    public static final String ROOT = &quot;config&quot;;\n    public static final String PROXY_NODE_PATH = ROOT + &quot;/proxy&quot;;\n    //namespace +  zookeeper\n    //namespace = sharding-data name() = xuzy \n    ///sharding-data/xuzy/config/datasource\n    public static final String DATA_SOURCE_NODE_PATH = ROOT + &quot;/datasource&quot;;\n    public static final String SHARDING_NODE_PATH = ROOT + &quot;/sharding&quot;;\n    public static final String MASTER_SLAVE_NODE_PATH = ROOT + &quot;/masterslave&quot;;\n    public static final String RULE_NODE_PATH = &quot;/rule&quot;;\n    public static final String CONFIG_MAP_NODE_PATH = &quot;/configmap&quot;;\n    public static final String SHARDING_RULE_NODE_PATH = SHARDING_NODE_PATH + RULE_NODE_PATH;\n    public static final String SHARDING_CONFIG_MAP_NODE_PATH = SHARDING_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String SHARDING_PROPS_NODE_PATH = SHARDING_NODE_PATH + &quot;/props&quot;;\n    public static final String MASTER_SLAVE_RULE_NODE_PATH = MASTER_SLAVE_NODE_PATH + RULE_NODE_PATH;\n    public static final String MASTER_SLAVE_CONFIG_MAP_NODE_PATH = MASTER_SLAVE_NODE_PATH + CONFIG_MAP_NODE_PATH;\n    public static final String MASTER_SLAVE_PROPS_NODE_PATH = MASTER_SLAVE_NODE_PATH + &quot;/props&quot;;\n    public static final String PROXY_RULE_NODE_PATH = PROXY_NODE_PATH + RULE_NODE_PATH;\n    private final String name;\n    /**\n     * Get node full path.\n     *\n     * @param node node name\n     * @return node full path\n     */\n    public String getFullPath(final String node) {\n        return String.format(&quot;/%s/%s&quot;, name, node);\n    }\n}</code></pre>\n<h4 id=\"shardingDataSource\"><a href=\"#shardingDataSource\" class=\"headerlink\" title=\"shardingDataSource\"></a>shardingDataSource</h4><p>shardingDataSource</p>\n<ul>\n<li>OrchestrationShardingDataSourceFactory shardingDataSource</li>\n<li>OrchestrationMasterSlaveDataSourceFactory shardingDataSource</li>\n</ul>\n<pre><code class=\"java\">@NoArgsConstructor(access = AccessLevel.PRIVATE)\npublic final class OrchestrationShardingDataSourceFactory {\n    public static DataSource createDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n        return new OrchestrationShardingDataSource(orchestrationConfig);\n    }\n}</code></pre>\n<h4 id=\"ShardingDataSource\"><a href=\"#ShardingDataSource\" class=\"headerlink\" title=\"ShardingDataSource\"></a>ShardingDataSource</h4><p>OrchestrationShardingDataSourceDataSourcezookeeperShardingDataSource</p>\n<p><img src=\"/2021/02/02/shardingjdbc-reg/1.png\" alt></p>\n<p></p>\n<ol>\n<li>OrchestrationFacadezookeeperetcd</li>\n<li></li>\n<li>ShardingDataSource</li>\n<li>watchShardingDataSource</li>\n</ol>\n<pre><code class=\"java\">public OrchestrationShardingDataSource(final OrchestrationConfiguration orchestrationConfig) throws SQLException {\n    //OrchestrationFacadezookeeperetcd\n    super(new OrchestrationFacade(orchestrationConfig));\n    ConfigurationService configService = getOrchestrationFacade().getConfigService();\n    //\n    ShardingRuleConfiguration shardingRuleConfig = configService.loadShardingRuleConfiguration();\n    Preconditions.checkNotNull(shardingRuleConfig, &quot;Missing the sharding rule configuration on register center&quot;);\n    //ShardingDataSource\n    dataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n            new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());\n    //watchShardingDataSource\n    initOrchestrationFacade(dataSource);\n}</code></pre>\n<p>OrchestrationFacadezookeeperetcd</p>\n<pre><code class=\"java\">public OrchestrationFacade(final OrchestrationConfiguration orchestrationConfig) {\n    //\n    regCenter = createRegistryCenter(orchestrationConfig.getRegCenterConfig());\n    isOverwrite = orchestrationConfig.isOverwrite();\n    //service\n    configService = new ConfigurationService(orchestrationConfig.getName(), regCenter);\n    //service\n    instanceStateService = new InstanceStateService(orchestrationConfig.getName(), regCenter);\n    //service\n    dataSourceService = new DataSourceService(orchestrationConfig.getName(), regCenter);\n    listenerManager = new ListenerFactory(orchestrationConfig.getName(), regCenter);\n}\n\nprivate RegistryCenter createRegistryCenter(final RegistryCenterConfiguration regCenterConfig) {\n    Preconditions.checkNotNull(regCenterConfig, &quot;Registry center configuration cannot be null.&quot;);\n    //ZookeeperConfigurationzookeeper\n    if (regCenterConfig instanceof ZookeeperConfiguration) {\n        return getZookeeperRegistryCenter((ZookeeperConfiguration) regCenterConfig);\n    }\n    if (regCenterConfig instanceof EtcdConfiguration) {\n        return new EtcdRegistryCenter((EtcdConfiguration) regCenterConfig);\n    }\n    throw new UnsupportedOperationException(regCenterConfig.getClass().getName());\n}\n\nprivate RegistryCenter getZookeeperRegistryCenter(final ZookeeperConfiguration regCenterConfig) {\n    if (regCenterConfig.isUseNative()) {\n        //\n        return new NewZookeeperRegistryCenter(regCenterConfig);\n    } else {\n        // Curatorzookeeper\n        return new ZookeeperRegistryCenter(regCenterConfig);\n    }\n}</code></pre>\n<p></p>\n<p></p>\n<pre><code class=\"java\">public ShardingRuleConfiguration loadShardingRuleConfiguration() {\n    try {\n        // /namespace/name/config/sharding/rule ShardingRuleConfiguration\n        ShardingRuleConfiguration result = ShardingConfigurationConverter.shardingRuleConfigFromYaml(regCenter.getDirectly(configNode.getFullPath(ConfigurationNode.SHARDING_RULE_NODE_PATH)));\n        Preconditions.checkState(null != result &amp;&amp; !result.getTableRuleConfigs().isEmpty(), &quot;No available sharding rule configuration to load.&quot;);\n        return result;\n    } catch (final Exception ex) {\n        throw new ShardingConfigurationException(&quot;No available sharding rule configuration to load.&quot;);\n    }\n}</code></pre>\n<p>shardingDataSource</p>\n<pre><code class=\"java\">dataSource = new ShardingDataSource(configService.loadDataSourceMap(),\n                new ShardingRule(shardingRuleConfig, configService.loadDataSourceMap().keySet()), configService.loadShardingConfigMap(), configService.loadShardingProperties());</code></pre>\n<p>watchShardingDataSource</p>\n<pre><code class=\"java\">public void init(final Map&lt;String, DataSource&gt; dataSourceMap, final ShardingRuleConfiguration shardingRuleConfig, \n                 final Map&lt;String, Object&gt; configMap, final Properties props) {\n    //\n    if (shardingRuleConfig.getMasterSlaveRuleConfigs().isEmpty()) {\n        reviseShardingRuleConfigurationForMasterSlave(dataSourceMap, shardingRuleConfig);\n    }\n    //isOverwrite\n    //true\n    configService.persistShardingConfiguration(getActualDataSourceMapForMasterSlave(dataSourceMap), shardingRuleConfig, configMap, props, isOverwrite);\n    //sharingjdbc  /namespace/name/state/instances\n    //\n    instanceStateService.persistShardingInstanceOnline();\n    dataSourceService.persistDataSourcesNode();\n    //Watch\n    listenerManager.initShardingListeners();\n}</code></pre>\n<pre><code class=\"java\">public void initShardingListeners() {\n    //Watch\n    configurationListenerManager.watchSharding();\n    //Watch\n    instanceListenerManager.watchSharding();\n    //Watch\n    dataSourceListenerManager.watchSharding();\n    //configmapWatch\n    configMapListenerManager.watchSharding();\n}\n\n//\nwatchSharding(ConfigurationNode.SHARDING_RULE_NODE_PATH);\nprivate void watchSharding(final String node) {\n    String cachePath = configNode.getFullPath(node);\n    regCenter.watch(cachePath, new EventListener() {\n\n        @Override\n        public void onChange(final DataChangedEvent event) {\n            ///sharding-data/xuzy/config/sharding/rule\n            if (DataChangedEvent.Type.UPDATED == event.getEventType()) {\n                //\n                Map&lt;String, DataSource&gt; dataSourceMap = dataSourceService.getAvailableDataSources();\n                //\n                ShardingConfigurationEventBusEvent shardingEvent = new ShardingConfigurationEventBusEvent(dataSourceMap,\n                        new ShardingRule(dataSourceService.getAvailableShardingRuleConfiguration(), dataSourceMap.keySet()), configService.loadShardingProperties());\n                //guavaEventBusshardingDataSource EventBus\n                ShardingEventBusInstance.getInstance().post(shardingEvent);\n            }\n        }\n    });\n}</code></pre>\n<h4 id=\"EventBus\"><a href=\"#EventBus\" class=\"headerlink\" title=\"EventBus\"></a>EventBus</h4><p>EventBusguava</p>\n<pre><code class=\"java\">public class EventBusTest {\n\n    public static void main(String[] args){\n        final EventBus eventBus = new EventBus();\n        //\n        eventBus.register(new SimpleListener());\n        eventBus.register(new SimpleListener2());\n        //post\n        eventBus.post(&quot;Simple Event&quot;);\n    }\n\n    static class SimpleListener {\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + &quot;_1&quot;);\n        }\n    }\n\n    static class SimpleListener2{\n        @Subscribe\n        public void doAction(final String event) {\n            System.out.println(event + &quot;_2&quot;);\n        }\n    }\n}</code></pre>\n<p>Watch</p>\n<pre><code class=\"java\">ShardingEventBusInstance.getInstance().post(shardingEvent);</code></pre>\n<p><img src=\"/2021/02/02/shardingjdbc-reg/2.png\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>zookeeperWatchshardingjdbc</p>"},{"title":"ShardingJdbc","description":"shardingjdbc","date":"2021-01-09T02:14:00.000Z","_content":"sharding-jdbc:https://shardingsphere.apache.org/document/current/cn/overview/\n**shardingjdbc**\n\n****\n\n![](sharding-student/1.png)\nsql\n```\nselect * from ips where flowtime = '20181202';\n```\nflowtime,20181202201812sharding_2018ips_12\n\n```\nselect * from `sharding_2018`.ips_12 where flowtime = '20181202';\n```\n<!--more-->\n#### \n##### mavensharding\n```\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-orchestration-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n```\n##### \n2017~2020shardingjdbc10\n######applicationContext-database.xml\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans-4.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd\">\n    <bean id=\"dataSource_default\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2017\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2018\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2019\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2020\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n</beans>\n```\n**dataSource_default**\n###### applicationContext-sharding.xml\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\"\n       xmlns:sharding=\"http://shardingsphere.io/schema/shardingsphere/sharding\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n                        http://www.springframework.org/schema/beans/spring-beans.xsd\n                        http://www.springframework.org/schema/tx\n                        http://www.springframework.org/schema/tx/spring-tx.xsd\n                        http://www.springframework.org/schema/context\n                        http://www.springframework.org/schema/context/spring-context.xsd\n                        http://shardingsphere.io/schema/shardingsphere/sharding\n                        http://shardingsphere.io/schema/shardingsphere/sharding/sharding.xsd\">\n\n    <!--:,-->\n    <!--(flowtime)-->\n    <bean id=\"databaseShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"tableShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\"></bean>\n\n\n    <bean id=\"complexModuloDatabaseShardingAlgorithm\" class=\"com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"complexModuloTableShardingAlgorithm\" class=\"com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\"></bean>\n\n\n    <!----time:mysql,time flowtime-->\n    <sharding:standard-strategy id=\"databaseShardingStrategy\" sharding-column=\"flowtime\" precise-algorithm-ref=\"databaseShardingAlgorithm\"/>\n    <!----time-->\n    <sharding:standard-strategy id=\"tableShardingStrategy\" sharding-column=\"flowtime\" precise-algorithm-ref=\"tableShardingAlgorithm\"/>\n\n    <!---->\n    <sharding:complex-strategy id=\"complexdatabaseShardingStrategy\" sharding-columns=\"flowtime,dataType\" algorithm-ref=\"complexModuloDatabaseShardingAlgorithm\"/>\n    <sharding:complex-strategy id=\"complextableShardingStrategy\" sharding-columns=\"flowtime,dataType\" algorithm-ref=\"complexModuloTableShardingAlgorithm\"/>\n\n\n    <sharding:none-strategy id=\"noShardingStrategy\"/>\n\n    <sharding:data-source id=\"shardingDataSource\">\n        <sharding:sharding-rule data-source-names=\"dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default\" default-data-source-name=\"dataSource_default\">\n            <sharding:table-rules>\n                <!--flow-->\n                <sharding:table-rule logic-table=\"flow\" actual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n                <sharding:table-rule logic-table=\"ips\" actual-data-nodes=\"dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n                <sharding:table-rule logic-table=\"acca\" actual-data-nodes=\"dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\" database-strategy-ref=\"complexdatabaseShardingStrategy\" table-strategy-ref=\"complextableShardingStrategy\" />\n                <!--\n                    dataSource_default\n                    <sharding:table-rule logic-table=\"websocket\" actual-data-nodes=\"dataSource_default.websocket\"/>\n                -->\n            </sharding:table-rules>\n        </sharding:sharding-rule>\n        <sharding:props>\n            <prop key=\"sql.show\">true</prop>\n        </sharding:props>\n    </sharding:data-source>\n\n    <bean id=\"jdbcTemplate\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"shardingDataSource\"></property>\n    </bean>\n\n    <!--sharding-->\n    <bean id=\"jdbcTemplate_default\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"dataSource_default\"></property>\n    </bean>\n</beans>\n```\n:\n```\n    <bean id=\"databaseShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"tableShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\"></bean>\n```\nshardingjdbc# [sharding-jdbc](https://www.cnblogs.com/mr-yang-localhost/p/8313360.html)select * from ips where flowtime = '20181212',flowtimeSQLin=shardingjdbc20181212shardingjdbc\n```\n<sharding:sharding-rule data-source-names=\"dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default\" default-data-source-name=\"dataSource_default\">\n......\n</sharding:sharding-rule>\n```\ndata-source-names default-data-source-namesharding\n```\n<sharding:table-rule logic-table=\"flow\" actual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n<sharding:table-rule logic-table=\"ips\" actual-data-nodes=\"dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n<sharding:table-rule logic-table=\"acca\" actual-data-nodes=\"dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\" database-strategy-ref=\"complexdatabaseShardingStrategy\" table-strategy-ref=\"complextableShardingStrategy\" />\n```\n\n```\nactual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\"\n```\n . inlineshardingjdbcdataSource_2017.flow_01 ~ dataSource_2020.flow_12[](https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/inline-expression/)\nlogic-table \ndatabase-strategy-ref \ntable-strategy-ref \n#### \n##### PreciseModuloDatabaseShardingAlgorithm\n```\npublic class PreciseModuloDatabaseShardingAlgorithm implements PreciseShardingAlgorithm<String> {\n\n    @Override\n    public String doSharding(Collection<String> collection, PreciseShardingValue<String> preciseShardingValue) {\n        //collectiondataSource_2017~dataSource_2020\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(\"preciseShardingValue is null\");\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,0,4); //\n            if(each.endsWith(value)){\n               // //\n                return each;\n            }\n        }\n        throw new UnsupportedOperationException();\n    }\n```\n##### PreciseModuloTableShardingAlgorithm\n```\n/**\n * @author xuzhiyong\n * @createDate 2019-01-28-22:30\n * \n */\npublic class PreciseModuloTableShardingAlgorithm implements PreciseShardingAlgorithm<String> {\n    @Override\n    public String doSharding(Collection<String> collection, PreciseShardingValue<String> preciseShardingValue) {\n        //collectionflow_01~flow_12\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(\"preciseShardingValue is null\");\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,4,6); //\n            if(each.endsWith(value)){\n                //\n                return each;\n            }\n        }\n        return null;\n    }\n}\n```\n#####\n```\n@RunWith(SpringJUnit4ClassRunner.class)\n@ContextConfiguration(locations = {\"classpath:applicationContext.xml\", \"classpath:applicationContext-database.xml\", \"classpath:applicationContext-sharding.xml\"})\npublic class ShardingTest {\n    @Resource(name = \"jdbcTemplate\")\n    private JdbcTemplate jdbcTemplate;\n\n    @Test\n    public void testCreateTable() {\n        jdbcTemplate.update(\"CREATE TABLE IF NOT EXISTS ips (flowtime VARCHAR(50) NOT NULL, value INT NOT NULL)\");\n  }\n}\n```\n\n![](sharding-student/2.png)\n\n\n```\n@Test\n    public void testInsertOne(){\n        //\n        jdbcTemplate.update(\"INSERT IGNORE INTO flow(flowtime,value) VALUES ('20190525',1),('20190526',2),('20190527',2)\");\n    }\n```\n\n![](sharding-student/3.png)\n\n```\n @Test\n    public void query(){\n        List<Map<String, Object>> list = jdbcTemplate.queryForList(\"select * from flow where flowtime = '20170818'\");\n    }\n```\n![](sharding-student/4.png)\n#### \n","source":"_posts/sharding-student.md","raw":"---\ntitle: ShardingJdbc\ntags:\n  - shardingjdbc\ncategories: \n  - shardingjdbc\ndescription : shardingjdbc\ndate: 2021-01-09 10:14:00\n---\nsharding-jdbc:https://shardingsphere.apache.org/document/current/cn/overview/\n**shardingjdbc**\n\n****\n\n![](sharding-student/1.png)\nsql\n```\nselect * from ips where flowtime = '20181202';\n```\nflowtime,20181202201812sharding_2018ips_12\n\n```\nselect * from `sharding_2018`.ips_12 where flowtime = '20181202';\n```\n<!--more-->\n#### \n##### mavensharding\n```\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n<dependency>\n            <groupId>io.shardingsphere</groupId>\n            <artifactId>sharding-jdbc-orchestration-spring-namespace</artifactId>\n            <version>3.0.0.M3</version>\n</dependency>\n```\n##### \n2017~2020shardingjdbc10\n######applicationContext-database.xml\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans-4.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd\">\n    <bean id=\"dataSource_default\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2017\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2018\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2019\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n    <bean id=\"dataSource_2020\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;characterEncoding=utf-8\"/>\n        <property name=\"username\" value=\"root\"/>\n        <property name=\"password\" value=\"123456\"/>\n        <!--  -->\n        <property name=\"initialSize\" value=\"0\"></property>\n        <!--  -->\n        <property name=\"maxActive\" value=\"200\"></property>\n        <!--  -->\n        <property name=\"maxIdle\" value=\"20\"></property>\n        <!--  -->\n        <property name=\"minIdle\" value=\"1\"></property>\n        <!--  -->\n        <property name=\"maxWait\" value=\"60000\"></property>\n    </bean>\n</beans>\n```\n**dataSource_default**\n###### applicationContext-sharding.xml\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\"\n       xmlns:sharding=\"http://shardingsphere.io/schema/shardingsphere/sharding\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n                        http://www.springframework.org/schema/beans/spring-beans.xsd\n                        http://www.springframework.org/schema/tx\n                        http://www.springframework.org/schema/tx/spring-tx.xsd\n                        http://www.springframework.org/schema/context\n                        http://www.springframework.org/schema/context/spring-context.xsd\n                        http://shardingsphere.io/schema/shardingsphere/sharding\n                        http://shardingsphere.io/schema/shardingsphere/sharding/sharding.xsd\">\n\n    <!--:,-->\n    <!--(flowtime)-->\n    <bean id=\"databaseShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"tableShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\"></bean>\n\n\n    <bean id=\"complexModuloDatabaseShardingAlgorithm\" class=\"com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"complexModuloTableShardingAlgorithm\" class=\"com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm\"></bean>\n\n\n    <!----time:mysql,time flowtime-->\n    <sharding:standard-strategy id=\"databaseShardingStrategy\" sharding-column=\"flowtime\" precise-algorithm-ref=\"databaseShardingAlgorithm\"/>\n    <!----time-->\n    <sharding:standard-strategy id=\"tableShardingStrategy\" sharding-column=\"flowtime\" precise-algorithm-ref=\"tableShardingAlgorithm\"/>\n\n    <!---->\n    <sharding:complex-strategy id=\"complexdatabaseShardingStrategy\" sharding-columns=\"flowtime,dataType\" algorithm-ref=\"complexModuloDatabaseShardingAlgorithm\"/>\n    <sharding:complex-strategy id=\"complextableShardingStrategy\" sharding-columns=\"flowtime,dataType\" algorithm-ref=\"complexModuloTableShardingAlgorithm\"/>\n\n\n    <sharding:none-strategy id=\"noShardingStrategy\"/>\n\n    <sharding:data-source id=\"shardingDataSource\">\n        <sharding:sharding-rule data-source-names=\"dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default\" default-data-source-name=\"dataSource_default\">\n            <sharding:table-rules>\n                <!--flow-->\n                <sharding:table-rule logic-table=\"flow\" actual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n                <sharding:table-rule logic-table=\"ips\" actual-data-nodes=\"dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n                <sharding:table-rule logic-table=\"acca\" actual-data-nodes=\"dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\" database-strategy-ref=\"complexdatabaseShardingStrategy\" table-strategy-ref=\"complextableShardingStrategy\" />\n                <!--\n                    dataSource_default\n                    <sharding:table-rule logic-table=\"websocket\" actual-data-nodes=\"dataSource_default.websocket\"/>\n                -->\n            </sharding:table-rules>\n        </sharding:sharding-rule>\n        <sharding:props>\n            <prop key=\"sql.show\">true</prop>\n        </sharding:props>\n    </sharding:data-source>\n\n    <bean id=\"jdbcTemplate\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"shardingDataSource\"></property>\n    </bean>\n\n    <!--sharding-->\n    <bean id=\"jdbcTemplate_default\" class=\"org.springframework.jdbc.core.JdbcTemplate\">\n        <property name=\"dataSource\" ref=\"dataSource_default\"></property>\n    </bean>\n</beans>\n```\n:\n```\n    <bean id=\"databaseShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm\"></bean>\n    <bean id=\"tableShardingAlgorithm\" class=\"com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm\"></bean>\n```\nshardingjdbc# [sharding-jdbc](https://www.cnblogs.com/mr-yang-localhost/p/8313360.html)select * from ips where flowtime = '20181212',flowtimeSQLin=shardingjdbc20181212shardingjdbc\n```\n<sharding:sharding-rule data-source-names=\"dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default\" default-data-source-name=\"dataSource_default\">\n......\n</sharding:sharding-rule>\n```\ndata-source-names default-data-source-namesharding\n```\n<sharding:table-rule logic-table=\"flow\" actual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n<sharding:table-rule logic-table=\"ips\" actual-data-nodes=\"dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}\" database-strategy-ref=\"databaseShardingStrategy\" table-strategy-ref=\"tableShardingStrategy\" />\n<sharding:table-rule logic-table=\"acca\" actual-data-nodes=\"dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}\" database-strategy-ref=\"complexdatabaseShardingStrategy\" table-strategy-ref=\"complextableShardingStrategy\" />\n```\n\n```\nactual-data-nodes=\"dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}\"\n```\n . inlineshardingjdbcdataSource_2017.flow_01 ~ dataSource_2020.flow_12[](https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/inline-expression/)\nlogic-table \ndatabase-strategy-ref \ntable-strategy-ref \n#### \n##### PreciseModuloDatabaseShardingAlgorithm\n```\npublic class PreciseModuloDatabaseShardingAlgorithm implements PreciseShardingAlgorithm<String> {\n\n    @Override\n    public String doSharding(Collection<String> collection, PreciseShardingValue<String> preciseShardingValue) {\n        //collectiondataSource_2017~dataSource_2020\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(\"preciseShardingValue is null\");\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,0,4); //\n            if(each.endsWith(value)){\n               // //\n                return each;\n            }\n        }\n        throw new UnsupportedOperationException();\n    }\n```\n##### PreciseModuloTableShardingAlgorithm\n```\n/**\n * @author xuzhiyong\n * @createDate 2019-01-28-22:30\n * \n */\npublic class PreciseModuloTableShardingAlgorithm implements PreciseShardingAlgorithm<String> {\n    @Override\n    public String doSharding(Collection<String> collection, PreciseShardingValue<String> preciseShardingValue) {\n        //collectionflow_01~flow_12\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(\"preciseShardingValue is null\");\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,4,6); //\n            if(each.endsWith(value)){\n                //\n                return each;\n            }\n        }\n        return null;\n    }\n}\n```\n#####\n```\n@RunWith(SpringJUnit4ClassRunner.class)\n@ContextConfiguration(locations = {\"classpath:applicationContext.xml\", \"classpath:applicationContext-database.xml\", \"classpath:applicationContext-sharding.xml\"})\npublic class ShardingTest {\n    @Resource(name = \"jdbcTemplate\")\n    private JdbcTemplate jdbcTemplate;\n\n    @Test\n    public void testCreateTable() {\n        jdbcTemplate.update(\"CREATE TABLE IF NOT EXISTS ips (flowtime VARCHAR(50) NOT NULL, value INT NOT NULL)\");\n  }\n}\n```\n\n![](sharding-student/2.png)\n\n\n```\n@Test\n    public void testInsertOne(){\n        //\n        jdbcTemplate.update(\"INSERT IGNORE INTO flow(flowtime,value) VALUES ('20190525',1),('20190526',2),('20190527',2)\");\n    }\n```\n\n![](sharding-student/3.png)\n\n```\n @Test\n    public void query(){\n        List<Map<String, Object>> list = jdbcTemplate.queryForList(\"select * from flow where flowtime = '20170818'\");\n    }\n```\n![](sharding-student/4.png)\n#### \n","slug":"sharding-student","published":1,"updated":"2021-04-08T00:47:06.977Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvt003iqwv21k7k2dns","content":"<p>sharding-jdbc:<a href=\"https://shardingsphere.apache.org/document/current/cn/overview/\" target=\"_blank\" rel=\"noopener\">https://shardingsphere.apache.org/document/current/cn/overview/</a><br><strong>shardingjdbc</strong></p>\n<p><strong></strong></p>\n<p><img src=\"/2021/01/09/sharding-student/1.png\" alt><br>sql</p>\n<pre><code>select * from ips where flowtime = &#39;20181202&#39;;</code></pre><p>flowtime,20181202201812sharding_2018ips_12<br></p>\n<pre><code>select * from `sharding_2018`.ips_12 where flowtime = &#39;20181202&#39;;</code></pre><a id=\"more\"></a>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"mavensharding\"><a href=\"#mavensharding\" class=\"headerlink\" title=\"mavensharding\"></a>mavensharding</h5><pre><code>&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0.M3&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-orchestration-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0.M3&lt;/version&gt;\n&lt;/dependency&gt;</code></pre><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>2017~2020shardingjdbc10<br>######applicationContext-database.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans-4.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;\n    &lt;bean id=&quot;dataSource_default&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2017&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2018&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2019&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2020&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><p><strong>dataSource_default</strong></p>\n<h6 id=\"applicationContext-sharding-xml\"><a href=\"#applicationContext-sharding-xml\" class=\"headerlink\" title=\"applicationContext-sharding.xml\"></a>applicationContext-sharding.xml</h6><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;\n       xmlns:sharding=&quot;http://shardingsphere.io/schema/shardingsphere/sharding&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n                        http://www.springframework.org/schema/beans/spring-beans.xsd\n                        http://www.springframework.org/schema/tx\n                        http://www.springframework.org/schema/tx/spring-tx.xsd\n                        http://www.springframework.org/schema/context\n                        http://www.springframework.org/schema/context/spring-context.xsd\n                        http://shardingsphere.io/schema/shardingsphere/sharding\n                        http://shardingsphere.io/schema/shardingsphere/sharding/sharding.xsd&quot;&gt;\n\n    &lt;!--:,--&gt;\n    &lt;!--(flowtime)--&gt;\n    &lt;bean id=&quot;databaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;tableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n\n\n    &lt;bean id=&quot;complexModuloDatabaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;complexModuloTableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n\n\n    &lt;!----time:mysql,time flowtime--&gt;\n    &lt;sharding:standard-strategy id=&quot;databaseShardingStrategy&quot; sharding-column=&quot;flowtime&quot; precise-algorithm-ref=&quot;databaseShardingAlgorithm&quot;/&gt;\n    &lt;!----time--&gt;\n    &lt;sharding:standard-strategy id=&quot;tableShardingStrategy&quot; sharding-column=&quot;flowtime&quot; precise-algorithm-ref=&quot;tableShardingAlgorithm&quot;/&gt;\n\n    &lt;!----&gt;\n    &lt;sharding:complex-strategy id=&quot;complexdatabaseShardingStrategy&quot; sharding-columns=&quot;flowtime,dataType&quot; algorithm-ref=&quot;complexModuloDatabaseShardingAlgorithm&quot;/&gt;\n    &lt;sharding:complex-strategy id=&quot;complextableShardingStrategy&quot; sharding-columns=&quot;flowtime,dataType&quot; algorithm-ref=&quot;complexModuloTableShardingAlgorithm&quot;/&gt;\n\n\n    &lt;sharding:none-strategy id=&quot;noShardingStrategy&quot;/&gt;\n\n    &lt;sharding:data-source id=&quot;shardingDataSource&quot;&gt;\n        &lt;sharding:sharding-rule data-source-names=&quot;dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default&quot; default-data-source-name=&quot;dataSource_default&quot;&gt;\n            &lt;sharding:table-rules&gt;\n                &lt;!--flow--&gt;\n                &lt;sharding:table-rule logic-table=&quot;flow&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n                &lt;sharding:table-rule logic-table=&quot;ips&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n                &lt;sharding:table-rule logic-table=&quot;acca&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}&quot; database-strategy-ref=&quot;complexdatabaseShardingStrategy&quot; table-strategy-ref=&quot;complextableShardingStrategy&quot; /&gt;\n                &lt;!--\n                    dataSource_default\n                    &lt;sharding:table-rule logic-table=&quot;websocket&quot; actual-data-nodes=&quot;dataSource_default.websocket&quot;/&gt;\n                --&gt;\n            &lt;/sharding:table-rules&gt;\n        &lt;/sharding:sharding-rule&gt;\n        &lt;sharding:props&gt;\n            &lt;prop key=&quot;sql.show&quot;&gt;true&lt;/prop&gt;\n        &lt;/sharding:props&gt;\n    &lt;/sharding:data-source&gt;\n\n    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;shardingDataSource&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--sharding--&gt;\n    &lt;bean id=&quot;jdbcTemplate_default&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource_default&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><p>:</p>\n<pre><code>    &lt;bean id=&quot;databaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;tableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;</code></pre><p>shardingjdbc# <a href=\"https://www.cnblogs.com/mr-yang-localhost/p/8313360.html\" target=\"_blank\" rel=\"noopener\">sharding-jdbc</a>select * from ips where flowtime = 20181212,flowtimeSQLin=shardingjdbc20181212shardingjdbc</p>\n<pre><code>&lt;sharding:sharding-rule data-source-names=&quot;dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default&quot; default-data-source-name=&quot;dataSource_default&quot;&gt;\n......\n&lt;/sharding:sharding-rule&gt;</code></pre><p>data-source-names default-data-source-namesharding</p>\n<pre><code>&lt;sharding:table-rule logic-table=&quot;flow&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n&lt;sharding:table-rule logic-table=&quot;ips&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n&lt;sharding:table-rule logic-table=&quot;acca&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}&quot; database-strategy-ref=&quot;complexdatabaseShardingStrategy&quot; table-strategy-ref=&quot;complextableShardingStrategy&quot; /&gt;</code></pre><p></p>\n<pre><code>actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot;</code></pre><p> . inlineshardingjdbcdataSource_2017.flow_01 ~ dataSource_2020.flow_12<a href=\"https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/inline-expression/\" target=\"_blank\" rel=\"noopener\"></a><br>logic-table <br>database-strategy-ref <br>table-strategy-ref </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>##### PreciseModuloDatabaseShardingAlgorithm</p>\n<pre><code>public class PreciseModuloDatabaseShardingAlgorithm implements PreciseShardingAlgorithm&lt;String&gt; {\n\n    @Override\n    public String doSharding(Collection&lt;String&gt; collection, PreciseShardingValue&lt;String&gt; preciseShardingValue) {\n        //collectiondataSource_2017~dataSource_2020\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(&quot;preciseShardingValue is null&quot;);\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,0,4); //\n            if(each.endsWith(value)){\n               // //\n                return each;\n            }\n        }\n        throw new UnsupportedOperationException();\n    }</code></pre><p>##### PreciseModuloTableShardingAlgorithm</p>\n<pre><code>/**\n * @author xuzhiyong\n * @createDate 2019-01-28-22:30\n * \n */\npublic class PreciseModuloTableShardingAlgorithm implements PreciseShardingAlgorithm&lt;String&gt; {\n    @Override\n    public String doSharding(Collection&lt;String&gt; collection, PreciseShardingValue&lt;String&gt; preciseShardingValue) {\n        //collectionflow_01~flow_12\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(&quot;preciseShardingValue is null&quot;);\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,4,6); //\n            if(each.endsWith(value)){\n                //\n                return each;\n            }\n        }\n        return null;\n    }\n}</code></pre><p>#####</p>\n<pre><code>@RunWith(SpringJUnit4ClassRunner.class)\n@ContextConfiguration(locations = {&quot;classpath:applicationContext.xml&quot;, &quot;classpath:applicationContext-database.xml&quot;, &quot;classpath:applicationContext-sharding.xml&quot;})\npublic class ShardingTest {\n    @Resource(name = &quot;jdbcTemplate&quot;)\n    private JdbcTemplate jdbcTemplate;\n\n    @Test\n    public void testCreateTable() {\n        jdbcTemplate.update(&quot;CREATE TABLE IF NOT EXISTS ips (flowtime VARCHAR(50) NOT NULL, value INT NOT NULL)&quot;);\n  }\n}</code></pre><p><br><img src=\"/2021/01/09/sharding-student/2.png\" alt><br></p>\n<pre><code>@Test\n    public void testInsertOne(){\n        //\n        jdbcTemplate.update(&quot;INSERT IGNORE INTO flow(flowtime,value) VALUES (&#39;20190525&#39;,1),(&#39;20190526&#39;,2),(&#39;20190527&#39;,2)&quot;);\n    }</code></pre><p><br><img src=\"/2021/01/09/sharding-student/3.png\" alt></p>\n<pre><code> @Test\n    public void query(){\n        List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(&quot;select * from flow where flowtime = &#39;20170818&#39;&quot;);\n    }</code></pre><p><img src=\"/2021/01/09/sharding-student/4.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n","site":{"data":{}},"excerpt":"<p>sharding-jdbc:<a href=\"https://shardingsphere.apache.org/document/current/cn/overview/\" target=\"_blank\" rel=\"noopener\">https://shardingsphere.apache.org/document/current/cn/overview/</a><br><strong>shardingjdbc</strong></p>\n<p><strong></strong></p>\n<p><img src=\"/2021/01/09/sharding-student/1.png\" alt><br>sql</p>\n<pre><code>select * from ips where flowtime = &#39;20181202&#39;;</code></pre><p>flowtime,20181202201812sharding_2018ips_12<br></p>\n<pre><code>select * from `sharding_2018`.ips_12 where flowtime = &#39;20181202&#39;;</code></pre>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"mavensharding\"><a href=\"#mavensharding\" class=\"headerlink\" title=\"mavensharding\"></a>mavensharding</h5><pre><code>&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0.M3&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n            &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-orchestration-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;3.0.0.M3&lt;/version&gt;\n&lt;/dependency&gt;</code></pre><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>2017~2020shardingjdbc10<br>######applicationContext-database.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans-4.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;\n    &lt;bean id=&quot;dataSource_default&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_default?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2017&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2017?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2018&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2018?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2019&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2019?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n    &lt;bean id=&quot;dataSource_2020&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;\n        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/sharding_2020?useUnicode=true&amp;amp;characterEncoding=utf-8&quot;/&gt;\n        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;initialSize&quot; value=&quot;0&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxIdle&quot; value=&quot;20&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;minIdle&quot; value=&quot;1&quot;&gt;&lt;/property&gt;\n        &lt;!--  --&gt;\n        &lt;property name=&quot;maxWait&quot; value=&quot;60000&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><p><strong>dataSource_default</strong></p>\n<h6 id=\"applicationContext-sharding-xml\"><a href=\"#applicationContext-sharding-xml\" class=\"headerlink\" title=\"applicationContext-sharding.xml\"></a>applicationContext-sharding.xml</h6><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;\n       xmlns:sharding=&quot;http://shardingsphere.io/schema/shardingsphere/sharding&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n                        http://www.springframework.org/schema/beans/spring-beans.xsd\n                        http://www.springframework.org/schema/tx\n                        http://www.springframework.org/schema/tx/spring-tx.xsd\n                        http://www.springframework.org/schema/context\n                        http://www.springframework.org/schema/context/spring-context.xsd\n                        http://shardingsphere.io/schema/shardingsphere/sharding\n                        http://shardingsphere.io/schema/shardingsphere/sharding/sharding.xsd&quot;&gt;\n\n    &lt;!--:,--&gt;\n    &lt;!--(flowtime)--&gt;\n    &lt;bean id=&quot;databaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;tableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n\n\n    &lt;bean id=&quot;complexModuloDatabaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.ComplexModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;complexModuloTableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.ComplexModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n\n\n    &lt;!----time:mysql,time flowtime--&gt;\n    &lt;sharding:standard-strategy id=&quot;databaseShardingStrategy&quot; sharding-column=&quot;flowtime&quot; precise-algorithm-ref=&quot;databaseShardingAlgorithm&quot;/&gt;\n    &lt;!----time--&gt;\n    &lt;sharding:standard-strategy id=&quot;tableShardingStrategy&quot; sharding-column=&quot;flowtime&quot; precise-algorithm-ref=&quot;tableShardingAlgorithm&quot;/&gt;\n\n    &lt;!----&gt;\n    &lt;sharding:complex-strategy id=&quot;complexdatabaseShardingStrategy&quot; sharding-columns=&quot;flowtime,dataType&quot; algorithm-ref=&quot;complexModuloDatabaseShardingAlgorithm&quot;/&gt;\n    &lt;sharding:complex-strategy id=&quot;complextableShardingStrategy&quot; sharding-columns=&quot;flowtime,dataType&quot; algorithm-ref=&quot;complexModuloTableShardingAlgorithm&quot;/&gt;\n\n\n    &lt;sharding:none-strategy id=&quot;noShardingStrategy&quot;/&gt;\n\n    &lt;sharding:data-source id=&quot;shardingDataSource&quot;&gt;\n        &lt;sharding:sharding-rule data-source-names=&quot;dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default&quot; default-data-source-name=&quot;dataSource_default&quot;&gt;\n            &lt;sharding:table-rules&gt;\n                &lt;!--flow--&gt;\n                &lt;sharding:table-rule logic-table=&quot;flow&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n                &lt;sharding:table-rule logic-table=&quot;ips&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n                &lt;sharding:table-rule logic-table=&quot;acca&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}&quot; database-strategy-ref=&quot;complexdatabaseShardingStrategy&quot; table-strategy-ref=&quot;complextableShardingStrategy&quot; /&gt;\n                &lt;!--\n                    dataSource_default\n                    &lt;sharding:table-rule logic-table=&quot;websocket&quot; actual-data-nodes=&quot;dataSource_default.websocket&quot;/&gt;\n                --&gt;\n            &lt;/sharding:table-rules&gt;\n        &lt;/sharding:sharding-rule&gt;\n        &lt;sharding:props&gt;\n            &lt;prop key=&quot;sql.show&quot;&gt;true&lt;/prop&gt;\n        &lt;/sharding:props&gt;\n    &lt;/sharding:data-source&gt;\n\n    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;shardingDataSource&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--sharding--&gt;\n    &lt;bean id=&quot;jdbcTemplate_default&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;\n        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource_default&quot;&gt;&lt;/property&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre><p>:</p>\n<pre><code>    &lt;bean id=&quot;databaseShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloDatabaseShardingAlgorithm&quot;&gt;&lt;/bean&gt;\n    &lt;bean id=&quot;tableShardingAlgorithm&quot; class=&quot;com.shardingAlgorithm.PreciseModuloTableShardingAlgorithm&quot;&gt;&lt;/bean&gt;</code></pre><p>shardingjdbc# <a href=\"https://www.cnblogs.com/mr-yang-localhost/p/8313360.html\" target=\"_blank\" rel=\"noopener\">sharding-jdbc</a>select * from ips where flowtime = 20181212,flowtimeSQLin=shardingjdbc20181212shardingjdbc</p>\n<pre><code>&lt;sharding:sharding-rule data-source-names=&quot;dataSource_2017,dataSource_2018,dataSource_2019,dataSource_2020,dataSource_default&quot; default-data-source-name=&quot;dataSource_default&quot;&gt;\n......\n&lt;/sharding:sharding-rule&gt;</code></pre><p>data-source-names default-data-source-namesharding</p>\n<pre><code>&lt;sharding:table-rule logic-table=&quot;flow&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n&lt;sharding:table-rule logic-table=&quot;ips&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.ips_0${1..9},dataSource_${2017..2020}.ips_1${0..2}&quot; database-strategy-ref=&quot;databaseShardingStrategy&quot; table-strategy-ref=&quot;tableShardingStrategy&quot; /&gt;\n&lt;sharding:table-rule logic-table=&quot;acca&quot; actual-data-nodes=&quot;dataSource_${2017..2020}.acca_0${1..9},dataSource_${2017..2020}.acca_1${0..2}&quot; database-strategy-ref=&quot;complexdatabaseShardingStrategy&quot; table-strategy-ref=&quot;complextableShardingStrategy&quot; /&gt;</code></pre><p></p>\n<pre><code>actual-data-nodes=&quot;dataSource_${2017..2020}.flow_0${1..9},dataSource_${2017..2020}.flow_1${0..2}&quot;</code></pre><p> . inlineshardingjdbcdataSource_2017.flow_01 ~ dataSource_2020.flow_12<a href=\"https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/inline-expression/\" target=\"_blank\" rel=\"noopener\"></a><br>logic-table <br>database-strategy-ref <br>table-strategy-ref </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>##### PreciseModuloDatabaseShardingAlgorithm</p>\n<pre><code>public class PreciseModuloDatabaseShardingAlgorithm implements PreciseShardingAlgorithm&lt;String&gt; {\n\n    @Override\n    public String doSharding(Collection&lt;String&gt; collection, PreciseShardingValue&lt;String&gt; preciseShardingValue) {\n        //collectiondataSource_2017~dataSource_2020\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(&quot;preciseShardingValue is null&quot;);\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,0,4); //\n            if(each.endsWith(value)){\n               // //\n                return each;\n            }\n        }\n        throw new UnsupportedOperationException();\n    }</code></pre><p>##### PreciseModuloTableShardingAlgorithm</p>\n<pre><code>/**\n * @author xuzhiyong\n * @createDate 2019-01-28-22:30\n * \n */\npublic class PreciseModuloTableShardingAlgorithm implements PreciseShardingAlgorithm&lt;String&gt; {\n    @Override\n    public String doSharding(Collection&lt;String&gt; collection, PreciseShardingValue&lt;String&gt; preciseShardingValue) {\n        //collectionflow_01~flow_12\n        //sharding-column\n        String timeValue = preciseShardingValue.getValue();\n        //sharding-column\n        String time = preciseShardingValue.getColumnName();\n        //\n        String table = preciseShardingValue.getLogicTableName();\n        if(StringUtils.isBlank(timeValue)){\n            throw new UnsupportedOperationException(&quot;preciseShardingValue is null&quot;);\n        }\n        //\n        for (String each : collection) {\n            String value = StringUtils.substring(timeValue,4,6); //\n            if(each.endsWith(value)){\n                //\n                return each;\n            }\n        }\n        return null;\n    }\n}</code></pre><p>#####</p>\n<pre><code>@RunWith(SpringJUnit4ClassRunner.class)\n@ContextConfiguration(locations = {&quot;classpath:applicationContext.xml&quot;, &quot;classpath:applicationContext-database.xml&quot;, &quot;classpath:applicationContext-sharding.xml&quot;})\npublic class ShardingTest {\n    @Resource(name = &quot;jdbcTemplate&quot;)\n    private JdbcTemplate jdbcTemplate;\n\n    @Test\n    public void testCreateTable() {\n        jdbcTemplate.update(&quot;CREATE TABLE IF NOT EXISTS ips (flowtime VARCHAR(50) NOT NULL, value INT NOT NULL)&quot;);\n  }\n}</code></pre><p><br><img src=\"/2021/01/09/sharding-student/2.png\" alt><br></p>\n<pre><code>@Test\n    public void testInsertOne(){\n        //\n        jdbcTemplate.update(&quot;INSERT IGNORE INTO flow(flowtime,value) VALUES (&#39;20190525&#39;,1),(&#39;20190526&#39;,2),(&#39;20190527&#39;,2)&quot;);\n    }</code></pre><p><br><img src=\"/2021/01/09/sharding-student/3.png\" alt></p>\n<pre><code> @Test\n    public void query(){\n        List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(&quot;select * from flow where flowtime = &#39;20170818&#39;&quot;);\n    }</code></pre><p><img src=\"/2021/01/09/sharding-student/4.png\" alt></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>"},{"title":"Spring","description":"Spring","date":"2020-09-13T03:24:54.000Z","_content":"\n## \n\n### BeanDefinitionRegistryPostProcessor\n\n![](spring-extend/1.png)\n\nBeanDefinitionbeanDefinitionBeanDefinition\n\n- postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry)beanspring\n- postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)BeanDefinition\n<!--more-->\n\n\n```java\n//refresh -> #invokeBeanFactoryPostProcessors() -> PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, //getBeanFactoryPostProcessors())\nboolean reiterate = true;\nwhile (reiterate) {\n\treiterate = false;\n\tpostProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n\tfor (String ppName : postProcessorNames) {\n\t\tif (!processedBeans.contains(ppName)) {\n\t\t\tcurrentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n\t\t\tprocessedBeans.add(ppName);\n\t\t\treiterate = true;\n\t\t}\n\t}\n\tsortPostProcessors(currentRegistryProcessors, beanFactory);\n\tregistryProcessors.addAll(currentRegistryProcessors);\n    //postProcessBeanDefinitionRegistry\n\tinvokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n\tcurrentRegistryProcessors.clear();\n}\n//postProcessBeanFactory\ninvokeBeanFactoryPostProcessors(registryProcessors, beanFactory);\ninvokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);\n```\n\n### BeanFactoryPostProcessor\n\nbeanFactoryspringbeanDefinitionbeanBeanDefinitionRegistryPostProcessorpostProcessBeanFactorybeanDefinition\n\n### InstantiationAwareBeanPostProcessor\n\nInstantiationAwareBeanPostProcessorBeanPostProcessBeanPostProcess`````bean``bean```\n\n![InstantiationAwareBeanPostProcessor](spring-extend/2.png)\n\n- postProcessBeforeInitialization \n- postProcessAfterInitialization \n- postProcessBeforeInstantiation \n- postProcessAfterInstantiation \n- postProcessProperties **@Autowired,@Resource**\n\n**Spring@AutowiredAutowiredAnnotationBeanPostProcessor**\n\n### SmartInstantiationAwareBeanPostProcessor\n\nSmartInstantiationAwareBeanPostProcessor`InstantiationAwareBeanPostProcessor`\n\n- predictBeanType`postProcessBeforeInstantiation`BeanBeanFactory.getType(name)beanbean\n- determineCandidateConstructors`postProcessBeforeInstantiation`bean\n- getEarlyBeanReference`postProcessAfterInstantiation`****\n\n### MergedBeanDefinitionPostProcessor\n\nAutowiredAnnotationBeanPostProcessor\n\nAutowiredAnnotationBeanPostProcessorspringbean@Autowired@ValueInjectionMetadata\n\n![](spring-extend/4.png)\n\n### BeanFactoryAware\n\n**beanSetter**\n\nbean BeanFactorybean\n\n**BeanBean**\n\n### BeanNameAware\n\nbean`postProcessBeforeInitialization`\n\nbeanspringbeanNamebeanName\n\n### InitializingBean\n\n`postProcessAfterInitialization`\n\n### DisposableBean\n\napplicationContext.registerShutdownHook\n\n### NamespaceHandler\n\n**BeanDefinitionParserBeanBeancomponent-scan**\n\n\\<context:component-scan\\>\n\n**spring.handlers\\<context:NamespaceHandler**\n\n![](spring-extend/3.png)\n\napplication.xmlcomponent-scanContextNamespaceHandlerinit\n\n```java\npublic class ContextNamespaceHandler extends NamespaceHandlerSupport {\n\t@Override\n\tpublic void init() {\n\t\tregisterBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser());\n         //component-scan\n\t\tregisterBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"load-time-weaver\", new LoadTimeWeaverBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-export\", new MBeanExportBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-server\", new MBeanServerBeanDefinitionParser());\n\t}\n}\n```\n\n**ComponentScanBeanDefinitionParserBeanDefinition**\n\nregisterComponents\n\n```java\nSet<BeanDefinitionHolder> processorDefinitions =\n\t\t\t\t\tAnnotationConfigUtils.registerAnnotationConfigProcessors(readerContext.getRegistry(), source)\n```\n\n- ConfigurationClassPostProcessor@Configuration@ComponentScan@Beanspring\n- AutowiredAnnotationBeanPostProcessor@Autowried\n- CommonAnnotationBeanPostProcessor@Resource@WebServiceRef@EJB\n- EventListenerMethodProcessor\n- DefaultEventListenerFactory\n\n### ApplicationContextAwareProcessor\n\nApplicationContextAwareProcessorSpring6 beanApplicationContextAwareApplicationContextAwareSpringUtilsgetBean\n\n```java\n//ApplicationContextAwareProcessorpostProcessBeforeInitialization\nprivate void invokeAwareInterfaces(Object bean) {\n\tif (bean instanceof EnvironmentAware) {\n\t\t((EnvironmentAware) bean).setEnvironment(this.applicationContext.getEnvironment());\n\t}\n\tif (bean instanceof EmbeddedValueResolverAware) {\n\t\t((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(this.embeddedValueResolver);\n\t}\n\tif (bean instanceof ResourceLoaderAware) {\n\t\t((ResourceLoaderAware) bean).setResourceLoader(this.applicationContext);\n\t}\n\tif (bean instanceof ApplicationEventPublisherAware) {\n\t\t((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(this.applicationContext);\n\t}\n\tif (bean instanceof MessageSourceAware) {\n\t\t((MessageSourceAware) bean).setMessageSource(this.applicationContext);\n\t}\n    //BeanApplicationContextAwareapplicationContext\n\tif (bean instanceof ApplicationContextAware) {\n\t\t((ApplicationContextAware) bean).setApplicationContext(this.applicationContext);\n\t}\n}\n```\n\n```java\n@Component\npublic class AppUtil implements ApplicationContextAware {\n    private static ApplicationContext applicationContext;\n    @Override\n    public void setApplicationContext(ApplicationContext arg0) throws BeansException {\n        //ApplicationContextspring\n        applicationContext = arg0;\n    }\n\n    public static Object getBean(String id) {\n        Object object = null;\n        object = applicationContext.getBean(id);\n        return object;\n    }\n}\n```\n\n- EnvironmentAwareEnviromentAware \n- EmbeddedValueResolverAwareStringValueResolver StringValueResolverStringproperties@Value\n- ResourceLoaderAwareResourceLoaderResourceLoaderclasspathResourceLoader\n- ApplicationEventPublisherAwareApplicationEventPublisher\n- MessageSourceAwareMessageSourceMessageSource\n- ApplicationContextAwareApplicationContext\n\n","source":"_posts/spring-extend.md","raw":"---\ntitle: Spring\ntags:\n  - spring\ncategories: \n  - spring\ndescription : Spring\ndate: 2020-09-13 11:24:54\n---\n\n## \n\n### BeanDefinitionRegistryPostProcessor\n\n![](spring-extend/1.png)\n\nBeanDefinitionbeanDefinitionBeanDefinition\n\n- postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry)beanspring\n- postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)BeanDefinition\n<!--more-->\n\n\n```java\n//refresh -> #invokeBeanFactoryPostProcessors() -> PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, //getBeanFactoryPostProcessors())\nboolean reiterate = true;\nwhile (reiterate) {\n\treiterate = false;\n\tpostProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n\tfor (String ppName : postProcessorNames) {\n\t\tif (!processedBeans.contains(ppName)) {\n\t\t\tcurrentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n\t\t\tprocessedBeans.add(ppName);\n\t\t\treiterate = true;\n\t\t}\n\t}\n\tsortPostProcessors(currentRegistryProcessors, beanFactory);\n\tregistryProcessors.addAll(currentRegistryProcessors);\n    //postProcessBeanDefinitionRegistry\n\tinvokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n\tcurrentRegistryProcessors.clear();\n}\n//postProcessBeanFactory\ninvokeBeanFactoryPostProcessors(registryProcessors, beanFactory);\ninvokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);\n```\n\n### BeanFactoryPostProcessor\n\nbeanFactoryspringbeanDefinitionbeanBeanDefinitionRegistryPostProcessorpostProcessBeanFactorybeanDefinition\n\n### InstantiationAwareBeanPostProcessor\n\nInstantiationAwareBeanPostProcessorBeanPostProcessBeanPostProcess`````bean``bean```\n\n![InstantiationAwareBeanPostProcessor](spring-extend/2.png)\n\n- postProcessBeforeInitialization \n- postProcessAfterInitialization \n- postProcessBeforeInstantiation \n- postProcessAfterInstantiation \n- postProcessProperties **@Autowired,@Resource**\n\n**Spring@AutowiredAutowiredAnnotationBeanPostProcessor**\n\n### SmartInstantiationAwareBeanPostProcessor\n\nSmartInstantiationAwareBeanPostProcessor`InstantiationAwareBeanPostProcessor`\n\n- predictBeanType`postProcessBeforeInstantiation`BeanBeanFactory.getType(name)beanbean\n- determineCandidateConstructors`postProcessBeforeInstantiation`bean\n- getEarlyBeanReference`postProcessAfterInstantiation`****\n\n### MergedBeanDefinitionPostProcessor\n\nAutowiredAnnotationBeanPostProcessor\n\nAutowiredAnnotationBeanPostProcessorspringbean@Autowired@ValueInjectionMetadata\n\n![](spring-extend/4.png)\n\n### BeanFactoryAware\n\n**beanSetter**\n\nbean BeanFactorybean\n\n**BeanBean**\n\n### BeanNameAware\n\nbean`postProcessBeforeInitialization`\n\nbeanspringbeanNamebeanName\n\n### InitializingBean\n\n`postProcessAfterInitialization`\n\n### DisposableBean\n\napplicationContext.registerShutdownHook\n\n### NamespaceHandler\n\n**BeanDefinitionParserBeanBeancomponent-scan**\n\n\\<context:component-scan\\>\n\n**spring.handlers\\<context:NamespaceHandler**\n\n![](spring-extend/3.png)\n\napplication.xmlcomponent-scanContextNamespaceHandlerinit\n\n```java\npublic class ContextNamespaceHandler extends NamespaceHandlerSupport {\n\t@Override\n\tpublic void init() {\n\t\tregisterBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser());\n         //component-scan\n\t\tregisterBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"load-time-weaver\", new LoadTimeWeaverBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-export\", new MBeanExportBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-server\", new MBeanServerBeanDefinitionParser());\n\t}\n}\n```\n\n**ComponentScanBeanDefinitionParserBeanDefinition**\n\nregisterComponents\n\n```java\nSet<BeanDefinitionHolder> processorDefinitions =\n\t\t\t\t\tAnnotationConfigUtils.registerAnnotationConfigProcessors(readerContext.getRegistry(), source)\n```\n\n- ConfigurationClassPostProcessor@Configuration@ComponentScan@Beanspring\n- AutowiredAnnotationBeanPostProcessor@Autowried\n- CommonAnnotationBeanPostProcessor@Resource@WebServiceRef@EJB\n- EventListenerMethodProcessor\n- DefaultEventListenerFactory\n\n### ApplicationContextAwareProcessor\n\nApplicationContextAwareProcessorSpring6 beanApplicationContextAwareApplicationContextAwareSpringUtilsgetBean\n\n```java\n//ApplicationContextAwareProcessorpostProcessBeforeInitialization\nprivate void invokeAwareInterfaces(Object bean) {\n\tif (bean instanceof EnvironmentAware) {\n\t\t((EnvironmentAware) bean).setEnvironment(this.applicationContext.getEnvironment());\n\t}\n\tif (bean instanceof EmbeddedValueResolverAware) {\n\t\t((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(this.embeddedValueResolver);\n\t}\n\tif (bean instanceof ResourceLoaderAware) {\n\t\t((ResourceLoaderAware) bean).setResourceLoader(this.applicationContext);\n\t}\n\tif (bean instanceof ApplicationEventPublisherAware) {\n\t\t((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(this.applicationContext);\n\t}\n\tif (bean instanceof MessageSourceAware) {\n\t\t((MessageSourceAware) bean).setMessageSource(this.applicationContext);\n\t}\n    //BeanApplicationContextAwareapplicationContext\n\tif (bean instanceof ApplicationContextAware) {\n\t\t((ApplicationContextAware) bean).setApplicationContext(this.applicationContext);\n\t}\n}\n```\n\n```java\n@Component\npublic class AppUtil implements ApplicationContextAware {\n    private static ApplicationContext applicationContext;\n    @Override\n    public void setApplicationContext(ApplicationContext arg0) throws BeansException {\n        //ApplicationContextspring\n        applicationContext = arg0;\n    }\n\n    public static Object getBean(String id) {\n        Object object = null;\n        object = applicationContext.getBean(id);\n        return object;\n    }\n}\n```\n\n- EnvironmentAwareEnviromentAware \n- EmbeddedValueResolverAwareStringValueResolver StringValueResolverStringproperties@Value\n- ResourceLoaderAwareResourceLoaderResourceLoaderclasspathResourceLoader\n- ApplicationEventPublisherAwareApplicationEventPublisher\n- MessageSourceAwareMessageSourceMessageSource\n- ApplicationContextAwareApplicationContext\n\n","slug":"spring-extend","published":1,"updated":"2021-04-08T00:47:06.997Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvu003mqwv26ydf4751","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"BeanDefinitionRegistryPostProcessor\"><a href=\"#BeanDefinitionRegistryPostProcessor\" class=\"headerlink\" title=\"BeanDefinitionRegistryPostProcessor\"></a>BeanDefinitionRegistryPostProcessor</h3><p><img src=\"/2020/09/13/spring-extend/1.png\" alt></p>\n<p>BeanDefinitionbeanDefinitionBeanDefinition</p>\n<ul>\n<li>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry)beanspring</li>\n<li>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)BeanDefinition<a id=\"more\"></a>\n</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//refresh -> #invokeBeanFactoryPostProcessors() -> PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, //getBeanFactoryPostProcessors())</span>\n<span class=\"token keyword\">boolean</span> reiterate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>reiterate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    reiterate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    postProcessorNames <span class=\"token operator\">=</span> beanFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getBeanNamesForType</span><span class=\"token punctuation\">(</span>BeanDefinitionRegistryPostProcessor<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>String ppName <span class=\"token operator\">:</span> postProcessorNames<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>processedBeans<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>ppName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            currentRegistryProcessors<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span>ppName<span class=\"token punctuation\">,</span> BeanDefinitionRegistryPostProcessor<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            processedBeans<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>ppName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            reiterate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">sortPostProcessors</span><span class=\"token punctuation\">(</span>currentRegistryProcessors<span class=\"token punctuation\">,</span> beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    registryProcessors<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>currentRegistryProcessors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//postProcessBeanDefinitionRegistry</span>\n    <span class=\"token function\">invokeBeanDefinitionRegistryPostProcessors</span><span class=\"token punctuation\">(</span>currentRegistryProcessors<span class=\"token punctuation\">,</span> registry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    currentRegistryProcessors<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//postProcessBeanFactory</span>\n<span class=\"token function\">invokeBeanFactoryPostProcessors</span><span class=\"token punctuation\">(</span>registryProcessors<span class=\"token punctuation\">,</span> beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">invokeBeanFactoryPostProcessors</span><span class=\"token punctuation\">(</span>regularPostProcessors<span class=\"token punctuation\">,</span> beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h3 id=\"BeanFactoryPostProcessor\"><a href=\"#BeanFactoryPostProcessor\" class=\"headerlink\" title=\"BeanFactoryPostProcessor\"></a>BeanFactoryPostProcessor</h3><p>beanFactoryspringbeanDefinitionbeanBeanDefinitionRegistryPostProcessorpostProcessBeanFactorybeanDefinition</p>\n<h3 id=\"InstantiationAwareBeanPostProcessor\"><a href=\"#InstantiationAwareBeanPostProcessor\" class=\"headerlink\" title=\"InstantiationAwareBeanPostProcessor\"></a>InstantiationAwareBeanPostProcessor</h3><p>InstantiationAwareBeanPostProcessorBeanPostProcessBeanPostProcess<code></code><code></code><code>bean</code><code>bean</code><code></code></p>\n<p><img src=\"/2020/09/13/spring-extend/2.png\" alt=\"InstantiationAwareBeanPostProcessor\"></p>\n<ul>\n<li>postProcessBeforeInitialization </li>\n<li>postProcessAfterInitialization </li>\n<li>postProcessBeforeInstantiation </li>\n<li>postProcessAfterInstantiation </li>\n<li>postProcessProperties <strong>@Autowired,@Resource</strong></li>\n</ul>\n<p><strong>Spring@AutowiredAutowiredAnnotationBeanPostProcessor</strong></p>\n<h3 id=\"SmartInstantiationAwareBeanPostProcessor\"><a href=\"#SmartInstantiationAwareBeanPostProcessor\" class=\"headerlink\" title=\"SmartInstantiationAwareBeanPostProcessor\"></a>SmartInstantiationAwareBeanPostProcessor</h3><p>SmartInstantiationAwareBeanPostProcessor<code>InstantiationAwareBeanPostProcessor</code></p>\n<ul>\n<li>predictBeanType<code>postProcessBeforeInstantiation</code>BeanBeanFactory.getType(name)beanbean</li>\n<li>determineCandidateConstructors<code>postProcessBeforeInstantiation</code>bean</li>\n<li>getEarlyBeanReference<code>postProcessAfterInstantiation</code><strong></strong></li>\n</ul>\n<h3 id=\"MergedBeanDefinitionPostProcessor\"><a href=\"#MergedBeanDefinitionPostProcessor\" class=\"headerlink\" title=\"MergedBeanDefinitionPostProcessor\"></a>MergedBeanDefinitionPostProcessor</h3><p>AutowiredAnnotationBeanPostProcessor</p>\n<p>AutowiredAnnotationBeanPostProcessorspringbean@Autowired@ValueInjectionMetadata</p>\n<p><img src=\"/2020/09/13/spring-extend/4.png\" alt></p>\n<h3 id=\"BeanFactoryAware\"><a href=\"#BeanFactoryAware\" class=\"headerlink\" title=\"BeanFactoryAware\"></a>BeanFactoryAware</h3><p><strong>beanSetter</strong></p>\n<p>bean BeanFactorybean</p>\n<p><strong>BeanBean</strong></p>\n<h3 id=\"BeanNameAware\"><a href=\"#BeanNameAware\" class=\"headerlink\" title=\"BeanNameAware\"></a>BeanNameAware</h3><p>bean<code>postProcessBeforeInitialization</code></p>\n<p>beanspringbeanNamebeanName</p>\n<h3 id=\"InitializingBean\"><a href=\"#InitializingBean\" class=\"headerlink\" title=\"InitializingBean\"></a>InitializingBean</h3><p><code>postProcessAfterInitialization</code></p>\n<h3 id=\"DisposableBean\"><a href=\"#DisposableBean\" class=\"headerlink\" title=\"DisposableBean\"></a>DisposableBean</h3><p>applicationContext.registerShutdownHook</p>\n<h3 id=\"NamespaceHandler\"><a href=\"#NamespaceHandler\" class=\"headerlink\" title=\"NamespaceHandler\"></a>NamespaceHandler</h3><p><strong>BeanDefinitionParserBeanBeancomponent-scan</strong></p>\n<p>&lt;context:component-scan&gt;</p>\n<p><strong>spring.handlers&lt;context:NamespaceHandler</strong></p>\n<p><img src=\"/2020/09/13/spring-extend/3.png\" alt></p>\n<p>application.xmlcomponent-scanContextNamespaceHandlerinit</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ContextNamespaceHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">NamespaceHandlerSupport</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"property-placeholder\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PropertyPlaceholderBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"property-override\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PropertyOverrideBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"annotation-config\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token comment\" spellcheck=\"true\">//component-scan</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"component-scan\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ComponentScanBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load-time-weaver\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LoadTimeWeaverBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"spring-configured\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SpringConfiguredBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mbean-export\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MBeanExportBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">registerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mbean-server\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MBeanServerBeanDefinitionParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>ComponentScanBeanDefinitionParserBeanDefinition</strong></p>\n<p>registerComponents</p>\n<pre class=\" language-java\"><code class=\"language-java\">Set<span class=\"token operator\">&lt;</span>BeanDefinitionHolder<span class=\"token operator\">></span> processorDefinitions <span class=\"token operator\">=</span>\n                    AnnotationConfigUtils<span class=\"token punctuation\">.</span><span class=\"token function\">registerAnnotationConfigProcessors</span><span class=\"token punctuation\">(</span>readerContext<span class=\"token punctuation\">.</span><span class=\"token function\">getRegistry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">)</span></code></pre>\n<ul>\n<li>ConfigurationClassPostProcessor@Configuration@ComponentScan@Beanspring</li>\n<li>AutowiredAnnotationBeanPostProcessor@Autowried</li>\n<li>CommonAnnotationBeanPostProcessor@Resource@WebServiceRef@EJB</li>\n<li>EventListenerMethodProcessor</li>\n<li>DefaultEventListenerFactory</li>\n</ul>\n<h3 id=\"ApplicationContextAwareProcessor\"><a href=\"#ApplicationContextAwareProcessor\" class=\"headerlink\" title=\"ApplicationContextAwareProcessor\"></a>ApplicationContextAwareProcessor</h3><p>ApplicationContextAwareProcessorSpring6 beanApplicationContextAwareApplicationContextAwareSpringUtilsgetBean</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//ApplicationContextAwareProcessorpostProcessBeforeInitialization</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">invokeAwareInterfaces</span><span class=\"token punctuation\">(</span>Object bean<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">EnvironmentAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>EnvironmentAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">EmbeddedValueResolverAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>EmbeddedValueResolverAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setEmbeddedValueResolver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>embeddedValueResolver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ResourceLoaderAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ResourceLoaderAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setResourceLoader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>applicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ApplicationEventPublisherAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ApplicationEventPublisherAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setApplicationEventPublisher</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>applicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MessageSourceAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>MessageSourceAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setMessageSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>applicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//BeanApplicationContextAwareapplicationContext</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bean <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ApplicationContextAware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ApplicationContextAware<span class=\"token punctuation\">)</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>applicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppUtil</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ApplicationContextAware</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> ApplicationContext applicationContext<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setApplicationContext</span><span class=\"token punctuation\">(</span>ApplicationContext arg0<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> BeansException <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//ApplicationContextspring</span>\n        applicationContext <span class=\"token operator\">=</span> arg0<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> Object <span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span>String id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Object object <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n        object <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> object<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<ul>\n<li>EnvironmentAwareEnviromentAware </li>\n<li>EmbeddedValueResolverAwareStringValueResolver StringValueResolverStringproperties@Value</li>\n<li>ResourceLoaderAwareResourceLoaderResourceLoaderclasspathResourceLoader</li>\n<li>ApplicationEventPublisherAwareApplicationEventPublisher</li>\n<li>MessageSourceAwareMessageSourceMessageSource</li>\n<li>ApplicationContextAwareApplicationContext</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"BeanDefinitionRegistryPostProcessor\"><a href=\"#BeanDefinitionRegistryPostProcessor\" class=\"headerlink\" title=\"BeanDefinitionRegistryPostProcessor\"></a>BeanDefinitionRegistryPostProcessor</h3><p><img src=\"/2020/09/13/spring-extend/1.png\" alt></p>\n<p>BeanDefinitionbeanDefinitionBeanDefinition</p>\n<ul>\n<li>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry)beanspring</li>\n<li>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)BeanDefinition</li></ul>","more":"\n\n<pre><code class=\"java\">//refresh -&gt; #invokeBeanFactoryPostProcessors() -&gt; PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, //getBeanFactoryPostProcessors())\nboolean reiterate = true;\nwhile (reiterate) {\n    reiterate = false;\n    postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n    for (String ppName : postProcessorNames) {\n        if (!processedBeans.contains(ppName)) {\n            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n            processedBeans.add(ppName);\n            reiterate = true;\n        }\n    }\n    sortPostProcessors(currentRegistryProcessors, beanFactory);\n    registryProcessors.addAll(currentRegistryProcessors);\n    //postProcessBeanDefinitionRegistry\n    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n    currentRegistryProcessors.clear();\n}\n//postProcessBeanFactory\ninvokeBeanFactoryPostProcessors(registryProcessors, beanFactory);\ninvokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</code></pre>\n<h3 id=\"BeanFactoryPostProcessor\"><a href=\"#BeanFactoryPostProcessor\" class=\"headerlink\" title=\"BeanFactoryPostProcessor\"></a>BeanFactoryPostProcessor</h3><p>beanFactoryspringbeanDefinitionbeanBeanDefinitionRegistryPostProcessorpostProcessBeanFactorybeanDefinition</p>\n<h3 id=\"InstantiationAwareBeanPostProcessor\"><a href=\"#InstantiationAwareBeanPostProcessor\" class=\"headerlink\" title=\"InstantiationAwareBeanPostProcessor\"></a>InstantiationAwareBeanPostProcessor</h3><p>InstantiationAwareBeanPostProcessorBeanPostProcessBeanPostProcess<code></code><code></code><code>bean</code><code>bean</code><code></code></p>\n<p><img src=\"/2020/09/13/spring-extend/2.png\" alt=\"InstantiationAwareBeanPostProcessor\"></p>\n<ul>\n<li>postProcessBeforeInitialization </li>\n<li>postProcessAfterInitialization </li>\n<li>postProcessBeforeInstantiation </li>\n<li>postProcessAfterInstantiation </li>\n<li>postProcessProperties <strong>@Autowired,@Resource</strong></li>\n</ul>\n<p><strong>Spring@AutowiredAutowiredAnnotationBeanPostProcessor</strong></p>\n<h3 id=\"SmartInstantiationAwareBeanPostProcessor\"><a href=\"#SmartInstantiationAwareBeanPostProcessor\" class=\"headerlink\" title=\"SmartInstantiationAwareBeanPostProcessor\"></a>SmartInstantiationAwareBeanPostProcessor</h3><p>SmartInstantiationAwareBeanPostProcessor<code>InstantiationAwareBeanPostProcessor</code></p>\n<ul>\n<li>predictBeanType<code>postProcessBeforeInstantiation</code>BeanBeanFactory.getType(name)beanbean</li>\n<li>determineCandidateConstructors<code>postProcessBeforeInstantiation</code>bean</li>\n<li>getEarlyBeanReference<code>postProcessAfterInstantiation</code><strong></strong></li>\n</ul>\n<h3 id=\"MergedBeanDefinitionPostProcessor\"><a href=\"#MergedBeanDefinitionPostProcessor\" class=\"headerlink\" title=\"MergedBeanDefinitionPostProcessor\"></a>MergedBeanDefinitionPostProcessor</h3><p>AutowiredAnnotationBeanPostProcessor</p>\n<p>AutowiredAnnotationBeanPostProcessorspringbean@Autowired@ValueInjectionMetadata</p>\n<p><img src=\"/2020/09/13/spring-extend/4.png\" alt></p>\n<h3 id=\"BeanFactoryAware\"><a href=\"#BeanFactoryAware\" class=\"headerlink\" title=\"BeanFactoryAware\"></a>BeanFactoryAware</h3><p><strong>beanSetter</strong></p>\n<p>bean BeanFactorybean</p>\n<p><strong>BeanBean</strong></p>\n<h3 id=\"BeanNameAware\"><a href=\"#BeanNameAware\" class=\"headerlink\" title=\"BeanNameAware\"></a>BeanNameAware</h3><p>bean<code>postProcessBeforeInitialization</code></p>\n<p>beanspringbeanNamebeanName</p>\n<h3 id=\"InitializingBean\"><a href=\"#InitializingBean\" class=\"headerlink\" title=\"InitializingBean\"></a>InitializingBean</h3><p><code>postProcessAfterInitialization</code></p>\n<h3 id=\"DisposableBean\"><a href=\"#DisposableBean\" class=\"headerlink\" title=\"DisposableBean\"></a>DisposableBean</h3><p>applicationContext.registerShutdownHook</p>\n<h3 id=\"NamespaceHandler\"><a href=\"#NamespaceHandler\" class=\"headerlink\" title=\"NamespaceHandler\"></a>NamespaceHandler</h3><p><strong>BeanDefinitionParserBeanBeancomponent-scan</strong></p>\n<p>&lt;context:component-scan&gt;</p>\n<p><strong>spring.handlers&lt;context:NamespaceHandler</strong></p>\n<p><img src=\"/2020/09/13/spring-extend/3.png\" alt></p>\n<p>application.xmlcomponent-scanContextNamespaceHandlerinit</p>\n<pre><code class=\"java\">public class ContextNamespaceHandler extends NamespaceHandlerSupport {\n    @Override\n    public void init() {\n        registerBeanDefinitionParser(&quot;property-placeholder&quot;, new PropertyPlaceholderBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;property-override&quot;, new PropertyOverrideBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;annotation-config&quot;, new AnnotationConfigBeanDefinitionParser());\n         //component-scan\n        registerBeanDefinitionParser(&quot;component-scan&quot;, new ComponentScanBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;load-time-weaver&quot;, new LoadTimeWeaverBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;mbean-export&quot;, new MBeanExportBeanDefinitionParser());\n        registerBeanDefinitionParser(&quot;mbean-server&quot;, new MBeanServerBeanDefinitionParser());\n    }\n}</code></pre>\n<p><strong>ComponentScanBeanDefinitionParserBeanDefinition</strong></p>\n<p>registerComponents</p>\n<pre><code class=\"java\">Set&lt;BeanDefinitionHolder&gt; processorDefinitions =\n                    AnnotationConfigUtils.registerAnnotationConfigProcessors(readerContext.getRegistry(), source)</code></pre>\n<ul>\n<li>ConfigurationClassPostProcessor@Configuration@ComponentScan@Beanspring</li>\n<li>AutowiredAnnotationBeanPostProcessor@Autowried</li>\n<li>CommonAnnotationBeanPostProcessor@Resource@WebServiceRef@EJB</li>\n<li>EventListenerMethodProcessor</li>\n<li>DefaultEventListenerFactory</li>\n</ul>\n<h3 id=\"ApplicationContextAwareProcessor\"><a href=\"#ApplicationContextAwareProcessor\" class=\"headerlink\" title=\"ApplicationContextAwareProcessor\"></a>ApplicationContextAwareProcessor</h3><p>ApplicationContextAwareProcessorSpring6 beanApplicationContextAwareApplicationContextAwareSpringUtilsgetBean</p>\n<pre><code class=\"java\">//ApplicationContextAwareProcessorpostProcessBeforeInitialization\nprivate void invokeAwareInterfaces(Object bean) {\n    if (bean instanceof EnvironmentAware) {\n        ((EnvironmentAware) bean).setEnvironment(this.applicationContext.getEnvironment());\n    }\n    if (bean instanceof EmbeddedValueResolverAware) {\n        ((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(this.embeddedValueResolver);\n    }\n    if (bean instanceof ResourceLoaderAware) {\n        ((ResourceLoaderAware) bean).setResourceLoader(this.applicationContext);\n    }\n    if (bean instanceof ApplicationEventPublisherAware) {\n        ((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(this.applicationContext);\n    }\n    if (bean instanceof MessageSourceAware) {\n        ((MessageSourceAware) bean).setMessageSource(this.applicationContext);\n    }\n    //BeanApplicationContextAwareapplicationContext\n    if (bean instanceof ApplicationContextAware) {\n        ((ApplicationContextAware) bean).setApplicationContext(this.applicationContext);\n    }\n}</code></pre>\n<pre><code class=\"java\">@Component\npublic class AppUtil implements ApplicationContextAware {\n    private static ApplicationContext applicationContext;\n    @Override\n    public void setApplicationContext(ApplicationContext arg0) throws BeansException {\n        //ApplicationContextspring\n        applicationContext = arg0;\n    }\n\n    public static Object getBean(String id) {\n        Object object = null;\n        object = applicationContext.getBean(id);\n        return object;\n    }\n}</code></pre>\n<ul>\n<li>EnvironmentAwareEnviromentAware </li>\n<li>EmbeddedValueResolverAwareStringValueResolver StringValueResolverStringproperties@Value</li>\n<li>ResourceLoaderAwareResourceLoaderResourceLoaderclasspathResourceLoader</li>\n<li>ApplicationEventPublisherAwareApplicationEventPublisher</li>\n<li>MessageSourceAwareMessageSourceMessageSource</li>\n<li>ApplicationContextAwareApplicationContext</li>\n</ul>"},{"title":"Spring","description":"Spring","date":"2020-05-10T05:42:51.000Z","_content":"\n### \n\nA  BB  A A  BB  CC  A\n\n![](spring-forbean/1.png)\n<!--more-->\n**Spring**\n\n```xml\n<!--src\\main\\resources\\applicationContext.xml-->\n<bean id=\"beanB\" class=\"com.xzy.bean.BeanB\">\n    <property name=\"param1\" value=\"param1\"/>\n    <property name=\"param2\" value=\"param2\"/>\n    <property name=\"beanC\" ref=\"beanC\"/>\n</bean>\n<bean id=\"beanC\" class=\"com.xzy.bean.BeanC\">\n    <property name=\"param1\" value=\"param1\"/>\n    <property name=\"param2\" value=\"param2\"/>\n    <property name=\"beanB\" ref=\"beanB\"/>\n</bean>\n```\n\n```java\n@Test\npublic void testFor(){\n    ClassPathResource resource = new ClassPathResource(\"applicationContext.xml\");\n    DefaultListableBeanFactory factory = new DefaultListableBeanFactory();\n    XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);\n    //\n    reader.loadBeanDefinitions(resource);\n    BeanB bean = factory.getBean(BeanB.class);\n    System.out.println(bean);\n}\n```\n\n### \n\nSpringgetBean()beanbean\n\n1. Beandefinitionbean\n2. bean\n3. bean\n4. bean\n5. bean\n\nABBBBA\n\n### Spring\n\nSpring \"\" A EarlyBeanReference B  A B B  A  B \n\n### \n\n#### **Bean **\n\nSpring IOCbean\n\n<img src=\"spring-forbean\\2.png\" style=\"zoom:50%;\" />\n\n1.  `getBean` `getBean`  `doGetBean` \n2. `transformedBeanName` name beanNamename FactoryBean  & \n3.  `getSingleton(beanName)`  Spring  bean\n4. sharedInstance  bean bean `getObjectForBeanInstance` \n5. sharedInstancenull bean \n\n#### ****\n\ngetBean****spring\n\n```java\n//org.springframework.beans.factory.support.DefaultSingletonBeanRegistry\nprivate final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);\nprivate final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);\nprivate final Map<String, Object> earlySingletonObjects = new HashMap<>(16);\n```\n\n\n\n- singletonObjectscachebean**->->**\n- earlySingletonObjectsbean****bean\n- singletonFactoriesbeanSpringbeanbean`beanFactory``singletonFactories`\n\n#### **Bean**\n\n![](spring-forbean/3.png)\n\n****\n\n```java\n\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\nsharedInstance = getSingleton(beanName, () -> {\n\ttry {\n\t\treturn createBean(beanName, mbd, args);\n\t}\n\tcatch (BeansException ex) {\n\t\t//Bean\n\t\tdestroySingleton(beanName);\n\t\tthrow ex;\n\t}\n});\n\npublic Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {\n\tAssert.notNull(beanName, \"Bean name must not be null\");\n\tsynchronized (this.singletonObjects) {\n\t\tObject singletonObject = this.singletonObjects.get(beanName);\n\t\tif (singletonObject == null) {\n\t\t\t//bean  createBean(beanName, mbd, args)\n\t\t\tsingletonObject = singletonFactory.getObject();\n\t\t\tnewSingleton = true;\n\t\t\tif (newSingleton) {\n\t\t\t\t//bean\n\t\t\t\taddSingleton(beanName, singletonObject);\n\n\t\t\t}\n\t\t}\n\t\treturn singletonObject;\n\t}\n}\n//BeanBeanBean\nprotected void addSingleton(String beanName, Object singletonObject) {\n\tsynchronized (this.singletonObjects) {\n\t\tthis.singletonObjects.put(beanName, singletonObject);\n\t\tthis.singletonFactories.remove(beanName);\n\t\tthis.earlySingletonObjects.remove(beanName);\n\t\tthis.registeredSingletons.add(beanName);\n\t}\n}\n\n@Override\nprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)\n\t\tthrows BeanCreationException {\n\tObject beanInstance = doCreateBean(beanName, mbdToUse, args);\n\treturn beanInstance;\n}\n\nprotected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\n\t\tthrows BeanCreationException {\n\tBeanWrapper instanceWrapper = null;\n\tif (instanceWrapper == null) {\n\t\t//Bean\n\t\tinstanceWrapper = createBeanInstance(beanName, mbd, args);\n\t}\n\tboolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&\n\t\t\tisSingletonCurrentlyInCreation(beanName));\n\tif (earlySingletonExposure) {\n\t\t//\n\t\taddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\n\t}\n\tObject exposedObject = bean;\n\t//\n\tpopulateBean(beanName, mbd, instanceWrapper);\n\t//\n\texposedObject = initializeBean(beanName, exposedObject, mbd);\n  \t// \n\tif (earlySingletonExposure) {\n\t    // falsegetObject() \n\t    // exposedObject  returnaddSingleton()  \n\t    //  \n\t    Object earlySingletonReference = getSingleton(beanName, false);\n\t    if (earlySingletonReference != null) {\n\t        if (exposedObject == bean) { \n\t            exposedObject = earlySingletonReference;\n\t        }\n\t    }\n\t}\n\treturn exposedObject;\n}\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n\tObject exposedObject = bean;\n\tif (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {\n\t\tfor (BeanPostProcessor bp : getBeanPostProcessors()) {\n\t\t\tif (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n\t\t\t\tSmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n\t\t\t\texposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n\t\t\t}\n\t\t}\n\t}\n\treturn exposedObject;\n}\n```\n\nBean\n\n1. `getSingleton`BeanBean`createBean`Bean\n2. `createBeanInstance`Bean`getEarlyBeanReference`\n3.  `populateBean`  bean **ABBAgetBean(A)beanAABgetObject()bean**\n4.  `addSingleton` bean singletonObjects \n\n#### ****\n\n![](spring-forbean/4.png)\n\nbeanAbeanBbeanBbeanBbeanAbeanAbeanBbeanB\n\n#### ****\n\nbean\n\n```java\n//bean\naddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n\tObject exposedObject = bean;\n\tif (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {\n\t\tfor (BeanPostProcessor bp : getBeanPostProcessors()) {\n\t\t\tif (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n                 // bean\n                 // getEarlyBeanReferencebean\n                 // !!!\n                 // \n\t\t\t\tSmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n\t\t\t\texposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n\t\t\t}\n\t\t}\n\t}\n\treturn exposedObject;\n}\n```\n\n Spring  AOP  if  exposedObject\n\n**SmartInstantiationAwareBeanPostProcessor**SpringAOP **Spring AOP******\n\n![](spring-forbean/5.png)\n\nbeanAAOPbeanBAA`singletonFactory.getObject()`\n\n** | **\n\nABAAOP3721BeanAOPSpringAOPBean\n\nSpringObjectFactorygetObject()SmartInstantiationAwareBeanPostProcessorgetEarlyBeanReferencebeanSpringbeanbeanbean\n\n### \n\n- https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&groupCode=microservice\n\n\n\n","source":"_posts/spring-forbean.md","raw":"---\ntitle: Spring\ntags:\n  - spring\ncategories: \n  - spring\ndescription : Spring\ndate: 2020-05-10 13:42:51\n---\n\n### \n\nA  BB  A A  BB  CC  A\n\n![](spring-forbean/1.png)\n<!--more-->\n**Spring**\n\n```xml\n<!--src\\main\\resources\\applicationContext.xml-->\n<bean id=\"beanB\" class=\"com.xzy.bean.BeanB\">\n    <property name=\"param1\" value=\"param1\"/>\n    <property name=\"param2\" value=\"param2\"/>\n    <property name=\"beanC\" ref=\"beanC\"/>\n</bean>\n<bean id=\"beanC\" class=\"com.xzy.bean.BeanC\">\n    <property name=\"param1\" value=\"param1\"/>\n    <property name=\"param2\" value=\"param2\"/>\n    <property name=\"beanB\" ref=\"beanB\"/>\n</bean>\n```\n\n```java\n@Test\npublic void testFor(){\n    ClassPathResource resource = new ClassPathResource(\"applicationContext.xml\");\n    DefaultListableBeanFactory factory = new DefaultListableBeanFactory();\n    XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);\n    //\n    reader.loadBeanDefinitions(resource);\n    BeanB bean = factory.getBean(BeanB.class);\n    System.out.println(bean);\n}\n```\n\n### \n\nSpringgetBean()beanbean\n\n1. Beandefinitionbean\n2. bean\n3. bean\n4. bean\n5. bean\n\nABBBBA\n\n### Spring\n\nSpring \"\" A EarlyBeanReference B  A B B  A  B \n\n### \n\n#### **Bean **\n\nSpring IOCbean\n\n<img src=\"spring-forbean\\2.png\" style=\"zoom:50%;\" />\n\n1.  `getBean` `getBean`  `doGetBean` \n2. `transformedBeanName` name beanNamename FactoryBean  & \n3.  `getSingleton(beanName)`  Spring  bean\n4. sharedInstance  bean bean `getObjectForBeanInstance` \n5. sharedInstancenull bean \n\n#### ****\n\ngetBean****spring\n\n```java\n//org.springframework.beans.factory.support.DefaultSingletonBeanRegistry\nprivate final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);\nprivate final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);\nprivate final Map<String, Object> earlySingletonObjects = new HashMap<>(16);\n```\n\n\n\n- singletonObjectscachebean**->->**\n- earlySingletonObjectsbean****bean\n- singletonFactoriesbeanSpringbeanbean`beanFactory``singletonFactories`\n\n#### **Bean**\n\n![](spring-forbean/3.png)\n\n****\n\n```java\n\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\nsharedInstance = getSingleton(beanName, () -> {\n\ttry {\n\t\treturn createBean(beanName, mbd, args);\n\t}\n\tcatch (BeansException ex) {\n\t\t//Bean\n\t\tdestroySingleton(beanName);\n\t\tthrow ex;\n\t}\n});\n\npublic Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {\n\tAssert.notNull(beanName, \"Bean name must not be null\");\n\tsynchronized (this.singletonObjects) {\n\t\tObject singletonObject = this.singletonObjects.get(beanName);\n\t\tif (singletonObject == null) {\n\t\t\t//bean  createBean(beanName, mbd, args)\n\t\t\tsingletonObject = singletonFactory.getObject();\n\t\t\tnewSingleton = true;\n\t\t\tif (newSingleton) {\n\t\t\t\t//bean\n\t\t\t\taddSingleton(beanName, singletonObject);\n\n\t\t\t}\n\t\t}\n\t\treturn singletonObject;\n\t}\n}\n//BeanBeanBean\nprotected void addSingleton(String beanName, Object singletonObject) {\n\tsynchronized (this.singletonObjects) {\n\t\tthis.singletonObjects.put(beanName, singletonObject);\n\t\tthis.singletonFactories.remove(beanName);\n\t\tthis.earlySingletonObjects.remove(beanName);\n\t\tthis.registeredSingletons.add(beanName);\n\t}\n}\n\n@Override\nprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)\n\t\tthrows BeanCreationException {\n\tObject beanInstance = doCreateBean(beanName, mbdToUse, args);\n\treturn beanInstance;\n}\n\nprotected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\n\t\tthrows BeanCreationException {\n\tBeanWrapper instanceWrapper = null;\n\tif (instanceWrapper == null) {\n\t\t//Bean\n\t\tinstanceWrapper = createBeanInstance(beanName, mbd, args);\n\t}\n\tboolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&\n\t\t\tisSingletonCurrentlyInCreation(beanName));\n\tif (earlySingletonExposure) {\n\t\t//\n\t\taddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\n\t}\n\tObject exposedObject = bean;\n\t//\n\tpopulateBean(beanName, mbd, instanceWrapper);\n\t//\n\texposedObject = initializeBean(beanName, exposedObject, mbd);\n  \t// \n\tif (earlySingletonExposure) {\n\t    // falsegetObject() \n\t    // exposedObject  returnaddSingleton()  \n\t    //  \n\t    Object earlySingletonReference = getSingleton(beanName, false);\n\t    if (earlySingletonReference != null) {\n\t        if (exposedObject == bean) { \n\t            exposedObject = earlySingletonReference;\n\t        }\n\t    }\n\t}\n\treturn exposedObject;\n}\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n\tObject exposedObject = bean;\n\tif (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {\n\t\tfor (BeanPostProcessor bp : getBeanPostProcessors()) {\n\t\t\tif (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n\t\t\t\tSmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n\t\t\t\texposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n\t\t\t}\n\t\t}\n\t}\n\treturn exposedObject;\n}\n```\n\nBean\n\n1. `getSingleton`BeanBean`createBean`Bean\n2. `createBeanInstance`Bean`getEarlyBeanReference`\n3.  `populateBean`  bean **ABBAgetBean(A)beanAABgetObject()bean**\n4.  `addSingleton` bean singletonObjects \n\n#### ****\n\n![](spring-forbean/4.png)\n\nbeanAbeanBbeanBbeanBbeanAbeanAbeanBbeanB\n\n#### ****\n\nbean\n\n```java\n//bean\naddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n\tObject exposedObject = bean;\n\tif (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {\n\t\tfor (BeanPostProcessor bp : getBeanPostProcessors()) {\n\t\t\tif (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n                 // bean\n                 // getEarlyBeanReferencebean\n                 // !!!\n                 // \n\t\t\t\tSmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n\t\t\t\texposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n\t\t\t}\n\t\t}\n\t}\n\treturn exposedObject;\n}\n```\n\n Spring  AOP  if  exposedObject\n\n**SmartInstantiationAwareBeanPostProcessor**SpringAOP **Spring AOP******\n\n![](spring-forbean/5.png)\n\nbeanAAOPbeanBAA`singletonFactory.getObject()`\n\n** | **\n\nABAAOP3721BeanAOPSpringAOPBean\n\nSpringObjectFactorygetObject()SmartInstantiationAwareBeanPostProcessorgetEarlyBeanReferencebeanSpringbeanbeanbean\n\n### \n\n- https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&groupCode=microservice\n\n\n\n","slug":"spring-forbean","published":1,"updated":"2021-04-08T00:47:07.007Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvv003qqwv2c6353vtk","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>A  BB  A A  BB  CC  A</p>\n<p><img src=\"/2020/05/10/spring-forbean/1.png\" alt></p>\n<a id=\"more\"></a>\n<p><strong>Spring</strong></p>\n<pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token comment\" spellcheck=\"true\">&lt;!--src\\main\\resources\\applicationContext.xml--></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>bean</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanB<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>com.xzy.bean.BeanB<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanC<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanC<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>bean</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>bean</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanC<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>com.xzy.bean.BeanC<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>param2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanB<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>beanB<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>bean</span><span class=\"token punctuation\">></span></span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testFor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    ClassPathResource resource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"applicationContext.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    DefaultListableBeanFactory factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultListableBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    XmlBeanDefinitionReader reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XmlBeanDefinitionReader</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    reader<span class=\"token punctuation\">.</span><span class=\"token function\">loadBeanDefinitions</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    BeanB bean <span class=\"token operator\">=</span> factory<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span>BeanB<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SpringgetBean()beanbean</p>\n<ol>\n<li>Beandefinitionbean</li>\n<li>bean</li>\n<li>bean</li>\n<li>bean</li>\n<li>bean</li>\n</ol>\n<p>ABBBBA</p>\n<h3 id=\"Spring\"><a href=\"#Spring\" class=\"headerlink\" title=\"Spring\"></a>Spring</h3><p>Spring  A EarlyBeanReference B  A B B  A  B </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Bean-\"><a href=\"#Bean-\" class=\"headerlink\" title=\"Bean \"></a><strong>Bean </strong></h4><p>Spring IOCbean</p>\n<img src=\"/2020/05/10/spring-forbean/2.png\" style=\"zoom:50%;\">\n\n<ol>\n<li> <code>getBean</code> <code>getBean</code>  <code>doGetBean</code> </li>\n<li><code>transformedBeanName</code> name beanNamename FactoryBean  &amp; </li>\n<li> <code>getSingleton(beanName)</code>  Spring  bean</li>\n<li>sharedInstance  bean bean <code>getObjectForBeanInstance</code> </li>\n<li>sharedInstancenull bean </li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>getBean<strong></strong>spring</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//org.springframework.beans.factory.support.DefaultSingletonBeanRegistry</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> singletonObjects <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> ObjectFactory<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">>></span> singletonFactories <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> earlySingletonObjects <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p></p>\n<ul>\n<li>singletonObjectscachebean<strong>-&gt;-&gt;</strong></li>\n<li>earlySingletonObjectsbean<strong></strong>bean</li>\n<li>singletonFactoriesbeanSpringbeanbean<code>beanFactory</code><code>singletonFactories</code></li>\n</ul>\n<h4 id=\"Bean\"><a href=\"#Bean\" class=\"headerlink\" title=\"Bean\"></a><strong>Bean</strong></h4><p><img src=\"/2020/05/10/spring-forbean/3.png\" alt></p>\n<p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\">\n<span class=\"token comment\" spellcheck=\"true\">//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span>\nsharedInstance <span class=\"token operator\">=</span> <span class=\"token function\">getSingleton</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">createBean</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BeansException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//Bean</span>\n        <span class=\"token function\">destroySingleton</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> ex<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> Object <span class=\"token function\">getSingleton</span><span class=\"token punctuation\">(</span>String beanName<span class=\"token punctuation\">,</span> ObjectFactory<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> singletonFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Assert<span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bean name must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>singletonObjects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Object singletonObject <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>singletonObjects<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>singletonObject <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//bean  createBean(beanName, mbd, args)</span>\n            singletonObject <span class=\"token operator\">=</span> singletonFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            newSingleton <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newSingleton<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//bean</span>\n                <span class=\"token function\">addSingleton</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> singletonObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> singletonObject<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//BeanBeanBean</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addSingleton</span><span class=\"token punctuation\">(</span>String beanName<span class=\"token punctuation\">,</span> Object singletonObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>singletonObjects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>singletonObjects<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> singletonObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>singletonFactories<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>earlySingletonObjects<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>registeredSingletons<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">protected</span> Object <span class=\"token function\">createBean</span><span class=\"token punctuation\">(</span>String beanName<span class=\"token punctuation\">,</span> RootBeanDefinition mbd<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throws</span> BeanCreationException <span class=\"token punctuation\">{</span>\n    Object beanInstance <span class=\"token operator\">=</span> <span class=\"token function\">doCreateBean</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbdToUse<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> beanInstance<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">protected</span> Object <span class=\"token function\">doCreateBean</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> String beanName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> RootBeanDefinition mbd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token annotation punctuation\">@Nullable</span> Object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throws</span> BeanCreationException <span class=\"token punctuation\">{</span>\n    BeanWrapper instanceWrapper <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instanceWrapper <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//Bean</span>\n        instanceWrapper <span class=\"token operator\">=</span> <span class=\"token function\">createBeanInstance</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">boolean</span> earlySingletonExposure <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>mbd<span class=\"token punctuation\">.</span><span class=\"token function\">isSingleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>allowCircularReferences <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token function\">isSingletonCurrentlyInCreation</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>earlySingletonExposure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token function\">addSingletonFactory</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">,</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    Object exposedObject <span class=\"token operator\">=</span> bean<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">populateBean</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">,</span> instanceWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    exposedObject <span class=\"token operator\">=</span> <span class=\"token function\">initializeBean</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> exposedObject<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\" spellcheck=\"true\">// </span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>earlySingletonExposure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">// falsegetObject() </span>\n        <span class=\"token comment\" spellcheck=\"true\">// exposedObject  returnaddSingleton()  </span>\n        <span class=\"token comment\" spellcheck=\"true\">//  </span>\n        Object earlySingletonReference <span class=\"token operator\">=</span> <span class=\"token function\">getSingleton</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>earlySingletonReference <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exposedObject <span class=\"token operator\">==</span> bean<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n                exposedObject <span class=\"token operator\">=</span> earlySingletonReference<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> exposedObject<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">protected</span> Object <span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>String beanName<span class=\"token punctuation\">,</span> RootBeanDefinition mbd<span class=\"token punctuation\">,</span> Object bean<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Object exposedObject <span class=\"token operator\">=</span> bean<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mbd<span class=\"token punctuation\">.</span><span class=\"token function\">isSynthetic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">hasInstantiationAwareBeanPostProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>BeanPostProcessor bp <span class=\"token operator\">:</span> <span class=\"token function\">getBeanPostProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bp <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">SmartInstantiationAwareBeanPostProcessor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                SmartInstantiationAwareBeanPostProcessor ibp <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SmartInstantiationAwareBeanPostProcessor<span class=\"token punctuation\">)</span> bp<span class=\"token punctuation\">;</span>\n                exposedObject <span class=\"token operator\">=</span> ibp<span class=\"token punctuation\">.</span><span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>exposedObject<span class=\"token punctuation\">,</span> beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> exposedObject<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Bean</p>\n<ol>\n<li><code>getSingleton</code>BeanBean<code>createBean</code>Bean</li>\n<li><code>createBeanInstance</code>Bean<code>getEarlyBeanReference</code></li>\n<li> <code>populateBean</code>  bean <strong>ABBAgetBean(A)beanAABgetObject()bean</strong></li>\n<li> <code>addSingleton</code> bean singletonObjects </li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p><img src=\"/2020/05/10/spring-forbean/4.png\" alt></p>\n<p>beanAbeanBbeanBbeanBbeanAbeanAbeanBbeanB</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>bean</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//bean</span>\n<span class=\"token function\">addSingletonFactory</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> mbd<span class=\"token punctuation\">,</span> bean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">protected</span> Object <span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>String beanName<span class=\"token punctuation\">,</span> RootBeanDefinition mbd<span class=\"token punctuation\">,</span> Object bean<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Object exposedObject <span class=\"token operator\">=</span> bean<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mbd<span class=\"token punctuation\">.</span><span class=\"token function\">isSynthetic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">hasInstantiationAwareBeanPostProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>BeanPostProcessor bp <span class=\"token operator\">:</span> <span class=\"token function\">getBeanPostProcessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bp <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">SmartInstantiationAwareBeanPostProcessor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                 <span class=\"token comment\" spellcheck=\"true\">// bean</span>\n                 <span class=\"token comment\" spellcheck=\"true\">// getEarlyBeanReferencebean</span>\n                 <span class=\"token comment\" spellcheck=\"true\">// !!!</span>\n                 <span class=\"token comment\" spellcheck=\"true\">// </span>\n                SmartInstantiationAwareBeanPostProcessor ibp <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SmartInstantiationAwareBeanPostProcessor<span class=\"token punctuation\">)</span> bp<span class=\"token punctuation\">;</span>\n                exposedObject <span class=\"token operator\">=</span> ibp<span class=\"token punctuation\">.</span><span class=\"token function\">getEarlyBeanReference</span><span class=\"token punctuation\">(</span>exposedObject<span class=\"token punctuation\">,</span> beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> exposedObject<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p> Spring  AOP  if  exposedObject</p>\n<p><strong>SmartInstantiationAwareBeanPostProcessor</strong>SpringAOP <strong>Spring AOP</strong><strong></strong></p>\n<p><img src=\"/2020/05/10/spring-forbean/5.png\" alt></p>\n<p>beanAAOPbeanBAA<code>singletonFactory.getObject()</code></p>\n<p><strong> | </strong></p>\n<p>ABAAOP3721BeanAOPSpringAOPBean</p>\n<p>SpringObjectFactorygetObject()SmartInstantiationAwareBeanPostProcessorgetEarlyBeanReferencebeanSpringbeanbeanbean</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><a href=\"https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&amp;groupCode=microservice\" target=\"_blank\" rel=\"noopener\">https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&amp;groupCode=microservice</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>A  BB  A A  BB  CC  A</p>\n<p><img src=\"/2020/05/10/spring-forbean/1.png\" alt></p>","more":"<p><strong>Spring</strong></p>\n<pre><code class=\"xml\">&lt;!--src\\main\\resources\\applicationContext.xml--&gt;\n&lt;bean id=&quot;beanB&quot; class=&quot;com.xzy.bean.BeanB&quot;&gt;\n    &lt;property name=&quot;param1&quot; value=&quot;param1&quot;/&gt;\n    &lt;property name=&quot;param2&quot; value=&quot;param2&quot;/&gt;\n    &lt;property name=&quot;beanC&quot; ref=&quot;beanC&quot;/&gt;\n&lt;/bean&gt;\n&lt;bean id=&quot;beanC&quot; class=&quot;com.xzy.bean.BeanC&quot;&gt;\n    &lt;property name=&quot;param1&quot; value=&quot;param1&quot;/&gt;\n    &lt;property name=&quot;param2&quot; value=&quot;param2&quot;/&gt;\n    &lt;property name=&quot;beanB&quot; ref=&quot;beanB&quot;/&gt;\n&lt;/bean&gt;</code></pre>\n<pre><code class=\"java\">@Test\npublic void testFor(){\n    ClassPathResource resource = new ClassPathResource(&quot;applicationContext.xml&quot;);\n    DefaultListableBeanFactory factory = new DefaultListableBeanFactory();\n    XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);\n    //\n    reader.loadBeanDefinitions(resource);\n    BeanB bean = factory.getBean(BeanB.class);\n    System.out.println(bean);\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SpringgetBean()beanbean</p>\n<ol>\n<li>Beandefinitionbean</li>\n<li>bean</li>\n<li>bean</li>\n<li>bean</li>\n<li>bean</li>\n</ol>\n<p>ABBBBA</p>\n<h3 id=\"Spring\"><a href=\"#Spring\" class=\"headerlink\" title=\"Spring\"></a>Spring</h3><p>Spring  A EarlyBeanReference B  A B B  A  B </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Bean-\"><a href=\"#Bean-\" class=\"headerlink\" title=\"Bean \"></a><strong>Bean </strong></h4><p>Spring IOCbean</p>\n<img src=\"/2020/05/10/spring-forbean/2.png\" style=\"zoom:50%;\">\n\n<ol>\n<li> <code>getBean</code> <code>getBean</code>  <code>doGetBean</code> </li>\n<li><code>transformedBeanName</code> name beanNamename FactoryBean  &amp; </li>\n<li> <code>getSingleton(beanName)</code>  Spring  bean</li>\n<li>sharedInstance  bean bean <code>getObjectForBeanInstance</code> </li>\n<li>sharedInstancenull bean </li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>getBean<strong></strong>spring</p>\n<pre><code class=\"java\">//org.springframework.beans.factory.support.DefaultSingletonBeanRegistry\nprivate final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);\nprivate final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);\nprivate final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16);</code></pre>\n<p></p>\n<ul>\n<li>singletonObjectscachebean<strong>-&gt;-&gt;</strong></li>\n<li>earlySingletonObjectsbean<strong></strong>bean</li>\n<li>singletonFactoriesbeanSpringbeanbean<code>beanFactory</code><code>singletonFactories</code></li>\n</ul>\n<h4 id=\"Bean\"><a href=\"#Bean\" class=\"headerlink\" title=\"Bean\"></a><strong>Bean</strong></h4><p><img src=\"/2020/05/10/spring-forbean/3.png\" alt></p>\n<p><strong></strong></p>\n<pre><code class=\"java\">\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\nsharedInstance = getSingleton(beanName, () -&gt; {\n    try {\n        return createBean(beanName, mbd, args);\n    }\n    catch (BeansException ex) {\n        //Bean\n        destroySingleton(beanName);\n        throw ex;\n    }\n});\n\npublic Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {\n    Assert.notNull(beanName, &quot;Bean name must not be null&quot;);\n    synchronized (this.singletonObjects) {\n        Object singletonObject = this.singletonObjects.get(beanName);\n        if (singletonObject == null) {\n            //bean  createBean(beanName, mbd, args)\n            singletonObject = singletonFactory.getObject();\n            newSingleton = true;\n            if (newSingleton) {\n                //bean\n                addSingleton(beanName, singletonObject);\n\n            }\n        }\n        return singletonObject;\n    }\n}\n//BeanBeanBean\nprotected void addSingleton(String beanName, Object singletonObject) {\n    synchronized (this.singletonObjects) {\n        this.singletonObjects.put(beanName, singletonObject);\n        this.singletonFactories.remove(beanName);\n        this.earlySingletonObjects.remove(beanName);\n        this.registeredSingletons.add(beanName);\n    }\n}\n\n@Override\nprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)\n        throws BeanCreationException {\n    Object beanInstance = doCreateBean(beanName, mbdToUse, args);\n    return beanInstance;\n}\n\nprotected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\n        throws BeanCreationException {\n    BeanWrapper instanceWrapper = null;\n    if (instanceWrapper == null) {\n        //Bean\n        instanceWrapper = createBeanInstance(beanName, mbd, args);\n    }\n    boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;\n            isSingletonCurrentlyInCreation(beanName));\n    if (earlySingletonExposure) {\n        //\n        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));\n    }\n    Object exposedObject = bean;\n    //\n    populateBean(beanName, mbd, instanceWrapper);\n    //\n    exposedObject = initializeBean(beanName, exposedObject, mbd);\n      // \n    if (earlySingletonExposure) {\n        // falsegetObject() \n        // exposedObject  returnaddSingleton()  \n        //  \n        Object earlySingletonReference = getSingleton(beanName, false);\n        if (earlySingletonReference != null) {\n            if (exposedObject == bean) { \n                exposedObject = earlySingletonReference;\n            }\n        }\n    }\n    return exposedObject;\n}\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n    Object exposedObject = bean;\n    if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {\n        for (BeanPostProcessor bp : getBeanPostProcessors()) {\n            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n                SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n            }\n        }\n    }\n    return exposedObject;\n}</code></pre>\n<p>Bean</p>\n<ol>\n<li><code>getSingleton</code>BeanBean<code>createBean</code>Bean</li>\n<li><code>createBeanInstance</code>Bean<code>getEarlyBeanReference</code></li>\n<li> <code>populateBean</code>  bean <strong>ABBAgetBean(A)beanAABgetObject()bean</strong></li>\n<li> <code>addSingleton</code> bean singletonObjects </li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p><img src=\"/2020/05/10/spring-forbean/4.png\" alt></p>\n<p>beanAbeanBbeanBbeanBbeanAbeanAbeanBbeanB</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>bean</p>\n<pre><code class=\"java\">//bean\naddSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));\n\nprotected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n    Object exposedObject = bean;\n    if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {\n        for (BeanPostProcessor bp : getBeanPostProcessors()) {\n            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n                 // bean\n                 // getEarlyBeanReferencebean\n                 // !!!\n                 // \n                SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;\n                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n            }\n        }\n    }\n    return exposedObject;\n}</code></pre>\n<p> Spring  AOP  if  exposedObject</p>\n<p><strong>SmartInstantiationAwareBeanPostProcessor</strong>SpringAOP <strong>Spring AOP</strong><strong></strong></p>\n<p><img src=\"/2020/05/10/spring-forbean/5.png\" alt></p>\n<p>beanAAOPbeanBAA<code>singletonFactory.getObject()</code></p>\n<p><strong> | </strong></p>\n<p>ABAAOP3721BeanAOPSpringAOPBean</p>\n<p>SpringObjectFactorygetObject()SmartInstantiationAwareBeanPostProcessorgetEarlyBeanReferencebeanSpringbeanbeanbean</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><a href=\"https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&amp;groupCode=microservice\" target=\"_blank\" rel=\"noopener\">https://developer.aliyun.com/article/771925?spm=a2c6h.12873581.0.0.322f2fb1GfswWI&amp;groupCode=microservice</a></li>\n</ul>"},{"title":"ShardingPhere","description":"ShardingPhere","date":"2021-02-02T08:43:15.000Z","_content":"\n### **1shardingphere**\n\nshardingphereshardingphere\n\n**shardingjdbc**\n\nshardingjdbc\n\n**shardingjdbc**\n<!--more-->\n + (user)\n\n- 4%4\n- 12\n- \n\n 44 * 1212 * 3= 144 100````\n\n```java\nio.shardingsphere.core.metadata.table.executor.TableMetaDataLoader\n```\n\n ![](shardingphere-problem/1.png)\n\n****\n\nshardingPhere\n\n- shardingpherejar\n- tomcattomcatTableMetaDataLoader\n\n\n\n![](shardingphere-problem/2.png)\n\n### **1SQL**\n\nMySQLSQL`time`\n\n```java\nSELECT ID,USERNAME .... FROM USER where time = '20200802'\n```\n\n**timeMySQLsharding**\n\n****\n\n- time\n- time\\`\\`\n\n```\nSELECT ID,USERNAME .... FROM USER where `time` = '20200802'\n```\n\n","source":"_posts/shardingphere-problem.md","raw":"---\ntitle: ShardingPhere\ntags:\n  - shardingjdbc\ncategories: \n  - shardingjdbc\ndescription : ShardingPhere\ndate: 2021-02-02 16:43:15\n---\n\n### **1shardingphere**\n\nshardingphereshardingphere\n\n**shardingjdbc**\n\nshardingjdbc\n\n**shardingjdbc**\n<!--more-->\n + (user)\n\n- 4%4\n- 12\n- \n\n 44 * 1212 * 3= 144 100````\n\n```java\nio.shardingsphere.core.metadata.table.executor.TableMetaDataLoader\n```\n\n ![](shardingphere-problem/1.png)\n\n****\n\nshardingPhere\n\n- shardingpherejar\n- tomcattomcatTableMetaDataLoader\n\n\n\n![](shardingphere-problem/2.png)\n\n### **1SQL**\n\nMySQLSQL`time`\n\n```java\nSELECT ID,USERNAME .... FROM USER where time = '20200802'\n```\n\n**timeMySQLsharding**\n\n****\n\n- time\n- time\\`\\`\n\n```\nSELECT ID,USERNAME .... FROM USER where `time` = '20200802'\n```\n\n","slug":"shardingphere-problem","published":1,"updated":"2021-04-08T00:47:06.987Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvw003tqwv2c41fb2zf","content":"<h3 id=\"1shardingphere\"><a href=\"#1shardingphere\" class=\"headerlink\" title=\"1shardingphere\"></a><strong>1shardingphere</strong></h3><p>shardingphereshardingphere</p>\n<p><strong>shardingjdbc</strong></p>\n<p>shardingjdbc</p>\n<p><strong>shardingjdbc</strong></p>\n<a id=\"more\"></a>\n<p> + (user)</p>\n<ul>\n<li>4%4</li>\n<li>12</li>\n<li></li>\n</ul>\n<p> 44 * 1212 * 3= 144 100<code></code><code></code></p>\n<pre class=\" language-java\"><code class=\"language-java\">io<span class=\"token punctuation\">.</span>shardingsphere<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>table<span class=\"token punctuation\">.</span>executor<span class=\"token punctuation\">.</span>TableMetaDataLoader</code></pre>\n<p> <img src=\"/2021/02/02/shardingphere-problem/1.png\" alt></p>\n<p><strong></strong></p>\n<p>shardingPhere</p>\n<ul>\n<li>shardingpherejar</li>\n<li>tomcattomcatTableMetaDataLoader</li>\n</ul>\n<p></p>\n<p><img src=\"/2021/02/02/shardingphere-problem/2.png\" alt></p>\n<h3 id=\"1SQL\"><a href=\"#1SQL\" class=\"headerlink\" title=\"1SQL\"></a><strong>1SQL</strong></h3><p>MySQLSQL<code>time</code></p>\n<pre class=\" language-java\"><code class=\"language-java\">SELECT ID<span class=\"token punctuation\">,</span>USERNAME <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> FROM USER where time <span class=\"token operator\">=</span> <span class=\"token string\">'20200802'</span></code></pre>\n<p><strong>timeMySQLsharding</strong></p>\n<p><strong></strong></p>\n<ul>\n<li>time</li>\n<li>time``</li>\n</ul>\n<pre><code>SELECT ID,USERNAME .... FROM USER where `time` = &#39;20200802&#39;</code></pre>","site":{"data":{}},"excerpt":"<h3 id=\"1shardingphere\"><a href=\"#1shardingphere\" class=\"headerlink\" title=\"1shardingphere\"></a><strong>1shardingphere</strong></h3><p>shardingphereshardingphere</p>\n<p><strong>shardingjdbc</strong></p>\n<p>shardingjdbc</p>\n<p><strong>shardingjdbc</strong></p>","more":"<p> + (user)</p>\n<ul>\n<li>4%4</li>\n<li>12</li>\n<li></li>\n</ul>\n<p> 44 * 1212 * 3= 144 100<code></code><code></code></p>\n<pre><code class=\"java\">io.shardingsphere.core.metadata.table.executor.TableMetaDataLoader</code></pre>\n<p> <img src=\"/2021/02/02/shardingphere-problem/1.png\" alt></p>\n<p><strong></strong></p>\n<p>shardingPhere</p>\n<ul>\n<li>shardingpherejar</li>\n<li>tomcattomcatTableMetaDataLoader</li>\n</ul>\n<p></p>\n<p><img src=\"/2021/02/02/shardingphere-problem/2.png\" alt></p>\n<h3 id=\"1SQL\"><a href=\"#1SQL\" class=\"headerlink\" title=\"1SQL\"></a><strong>1SQL</strong></h3><p>MySQLSQL<code>time</code></p>\n<pre><code class=\"java\">SELECT ID,USERNAME .... FROM USER where time = &#39;20200802&#39;</code></pre>\n<p><strong>timeMySQLsharding</strong></p>\n<p><strong></strong></p>\n<ul>\n<li>time</li>\n<li>time``</li>\n</ul>\n<pre><code>SELECT ID,USERNAME .... FROM USER where `time` = &#39;20200802&#39;</code></pre>"},{"title":"SpringBoot","description":"SpringBoot","date":"2020-09-27T02:32:09.000Z","_content":"\n## \n\nSpringBootRedisspring-boot-starter-data-redisRedisapplication.propertiesredisRedisTemplate.javaRedis\n\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n</dependency>\n```\n<!--more-->\nSpringBoot**SpringBoot**  ****\n\n- spring-boot-starter-xxxstarter\n\n- xxx-spring-boot-starterstarter\n\n## \n\nSpringBootspring-boot-autoconfigure-xxx**@EnableAutoConfiguration**\n\n![](springboot-custom-start/1.png)\n\nSpringBoot@SpringBootApplication@EnableAutoConfiguration\n\n```java\n@SpringBootApplication\npublic class SpringbootprojectApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(SpringbootprojectApplication.class, args);\n    }\n}\n```\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@SpringBootConfiguration\n@EnableAutoConfiguration //\n@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n\t\t@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })\npublic @interface SpringBootApplication {\n\t//...\n}\n```\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration {\n\t//..\n}\n```\n\n@EnableAutoConfiguration@ImportAutoConfigurationImportSelector.class\n\n**AutoConfigurationImportSelector**selectImports()**SpringFactoriesLoader.loadFactoryNames()****META-INF/spring.factories**jarspring-boot-autoconfigure-x.x.x.x.jarspring.factories\n\n![](springboot-custom-start/3.png)\n\n<font color=red>SpringBoot@EnableAutoConfigurationclassspring.factorieskey = org.springframework.boot.autoconfigure.EnableAutoConfigurationBean</font>\n\nSpingBootMavenRedisAutoConfigurationspringRedis**Redis(IP,)Redis**SpringBoot\n\n- @ConditionalOnBeanbeanBean\n- @ConditionalOnClassclassBean\n- @ConditionalOnExpressiontrueBean\n- @ConditionalOnMissingBeanbeanBean\n- @ConditionalOnMissingClassclassBean\n- @ConditionalOnNotWebApplicationwebBean\n- @AutoConfigureAfterbeanbean\n- @AutoConfigureBeforebeanbean\n- @ConditionalOnProperty\n- @EnableConfigurationProperties(xxxProperties.class)@ConfigurationPropertiesymlpropertiesbean\n\n**Redis**\n\n```java\n//\n@Configuration(proxyBeanMethods = false)\n//RedisOperations.class\n@ConditionalOnClass(RedisOperations.class)\n//ymlpropertiesRedisProperties.class\n@EnableConfigurationProperties(RedisProperties.class)\n//@Import<import />RedisAutoConfiguration\n//LettuceConnectionConfigurationspringbootlettuceredis\n@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })\npublic class RedisAutoConfiguration {\n    //RedisTemplateRedisTemplate\n\t@Bean\n    //@ConditionalOnMissingBeanspringredisTemplate\n\t@ConditionalOnMissingBean(name = \"redisTemplate\")\n\tpublic RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory)\n\t\t\tthrows UnknownHostException {\n\t\tRedisTemplate<Object, Object> template = new RedisTemplate<>();\n\t\ttemplate.setConnectionFactory(redisConnectionFactory);\n\t\treturn template;\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory)\n\t\t\tthrows UnknownHostException {\n\t\tStringRedisTemplate template = new StringRedisTemplate();\n\t\ttemplate.setConnectionFactory(redisConnectionFactory);\n\t\treturn template;\n\t}\n}\n\n@ConfigurationProperties(prefix = \"spring.redis\")\npublic class RedisProperties {\n\tprivate String url;\n    private String host = \"localhost\";\n}\n```\n\n**SpringBoot**\n\n![](springboot-custom-start/4.png)\n\n## Mybatis\n\nspring-boot-starter-xxxstarterxxx-spring-boot-starterstarterRedisSpringBootMybatis\n\n```java\n<dependency>\n\t<groupId>org.mybatis.spring.boot</groupId>\n\t<artifactId>mybatis-spring-boot-starter</artifactId>\n\t<version>1.3.2</version>\n</dependency>\n```\n\n![](springboot-custom-start/5.png)\n\nMybatisstartermybatis-spring-boot-starter\n\n- mybatis-spring-boot-autoconfigure  \n- mybatis mybatis\n- mybatis-spring mybatis-spring\n- spring-boot-starter-jdbc springjbdcmybatisjdbc\n\nmybatis-spring-boot-autoconfigure**spring.factories**org.springframework.boot.autoconfigure.EnableAutoConfiguration = XXXConfiguration\n\n![](springboot-custom-start/6.png)\n\n```java\npackage org.mybatis.spring.boot.autoconfigure;\n//...\n@Configuration //\n//classSqlSessionFactorySqlSessionFactoryBeanclassmybatis\n@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})\n//spring@ConditionalOnClassmybatis\n@ConditionalOnBean({DataSource.class})\n//ymlpropertiesMybatisProperties\n@EnableConfigurationProperties({MybatisProperties.class})\n//DataSourceAutoConfiguration.class\n@AutoConfigureAfter({DataSourceAutoConfiguration.class})\npublic class MybatisAutoConfiguration {\n    //...\n\n    @PostConstruct\n    public void checkConfigFileExists() {\n        if (this.properties.isCheckConfigLocation() && StringUtils.hasText(this.properties.getConfigLocation())) {\n            Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());\n            Assert.state(resource.exists(), \"Cannot find config location: \" + resource + \" (please add config file or check your Mybatis configuration)\");\n        }\n    }\n\n    //SqlSessionFactory\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n        //...\n    }\n\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {\n        ExecutorType executorType = this.properties.getExecutorType();\n        return executorType != null ? new SqlSessionTemplate(sqlSessionFactory, executorType) : new SqlSessionTemplate(sqlSessionFactory);\n    }\n\n    //MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrarMapperspring\n    @Configuration\n    @Import({MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrar.class})\n    @ConditionalOnMissingBean({MapperFactoryBean.class})\n    public static class MapperScannerRegistrarNotFoundConfiguration {\n        public MapperScannerRegistrarNotFoundConfiguration() {\n        }\n\n        @PostConstruct\n        public void afterPropertiesSet() {\n            MybatisAutoConfiguration.logger.debug(\"No {} found.\", MapperFactoryBean.class.getName());\n        }\n    }\n\n    public static class AutoConfiguredMapperScannerRegistrar implements BeanFactoryAware, ImportBeanDefinitionRegistrar, ResourceLoaderAware {\n        private BeanFactory beanFactory;\n        private ResourceLoader resourceLoader;\n\n        public AutoConfiguredMapperScannerRegistrar() {\n        }\n\n        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n            //....\n        }\n\n        public void setBeanFactory(BeanFactory beanFactory) throws BeansException {\n            this.beanFactory = beanFactory;\n        }\n\n        public void setResourceLoader(ResourceLoader resourceLoader) {\n            this.resourceLoader = resourceLoader;\n        }\n    }\n}\n```\n\n## \n\nRedisRedisstarter\n\n1.  **xuzy-spring-redis-starter**\n2. **spring-boot-starter-data-redis**\n3. **META-INF/spring.factories**\n4. **RedisAutoConfig**\n\n![](springboot-custom-start/7.png)\n\nMybatis@AutoConfigureAfter(RedisTemplate.class)RedisTemplate@BeanRedisUtil\n\nstarter\n\n\n\n","source":"_posts/springboot-custom-start.md","raw":"---\ntitle: SpringBoot\ntags:\n  - spring\ncategories: \n  - spring\ndescription : SpringBoot\ndate: 2020-09-27 10:32:09\n---\n\n## \n\nSpringBootRedisspring-boot-starter-data-redisRedisapplication.propertiesredisRedisTemplate.javaRedis\n\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n</dependency>\n```\n<!--more-->\nSpringBoot**SpringBoot**  ****\n\n- spring-boot-starter-xxxstarter\n\n- xxx-spring-boot-starterstarter\n\n## \n\nSpringBootspring-boot-autoconfigure-xxx**@EnableAutoConfiguration**\n\n![](springboot-custom-start/1.png)\n\nSpringBoot@SpringBootApplication@EnableAutoConfiguration\n\n```java\n@SpringBootApplication\npublic class SpringbootprojectApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(SpringbootprojectApplication.class, args);\n    }\n}\n```\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@SpringBootConfiguration\n@EnableAutoConfiguration //\n@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n\t\t@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })\npublic @interface SpringBootApplication {\n\t//...\n}\n```\n\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration {\n\t//..\n}\n```\n\n@EnableAutoConfiguration@ImportAutoConfigurationImportSelector.class\n\n**AutoConfigurationImportSelector**selectImports()**SpringFactoriesLoader.loadFactoryNames()****META-INF/spring.factories**jarspring-boot-autoconfigure-x.x.x.x.jarspring.factories\n\n![](springboot-custom-start/3.png)\n\n<font color=red>SpringBoot@EnableAutoConfigurationclassspring.factorieskey = org.springframework.boot.autoconfigure.EnableAutoConfigurationBean</font>\n\nSpingBootMavenRedisAutoConfigurationspringRedis**Redis(IP,)Redis**SpringBoot\n\n- @ConditionalOnBeanbeanBean\n- @ConditionalOnClassclassBean\n- @ConditionalOnExpressiontrueBean\n- @ConditionalOnMissingBeanbeanBean\n- @ConditionalOnMissingClassclassBean\n- @ConditionalOnNotWebApplicationwebBean\n- @AutoConfigureAfterbeanbean\n- @AutoConfigureBeforebeanbean\n- @ConditionalOnProperty\n- @EnableConfigurationProperties(xxxProperties.class)@ConfigurationPropertiesymlpropertiesbean\n\n**Redis**\n\n```java\n//\n@Configuration(proxyBeanMethods = false)\n//RedisOperations.class\n@ConditionalOnClass(RedisOperations.class)\n//ymlpropertiesRedisProperties.class\n@EnableConfigurationProperties(RedisProperties.class)\n//@Import<import />RedisAutoConfiguration\n//LettuceConnectionConfigurationspringbootlettuceredis\n@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })\npublic class RedisAutoConfiguration {\n    //RedisTemplateRedisTemplate\n\t@Bean\n    //@ConditionalOnMissingBeanspringredisTemplate\n\t@ConditionalOnMissingBean(name = \"redisTemplate\")\n\tpublic RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory)\n\t\t\tthrows UnknownHostException {\n\t\tRedisTemplate<Object, Object> template = new RedisTemplate<>();\n\t\ttemplate.setConnectionFactory(redisConnectionFactory);\n\t\treturn template;\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory)\n\t\t\tthrows UnknownHostException {\n\t\tStringRedisTemplate template = new StringRedisTemplate();\n\t\ttemplate.setConnectionFactory(redisConnectionFactory);\n\t\treturn template;\n\t}\n}\n\n@ConfigurationProperties(prefix = \"spring.redis\")\npublic class RedisProperties {\n\tprivate String url;\n    private String host = \"localhost\";\n}\n```\n\n**SpringBoot**\n\n![](springboot-custom-start/4.png)\n\n## Mybatis\n\nspring-boot-starter-xxxstarterxxx-spring-boot-starterstarterRedisSpringBootMybatis\n\n```java\n<dependency>\n\t<groupId>org.mybatis.spring.boot</groupId>\n\t<artifactId>mybatis-spring-boot-starter</artifactId>\n\t<version>1.3.2</version>\n</dependency>\n```\n\n![](springboot-custom-start/5.png)\n\nMybatisstartermybatis-spring-boot-starter\n\n- mybatis-spring-boot-autoconfigure  \n- mybatis mybatis\n- mybatis-spring mybatis-spring\n- spring-boot-starter-jdbc springjbdcmybatisjdbc\n\nmybatis-spring-boot-autoconfigure**spring.factories**org.springframework.boot.autoconfigure.EnableAutoConfiguration = XXXConfiguration\n\n![](springboot-custom-start/6.png)\n\n```java\npackage org.mybatis.spring.boot.autoconfigure;\n//...\n@Configuration //\n//classSqlSessionFactorySqlSessionFactoryBeanclassmybatis\n@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})\n//spring@ConditionalOnClassmybatis\n@ConditionalOnBean({DataSource.class})\n//ymlpropertiesMybatisProperties\n@EnableConfigurationProperties({MybatisProperties.class})\n//DataSourceAutoConfiguration.class\n@AutoConfigureAfter({DataSourceAutoConfiguration.class})\npublic class MybatisAutoConfiguration {\n    //...\n\n    @PostConstruct\n    public void checkConfigFileExists() {\n        if (this.properties.isCheckConfigLocation() && StringUtils.hasText(this.properties.getConfigLocation())) {\n            Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());\n            Assert.state(resource.exists(), \"Cannot find config location: \" + resource + \" (please add config file or check your Mybatis configuration)\");\n        }\n    }\n\n    //SqlSessionFactory\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n        //...\n    }\n\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {\n        ExecutorType executorType = this.properties.getExecutorType();\n        return executorType != null ? new SqlSessionTemplate(sqlSessionFactory, executorType) : new SqlSessionTemplate(sqlSessionFactory);\n    }\n\n    //MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrarMapperspring\n    @Configuration\n    @Import({MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrar.class})\n    @ConditionalOnMissingBean({MapperFactoryBean.class})\n    public static class MapperScannerRegistrarNotFoundConfiguration {\n        public MapperScannerRegistrarNotFoundConfiguration() {\n        }\n\n        @PostConstruct\n        public void afterPropertiesSet() {\n            MybatisAutoConfiguration.logger.debug(\"No {} found.\", MapperFactoryBean.class.getName());\n        }\n    }\n\n    public static class AutoConfiguredMapperScannerRegistrar implements BeanFactoryAware, ImportBeanDefinitionRegistrar, ResourceLoaderAware {\n        private BeanFactory beanFactory;\n        private ResourceLoader resourceLoader;\n\n        public AutoConfiguredMapperScannerRegistrar() {\n        }\n\n        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n            //....\n        }\n\n        public void setBeanFactory(BeanFactory beanFactory) throws BeansException {\n            this.beanFactory = beanFactory;\n        }\n\n        public void setResourceLoader(ResourceLoader resourceLoader) {\n            this.resourceLoader = resourceLoader;\n        }\n    }\n}\n```\n\n## \n\nRedisRedisstarter\n\n1.  **xuzy-spring-redis-starter**\n2. **spring-boot-starter-data-redis**\n3. **META-INF/spring.factories**\n4. **RedisAutoConfig**\n\n![](springboot-custom-start/7.png)\n\nMybatis@AutoConfigureAfter(RedisTemplate.class)RedisTemplate@BeanRedisUtil\n\nstarter\n\n\n\n","slug":"springboot-custom-start","published":1,"updated":"2021-04-08T00:47:07.017Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvx003yqwv2626945nt","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SpringBootRedisspring-boot-starter-data-redisRedisapplication.propertiesredisRedisTemplate.javaRedis</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-data-redis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre>\n<a id=\"more\"></a>\n<p>SpringBoot<strong>SpringBoot</strong>  <strong></strong></p>\n<ul>\n<li><p>spring-boot-starter-xxxstarter</p>\n</li>\n<li><p>xxx-spring-boot-starterstarter</p>\n</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SpringBootspring-boot-autoconfigure-xxx<strong>@EnableAutoConfiguration</strong></p>\n<p><img src=\"/2020/09/27/springboot-custom-start/1.png\" alt></p>\n<p>SpringBoot@SpringBootApplication@EnableAutoConfiguration</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringbootprojectApplication</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        SpringApplication<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>SpringbootprojectApplication<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Target</span><span class=\"token punctuation\">(</span>ElementType<span class=\"token punctuation\">.</span>TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Retention</span><span class=\"token punctuation\">(</span>RetentionPolicy<span class=\"token punctuation\">.</span>RUNTIME<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Documented</span>\n<span class=\"token annotation punctuation\">@Inherited</span>\n<span class=\"token annotation punctuation\">@SpringBootConfiguration</span>\n<span class=\"token annotation punctuation\">@EnableAutoConfiguration</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@ComponentScan</span><span class=\"token punctuation\">(</span>excludeFilters <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token annotation punctuation\">@Filter</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> FilterType<span class=\"token punctuation\">.</span>CUSTOM<span class=\"token punctuation\">,</span> classes <span class=\"token operator\">=</span> TypeExcludeFilter<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token annotation punctuation\">@Filter</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> FilterType<span class=\"token punctuation\">.</span>CUSTOM<span class=\"token punctuation\">,</span> classes <span class=\"token operator\">=</span> AutoConfigurationExcludeFilter<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> @<span class=\"token keyword\">interface</span> <span class=\"token class-name\">SpringBootApplication</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Target</span><span class=\"token punctuation\">(</span>ElementType<span class=\"token punctuation\">.</span>TYPE<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Retention</span><span class=\"token punctuation\">(</span>RetentionPolicy<span class=\"token punctuation\">.</span>RUNTIME<span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Documented</span>\n<span class=\"token annotation punctuation\">@Inherited</span>\n<span class=\"token annotation punctuation\">@AutoConfigurationPackage</span>\n<span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span>AutoConfigurationImportSelector<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> @<span class=\"token keyword\">interface</span> <span class=\"token class-name\">EnableAutoConfiguration</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//..</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>@EnableAutoConfiguration@ImportAutoConfigurationImportSelector.class</p>\n<p><strong>AutoConfigurationImportSelector</strong>selectImports()<strong>SpringFactoriesLoader.loadFactoryNames()</strong><strong>META-INF/spring.factories</strong>jarspring-boot-autoconfigure-x.x.x.x.jarspring.factories</p>\n<p><img src=\"/2020/09/27/springboot-custom-start/3.png\" alt></p>\n<p><font color=\"red\">SpringBoot@EnableAutoConfigurationclassspring.factorieskey = org.springframework.boot.autoconfigure.EnableAutoConfiguration Bean</font></p>\n<p>SpingBootMavenRedisAutoConfigurationspringRedis<strong>Redis(IP,)Redis</strong>SpringBoot</p>\n<ul>\n<li>@ConditionalOnBeanbeanBean</li>\n<li>@ConditionalOnClassclassBean</li>\n<li>@ConditionalOnExpressiontrueBean</li>\n<li>@ConditionalOnMissingBeanbeanBean</li>\n<li>@ConditionalOnMissingClassclassBean</li>\n<li>@ConditionalOnNotWebApplicationwebBean</li>\n<li>@AutoConfigureAfterbeanbean</li>\n<li>@AutoConfigureBeforebeanbean</li>\n<li>@ConditionalOnProperty</li>\n<li>@EnableConfigurationProperties(xxxProperties.class)@ConfigurationPropertiesymlpropertiesbean</li>\n</ul>\n<p><strong>Redis</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@Configuration</span><span class=\"token punctuation\">(</span>proxyBeanMethods <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//RedisOperations.class</span>\n<span class=\"token annotation punctuation\">@ConditionalOnClass</span><span class=\"token punctuation\">(</span>RedisOperations<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//ymlpropertiesRedisProperties.class</span>\n<span class=\"token annotation punctuation\">@EnableConfigurationProperties</span><span class=\"token punctuation\">(</span>RedisProperties<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//@Import&lt;import />RedisAutoConfiguration</span>\n<span class=\"token comment\" spellcheck=\"true\">//LettuceConnectionConfigurationspringbootlettuceredis</span>\n<span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> LettuceConnectionConfiguration<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> JedisConnectionConfiguration<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisAutoConfiguration</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//RedisTemplateRedisTemplate</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token comment\" spellcheck=\"true\">//@ConditionalOnMissingBeanspringredisTemplate</span>\n    <span class=\"token annotation punctuation\">@ConditionalOnMissingBean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"redisTemplate\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> RedisTemplate<span class=\"token operator\">&lt;</span>Object<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span>RedisConnectionFactory redisConnectionFactory<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throws</span> UnknownHostException <span class=\"token punctuation\">{</span>\n        RedisTemplate<span class=\"token operator\">&lt;</span>Object<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> template <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>redisConnectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> template<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@ConditionalOnMissingBean</span>\n    <span class=\"token keyword\">public</span> StringRedisTemplate <span class=\"token function\">stringRedisTemplate</span><span class=\"token punctuation\">(</span>RedisConnectionFactory redisConnectionFactory<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throws</span> UnknownHostException <span class=\"token punctuation\">{</span>\n        StringRedisTemplate template <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        template<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>redisConnectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> template<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"spring.redis\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisProperties</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> String url<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String host <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>SpringBoot</strong></p>\n<p><img src=\"/2020/09/27/springboot-custom-start/4.png\" alt></p>\n<h2 id=\"Mybatis\"><a href=\"#Mybatis\" class=\"headerlink\" title=\"Mybatis\"></a>Mybatis</h2><p>spring-boot-starter-xxxstarterxxx-spring-boot-starterstarterRedisSpringBootMybatis</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token operator\">&lt;</span>dependency<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>groupId<span class=\"token operator\">></span>org<span class=\"token punctuation\">.</span>mybatis<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>boot<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>groupId<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>artifactId<span class=\"token operator\">></span>mybatis<span class=\"token operator\">-</span>spring<span class=\"token operator\">-</span>boot<span class=\"token operator\">-</span>starter<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>artifactId<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>version<span class=\"token operator\">></span><span class=\"token number\">1.3</span><span class=\"token punctuation\">.</span><span class=\"token number\">2</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>version<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>dependency<span class=\"token operator\">></span></code></pre>\n<p><img src=\"/2020/09/27/springboot-custom-start/5.png\" alt></p>\n<p>Mybatisstartermybatis-spring-boot-starter</p>\n<ul>\n<li>mybatis-spring-boot-autoconfigure  </li>\n<li>mybatis mybatis</li>\n<li>mybatis-spring mybatis-spring</li>\n<li>spring-boot-starter-jdbc springjbdcmybatisjdbc</li>\n</ul>\n<p>mybatis-spring-boot-autoconfigure<strong>spring.factories</strong>org.springframework.boot.autoconfigure.EnableAutoConfiguration = XXXConfiguration</p>\n<p><img src=\"/2020/09/27/springboot-custom-start/6.png\" alt></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> org<span class=\"token punctuation\">.</span>mybatis<span class=\"token punctuation\">.</span>spring<span class=\"token punctuation\">.</span>boot<span class=\"token punctuation\">.</span>autoconfigure<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//...</span>\n<span class=\"token annotation punctuation\">@Configuration</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//classSqlSessionFactorySqlSessionFactoryBeanclassmybatis</span>\n<span class=\"token annotation punctuation\">@ConditionalOnClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>SqlSessionFactory<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> SqlSessionFactoryBean<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//spring@ConditionalOnClassmybatis</span>\n<span class=\"token annotation punctuation\">@ConditionalOnBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>DataSource<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//ymlpropertiesMybatisProperties</span>\n<span class=\"token annotation punctuation\">@EnableConfigurationProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>MybatisProperties<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\" spellcheck=\"true\">//DataSourceAutoConfiguration.class</span>\n<span class=\"token annotation punctuation\">@AutoConfigureAfter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>DataSourceAutoConfiguration<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MybatisAutoConfiguration</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//...</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkConfigFileExists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">isCheckConfigLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> StringUtils<span class=\"token punctuation\">.</span><span class=\"token function\">hasText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getConfigLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Resource resource <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceLoader<span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getConfigLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Assert<span class=\"token punctuation\">.</span><span class=\"token function\">state</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Cannot find config location: \"</span> <span class=\"token operator\">+</span> resource <span class=\"token operator\">+</span> <span class=\"token string\">\" (please add config file or check your Mybatis configuration)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//SqlSessionFactory</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@ConditionalOnMissingBean</span>\n    <span class=\"token keyword\">public</span> SqlSessionFactory <span class=\"token function\">sqlSessionFactory</span><span class=\"token punctuation\">(</span>DataSource dataSource<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token annotation punctuation\">@ConditionalOnMissingBean</span>\n    <span class=\"token keyword\">public</span> SqlSessionTemplate <span class=\"token function\">sqlSessionTemplate</span><span class=\"token punctuation\">(</span>SqlSessionFactory sqlSessionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        ExecutorType executorType <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getExecutorType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> executorType <span class=\"token operator\">!=</span> null <span class=\"token operator\">?</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SqlSessionTemplate</span><span class=\"token punctuation\">(</span>sqlSessionFactory<span class=\"token punctuation\">,</span> executorType<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SqlSessionTemplate</span><span class=\"token punctuation\">(</span>sqlSessionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">//MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrarMapperspring</span>\n    <span class=\"token annotation punctuation\">@Configuration</span>\n    <span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>MybatisAutoConfiguration<span class=\"token punctuation\">.</span>AutoConfiguredMapperScannerRegistrar<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ConditionalOnMissingBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>MapperFactoryBean<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MapperScannerRegistrarNotFoundConfiguration</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token function\">MapperScannerRegistrarNotFoundConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@PostConstruct</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            MybatisAutoConfiguration<span class=\"token punctuation\">.</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No {} found.\"</span><span class=\"token punctuation\">,</span> MapperFactoryBean<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AutoConfiguredMapperScannerRegistrar</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BeanFactoryAware</span><span class=\"token punctuation\">,</span> ImportBeanDefinitionRegistrar<span class=\"token punctuation\">,</span> ResourceLoaderAware <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> BeanFactory beanFactory<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> ResourceLoader resourceLoader<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token function\">AutoConfiguredMapperScannerRegistrar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerBeanDefinitions</span><span class=\"token punctuation\">(</span>AnnotationMetadata importingClassMetadata<span class=\"token punctuation\">,</span> BeanDefinitionRegistry registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//....</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setBeanFactory</span><span class=\"token punctuation\">(</span>BeanFactory beanFactory<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> BeansException <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>beanFactory <span class=\"token operator\">=</span> beanFactory<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setResourceLoader</span><span class=\"token punctuation\">(</span>ResourceLoader resourceLoader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceLoader <span class=\"token operator\">=</span> resourceLoader<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>RedisRedisstarter</p>\n<ol>\n<li> <strong>xuzy-spring-redis-starter</strong></li>\n<li><strong>spring-boot-starter-data-redis</strong></li>\n<li><strong>META-INF/spring.factories</strong></li>\n<li><strong>RedisAutoConfig</strong></li>\n</ol>\n<p><img src=\"/2020/09/27/springboot-custom-start/7.png\" alt></p>\n<p>Mybatis@AutoConfigureAfter(RedisTemplate.class)RedisTemplate@BeanRedisUtil</p>\n<p>starter</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SpringBootRedisspring-boot-starter-data-redisRedisapplication.propertiesredisRedisTemplate.javaRedis</p>\n<pre><code class=\"xml\">&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;\n&lt;/dependency&gt;</code></pre>","more":"<p>SpringBoot<strong>SpringBoot</strong>  <strong></strong></p>\n<ul>\n<li><p>spring-boot-starter-xxxstarter</p>\n</li>\n<li><p>xxx-spring-boot-starterstarter</p>\n</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SpringBootspring-boot-autoconfigure-xxx<strong>@EnableAutoConfiguration</strong></p>\n<p><img src=\"/2020/09/27/springboot-custom-start/1.png\" alt></p>\n<p>SpringBoot@SpringBootApplication@EnableAutoConfiguration</p>\n<pre><code class=\"java\">@SpringBootApplication\npublic class SpringbootprojectApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(SpringbootprojectApplication.class, args);\n    }\n}</code></pre>\n<pre><code class=\"java\">@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@SpringBootConfiguration\n@EnableAutoConfiguration //\n@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })\npublic @interface SpringBootApplication {\n    //...\n}</code></pre>\n<pre><code class=\"java\">@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration {\n    //..\n}</code></pre>\n<p>@EnableAutoConfiguration@ImportAutoConfigurationImportSelector.class</p>\n<p><strong>AutoConfigurationImportSelector</strong>selectImports()<strong>SpringFactoriesLoader.loadFactoryNames()</strong><strong>META-INF/spring.factories</strong>jarspring-boot-autoconfigure-x.x.x.x.jarspring.factories</p>\n<p><img src=\"/2020/09/27/springboot-custom-start/3.png\" alt></p>\n<p><font color=\"red\">SpringBoot@EnableAutoConfigurationclassspring.factorieskey = org.springframework.boot.autoconfigure.EnableAutoConfiguration Bean</font></p>\n<p>SpingBootMavenRedisAutoConfigurationspringRedis<strong>Redis(IP,)Redis</strong>SpringBoot</p>\n<ul>\n<li>@ConditionalOnBeanbeanBean</li>\n<li>@ConditionalOnClassclassBean</li>\n<li>@ConditionalOnExpressiontrueBean</li>\n<li>@ConditionalOnMissingBeanbeanBean</li>\n<li>@ConditionalOnMissingClassclassBean</li>\n<li>@ConditionalOnNotWebApplicationwebBean</li>\n<li>@AutoConfigureAfterbeanbean</li>\n<li>@AutoConfigureBeforebeanbean</li>\n<li>@ConditionalOnProperty</li>\n<li>@EnableConfigurationProperties(xxxProperties.class)@ConfigurationPropertiesymlpropertiesbean</li>\n</ul>\n<p><strong>Redis</strong></p>\n<pre><code class=\"java\">//\n@Configuration(proxyBeanMethods = false)\n//RedisOperations.class\n@ConditionalOnClass(RedisOperations.class)\n//ymlpropertiesRedisProperties.class\n@EnableConfigurationProperties(RedisProperties.class)\n//@Import&lt;import /&gt;RedisAutoConfiguration\n//LettuceConnectionConfigurationspringbootlettuceredis\n@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })\npublic class RedisAutoConfiguration {\n    //RedisTemplateRedisTemplate\n    @Bean\n    //@ConditionalOnMissingBeanspringredisTemplate\n    @ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)\n    public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)\n            throws UnknownHostException {\n        RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();\n        template.setConnectionFactory(redisConnectionFactory);\n        return template;\n    }\n\n    @Bean\n    @ConditionalOnMissingBean\n    public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory)\n            throws UnknownHostException {\n        StringRedisTemplate template = new StringRedisTemplate();\n        template.setConnectionFactory(redisConnectionFactory);\n        return template;\n    }\n}\n\n@ConfigurationProperties(prefix = &quot;spring.redis&quot;)\npublic class RedisProperties {\n    private String url;\n    private String host = &quot;localhost&quot;;\n}</code></pre>\n<p><strong>SpringBoot</strong></p>\n<p><img src=\"/2020/09/27/springboot-custom-start/4.png\" alt></p>\n<h2 id=\"Mybatis\"><a href=\"#Mybatis\" class=\"headerlink\" title=\"Mybatis\"></a>Mybatis</h2><p>spring-boot-starter-xxxstarterxxx-spring-boot-starterstarterRedisSpringBootMybatis</p>\n<pre><code class=\"java\">&lt;dependency&gt;\n    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;\n    &lt;version&gt;1.3.2&lt;/version&gt;\n&lt;/dependency&gt;</code></pre>\n<p><img src=\"/2020/09/27/springboot-custom-start/5.png\" alt></p>\n<p>Mybatisstartermybatis-spring-boot-starter</p>\n<ul>\n<li>mybatis-spring-boot-autoconfigure  </li>\n<li>mybatis mybatis</li>\n<li>mybatis-spring mybatis-spring</li>\n<li>spring-boot-starter-jdbc springjbdcmybatisjdbc</li>\n</ul>\n<p>mybatis-spring-boot-autoconfigure<strong>spring.factories</strong>org.springframework.boot.autoconfigure.EnableAutoConfiguration = XXXConfiguration</p>\n<p><img src=\"/2020/09/27/springboot-custom-start/6.png\" alt></p>\n<pre><code class=\"java\">package org.mybatis.spring.boot.autoconfigure;\n//...\n@Configuration //\n//classSqlSessionFactorySqlSessionFactoryBeanclassmybatis\n@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})\n//spring@ConditionalOnClassmybatis\n@ConditionalOnBean({DataSource.class})\n//ymlpropertiesMybatisProperties\n@EnableConfigurationProperties({MybatisProperties.class})\n//DataSourceAutoConfiguration.class\n@AutoConfigureAfter({DataSourceAutoConfiguration.class})\npublic class MybatisAutoConfiguration {\n    //...\n\n    @PostConstruct\n    public void checkConfigFileExists() {\n        if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) {\n            Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());\n            Assert.state(resource.exists(), &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);\n        }\n    }\n\n    //SqlSessionFactory\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n        //...\n    }\n\n    @Bean\n    @ConditionalOnMissingBean\n    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {\n        ExecutorType executorType = this.properties.getExecutorType();\n        return executorType != null ? new SqlSessionTemplate(sqlSessionFactory, executorType) : new SqlSessionTemplate(sqlSessionFactory);\n    }\n\n    //MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrarMapperspring\n    @Configuration\n    @Import({MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrar.class})\n    @ConditionalOnMissingBean({MapperFactoryBean.class})\n    public static class MapperScannerRegistrarNotFoundConfiguration {\n        public MapperScannerRegistrarNotFoundConfiguration() {\n        }\n\n        @PostConstruct\n        public void afterPropertiesSet() {\n            MybatisAutoConfiguration.logger.debug(&quot;No {} found.&quot;, MapperFactoryBean.class.getName());\n        }\n    }\n\n    public static class AutoConfiguredMapperScannerRegistrar implements BeanFactoryAware, ImportBeanDefinitionRegistrar, ResourceLoaderAware {\n        private BeanFactory beanFactory;\n        private ResourceLoader resourceLoader;\n\n        public AutoConfiguredMapperScannerRegistrar() {\n        }\n\n        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n            //....\n        }\n\n        public void setBeanFactory(BeanFactory beanFactory) throws BeansException {\n            this.beanFactory = beanFactory;\n        }\n\n        public void setResourceLoader(ResourceLoader resourceLoader) {\n            this.resourceLoader = resourceLoader;\n        }\n    }\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>RedisRedisstarter</p>\n<ol>\n<li> <strong>xuzy-spring-redis-starter</strong></li>\n<li><strong>spring-boot-starter-data-redis</strong></li>\n<li><strong>META-INF/spring.factories</strong></li>\n<li><strong>RedisAutoConfig</strong></li>\n</ol>\n<p><img src=\"/2020/09/27/springboot-custom-start/7.png\" alt></p>\n<p>Mybatis@AutoConfigureAfter(RedisTemplate.class)RedisTemplate@BeanRedisUtil</p>\n<p>starter</p>"},{"title":"SpringCloud","description":"SpringCloud","date":"2021-01-01T07:46:34.000Z","_content":"## \n\n![](springcloud-1/1.png)\n\n- EurekaEurekaIP\n- EurekaEureka\n- EurekaEurekaEureka\n- Eureka\n- Eureka\n\n## \n\nLeaseManagerLeaseManager\n\n```java\npublic interface LeaseManager<T> {\n    //\n    void register(T r, int leaseDuration, boolean isReplication);\n    //\n    boolean cancel(String appName, String id, boolean isReplication);\n    //\n    boolean renew(String appName, String id, boolean isReplication);\n    //\n    void evict();\n}\n```\n\n### \n\n1. `DiscoveryClient#register()`RESTHTTP`InstanceInfo`\n2. REST`AbstractInstanceRegistry#register()`ConcurrentHashMapMapkeyspring.application.namekeyIdeureka.instance.instanceIdValueLease\n\n```java\n# DiscoveryClient#register()\nboolean register() throws Throwable {\n    logger.info(PREFIX + \"{}: registering service...\", appPathIdentifier);\n    EurekaHttpResponse<Void> httpResponse;\n    try {\n        //instanceInfo\n        //,REST\n        httpResponse = eurekaTransport.registrationClient.register(instanceInfo);\n    } catch (Exception e) {\n        //....\n    }\n    // ...\n    return httpResponse.getStatusCode() == 204;\n}\n\n// ----------------------------------------------------------------\n\n//\nConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>> registry\n            = new ConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>>();\n\n\npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n try { \n // registry \n Map<String, Lease<InstanceInfo>> gMap = registry.get(registrant.getAppName());\n REGISTER.increment(isReplication);\n if (gMap == null) {\n // Map<String, Lease<InstanceInfo>>  registry \n }\n  // ID  Lease\n Lease<InstanceInfo> existingLease = gMap.get(registrant.getId());\n\n if (existingLease != null && (existingLease.getHolder() != null)) {\n // Lease \n //\n } else {\n //\n }\n // Lease  Map \n Lease<InstanceInfo> lease = new Lease<InstanceInfo>(registrant, leaseDuration);\n gMap.put(registrant.getId(), lease);\n\n // InstanceStatus\n registrant.setActionType(ActionType.ADDED);\n\n //\n registrant.setLastUpdatedTimestamp();\n\n //ResponseCacheImpl Eureka  readOnlyCacheMap() readWriteCacheMap()\n invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n } \n}\n```\n\n### \n\n\n\n1. ()`DiscoveryClient#initScheduledTasks()`\n2. `AbstractInstanceRegistry#renew()`\n\n```java\nscheduler.schedule(\n                    new TimedSupervisorTask(\n                            \"heartbeat\",\n                            scheduler,\n                            heartbeatExecutor,\n                            renewalIntervalInSecs,\n                            TimeUnit.SECONDS,\n                            expBackOffBound,\n                        \t//\n                            new HeartbeatThread()\n                    ),\nrenewalIntervalInSecs, TimeUnit.SECONDS);\n```\n\n### \n\n30\n\neureka.client.registry-fetch-interval-seconds=3030\n\nEureka  Eureka \n\n`DiscoveryClient#initScheduledTasks()`\n\n```\nif (clientConfig.shouldFetchRegistry()) {\n    int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();\n    int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();\n    scheduler.schedule(\n            new TimedSupervisorTask(\n                    \"cacheRefresh\",\n                    scheduler,\n                    cacheRefreshExecutor,\n                    registryFetchIntervalSeconds,\n                    TimeUnit.SECONDS,\n                    expBackOffBound,\n                    new CacheRefreshThread()\n            ),\n            registryFetchIntervalSeconds, TimeUnit.SECONDS);\n}\n\n```\n\nHashCodeHashCode\n\n### \n\nAAAA\n\n****1585%EurekaEureka Server\n\n**** \n\n- \n- \n- \n\n","source":"_posts/springcloud-1.md","raw":"---\ntitle: SpringCloud\ntags:\n  - SpringCloud\ncategories: SpringCloud\ndescription : SpringCloud\ndate: 2021-01-01 15:46:34\n---\n## \n\n![](springcloud-1/1.png)\n\n- EurekaEurekaIP\n- EurekaEureka\n- EurekaEurekaEureka\n- Eureka\n- Eureka\n\n## \n\nLeaseManagerLeaseManager\n\n```java\npublic interface LeaseManager<T> {\n    //\n    void register(T r, int leaseDuration, boolean isReplication);\n    //\n    boolean cancel(String appName, String id, boolean isReplication);\n    //\n    boolean renew(String appName, String id, boolean isReplication);\n    //\n    void evict();\n}\n```\n\n### \n\n1. `DiscoveryClient#register()`RESTHTTP`InstanceInfo`\n2. REST`AbstractInstanceRegistry#register()`ConcurrentHashMapMapkeyspring.application.namekeyIdeureka.instance.instanceIdValueLease\n\n```java\n# DiscoveryClient#register()\nboolean register() throws Throwable {\n    logger.info(PREFIX + \"{}: registering service...\", appPathIdentifier);\n    EurekaHttpResponse<Void> httpResponse;\n    try {\n        //instanceInfo\n        //,REST\n        httpResponse = eurekaTransport.registrationClient.register(instanceInfo);\n    } catch (Exception e) {\n        //....\n    }\n    // ...\n    return httpResponse.getStatusCode() == 204;\n}\n\n// ----------------------------------------------------------------\n\n//\nConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>> registry\n            = new ConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>>();\n\n\npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n try { \n // registry \n Map<String, Lease<InstanceInfo>> gMap = registry.get(registrant.getAppName());\n REGISTER.increment(isReplication);\n if (gMap == null) {\n // Map<String, Lease<InstanceInfo>>  registry \n }\n  // ID  Lease\n Lease<InstanceInfo> existingLease = gMap.get(registrant.getId());\n\n if (existingLease != null && (existingLease.getHolder() != null)) {\n // Lease \n //\n } else {\n //\n }\n // Lease  Map \n Lease<InstanceInfo> lease = new Lease<InstanceInfo>(registrant, leaseDuration);\n gMap.put(registrant.getId(), lease);\n\n // InstanceStatus\n registrant.setActionType(ActionType.ADDED);\n\n //\n registrant.setLastUpdatedTimestamp();\n\n //ResponseCacheImpl Eureka  readOnlyCacheMap() readWriteCacheMap()\n invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n } \n}\n```\n\n### \n\n\n\n1. ()`DiscoveryClient#initScheduledTasks()`\n2. `AbstractInstanceRegistry#renew()`\n\n```java\nscheduler.schedule(\n                    new TimedSupervisorTask(\n                            \"heartbeat\",\n                            scheduler,\n                            heartbeatExecutor,\n                            renewalIntervalInSecs,\n                            TimeUnit.SECONDS,\n                            expBackOffBound,\n                        \t//\n                            new HeartbeatThread()\n                    ),\nrenewalIntervalInSecs, TimeUnit.SECONDS);\n```\n\n### \n\n30\n\neureka.client.registry-fetch-interval-seconds=3030\n\nEureka  Eureka \n\n`DiscoveryClient#initScheduledTasks()`\n\n```\nif (clientConfig.shouldFetchRegistry()) {\n    int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();\n    int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();\n    scheduler.schedule(\n            new TimedSupervisorTask(\n                    \"cacheRefresh\",\n                    scheduler,\n                    cacheRefreshExecutor,\n                    registryFetchIntervalSeconds,\n                    TimeUnit.SECONDS,\n                    expBackOffBound,\n                    new CacheRefreshThread()\n            ),\n            registryFetchIntervalSeconds, TimeUnit.SECONDS);\n}\n\n```\n\nHashCodeHashCode\n\n### \n\nAAAA\n\n****1585%EurekaEureka Server\n\n**** \n\n- \n- \n- \n\n","slug":"springcloud-1","published":1,"updated":"2021-04-08T00:47:07.027Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvx0041qwv28f7z74rb","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/2021/01/01/springcloud-1/1.png\" alt></p>\n<ul>\n<li>EurekaEurekaIP</li>\n<li>EurekaEureka</li>\n<li>EurekaEurekaEureka</li>\n<li>Eureka</li>\n<li>Eureka</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>LeaseManagerLeaseManager</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">LeaseManager</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>T r<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> leaseDuration<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isReplication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span>String appName<span class=\"token punctuation\">,</span> String id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isReplication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">renew</span><span class=\"token punctuation\">(</span>String appName<span class=\"token punctuation\">,</span> String id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isReplication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">evict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><code>DiscoveryClient#register()</code>RESTHTTP<code>InstanceInfo</code></li>\n<li>REST<code>AbstractInstanceRegistry#register()</code>ConcurrentHashMapMapkeyspring.application.namekeyIdeureka.instance.instanceIdValueLease</li>\n</ol>\n<pre class=\" language-java\"><code class=\"language-java\"># DiscoveryClient#<span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Throwable <span class=\"token punctuation\">{</span>\n    logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>PREFIX <span class=\"token operator\">+</span> <span class=\"token string\">\"{}: registering service...\"</span><span class=\"token punctuation\">,</span> appPathIdentifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    EurekaHttpResponse<span class=\"token operator\">&lt;</span>Void<span class=\"token operator\">></span> httpResponse<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//instanceInfo</span>\n        <span class=\"token comment\" spellcheck=\"true\">//,REST</span>\n        httpResponse <span class=\"token operator\">=</span> eurekaTransport<span class=\"token punctuation\">.</span>registrationClient<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>instanceInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//....</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">// ...</span>\n    <span class=\"token keyword\">return</span> httpResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getStatusCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">204</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// ----------------------------------------------------------------</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\nConcurrentHashMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Lease<span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">>>></span> registry\n            <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentHashMap</span><span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Lease<span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">>>></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>InstanceInfo registrant<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> leaseDuration<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isReplication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span> \n        <span class=\"token comment\" spellcheck=\"true\">// registry </span>\n        Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Lease<span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">>></span> gMap <span class=\"token operator\">=</span> registry<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getAppName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        REGISTER<span class=\"token punctuation\">.</span><span class=\"token function\">increment</span><span class=\"token punctuation\">(</span>isReplication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gMap <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">// Map&lt;String, Lease&lt;InstanceInfo>>  registry </span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">// ID  Lease</span>\n        Lease<span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">></span> existingLease <span class=\"token operator\">=</span> gMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingLease <span class=\"token operator\">!=</span> null <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>existingLease<span class=\"token punctuation\">.</span><span class=\"token function\">getHolder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">// Lease </span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">// Lease  Map </span>\n        Lease<span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">></span> lease <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lease</span><span class=\"token operator\">&lt;</span>InstanceInfo<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">,</span> leaseDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        gMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lease<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">// InstanceStatus</span>\n        registrant<span class=\"token punctuation\">.</span><span class=\"token function\">setActionType</span><span class=\"token punctuation\">(</span>ActionType<span class=\"token punctuation\">.</span>ADDED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        registrant<span class=\"token punctuation\">.</span><span class=\"token function\">setLastUpdatedTimestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\" spellcheck=\"true\">//ResponseCacheImpl Eureka  readOnlyCacheMap() readWriteCacheMap()</span>\n        <span class=\"token function\">invalidateCache</span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getAppName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getVIPAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureVipAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> \n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ol>\n<li>()<code>DiscoveryClient#initScheduledTasks()</code></li>\n<li><code>AbstractInstanceRegistry#renew()</code></li>\n</ol>\n<pre class=\" language-java\"><code class=\"language-java\">scheduler<span class=\"token punctuation\">.</span><span class=\"token function\">schedule</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">new</span> <span class=\"token class-name\">TimedSupervisorTask</span><span class=\"token punctuation\">(</span>\n                            <span class=\"token string\">\"heartbeat\"</span><span class=\"token punctuation\">,</span>\n                            scheduler<span class=\"token punctuation\">,</span>\n                            heartbeatExecutor<span class=\"token punctuation\">,</span>\n                            renewalIntervalInSecs<span class=\"token punctuation\">,</span>\n                            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">,</span>\n                            expBackOffBound<span class=\"token punctuation\">,</span>\n                            <span class=\"token comment\" spellcheck=\"true\">//</span>\n                            <span class=\"token keyword\">new</span> <span class=\"token class-name\">HeartbeatThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nrenewalIntervalInSecs<span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>30</p>\n<p>eureka.client.registry-fetch-interval-seconds=3030</p>\n<p>Eureka  Eureka </p>\n<p><code>DiscoveryClient#initScheduledTasks()</code></p>\n<pre><code>if (clientConfig.shouldFetchRegistry()) {\n    int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();\n    int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();\n    scheduler.schedule(\n            new TimedSupervisorTask(\n                    &quot;cacheRefresh&quot;,\n                    scheduler,\n                    cacheRefreshExecutor,\n                    registryFetchIntervalSeconds,\n                    TimeUnit.SECONDS,\n                    expBackOffBound,\n                    new CacheRefreshThread()\n            ),\n            registryFetchIntervalSeconds, TimeUnit.SECONDS);\n}\n</code></pre><p>HashCodeHashCode</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AAAA</p>\n<p><strong></strong>1585%EurekaEureka Server</p>\n<p><strong></strong> </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><img src=\"/2021/01/01/springcloud-1/1.png\" alt></p>\n<ul>\n<li>EurekaEurekaIP</li>\n<li>EurekaEureka</li>\n<li>EurekaEurekaEureka</li>\n<li>Eureka</li>\n<li>Eureka</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>LeaseManagerLeaseManager</p>\n<pre><code class=\"java\">public interface LeaseManager&lt;T&gt; {\n    //\n    void register(T r, int leaseDuration, boolean isReplication);\n    //\n    boolean cancel(String appName, String id, boolean isReplication);\n    //\n    boolean renew(String appName, String id, boolean isReplication);\n    //\n    void evict();\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><code>DiscoveryClient#register()</code>RESTHTTP<code>InstanceInfo</code></li>\n<li>REST<code>AbstractInstanceRegistry#register()</code>ConcurrentHashMapMapkeyspring.application.namekeyIdeureka.instance.instanceIdValueLease</li>\n</ol>\n<pre><code class=\"java\"># DiscoveryClient#register()\nboolean register() throws Throwable {\n    logger.info(PREFIX + &quot;{}: registering service...&quot;, appPathIdentifier);\n    EurekaHttpResponse&lt;Void&gt; httpResponse;\n    try {\n        //instanceInfo\n        //,REST\n        httpResponse = eurekaTransport.registrationClient.register(instanceInfo);\n    } catch (Exception e) {\n        //....\n    }\n    // ...\n    return httpResponse.getStatusCode() == 204;\n}\n\n// ----------------------------------------------------------------\n\n//\nConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry\n            = new ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();\n\n\npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n    try { \n        // registry \n        Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());\n        REGISTER.increment(isReplication);\n        if (gMap == null) {\n            // Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;  registry \n        }\n        // ID  Lease\n        Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());\n\n        if (existingLease != null &amp;&amp; (existingLease.getHolder() != null)) {\n            // Lease \n            //\n        } else {\n              //\n        }\n        // Lease  Map \n        Lease&lt;InstanceInfo&gt; lease = new Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);\n        gMap.put(registrant.getId(), lease);\n\n        // InstanceStatus\n        registrant.setActionType(ActionType.ADDED);\n\n        //\n        registrant.setLastUpdatedTimestamp();\n\n        //ResponseCacheImpl Eureka  readOnlyCacheMap() readWriteCacheMap()\n        invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n    } \n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<ol>\n<li>()<code>DiscoveryClient#initScheduledTasks()</code></li>\n<li><code>AbstractInstanceRegistry#renew()</code></li>\n</ol>\n<pre><code class=\"java\">scheduler.schedule(\n                    new TimedSupervisorTask(\n                            &quot;heartbeat&quot;,\n                            scheduler,\n                            heartbeatExecutor,\n                            renewalIntervalInSecs,\n                            TimeUnit.SECONDS,\n                            expBackOffBound,\n                            //\n                            new HeartbeatThread()\n                    ),\nrenewalIntervalInSecs, TimeUnit.SECONDS);</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>30</p>\n<p>eureka.client.registry-fetch-interval-seconds=3030</p>\n<p>Eureka  Eureka </p>\n<p><code>DiscoveryClient#initScheduledTasks()</code></p>\n<pre><code>if (clientConfig.shouldFetchRegistry()) {\n    int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();\n    int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();\n    scheduler.schedule(\n            new TimedSupervisorTask(\n                    &quot;cacheRefresh&quot;,\n                    scheduler,\n                    cacheRefreshExecutor,\n                    registryFetchIntervalSeconds,\n                    TimeUnit.SECONDS,\n                    expBackOffBound,\n                    new CacheRefreshThread()\n            ),\n            registryFetchIntervalSeconds, TimeUnit.SECONDS);\n}\n</code></pre><p>HashCodeHashCode</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>AAAA</p>\n<p><strong></strong>1585%EurekaEureka Server</p>\n<p><strong></strong> </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n"},{"title":"SpringCloud","description":"SpringCloud","date":"2021-01-02T07:46:34.000Z","_content":"### Eureka \n\n :\n\n1. \n2. \n\nEureka ServerEureka ClientRibbon\n\n- Eureka Server 30eureka.server.response-cache-update-interval-ms180\n- Eureka ClientCacheRefreshThread  Eureka Server 30eureka.client.registry-fetch-interval-seconds\n- Ribbonribbon.ServerListRefreshInterval\n\n#### ****\n\nEureka ClientEureka Server`ConcurrentHashMap`Eureka Server``ResponseCacheImpl\n\n- readOnlyCacheMapConcurrentHashMap\n- readWriteCacheMapguavaCache\n\n****\n\n(`Eureka Client`)`readWriteCacheMap`\n\n```java\n// AbstractInstanceRegistry\n// \npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n\ttry{\n\t\t......\n\t\tinvalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n\t\t......\n\t}finally {\n       read.unlock();\n    }\n}\nprivate void invalidateCache(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress) {\n    responseCache.invalidate(appName, vipAddress, secureVipAddress);\n}\n\n// ResponseCacheImpl\npublic void invalidate(Key... keys) {\n    for (Key key : keys) {\n        readWriteCacheMap.invalidate(key);\n        ......\n        for (Key keysWithRegion : keysWithRegions) {\n            readWriteCacheMap.invalidate(keysWithRegion);\n        }\n        ......\n    }\n}\n```\n\n****\n\nshouldUseReadOnlyResponseCacheeureka.server.use-read-only-response-cachetrue30seureka.server.response-cache-update-interval-ms`readWriteCacheMap``readOnlyCacheMap`\n\n```java\nResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //    \n     if (shouldUseReadOnlyResponseCache) {\n         timer.schedule(getCacheUpdateTask(),\n                 new Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)\n                         + responseCacheUpdateIntervalMs),\n                 responseCacheUpdateIntervalMs);\n     }\n}\n\nprivate TimerTask getCacheUpdateTask() {\n    return new TimerTask() {\n        @Override\n        public void run() {\n            logger.debug(\"Updating the client cache from response cache\");\n            for (Key key : readOnlyCacheMap.keySet()) {\n                if (logger.isDebugEnabled()) {\n                    logger.debug(\"Updating the client cache from response cache for key : {} {} {} {}\",\n                            key.getEntityType(), key.getName(), key.getVersion(), key.getType());\n                }\n                try {\n                    CurrentRequestVersion.set(key.getVersion());\n                    Value cacheValue = readWriteCacheMap.get(key);\n                    Value currentCacheValue = readOnlyCacheMap.get(key);\n                    if (cacheValue != currentCacheValue) {\n                        readOnlyCacheMap.put(key, cacheValue);\n                    }\n                } catch (Throwable th) {\n                    logger.error(\"Error while updating the client cache from response cache for key {}\", key.toStringCompact(), th);\n                }\n            }\n        }\n    };\n}\n```\n\n****\n\n`readWriteCacheMap`180SResponseCacheAutoExpirationInSecondseureka.server.response-cache-auto-expiration-in-seconds=180\n\n```java\nResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //guava\n   this.readWriteCacheMap =\n           CacheBuilder.newBuilder().initialCapacity(serverConfig.getInitialCapacityOfResponseCache())\n                   .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)\n                   .removalListener(new RemovalListener<Key, Value>() {\n                       @Override\n                       public void onRemoval(RemovalNotification<Key, Value> notification) {\n                           Key removedKey = notification.getKey();\n                           if (removedKey.hasRegions()) {\n                               Key cloneWithNoRegions = removedKey.cloneWithoutRegions();\n                               regionSpecificKeys.remove(cloneWithNoRegions, removedKey);\n                           }\n                       }\n                   })\n                   .build(new CacheLoader<Key, Value>() {\n                       @Override\n                       public Value load(Key key) throws Exception {\n                           if (key.hasRegions()) {\n                               Key cloneWithNoRegions = key.cloneWithoutRegions();\n                               regionSpecificKeys.put(cloneWithNoRegions, key);\n                           }\n                           Value value = generatePayload(key);\n                           return value;\n                       }\n                   });\n\n}\n```\n\n**Eureka Client**\n\nEureka Client  Client\n\n#### ****\n\nEureka ClientClientDiscoveryClient.initScheduledTasks()CacheRefreshThread Eureka Server 30Seureka.client.registry-fetch-interval-seconds\n\nEureka Client\n\n1. \n2. CacheRefreshThreadhashcode\n\n#### **Ribbon **\n\nRibbonEureka ClientServerListUpdater  Ribbon PollingServerListUpdater 30 ribbon.ServerListRefreshInterval\n\nRibbon\n\n- ILoadBalancer\n- IRule\n- ServerList\n- ServerListFilter\n- ServerListUpdater\n- IPing\n\n### FeginHystrixRibbon\n\n![FeginHystrixRibbon](springcloud-2/1.png)\n\n- Ribbon`ribbon.ReadTimeout ` `ribbon.ConnectTimeout`\n- Hyxstrix`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds`\n- Fegin`feign.client.config.default.connectTimeout``feign.client.config.default.connectTimeout`**RibbonRibbonFegin**\n- RibbonHystrixRibbon `Hystrix > Ribbon() * (ribbon.ReadTimeout + ribbon.ConnectTimeout)`\n\nRibbon``  ``Ribbon\n$$\n1 + ribbon.MaxAutoRetries  +  ribbon.MaxAutoRetriesNextServer\n$$\n\n```yml\nribbon:\n  eager-load:\n    enabled: true\n  #1\n  MaxAutoRetries: 1\n  #1\n  MaxAutoRetriesNextServer: 1\n  #true\n  OkToRetryOnAllOperations: true\n  #20002\n  ServerListRefreshInterval: 2000\n  #Apache HttpClient\n  ConnectTimeout: 3000\n  #Apache HttpClient\n  ReadTimeout: 3000\n```\n\n### Fegin\n\n#### Fegin\n\nEureka Client```` Spring Cloud Open Feign  API  API \n\n```java\n//APIMaven\n@FeignClient(name = \"user-service\")\npublic interface UserFeignRemoteClient {\n\t@GetMapping(\"/user/get\")\n\tpublic User getUser(@RequestParam(\"id\") Long id);\n}\n\n\n//\n@RestController\npublic class UserController implements UserFeignRemoteClient{\n\t@Override\n\tpublic User getUser(@RequestParam(\"id\") Long id){\n\t\tSystem.out.println(\"\");\n\t}\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;\n```\n\n Spring Cloud Open Feign  UserServiceUserService  API \n\n```java\npublic interface UserService {\n\t@GetMapping(\"/user/get\")\n\tpublic User getUser(@RequestParam(\"id\") Long id);\n}\n\n//APIMaven\n@FeignClient(name = \"user-service\")\npublic interface UserFeignRemoteClient extends UserService{\n\t\n}\n\n//\n@RestController\npublic class UserController implements UserService{\n\t@Override\n\tpublic User getUser(@RequestParam(\"id\") Long id){\n\t\tSystem.out.println(\"\");\n\t}\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;\n```\n\n#### Fegin\n\nFegin`@SpringQueryMap`\n\n```java\n@RestController\npublic class UserController implements UserService{\n\t@Override\n\tpublic User getUser(@SpringQueryMap StudentRequest studentRequest){\n\t\tSystem.out.println(\"\");\n\t}\n}\npublic class StudentRequest{\n\tprivate Long id;\n\tprivate String name;\n}\n```\n\n#### Feign\n\nABABFegin\n\n```java\n@Configuration\npublic class FeignInterceptorConfig {\n\t@Bean\n\tpublic RequestInterceptor requestInterceptor() {\n\t\tRequestInterceptor requestInterceptor = new RequestInterceptor() {\n\n\t\t\t@Override\n\t\t\tpublic void apply(RequestTemplate template) {\n\t\t\t\t//token\n\t\t\t\t//feign clientaccessToken header \n\t\t\t\t//config.anyRequest().permitAll() token\n\t\t\t\tif(StringUtils.isNotBlank(TokenUtil.getToken())){\n\t\t\t\t\ttemplate.header(UaaConstant.TOKEN_HEADER, TokenUtil.getToken() );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\treturn requestInterceptor;\n\t}\n}\n```\n\n","source":"_posts/springcloud-2.md","raw":"---\ntitle: SpringCloud\ntags:\n  - SpringCloud\ncategories: SpringCloud\ndescription : SpringCloud\ndate: 2021-01-02 15:46:34\n---\n### Eureka \n\n :\n\n1. \n2. \n\nEureka ServerEureka ClientRibbon\n\n- Eureka Server 30eureka.server.response-cache-update-interval-ms180\n- Eureka ClientCacheRefreshThread  Eureka Server 30eureka.client.registry-fetch-interval-seconds\n- Ribbonribbon.ServerListRefreshInterval\n\n#### ****\n\nEureka ClientEureka Server`ConcurrentHashMap`Eureka Server``ResponseCacheImpl\n\n- readOnlyCacheMapConcurrentHashMap\n- readWriteCacheMapguavaCache\n\n****\n\n(`Eureka Client`)`readWriteCacheMap`\n\n```java\n// AbstractInstanceRegistry\n// \npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n\ttry{\n\t\t......\n\t\tinvalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n\t\t......\n\t}finally {\n       read.unlock();\n    }\n}\nprivate void invalidateCache(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress) {\n    responseCache.invalidate(appName, vipAddress, secureVipAddress);\n}\n\n// ResponseCacheImpl\npublic void invalidate(Key... keys) {\n    for (Key key : keys) {\n        readWriteCacheMap.invalidate(key);\n        ......\n        for (Key keysWithRegion : keysWithRegions) {\n            readWriteCacheMap.invalidate(keysWithRegion);\n        }\n        ......\n    }\n}\n```\n\n****\n\nshouldUseReadOnlyResponseCacheeureka.server.use-read-only-response-cachetrue30seureka.server.response-cache-update-interval-ms`readWriteCacheMap``readOnlyCacheMap`\n\n```java\nResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //    \n     if (shouldUseReadOnlyResponseCache) {\n         timer.schedule(getCacheUpdateTask(),\n                 new Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)\n                         + responseCacheUpdateIntervalMs),\n                 responseCacheUpdateIntervalMs);\n     }\n}\n\nprivate TimerTask getCacheUpdateTask() {\n    return new TimerTask() {\n        @Override\n        public void run() {\n            logger.debug(\"Updating the client cache from response cache\");\n            for (Key key : readOnlyCacheMap.keySet()) {\n                if (logger.isDebugEnabled()) {\n                    logger.debug(\"Updating the client cache from response cache for key : {} {} {} {}\",\n                            key.getEntityType(), key.getName(), key.getVersion(), key.getType());\n                }\n                try {\n                    CurrentRequestVersion.set(key.getVersion());\n                    Value cacheValue = readWriteCacheMap.get(key);\n                    Value currentCacheValue = readOnlyCacheMap.get(key);\n                    if (cacheValue != currentCacheValue) {\n                        readOnlyCacheMap.put(key, cacheValue);\n                    }\n                } catch (Throwable th) {\n                    logger.error(\"Error while updating the client cache from response cache for key {}\", key.toStringCompact(), th);\n                }\n            }\n        }\n    };\n}\n```\n\n****\n\n`readWriteCacheMap`180SResponseCacheAutoExpirationInSecondseureka.server.response-cache-auto-expiration-in-seconds=180\n\n```java\nResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //guava\n   this.readWriteCacheMap =\n           CacheBuilder.newBuilder().initialCapacity(serverConfig.getInitialCapacityOfResponseCache())\n                   .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)\n                   .removalListener(new RemovalListener<Key, Value>() {\n                       @Override\n                       public void onRemoval(RemovalNotification<Key, Value> notification) {\n                           Key removedKey = notification.getKey();\n                           if (removedKey.hasRegions()) {\n                               Key cloneWithNoRegions = removedKey.cloneWithoutRegions();\n                               regionSpecificKeys.remove(cloneWithNoRegions, removedKey);\n                           }\n                       }\n                   })\n                   .build(new CacheLoader<Key, Value>() {\n                       @Override\n                       public Value load(Key key) throws Exception {\n                           if (key.hasRegions()) {\n                               Key cloneWithNoRegions = key.cloneWithoutRegions();\n                               regionSpecificKeys.put(cloneWithNoRegions, key);\n                           }\n                           Value value = generatePayload(key);\n                           return value;\n                       }\n                   });\n\n}\n```\n\n**Eureka Client**\n\nEureka Client  Client\n\n#### ****\n\nEureka ClientClientDiscoveryClient.initScheduledTasks()CacheRefreshThread Eureka Server 30Seureka.client.registry-fetch-interval-seconds\n\nEureka Client\n\n1. \n2. CacheRefreshThreadhashcode\n\n#### **Ribbon **\n\nRibbonEureka ClientServerListUpdater  Ribbon PollingServerListUpdater 30 ribbon.ServerListRefreshInterval\n\nRibbon\n\n- ILoadBalancer\n- IRule\n- ServerList\n- ServerListFilter\n- ServerListUpdater\n- IPing\n\n### FeginHystrixRibbon\n\n![FeginHystrixRibbon](springcloud-2/1.png)\n\n- Ribbon`ribbon.ReadTimeout ` `ribbon.ConnectTimeout`\n- Hyxstrix`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds`\n- Fegin`feign.client.config.default.connectTimeout``feign.client.config.default.connectTimeout`**RibbonRibbonFegin**\n- RibbonHystrixRibbon `Hystrix > Ribbon() * (ribbon.ReadTimeout + ribbon.ConnectTimeout)`\n\nRibbon``  ``Ribbon\n$$\n1 + ribbon.MaxAutoRetries  +  ribbon.MaxAutoRetriesNextServer\n$$\n\n```yml\nribbon:\n  eager-load:\n    enabled: true\n  #1\n  MaxAutoRetries: 1\n  #1\n  MaxAutoRetriesNextServer: 1\n  #true\n  OkToRetryOnAllOperations: true\n  #20002\n  ServerListRefreshInterval: 2000\n  #Apache HttpClient\n  ConnectTimeout: 3000\n  #Apache HttpClient\n  ReadTimeout: 3000\n```\n\n### Fegin\n\n#### Fegin\n\nEureka Client```` Spring Cloud Open Feign  API  API \n\n```java\n//APIMaven\n@FeignClient(name = \"user-service\")\npublic interface UserFeignRemoteClient {\n\t@GetMapping(\"/user/get\")\n\tpublic User getUser(@RequestParam(\"id\") Long id);\n}\n\n\n//\n@RestController\npublic class UserController implements UserFeignRemoteClient{\n\t@Override\n\tpublic User getUser(@RequestParam(\"id\") Long id){\n\t\tSystem.out.println(\"\");\n\t}\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;\n```\n\n Spring Cloud Open Feign  UserServiceUserService  API \n\n```java\npublic interface UserService {\n\t@GetMapping(\"/user/get\")\n\tpublic User getUser(@RequestParam(\"id\") Long id);\n}\n\n//APIMaven\n@FeignClient(name = \"user-service\")\npublic interface UserFeignRemoteClient extends UserService{\n\t\n}\n\n//\n@RestController\npublic class UserController implements UserService{\n\t@Override\n\tpublic User getUser(@RequestParam(\"id\") Long id){\n\t\tSystem.out.println(\"\");\n\t}\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;\n```\n\n#### Fegin\n\nFegin`@SpringQueryMap`\n\n```java\n@RestController\npublic class UserController implements UserService{\n\t@Override\n\tpublic User getUser(@SpringQueryMap StudentRequest studentRequest){\n\t\tSystem.out.println(\"\");\n\t}\n}\npublic class StudentRequest{\n\tprivate Long id;\n\tprivate String name;\n}\n```\n\n#### Feign\n\nABABFegin\n\n```java\n@Configuration\npublic class FeignInterceptorConfig {\n\t@Bean\n\tpublic RequestInterceptor requestInterceptor() {\n\t\tRequestInterceptor requestInterceptor = new RequestInterceptor() {\n\n\t\t\t@Override\n\t\t\tpublic void apply(RequestTemplate template) {\n\t\t\t\t//token\n\t\t\t\t//feign clientaccessToken header \n\t\t\t\t//config.anyRequest().permitAll() token\n\t\t\t\tif(StringUtils.isNotBlank(TokenUtil.getToken())){\n\t\t\t\t\ttemplate.header(UaaConstant.TOKEN_HEADER, TokenUtil.getToken() );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\treturn requestInterceptor;\n\t}\n}\n```\n\n","slug":"springcloud-2","published":1,"updated":"2021-04-08T00:47:07.037Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhvz0046qwv22hrf25le","content":"<h3 id=\"Eureka-\"><a href=\"#Eureka-\" class=\"headerlink\" title=\"Eureka \"></a>Eureka </h3><p> :</p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n<p>Eureka ServerEureka ClientRibbon</p>\n<ul>\n<li>Eureka Server 30eureka.server.response-cache-update-interval-ms180</li>\n<li>Eureka ClientCacheRefreshThread  Eureka Server 30eureka.client.registry-fetch-interval-seconds</li>\n<li>Ribbonribbon.ServerListRefreshInterval</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>Eureka ClientEureka Server<code>ConcurrentHashMap</code>Eureka Server<code></code>ResponseCacheImpl</p>\n<ul>\n<li>readOnlyCacheMapConcurrentHashMap</li>\n<li>readWriteCacheMapguavaCache</li>\n</ul>\n<p><strong></strong></p>\n<p>(<code>Eureka Client</code>)<code>readWriteCacheMap</code></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">// AbstractInstanceRegistry</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>InstanceInfo registrant<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> leaseDuration<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isReplication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token function\">invalidateCache</span><span class=\"token punctuation\">(</span>registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getAppName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getVIPAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> registrant<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureVipAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n       read<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">invalidateCache</span><span class=\"token punctuation\">(</span>String appName<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> String vipAddress<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> String secureVipAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    responseCache<span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span>appName<span class=\"token punctuation\">,</span> vipAddress<span class=\"token punctuation\">,</span> secureVipAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// ResponseCacheImpl</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span>Key<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> keys<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Key key <span class=\"token operator\">:</span> keys<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        readWriteCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Key keysWithRegion <span class=\"token operator\">:</span> keysWithRegions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            readWriteCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span>keysWithRegion<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong></strong></p>\n<p>shouldUseReadOnlyResponseCacheeureka.server.use-read-only-response-cachetrue30seureka.server.response-cache-update-interval-ms<code>readWriteCacheMap</code><code>readOnlyCacheMap</code></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token function\">ResponseCacheImpl</span><span class=\"token punctuation\">(</span>EurekaServerConfig serverConfig<span class=\"token punctuation\">,</span> ServerCodecs serverCodecs<span class=\"token punctuation\">,</span> AbstractInstanceRegistry registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//    </span>\n     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldUseReadOnlyResponseCache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         timer<span class=\"token punctuation\">.</span><span class=\"token function\">schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">getCacheUpdateTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                 <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> responseCacheUpdateIntervalMs<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> responseCacheUpdateIntervalMs<span class=\"token punctuation\">)</span>\n                         <span class=\"token operator\">+</span> responseCacheUpdateIntervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                 responseCacheUpdateIntervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> TimerTask <span class=\"token function\">getCacheUpdateTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TimerTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Updating the client cache from response cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Key key <span class=\"token operator\">:</span> readOnlyCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Updating the client cache from response cache for key : {} {} {} {}\"</span><span class=\"token punctuation\">,</span>\n                            key<span class=\"token punctuation\">.</span><span class=\"token function\">getEntityType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">getType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    CurrentRequestVersion<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    Value cacheValue <span class=\"token operator\">=</span> readWriteCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    Value currentCacheValue <span class=\"token operator\">=</span> readOnlyCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheValue <span class=\"token operator\">!=</span> currentCacheValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        readOnlyCacheMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> cacheValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> th<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    logger<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error while updating the client cache from response cache for key {}\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">toStringCompact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> th<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong></strong></p>\n<p><code>readWriteCacheMap</code>180SResponseCacheAutoExpirationInSecondseureka.server.response-cache-auto-expiration-in-seconds=180</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token function\">ResponseCacheImpl</span><span class=\"token punctuation\">(</span>EurekaServerConfig serverConfig<span class=\"token punctuation\">,</span> ServerCodecs serverCodecs<span class=\"token punctuation\">,</span> AbstractInstanceRegistry registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//guava</span>\n   <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>readWriteCacheMap <span class=\"token operator\">=</span>\n           CacheBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialCapacity</span><span class=\"token punctuation\">(</span>serverConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialCapacityOfResponseCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">.</span><span class=\"token function\">expireAfterWrite</span><span class=\"token punctuation\">(</span>serverConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getResponseCacheAutoExpirationInSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">.</span><span class=\"token function\">removalListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RemovalListener</span><span class=\"token operator\">&lt;</span>Key<span class=\"token punctuation\">,</span> Value<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                       <span class=\"token annotation punctuation\">@Override</span>\n                       <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onRemoval</span><span class=\"token punctuation\">(</span>RemovalNotification<span class=\"token operator\">&lt;</span>Key<span class=\"token punctuation\">,</span> Value<span class=\"token operator\">></span> notification<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                           Key removedKey <span class=\"token operator\">=</span> notification<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>removedKey<span class=\"token punctuation\">.</span><span class=\"token function\">hasRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                               Key cloneWithNoRegions <span class=\"token operator\">=</span> removedKey<span class=\"token punctuation\">.</span><span class=\"token function\">cloneWithoutRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                               regionSpecificKeys<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>cloneWithNoRegions<span class=\"token punctuation\">,</span> removedKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                           <span class=\"token punctuation\">}</span>\n                       <span class=\"token punctuation\">}</span>\n                   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CacheLoader</span><span class=\"token operator\">&lt;</span>Key<span class=\"token punctuation\">,</span> Value<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                       <span class=\"token annotation punctuation\">@Override</span>\n                       <span class=\"token keyword\">public</span> Value <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>Key key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n                           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">hasRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                               Key cloneWithNoRegions <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">cloneWithoutRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                               regionSpecificKeys<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>cloneWithNoRegions<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                           <span class=\"token punctuation\">}</span>\n                           Value value <span class=\"token operator\">=</span> <span class=\"token function\">generatePayload</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                           <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n                       <span class=\"token punctuation\">}</span>\n                   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>Eureka Client</strong></p>\n<p>Eureka Client  Client</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>Eureka ClientClientDiscoveryClient.initScheduledTasks()CacheRefreshThread Eureka Server 30Seureka.client.registry-fetch-interval-seconds</p>\n<p>Eureka Client</p>\n<ol>\n<li></li>\n<li>CacheRefreshThreadhashcode</li>\n</ol>\n<h4 id=\"Ribbon-\"><a href=\"#Ribbon-\" class=\"headerlink\" title=\"Ribbon \"></a><strong>Ribbon </strong></h4><p>RibbonEureka ClientServerListUpdater  Ribbon PollingServerListUpdater 30 ribbon.ServerListRefreshInterval</p>\n<p>Ribbon</p>\n<ul>\n<li>ILoadBalancer</li>\n<li>IRule</li>\n<li>ServerList</li>\n<li>ServerListFilter</li>\n<li>ServerListUpdater</li>\n<li>IPing</li>\n</ul>\n<h3 id=\"FeginHystrixRibbon\"><a href=\"#FeginHystrixRibbon\" class=\"headerlink\" title=\"FeginHystrixRibbon\"></a>FeginHystrixRibbon</h3><p><img src=\"/2021/01/02/springcloud-2/1.png\" alt=\"FeginHystrixRibbon\"></p>\n<ul>\n<li>Ribbon<code>ribbon.ReadTimeout</code> <code>ribbon.ConnectTimeout</code></li>\n<li>Hyxstrix<code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code></li>\n<li>Fegin<code>feign.client.config.default.connectTimeout</code><code>feign.client.config.default.connectTimeout</code><strong>RibbonRibbonFegin</strong></li>\n<li>RibbonHystrixRibbon <code>Hystrix &gt; Ribbon() * (ribbon.ReadTimeout + ribbon.ConnectTimeout)</code></li>\n</ul>\n<p>Ribbon<code></code>  <code></code>Ribbon<br>$$<br>1 + ribbon.MaxAutoRetries  +  ribbon.MaxAutoRetriesNextServer<br>$$</p>\n<pre class=\" language-yml\"><code class=\"language-yml\">ribbon:\n  eager-load:\n    enabled: true\n  #1\n  MaxAutoRetries: 1\n  #1\n  MaxAutoRetriesNextServer: 1\n  #true\n  OkToRetryOnAllOperations: true\n  #20002\n  ServerListRefreshInterval: 2000\n  #Apache HttpClient\n  ConnectTimeout: 3000\n  #Apache HttpClient\n  ReadTimeout: 3000</code></pre>\n<h3 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h3><h4 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h4><p>Eureka Client<code></code><code></code> Spring Cloud Open Feign  API  API </p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//APIMaven</span>\n<span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user-service\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserFeignRemoteClient</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user/get\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> User <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> Long id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">UserFeignRemoteClient</span><span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> User <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> Long id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@Autowired</span>\n<span class=\"token keyword\">private</span> UserFeignRemoteClient userFeignRemoteClient<span class=\"token punctuation\">;</span></code></pre>\n<p> Spring Cloud Open Feign  UserServiceUserService  API </p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user/get\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> User <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> Long id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//APIMaven</span>\n<span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user-service\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserFeignRemoteClient</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">UserService</span><span class=\"token punctuation\">{</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">UserService</span><span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> User <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> Long id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token annotation punctuation\">@Autowired</span>\n<span class=\"token keyword\">private</span> UserFeignRemoteClient userFeignRemoteClient<span class=\"token punctuation\">;</span></code></pre>\n<h4 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h4><p>Fegin<code>@SpringQueryMap</code></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">UserService</span><span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> User <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@SpringQueryMap</span> StudentRequest studentRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StudentRequest</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> Long id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h4 id=\"Feign\"><a href=\"#Feign\" class=\"headerlink\" title=\"Feign\"></a>Feign</h4><p>ABABFegin</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FeignInterceptorConfig</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> RequestInterceptor <span class=\"token function\">requestInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        RequestInterceptor requestInterceptor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RequestInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>RequestTemplate template<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\" spellcheck=\"true\">//token</span>\n                <span class=\"token comment\" spellcheck=\"true\">//feign clientaccessToken header </span>\n                <span class=\"token comment\" spellcheck=\"true\">//config.anyRequest().permitAll() token</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>StringUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isNotBlank</span><span class=\"token punctuation\">(</span>TokenUtil<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    template<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span>UaaConstant<span class=\"token punctuation\">.</span>TOKEN_HEADER<span class=\"token punctuation\">,</span> TokenUtil<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> requestInterceptor<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Eureka-\"><a href=\"#Eureka-\" class=\"headerlink\" title=\"Eureka \"></a>Eureka </h3><p> :</p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n<p>Eureka ServerEureka ClientRibbon</p>\n<ul>\n<li>Eureka Server 30eureka.server.response-cache-update-interval-ms180</li>\n<li>Eureka ClientCacheRefreshThread  Eureka Server 30eureka.client.registry-fetch-interval-seconds</li>\n<li>Ribbonribbon.ServerListRefreshInterval</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>Eureka ClientEureka Server<code>ConcurrentHashMap</code>Eureka Server<code></code>ResponseCacheImpl</p>\n<ul>\n<li>readOnlyCacheMapConcurrentHashMap</li>\n<li>readWriteCacheMapguavaCache</li>\n</ul>\n<p><strong></strong></p>\n<p>(<code>Eureka Client</code>)<code>readWriteCacheMap</code></p>\n<pre><code class=\"java\">// AbstractInstanceRegistry\n// \npublic void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n    try{\n        ......\n        invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n        ......\n    }finally {\n       read.unlock();\n    }\n}\nprivate void invalidateCache(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress) {\n    responseCache.invalidate(appName, vipAddress, secureVipAddress);\n}\n\n// ResponseCacheImpl\npublic void invalidate(Key... keys) {\n    for (Key key : keys) {\n        readWriteCacheMap.invalidate(key);\n        ......\n        for (Key keysWithRegion : keysWithRegions) {\n            readWriteCacheMap.invalidate(keysWithRegion);\n        }\n        ......\n    }\n}</code></pre>\n<p><strong></strong></p>\n<p>shouldUseReadOnlyResponseCacheeureka.server.use-read-only-response-cachetrue30seureka.server.response-cache-update-interval-ms<code>readWriteCacheMap</code><code>readOnlyCacheMap</code></p>\n<pre><code class=\"java\">ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //    \n     if (shouldUseReadOnlyResponseCache) {\n         timer.schedule(getCacheUpdateTask(),\n                 new Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)\n                         + responseCacheUpdateIntervalMs),\n                 responseCacheUpdateIntervalMs);\n     }\n}\n\nprivate TimerTask getCacheUpdateTask() {\n    return new TimerTask() {\n        @Override\n        public void run() {\n            logger.debug(&quot;Updating the client cache from response cache&quot;);\n            for (Key key : readOnlyCacheMap.keySet()) {\n                if (logger.isDebugEnabled()) {\n                    logger.debug(&quot;Updating the client cache from response cache for key : {} {} {} {}&quot;,\n                            key.getEntityType(), key.getName(), key.getVersion(), key.getType());\n                }\n                try {\n                    CurrentRequestVersion.set(key.getVersion());\n                    Value cacheValue = readWriteCacheMap.get(key);\n                    Value currentCacheValue = readOnlyCacheMap.get(key);\n                    if (cacheValue != currentCacheValue) {\n                        readOnlyCacheMap.put(key, cacheValue);\n                    }\n                } catch (Throwable th) {\n                    logger.error(&quot;Error while updating the client cache from response cache for key {}&quot;, key.toStringCompact(), th);\n                }\n            }\n        }\n    };\n}</code></pre>\n<p><strong></strong></p>\n<p><code>readWriteCacheMap</code>180SResponseCacheAutoExpirationInSecondseureka.server.response-cache-auto-expiration-in-seconds=180</p>\n<pre><code class=\"java\">ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) {\n    //guava\n   this.readWriteCacheMap =\n           CacheBuilder.newBuilder().initialCapacity(serverConfig.getInitialCapacityOfResponseCache())\n                   .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)\n                   .removalListener(new RemovalListener&lt;Key, Value&gt;() {\n                       @Override\n                       public void onRemoval(RemovalNotification&lt;Key, Value&gt; notification) {\n                           Key removedKey = notification.getKey();\n                           if (removedKey.hasRegions()) {\n                               Key cloneWithNoRegions = removedKey.cloneWithoutRegions();\n                               regionSpecificKeys.remove(cloneWithNoRegions, removedKey);\n                           }\n                       }\n                   })\n                   .build(new CacheLoader&lt;Key, Value&gt;() {\n                       @Override\n                       public Value load(Key key) throws Exception {\n                           if (key.hasRegions()) {\n                               Key cloneWithNoRegions = key.cloneWithoutRegions();\n                               regionSpecificKeys.put(cloneWithNoRegions, key);\n                           }\n                           Value value = generatePayload(key);\n                           return value;\n                       }\n                   });\n\n}</code></pre>\n<p><strong>Eureka Client</strong></p>\n<p>Eureka Client  Client</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h4><p>Eureka ClientClientDiscoveryClient.initScheduledTasks()CacheRefreshThread Eureka Server 30Seureka.client.registry-fetch-interval-seconds</p>\n<p>Eureka Client</p>\n<ol>\n<li></li>\n<li>CacheRefreshThreadhashcode</li>\n</ol>\n<h4 id=\"Ribbon-\"><a href=\"#Ribbon-\" class=\"headerlink\" title=\"Ribbon \"></a><strong>Ribbon </strong></h4><p>RibbonEureka ClientServerListUpdater  Ribbon PollingServerListUpdater 30 ribbon.ServerListRefreshInterval</p>\n<p>Ribbon</p>\n<ul>\n<li>ILoadBalancer</li>\n<li>IRule</li>\n<li>ServerList</li>\n<li>ServerListFilter</li>\n<li>ServerListUpdater</li>\n<li>IPing</li>\n</ul>\n<h3 id=\"FeginHystrixRibbon\"><a href=\"#FeginHystrixRibbon\" class=\"headerlink\" title=\"FeginHystrixRibbon\"></a>FeginHystrixRibbon</h3><p><img src=\"/2021/01/02/springcloud-2/1.png\" alt=\"FeginHystrixRibbon\"></p>\n<ul>\n<li>Ribbon<code>ribbon.ReadTimeout</code> <code>ribbon.ConnectTimeout</code></li>\n<li>Hyxstrix<code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code></li>\n<li>Fegin<code>feign.client.config.default.connectTimeout</code><code>feign.client.config.default.connectTimeout</code><strong>RibbonRibbonFegin</strong></li>\n<li>RibbonHystrixRibbon <code>Hystrix &gt; Ribbon() * (ribbon.ReadTimeout + ribbon.ConnectTimeout)</code></li>\n</ul>\n<p>Ribbon<code></code>  <code></code>Ribbon<br>$$<br>1 + ribbon.MaxAutoRetries  +  ribbon.MaxAutoRetriesNextServer<br>$$</p>\n<pre><code class=\"yml\">ribbon:\n  eager-load:\n    enabled: true\n  #1\n  MaxAutoRetries: 1\n  #1\n  MaxAutoRetriesNextServer: 1\n  #true\n  OkToRetryOnAllOperations: true\n  #20002\n  ServerListRefreshInterval: 2000\n  #Apache HttpClient\n  ConnectTimeout: 3000\n  #Apache HttpClient\n  ReadTimeout: 3000</code></pre>\n<h3 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h3><h4 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h4><p>Eureka Client<code></code><code></code> Spring Cloud Open Feign  API  API </p>\n<pre><code class=\"java\">//APIMaven\n@FeignClient(name = &quot;user-service&quot;)\npublic interface UserFeignRemoteClient {\n    @GetMapping(&quot;/user/get&quot;)\n    public User getUser(@RequestParam(&quot;id&quot;) Long id);\n}\n\n\n//\n@RestController\npublic class UserController implements UserFeignRemoteClient{\n    @Override\n    public User getUser(@RequestParam(&quot;id&quot;) Long id){\n        System.out.println(&quot;&quot;);\n    }\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;</code></pre>\n<p> Spring Cloud Open Feign  UserServiceUserService  API </p>\n<pre><code class=\"java\">public interface UserService {\n    @GetMapping(&quot;/user/get&quot;)\n    public User getUser(@RequestParam(&quot;id&quot;) Long id);\n}\n\n//APIMaven\n@FeignClient(name = &quot;user-service&quot;)\npublic interface UserFeignRemoteClient extends UserService{\n\n}\n\n//\n@RestController\npublic class UserController implements UserService{\n    @Override\n    public User getUser(@RequestParam(&quot;id&quot;) Long id){\n        System.out.println(&quot;&quot;);\n    }\n}\n\n//\n@Autowired\nprivate UserFeignRemoteClient userFeignRemoteClient;</code></pre>\n<h4 id=\"Fegin\"><a href=\"#Fegin\" class=\"headerlink\" title=\"Fegin\"></a>Fegin</h4><p>Fegin<code>@SpringQueryMap</code></p>\n<pre><code class=\"java\">@RestController\npublic class UserController implements UserService{\n    @Override\n    public User getUser(@SpringQueryMap StudentRequest studentRequest){\n        System.out.println(&quot;&quot;);\n    }\n}\npublic class StudentRequest{\n    private Long id;\n    private String name;\n}</code></pre>\n<h4 id=\"Feign\"><a href=\"#Feign\" class=\"headerlink\" title=\"Feign\"></a>Feign</h4><p>ABABFegin</p>\n<pre><code class=\"java\">@Configuration\npublic class FeignInterceptorConfig {\n    @Bean\n    public RequestInterceptor requestInterceptor() {\n        RequestInterceptor requestInterceptor = new RequestInterceptor() {\n\n            @Override\n            public void apply(RequestTemplate template) {\n                //token\n                //feign clientaccessToken header \n                //config.anyRequest().permitAll() token\n                if(StringUtils.isNotBlank(TokenUtil.getToken())){\n                    template.header(UaaConstant.TOKEN_HEADER, TokenUtil.getToken() );\n                }\n            }\n        };\n        return requestInterceptor;\n    }\n}</code></pre>\n"},{"title":"SpringMVC","description":"SpringMVC","date":"2020-01-03T16:00:20.000Z","_content":"## SpringMVC\n\n### \n\n-  DispatcherServlet\n- DispatcherServlet  HandlerMapping HandlerHandlerExecutionChainhandler\n-  Handler Controller  HandlerAdapter \n- HandlerAdapter  Handler \n-  ModelAndView Model View  View\n- ViewResolver  View  View\n- DispaterServlet  Model  View\n-  View \n<!--more-->\n### \n\n<font size=4 color=red>DispatcherServlet</font>\n\nSpringMVCSevletDispatcherServletHttpServletHttpServletdoGetdoPostDispatcherServletdoGetdoPost\n\n![](springmvc2/10.png)\n\n![](springmvc2/11.png)\n\n![](springmvc2/12.png)\n\nDispatcherServletdoDispatch\n\n```java\nprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\tHttpServletRequest processedRequest = request;\n\tHandlerExecutionChain mappedHandler = null;\n\tboolean multipartRequestParsed = false;\n\n\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n\ttry {\n\t\tModelAndView mv = null;\n\t\tException dispatchException = null;\n\n\t\ttry {\n\t\t\tprocessedRequest = checkMultipart(request);\n\t\t\tmultipartRequestParsed = (processedRequest != request);\n\n\t\t\t//DispatcherServlet  HandlerMapping Handler\n\t\t\tmappedHandler = getHandler(processedRequest);\n\t\t\tif (mappedHandler == null) {\n\t\t\t\tnoHandlerFound(processedRequest, response);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//  Handler Controller  HandlerAdapter \n\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\t\t\t\n\t\t\tString method = request.getMethod();\n\t\t\tboolean isGet = \"GET\".equals(method);\n\t\t\tif (isGet || \"HEAD\".equals(method)) {\n\t\t\t\tlong lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n\t\t\t\tif (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t//\n\t\t\tif (!mappedHandler.applyPreHandle(processedRequest, response)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// HandlerAdapter  Handler \n\t\t\t//  ModelAndView Model View  View\n\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t//\n\t\t\tapplyDefaultViewName(processedRequest, mv);\n\t\t\t//\n\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tdispatchException = ex;\n\t\t}\n\t\tcatch (Throwable err) {\n\t\t\t\n\t\t\tdispatchException = new NestedServletException(\"Handler dispatch failed\", err);\n\t\t}\n\t\t//\n\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n\t}\n\tcatch (Exception ex) {\n\t\t//\n\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n\t}\n\tcatch (Throwable err) {\n\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler,\n\t\t\t\tnew NestedServletException(\"Handler processing failed\", err));\n\t}\n\tfinally {\n\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t// \n\t\t\tif (mappedHandler != null) {\n\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// \n\t\t\tif (multipartRequestParsed) {\n\t\t\t\tcleanupMultipart(processedRequest);\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\n<font size=4 color=red>DispatcherServlet  HandlerMapping HandlerHandlerExecutionChain(Handler + HandlerInterceptor)</font>\n\nhandlerMappingsHandlerHandler +  HandlerExecutionChain\n\n![](springmvc2/13.png)\n\n<font size=4 color=red>HandlerHandlerAdapter</font>\n\nHandlerAdapter \n\n- boolean supports(Object handler)  -- handler\n- ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)  -- ModelAndView\n\n![](springmvc2/14.png)\n\nRequestMappingHandlerAdapterhandlerHandlerMethodhandler\n\n<font size=4 color=red>handler</font>\n\n3\n\n- **preHandle** - \n- **postHandle** - Controller ModelAndView \n- **afterCompletion** - \n\n```java\n//mappedHandler.applyPreHandle(processedRequest, response);\nboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\tHandlerInterceptor[] interceptors = getInterceptors(); //\n\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\tfor (int i = 0; i < interceptors.length; i++) {\n\t\t\tHandlerInterceptor interceptor = interceptors[i];\n             //\n\t\t\tif (!interceptor.preHandle(request, response, this.handler)) {\n\t\t\t\ttriggerAfterCompletion(request, response, null);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.interceptorIndex = i;\n\t\t}\n\t}\n\treturn true;\n}\n```\n\n<font size=4 color=red>HandlerAdapter()handlerModelAndView</font>\n\n```java\nmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n```\n\nRequestMappingHandlerAdapter\n\n![handler](springmvc2/15.png)\n\n![hanlderModelAndView](springmvc2/16.png)\n\n<font size=4 color=red></font>\n\n```\n//\napplyDefaultViewName(processedRequest, mv)\n//\nmappedHandler.applyPostHandle(processedRequest, response, mv)\n```\n\n<font size=4 color=red>ViewResolver</font>\n\n```java\n//\nprotected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tLocale locale = (this.localeResolver != null ? this.localeResolver.resolveLocale(request) : request.getLocale());\n\t\tresponse.setLocale(locale);\n\t\tView view;\n\t\tString viewName = mv.getViewName();\n\t\tif (viewName != null) {\n\t\t\t//view\n\t\t\tview = resolveViewName(viewName, mv.getModelInternal(), locale, request);\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"Could not resolve view with name '\" + mv.getViewName() +\n\t\t\t\t\t\t\"' in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tview = mv.getView();\n\t\t}\n\t\ttry {\n\t\t\tif (mv.getStatus() != null) {\n\t\t\t\tresponse.setStatus(mv.getStatus().value());\n\t\t\t}\n\t\t\t//\n\t\t\tview.render(mv.getModelInternal(), request, response);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Error rendering view [\" + view + \"]\", ex);\n\t\t\t}\n\t\t\tthrow ex;\n\t\t}\n}\n\nprotected View resolveViewName(String viewName, @Nullable Map<String, Object> model,\n\t\tLocale locale, HttpServletRequest request) throws Exception {\n\tif (this.viewResolvers != null) {\n\t\t//\n\t\tfor (ViewResolver viewResolver : this.viewResolvers) {\n\t\t\tView view = viewResolver.resolveViewName(viewName, locale);\n\t\t\tif (view != null) {\n\t\t\t\treturn view;\n\t\t\t}\n\t\t}\n\t}\n\treturn null;\n}\n```\n\n","source":"_posts/springmvc2.md","raw":"---\ntitle: SpringMVC\ntags:\n  - spring\ncategories: \n  - spring\ndescription : SpringMVC\ndate: 2020-01-04 00:00:20\n---\n## SpringMVC\n\n### \n\n-  DispatcherServlet\n- DispatcherServlet  HandlerMapping HandlerHandlerExecutionChainhandler\n-  Handler Controller  HandlerAdapter \n- HandlerAdapter  Handler \n-  ModelAndView Model View  View\n- ViewResolver  View  View\n- DispaterServlet  Model  View\n-  View \n<!--more-->\n### \n\n<font size=4 color=red>DispatcherServlet</font>\n\nSpringMVCSevletDispatcherServletHttpServletHttpServletdoGetdoPostDispatcherServletdoGetdoPost\n\n![](springmvc2/10.png)\n\n![](springmvc2/11.png)\n\n![](springmvc2/12.png)\n\nDispatcherServletdoDispatch\n\n```java\nprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\tHttpServletRequest processedRequest = request;\n\tHandlerExecutionChain mappedHandler = null;\n\tboolean multipartRequestParsed = false;\n\n\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n\ttry {\n\t\tModelAndView mv = null;\n\t\tException dispatchException = null;\n\n\t\ttry {\n\t\t\tprocessedRequest = checkMultipart(request);\n\t\t\tmultipartRequestParsed = (processedRequest != request);\n\n\t\t\t//DispatcherServlet  HandlerMapping Handler\n\t\t\tmappedHandler = getHandler(processedRequest);\n\t\t\tif (mappedHandler == null) {\n\t\t\t\tnoHandlerFound(processedRequest, response);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//  Handler Controller  HandlerAdapter \n\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\t\t\t\n\t\t\tString method = request.getMethod();\n\t\t\tboolean isGet = \"GET\".equals(method);\n\t\t\tif (isGet || \"HEAD\".equals(method)) {\n\t\t\t\tlong lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n\t\t\t\tif (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t//\n\t\t\tif (!mappedHandler.applyPreHandle(processedRequest, response)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// HandlerAdapter  Handler \n\t\t\t//  ModelAndView Model View  View\n\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t//\n\t\t\tapplyDefaultViewName(processedRequest, mv);\n\t\t\t//\n\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tdispatchException = ex;\n\t\t}\n\t\tcatch (Throwable err) {\n\t\t\t\n\t\t\tdispatchException = new NestedServletException(\"Handler dispatch failed\", err);\n\t\t}\n\t\t//\n\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n\t}\n\tcatch (Exception ex) {\n\t\t//\n\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n\t}\n\tcatch (Throwable err) {\n\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler,\n\t\t\t\tnew NestedServletException(\"Handler processing failed\", err));\n\t}\n\tfinally {\n\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t// \n\t\t\tif (mappedHandler != null) {\n\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// \n\t\t\tif (multipartRequestParsed) {\n\t\t\t\tcleanupMultipart(processedRequest);\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\n<font size=4 color=red>DispatcherServlet  HandlerMapping HandlerHandlerExecutionChain(Handler + HandlerInterceptor)</font>\n\nhandlerMappingsHandlerHandler +  HandlerExecutionChain\n\n![](springmvc2/13.png)\n\n<font size=4 color=red>HandlerHandlerAdapter</font>\n\nHandlerAdapter \n\n- boolean supports(Object handler)  -- handler\n- ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)  -- ModelAndView\n\n![](springmvc2/14.png)\n\nRequestMappingHandlerAdapterhandlerHandlerMethodhandler\n\n<font size=4 color=red>handler</font>\n\n3\n\n- **preHandle** - \n- **postHandle** - Controller ModelAndView \n- **afterCompletion** - \n\n```java\n//mappedHandler.applyPreHandle(processedRequest, response);\nboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\tHandlerInterceptor[] interceptors = getInterceptors(); //\n\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\tfor (int i = 0; i < interceptors.length; i++) {\n\t\t\tHandlerInterceptor interceptor = interceptors[i];\n             //\n\t\t\tif (!interceptor.preHandle(request, response, this.handler)) {\n\t\t\t\ttriggerAfterCompletion(request, response, null);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.interceptorIndex = i;\n\t\t}\n\t}\n\treturn true;\n}\n```\n\n<font size=4 color=red>HandlerAdapter()handlerModelAndView</font>\n\n```java\nmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n```\n\nRequestMappingHandlerAdapter\n\n![handler](springmvc2/15.png)\n\n![hanlderModelAndView](springmvc2/16.png)\n\n<font size=4 color=red></font>\n\n```\n//\napplyDefaultViewName(processedRequest, mv)\n//\nmappedHandler.applyPostHandle(processedRequest, response, mv)\n```\n\n<font size=4 color=red>ViewResolver</font>\n\n```java\n//\nprotected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tLocale locale = (this.localeResolver != null ? this.localeResolver.resolveLocale(request) : request.getLocale());\n\t\tresponse.setLocale(locale);\n\t\tView view;\n\t\tString viewName = mv.getViewName();\n\t\tif (viewName != null) {\n\t\t\t//view\n\t\t\tview = resolveViewName(viewName, mv.getModelInternal(), locale, request);\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"Could not resolve view with name '\" + mv.getViewName() +\n\t\t\t\t\t\t\"' in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tview = mv.getView();\n\t\t}\n\t\ttry {\n\t\t\tif (mv.getStatus() != null) {\n\t\t\t\tresponse.setStatus(mv.getStatus().value());\n\t\t\t}\n\t\t\t//\n\t\t\tview.render(mv.getModelInternal(), request, response);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Error rendering view [\" + view + \"]\", ex);\n\t\t\t}\n\t\t\tthrow ex;\n\t\t}\n}\n\nprotected View resolveViewName(String viewName, @Nullable Map<String, Object> model,\n\t\tLocale locale, HttpServletRequest request) throws Exception {\n\tif (this.viewResolvers != null) {\n\t\t//\n\t\tfor (ViewResolver viewResolver : this.viewResolvers) {\n\t\t\tView view = viewResolver.resolveViewName(viewName, locale);\n\t\t\tif (view != null) {\n\t\t\t\treturn view;\n\t\t\t}\n\t\t}\n\t}\n\treturn null;\n}\n```\n\n","slug":"springmvc2","published":1,"updated":"2021-04-08T00:47:07.057Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw00049qwv23866gmu1","content":"<h2 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li> DispatcherServlet</li>\n<li>DispatcherServlet  HandlerMapping HandlerHandlerExecutionChainhandler</li>\n<li> Handler Controller  HandlerAdapter </li>\n<li>HandlerAdapter  Handler </li>\n<li> ModelAndView Model View  View</li>\n<li>ViewResolver  View  View</li>\n<li>DispaterServlet  Model  View</li>\n<li> View <a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3></li>\n</ul>\n<p><font size=\"4\" color=\"red\">DispatcherServlet</font></p>\n<p>SpringMVCSevletDispatcherServletHttpServletHttpServletdoGetdoPostDispatcherServletdoGetdoPost</p>\n<p><img src=\"/2020/01/04/springmvc2/10.png\" alt></p>\n<p><img src=\"/2020/01/04/springmvc2/11.png\" alt></p>\n<p><img src=\"/2020/01/04/springmvc2/12.png\" alt></p>\n<p>DispatcherServletdoDispatch</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doDispatch</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">,</span> HttpServletResponse response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    HttpServletRequest processedRequest <span class=\"token operator\">=</span> request<span class=\"token punctuation\">;</span>\n    HandlerExecutionChain mappedHandler <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> multipartRequestParsed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    WebAsyncManager asyncManager <span class=\"token operator\">=</span> WebAsyncUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getAsyncManager</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        ModelAndView mv <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n        Exception dispatchException <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            processedRequest <span class=\"token operator\">=</span> <span class=\"token function\">checkMultipart</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            multipartRequestParsed <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>processedRequest <span class=\"token operator\">!=</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\" spellcheck=\"true\">//DispatcherServlet  HandlerMapping Handler</span>\n            mappedHandler <span class=\"token operator\">=</span> <span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappedHandler <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">noHandlerFound</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\" spellcheck=\"true\">//  Handler Controller  HandlerAdapter </span>\n            HandlerAdapter ha <span class=\"token operator\">=</span> <span class=\"token function\">getHandlerAdapter</span><span class=\"token punctuation\">(</span>mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n            String method <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">boolean</span> isGet <span class=\"token operator\">=</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isGet <span class=\"token operator\">||</span> <span class=\"token string\">\"HEAD\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">long</span> lastModified <span class=\"token operator\">=</span> ha<span class=\"token punctuation\">.</span><span class=\"token function\">getLastModified</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ServletWebRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkNotModified</span><span class=\"token punctuation\">(</span>lastModified<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> isGet<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">applyPreHandle</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\" spellcheck=\"true\">// HandlerAdapter  Handler </span>\n            <span class=\"token comment\" spellcheck=\"true\">//  ModelAndView Model View  View</span>\n            mv <span class=\"token operator\">=</span> ha<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asyncManager<span class=\"token punctuation\">.</span><span class=\"token function\">isConcurrentHandlingStarted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token function\">applyDefaultViewName</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">applyPostHandle</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            dispatchException <span class=\"token operator\">=</span> ex<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            dispatchException <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NestedServletException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Handler dispatch failed\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token function\">processDispatchResult</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">,</span> dispatchException<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token function\">triggerAfterCompletion</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">triggerAfterCompletion</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">NestedServletException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Handler processing failed\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asyncManager<span class=\"token punctuation\">.</span><span class=\"token function\">isConcurrentHandlingStarted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">// </span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappedHandler <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">applyAfterConcurrentHandlingStarted</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">// </span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>multipartRequestParsed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">cleanupMultipart</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><font size=\"4\" color=\"red\">DispatcherServlet  HandlerMapping HandlerHandlerExecutionChain(Handler + HandlerInterceptor)</font></p>\n<p>handlerMappingsHandlerHandler +  HandlerExecutionChain</p>\n<p><img src=\"/2020/01/04/springmvc2/13.png\" alt></p>\n<p><font size=\"4\" color=\"red\">HandlerHandlerAdapter</font></p>\n<p>HandlerAdapter </p>\n<ul>\n<li>boolean supports(Object handler)   handler</li>\n<li>ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)   ModelAndView</li>\n</ul>\n<p><img src=\"/2020/01/04/springmvc2/14.png\" alt></p>\n<p>RequestMappingHandlerAdapterhandlerHandlerMethodhandler</p>\n<p><font size=\"4\" color=\"red\">handler</font></p>\n<p>3</p>\n<ul>\n<li><strong>preHandle</strong> - </li>\n<li><strong>postHandle</strong> - Controller ModelAndView </li>\n<li><strong>afterCompletion</strong> - </li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//mappedHandler.applyPreHandle(processedRequest, response);</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">applyPreHandle</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">,</span> HttpServletResponse response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    HandlerInterceptor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> interceptors <span class=\"token operator\">=</span> <span class=\"token function\">getInterceptors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ObjectUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>interceptors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> interceptors<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            HandlerInterceptor interceptor <span class=\"token operator\">=</span> interceptors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n             <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">preHandle</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">triggerAfterCompletion</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptorIndex <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><font size=\"4\" color=\"red\">HandlerAdapter()handlerModelAndView</font></p>\n<pre class=\" language-java\"><code class=\"language-java\">mv <span class=\"token operator\">=</span> ha<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>processedRequest<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> mappedHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>RequestMappingHandlerAdapter</p>\n<p><img src=\"/2020/01/04/springmvc2/15.png\" alt=\"handler\"></p>\n<p><img src=\"/2020/01/04/springmvc2/16.png\" alt=\"hanlderModelAndView\"></p>\n<p><font size=\"4\" color=\"red\"></font></p>\n<pre><code>//\napplyDefaultViewName(processedRequest, mv)\n//\nmappedHandler.applyPostHandle(processedRequest, response, mv)</code></pre><p><font size=\"4\" color=\"red\">ViewResolver</font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>ModelAndView mv<span class=\"token punctuation\">,</span> HttpServletRequest request<span class=\"token punctuation\">,</span> HttpServletResponse response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        Locale locale <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>localeResolver <span class=\"token operator\">!=</span> null <span class=\"token operator\">?</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>localeResolver<span class=\"token punctuation\">.</span><span class=\"token function\">resolveLocale</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getLocale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">setLocale</span><span class=\"token punctuation\">(</span>locale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        View view<span class=\"token punctuation\">;</span>\n        String viewName <span class=\"token operator\">=</span> mv<span class=\"token punctuation\">.</span><span class=\"token function\">getViewName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>viewName <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//view</span>\n            view <span class=\"token operator\">=</span> <span class=\"token function\">resolveViewName</span><span class=\"token punctuation\">(</span>viewName<span class=\"token punctuation\">,</span> mv<span class=\"token punctuation\">.</span><span class=\"token function\">getModelInternal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>view <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServletException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not resolve view with name '\"</span> <span class=\"token operator\">+</span> mv<span class=\"token punctuation\">.</span><span class=\"token function\">getViewName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"' in servlet with name '\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">getServletName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            view <span class=\"token operator\">=</span> mv<span class=\"token punctuation\">.</span><span class=\"token function\">getView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mv<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                response<span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>mv<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            view<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>mv<span class=\"token punctuation\">.</span><span class=\"token function\">getModelInternal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error rendering view [\"</span> <span class=\"token operator\">+</span> view <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">throw</span> ex<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">protected</span> View <span class=\"token function\">resolveViewName</span><span class=\"token punctuation\">(</span>String viewName<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span> model<span class=\"token punctuation\">,</span>\n        Locale locale<span class=\"token punctuation\">,</span> HttpServletRequest request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>viewResolvers <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>ViewResolver viewResolver <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>viewResolvers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            View view <span class=\"token operator\">=</span> viewResolver<span class=\"token punctuation\">.</span><span class=\"token function\">resolveViewName</span><span class=\"token punctuation\">(</span>viewName<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>view <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> view<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> null<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li> DispatcherServlet</li>\n<li>DispatcherServlet  HandlerMapping HandlerHandlerExecutionChainhandler</li>\n<li> Handler Controller  HandlerAdapter </li>\n<li>HandlerAdapter  Handler </li>\n<li> ModelAndView Model View  View</li>\n<li>ViewResolver  View  View</li>\n<li>DispaterServlet  Model  View</li>\n<li> View </li></ul>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3>\n\n<p><font size=\"4\" color=\"red\">DispatcherServlet</font></p>\n<p>SpringMVCSevletDispatcherServletHttpServletHttpServletdoGetdoPostDispatcherServletdoGetdoPost</p>\n<p><img src=\"/2020/01/04/springmvc2/10.png\" alt></p>\n<p><img src=\"/2020/01/04/springmvc2/11.png\" alt></p>\n<p><img src=\"/2020/01/04/springmvc2/12.png\" alt></p>\n<p>DispatcherServletdoDispatch</p>\n<pre><code class=\"java\">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n    HttpServletRequest processedRequest = request;\n    HandlerExecutionChain mappedHandler = null;\n    boolean multipartRequestParsed = false;\n\n    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n    try {\n        ModelAndView mv = null;\n        Exception dispatchException = null;\n\n        try {\n            processedRequest = checkMultipart(request);\n            multipartRequestParsed = (processedRequest != request);\n\n            //DispatcherServlet  HandlerMapping Handler\n            mappedHandler = getHandler(processedRequest);\n            if (mappedHandler == null) {\n                noHandlerFound(processedRequest, response);\n                return;\n            }\n\n            //  Handler Controller  HandlerAdapter \n            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\n            String method = request.getMethod();\n            boolean isGet = &quot;GET&quot;.equals(method);\n            if (isGet || &quot;HEAD&quot;.equals(method)) {\n                long lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n                if (new ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) {\n                    return;\n                }\n            }\n            //\n            if (!mappedHandler.applyPreHandle(processedRequest, response)) {\n                return;\n            }\n\n            // HandlerAdapter  Handler \n            //  ModelAndView Model View  View\n            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n            if (asyncManager.isConcurrentHandlingStarted()) {\n                return;\n            }\n            //\n            applyDefaultViewName(processedRequest, mv);\n            //\n            mappedHandler.applyPostHandle(processedRequest, response, mv);\n        }\n        catch (Exception ex) {\n            dispatchException = ex;\n        }\n        catch (Throwable err) {\n\n            dispatchException = new NestedServletException(&quot;Handler dispatch failed&quot;, err);\n        }\n        //\n        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n    }\n    catch (Exception ex) {\n        //\n        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n    }\n    catch (Throwable err) {\n        triggerAfterCompletion(processedRequest, response, mappedHandler,\n                new NestedServletException(&quot;Handler processing failed&quot;, err));\n    }\n    finally {\n        if (asyncManager.isConcurrentHandlingStarted()) {\n            // \n            if (mappedHandler != null) {\n                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n            }\n        }\n        else {\n            // \n            if (multipartRequestParsed) {\n                cleanupMultipart(processedRequest);\n            }\n        }\n    }\n}</code></pre>\n<p><font size=\"4\" color=\"red\">DispatcherServlet  HandlerMapping HandlerHandlerExecutionChain(Handler + HandlerInterceptor)</font></p>\n<p>handlerMappingsHandlerHandler +  HandlerExecutionChain</p>\n<p><img src=\"/2020/01/04/springmvc2/13.png\" alt></p>\n<p><font size=\"4\" color=\"red\">HandlerHandlerAdapter</font></p>\n<p>HandlerAdapter </p>\n<ul>\n<li>boolean supports(Object handler)   handler</li>\n<li>ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)   ModelAndView</li>\n</ul>\n<p><img src=\"/2020/01/04/springmvc2/14.png\" alt></p>\n<p>RequestMappingHandlerAdapterhandlerHandlerMethodhandler</p>\n<p><font size=\"4\" color=\"red\">handler</font></p>\n<p>3</p>\n<ul>\n<li><strong>preHandle</strong> - </li>\n<li><strong>postHandle</strong> - Controller ModelAndView </li>\n<li><strong>afterCompletion</strong> - </li>\n</ul>\n<pre><code class=\"java\">//mappedHandler.applyPreHandle(processedRequest, response);\nboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {\n    HandlerInterceptor[] interceptors = getInterceptors(); //\n    if (!ObjectUtils.isEmpty(interceptors)) {\n        for (int i = 0; i &lt; interceptors.length; i++) {\n            HandlerInterceptor interceptor = interceptors[i];\n             //\n            if (!interceptor.preHandle(request, response, this.handler)) {\n                triggerAfterCompletion(request, response, null);\n                return false;\n            }\n            this.interceptorIndex = i;\n        }\n    }\n    return true;\n}</code></pre>\n<p><font size=\"4\" color=\"red\">HandlerAdapter()handlerModelAndView</font></p>\n<pre><code class=\"java\">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code></pre>\n<p>RequestMappingHandlerAdapter</p>\n<p><img src=\"/2020/01/04/springmvc2/15.png\" alt=\"handler\"></p>\n<p><img src=\"/2020/01/04/springmvc2/16.png\" alt=\"hanlderModelAndView\"></p>\n<p><font size=\"4\" color=\"red\"></font></p>\n<pre><code>//\napplyDefaultViewName(processedRequest, mv)\n//\nmappedHandler.applyPostHandle(processedRequest, response, mv)</code></pre><p><font size=\"4\" color=\"red\">ViewResolver</font></p>\n<pre><code class=\"java\">//\nprotected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {\n        Locale locale = (this.localeResolver != null ? this.localeResolver.resolveLocale(request) : request.getLocale());\n        response.setLocale(locale);\n        View view;\n        String viewName = mv.getViewName();\n        if (viewName != null) {\n            //view\n            view = resolveViewName(viewName, mv.getModelInternal(), locale, request);\n            if (view == null) {\n                throw new ServletException(&quot;Could not resolve view with name &#39;&quot; + mv.getViewName() +\n                        &quot;&#39; in servlet with name &#39;&quot; + getServletName() + &quot;&#39;&quot;);\n            }\n        }\n        else {\n            view = mv.getView();\n        }\n        try {\n            if (mv.getStatus() != null) {\n                response.setStatus(mv.getStatus().value());\n            }\n            //\n            view.render(mv.getModelInternal(), request, response);\n        }\n        catch (Exception ex) {\n            if (logger.isDebugEnabled()) {\n                logger.debug(&quot;Error rendering view [&quot; + view + &quot;]&quot;, ex);\n            }\n            throw ex;\n        }\n}\n\nprotected View resolveViewName(String viewName, @Nullable Map&lt;String, Object&gt; model,\n        Locale locale, HttpServletRequest request) throws Exception {\n    if (this.viewResolvers != null) {\n        //\n        for (ViewResolver viewResolver : this.viewResolvers) {\n            View view = viewResolver.resolveViewName(viewName, locale);\n            if (view != null) {\n                return view;\n            }\n        }\n    }\n    return null;\n}</code></pre>"},{"title":"SpringMVC","description":"SpringMVC","date":"2020-01-01T08:02:20.000Z","_content":"## SpringMVC\n\n### SpringMVC\n\n1.applicationContext.xml\n\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd\">\n    <context:annotation-config/>\n    <bean id=\"beanService\" class=\"com.xzy.bean.BeanService\"></bean>\n    //...\n</bean>\n</beans>\n```\n<!--more-->\n2.springmvc.xml\n\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:mvc=\"http://www.springframework.org/schema/mvc\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd\">\n\n    <!-- SpringMVC@controller -->\n    <context:component-scan base-package=\"com.xzy.controller\"/>\n    <mvc:annotation-driven />\n    <!--  -->\n    <bean class=\"org.springframework.web.servlet.view.InternalResourceViewResolver\">\n        <!-- actionreturn url -->\n        <property name=\"prefix\" value=\"/WEB-INF/\"/>\n        <property name=\"suffix\" value=\".jsp\"/>\n    </bean>\n</beans>\n```\n\n3.web.xml\n\n```xml\n <!Root WebApplicationContext-->\n    <context-param>  \n        <param-name>contextConfigLocation</param-name>  \n        <param-value>classpath:applicationContext.xml</param-value>  \n    </context-param>  \n  \n    <listener>  \n        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>  \n    </listener>\n    <!Servlet WebApplicationContext-->\n    <servlet>  \n        <servlet-name>dispatcher</servlet-name>  \n        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>  \n        <init-param>  \n            <param-name>contextConfigLocation</param-name>  \n            <param-value>classpath:spring-mvc.xml</param-value>  \n        </init-param>  \n        <load-on-startup>1</load-on-startup>  \n    </servlet>  \n    <servlet-mapping>  \n        <servlet-name>dispatcher</servlet-name>  \n        <url-pattern>/*</url-pattern>  \n    </servlet-mapping>\n```\n\n### SpringMVC\n\nJavaWebListener()ServletFilter \n\n- Listenerservlet\n- ServletdoGetdoPost\n- Filter\n\nweb.xmlContextLoaderListenerDispatcherServletServlet\n\n- Root WebApplicationContextJ2EEservicedaobean(DataSource)applicationContext.xmlwebContextLoaderListener\n- Servlet WebApplicationContextJ2EEweb(controller)(view resolvers)beanspring mvcDispatchServletspring-servlet.xml\n\n**?**\n\n\n\n## ContextLoaderListener\n\nContextLoaderListenerServletContextListener ServletContext WebcontextInitializedapplicationContext.xmlBeanservicedaobean\n\n![ContextLoaderListener](springmvc/4.png)\n\n## DispatcherServlet\n\n### httpServletinit\n\n![DispatcherServlet](springmvc/5.png)\n\nDispatcherServletHttpServletinit()\n\n- Spring-mvc.xml\n\n- <mvc:annotation-driven /> (HandlerMapping)(HandlerAdapter)\n\n  \\<mvc:annotation-driven\\/> ----- MvcNamespaceHandler#init() ----- AnnotationDrivenBeanDefinitionParser#parse()\n\n- initStrategies\n\n![](springmvc/6.png)\n\n```java\n//initStrategies\nprotected void initStrategies(ApplicationContext context) {\n\t//\n\tinitMultipartResolver(context);\n\t//\n\tinitLocaleResolver(context);\n\t//\n\tinitThemeResolver(context);\n\t//\n\tinitHandlerMappings(context);\n\t//\n\tinitHandlerAdapters(context);\n\t//\n\tinitHandlerExceptionResolvers(context);\n\t//\n\tinitRequestToViewNameTranslator(context);\n\t//\n\tinitViewResolvers(context);\n\t//\n\tinitFlashMapManager(context);\n}\n```\n\n\n\n### HandlerMapping\n\nSpringMVC  `HandlerMapping`  `Request`  `Controller` mappingRegistry.javaurlControllerWebRequestMappingHandlerMapping.java  BeanNameUrlHandlerMapping.java\n\nRequestMappingHandlerMapping.javaRequestController\n\n![RequestMappingHandlerMapping](springmvc/7.png)\n\nRequestMappingHandlerMappingInitializingBeanafterPropertiesSet\n\n1. RequestMappingHandlerMapping#afterPropertiesSet()\n2. AbstractHandlerMethodMapping#initHandlerMethods() \n3. AbstractHandlerMethodMapping#processCandidateBean(beanName)\n4. AbstractHandlerMethodMapping#detectHandlerMethods(beanName)\n5. AbstractHandlerMethodMapping#registerMapping()\n6. AbstractHandlerMethodMapping#register(T mapping, Object handler, Method method)\n\n![](springmvc/8.png)\n\n![](springmvc/9.png)\n\n![](springmvc/10.png)\n\nHandlerMapping(Handler)Controller\n\n```java\n//@Controller  @RequestMapping\n@Controller\n@RequestMapping(value = \"/demo\")\npublic class DemoController {\n    @RequestMapping(value = \"/demo1.action\")\n    @ResponseBody\n    public Map demo1() {\n        //..\n    }\n}\n\n//Controller\npublic class OtherController implements Controller {\n    public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception {\n        ModelAndView mv = new ModelAndView();\n        mv.addObject(\"hello\",\"world\");\n        mv.setViewName(\"result\");\n        return mv;\n    }\n}\n<bean id=\"/other.action\" class=\"com.xzy.controller.OtherController\"></bean>\n```\n\nHandlerMappingurlhandlergetHandler()urlhandlerhandler+HandlerInterceptorHandlerExecutionChain\n\n\n\n- RequestMappingHandlerMapping,urlController\n- BeanNameUrlHandlerMappingspring-mvc.xmlBeanNameUrlHandlerMappingbeanAbstractControllerbeanurlController\n\n```java\n<bean class=\"org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping\"></bean>\n<bean id=\"/hello\" class=\"com.cyw.web.controller.HelloController\"></bean>\npublic class HelloController extends AbstractController {\n    @Override\n    protected ModelAndView handleRequestInternal(HttpServletRequest request, HttpServletResponse response)\n            throws Exception {\n        return new ModelAndView(\"Hello\");\n    }\n}\n```\n\n- SimpleUrlHandlerMappingurl\n\n```xml\n<bean class=\"org.springframework.web.servlet.handler.SimpleUrlHandlerMapping\">\n   <property name=\"mappings\">\n    <props>\n       <prop key=\"/hello.htm\">helloController</prop>\n     </props>\n   </property>\n</bean>\n<bean id=\"helloController\" class=\"com.cyw.web.controller.HelloController\" />\n```\n\n### (HandlerAdapter)\n\nHandlerAdapterModelAndViewhandlerController@Controllerhandler\n\n- RequestMappingHandlerAdapter.java\n- HttpRequestHandlerAdapter.java\n- SimpleControllerHandlerAdapter.java\n\n","source":"_posts/springmvc.md","raw":"---\ntitle: SpringMVC\ntags:\n  - spring\ncategories: \n  - spring\ndescription : SpringMVC\ndate: 2020-01-01 16:02:20\n---\n## SpringMVC\n\n### SpringMVC\n\n1.applicationContext.xml\n\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd\">\n    <context:annotation-config/>\n    <bean id=\"beanService\" class=\"com.xzy.bean.BeanService\"></bean>\n    //...\n</bean>\n</beans>\n```\n<!--more-->\n2.springmvc.xml\n\n```java\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:mvc=\"http://www.springframework.org/schema/mvc\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd\">\n\n    <!-- SpringMVC@controller -->\n    <context:component-scan base-package=\"com.xzy.controller\"/>\n    <mvc:annotation-driven />\n    <!--  -->\n    <bean class=\"org.springframework.web.servlet.view.InternalResourceViewResolver\">\n        <!-- actionreturn url -->\n        <property name=\"prefix\" value=\"/WEB-INF/\"/>\n        <property name=\"suffix\" value=\".jsp\"/>\n    </bean>\n</beans>\n```\n\n3.web.xml\n\n```xml\n <!Root WebApplicationContext-->\n    <context-param>  \n        <param-name>contextConfigLocation</param-name>  \n        <param-value>classpath:applicationContext.xml</param-value>  \n    </context-param>  \n  \n    <listener>  \n        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>  \n    </listener>\n    <!Servlet WebApplicationContext-->\n    <servlet>  \n        <servlet-name>dispatcher</servlet-name>  \n        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>  \n        <init-param>  \n            <param-name>contextConfigLocation</param-name>  \n            <param-value>classpath:spring-mvc.xml</param-value>  \n        </init-param>  \n        <load-on-startup>1</load-on-startup>  \n    </servlet>  \n    <servlet-mapping>  \n        <servlet-name>dispatcher</servlet-name>  \n        <url-pattern>/*</url-pattern>  \n    </servlet-mapping>\n```\n\n### SpringMVC\n\nJavaWebListener()ServletFilter \n\n- Listenerservlet\n- ServletdoGetdoPost\n- Filter\n\nweb.xmlContextLoaderListenerDispatcherServletServlet\n\n- Root WebApplicationContextJ2EEservicedaobean(DataSource)applicationContext.xmlwebContextLoaderListener\n- Servlet WebApplicationContextJ2EEweb(controller)(view resolvers)beanspring mvcDispatchServletspring-servlet.xml\n\n**?**\n\n\n\n## ContextLoaderListener\n\nContextLoaderListenerServletContextListener ServletContext WebcontextInitializedapplicationContext.xmlBeanservicedaobean\n\n![ContextLoaderListener](springmvc/4.png)\n\n## DispatcherServlet\n\n### httpServletinit\n\n![DispatcherServlet](springmvc/5.png)\n\nDispatcherServletHttpServletinit()\n\n- Spring-mvc.xml\n\n- <mvc:annotation-driven /> (HandlerMapping)(HandlerAdapter)\n\n  \\<mvc:annotation-driven\\/> ----- MvcNamespaceHandler#init() ----- AnnotationDrivenBeanDefinitionParser#parse()\n\n- initStrategies\n\n![](springmvc/6.png)\n\n```java\n//initStrategies\nprotected void initStrategies(ApplicationContext context) {\n\t//\n\tinitMultipartResolver(context);\n\t//\n\tinitLocaleResolver(context);\n\t//\n\tinitThemeResolver(context);\n\t//\n\tinitHandlerMappings(context);\n\t//\n\tinitHandlerAdapters(context);\n\t//\n\tinitHandlerExceptionResolvers(context);\n\t//\n\tinitRequestToViewNameTranslator(context);\n\t//\n\tinitViewResolvers(context);\n\t//\n\tinitFlashMapManager(context);\n}\n```\n\n\n\n### HandlerMapping\n\nSpringMVC  `HandlerMapping`  `Request`  `Controller` mappingRegistry.javaurlControllerWebRequestMappingHandlerMapping.java  BeanNameUrlHandlerMapping.java\n\nRequestMappingHandlerMapping.javaRequestController\n\n![RequestMappingHandlerMapping](springmvc/7.png)\n\nRequestMappingHandlerMappingInitializingBeanafterPropertiesSet\n\n1. RequestMappingHandlerMapping#afterPropertiesSet()\n2. AbstractHandlerMethodMapping#initHandlerMethods() \n3. AbstractHandlerMethodMapping#processCandidateBean(beanName)\n4. AbstractHandlerMethodMapping#detectHandlerMethods(beanName)\n5. AbstractHandlerMethodMapping#registerMapping()\n6. AbstractHandlerMethodMapping#register(T mapping, Object handler, Method method)\n\n![](springmvc/8.png)\n\n![](springmvc/9.png)\n\n![](springmvc/10.png)\n\nHandlerMapping(Handler)Controller\n\n```java\n//@Controller  @RequestMapping\n@Controller\n@RequestMapping(value = \"/demo\")\npublic class DemoController {\n    @RequestMapping(value = \"/demo1.action\")\n    @ResponseBody\n    public Map demo1() {\n        //..\n    }\n}\n\n//Controller\npublic class OtherController implements Controller {\n    public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception {\n        ModelAndView mv = new ModelAndView();\n        mv.addObject(\"hello\",\"world\");\n        mv.setViewName(\"result\");\n        return mv;\n    }\n}\n<bean id=\"/other.action\" class=\"com.xzy.controller.OtherController\"></bean>\n```\n\nHandlerMappingurlhandlergetHandler()urlhandlerhandler+HandlerInterceptorHandlerExecutionChain\n\n\n\n- RequestMappingHandlerMapping,urlController\n- BeanNameUrlHandlerMappingspring-mvc.xmlBeanNameUrlHandlerMappingbeanAbstractControllerbeanurlController\n\n```java\n<bean class=\"org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping\"></bean>\n<bean id=\"/hello\" class=\"com.cyw.web.controller.HelloController\"></bean>\npublic class HelloController extends AbstractController {\n    @Override\n    protected ModelAndView handleRequestInternal(HttpServletRequest request, HttpServletResponse response)\n            throws Exception {\n        return new ModelAndView(\"Hello\");\n    }\n}\n```\n\n- SimpleUrlHandlerMappingurl\n\n```xml\n<bean class=\"org.springframework.web.servlet.handler.SimpleUrlHandlerMapping\">\n   <property name=\"mappings\">\n    <props>\n       <prop key=\"/hello.htm\">helloController</prop>\n     </props>\n   </property>\n</bean>\n<bean id=\"helloController\" class=\"com.cyw.web.controller.HelloController\" />\n```\n\n### (HandlerAdapter)\n\nHandlerAdapterModelAndViewhandlerController@Controllerhandler\n\n- RequestMappingHandlerAdapter.java\n- HttpRequestHandlerAdapter.java\n- SimpleControllerHandlerAdapter.java\n\n","slug":"springmvc","published":1,"updated":"2021-04-08T00:47:07.037Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw1004eqwv24fnn05x6","content":"<h2 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h2><h3 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h3><p>1.applicationContext.xml</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>xml version<span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> encoding<span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span><span class=\"token operator\">?</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>beans xmlns<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/beans\"</span>\n       xmlns<span class=\"token operator\">:</span>xsi<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span>\n       xmlns<span class=\"token operator\">:</span>context<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/context\"</span>\n       xmlns<span class=\"token operator\">:</span>tx<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/tx\"</span>\n       xsi<span class=\"token operator\">:</span>schemaLocation<span class=\"token operator\">=</span>\"http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>beans\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>beans<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>beans<span class=\"token punctuation\">.</span>xsd\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>context\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>context<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>context<span class=\"token punctuation\">.</span>xsd\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>tx\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>tx<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>tx<span class=\"token punctuation\">.</span>xsd\"<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>context<span class=\"token operator\">:</span>annotation<span class=\"token operator\">-</span>config<span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>bean id<span class=\"token operator\">=</span><span class=\"token string\">\"beanService\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"com.xzy.bean.BeanService\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span>\n    <span class=\"token comment\" spellcheck=\"true\">//...</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>beans<span class=\"token operator\">></span></code></pre>\n<a id=\"more\"></a>\n<p>2.springmvc.xml</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>xml version<span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> encoding<span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span><span class=\"token operator\">?</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>beans xmlns<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/beans\"</span>\n       xmlns<span class=\"token operator\">:</span>xsi<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span>\n       xmlns<span class=\"token operator\">:</span>context<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/context\"</span>\n       xmlns<span class=\"token operator\">:</span>tx<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/tx\"</span> xmlns<span class=\"token operator\">:</span>mvc<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.springframework.org/schema/mvc\"</span>\n       xsi<span class=\"token operator\">:</span>schemaLocation<span class=\"token operator\">=</span>\"http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>beans\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>beans<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>beans<span class=\"token punctuation\">.</span>xsd\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>context\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>context<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>context<span class=\"token punctuation\">.</span>xsd\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>tx\n        http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>tx<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>tx<span class=\"token punctuation\">.</span>xsd http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>mvc https<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>schema<span class=\"token operator\">/</span>mvc<span class=\"token operator\">/</span>spring<span class=\"token operator\">-</span>mvc<span class=\"token punctuation\">.</span>xsd\"<span class=\"token operator\">></span>\n\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> SpringMVC<span class=\"token annotation punctuation\">@controller</span> <span class=\"token operator\">--</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>context<span class=\"token operator\">:</span>component<span class=\"token operator\">-</span>scan base<span class=\"token operator\">-</span><span class=\"token keyword\">package</span><span class=\"token operator\">=</span><span class=\"token string\">\"com.xzy.controller\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>mvc<span class=\"token operator\">:</span>annotation<span class=\"token operator\">-</span>driven <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>  <span class=\"token operator\">--</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>bean <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.springframework.web.servlet.view.InternalResourceViewResolver\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> action<span class=\"token keyword\">return</span> url <span class=\"token operator\">--</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>property name<span class=\"token operator\">=</span><span class=\"token string\">\"prefix\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"/WEB-INF/\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>property name<span class=\"token operator\">=</span><span class=\"token string\">\"suffix\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\".jsp\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>beans<span class=\"token operator\">></span></code></pre>\n<p>3.web.xml</p>\n<pre class=\" language-xml\"><code class=\"language-xml\"> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>!Root</span> <span class=\"token attr-name\">WebApplicationContext--</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>context-param</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextConfigLocation<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span>classpath:applicationContext.xml<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>context-param</span><span class=\"token punctuation\">></span></span>  \n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listener</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listener-class</span><span class=\"token punctuation\">></span></span>org.springframework.web.context.ContextLoaderListener<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener-class</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>!Servlet</span> <span class=\"token attr-name\">WebApplicationContext--</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-name</span><span class=\"token punctuation\">></span></span>dispatcher<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-name</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-class</span><span class=\"token punctuation\">></span></span>org.springframework.web.servlet.DispatcherServlet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-class</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>init-param</span><span class=\"token punctuation\">></span></span>  \n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextConfigLocation<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span>  \n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span>classpath:spring-mvc.xml<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>init-param</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>load-on-startup</span><span class=\"token punctuation\">></span></span>1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>load-on-startup</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-mapping</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-name</span><span class=\"token punctuation\">></span></span>dispatcher<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-name</span><span class=\"token punctuation\">></span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>url-pattern</span><span class=\"token punctuation\">></span></span>/*<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>url-pattern</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-mapping</span><span class=\"token punctuation\">></span></span></code></pre>\n<h3 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h3><p>JavaWebListener()ServletFilter </p>\n<ul>\n<li>Listenerservlet</li>\n<li>ServletdoGetdoPost</li>\n<li>Filter</li>\n</ul>\n<p>web.xmlContextLoaderListenerDispatcherServletServlet</p>\n<ul>\n<li>Root WebApplicationContextJ2EEservicedaobean(DataSource)applicationContext.xmlwebContextLoaderListener</li>\n<li>Servlet WebApplicationContextJ2EEweb(controller)(view resolvers)beanspring mvcDispatchServletspring-servlet.xml</li>\n</ul>\n<p><strong>?</strong></p>\n<p></p>\n<h2 id=\"ContextLoaderListener\"><a href=\"#ContextLoaderListener\" class=\"headerlink\" title=\"ContextLoaderListener\"></a>ContextLoaderListener</h2><p>ContextLoaderListenerServletContextListener ServletContext WebcontextInitializedapplicationContext.xmlBeanservicedaobean</p>\n<p><img src=\"/2020/01/01/springmvc/4.png\" alt=\"ContextLoaderListener\"></p>\n<h2 id=\"DispatcherServlet\"><a href=\"#DispatcherServlet\" class=\"headerlink\" title=\"DispatcherServlet\"></a>DispatcherServlet</h2><h3 id=\"httpServletinit\"><a href=\"#httpServletinit\" class=\"headerlink\" title=\"httpServletinit\"></a>httpServletinit</h3><p><img src=\"/2020/01/01/springmvc/5.png\" alt=\"DispatcherServlet\"></p>\n<p>DispatcherServletHttpServletinit()</p>\n<ul>\n<li><p>Spring-mvc.xml</p>\n</li>\n<li><p>&lt;mvc:annotation-driven /&gt; (HandlerMapping)(HandlerAdapter)</p>\n<p>&lt;mvc:annotation-driven/&gt;  MvcNamespaceHandler#init()  AnnotationDrivenBeanDefinitionParser#parse()</p>\n</li>\n<li><p>initStrategies</p>\n</li>\n</ul>\n<p><img src=\"/2020/01/01/springmvc/6.png\" alt></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//initStrategies</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initStrategies</span><span class=\"token punctuation\">(</span>ApplicationContext context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initMultipartResolver</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initLocaleResolver</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initThemeResolver</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initHandlerMappings</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initHandlerAdapters</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initHandlerExceptionResolvers</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initRequestToViewNameTranslator</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initViewResolvers</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">initFlashMapManager</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"HandlerMapping\"><a href=\"#HandlerMapping\" class=\"headerlink\" title=\"HandlerMapping\"></a>HandlerMapping</h3><p>SpringMVC  <code>HandlerMapping</code>  <code>Request</code>  <code>Controller</code> mappingRegistry.javaurlControllerWebRequestMappingHandlerMapping.java  BeanNameUrlHandlerMapping.java</p>\n<p>RequestMappingHandlerMapping.javaRequestController</p>\n<p><img src=\"/2020/01/01/springmvc/7.png\" alt=\"RequestMappingHandlerMapping\"></p>\n<p>RequestMappingHandlerMappingInitializingBeanafterPropertiesSet</p>\n<ol>\n<li>RequestMappingHandlerMapping#afterPropertiesSet()</li>\n<li>AbstractHandlerMethodMapping#initHandlerMethods() </li>\n<li>AbstractHandlerMethodMapping#processCandidateBean(beanName)</li>\n<li>AbstractHandlerMethodMapping#detectHandlerMethods(beanName)</li>\n<li>AbstractHandlerMethodMapping#registerMapping()</li>\n<li>AbstractHandlerMethodMapping#register(T mapping, Object handler, Method method)</li>\n</ol>\n<p><img src=\"/2020/01/01/springmvc/8.png\" alt></p>\n<p><img src=\"/2020/01/01/springmvc/9.png\" alt></p>\n<p><img src=\"/2020/01/01/springmvc/10.png\" alt></p>\n<p>HandlerMapping(Handler)Controller</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//@Controller  @RequestMapping</span>\n<span class=\"token annotation punctuation\">@Controller</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"/demo\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DemoController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"/demo1.action\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ResponseBody</span>\n    <span class=\"token keyword\">public</span> Map <span class=\"token function\">demo1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//..</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//Controller</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherController</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Controller</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> ModelAndView <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">,</span> HttpServletResponse response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        ModelAndView mv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ModelAndView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">addObject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mv<span class=\"token punctuation\">.</span><span class=\"token function\">setViewName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> mv<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span>bean id<span class=\"token operator\">=</span><span class=\"token string\">\"/other.action\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"com.xzy.controller.OtherController\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span></code></pre>\n<p>HandlerMappingurlhandlergetHandler()urlhandlerhandler+HandlerInterceptorHandlerExecutionChain</p>\n<p></p>\n<ul>\n<li>RequestMappingHandlerMapping,urlController</li>\n<li>BeanNameUrlHandlerMappingspring-mvc.xmlBeanNameUrlHandlerMappingbeanAbstractControllerbeanurlController</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token operator\">&lt;</span>bean <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>bean id<span class=\"token operator\">=</span><span class=\"token string\">\"/hello\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"com.cyw.web.controller.HelloController\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>bean<span class=\"token operator\">></span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloController</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> ModelAndView <span class=\"token function\">handleRequestInternal</span><span class=\"token punctuation\">(</span>HttpServletRequest request<span class=\"token punctuation\">,</span> HttpServletResponse response<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ModelAndView</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<ul>\n<li>SimpleUrlHandlerMappingurl</li>\n</ul>\n<pre class=\" language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>bean</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>org.springframework.web.servlet.handler.SimpleUrlHandlerMapping<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>mappings<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>props</span><span class=\"token punctuation\">></span></span>\n       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>prop</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/hello.htm<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>helloController<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>prop</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>props</span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>property</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>bean</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>bean</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>helloController<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>com.cyw.web.controller.HelloController<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre>\n<h3 id=\"-HandlerAdapter\"><a href=\"#-HandlerAdapter\" class=\"headerlink\" title=\"(HandlerAdapter)\"></a>(HandlerAdapter)</h3><p>HandlerAdapterModelAndViewhandlerController@Controllerhandler</p>\n<ul>\n<li>RequestMappingHandlerAdapter.java</li>\n<li>HttpRequestHandlerAdapter.java</li>\n<li>SimpleControllerHandlerAdapter.java</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h2><h3 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h3><p>1.applicationContext.xml</p>\n<pre><code class=\"java\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd&quot;&gt;\n    &lt;context:annotation-config/&gt;\n    &lt;bean id=&quot;beanService&quot; class=&quot;com.xzy.bean.BeanService&quot;&gt;&lt;/bean&gt;\n    //...\n&lt;/bean&gt;\n&lt;/beans&gt;</code></pre>","more":"<p>2.springmvc.xml</p>\n<pre><code class=\"java\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context\n        http://www.springframework.org/schema/context/spring-context.xsd\n        http://www.springframework.org/schema/tx\n        http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;&gt;\n\n    &lt;!-- SpringMVC@controller --&gt;\n    &lt;context:component-scan base-package=&quot;com.xzy.controller&quot;/&gt;\n    &lt;mvc:annotation-driven /&gt;\n    &lt;!--  --&gt;\n    &lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;\n        &lt;!-- actionreturn url --&gt;\n        &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/&quot;/&gt;\n        &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;</code></pre>\n<p>3.web.xml</p>\n<pre><code class=\"xml\"> &lt;!Root WebApplicationContext--&gt;\n    &lt;context-param&gt;  \n        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;  \n        &lt;param-value&gt;classpath:applicationContext.xml&lt;/param-value&gt;  \n    &lt;/context-param&gt;  \n\n    &lt;listener&gt;  \n        &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;  \n    &lt;/listener&gt;\n    &lt;!Servlet WebApplicationContext--&gt;\n    &lt;servlet&gt;  \n        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;  \n        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;  \n        &lt;init-param&gt;  \n            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;  \n            &lt;param-value&gt;classpath:spring-mvc.xml&lt;/param-value&gt;  \n        &lt;/init-param&gt;  \n        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;  \n    &lt;/servlet&gt;  \n    &lt;servlet-mapping&gt;  \n        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;  \n        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  \n    &lt;/servlet-mapping&gt;</code></pre>\n<h3 id=\"SpringMVC\"><a href=\"#SpringMVC\" class=\"headerlink\" title=\"SpringMVC\"></a>SpringMVC</h3><p>JavaWebListener()ServletFilter </p>\n<ul>\n<li>Listenerservlet</li>\n<li>ServletdoGetdoPost</li>\n<li>Filter</li>\n</ul>\n<p>web.xmlContextLoaderListenerDispatcherServletServlet</p>\n<ul>\n<li>Root WebApplicationContextJ2EEservicedaobean(DataSource)applicationContext.xmlwebContextLoaderListener</li>\n<li>Servlet WebApplicationContextJ2EEweb(controller)(view resolvers)beanspring mvcDispatchServletspring-servlet.xml</li>\n</ul>\n<p><strong>?</strong></p>\n<p></p>\n<h2 id=\"ContextLoaderListener\"><a href=\"#ContextLoaderListener\" class=\"headerlink\" title=\"ContextLoaderListener\"></a>ContextLoaderListener</h2><p>ContextLoaderListenerServletContextListener ServletContext WebcontextInitializedapplicationContext.xmlBeanservicedaobean</p>\n<p><img src=\"/2020/01/01/springmvc/4.png\" alt=\"ContextLoaderListener\"></p>\n<h2 id=\"DispatcherServlet\"><a href=\"#DispatcherServlet\" class=\"headerlink\" title=\"DispatcherServlet\"></a>DispatcherServlet</h2><h3 id=\"httpServletinit\"><a href=\"#httpServletinit\" class=\"headerlink\" title=\"httpServletinit\"></a>httpServletinit</h3><p><img src=\"/2020/01/01/springmvc/5.png\" alt=\"DispatcherServlet\"></p>\n<p>DispatcherServletHttpServletinit()</p>\n<ul>\n<li><p>Spring-mvc.xml</p>\n</li>\n<li><p>&lt;mvc:annotation-driven /&gt; (HandlerMapping)(HandlerAdapter)</p>\n<p>&lt;mvc:annotation-driven/&gt;  MvcNamespaceHandler#init()  AnnotationDrivenBeanDefinitionParser#parse()</p>\n</li>\n<li><p>initStrategies</p>\n</li>\n</ul>\n<p><img src=\"/2020/01/01/springmvc/6.png\" alt></p>\n<pre><code class=\"java\">//initStrategies\nprotected void initStrategies(ApplicationContext context) {\n    //\n    initMultipartResolver(context);\n    //\n    initLocaleResolver(context);\n    //\n    initThemeResolver(context);\n    //\n    initHandlerMappings(context);\n    //\n    initHandlerAdapters(context);\n    //\n    initHandlerExceptionResolvers(context);\n    //\n    initRequestToViewNameTranslator(context);\n    //\n    initViewResolvers(context);\n    //\n    initFlashMapManager(context);\n}</code></pre>\n<h3 id=\"HandlerMapping\"><a href=\"#HandlerMapping\" class=\"headerlink\" title=\"HandlerMapping\"></a>HandlerMapping</h3><p>SpringMVC  <code>HandlerMapping</code>  <code>Request</code>  <code>Controller</code> mappingRegistry.javaurlControllerWebRequestMappingHandlerMapping.java  BeanNameUrlHandlerMapping.java</p>\n<p>RequestMappingHandlerMapping.javaRequestController</p>\n<p><img src=\"/2020/01/01/springmvc/7.png\" alt=\"RequestMappingHandlerMapping\"></p>\n<p>RequestMappingHandlerMappingInitializingBeanafterPropertiesSet</p>\n<ol>\n<li>RequestMappingHandlerMapping#afterPropertiesSet()</li>\n<li>AbstractHandlerMethodMapping#initHandlerMethods() </li>\n<li>AbstractHandlerMethodMapping#processCandidateBean(beanName)</li>\n<li>AbstractHandlerMethodMapping#detectHandlerMethods(beanName)</li>\n<li>AbstractHandlerMethodMapping#registerMapping()</li>\n<li>AbstractHandlerMethodMapping#register(T mapping, Object handler, Method method)</li>\n</ol>\n<p><img src=\"/2020/01/01/springmvc/8.png\" alt></p>\n<p><img src=\"/2020/01/01/springmvc/9.png\" alt></p>\n<p><img src=\"/2020/01/01/springmvc/10.png\" alt></p>\n<p>HandlerMapping(Handler)Controller</p>\n<pre><code class=\"java\">//@Controller  @RequestMapping\n@Controller\n@RequestMapping(value = &quot;/demo&quot;)\npublic class DemoController {\n    @RequestMapping(value = &quot;/demo1.action&quot;)\n    @ResponseBody\n    public Map demo1() {\n        //..\n    }\n}\n\n//Controller\npublic class OtherController implements Controller {\n    public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception {\n        ModelAndView mv = new ModelAndView();\n        mv.addObject(&quot;hello&quot;,&quot;world&quot;);\n        mv.setViewName(&quot;result&quot;);\n        return mv;\n    }\n}\n&lt;bean id=&quot;/other.action&quot; class=&quot;com.xzy.controller.OtherController&quot;&gt;&lt;/bean&gt;</code></pre>\n<p>HandlerMappingurlhandlergetHandler()urlhandlerhandler+HandlerInterceptorHandlerExecutionChain</p>\n<p></p>\n<ul>\n<li>RequestMappingHandlerMapping,urlController</li>\n<li>BeanNameUrlHandlerMappingspring-mvc.xmlBeanNameUrlHandlerMappingbeanAbstractControllerbeanurlController</li>\n</ul>\n<pre><code class=\"java\">&lt;bean class=&quot;org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping&quot;&gt;&lt;/bean&gt;\n&lt;bean id=&quot;/hello&quot; class=&quot;com.cyw.web.controller.HelloController&quot;&gt;&lt;/bean&gt;\npublic class HelloController extends AbstractController {\n    @Override\n    protected ModelAndView handleRequestInternal(HttpServletRequest request, HttpServletResponse response)\n            throws Exception {\n        return new ModelAndView(&quot;Hello&quot;);\n    }\n}</code></pre>\n<ul>\n<li>SimpleUrlHandlerMappingurl</li>\n</ul>\n<pre><code class=\"xml\">&lt;bean class=&quot;org.springframework.web.servlet.handler.SimpleUrlHandlerMapping&quot;&gt;\n   &lt;property name=&quot;mappings&quot;&gt;\n    &lt;props&gt;\n       &lt;prop key=&quot;/hello.htm&quot;&gt;helloController&lt;/prop&gt;\n     &lt;/props&gt;\n   &lt;/property&gt;\n&lt;/bean&gt;\n&lt;bean id=&quot;helloController&quot; class=&quot;com.cyw.web.controller.HelloController&quot; /&gt;</code></pre>\n<h3 id=\"-HandlerAdapter\"><a href=\"#-HandlerAdapter\" class=\"headerlink\" title=\"(HandlerAdapter)\"></a>(HandlerAdapter)</h3><p>HandlerAdapterModelAndViewhandlerController@Controllerhandler</p>\n<ul>\n<li>RequestMappingHandlerAdapter.java</li>\n<li>HttpRequestHandlerAdapter.java</li>\n<li>SimpleControllerHandlerAdapter.java</li>\n</ul>"},{"title":"javasynchronized","description":"javasynchronized","date":"2020-08-09T11:57:48.000Z","_content":"## \n\nsynchronizedjava****synchronizedmonitorentermonitorexitMutex Lock\n\n**synchronizedmonitorenter,monitorexitMutex LockMutex Lock**\n\n\n## synchronized\n\n|              |         |                                                          |\n| ------------ | ----------------- | ------------------------------------------------------------ |\n|  | new | public synchronized void doSome(){}                          |\n|  |   | public static synchronized void doSome(){}                   |\n| 1  | new | public void doSome(){<br/>\t&nbsp;&nbsp;&nbsp;synchronized(this){<br/>\t &nbsp;&nbsp;&nbsp; ...<br/>\t&nbsp;}<br/>} |\n| 2  |         | public void doSome(){<br/>\t&nbsp;synchronized(Dog.class){<br/>\t &nbsp;&nbsp; ...<br/>\t&nbsp;}<br/>} |\n\n## synchronized\n\n`javap -v OtherTest.class` \n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        Object o = new Object();\n        synchronized (o){\n            System.out.println(o);\n        }\n    }\n}\n```\n\n<!--more-->\n\n![](synchronized-up/6.png)\n\nsynchronizedJVM<font color=red>JVMMonitor</font>`monitorenter``monnitorexit`[java-monitor](https://www.cnblogs.com/qingshan-tang/p/12698705.html)\n\n## \n\nJDK6synchronizedJDK6synchronizedsynchronizedJDK6\n\nsynchronized<font color=red></font>synchronized<font color=red></font>\n\n## \n\n<font color=red>synchronized</font>JVM <font color=red>synchronized</font>\n\n![](synchronized-up/1.jpg)\n\nMarkWord<font color=red>markWord</font>01\n\n![](synchronized-up/2.png)\n\n### \n\n****** \n\n![->](synchronized-up/3.png)\n\n- AMarkWordIDCASIDMarkWord\n- AMardWordID(MarkWordIDA)01\n- \n- BMardWordAIDBCASB,\n\n<font color=red></font>\n\n<font color=red></font>\n\n### \n\n\n\n![->](synchronized-up/4.png)\n\nLockRecordCASmarkwordLockRecordACASABCAS<font color=red></font>1010CPU\n\n10JDK6<font color=red></font>()\n\n<font color=red></font>\n\n### \n\n\n\nLockRecordmonitor<font color=red>monitorenter</font><font color=red>monitorexit</font>\n\n\n\n![](synchronized-up/5.png)\n\njavamonitormonitormonitorenter monitor<font color=red>monitor</font><font color=red>monitor mutexLock()Linux</font>\n\n## \n\n\n\nStringBufferStringBuffersynchronizednewStringBufferStringBuffersynchronized\n\n```java\n//StringBuffer\npublic void addStr(String buffer){\n\tStringBuffer sb = new StringBuffer();\n\tsb.append(\"1\").append(\"2\");\n\treturn sb.toString(); \n}\n```\n\n## \n\n\n\n## \n\nJDK6synchronized<font color=red></font><font color=red></font>\n\nsynchronizedsynchronized\n\nJDK6synchronizedsynchronizedAQSAQSCAS\n\n## \n\n- https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w\n\n","source":"_posts/synchronized-up.md","raw":"---\ntitle: javasynchronized\ntags:\n  - java\ncategories:  java\ndescription: javasynchronized\ndate: 2020-08-09 19:57:48\n---\n## \n\nsynchronizedjava****synchronizedmonitorentermonitorexitMutex Lock\n\n**synchronizedmonitorenter,monitorexitMutex LockMutex Lock**\n\n\n## synchronized\n\n|              |         |                                                          |\n| ------------ | ----------------- | ------------------------------------------------------------ |\n|  | new | public synchronized void doSome(){}                          |\n|  |   | public static synchronized void doSome(){}                   |\n| 1  | new | public void doSome(){<br/>\t&nbsp;&nbsp;&nbsp;synchronized(this){<br/>\t &nbsp;&nbsp;&nbsp; ...<br/>\t&nbsp;}<br/>} |\n| 2  |         | public void doSome(){<br/>\t&nbsp;synchronized(Dog.class){<br/>\t &nbsp;&nbsp; ...<br/>\t&nbsp;}<br/>} |\n\n## synchronized\n\n`javap -v OtherTest.class` \n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        Object o = new Object();\n        synchronized (o){\n            System.out.println(o);\n        }\n    }\n}\n```\n\n<!--more-->\n\n![](synchronized-up/6.png)\n\nsynchronizedJVM<font color=red>JVMMonitor</font>`monitorenter``monnitorexit`[java-monitor](https://www.cnblogs.com/qingshan-tang/p/12698705.html)\n\n## \n\nJDK6synchronizedJDK6synchronizedsynchronizedJDK6\n\nsynchronized<font color=red></font>synchronized<font color=red></font>\n\n## \n\n<font color=red>synchronized</font>JVM <font color=red>synchronized</font>\n\n![](synchronized-up/1.jpg)\n\nMarkWord<font color=red>markWord</font>01\n\n![](synchronized-up/2.png)\n\n### \n\n****** \n\n![->](synchronized-up/3.png)\n\n- AMarkWordIDCASIDMarkWord\n- AMardWordID(MarkWordIDA)01\n- \n- BMardWordAIDBCASB,\n\n<font color=red></font>\n\n<font color=red></font>\n\n### \n\n\n\n![->](synchronized-up/4.png)\n\nLockRecordCASmarkwordLockRecordACASABCAS<font color=red></font>1010CPU\n\n10JDK6<font color=red></font>()\n\n<font color=red></font>\n\n### \n\n\n\nLockRecordmonitor<font color=red>monitorenter</font><font color=red>monitorexit</font>\n\n\n\n![](synchronized-up/5.png)\n\njavamonitormonitormonitorenter monitor<font color=red>monitor</font><font color=red>monitor mutexLock()Linux</font>\n\n## \n\n\n\nStringBufferStringBuffersynchronizednewStringBufferStringBuffersynchronized\n\n```java\n//StringBuffer\npublic void addStr(String buffer){\n\tStringBuffer sb = new StringBuffer();\n\tsb.append(\"1\").append(\"2\");\n\treturn sb.toString(); \n}\n```\n\n## \n\n\n\n## \n\nJDK6synchronized<font color=red></font><font color=red></font>\n\nsynchronizedsynchronized\n\nJDK6synchronizedsynchronizedAQSAQSCAS\n\n## \n\n- https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w\n\n","slug":"synchronized-up","published":1,"updated":"2021-04-08T00:47:07.087Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw2004gqwv2f31ef3cp","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>synchronizedjava<strong></strong>synchronizedmonitorentermonitorexitMutex Lock</p>\n<p><strong>synchronizedmonitorenter,monitorexitMutex LockMutex Lock</strong></p>\n<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"synchronized\"></a>synchronized</h2><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>new</td>\n<td>public synchronized void doSome(){}</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>public static synchronized void doSome(){}</td>\n</tr>\n<tr>\n<td>1</td>\n<td>new</td>\n<td>public void doSome(){<br>    &nbsp;&nbsp;&nbsp;synchronized(this){<br>     &nbsp;&nbsp;&nbsp; <br>    &nbsp;}<br>}</td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>public void doSome(){<br>    &nbsp;synchronized(Dog.class){<br>     &nbsp;&nbsp; <br>    &nbsp;}<br>}</td>\n</tr>\n</tbody></table>\n<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"synchronized\"></a>synchronized</h2><p><code>javap -v OtherTest.class</code> </p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Object o <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<a id=\"more\"></a>\n\n<p><img src=\"/2020/08/09/synchronized-up/6.png\" alt></p>\n<p>synchronizedJVM<font color=\"red\">JVMMonitor</font><code>monitorenter</code><code>monnitorexit</code><a href=\"https://www.cnblogs.com/qingshan-tang/p/12698705.html\" target=\"_blank\" rel=\"noopener\">java-monitor</a></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JDK6synchronizedJDK6synchronizedsynchronizedJDK6</p>\n<p>synchronized<font color=\"red\"></font>synchronized<font color=\"red\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font color=\"red\">synchronized</font>JVM <font color=\"red\">synchronized</font></p>\n<p><img src=\"/2020/08/09/synchronized-up/1.jpg\" alt=\"\"></p>\n<p>MarkWord<font color=\"red\">markWord</font>01</p>\n<p><img src=\"/2020/08/09/synchronized-up/2.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong><em></em></strong> </p>\n<p><img src=\"/2020/08/09/synchronized-up/3.png\" alt=\"-&gt;\"></p>\n<ul>\n<li>AMarkWordIDCASIDMarkWord</li>\n<li>AMardWordID(MarkWordIDA)01</li>\n<li></li>\n<li>BMardWordAIDBCASB,</li>\n</ul>\n<p><font color=\"red\"></font></p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"/2020/08/09/synchronized-up/4.png\" alt=\"-&gt;\"></p>\n<p>LockRecordCASmarkwordLockRecordACASABCAS<font color=\"red\"></font>1010CPU</p>\n<p>10JDK6<font color=\"red\"></font>()</p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>LockRecordmonitor<font color=\"red\">monitorenter</font><font color=\"red\">monitorexit</font></p>\n<p></p>\n<p><img src=\"/2020/08/09/synchronized-up/5.png\" alt></p>\n<p>javamonitormonitormonitorenter monitor<font color=\"red\">monitor</font><font color=\"red\">monitor mutexLock()Linux</font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>StringBufferStringBuffersynchronizednewStringBufferStringBuffersynchronized</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//StringBuffer</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addStr</span><span class=\"token punctuation\">(</span>String buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    StringBuffer sb <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sb<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> sb<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JDK6synchronized<font color=\"red\"></font><font color=\"red\"></font></p>\n<p>synchronizedsynchronized</p>\n<p>JDK6synchronizedsynchronizedAQSAQSCAS</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>synchronizedjava<strong></strong>synchronizedmonitorentermonitorexitMutex Lock</p>\n<p><strong>synchronizedmonitorenter,monitorexitMutex LockMutex Lock</strong></p>\n<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"synchronized\"></a>synchronized</h2><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>new</td>\n<td>public synchronized void doSome(){}</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>public static synchronized void doSome(){}</td>\n</tr>\n<tr>\n<td>1</td>\n<td>new</td>\n<td>public void doSome(){<br>    &nbsp;&nbsp;&nbsp;synchronized(this){<br>     &nbsp;&nbsp;&nbsp; <br>    &nbsp;}<br>}</td>\n</tr>\n<tr>\n<td>2</td>\n<td></td>\n<td>public void doSome(){<br>    &nbsp;synchronized(Dog.class){<br>     &nbsp;&nbsp; <br>    &nbsp;}<br>}</td>\n</tr>\n</tbody></table>\n<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"synchronized\"></a>synchronized</h2><p><code>javap -v OtherTest.class</code> </p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args) {\n        Object o = new Object();\n        synchronized (o){\n            System.out.println(o);\n        }\n    }\n}</code></pre>","more":"<p><img src=\"/2020/08/09/synchronized-up/6.png\" alt></p>\n<p>synchronizedJVM<font color=\"red\">JVMMonitor</font><code>monitorenter</code><code>monnitorexit</code><a href=\"https://www.cnblogs.com/qingshan-tang/p/12698705.html\" target=\"_blank\" rel=\"noopener\">java-monitor</a></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JDK6synchronizedJDK6synchronizedsynchronizedJDK6</p>\n<p>synchronized<font color=\"red\"></font>synchronized<font color=\"red\"></font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font color=\"red\">synchronized</font>JVM <font color=\"red\">synchronized</font></p>\n<p><img src=\"/2020/08/09/synchronized-up/1.jpg\" alt=\"\"></p>\n<p>MarkWord<font color=\"red\">markWord</font>01</p>\n<p><img src=\"/2020/08/09/synchronized-up/2.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong><em></em></strong> </p>\n<p><img src=\"/2020/08/09/synchronized-up/3.png\" alt=\"-&gt;\"></p>\n<ul>\n<li>AMarkWordIDCASIDMarkWord</li>\n<li>AMardWordID(MarkWordIDA)01</li>\n<li></li>\n<li>BMardWordAIDBCASB,</li>\n</ul>\n<p><font color=\"red\"></font></p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"/2020/08/09/synchronized-up/4.png\" alt=\"-&gt;\"></p>\n<p>LockRecordCASmarkwordLockRecordACASABCAS<font color=\"red\"></font>1010CPU</p>\n<p>10JDK6<font color=\"red\"></font>()</p>\n<p><font color=\"red\"></font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>LockRecordmonitor<font color=\"red\">monitorenter</font><font color=\"red\">monitorexit</font></p>\n<p></p>\n<p><img src=\"/2020/08/09/synchronized-up/5.png\" alt></p>\n<p>javamonitormonitormonitorenter monitor<font color=\"red\">monitor</font><font color=\"red\">monitor mutexLock()Linux</font></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>StringBufferStringBuffersynchronizednewStringBufferStringBuffersynchronized</p>\n<pre><code class=\"java\">//StringBuffer\npublic void addStr(String buffer){\n    StringBuffer sb = new StringBuffer();\n    sb.append(&quot;1&quot;).append(&quot;2&quot;);\n    return sb.toString(); \n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>JDK6synchronized<font color=\"red\"></font><font color=\"red\"></font></p>\n<p>synchronizedsynchronized</p>\n<p>JDK6synchronizedsynchronizedAQSAQSCAS</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/OAO7PGdKemLbdNb6bYtq-w</a></li>\n</ul>"},{"title":"javaThreadLocal","description":"ThreadLocal","date":"2020-08-12T05:57:14.000Z","_content":"## ThreadLocal\nThreadLocalJAVAThreadLocal\"\"\n<!--more-->\n```java\nimport org.junit.Test;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.atomic.AtomicInteger;\npublic class ThreadLocalTest {\n    private static final AtomicInteger nextId = new AtomicInteger(0);\n    private static final ThreadLocal<Integer> threadId = new ThreadLocal<Integer>(){\n        @Override\n        protected Integer initialValue() {\n            return nextId.getAndIncrement();\n        }\n    };\n    @Test\n    public void test1() throws InterruptedException {\n        for(int i = 0 ; i < 5 ; i++){\n            new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    System.out.println(\"threadName=\" + Thread.currentThread().getName() + \",threadId=\" + threadId.get());\n                }\n            },\"\" + i).start();\n        }\n        TimeUnit.SECONDS.sleep(2);\n    }\n}\n//\nthreadName=Thread-1,threadId=0\nthreadName=Thread-0,threadId=1\nthreadName=Thread-2,threadId=2\nthreadName=Thread-3,threadId=3\nthreadName=Thread-4,threadId=4\n```\n\n## ThreadLocal\n\nThreadLocalThreadLocal\n\n![ThreadLocalMap](threadlocal/1.png)\n\n![ThreadThreadLocalMap](threadlocal/2.png)\n\n\n\n- ThreadLocalThreadLocalMapThreadLocalMapkeyThreadLocalObject\n- ThreadthreadLocalsThreadLocal.ThreadLocalMap\n- <font color=red>ThreadThreadLocalThreadLocal</font>\n\nThreadLocalThreadthreadLocalsThreadLocal\n\n![ThreadLocal](threadlocal/3.png)\n\n- ThreadLocalMapEntry\n- ThreadLocalEntryThreadLocalMap\n- **Entry**ThreadLocalThreadLocalEntry,ThreadLocal\n\n## ThreadLocal\n\n\n- ThreadLocalMapEntry?\n- ThreadLocal?\n\nGCThreadLocal.ThreadLocalMapEntry\n```java\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    /** The value associated with this ThreadLocal. */\n    Object value;\n\n    Entry(ThreadLocal<?> k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n```\n![ThreadLocalJVM](threadlocal/4.png)\n\n22ThreadLocalMapEntry,keythreadId2keythreadId=nullkeyGC\n![2](threadlocal/5.png)\n**ThreadLocalMapEntry**\nthreadId=nullThreadLocalRef->ThreadLocalthreadIdkey->ThreadLocalThreadLocalkey->ThreadLocalThreadLocalGCThreadLocalkey = null \n\n****\nthreadId=null\n\n****\nthreadId=nullThreadLocalEntryKeynull KeyThreadLocalMapnull KeyValueThreadLocalMapnull keyThread --> ThreadLocalMap-->Entry-->ValueEntryValueEntryKey<font color=red>ValueThreadLocalremove</font>\n\n**?**\n\n- ThreadLocal<font color=red>remove</font>\n- Value<font color=red>remove</font>Value\n\n## ThreadLocal\n\n### set\n\n```java\npublic void set(T value) {\n    //set\n    Thread t = Thread.currentThread();\n    //threadLocals\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        //threadLocalsthisThreadLocal\n        map.set(this, value);\n    else\n        //t.threadLocals\n        createMap(t, value);\n}\n\nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n\nvoid createMap(Thread t, T firstValue) {\n    //ThreadLocalMap ThreadLocalMapThreadLocal\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}\n```\n\n### get\n\n```java\npublic T get() {\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null) {\n        //ThreadLocalMapThreadLocalMapkey = ThreadLocal\n        ThreadLocalMap.Entry e = map.getEntry(this);\n        if (e != null) {\n            @SuppressWarnings(\"unchecked\")\n            T result = (T)e.value;\n            return result;\n        }\n    }\n    //t.threadLocals\n    return setInitialValue();\n}\n\n//\nprivate T setInitialValue() {\n    //initialValuevalue\n    T value = initialValue();\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        map.set(this, value);\n    else\n        createMap(t, value);\n    return value;\n}\n```\n\n### remove\n\n```java\npublic void remove() {\n    //ThreadLocalMapremove\n    ThreadLocalMap m = getMap(Thread.currentThread());\n    if (m != null)\n        m.remove(this);\n}\n```\n\n\n\n## ThreadLocalMap()\n\nThreadLocalThreadLocalMapThreadLocalMapThreadLocal\n\nThreadLocalMapHashMap\n\n### \n\n```java\n//EntryTheadLocalMapHashMapNode\n//keyThreadLocal\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    Object value;\n    Entry(ThreadLocal<?> k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n//2\nprivate static final int INITIAL_CAPACITY = 16;\n//Entry2 ThreadLocalMaptable\nprivate Entry[] table;\t\n//entry\nprivate int size = 0;\n//0\nprivate int threshold;\n```\n\n<font color=red>**ThreadLocalMapEntry[]**</font>\n\n![Entry[]](threadlocal/6.png)\n\nThreadLocalMapEntryEntrykeyThreadLocalThreadLocalvalueThreadLoacl\n\n### \n\n```java\nThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n    //table,16\n    table = new Entry[INITIAL_CAPACITY];\n    //\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n    //\n    table[i] = new Entry(firstKey, firstValue);\n    size = 1;\n    //\n    setThreshold(INITIAL_CAPACITY);\n}\nprivate void setThreshold(int len) {\n   threshold = len * 2 / 3;\n}\n```\n\n**ThreadLocal.threadLocalHashCode**\n\n```java\nprivate static AtomicInteger nextHashCode = new AtomicInteger();\n\nprivate final int threadLocalHashCode = nextHashCode();\n//\nprivate static final int HASH_INCREMENT = 0x61c88647;\n//ThreadLocalnextHashCodeHASH_INCREMENT\nprivate static int nextHashCode() {\n    return nextHashCode.getAndAdd(HASH_INCREMENT);\n}\n```\n\n `ThreadLocal` `getAndAdd(0x61c88647)`ThreadLocal<font color=red>0x61c88647ThreadLocalIDthreadLocalHashCode2</font>\n\n### set()\n\n```java\nprivate void set(ThreadLocal<?> key, Object value) {\n    Entry[] tab = table;\n    int len = tab.length;\n    //hash * (table.length - 1) \n    int i = key.threadLocalHashCode & (len-1);\n    //nextIndex\n    //ThreadLocalhash\n    for (Entry e = tab[i]; e != null ; e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal<?> k = e.get();\n        //iThreadLocalThraedLocal\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        //k == nullThreadLocalThreadLocalslot\n        if (k == null) {\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n        //\n    }\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        rehash();\n}\n\nprivate static int nextIndex(int i, int len) {\n   return ((i + 1 < len) ? i + 1 : 0);\n}\n```\n\n## \n\n- https://www.cnblogs.com/micrari/p/6790229.html","source":"_posts/threadlocal.md","raw":"---\ntitle: javaThreadLocal\ntags:\n  - java\ncategories:  java\ndescription : ThreadLocal\ndate: 2020-08-12 13:57:14\n---\n## ThreadLocal\nThreadLocalJAVAThreadLocal\"\"\n<!--more-->\n```java\nimport org.junit.Test;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.atomic.AtomicInteger;\npublic class ThreadLocalTest {\n    private static final AtomicInteger nextId = new AtomicInteger(0);\n    private static final ThreadLocal<Integer> threadId = new ThreadLocal<Integer>(){\n        @Override\n        protected Integer initialValue() {\n            return nextId.getAndIncrement();\n        }\n    };\n    @Test\n    public void test1() throws InterruptedException {\n        for(int i = 0 ; i < 5 ; i++){\n            new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    System.out.println(\"threadName=\" + Thread.currentThread().getName() + \",threadId=\" + threadId.get());\n                }\n            },\"\" + i).start();\n        }\n        TimeUnit.SECONDS.sleep(2);\n    }\n}\n//\nthreadName=Thread-1,threadId=0\nthreadName=Thread-0,threadId=1\nthreadName=Thread-2,threadId=2\nthreadName=Thread-3,threadId=3\nthreadName=Thread-4,threadId=4\n```\n\n## ThreadLocal\n\nThreadLocalThreadLocal\n\n![ThreadLocalMap](threadlocal/1.png)\n\n![ThreadThreadLocalMap](threadlocal/2.png)\n\n\n\n- ThreadLocalThreadLocalMapThreadLocalMapkeyThreadLocalObject\n- ThreadthreadLocalsThreadLocal.ThreadLocalMap\n- <font color=red>ThreadThreadLocalThreadLocal</font>\n\nThreadLocalThreadthreadLocalsThreadLocal\n\n![ThreadLocal](threadlocal/3.png)\n\n- ThreadLocalMapEntry\n- ThreadLocalEntryThreadLocalMap\n- **Entry**ThreadLocalThreadLocalEntry,ThreadLocal\n\n## ThreadLocal\n\n\n- ThreadLocalMapEntry?\n- ThreadLocal?\n\nGCThreadLocal.ThreadLocalMapEntry\n```java\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    /** The value associated with this ThreadLocal. */\n    Object value;\n\n    Entry(ThreadLocal<?> k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n```\n![ThreadLocalJVM](threadlocal/4.png)\n\n22ThreadLocalMapEntry,keythreadId2keythreadId=nullkeyGC\n![2](threadlocal/5.png)\n**ThreadLocalMapEntry**\nthreadId=nullThreadLocalRef->ThreadLocalthreadIdkey->ThreadLocalThreadLocalkey->ThreadLocalThreadLocalGCThreadLocalkey = null \n\n****\nthreadId=null\n\n****\nthreadId=nullThreadLocalEntryKeynull KeyThreadLocalMapnull KeyValueThreadLocalMapnull keyThread --> ThreadLocalMap-->Entry-->ValueEntryValueEntryKey<font color=red>ValueThreadLocalremove</font>\n\n**?**\n\n- ThreadLocal<font color=red>remove</font>\n- Value<font color=red>remove</font>Value\n\n## ThreadLocal\n\n### set\n\n```java\npublic void set(T value) {\n    //set\n    Thread t = Thread.currentThread();\n    //threadLocals\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        //threadLocalsthisThreadLocal\n        map.set(this, value);\n    else\n        //t.threadLocals\n        createMap(t, value);\n}\n\nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n\nvoid createMap(Thread t, T firstValue) {\n    //ThreadLocalMap ThreadLocalMapThreadLocal\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}\n```\n\n### get\n\n```java\npublic T get() {\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null) {\n        //ThreadLocalMapThreadLocalMapkey = ThreadLocal\n        ThreadLocalMap.Entry e = map.getEntry(this);\n        if (e != null) {\n            @SuppressWarnings(\"unchecked\")\n            T result = (T)e.value;\n            return result;\n        }\n    }\n    //t.threadLocals\n    return setInitialValue();\n}\n\n//\nprivate T setInitialValue() {\n    //initialValuevalue\n    T value = initialValue();\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        map.set(this, value);\n    else\n        createMap(t, value);\n    return value;\n}\n```\n\n### remove\n\n```java\npublic void remove() {\n    //ThreadLocalMapremove\n    ThreadLocalMap m = getMap(Thread.currentThread());\n    if (m != null)\n        m.remove(this);\n}\n```\n\n\n\n## ThreadLocalMap()\n\nThreadLocalThreadLocalMapThreadLocalMapThreadLocal\n\nThreadLocalMapHashMap\n\n### \n\n```java\n//EntryTheadLocalMapHashMapNode\n//keyThreadLocal\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    Object value;\n    Entry(ThreadLocal<?> k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n//2\nprivate static final int INITIAL_CAPACITY = 16;\n//Entry2 ThreadLocalMaptable\nprivate Entry[] table;\t\n//entry\nprivate int size = 0;\n//0\nprivate int threshold;\n```\n\n<font color=red>**ThreadLocalMapEntry[]**</font>\n\n![Entry[]](threadlocal/6.png)\n\nThreadLocalMapEntryEntrykeyThreadLocalThreadLocalvalueThreadLoacl\n\n### \n\n```java\nThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n    //table,16\n    table = new Entry[INITIAL_CAPACITY];\n    //\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n    //\n    table[i] = new Entry(firstKey, firstValue);\n    size = 1;\n    //\n    setThreshold(INITIAL_CAPACITY);\n}\nprivate void setThreshold(int len) {\n   threshold = len * 2 / 3;\n}\n```\n\n**ThreadLocal.threadLocalHashCode**\n\n```java\nprivate static AtomicInteger nextHashCode = new AtomicInteger();\n\nprivate final int threadLocalHashCode = nextHashCode();\n//\nprivate static final int HASH_INCREMENT = 0x61c88647;\n//ThreadLocalnextHashCodeHASH_INCREMENT\nprivate static int nextHashCode() {\n    return nextHashCode.getAndAdd(HASH_INCREMENT);\n}\n```\n\n `ThreadLocal` `getAndAdd(0x61c88647)`ThreadLocal<font color=red>0x61c88647ThreadLocalIDthreadLocalHashCode2</font>\n\n### set()\n\n```java\nprivate void set(ThreadLocal<?> key, Object value) {\n    Entry[] tab = table;\n    int len = tab.length;\n    //hash * (table.length - 1) \n    int i = key.threadLocalHashCode & (len-1);\n    //nextIndex\n    //ThreadLocalhash\n    for (Entry e = tab[i]; e != null ; e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal<?> k = e.get();\n        //iThreadLocalThraedLocal\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        //k == nullThreadLocalThreadLocalslot\n        if (k == null) {\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n        //\n    }\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        rehash();\n}\n\nprivate static int nextIndex(int i, int len) {\n   return ((i + 1 < len) ? i + 1 : 0);\n}\n```\n\n## \n\n- https://www.cnblogs.com/micrari/p/6790229.html","slug":"threadlocal","published":1,"updated":"2021-04-08T00:47:07.107Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw3004kqwv2gassfatz","content":"<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p>ThreadLocalJAVAThreadLocal</p>\n<a id=\"more\"></a>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>Test<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>TimeUnit<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>atomic<span class=\"token punctuation\">.</span>AtomicInteger<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ThreadLocalTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> AtomicInteger nextId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> ThreadLocal<span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span> threadId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token operator\">&lt;</span>Integer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> Integer <span class=\"token function\">initialValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> nextId<span class=\"token punctuation\">.</span><span class=\"token function\">getAndIncrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token annotation punctuation\">@Override</span>\n                <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadName=\"</span> <span class=\"token operator\">+</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\",threadId=\"</span> <span class=\"token operator\">+</span> threadId<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\nthreadName<span class=\"token operator\">=</span>Thread<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>threadId<span class=\"token operator\">=</span><span class=\"token number\">0</span>\nthreadName<span class=\"token operator\">=</span>Thread<span class=\"token operator\">-</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>threadId<span class=\"token operator\">=</span><span class=\"token number\">1</span>\nthreadName<span class=\"token operator\">=</span>Thread<span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>threadId<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nthreadName<span class=\"token operator\">=</span>Thread<span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>threadId<span class=\"token operator\">=</span><span class=\"token number\">3</span>\nthreadName<span class=\"token operator\">=</span>Thread<span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>threadId<span class=\"token operator\">=</span><span class=\"token number\">4</span></code></pre>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p>ThreadLocalThreadLocal</p>\n<p><img src=\"/2020/08/12/threadlocal/1.png\" alt=\"ThreadLocalMap\"></p>\n<p><img src=\"/2020/08/12/threadlocal/2.png\" alt=\"ThreadThreadLocalMap\"></p>\n<p></p>\n<ul>\n<li>ThreadLocalThreadLocalMapThreadLocalMapkeyThreadLocalObject</li>\n<li>ThreadthreadLocalsThreadLocal.ThreadLocalMap</li>\n<li><font color=\"red\">ThreadThreadLocalThreadLocal</font></li>\n</ul>\n<p>ThreadLocalThreadthreadLocalsThreadLocal</p>\n<p><img src=\"/2020/08/12/threadlocal/3.png\" alt=\"ThreadLocal\"></p>\n<ul>\n<li>ThreadLocalMapEntry</li>\n<li>ThreadLocalEntryThreadLocalMap</li>\n<li><strong>Entry</strong>ThreadLocalThreadLocalEntry,ThreadLocal</li>\n</ul>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p></p>\n<ul>\n<li>ThreadLocalMapEntry?</li>\n<li>ThreadLocal?</li>\n</ul>\n<p>GCThreadLocal.ThreadLocalMapEntry</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Entry</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WeakReference</span><span class=\"token operator\">&lt;</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">/** The value associated with this ThreadLocal. */</span>\n    Object value<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">Entry</span><span class=\"token punctuation\">(</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> k<span class=\"token punctuation\">,</span> Object v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        value <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><img src=\"/2020/08/12/threadlocal/4.png\" alt=\"ThreadLocalJVM\"></p>\n<p>22ThreadLocalMapEntry,keythreadId2keythreadId=nullkeyGC<br><img src=\"/2020/08/12/threadlocal/5.png\" alt=\"2\"><br><strong>ThreadLocalMapEntry</strong><br>threadId=nullThreadLocalRef-&gt;ThreadLocalthreadIdkey-&gt;ThreadLocalThreadLocalkey-&gt;ThreadLocalThreadLocalGCThreadLocalkey = null </p>\n<p><strong></strong><br>threadId=null</p>\n<p><strong></strong><br>threadId=nullThreadLocalEntryKeynull KeyThreadLocalMapnull KeyValueThreadLocalMapnull keyThread &gt; ThreadLocalMap&gt;Entry&gt;ValueEntryValueEntryKey<font color=\"red\">ValueThreadLocalremove</font></p>\n<p><strong>?</strong><br></p>\n<ul>\n<li>ThreadLocal<font color=\"red\">remove</font></li>\n<li>Value<font color=\"red\">remove</font>Value</li>\n</ul>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><h3 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"set\"></a>set</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>T value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//set</span>\n    Thread t <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//threadLocals</span>\n    ThreadLocalMap map <span class=\"token operator\">=</span> <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\" spellcheck=\"true\">//threadLocalsthisThreadLocal</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token comment\" spellcheck=\"true\">//t.threadLocals</span>\n        <span class=\"token function\">createMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nThreadLocalMap <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>Thread t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">.</span>threadLocals<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">createMap</span><span class=\"token punctuation\">(</span>Thread t<span class=\"token punctuation\">,</span> T firstValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ThreadLocalMap ThreadLocalMapThreadLocal</span>\n    t<span class=\"token punctuation\">.</span>threadLocals <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadLocalMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> firstValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> T <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Thread t <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ThreadLocalMap map <span class=\"token operator\">=</span> <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//ThreadLocalMapThreadLocalMapkey = ThreadLocal</span>\n        ThreadLocalMap<span class=\"token punctuation\">.</span>Entry e <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n            T result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">)</span>e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\" spellcheck=\"true\">//t.threadLocals</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">setInitialValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> T <span class=\"token function\">setInitialValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//initialValuevalue</span>\n    T value <span class=\"token operator\">=</span> <span class=\"token function\">initialValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Thread t <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ThreadLocalMap map <span class=\"token operator\">=</span> <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token function\">createMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ThreadLocalMapremove</span>\n    ThreadLocalMap m <span class=\"token operator\">=</span> <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span>\n        m<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"ThreadLocalMap-\"><a href=\"#ThreadLocalMap-\" class=\"headerlink\" title=\"ThreadLocalMap()\"></a>ThreadLocalMap()</h2><p>ThreadLocalThreadLocalMapThreadLocalMapThreadLocal</p>\n<p>ThreadLocalMapHashMap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//EntryTheadLocalMapHashMapNode</span>\n<span class=\"token comment\" spellcheck=\"true\">//keyThreadLocal</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Entry</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WeakReference</span><span class=\"token operator\">&lt;</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    Object value<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">Entry</span><span class=\"token punctuation\">(</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> k<span class=\"token punctuation\">,</span> Object v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        value <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//2</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> INITIAL_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//Entry2 ThreadLocalMaptable</span>\n<span class=\"token keyword\">private</span> Entry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> table<span class=\"token punctuation\">;</span>    \n<span class=\"token comment\" spellcheck=\"true\">//entry</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//0</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> threshold<span class=\"token punctuation\">;</span></code></pre>\n<p><font color=\"red\"><strong>ThreadLocalMapEntry[]</strong></font></p>\n<p><img src=\"/2020/08/12/threadlocal/6.png\" alt=\"Entry[]\"></p>\n<p>ThreadLocalMapEntryEntrykeyThreadLocalThreadLocalvalueThreadLoacl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token function\">ThreadLocalMap</span><span class=\"token punctuation\">(</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> firstKey<span class=\"token punctuation\">,</span> Object firstValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//table,16</span>\n    table <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span>INITIAL_CAPACITY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> firstKey<span class=\"token punctuation\">.</span>threadLocalHashCode <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>INITIAL_CAPACITY <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">(</span>firstKey<span class=\"token punctuation\">,</span> firstValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    size <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token function\">setThreshold</span><span class=\"token punctuation\">(</span>INITIAL_CAPACITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setThreshold</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> len<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   threshold <span class=\"token operator\">=</span> len <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">/</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>ThreadLocal.threadLocalHashCode</strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> AtomicInteger nextHashCode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> threadLocalHashCode <span class=\"token operator\">=</span> <span class=\"token function\">nextHashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> HASH_INCREMENT <span class=\"token operator\">=</span> <span class=\"token number\">0x61c88647</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//ThreadLocalnextHashCodeHASH_INCREMENT</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">nextHashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> nextHashCode<span class=\"token punctuation\">.</span><span class=\"token function\">getAndAdd</span><span class=\"token punctuation\">(</span>HASH_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p> <code>ThreadLocal</code> <code>getAndAdd(0x61c88647)</code>ThreadLocal<font color=\"red\">0x61c88647ThreadLocalIDthreadLocalHashCode2</font></p>\n<h3 id=\"set-\"><a href=\"#set-\" class=\"headerlink\" title=\"set()\"></a>set()</h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> key<span class=\"token punctuation\">,</span> Object value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Entry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> len <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//hash * (table.length - 1) </span>\n    <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span>threadLocalHashCode <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>len<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//nextIndex</span>\n    <span class=\"token comment\" spellcheck=\"true\">//ThreadLocalhash</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Entry e <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> null <span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>i <span class=\"token operator\">=</span> <span class=\"token function\">nextIndex</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        ThreadLocal<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token operator\">></span> k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//iThreadLocalThraedLocal</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">==</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//k == nullThreadLocalThreadLocalslot</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">replaceStaleEntry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token punctuation\">}</span>\n    tab<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> sz <span class=\"token operator\">=</span> <span class=\"token operator\">++</span>size<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">cleanSomeSlots</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> sz<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> sz <span class=\"token operator\">>=</span> threshold<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">rehash</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">nextIndex</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> len<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.cnblogs.com/micrari/p/6790229.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/micrari/p/6790229.html</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p>ThreadLocalJAVAThreadLocal</p>","more":"<pre><code class=\"java\">import org.junit.Test;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.atomic.AtomicInteger;\npublic class ThreadLocalTest {\n    private static final AtomicInteger nextId = new AtomicInteger(0);\n    private static final ThreadLocal&lt;Integer&gt; threadId = new ThreadLocal&lt;Integer&gt;(){\n        @Override\n        protected Integer initialValue() {\n            return nextId.getAndIncrement();\n        }\n    };\n    @Test\n    public void test1() throws InterruptedException {\n        for(int i = 0 ; i &lt; 5 ; i++){\n            new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    System.out.println(&quot;threadName=&quot; + Thread.currentThread().getName() + &quot;,threadId=&quot; + threadId.get());\n                }\n            },&quot;&quot; + i).start();\n        }\n        TimeUnit.SECONDS.sleep(2);\n    }\n}\n//\nthreadName=Thread-1,threadId=0\nthreadName=Thread-0,threadId=1\nthreadName=Thread-2,threadId=2\nthreadName=Thread-3,threadId=3\nthreadName=Thread-4,threadId=4</code></pre>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p>ThreadLocalThreadLocal</p>\n<p><img src=\"/2020/08/12/threadlocal/1.png\" alt=\"ThreadLocalMap\"></p>\n<p><img src=\"/2020/08/12/threadlocal/2.png\" alt=\"ThreadThreadLocalMap\"></p>\n<p></p>\n<ul>\n<li>ThreadLocalThreadLocalMapThreadLocalMapkeyThreadLocalObject</li>\n<li>ThreadthreadLocalsThreadLocal.ThreadLocalMap</li>\n<li><font color=\"red\">ThreadThreadLocalThreadLocal</font></li>\n</ul>\n<p>ThreadLocalThreadthreadLocalsThreadLocal</p>\n<p><img src=\"/2020/08/12/threadlocal/3.png\" alt=\"ThreadLocal\"></p>\n<ul>\n<li>ThreadLocalMapEntry</li>\n<li>ThreadLocalEntryThreadLocalMap</li>\n<li><strong>Entry</strong>ThreadLocalThreadLocalEntry,ThreadLocal</li>\n</ul>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><p></p>\n<ul>\n<li>ThreadLocalMapEntry?</li>\n<li>ThreadLocal?</li>\n</ul>\n<p>GCThreadLocal.ThreadLocalMapEntry</p>\n<pre><code class=\"java\">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {\n    /** The value associated with this ThreadLocal. */\n    Object value;\n\n    Entry(ThreadLocal&lt;?&gt; k, Object v) {\n        super(k);\n        value = v;\n    }\n}</code></pre>\n<p><img src=\"/2020/08/12/threadlocal/4.png\" alt=\"ThreadLocalJVM\"></p>\n<p>22ThreadLocalMapEntry,keythreadId2keythreadId=nullkeyGC<br><img src=\"/2020/08/12/threadlocal/5.png\" alt=\"2\"><br><strong>ThreadLocalMapEntry</strong><br>threadId=nullThreadLocalRef-&gt;ThreadLocalthreadIdkey-&gt;ThreadLocalThreadLocalkey-&gt;ThreadLocalThreadLocalGCThreadLocalkey = null </p>\n<p><strong></strong><br>threadId=null</p>\n<p><strong></strong><br>threadId=nullThreadLocalEntryKeynull KeyThreadLocalMapnull KeyValueThreadLocalMapnull keyThread &gt; ThreadLocalMap&gt;Entry&gt;ValueEntryValueEntryKey<font color=\"red\">ValueThreadLocalremove</font></p>\n<p><strong>?</strong><br></p>\n<ul>\n<li>ThreadLocal<font color=\"red\">remove</font></li>\n<li>Value<font color=\"red\">remove</font>Value</li>\n</ul>\n<h2 id=\"ThreadLocal\"><a href=\"#ThreadLocal\" class=\"headerlink\" title=\"ThreadLocal\"></a>ThreadLocal</h2><h3 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"set\"></a>set</h3><pre><code class=\"java\">public void set(T value) {\n    //set\n    Thread t = Thread.currentThread();\n    //threadLocals\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        //threadLocalsthisThreadLocal\n        map.set(this, value);\n    else\n        //t.threadLocals\n        createMap(t, value);\n}\n\nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n\nvoid createMap(Thread t, T firstValue) {\n    //ThreadLocalMap ThreadLocalMapThreadLocal\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}</code></pre>\n<h3 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"get\"></a>get</h3><pre><code class=\"java\">public T get() {\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null) {\n        //ThreadLocalMapThreadLocalMapkey = ThreadLocal\n        ThreadLocalMap.Entry e = map.getEntry(this);\n        if (e != null) {\n            @SuppressWarnings(&quot;unchecked&quot;)\n            T result = (T)e.value;\n            return result;\n        }\n    }\n    //t.threadLocals\n    return setInitialValue();\n}\n\n//\nprivate T setInitialValue() {\n    //initialValuevalue\n    T value = initialValue();\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        map.set(this, value);\n    else\n        createMap(t, value);\n    return value;\n}</code></pre>\n<h3 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h3><pre><code class=\"java\">public void remove() {\n    //ThreadLocalMapremove\n    ThreadLocalMap m = getMap(Thread.currentThread());\n    if (m != null)\n        m.remove(this);\n}</code></pre>\n<h2 id=\"ThreadLocalMap-\"><a href=\"#ThreadLocalMap-\" class=\"headerlink\" title=\"ThreadLocalMap()\"></a>ThreadLocalMap()</h2><p>ThreadLocalThreadLocalMapThreadLocalMapThreadLocal</p>\n<p>ThreadLocalMapHashMap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">//EntryTheadLocalMapHashMapNode\n//keyThreadLocal\nstatic class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {\n    Object value;\n    Entry(ThreadLocal&lt;?&gt; k, Object v) {\n        super(k);\n        value = v;\n    }\n}\n//2\nprivate static final int INITIAL_CAPACITY = 16;\n//Entry2 ThreadLocalMaptable\nprivate Entry[] table;    \n//entry\nprivate int size = 0;\n//0\nprivate int threshold;</code></pre>\n<p><font color=\"red\"><strong>ThreadLocalMapEntry[]</strong></font></p>\n<p><img src=\"/2020/08/12/threadlocal/6.png\" alt=\"Entry[]\"></p>\n<p>ThreadLocalMapEntryEntrykeyThreadLocalThreadLocalvalueThreadLoacl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {\n    //table,16\n    table = new Entry[INITIAL_CAPACITY];\n    //\n    int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);\n    //\n    table[i] = new Entry(firstKey, firstValue);\n    size = 1;\n    //\n    setThreshold(INITIAL_CAPACITY);\n}\nprivate void setThreshold(int len) {\n   threshold = len * 2 / 3;\n}</code></pre>\n<p><strong>ThreadLocal.threadLocalHashCode</strong></p>\n<pre><code class=\"java\">private static AtomicInteger nextHashCode = new AtomicInteger();\n\nprivate final int threadLocalHashCode = nextHashCode();\n//\nprivate static final int HASH_INCREMENT = 0x61c88647;\n//ThreadLocalnextHashCodeHASH_INCREMENT\nprivate static int nextHashCode() {\n    return nextHashCode.getAndAdd(HASH_INCREMENT);\n}</code></pre>\n<p> <code>ThreadLocal</code> <code>getAndAdd(0x61c88647)</code>ThreadLocal<font color=\"red\">0x61c88647ThreadLocalIDthreadLocalHashCode2</font></p>\n<h3 id=\"set-\"><a href=\"#set-\" class=\"headerlink\" title=\"set()\"></a>set()</h3><pre><code class=\"java\">private void set(ThreadLocal&lt;?&gt; key, Object value) {\n    Entry[] tab = table;\n    int len = tab.length;\n    //hash * (table.length - 1) \n    int i = key.threadLocalHashCode &amp; (len-1);\n    //nextIndex\n    //ThreadLocalhash\n    for (Entry e = tab[i]; e != null ; e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal&lt;?&gt; k = e.get();\n        //iThreadLocalThraedLocal\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        //k == nullThreadLocalThreadLocalslot\n        if (k == null) {\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n        //\n    }\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)\n        rehash();\n}\n\nprivate static int nextIndex(int i, int len) {\n   return ((i + 1 &lt; len) ? i + 1 : 0);\n}</code></pre>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.cnblogs.com/micrari/p/6790229.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/micrari/p/6790229.html</a></li>\n</ul>"},{"title":"classString","description":"classString","_content":"## \nclass\n## class\n <font color=red>=</font> Class\n\n, Class Java ClassClassClassClass````\n\n![](sring-class/1.jpg)\n\n<!--more-->\n\n\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        int a = 11;\n        String s = \"helloWorld\";\n    }\n}\n```\n\n javap -v OtherTest.class\n\n![](sring-class/4.png)\n\n### \n\n\n\nint a=11a1111`11``helloWorld`\n\n### \n\n *  *  * `xzy//OtherTest``main``([Ljava/lang/String;)V`\n\n## \n\n<font color=red></font>\n\nClassJavaClass(<font color=red></font>)\n\nClassJavaClass\n\n\n\n## Class\n\n![](sring-class/2.jpg)\n\n## \n,String Pool<font color=red>HeapString</font>\nJVM,JDK7JDK7\n\n**?**\n\n\n\n- () public static final String str = \"hello\"\n- String str = \"hello\"\n- \n- newString str = new String()\n\nJVM<font color=red>-XX:+PrintStringTableStatistics</font>\n\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \t//\n    }\n}\n// 1774\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes\n```\n\n1\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = \"hello\";\n    }\n}\n//+1\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n2\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = \"hello\";\n        String str2 = \"hello\";\n    }\n}\n//1775strstr2str2\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n\n3new\n\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = new String(\"hello\");\n    }\n}\n//1775\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n\n4\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i < 10; i++) {\n            String temp = String.valueOf(i);\n        }\n    }\n}\n#\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes\n```\n\n5intern\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i < 10; i++) {\n            String temp = String.valueOf(i).intern();\n        }\n    }\n}\n//10\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1784 =     42816 bytes, avg  24.000\nNumber of literals      :      1784 =    159312 bytes, avg  89.300\nTotal footprint         :           =    682232 bytes\n```\n\n**String str = new String(\"hello\")**\n\njavap\n\n```java\npackage xzy;\npublic class OtherTest {\n    public static void main(String[] args) {\n        String str = new String(\"hello\");\n    }\n}\n\n//\nCompiled from \"OtherTest.java\"\npublic class xzy.OtherTest {\n  public xzy.OtherTest();\n    Code:\n       0: aload_0\n       1: invokespecial #1                  // Method java/lang/Object.\"<init>\":()V\n       4: return\n\n  public static void main(java.lang.String[]);\n    Code:\n       0: new           #2                  // class java/lang/String    -- newString\n       3: dup                                                            -- (dup)\n       4: ldc           #3                  // String hello              -- (ldc)hello\n       6: invokespecial #4                  // Method java/lang/String.\"<init>\":(Ljava/lang/String;)V --(invokespecial)\n       9: astore_1                            --(astore_1)str     \n      10: return\n}\n```\n\nhello\n\n`String str = new String(\"A\" + \"B\")` \n\n+1A,B,ABA+BABclass\n\n![](sring-class/1.png)\n\n**JVM**\n\n `String str = \"ABC\"` ABC<font color=red></font>\n\n abcnew String(\"abc\")<font color=red>abc</font>\n\n**<font color=green>abcJVM</font>**\n\n```java\npublic static void main(String[] args){\n\tString str = \"hello\";\n}\n```\n\n1.  \"hello\" classclass\n2.  classJVMclass \"hello\" \n3. String str = \"hello\"JVMJVMstrhellostr\n\n**JVM**\n\neverorStringeverorString str = new String(everor);String str = everor;everor\n\n## \n\n- StringJVM\n- classclass\n- classclass\n\n## \n\n- [JVMClass](https://www.baidu.com/link?url=M8Bauh76JXr4VhFH84A2uK6PkDyDwfw8Si1uo23sMjKXirLJF2BHwIutcY1jMBx03jjyPJmnrXVVMyt_N_-jP_&wd=&eqid=b278744100018add000000065f237350)\n- [class](https://blog.csdn.net/u011552955/article/details/100079685)\n- https://segmentfault.com/a/1190000017952075?utm_source=tag-newest\n- https://mrdear.cn/posts/java-string-pool.html","source":"_posts/sring-class.md","raw":"---\ntitle: classString\ntags:\n  - jvm\ncategories:  java\ndescription: classString\n---\n## \nclass\n## class\n <font color=red>=</font> Class\n\n, Class Java ClassClassClassClass````\n\n![](sring-class/1.jpg)\n\n<!--more-->\n\n\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        int a = 11;\n        String s = \"helloWorld\";\n    }\n}\n```\n\n javap -v OtherTest.class\n\n![](sring-class/4.png)\n\n### \n\n\n\nint a=11a1111`11``helloWorld`\n\n### \n\n *  *  * `xzy//OtherTest``main``([Ljava/lang/String;)V`\n\n## \n\n<font color=red></font>\n\nClassJavaClass(<font color=red></font>)\n\nClassJavaClass\n\n\n\n## Class\n\n![](sring-class/2.jpg)\n\n## \n,String Pool<font color=red>HeapString</font>\nJVM,JDK7JDK7\n\n**?**\n\n\n\n- () public static final String str = \"hello\"\n- String str = \"hello\"\n- \n- newString str = new String()\n\nJVM<font color=red>-XX:+PrintStringTableStatistics</font>\n\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \t//\n    }\n}\n// 1774\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes\n```\n\n1\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = \"hello\";\n    }\n}\n//+1\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n2\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = \"hello\";\n        String str2 = \"hello\";\n    }\n}\n//1775strstr2str2\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n\n3new\n\n```java\npublic class OtherTest {\n    public static void main(String[] args){\n    \tString str = new String(\"hello\");\n    }\n}\n//1775\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes\n```\n\n4\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i < 10; i++) {\n            String temp = String.valueOf(i);\n        }\n    }\n}\n#\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes\n```\n\n5intern\n\n```java\npublic class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i < 10; i++) {\n            String temp = String.valueOf(i).intern();\n        }\n    }\n}\n//10\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1784 =     42816 bytes, avg  24.000\nNumber of literals      :      1784 =    159312 bytes, avg  89.300\nTotal footprint         :           =    682232 bytes\n```\n\n**String str = new String(\"hello\")**\n\njavap\n\n```java\npackage xzy;\npublic class OtherTest {\n    public static void main(String[] args) {\n        String str = new String(\"hello\");\n    }\n}\n\n//\nCompiled from \"OtherTest.java\"\npublic class xzy.OtherTest {\n  public xzy.OtherTest();\n    Code:\n       0: aload_0\n       1: invokespecial #1                  // Method java/lang/Object.\"<init>\":()V\n       4: return\n\n  public static void main(java.lang.String[]);\n    Code:\n       0: new           #2                  // class java/lang/String    -- newString\n       3: dup                                                            -- (dup)\n       4: ldc           #3                  // String hello              -- (ldc)hello\n       6: invokespecial #4                  // Method java/lang/String.\"<init>\":(Ljava/lang/String;)V --(invokespecial)\n       9: astore_1                            --(astore_1)str     \n      10: return\n}\n```\n\nhello\n\n`String str = new String(\"A\" + \"B\")` \n\n+1A,B,ABA+BABclass\n\n![](sring-class/1.png)\n\n**JVM**\n\n `String str = \"ABC\"` ABC<font color=red></font>\n\n abcnew String(\"abc\")<font color=red>abc</font>\n\n**<font color=green>abcJVM</font>**\n\n```java\npublic static void main(String[] args){\n\tString str = \"hello\";\n}\n```\n\n1.  \"hello\" classclass\n2.  classJVMclass \"hello\" \n3. String str = \"hello\"JVMJVMstrhellostr\n\n**JVM**\n\neverorStringeverorString str = new String(everor);String str = everor;everor\n\n## \n\n- StringJVM\n- classclass\n- classclass\n\n## \n\n- [JVMClass](https://www.baidu.com/link?url=M8Bauh76JXr4VhFH84A2uK6PkDyDwfw8Si1uo23sMjKXirLJF2BHwIutcY1jMBx03jjyPJmnrXVVMyt_N_-jP_&wd=&eqid=b278744100018add000000065f237350)\n- [class](https://blog.csdn.net/u011552955/article/details/100079685)\n- https://segmentfault.com/a/1190000017952075?utm_source=tag-newest\n- https://mrdear.cn/posts/java-string-pool.html","slug":"sring-class","published":1,"date":"2021-04-08T00:47:07.077Z","updated":"2021-04-08T00:47:07.077Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw5004nqwv2d3r39hb6","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>class</p>\n<h2 id=\"class\"><a href=\"#class\" class=\"headerlink\" title=\"class\"></a>class</h2><p> <font color=\"red\">=</font> Class</p>\n<p>, Class Java ClassClassClassClass<code></code><code></code></p>\n<p><img src=\"/2021/04/08/sring-class/1.jpg\" alt></p>\n<a id=\"more\"></a>\n\n<p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n        String s <span class=\"token operator\">=</span> <span class=\"token string\">\"helloWorld\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p> javap -v OtherTest.class</p>\n<p><img src=\"/2021/04/08/sring-class/4.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>int a=11a1111<code>11</code><code>helloWorld</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> *  *  * <code>xzy//OtherTest</code><code>main</code><code>([Ljava/lang/String;)V</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font color=\"red\"></font></p>\n<p>ClassJavaClass(<font color=\"red\"></font>)</p>\n<p>ClassJavaClass</p>\n<h2 id=\"Class\"><a href=\"#Class\" class=\"headerlink\" title=\"Class\"></a>Class</h2><p><img src=\"/2021/04/08/sring-class/2.jpg\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>,String Pool<font color=\"red\">HeapString</font><br>JVM,JDK7JDK7</p>\n<p><strong>?</strong></p>\n<p></p>\n<ul>\n<li>() public static final String str = hello</li>\n<li>String str = hello</li>\n<li></li>\n<li>newString str = new String()</li>\n</ul>\n<p>JVM<font color=\"red\">-XX:+PrintStringTableStatistics</font></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// 1774</span>\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1774</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42576</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1774</span> <span class=\"token operator\">=</span>    <span class=\"token number\">158832</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.533</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">681512</span> bytes</code></pre>\n<p>1</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        String str <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//+1</span>\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42600</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>    <span class=\"token number\">158888</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.514</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">681592</span> bytes</code></pre>\n<p>2</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        String str <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n        String str2 <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//1775strstr2str2</span>\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42600</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>    <span class=\"token number\">158888</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.514</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">681592</span> bytes</code></pre>\n<p>3new</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        String str <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//1775</span>\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42600</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1775</span> <span class=\"token operator\">=</span>    <span class=\"token number\">158888</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.514</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">681592</span> bytes</code></pre>\n<p>4</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            String temp <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n#\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1774</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42576</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1774</span> <span class=\"token operator\">=</span>    <span class=\"token number\">158832</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.533</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">681512</span> bytes</code></pre>\n<p>5intern</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            String temp <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">intern</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//10</span>\nStringTable statistics<span class=\"token operator\">:</span>\nNumber of buckets       <span class=\"token operator\">:</span>     <span class=\"token number\">60013</span> <span class=\"token operator\">=</span>    <span class=\"token number\">480104</span> bytes<span class=\"token punctuation\">,</span> avg   <span class=\"token number\">8.000</span>\nNumber of entries       <span class=\"token operator\">:</span>      <span class=\"token number\">1784</span> <span class=\"token operator\">=</span>     <span class=\"token number\">42816</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">24.000</span>\nNumber of literals      <span class=\"token operator\">:</span>      <span class=\"token number\">1784</span> <span class=\"token operator\">=</span>    <span class=\"token number\">159312</span> bytes<span class=\"token punctuation\">,</span> avg  <span class=\"token number\">89.300</span>\nTotal footprint         <span class=\"token operator\">:</span>           <span class=\"token operator\">=</span>    <span class=\"token number\">682232</span> bytes</code></pre>\n<p><strong>String str = new String(hello)</strong></p>\n<p>javap</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> xzy<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OtherTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        String str <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//</span>\nCompiled from <span class=\"token string\">\"OtherTest.java\"</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">xzy<span class=\"token punctuation\">.</span>OtherTest</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> xzy<span class=\"token punctuation\">.</span><span class=\"token function\">OtherTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Code<span class=\"token operator\">:</span>\n       <span class=\"token number\">0</span><span class=\"token operator\">:</span> aload_0\n       <span class=\"token number\">1</span><span class=\"token operator\">:</span> invokespecial #<span class=\"token number\">1</span>                  <span class=\"token comment\" spellcheck=\"true\">// Method java/lang/Object.\"&lt;init>\":()V</span>\n       <span class=\"token number\">4</span><span class=\"token operator\">:</span> <span class=\"token keyword\">return</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Code<span class=\"token operator\">:</span>\n       <span class=\"token number\">0</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span>           #<span class=\"token number\">2</span>                  <span class=\"token comment\" spellcheck=\"true\">// class java/lang/String    -- newString</span>\n       <span class=\"token number\">3</span><span class=\"token operator\">:</span> dup                                                            <span class=\"token operator\">--</span> <span class=\"token punctuation\">(</span>dup<span class=\"token punctuation\">)</span>\n       <span class=\"token number\">4</span><span class=\"token operator\">:</span> ldc           #<span class=\"token number\">3</span>                  <span class=\"token comment\" spellcheck=\"true\">// String hello              -- (ldc)hello</span>\n       <span class=\"token number\">6</span><span class=\"token operator\">:</span> invokespecial #<span class=\"token number\">4</span>                  <span class=\"token comment\" spellcheck=\"true\">// Method java/lang/String.\"&lt;init>\":(Ljava/lang/String;)V --(invokespecial)</span>\n       <span class=\"token number\">9</span><span class=\"token operator\">:</span> astore_1                            <span class=\"token operator\">--</span><span class=\"token punctuation\">(</span>astore_1<span class=\"token punctuation\">)</span>str     \n      <span class=\"token number\">10</span><span class=\"token operator\">:</span> <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>hello</p>\n<p><code>String str = new String(&quot;A&quot; + &quot;B&quot;)</code> </p>\n<p>+1A,B,ABA+BABclass</p>\n<p><img src=\"/2021/04/08/sring-class/1.png\" alt></p>\n<p><strong>JVM</strong></p>\n<p> <code>String str = &quot;ABC&quot;</code> ABC<font color=\"red\"></font></p>\n<p> abcnew String(abc)<font color=\"red\">abc</font></p>\n<p><strong><font color=\"green\">abcJVM</font></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    String str <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<ol>\n<li> hello classclass</li>\n<li> classJVMclass hello </li>\n<li>String str = helloJVMJVMstrhellostr</li>\n</ol>\n<p><strong>JVM</strong></p>\n<p>everorStringeverorString str = new String(everor);String str = everor;everor</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>StringJVM</li>\n<li>classclass</li>\n<li>classclass</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.baidu.com/link?url=M8Bauh76JXr4VhFH84A2uK6PkDyDwfw8Si1uo23sMjKXirLJF2BHwIutcY1jMBx03jjyPJmnrXVVMyt_N_-jP_&wd=&eqid=b278744100018add000000065f237350\" target=\"_blank\" rel=\"noopener\">JVMClass</a></li>\n<li><a href=\"https://blog.csdn.net/u011552955/article/details/100079685\" target=\"_blank\" rel=\"noopener\">class</a></li>\n<li><a href=\"https://segmentfault.com/a/1190000017952075?utm_source=tag-newest\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000017952075?utm_source=tag-newest</a></li>\n<li><a href=\"https://mrdear.cn/posts/java-string-pool.html\" target=\"_blank\" rel=\"noopener\">https://mrdear.cn/posts/java-string-pool.html</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>class</p>\n<h2 id=\"class\"><a href=\"#class\" class=\"headerlink\" title=\"class\"></a>class</h2><p> <font color=\"red\">=</font> Class</p>\n<p>, Class Java ClassClassClassClass<code></code><code></code></p>\n<p><img src=\"/2021/04/08/sring-class/1.jpg\" alt></p>","more":"<p></p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args) {\n        int a = 11;\n        String s = &quot;helloWorld&quot;;\n    }\n}</code></pre>\n<p> javap -v OtherTest.class</p>\n<p><img src=\"/2021/04/08/sring-class/4.png\" alt=\"\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>int a=11a1111<code>11</code><code>helloWorld</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> *  *  * <code>xzy//OtherTest</code><code>main</code><code>([Ljava/lang/String;)V</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font color=\"red\"></font></p>\n<p>ClassJavaClass(<font color=\"red\"></font>)</p>\n<p>ClassJavaClass</p>\n<h2 id=\"Class\"><a href=\"#Class\" class=\"headerlink\" title=\"Class\"></a>Class</h2><p><img src=\"/2021/04/08/sring-class/2.jpg\" alt></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>,String Pool<font color=\"red\">HeapString</font><br>JVM,JDK7JDK7</p>\n<p><strong>?</strong></p>\n<p></p>\n<ul>\n<li>() public static final String str = hello</li>\n<li>String str = hello</li>\n<li></li>\n<li>newString str = new String()</li>\n</ul>\n<p>JVM<font color=\"red\">-XX:+PrintStringTableStatistics</font></p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args){\n        //\n    }\n}\n// 1774\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes</code></pre>\n<p>1</p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args){\n        String str = &quot;hello&quot;;\n    }\n}\n//+1\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes</code></pre>\n<p>2</p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args){\n        String str = &quot;hello&quot;;\n        String str2 = &quot;hello&quot;;\n    }\n}\n//1775strstr2str2\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes</code></pre>\n<p>3new</p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args){\n        String str = new String(&quot;hello&quot;);\n    }\n}\n//1775\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1775 =     42600 bytes, avg  24.000\nNumber of literals      :      1775 =    158888 bytes, avg  89.514\nTotal footprint         :           =    681592 bytes</code></pre>\n<p>4</p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i &lt; 10; i++) {\n            String temp = String.valueOf(i);\n        }\n    }\n}\n#\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1774 =     42576 bytes, avg  24.000\nNumber of literals      :      1774 =    158832 bytes, avg  89.533\nTotal footprint         :           =    681512 bytes</code></pre>\n<p>5intern</p>\n<pre><code class=\"java\">public class OtherTest {\n    public static void main(String[] args) {\n        for (int i = 0; i &lt; 10; i++) {\n            String temp = String.valueOf(i).intern();\n        }\n    }\n}\n//10\nStringTable statistics:\nNumber of buckets       :     60013 =    480104 bytes, avg   8.000\nNumber of entries       :      1784 =     42816 bytes, avg  24.000\nNumber of literals      :      1784 =    159312 bytes, avg  89.300\nTotal footprint         :           =    682232 bytes</code></pre>\n<p><strong>String str = new String(hello)</strong></p>\n<p>javap</p>\n<pre><code class=\"java\">package xzy;\npublic class OtherTest {\n    public static void main(String[] args) {\n        String str = new String(&quot;hello&quot;);\n    }\n}\n\n//\nCompiled from &quot;OtherTest.java&quot;\npublic class xzy.OtherTest {\n  public xzy.OtherTest();\n    Code:\n       0: aload_0\n       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V\n       4: return\n\n  public static void main(java.lang.String[]);\n    Code:\n       0: new           #2                  // class java/lang/String    -- newString\n       3: dup                                                            -- (dup)\n       4: ldc           #3                  // String hello              -- (ldc)hello\n       6: invokespecial #4                  // Method java/lang/String.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V --(invokespecial)\n       9: astore_1                            --(astore_1)str     \n      10: return\n}</code></pre>\n<p>hello</p>\n<p><code>String str = new String(&quot;A&quot; + &quot;B&quot;)</code> </p>\n<p>+1A,B,ABA+BABclass</p>\n<p><img src=\"/2021/04/08/sring-class/1.png\" alt></p>\n<p><strong>JVM</strong></p>\n<p> <code>String str = &quot;ABC&quot;</code> ABC<font color=\"red\"></font></p>\n<p> abcnew String(abc)<font color=\"red\">abc</font></p>\n<p><strong><font color=\"green\">abcJVM</font></strong></p>\n<pre><code class=\"java\">public static void main(String[] args){\n    String str = &quot;hello&quot;;\n}</code></pre>\n<ol>\n<li> hello classclass</li>\n<li> classJVMclass hello </li>\n<li>String str = helloJVMJVMstrhellostr</li>\n</ol>\n<p><strong>JVM</strong></p>\n<p>everorStringeverorString str = new String(everor);String str = everor;everor</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>StringJVM</li>\n<li>classclass</li>\n<li>classclass</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.baidu.com/link?url=M8Bauh76JXr4VhFH84A2uK6PkDyDwfw8Si1uo23sMjKXirLJF2BHwIutcY1jMBx03jjyPJmnrXVVMyt_N_-jP_&wd=&eqid=b278744100018add000000065f237350\" target=\"_blank\" rel=\"noopener\">JVMClass</a></li>\n<li><a href=\"https://blog.csdn.net/u011552955/article/details/100079685\" target=\"_blank\" rel=\"noopener\">class</a></li>\n<li><a href=\"https://segmentfault.com/a/1190000017952075?utm_source=tag-newest\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000017952075?utm_source=tag-newest</a></li>\n<li><a href=\"https://mrdear.cn/posts/java-string-pool.html\" target=\"_blank\" rel=\"noopener\">https://mrdear.cn/posts/java-string-pool.html</a></li>\n</ul>"},{"title":"javavolatile","description":"volatile","date":"2019-07-18T02:00:00.000Z","_content":"\n## Java(jmm)\n\n```java\npublic class VolatileExample extends Thread{\n    //,\n    private  static boolean flag = false;\n    //,flagtrue\n   public void run() {\n       while (!flag){\n       };\n       System.out.println(\"\");\n   }\n\n    public static void main(String[] args) throws Exception {\n        new VolatileExample().start();\n        //sleep,run\n        Thread.sleep(100);\n        flag = true;\n    }\n}\n```\nflagtrue\n<!--more-->\n***?***\n\nJava\n\n![](volatile/1.png)\nJMMflagflagflag\n\n## volatile\n### \n- \n- \n- Java\n\n### volatile\nvolatile\n- volatile\n- \n\n### volatile\n\nhttps://www.toutiao.com/a6845877313154843148/\n\n**CPU**\n\n![](volatile/2.png)\n\nCPUCPUCPU0CPU0CPU1CPU**MESI**<font color=red>CPUCPUCPU</font>\n\n**(MESI)**\n\nCPUCPUCPUCPU \n\nvolatile<font color=red>lock</font>\n\n```\n0x000000010d3f3203: lock addl $0x0,(%rsp)     ;*putstatic flag\n; - com.java.study.VolatileStudy::lambda$main$1@9 (line 31)\n```\n\nlock\n\n- \n- CPU\n\n**volatilevolatile**\n\n### volatile\nvolatile<font color=red>lock</font>lock\n\n- \n\nhappens-before\n\n```\nx = 1; //1\ny = 10; //2\nc = x + y; //3\n```\n1,231,2happens-before\n**volatile?**\n```\nx = 2;        //1\ny = 0;        //2\nflag = true;  //3 flagvolatile\nx = 4;         //4\ny = -1;       //5\n```\nflagvolatile3123451245\n\n<font color=red></font>JMMvolatile4JMMvolatile4\n\n- volatileStoreStorevolatile\n- volatileStoreLoadvolatile\n- volatileLoadLoadvolatile\n- volatileLoadStorevolatile\n\n### volatile\n\n****,volatile\n```\nvolatile int i = 5;\ntemp = i + 1;\ni = temp;\n```\nivolatileABi = 5A temp = i + 1; temp6 i 5Btemp = i + 1; temp = 6,ABi = temp+1\n\n## javavolatile\n### \n```\npublic class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}\n```\nvolatile1BinstancenullBinstanceA\n new Object()  Cache cache=new Cache()\n```\n\t//  Cache \n       0: new           #5                  // class com/query/Cache\n       // \n       3: dup\n\t//  Cache \n       4: invokespecial #6                  // Method \"<init>\":()V\n\t// \n       7: astore_1\n```\n\n1. \n2. \n3. \n\n 2,3  1  1  2,3  1 volatile\n### happens-before\n\nhappens-beforeJMMJavavolatilesynchronizedJavaJava(happens-before)\n\nhappends-before<font color=red></font>a1a1\n\n1. \n2. unLocklock\n3. volatile\n4. ABBCAC\n5. Threadstart()\n6. interrupt()\n7. Thread.join()Thread.isAlive()\n8. finalize()\n\n### as-if-serial\n\nas-if-serial****as-if-serial\n\n## \n\n- volatilevolatile\n- volatile\n- volatile\n\n## \n\n- https://www.toutiao.com/a6839502799437300237/","source":"_posts/volatile.md","raw":"---\ntitle: javavolatile\ntags:\n  - java\ncategories:  java\ndescription : volatile\ndate: 2019-07-18 10:00:00\n---\n\n## Java(jmm)\n\n```java\npublic class VolatileExample extends Thread{\n    //,\n    private  static boolean flag = false;\n    //,flagtrue\n   public void run() {\n       while (!flag){\n       };\n       System.out.println(\"\");\n   }\n\n    public static void main(String[] args) throws Exception {\n        new VolatileExample().start();\n        //sleep,run\n        Thread.sleep(100);\n        flag = true;\n    }\n}\n```\nflagtrue\n<!--more-->\n***?***\n\nJava\n\n![](volatile/1.png)\nJMMflagflagflag\n\n## volatile\n### \n- \n- \n- Java\n\n### volatile\nvolatile\n- volatile\n- \n\n### volatile\n\nhttps://www.toutiao.com/a6845877313154843148/\n\n**CPU**\n\n![](volatile/2.png)\n\nCPUCPUCPU0CPU0CPU1CPU**MESI**<font color=red>CPUCPUCPU</font>\n\n**(MESI)**\n\nCPUCPUCPUCPU \n\nvolatile<font color=red>lock</font>\n\n```\n0x000000010d3f3203: lock addl $0x0,(%rsp)     ;*putstatic flag\n; - com.java.study.VolatileStudy::lambda$main$1@9 (line 31)\n```\n\nlock\n\n- \n- CPU\n\n**volatilevolatile**\n\n### volatile\nvolatile<font color=red>lock</font>lock\n\n- \n\nhappens-before\n\n```\nx = 1; //1\ny = 10; //2\nc = x + y; //3\n```\n1,231,2happens-before\n**volatile?**\n```\nx = 2;        //1\ny = 0;        //2\nflag = true;  //3 flagvolatile\nx = 4;         //4\ny = -1;       //5\n```\nflagvolatile3123451245\n\n<font color=red></font>JMMvolatile4JMMvolatile4\n\n- volatileStoreStorevolatile\n- volatileStoreLoadvolatile\n- volatileLoadLoadvolatile\n- volatileLoadStorevolatile\n\n### volatile\n\n****,volatile\n```\nvolatile int i = 5;\ntemp = i + 1;\ni = temp;\n```\nivolatileABi = 5A temp = i + 1; temp6 i 5Btemp = i + 1; temp = 6,ABi = temp+1\n\n## javavolatile\n### \n```\npublic class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}\n```\nvolatile1BinstancenullBinstanceA\n new Object()  Cache cache=new Cache()\n```\n\t//  Cache \n       0: new           #5                  // class com/query/Cache\n       // \n       3: dup\n\t//  Cache \n       4: invokespecial #6                  // Method \"<init>\":()V\n\t// \n       7: astore_1\n```\n\n1. \n2. \n3. \n\n 2,3  1  1  2,3  1 volatile\n### happens-before\n\nhappens-beforeJMMJavavolatilesynchronizedJavaJava(happens-before)\n\nhappends-before<font color=red></font>a1a1\n\n1. \n2. unLocklock\n3. volatile\n4. ABBCAC\n5. Threadstart()\n6. interrupt()\n7. Thread.join()Thread.isAlive()\n8. finalize()\n\n### as-if-serial\n\nas-if-serial****as-if-serial\n\n## \n\n- volatilevolatile\n- volatile\n- volatile\n\n## \n\n- https://www.toutiao.com/a6839502799437300237/","slug":"volatile","published":1,"updated":"2021-04-08T00:47:07.117Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw6004sqwv2c40o9wr5","content":"<h2 id=\"Java-jmm\"><a href=\"#Java-jmm\" class=\"headerlink\" title=\"Java(jmm)\"></a>Java(jmm)</h2><p></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VolatileExample</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//,</span>\n    <span class=\"token keyword\">private</span>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> flag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">//,flagtrue</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n       <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n       System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">VolatileExample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//sleep,run</span>\n        Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>flagtrue</p>\n<a id=\"more\"></a>\n<p><strong><em>?</em></strong></p>\n<p>Java</p>\n<p><img src=\"/2019/07/18/volatile/1.png\" alt><br>JMMflagflagflag</p>\n<h2 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n<li>Java</li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p>volatile</p>\n<ul>\n<li>volatile</li>\n<li></li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p><a href=\"https://www.toutiao.com/a6845877313154843148/\" target=\"_blank\" rel=\"noopener\">https://www.toutiao.com/a6845877313154843148/</a></p>\n<p><strong>CPU</strong></p>\n<p><img src=\"/2019/07/18/volatile/2.png\" alt></p>\n<p>CPUCPUCPU0CPU0CPU1CPU<strong>MESI</strong><font color=\"red\">CPUCPUCPU</font></p>\n<p><strong>(MESI)</strong></p>\n<p>CPUCPUCPUCPU </p>\n<p>volatile<font color=\"red\">lock</font></p>\n<pre><code>0x000000010d3f3203: lock addl $0x0,(%rsp)     ;*putstatic flag\n; - com.java.study.VolatileStudy::lambda$main$1@9 (line 31)</code></pre><p>lock</p>\n<ul>\n<li></li>\n<li>CPU</li>\n</ul>\n<p><strong>volatilevolatile</strong></p>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p>volatile<font color=\"red\">lock</font>lock</p>\n<ul>\n<li></li>\n</ul>\n<p>happens-before</p>\n<pre><code>x = 1; //1\ny = 10; //2\nc = x + y; //3</code></pre><p>1,231,2happens-before<br><strong>volatile?</strong></p>\n<pre><code>x = 2;        //1\ny = 0;        //2\nflag = true;  //3 flagvolatile\nx = 4;         //4\ny = -1;       //5</code></pre><p>flagvolatile3123451245</p>\n<p><font color=\"red\"></font>JMMvolatile4JMMvolatile4</p>\n<ul>\n<li>volatileStoreStorevolatile</li>\n<li>volatileStoreLoadvolatile</li>\n<li>volatileLoadLoadvolatile</li>\n<li>volatileLoadStorevolatile</li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p><strong></strong>,volatile</p>\n<pre><code>volatile int i = 5;\ntemp = i + 1;\ni = temp;</code></pre><p>ivolatileABi = 5A temp = i + 1; temp6 i 5Btemp = i + 1; temp = 6,ABi = temp+1</p>\n<h2 id=\"javavolatile\"><a href=\"#javavolatile\" class=\"headerlink\" title=\"javavolatile\"></a>javavolatile</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>public class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}</code></pre><p>volatile1BinstancenullBinstanceA<br> new Object()  Cache cache=new Cache()</p>\n<pre><code>    //  Cache \n       0: new           #5                  // class com/query/Cache\n       // \n       3: dup\n    //  Cache \n       4: invokespecial #6                  // Method &quot;&lt;init&gt;&quot;:()V\n    // \n       7: astore_1</code></pre><p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> 2,3  1  1  2,3  1 volatile</p>\n<h3 id=\"happens-before\"><a href=\"#happens-before\" class=\"headerlink\" title=\"happens-before\"></a>happens-before</h3><p>happens-beforeJMMJavavolatilesynchronizedJavaJava(happens-before)</p>\n<p>happends-before<font color=\"red\"></font>a1a1</p>\n<ol>\n<li></li>\n<li>unLocklock</li>\n<li>volatile</li>\n<li>ABBCAC</li>\n<li>Threadstart()</li>\n<li>interrupt()</li>\n<li>Thread.join()Thread.isAlive()</li>\n<li>finalize()</li>\n</ol>\n<h3 id=\"as-if-serial\"><a href=\"#as-if-serial\" class=\"headerlink\" title=\"as-if-serial\"></a>as-if-serial</h3><p>as-if-serial<strong></strong>as-if-serial</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>volatilevolatile</li>\n<li>volatile</li>\n<li>volatile</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.toutiao.com/a6839502799437300237/\" target=\"_blank\" rel=\"noopener\">https://www.toutiao.com/a6839502799437300237/</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"Java-jmm\"><a href=\"#Java-jmm\" class=\"headerlink\" title=\"Java(jmm)\"></a>Java(jmm)</h2><p></p>\n<pre><code class=\"java\">public class VolatileExample extends Thread{\n    //,\n    private  static boolean flag = false;\n    //,flagtrue\n   public void run() {\n       while (!flag){\n       };\n       System.out.println(&quot;&quot;);\n   }\n\n    public static void main(String[] args) throws Exception {\n        new VolatileExample().start();\n        //sleep,run\n        Thread.sleep(100);\n        flag = true;\n    }\n}</code></pre>\n<p>flagtrue</p>","more":"<p><strong><em>?</em></strong></p>\n<p>Java</p>\n<p><img src=\"/2019/07/18/volatile/1.png\" alt><br>JMMflagflagflag</p>\n<h2 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n<li>Java</li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p>volatile</p>\n<ul>\n<li>volatile</li>\n<li></li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p><a href=\"https://www.toutiao.com/a6845877313154843148/\" target=\"_blank\" rel=\"noopener\">https://www.toutiao.com/a6845877313154843148/</a></p>\n<p><strong>CPU</strong></p>\n<p><img src=\"/2019/07/18/volatile/2.png\" alt></p>\n<p>CPUCPUCPU0CPU0CPU1CPU<strong>MESI</strong><font color=\"red\">CPUCPUCPU</font></p>\n<p><strong>(MESI)</strong></p>\n<p>CPUCPUCPUCPU </p>\n<p>volatile<font color=\"red\">lock</font></p>\n<pre><code>0x000000010d3f3203: lock addl $0x0,(%rsp)     ;*putstatic flag\n; - com.java.study.VolatileStudy::lambda$main$1@9 (line 31)</code></pre><p>lock</p>\n<ul>\n<li></li>\n<li>CPU</li>\n</ul>\n<p><strong>volatilevolatile</strong></p>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p>volatile<font color=\"red\">lock</font>lock</p>\n<ul>\n<li></li>\n</ul>\n<p>happens-before</p>\n<pre><code>x = 1; //1\ny = 10; //2\nc = x + y; //3</code></pre><p>1,231,2happens-before<br><strong>volatile?</strong></p>\n<pre><code>x = 2;        //1\ny = 0;        //2\nflag = true;  //3 flagvolatile\nx = 4;         //4\ny = -1;       //5</code></pre><p>flagvolatile3123451245</p>\n<p><font color=\"red\"></font>JMMvolatile4JMMvolatile4</p>\n<ul>\n<li>volatileStoreStorevolatile</li>\n<li>volatileStoreLoadvolatile</li>\n<li>volatileLoadLoadvolatile</li>\n<li>volatileLoadStorevolatile</li>\n</ul>\n<h3 id=\"volatile\"><a href=\"#volatile\" class=\"headerlink\" title=\"volatile\"></a>volatile</h3><p><strong></strong>,volatile</p>\n<pre><code>volatile int i = 5;\ntemp = i + 1;\ni = temp;</code></pre><p>ivolatileABi = 5A temp = i + 1; temp6 i 5Btemp = i + 1; temp = 6,ABi = temp+1</p>\n<h2 id=\"javavolatile\"><a href=\"#javavolatile\" class=\"headerlink\" title=\"javavolatile\"></a>javavolatile</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>public class SingletonFour {\n    private static volatile SingletonFour singletonFour;\n    private SingletonFour(){}\n    private static SingletonFour getSingleton(){\n        if(singletonFour == null){  //\n            synchronized (SingletonFour.class){\n                if(singletonFour == null) //\n                    singletonFour = new SingletonFour(); // 1\n            }\n        }\n        return singletonFour;\n    }\n}</code></pre><p>volatile1BinstancenullBinstanceA<br> new Object()  Cache cache=new Cache()</p>\n<pre><code>    //  Cache \n       0: new           #5                  // class com/query/Cache\n       // \n       3: dup\n    //  Cache \n       4: invokespecial #6                  // Method &quot;&lt;init&gt;&quot;:()V\n    // \n       7: astore_1</code></pre><p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> 2,3  1  1  2,3  1 volatile</p>\n<h3 id=\"happens-before\"><a href=\"#happens-before\" class=\"headerlink\" title=\"happens-before\"></a>happens-before</h3><p>happens-beforeJMMJavavolatilesynchronizedJavaJava(happens-before)</p>\n<p>happends-before<font color=\"red\"></font>a1a1</p>\n<ol>\n<li></li>\n<li>unLocklock</li>\n<li>volatile</li>\n<li>ABBCAC</li>\n<li>Threadstart()</li>\n<li>interrupt()</li>\n<li>Thread.join()Thread.isAlive()</li>\n<li>finalize()</li>\n</ol>\n<h3 id=\"as-if-serial\"><a href=\"#as-if-serial\" class=\"headerlink\" title=\"as-if-serial\"></a>as-if-serial</h3><p>as-if-serial<strong></strong>as-if-serial</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li>volatilevolatile</li>\n<li>volatile</li>\n<li>volatile</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.toutiao.com/a6839502799437300237/\" target=\"_blank\" rel=\"noopener\">https://www.toutiao.com/a6839502799437300237/</a></li>\n</ul>"},{"title":"java","description":"javainterrupt()Thread.interrupt()isInterrupted()","date":"2020-08-27T02:57:08.000Z","_content":"\n## \n\njavainterrupt()Thread.interrupt()isInterrupted()\n<!--more-->\n## \n\n\n\n|                  |              |                                                          |\n| -------------------- | -------------------- | ------------------------------------------------------------ |\n| interrupt()          | Thread | isInterrupted()Thread.interrupted()interruptedException |\n| isInterrupted()      | Thread |              |\n| Thread.interrupted() | Thread | (currentThread()) |\n\n\n\n- Thread.interrupted()\n- boolean isInterrupted(boolean ClearInterrupted)\n\n```java\n//Thread.interrupted();\npublic static boolean interrupted() {\n    return currentThread().isInterrupted(true);\n}\n//this.isInterrupted\npublic boolean isInterrupted() {\n    return isInterrupted(false);\n}\nprivate native boolean isInterrupted(boolean ClearInterrupted);\n```\n\n\n\n## stop\n\n<font color=red></font>stop``stop``stop\n\n## \n\nrunwhilebooleantruefalsewhile\n\n```java\npublic class myTest {\n\t//volatile\n    public static volatile boolean exit =false;  //\n    public static void main(String[] args) {\n        new Thread() {\n            public void run() {\n                System.out.println(\"\");\n                while (!exit) {\n                    System.out.println(\"............\");\n                }\n                System.out.println(\"\");\n            }\n        }.start();\n        \n        try {\n            Thread.sleep(1000 * 5);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        exit = true;//5,\n    }\n}\n```\n\n## interrupt()+InterruptedException\n\nThread.sleepwaitIOinterruptsleepInterruptedException\n\n```java\npublic class Interrupt2 {\n    public static void main(String[] args) {\n        Thread thread = new Thread(new MyThread(), \"testThread\");\n        thread.start();\n        try {\n            Thread.sleep(5000);\n        } catch (InterruptedException e) {\n\n        }\n        MyThread.on = true;\n        thread.interrupt();\n    }\n\n    static class MyThread extends Thread {\n        private volatile static boolean on = false;\n        @Override\n        public void run() {\n            //\n            //\n            while (!on) {\n                try {\n                    System.out.println(\"begin Sleep\");\n                    Thread.sleep(10000000);\n                    System.out.println(\"end Sleep\");\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                System.out.println(\"Oh, myGod!\");\n            }\n        }\n    }\n}\n```\n\n## interrupt()+isInterrupted()\n\n+\n\n```java\npublic class Interrupt {\n    public static void main(String[] agrs) {\n        try{\n            MyThread myThread = new MyThread();\n            myThread.start();\n            TimeUnit.SECONDS.sleep(1); //\n            myThread.interrupt(); //\n        }catch (Exception e){\n            System.out.println(\"main catch\");\n            e.printStackTrace();\n        }\n    }\n\n    static class MyThread extends Thread {\n        @Override\n        public void run() {\n            for (int i = 0; i < 500000; i++) {\n                if (this.isInterrupted()) {\n                    System.out.println(\"should be stopped and exit\");\n                    break;\n                }\n                System.out.println(\"i=\" + (i + 1));\n            }\n            System.out.println(\"this line is also executed. thread does not stopped\"); //,\n        }\n    }\n}\n```\n\n","source":"_posts/thread-interrupted.md","raw":"---\ntitle: java\ntags:\n  - java\ncategories:  java\ndescription : javainterrupt()Thread.interrupt()isInterrupted()\ndate: 2020-08-27 10:57:08\n---\n\n## \n\njavainterrupt()Thread.interrupt()isInterrupted()\n<!--more-->\n## \n\n\n\n|                  |              |                                                          |\n| -------------------- | -------------------- | ------------------------------------------------------------ |\n| interrupt()          | Thread | isInterrupted()Thread.interrupted()interruptedException |\n| isInterrupted()      | Thread |              |\n| Thread.interrupted() | Thread | (currentThread()) |\n\n\n\n- Thread.interrupted()\n- boolean isInterrupted(boolean ClearInterrupted)\n\n```java\n//Thread.interrupted();\npublic static boolean interrupted() {\n    return currentThread().isInterrupted(true);\n}\n//this.isInterrupted\npublic boolean isInterrupted() {\n    return isInterrupted(false);\n}\nprivate native boolean isInterrupted(boolean ClearInterrupted);\n```\n\n\n\n## stop\n\n<font color=red></font>stop``stop``stop\n\n## \n\nrunwhilebooleantruefalsewhile\n\n```java\npublic class myTest {\n\t//volatile\n    public static volatile boolean exit =false;  //\n    public static void main(String[] args) {\n        new Thread() {\n            public void run() {\n                System.out.println(\"\");\n                while (!exit) {\n                    System.out.println(\"............\");\n                }\n                System.out.println(\"\");\n            }\n        }.start();\n        \n        try {\n            Thread.sleep(1000 * 5);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        exit = true;//5,\n    }\n}\n```\n\n## interrupt()+InterruptedException\n\nThread.sleepwaitIOinterruptsleepInterruptedException\n\n```java\npublic class Interrupt2 {\n    public static void main(String[] args) {\n        Thread thread = new Thread(new MyThread(), \"testThread\");\n        thread.start();\n        try {\n            Thread.sleep(5000);\n        } catch (InterruptedException e) {\n\n        }\n        MyThread.on = true;\n        thread.interrupt();\n    }\n\n    static class MyThread extends Thread {\n        private volatile static boolean on = false;\n        @Override\n        public void run() {\n            //\n            //\n            while (!on) {\n                try {\n                    System.out.println(\"begin Sleep\");\n                    Thread.sleep(10000000);\n                    System.out.println(\"end Sleep\");\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                System.out.println(\"Oh, myGod!\");\n            }\n        }\n    }\n}\n```\n\n## interrupt()+isInterrupted()\n\n+\n\n```java\npublic class Interrupt {\n    public static void main(String[] agrs) {\n        try{\n            MyThread myThread = new MyThread();\n            myThread.start();\n            TimeUnit.SECONDS.sleep(1); //\n            myThread.interrupt(); //\n        }catch (Exception e){\n            System.out.println(\"main catch\");\n            e.printStackTrace();\n        }\n    }\n\n    static class MyThread extends Thread {\n        @Override\n        public void run() {\n            for (int i = 0; i < 500000; i++) {\n                if (this.isInterrupted()) {\n                    System.out.println(\"should be stopped and exit\");\n                    break;\n                }\n                System.out.println(\"i=\" + (i + 1));\n            }\n            System.out.println(\"this line is also executed. thread does not stopped\"); //,\n        }\n    }\n}\n```\n\n","slug":"thread-interrupted","published":1,"updated":"2021-04-08T00:47:07.107Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw7004vqwv2doo29zz0","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>javainterrupt()Thread.interrupt()isInterrupted()</p>\n<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>interrupt()</td>\n<td>Thread</td>\n<td>isInterrupted()Thread.interrupted()interruptedException</td>\n</tr>\n<tr>\n<td>isInterrupted()</td>\n<td>Thread</td>\n<td></td>\n</tr>\n<tr>\n<td>Thread.interrupted()</td>\n<td>Thread</td>\n<td>(currentThread())</td>\n</tr>\n</tbody></table>\n<p></p>\n<ul>\n<li>Thread.interrupted()</li>\n<li>boolean isInterrupted(boolean ClearInterrupted)</li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">//Thread.interrupted();</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//this.isInterrupted</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> ClearInterrupted<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"stop\"><a href=\"#stop\" class=\"headerlink\" title=\"stop\"></a>stop</h2><p><font color=\"red\"></font>stop<code></code>stop<code></code>stop</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>runwhilebooleantruefalsewhile</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">myTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">//volatile</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">boolean</span> exit <span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\" spellcheck=\"true\">//</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>exit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"............\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        exit <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">//5,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"interrupt-InterruptedException\"><a href=\"#interrupt-InterruptedException\" class=\"headerlink\" title=\"interrupt()+InterruptedException\"></a>interrupt()+InterruptedException</h2><p>Thread.sleepwaitIOinterruptsleepInterruptedException</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Interrupt2</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Thread thread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">MyThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"testThread\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        thread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token punctuation\">}</span>\n        MyThread<span class=\"token punctuation\">.</span>on <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        thread<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> on <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>on<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"begin Sleep\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end Sleep\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Oh, myGod!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"interrupt-isInterrupted-\"><a href=\"#interrupt-isInterrupted-\" class=\"headerlink\" title=\"interrupt()+isInterrupted()\"></a>interrupt()+isInterrupted()</h2><p>+</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Interrupt</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> agrs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n            MyThread myThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            myThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            myThread<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token punctuation\">}</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main catch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">500000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be stopped and exit\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"i=\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"this line is also executed. thread does not stopped\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>javainterrupt()Thread.interrupt()isInterrupted()</p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>interrupt()</td>\n<td>Thread</td>\n<td>isInterrupted()Thread.interrupted()interruptedException</td>\n</tr>\n<tr>\n<td>isInterrupted()</td>\n<td>Thread</td>\n<td></td>\n</tr>\n<tr>\n<td>Thread.interrupted()</td>\n<td>Thread</td>\n<td>(currentThread())</td>\n</tr>\n</tbody></table>\n<p></p>\n<ul>\n<li>Thread.interrupted()</li>\n<li>boolean isInterrupted(boolean ClearInterrupted)</li>\n</ul>\n<pre><code class=\"java\">//Thread.interrupted();\npublic static boolean interrupted() {\n    return currentThread().isInterrupted(true);\n}\n//this.isInterrupted\npublic boolean isInterrupted() {\n    return isInterrupted(false);\n}\nprivate native boolean isInterrupted(boolean ClearInterrupted);</code></pre>\n<h2 id=\"stop\"><a href=\"#stop\" class=\"headerlink\" title=\"stop\"></a>stop</h2><p><font color=\"red\"></font>stop<code></code>stop<code></code>stop</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>runwhilebooleantruefalsewhile</p>\n<pre><code class=\"java\">public class myTest {\n    //volatile\n    public static volatile boolean exit =false;  //\n    public static void main(String[] args) {\n        new Thread() {\n            public void run() {\n                System.out.println(&quot;&quot;);\n                while (!exit) {\n                    System.out.println(&quot;............&quot;);\n                }\n                System.out.println(&quot;&quot;);\n            }\n        }.start();\n\n        try {\n            Thread.sleep(1000 * 5);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        exit = true;//5,\n    }\n}</code></pre>\n<h2 id=\"interrupt-InterruptedException\"><a href=\"#interrupt-InterruptedException\" class=\"headerlink\" title=\"interrupt()+InterruptedException\"></a>interrupt()+InterruptedException</h2><p>Thread.sleepwaitIOinterruptsleepInterruptedException</p>\n<pre><code class=\"java\">public class Interrupt2 {\n    public static void main(String[] args) {\n        Thread thread = new Thread(new MyThread(), &quot;testThread&quot;);\n        thread.start();\n        try {\n            Thread.sleep(5000);\n        } catch (InterruptedException e) {\n\n        }\n        MyThread.on = true;\n        thread.interrupt();\n    }\n\n    static class MyThread extends Thread {\n        private volatile static boolean on = false;\n        @Override\n        public void run() {\n            //\n            //\n            while (!on) {\n                try {\n                    System.out.println(&quot;begin Sleep&quot;);\n                    Thread.sleep(10000000);\n                    System.out.println(&quot;end Sleep&quot;);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                System.out.println(&quot;Oh, myGod!&quot;);\n            }\n        }\n    }\n}</code></pre>\n<h2 id=\"interrupt-isInterrupted-\"><a href=\"#interrupt-isInterrupted-\" class=\"headerlink\" title=\"interrupt()+isInterrupted()\"></a>interrupt()+isInterrupted()</h2><p>+</p>\n<pre><code class=\"java\">public class Interrupt {\n    public static void main(String[] agrs) {\n        try{\n            MyThread myThread = new MyThread();\n            myThread.start();\n            TimeUnit.SECONDS.sleep(1); //\n            myThread.interrupt(); //\n        }catch (Exception e){\n            System.out.println(&quot;main catch&quot;);\n            e.printStackTrace();\n        }\n    }\n\n    static class MyThread extends Thread {\n        @Override\n        public void run() {\n            for (int i = 0; i &lt; 500000; i++) {\n                if (this.isInterrupted()) {\n                    System.out.println(&quot;should be stopped and exit&quot;);\n                    break;\n                }\n                System.out.println(&quot;i=&quot; + (i + 1));\n            }\n            System.out.println(&quot;this line is also executed. thread does not stopped&quot;); //,\n        }\n    }\n}</code></pre>"},{"title":"Zookeeper","description":"Zookeeper","date":"2020-08-27T09:06:06.000Z","_content":"\n\n\n\n## \n\n\n\n## \n\n### \n\n()watch\n\n()watch\n\n![](zookeeper-lock/1.png)\n<!--more-->\n1.  lock \n2.  lock  lock  watcher\n3.  lock  Zookeeper  lock \n4.  lock \n5. 4\n\n### \n\n****\n\n```java\npackage lock;\n\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.KeeperException;\n\nimport java.util.UUID;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\n\n/***\n * zk\n */\npublic class ZkOnlyLock {\n    private static String lockNameSpace = \"/mylock\";\n    public static String CONNECT_ADDR = \"localhost:2181\";\n    private static final ThreadLocal<String> threadUuid = new ThreadLocal<String>() {\n        @Override\n        protected String initialValue() {\n            return UUID.randomUUID().toString();\n        }\n    };\n    private CuratorFramework cf;\n    private String locakPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyLock(String lockPath) {\n        this.locakPath = lockNameSpace + \"/\" + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(\"\");//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(\"\");\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(\"\");\n                }\n            }\n        });\n        cf.start();\n    }\n\n    public void lock() {\n        this.lock(0, null);\n    }\n\t\n    public void lock(long millisToWait, TimeUnit unit) {\n        boolean doDeleteOurPath = false;\n        for (;doDeleteOurPath == false;) {\n            try {\n                String path = cf.create()\n                        .creatingParentsIfNeeded() //\n                        .withMode(CreateMode.PERSISTENT)\n                        .forPath(locakPath, threadUuid.get().getBytes());\n                if (StringUtils.isNoneBlank(path)) {\n                    System.out.println(\"\" + Thread.currentThread().getId() + \"\");\n                    break;\n                }\n            } catch (Exception e) {\n                if (e instanceof KeeperException.NodeExistsException) {\n                    //watch\n                    NodeCache cache = new NodeCache(cf, locakPath);\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                System.out.println(\"======\");\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    try {\n                        cache.start();\n                    } catch (Exception exception) {\n                        exception.printStackTrace();\n                    }\n                    try {\n                        if (unit != null) {\n                            countDownLatch.await(millisToWait, unit);\n                            doDeleteOurPath = true;\n                        } else {\n                            countDownLatch.await();\n                        }\n                        CloseableUtils.closeQuietly(cache);\n                    } catch (InterruptedException interruptedException) {\n                        interruptedException.printStackTrace();\n                    }\n                }\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        try {\n            String uuidData = new String(cf.getData().forPath(locakPath), \"UTF-8\");\n            //uuid\n            if (StringUtils.isNoneBlank(uuidData) && uuidData.equals(threadUuid.get())) {\n                cf.delete().forPath(locakPath);\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            threadUuid.remove();\n        }\n    }\n}\n```\n\n****\n\n```java\n/****\n     * \n     */\n    @Test\n    public void onlyLockTest1() {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(\"lock001\");\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for (int i = 0; i < 5; i++) {\n            executorService.execute(() -> {\n                try {\n                    zkOnlyLock.lock();\n                    System.out.println(\"ing\");\n                    try {\n                        TimeUnit.SECONDS.sleep(5);\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                } finally {\n                    zkOnlyLock.unlock();\n                }\n            });\n        }\n    }\n\n    /***\n     * \n     * @throws InterruptedException\n     */\n    @Test\n    public void onlyLockTest2() throws InterruptedException {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(\"lock001\");\n        Thread thread = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    TimeUnit.SECONDS.sleep(1);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                zkOnlyLock.lock(10,TimeUnit.SECONDS);\n                System.out.println(\"====do=====\");\n                zkOnlyLock.unlock();\n            }\n        });\n        thread.start();\n        zkOnlyLock.lock();\n        TimeUnit.SECONDS.sleep(30);\n        zkOnlyLock.unlock();\n        thread.join();\n    }\n```\n\n### \n\nwatchZookeeper\n\n## \n\n### \n\n![](zookeeper-lock/2.png)\n\n![](zookeeper-lock/3.png)\n\n1. ()\n2.  Zookeeper  /share_lock\n3. ()watcher\n4. \n5. 4\n\n### \n\n```java\npackage lock;\n\nimport com.google.common.collect.Lists;\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.data.Stat;\n\nimport java.util.List;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\nimport java.util.stream.Collectors;\n\n/***\n * \n */\npublic class ZkOnlyFairLock {\n    private static String lockNameSpace = \"/mylock02\";\n    public static String CONNECT_ADDR = \"localhost:2181\";\n    private CuratorFramework cf;\n    private String locakPath;\n    private String currentLockPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyFairLock(String lockPath) {\n        this.locakPath = lockNameSpace + \"/\" + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(\"\");//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(\"\");\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(\"\");\n                }\n            }\n        });\n        cf.start();\n    }\n\n    /***\n     * watch+\n     * @param millisToWait\n     * @param unit\n     * @param path\n     * @return\n     * @throws Exception\n     */\n    public boolean waiteLock(long millisToWait, TimeUnit unit, String path) {\n        boolean haveTheLock = false;\n        boolean doDeleteOurPath = false;\n        try {\n\n            while (!haveTheLock) {\n                List<String> childNodeList = getChildrenPath();// [lock0000000005, lock0000000006, lock0000000007]\n                String pathName = path.substring(lockNameSpace.length() + 1);\n                int nodeIndex = childNodeList.indexOf(pathName);\n                if (nodeIndex < 0) {\n                    //\n                    throw new RuntimeException(\"\");\n                }\n\n                if (nodeIndex == 0) {\n                    haveTheLock = true; //\n                    System.out.println(\"path = \" + path + \" \");\n                } else {\n                    //\n                    String preNodePath = lockNameSpace.concat(\"/\").concat(childNodeList.get(nodeIndex - 1));\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    //\n                    NodeCache cache = new NodeCache(cf, preNodePath);\n                    //\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    cache.start();\n                    //\n                    if (isExistNode(preNodePath)) {\n                        System.out.println(\"====path=\" + preNodePath + \" watch -\" + path);\n                        countDownLatch.await();\n                    } else {\n                        CloseableUtils.closeQuietly(cache);\n                    }\n                }\n            }\n        } catch (Exception e) {\n            //\n            doDeleteOurPath = true;\n        } finally {\n            if (doDeleteOurPath) {\n                deleteNode(path);\n            }\n        }\n        return haveTheLock;\n    }\n\n    public void lock() throws Exception {\n        this.lock(0, null);\n    }\n\n    /***\n     * \n     */\n    public void lock(long millisToWait, TimeUnit unit) throws Exception {\n        boolean isDone = false;\n        //\n        while (!isDone) {\n            String path = createNode(); // path = /mylock02/lock0000000005\n            this.currentLockPath = path; //\n            if (StringUtils.isBlank(path)) {\n                throw new RuntimeException(\"\");\n            }\n            if (waiteLock(millisToWait, unit, path)) {\n                isDone = true;\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        deleteNode(this.currentLockPath);\n        CloseableUtils.closeQuietly(cf);\n    }\n\n    /***\n     * \n     * @return\n     * @throws Exception\n     */\n    public String createNode() {\n        String s = null;\n        try {\n            s = cf.create()\n                    .creatingParentsIfNeeded() //\n                    .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)\n                    .forPath(locakPath);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return s;\n    }\n\n    /***\n     * \n     * @param path\n     */\n    public void deleteNode(String path) {\n        try {\n            if (isExistNode(path)) {\n                cf.delete().forPath(path);\n                System.out.println(\"====\" + path + \" \");\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    /***\n     * \n     * @param path\n     * @return\n     */\n    public boolean isExistNode(String path) {\n        try {\n            Stat stat = cf.checkExists().forPath(path);\n            return stat == null ? false : true;\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return false;\n    }\n\n    /***\n     * \n     * @return\n     */\n    public List<String> getChildrenPath() {\n        try {\n            List<String> strings = cf.getChildren().forPath(lockNameSpace);\n            return strings.stream().sorted().collect(Collectors.toList());\n        } catch (Exception e) {\n            e.printStackTrace();\n            return Lists.newArrayList();\n        }\n    }\n\n}\n\n```\n\n****\n\n```java\n@Test\n    public void zkOnlyFairLock01() throws InterruptedException {\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for(int i = 0 ; i < 100; i++){\n            executorService.submit(() -> {\n                ZkOnlyFairLock zkLock = new ZkOnlyFairLock(\"lock\");\n                try {\n                    zkLock.lock();\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(2);\n                } catch (Exception e) {\n                    e.printStackTrace();\n                }finally {\n                    zkLock.unlock();\n                }\n            });\n        }\n        executorService.awaitTermination(10,TimeUnit.MINUTES);\n    }\n```\n\n## Curator\n\nCuratorZookeeper\n\n- InterProcessMutex\n- InterProcessSemaphoreMutex\n- InterProcessReadWriteLock\n- InterProcessMultiLock\n\n### \n\nInterProcessSemaphoreMutex\n\n```java\n@Test\npublic void curtorLock001() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i < 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(\"localhost:2181\",new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessSemaphoreMutex(cf, \"/curator/lock\");\n                try{\n                    cf.start();\n                    lock.acquire(); //\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}\n```\n\n### \n\n\n\nInterProcessMutexzookeeperuuid + watcherwatcher\n\n```java\n@Test\npublic void curtorLock002() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i < 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(\"localhost:2181\",new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessMutex(cf, \"/curator/lock\");\n                try{\n                    cf.start();\n                    lock.acquire();\n                    lock.acquire();\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}\n```\n\n###  \n\nInterProcessReadWriteLock\n\n### \n\nInterProcessMultiLock\n\n## zk\n\nZKleader ZK \n\n\n\n- Rediszkwatchkey\n- RedisclientAredisredisredisredisredis,redisclientA clientBzkleaderleader\n\n## \n\n- https://www.jianshu.com/p/6e20e65f301a\n- http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/\n- https://www.jianshu.com/p/7fe495c93290","source":"_posts/zookeeper-lock.md","raw":"---\ntitle: Zookeeper\ntags:\n  - zookeeper\ncategories:  zookeeper\ndescription : Zookeeper\ndate: 2020-08-27 17:06:06\n---\n\n\n\n\n## \n\n\n\n## \n\n### \n\n()watch\n\n()watch\n\n![](zookeeper-lock/1.png)\n<!--more-->\n1.  lock \n2.  lock  lock  watcher\n3.  lock  Zookeeper  lock \n4.  lock \n5. 4\n\n### \n\n****\n\n```java\npackage lock;\n\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.KeeperException;\n\nimport java.util.UUID;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\n\n/***\n * zk\n */\npublic class ZkOnlyLock {\n    private static String lockNameSpace = \"/mylock\";\n    public static String CONNECT_ADDR = \"localhost:2181\";\n    private static final ThreadLocal<String> threadUuid = new ThreadLocal<String>() {\n        @Override\n        protected String initialValue() {\n            return UUID.randomUUID().toString();\n        }\n    };\n    private CuratorFramework cf;\n    private String locakPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyLock(String lockPath) {\n        this.locakPath = lockNameSpace + \"/\" + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(\"\");//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(\"\");\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(\"\");\n                }\n            }\n        });\n        cf.start();\n    }\n\n    public void lock() {\n        this.lock(0, null);\n    }\n\t\n    public void lock(long millisToWait, TimeUnit unit) {\n        boolean doDeleteOurPath = false;\n        for (;doDeleteOurPath == false;) {\n            try {\n                String path = cf.create()\n                        .creatingParentsIfNeeded() //\n                        .withMode(CreateMode.PERSISTENT)\n                        .forPath(locakPath, threadUuid.get().getBytes());\n                if (StringUtils.isNoneBlank(path)) {\n                    System.out.println(\"\" + Thread.currentThread().getId() + \"\");\n                    break;\n                }\n            } catch (Exception e) {\n                if (e instanceof KeeperException.NodeExistsException) {\n                    //watch\n                    NodeCache cache = new NodeCache(cf, locakPath);\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                System.out.println(\"======\");\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    try {\n                        cache.start();\n                    } catch (Exception exception) {\n                        exception.printStackTrace();\n                    }\n                    try {\n                        if (unit != null) {\n                            countDownLatch.await(millisToWait, unit);\n                            doDeleteOurPath = true;\n                        } else {\n                            countDownLatch.await();\n                        }\n                        CloseableUtils.closeQuietly(cache);\n                    } catch (InterruptedException interruptedException) {\n                        interruptedException.printStackTrace();\n                    }\n                }\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        try {\n            String uuidData = new String(cf.getData().forPath(locakPath), \"UTF-8\");\n            //uuid\n            if (StringUtils.isNoneBlank(uuidData) && uuidData.equals(threadUuid.get())) {\n                cf.delete().forPath(locakPath);\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            threadUuid.remove();\n        }\n    }\n}\n```\n\n****\n\n```java\n/****\n     * \n     */\n    @Test\n    public void onlyLockTest1() {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(\"lock001\");\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for (int i = 0; i < 5; i++) {\n            executorService.execute(() -> {\n                try {\n                    zkOnlyLock.lock();\n                    System.out.println(\"ing\");\n                    try {\n                        TimeUnit.SECONDS.sleep(5);\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                } finally {\n                    zkOnlyLock.unlock();\n                }\n            });\n        }\n    }\n\n    /***\n     * \n     * @throws InterruptedException\n     */\n    @Test\n    public void onlyLockTest2() throws InterruptedException {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(\"lock001\");\n        Thread thread = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    TimeUnit.SECONDS.sleep(1);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                zkOnlyLock.lock(10,TimeUnit.SECONDS);\n                System.out.println(\"====do=====\");\n                zkOnlyLock.unlock();\n            }\n        });\n        thread.start();\n        zkOnlyLock.lock();\n        TimeUnit.SECONDS.sleep(30);\n        zkOnlyLock.unlock();\n        thread.join();\n    }\n```\n\n### \n\nwatchZookeeper\n\n## \n\n### \n\n![](zookeeper-lock/2.png)\n\n![](zookeeper-lock/3.png)\n\n1. ()\n2.  Zookeeper  /share_lock\n3. ()watcher\n4. \n5. 4\n\n### \n\n```java\npackage lock;\n\nimport com.google.common.collect.Lists;\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.data.Stat;\n\nimport java.util.List;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\nimport java.util.stream.Collectors;\n\n/***\n * \n */\npublic class ZkOnlyFairLock {\n    private static String lockNameSpace = \"/mylock02\";\n    public static String CONNECT_ADDR = \"localhost:2181\";\n    private CuratorFramework cf;\n    private String locakPath;\n    private String currentLockPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyFairLock(String lockPath) {\n        this.locakPath = lockNameSpace + \"/\" + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(\"\");//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(\"\");\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(\"\");\n                }\n            }\n        });\n        cf.start();\n    }\n\n    /***\n     * watch+\n     * @param millisToWait\n     * @param unit\n     * @param path\n     * @return\n     * @throws Exception\n     */\n    public boolean waiteLock(long millisToWait, TimeUnit unit, String path) {\n        boolean haveTheLock = false;\n        boolean doDeleteOurPath = false;\n        try {\n\n            while (!haveTheLock) {\n                List<String> childNodeList = getChildrenPath();// [lock0000000005, lock0000000006, lock0000000007]\n                String pathName = path.substring(lockNameSpace.length() + 1);\n                int nodeIndex = childNodeList.indexOf(pathName);\n                if (nodeIndex < 0) {\n                    //\n                    throw new RuntimeException(\"\");\n                }\n\n                if (nodeIndex == 0) {\n                    haveTheLock = true; //\n                    System.out.println(\"path = \" + path + \" \");\n                } else {\n                    //\n                    String preNodePath = lockNameSpace.concat(\"/\").concat(childNodeList.get(nodeIndex - 1));\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    //\n                    NodeCache cache = new NodeCache(cf, preNodePath);\n                    //\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    cache.start();\n                    //\n                    if (isExistNode(preNodePath)) {\n                        System.out.println(\"====path=\" + preNodePath + \" watch -\" + path);\n                        countDownLatch.await();\n                    } else {\n                        CloseableUtils.closeQuietly(cache);\n                    }\n                }\n            }\n        } catch (Exception e) {\n            //\n            doDeleteOurPath = true;\n        } finally {\n            if (doDeleteOurPath) {\n                deleteNode(path);\n            }\n        }\n        return haveTheLock;\n    }\n\n    public void lock() throws Exception {\n        this.lock(0, null);\n    }\n\n    /***\n     * \n     */\n    public void lock(long millisToWait, TimeUnit unit) throws Exception {\n        boolean isDone = false;\n        //\n        while (!isDone) {\n            String path = createNode(); // path = /mylock02/lock0000000005\n            this.currentLockPath = path; //\n            if (StringUtils.isBlank(path)) {\n                throw new RuntimeException(\"\");\n            }\n            if (waiteLock(millisToWait, unit, path)) {\n                isDone = true;\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        deleteNode(this.currentLockPath);\n        CloseableUtils.closeQuietly(cf);\n    }\n\n    /***\n     * \n     * @return\n     * @throws Exception\n     */\n    public String createNode() {\n        String s = null;\n        try {\n            s = cf.create()\n                    .creatingParentsIfNeeded() //\n                    .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)\n                    .forPath(locakPath);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return s;\n    }\n\n    /***\n     * \n     * @param path\n     */\n    public void deleteNode(String path) {\n        try {\n            if (isExistNode(path)) {\n                cf.delete().forPath(path);\n                System.out.println(\"====\" + path + \" \");\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    /***\n     * \n     * @param path\n     * @return\n     */\n    public boolean isExistNode(String path) {\n        try {\n            Stat stat = cf.checkExists().forPath(path);\n            return stat == null ? false : true;\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return false;\n    }\n\n    /***\n     * \n     * @return\n     */\n    public List<String> getChildrenPath() {\n        try {\n            List<String> strings = cf.getChildren().forPath(lockNameSpace);\n            return strings.stream().sorted().collect(Collectors.toList());\n        } catch (Exception e) {\n            e.printStackTrace();\n            return Lists.newArrayList();\n        }\n    }\n\n}\n\n```\n\n****\n\n```java\n@Test\n    public void zkOnlyFairLock01() throws InterruptedException {\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for(int i = 0 ; i < 100; i++){\n            executorService.submit(() -> {\n                ZkOnlyFairLock zkLock = new ZkOnlyFairLock(\"lock\");\n                try {\n                    zkLock.lock();\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(2);\n                } catch (Exception e) {\n                    e.printStackTrace();\n                }finally {\n                    zkLock.unlock();\n                }\n            });\n        }\n        executorService.awaitTermination(10,TimeUnit.MINUTES);\n    }\n```\n\n## Curator\n\nCuratorZookeeper\n\n- InterProcessMutex\n- InterProcessSemaphoreMutex\n- InterProcessReadWriteLock\n- InterProcessMultiLock\n\n### \n\nInterProcessSemaphoreMutex\n\n```java\n@Test\npublic void curtorLock001() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i < 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(\"localhost:2181\",new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessSemaphoreMutex(cf, \"/curator/lock\");\n                try{\n                    cf.start();\n                    lock.acquire(); //\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}\n```\n\n### \n\n\n\nInterProcessMutexzookeeperuuid + watcherwatcher\n\n```java\n@Test\npublic void curtorLock002() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i < 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(\"localhost:2181\",new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessMutex(cf, \"/curator/lock\");\n                try{\n                    cf.start();\n                    lock.acquire();\n                    lock.acquire();\n                    System.out.println(\"ing\");\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}\n```\n\n###  \n\nInterProcessReadWriteLock\n\n### \n\nInterProcessMultiLock\n\n## zk\n\nZKleader ZK \n\n\n\n- Rediszkwatchkey\n- RedisclientAredisredisredisredisredis,redisclientA clientBzkleaderleader\n\n## \n\n- https://www.jianshu.com/p/6e20e65f301a\n- http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/\n- https://www.jianshu.com/p/7fe495c93290","slug":"zookeeper-lock","published":1,"updated":"2021-04-08T00:47:07.127Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn9yvhw80050qwv22sdp6hlv","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>()watch</p>\n<p>()watch</p>\n<p><img src=\"/2020/08/27/zookeeper-lock/1.png\" alt></p>\n<a id=\"more\"></a>\n<ol>\n<li> lock </li>\n<li> lock  lock  watcher</li>\n<li> lock  Zookeeper  lock </li>\n<li> lock </li>\n<li>4</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> lock<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>lang3<span class=\"token punctuation\">.</span>StringUtils<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>RetryPolicy<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>CuratorFramework<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>CuratorFrameworkFactory<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>ChildData<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>NodeCache<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>NodeCacheListener<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>ConnectionState<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>ConnectionStateListener<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>retry<span class=\"token punctuation\">.</span>ExponentialBackoffRetry<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>CloseableUtils<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>zookeeper<span class=\"token punctuation\">.</span>CreateMode<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>zookeeper<span class=\"token punctuation\">.</span>KeeperException<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>UUID<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>CountDownLatch<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>TimeUnit<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">/***\n * zk\n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ZkOnlyLock</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> String lockNameSpace <span class=\"token operator\">=</span> <span class=\"token string\">\"/mylock\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> String CONNECT_ADDR <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> ThreadLocal<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> threadUuid <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> String <span class=\"token function\">initialValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> CuratorFramework cf<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String locakPath<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     *\n     * @param lockPath \n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ZkOnlyLock</span><span class=\"token punctuation\">(</span>String lockPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>locakPath <span class=\"token operator\">=</span> lockNameSpace <span class=\"token operator\">+</span> <span class=\"token string\">\"/\"</span> <span class=\"token operator\">+</span> lockPath<span class=\"token punctuation\">;</span>\n        RetryPolicy retryPolicy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExponentialBackoffRetry</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf <span class=\"token operator\">=</span> CuratorFrameworkFactory<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">connectString</span><span class=\"token punctuation\">(</span>CONNECT_ADDR<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">sessionTimeoutMs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">connectionTimeoutMs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">retryPolicy</span><span class=\"token punctuation\">(</span>retryPolicy<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">getConnectionStateListenable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConnectionStateListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">stateChanged</span><span class=\"token punctuation\">(</span>CuratorFramework curatorFramework<span class=\"token punctuation\">,</span> ConnectionState connectionState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>LOST<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>RECONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> millisToWait<span class=\"token punctuation\">,</span> TimeUnit unit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">boolean</span> doDeleteOurPath <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span>doDeleteOurPath <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                String path <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">creatingParentsIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">withMode</span><span class=\"token punctuation\">(</span>CreateMode<span class=\"token punctuation\">.</span>PERSISTENT<span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>locakPath<span class=\"token punctuation\">,</span> threadUuid<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>StringUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isNoneBlank</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">KeeperException<span class=\"token punctuation\">.</span>NodeExistsException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//watch</span>\n                    NodeCache cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NodeCache</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">,</span> locakPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    CountDownLatch countDownLatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    cache<span class=\"token punctuation\">.</span><span class=\"token function\">getListenable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">NodeCacheListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token annotation punctuation\">@Override</span>\n                        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">nodeChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n                            ChildData childData <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childData <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"======\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        cache<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        exception<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>unit <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span>millisToWait<span class=\"token punctuation\">,</span> unit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            doDeleteOurPath <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                            countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        CloseableUtils<span class=\"token punctuation\">.</span><span class=\"token function\">closeQuietly</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> interruptedException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        interruptedException<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            String uuidData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>locakPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"UTF-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\" spellcheck=\"true\">//uuid</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>StringUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isNoneBlank</span><span class=\"token punctuation\">(</span>uuidData<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> uuidData<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>threadUuid<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                cf<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>locakPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            threadUuid<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token comment\" spellcheck=\"true\">/****\n     * \n     */</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onlyLockTest1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        ZkOnlyLock zkOnlyLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZkOnlyLock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lock001\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ExecutorService executorService <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @throws InterruptedException\n     */</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onlyLockTest2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n        ZkOnlyLock zkOnlyLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZkOnlyLock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lock001\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Thread thread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====do=====\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        thread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        zkOnlyLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        thread<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>watchZookeeper</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/08/27/zookeeper-lock/2.png\" alt></p>\n<p><img src=\"/2020/08/27/zookeeper-lock/3.png\" alt></p>\n<ol>\n<li>()</li>\n<li> Zookeeper  /share_lock</li>\n<li>()watcher</li>\n<li></li>\n<li>4</li>\n</ol>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre class=\" language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> lock<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">.</span>Lists<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>lang3<span class=\"token punctuation\">.</span>StringUtils<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>RetryPolicy<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>CuratorFramework<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>CuratorFrameworkFactory<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>ChildData<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>NodeCache<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>recipes<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>NodeCacheListener<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>ConnectionState<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>framework<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>ConnectionStateListener<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>retry<span class=\"token punctuation\">.</span>ExponentialBackoffRetry<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>curator<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>CloseableUtils<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>zookeeper<span class=\"token punctuation\">.</span>CreateMode<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>zookeeper<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>Stat<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>List<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>CountDownLatch<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>TimeUnit<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">.</span>Collectors<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\" spellcheck=\"true\">/***\n * \n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ZkOnlyFairLock</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> String lockNameSpace <span class=\"token operator\">=</span> <span class=\"token string\">\"/mylock02\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> String CONNECT_ADDR <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> CuratorFramework cf<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String locakPath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> String currentLockPath<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     *\n     * @param lockPath \n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ZkOnlyFairLock</span><span class=\"token punctuation\">(</span>String lockPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>locakPath <span class=\"token operator\">=</span> lockNameSpace <span class=\"token operator\">+</span> <span class=\"token string\">\"/\"</span> <span class=\"token operator\">+</span> lockPath<span class=\"token punctuation\">;</span>\n        RetryPolicy retryPolicy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExponentialBackoffRetry</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf <span class=\"token operator\">=</span> CuratorFrameworkFactory<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">connectString</span><span class=\"token punctuation\">(</span>CONNECT_ADDR<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">sessionTimeoutMs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">connectionTimeoutMs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">retryPolicy</span><span class=\"token punctuation\">(</span>retryPolicy<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">getConnectionStateListenable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConnectionStateListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">stateChanged</span><span class=\"token punctuation\">(</span>CuratorFramework curatorFramework<span class=\"token punctuation\">,</span> ConnectionState connectionState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>LOST<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">//</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionState <span class=\"token operator\">==</span> ConnectionState<span class=\"token punctuation\">.</span>RECONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * watch+\n     * @param millisToWait\n     * @param unit\n     * @param path\n     * @return\n     * @throws Exception\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">waiteLock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> millisToWait<span class=\"token punctuation\">,</span> TimeUnit unit<span class=\"token punctuation\">,</span> String path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">boolean</span> haveTheLock <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">boolean</span> doDeleteOurPath <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>haveTheLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> childNodeList <span class=\"token operator\">=</span> <span class=\"token function\">getChildrenPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\" spellcheck=\"true\">// [lock0000000005, lock0000000006, lock0000000007]</span>\n                String pathName <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span>lockNameSpace<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">int</span> nodeIndex <span class=\"token operator\">=</span> childNodeList<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>pathName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodeIndex <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodeIndex <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    haveTheLock <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path = \"</span> <span class=\"token operator\">+</span> path <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    String preNodePath <span class=\"token operator\">=</span> lockNameSpace<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>childNodeList<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeIndex <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    CountDownLatch countDownLatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    NodeCache cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NodeCache</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">,</span> preNodePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    cache<span class=\"token punctuation\">.</span><span class=\"token function\">getListenable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">NodeCacheListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token annotation punctuation\">@Override</span>\n                        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">nodeChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n                            ChildData childData <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childData <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    cache<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isExistNode</span><span class=\"token punctuation\">(</span>preNodePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====path=\"</span> <span class=\"token operator\">+</span> preNodePath <span class=\"token operator\">+</span> <span class=\"token string\">\" watch -\"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        CloseableUtils<span class=\"token punctuation\">.</span><span class=\"token function\">closeQuietly</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\" spellcheck=\"true\">//</span>\n            doDeleteOurPath <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>doDeleteOurPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">deleteNode</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> haveTheLock<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> millisToWait<span class=\"token punctuation\">,</span> TimeUnit unit<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Exception <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">boolean</span> isDone <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isDone<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            String path <span class=\"token operator\">=</span> <span class=\"token function\">createNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// path = /mylock02/lock0000000005</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentLockPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>StringUtils<span class=\"token punctuation\">.</span><span class=\"token function\">isBlank</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">waiteLock</span><span class=\"token punctuation\">(</span>millisToWait<span class=\"token punctuation\">,</span> unit<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                isDone <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">deleteNode</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentLockPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        CloseableUtils<span class=\"token punctuation\">.</span><span class=\"token function\">closeQuietly</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @return\n     * @throws Exception\n     */</span>\n    <span class=\"token keyword\">public</span> String <span class=\"token function\">createNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        String s <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            s <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">creatingParentsIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">withMode</span><span class=\"token punctuation\">(</span>CreateMode<span class=\"token punctuation\">.</span>EPHEMERAL_SEQUENTIAL<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>locakPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @param path\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteNode</span><span class=\"token punctuation\">(</span>String path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isExistNode</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                cf<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====\"</span> <span class=\"token operator\">+</span> path <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @param path\n     * @return\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isExistNode</span><span class=\"token punctuation\">(</span>String path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            Stat stat <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">checkExists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> stat <span class=\"token operator\">==</span> null <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\" spellcheck=\"true\">/***\n     * \n     * @return\n     */</span>\n    <span class=\"token keyword\">public</span> List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token function\">getChildrenPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> strings <span class=\"token operator\">=</span> cf<span class=\"token punctuation\">.</span><span class=\"token function\">getChildren</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forPath</span><span class=\"token punctuation\">(</span>lockNameSpace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>Collectors<span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> Lists<span class=\"token punctuation\">.</span><span class=\"token function\">newArrayList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><strong></strong></p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">zkOnlyFairLock01</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n        ExecutorService executorService <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n                ZkOnlyFairLock zkLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ZkOnlyFairLock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    zkLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    zkLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>TimeUnit<span class=\"token punctuation\">.</span>MINUTES<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"Curator\"><a href=\"#Curator\" class=\"headerlink\" title=\"Curator\"></a>Curator</h2><p>CuratorZookeeper</p>\n<ul>\n<li>InterProcessMutex</li>\n<li>InterProcessSemaphoreMutex</li>\n<li>InterProcessReadWriteLock</li>\n<li>InterProcessMultiLock</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessSemaphoreMutex</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">curtorLock001</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    ExecutorService executorService <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                CuratorFramework cf <span class=\"token operator\">=</span> CuratorFrameworkFactory<span class=\"token punctuation\">.</span><span class=\"token function\">newClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ExponentialBackoffRetry</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                InterProcessLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterProcessSemaphoreMutex</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/curator/lock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n                    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    lock<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        lock<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>TimeUnit<span class=\"token punctuation\">.</span>MINUTES<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>InterProcessMutexzookeeperuuid + watcherwatcher</p>\n<pre class=\" language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">curtorLock002</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InterruptedException <span class=\"token punctuation\">{</span>\n    ExecutorService executorService <span class=\"token operator\">=</span> Executors<span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                CuratorFramework cf <span class=\"token operator\">=</span> CuratorFrameworkFactory<span class=\"token punctuation\">.</span><span class=\"token function\">newClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost:2181\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ExponentialBackoffRetry</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                InterProcessLock lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterProcessMutex</span><span class=\"token punctuation\">(</span>cf<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/curator/lock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n                    cf<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    lock<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    lock<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        lock<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        lock<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>TimeUnit<span class=\"token punctuation\">.</span>MINUTES<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessReadWriteLock</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessMultiLock</p>\n<h2 id=\"zk\"><a href=\"#zk\" class=\"headerlink\" title=\"zk\"></a>zk</h2><p>ZKleader ZK </p>\n<p></p>\n<ul>\n<li>Rediszkwatchkey</li>\n<li>RedisclientAredisredisredisredisredis,redisclientA clientBzkleaderleader</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.jianshu.com/p/6e20e65f301a\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/6e20e65f301a</a></li>\n<li><a href=\"http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/\" target=\"_blank\" rel=\"noopener\">http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/</a></li>\n<li><a href=\"https://www.jianshu.com/p/7fe495c93290\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/7fe495c93290</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>()watch</p>\n<p>()watch</p>\n<p><img src=\"/2020/08/27/zookeeper-lock/1.png\" alt></p>","more":"<ol>\n<li> lock </li>\n<li> lock  lock  watcher</li>\n<li> lock  Zookeeper  lock </li>\n<li> lock </li>\n<li>4</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<pre><code class=\"java\">package lock;\n\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.KeeperException;\n\nimport java.util.UUID;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\n\n/***\n * zk\n */\npublic class ZkOnlyLock {\n    private static String lockNameSpace = &quot;/mylock&quot;;\n    public static String CONNECT_ADDR = &quot;localhost:2181&quot;;\n    private static final ThreadLocal&lt;String&gt; threadUuid = new ThreadLocal&lt;String&gt;() {\n        @Override\n        protected String initialValue() {\n            return UUID.randomUUID().toString();\n        }\n    };\n    private CuratorFramework cf;\n    private String locakPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyLock(String lockPath) {\n        this.locakPath = lockNameSpace + &quot;/&quot; + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(&quot;&quot;);//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(&quot;&quot;);\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(&quot;&quot;);\n                }\n            }\n        });\n        cf.start();\n    }\n\n    public void lock() {\n        this.lock(0, null);\n    }\n\n    public void lock(long millisToWait, TimeUnit unit) {\n        boolean doDeleteOurPath = false;\n        for (;doDeleteOurPath == false;) {\n            try {\n                String path = cf.create()\n                        .creatingParentsIfNeeded() //\n                        .withMode(CreateMode.PERSISTENT)\n                        .forPath(locakPath, threadUuid.get().getBytes());\n                if (StringUtils.isNoneBlank(path)) {\n                    System.out.println(&quot;&quot; + Thread.currentThread().getId() + &quot;&quot;);\n                    break;\n                }\n            } catch (Exception e) {\n                if (e instanceof KeeperException.NodeExistsException) {\n                    //watch\n                    NodeCache cache = new NodeCache(cf, locakPath);\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                System.out.println(&quot;======&quot;);\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    try {\n                        cache.start();\n                    } catch (Exception exception) {\n                        exception.printStackTrace();\n                    }\n                    try {\n                        if (unit != null) {\n                            countDownLatch.await(millisToWait, unit);\n                            doDeleteOurPath = true;\n                        } else {\n                            countDownLatch.await();\n                        }\n                        CloseableUtils.closeQuietly(cache);\n                    } catch (InterruptedException interruptedException) {\n                        interruptedException.printStackTrace();\n                    }\n                }\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        try {\n            String uuidData = new String(cf.getData().forPath(locakPath), &quot;UTF-8&quot;);\n            //uuid\n            if (StringUtils.isNoneBlank(uuidData) &amp;&amp; uuidData.equals(threadUuid.get())) {\n                cf.delete().forPath(locakPath);\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            threadUuid.remove();\n        }\n    }\n}</code></pre>\n<p><strong></strong></p>\n<pre><code class=\"java\">/****\n     * \n     */\n    @Test\n    public void onlyLockTest1() {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(&quot;lock001&quot;);\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for (int i = 0; i &lt; 5; i++) {\n            executorService.execute(() -&gt; {\n                try {\n                    zkOnlyLock.lock();\n                    System.out.println(&quot;ing&quot;);\n                    try {\n                        TimeUnit.SECONDS.sleep(5);\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                } finally {\n                    zkOnlyLock.unlock();\n                }\n            });\n        }\n    }\n\n    /***\n     * \n     * @throws InterruptedException\n     */\n    @Test\n    public void onlyLockTest2() throws InterruptedException {\n        ZkOnlyLock zkOnlyLock = new ZkOnlyLock(&quot;lock001&quot;);\n        Thread thread = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    TimeUnit.SECONDS.sleep(1);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                zkOnlyLock.lock(10,TimeUnit.SECONDS);\n                System.out.println(&quot;====do=====&quot;);\n                zkOnlyLock.unlock();\n            }\n        });\n        thread.start();\n        zkOnlyLock.lock();\n        TimeUnit.SECONDS.sleep(30);\n        zkOnlyLock.unlock();\n        thread.join();\n    }</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>watchZookeeper</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><p><img src=\"/2020/08/27/zookeeper-lock/2.png\" alt></p>\n<p><img src=\"/2020/08/27/zookeeper-lock/3.png\" alt></p>\n<ol>\n<li>()</li>\n<li> Zookeeper  /share_lock</li>\n<li>()watcher</li>\n<li></li>\n<li>4</li>\n</ol>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><pre><code class=\"java\">package lock;\n\nimport com.google.common.collect.Lists;\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.curator.RetryPolicy;\nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.cache.ChildData;\nimport org.apache.curator.framework.recipes.cache.NodeCache;\nimport org.apache.curator.framework.recipes.cache.NodeCacheListener;\nimport org.apache.curator.framework.state.ConnectionState;\nimport org.apache.curator.framework.state.ConnectionStateListener;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\nimport org.apache.curator.utils.CloseableUtils;\nimport org.apache.zookeeper.CreateMode;\nimport org.apache.zookeeper.data.Stat;\n\nimport java.util.List;\nimport java.util.concurrent.CountDownLatch;\nimport java.util.concurrent.TimeUnit;\nimport java.util.stream.Collectors;\n\n/***\n * \n */\npublic class ZkOnlyFairLock {\n    private static String lockNameSpace = &quot;/mylock02&quot;;\n    public static String CONNECT_ADDR = &quot;localhost:2181&quot;;\n    private CuratorFramework cf;\n    private String locakPath;\n    private String currentLockPath;\n\n    /***\n     *\n     * @param lockPath \n     */\n    public ZkOnlyFairLock(String lockPath) {\n        this.locakPath = lockNameSpace + &quot;/&quot; + lockPath;\n        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000000, 3);\n        cf = CuratorFrameworkFactory.builder()\n                .connectString(CONNECT_ADDR)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        cf.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n            @Override\n            public void stateChanged(CuratorFramework curatorFramework, ConnectionState connectionState) {\n                if (connectionState == ConnectionState.LOST) {\n                    System.out.println(&quot;&quot;);//\n                } else if (connectionState == ConnectionState.CONNECTED) {\n                    System.out.println(&quot;&quot;);\n                } else if (connectionState == ConnectionState.RECONNECTED) {\n                    System.out.println(&quot;&quot;);\n                }\n            }\n        });\n        cf.start();\n    }\n\n    /***\n     * watch+\n     * @param millisToWait\n     * @param unit\n     * @param path\n     * @return\n     * @throws Exception\n     */\n    public boolean waiteLock(long millisToWait, TimeUnit unit, String path) {\n        boolean haveTheLock = false;\n        boolean doDeleteOurPath = false;\n        try {\n\n            while (!haveTheLock) {\n                List&lt;String&gt; childNodeList = getChildrenPath();// [lock0000000005, lock0000000006, lock0000000007]\n                String pathName = path.substring(lockNameSpace.length() + 1);\n                int nodeIndex = childNodeList.indexOf(pathName);\n                if (nodeIndex &lt; 0) {\n                    //\n                    throw new RuntimeException(&quot;&quot;);\n                }\n\n                if (nodeIndex == 0) {\n                    haveTheLock = true; //\n                    System.out.println(&quot;path = &quot; + path + &quot; &quot;);\n                } else {\n                    //\n                    String preNodePath = lockNameSpace.concat(&quot;/&quot;).concat(childNodeList.get(nodeIndex - 1));\n                    CountDownLatch countDownLatch = new CountDownLatch(1);\n                    //\n                    NodeCache cache = new NodeCache(cf, preNodePath);\n                    //\n                    cache.getListenable().addListener(new NodeCacheListener() {\n                        @Override\n                        public void nodeChanged() throws Exception {\n                            ChildData childData = cache.getCurrentData();\n                            if (childData == null) {\n                                countDownLatch.countDown();\n                            }\n                        }\n                    });\n                    cache.start();\n                    //\n                    if (isExistNode(preNodePath)) {\n                        System.out.println(&quot;====path=&quot; + preNodePath + &quot; watch -&quot; + path);\n                        countDownLatch.await();\n                    } else {\n                        CloseableUtils.closeQuietly(cache);\n                    }\n                }\n            }\n        } catch (Exception e) {\n            //\n            doDeleteOurPath = true;\n        } finally {\n            if (doDeleteOurPath) {\n                deleteNode(path);\n            }\n        }\n        return haveTheLock;\n    }\n\n    public void lock() throws Exception {\n        this.lock(0, null);\n    }\n\n    /***\n     * \n     */\n    public void lock(long millisToWait, TimeUnit unit) throws Exception {\n        boolean isDone = false;\n        //\n        while (!isDone) {\n            String path = createNode(); // path = /mylock02/lock0000000005\n            this.currentLockPath = path; //\n            if (StringUtils.isBlank(path)) {\n                throw new RuntimeException(&quot;&quot;);\n            }\n            if (waiteLock(millisToWait, unit, path)) {\n                isDone = true;\n            }\n        }\n    }\n\n    /***\n     * \n     */\n    public void unlock() {\n        deleteNode(this.currentLockPath);\n        CloseableUtils.closeQuietly(cf);\n    }\n\n    /***\n     * \n     * @return\n     * @throws Exception\n     */\n    public String createNode() {\n        String s = null;\n        try {\n            s = cf.create()\n                    .creatingParentsIfNeeded() //\n                    .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)\n                    .forPath(locakPath);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return s;\n    }\n\n    /***\n     * \n     * @param path\n     */\n    public void deleteNode(String path) {\n        try {\n            if (isExistNode(path)) {\n                cf.delete().forPath(path);\n                System.out.println(&quot;====&quot; + path + &quot; &quot;);\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    /***\n     * \n     * @param path\n     * @return\n     */\n    public boolean isExistNode(String path) {\n        try {\n            Stat stat = cf.checkExists().forPath(path);\n            return stat == null ? false : true;\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return false;\n    }\n\n    /***\n     * \n     * @return\n     */\n    public List&lt;String&gt; getChildrenPath() {\n        try {\n            List&lt;String&gt; strings = cf.getChildren().forPath(lockNameSpace);\n            return strings.stream().sorted().collect(Collectors.toList());\n        } catch (Exception e) {\n            e.printStackTrace();\n            return Lists.newArrayList();\n        }\n    }\n\n}\n</code></pre>\n<p><strong></strong></p>\n<pre><code class=\"java\">@Test\n    public void zkOnlyFairLock01() throws InterruptedException {\n        ExecutorService executorService = Executors.newFixedThreadPool(100);\n        for(int i = 0 ; i &lt; 100; i++){\n            executorService.submit(() -&gt; {\n                ZkOnlyFairLock zkLock = new ZkOnlyFairLock(&quot;lock&quot;);\n                try {\n                    zkLock.lock();\n                    System.out.println(&quot;ing&quot;);\n                    TimeUnit.SECONDS.sleep(2);\n                } catch (Exception e) {\n                    e.printStackTrace();\n                }finally {\n                    zkLock.unlock();\n                }\n            });\n        }\n        executorService.awaitTermination(10,TimeUnit.MINUTES);\n    }</code></pre>\n<h2 id=\"Curator\"><a href=\"#Curator\" class=\"headerlink\" title=\"Curator\"></a>Curator</h2><p>CuratorZookeeper</p>\n<ul>\n<li>InterProcessMutex</li>\n<li>InterProcessSemaphoreMutex</li>\n<li>InterProcessReadWriteLock</li>\n<li>InterProcessMultiLock</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessSemaphoreMutex</p>\n<pre><code class=\"java\">@Test\npublic void curtorLock001() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i &lt; 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(&quot;localhost:2181&quot;,new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessSemaphoreMutex(cf, &quot;/curator/lock&quot;);\n                try{\n                    cf.start();\n                    lock.acquire(); //\n                    System.out.println(&quot;ing&quot;);\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>InterProcessMutexzookeeperuuid + watcherwatcher</p>\n<pre><code class=\"java\">@Test\npublic void curtorLock002() throws InterruptedException {\n    ExecutorService executorService = Executors.newFixedThreadPool(100);\n    for(int i = 0 ; i &lt; 10; i++){\n        executorService.submit(new Runnable() {\n            @Override\n            public void run() {\n                CuratorFramework cf = CuratorFrameworkFactory.newClient(&quot;localhost:2181&quot;,new ExponentialBackoffRetry(2000,3));\n                InterProcessLock lock = new InterProcessMutex(cf, &quot;/curator/lock&quot;);\n                try{\n                    cf.start();\n                    lock.acquire();\n                    lock.acquire();\n                    System.out.println(&quot;ing&quot;);\n                    TimeUnit.SECONDS.sleep(5);\n                }catch (Exception e){\n                    e.printStackTrace();\n                }finally {\n                    try {\n                        lock.release();\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        });\n    }\n    executorService.awaitTermination(10,TimeUnit.MINUTES);\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessReadWriteLock</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>InterProcessMultiLock</p>\n<h2 id=\"zk\"><a href=\"#zk\" class=\"headerlink\" title=\"zk\"></a>zk</h2><p>ZKleader ZK </p>\n<p></p>\n<ul>\n<li>Rediszkwatchkey</li>\n<li>RedisclientAredisredisredisredisredis,redisclientA clientBzkleaderleader</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><a href=\"https://www.jianshu.com/p/6e20e65f301a\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/6e20e65f301a</a></li>\n<li><a href=\"http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/\" target=\"_blank\" rel=\"noopener\">http://www.tianxiaobo.com/2018/01/20/%E5%9F%BA%E4%BA%8E-Zookeeper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/</a></li>\n<li><a href=\"https://www.jianshu.com/p/7fe495c93290\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/7fe495c93290</a></li>\n</ul>"},{"title":"substrate","description":"substrate","date":"2020-10-30T05:53:30.000Z","_content":"### \nwiki : https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact\n\n : https://zhuanlan.zhihu.com/p/342576492\n\nubantu : ubuntu-20.04.2.0-desktop-amd64.iso\n\n### vboxubantu\n\n**ifconfig**\n\n```\nsudo apt install net-tools\n```\n\n**root**\n\nhttp://www.5sharing.com/m/view.php?aid=1541\n\n**ubanturoot**\n\nubanturootroot\n\n```\nsudo passwd root #rootubanto\nsu root #root\n```\n\n**ubantuxshell**\n\nxshellubuntusshubuntussh\n\n```\nsudo apt-get install openssh-server\nsudo service ssh restart #\n```\n\n**Ubanturootxshell**\n\n```\n /etc/ssh/sshd_config PermitRootLogin Prohibit-password #\nPermitRootLogin yes\nssh /etc/init.d/ssh restart\nroot\n```\n\n**Ubantu**\n\n```\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\niptables-save\napt-get install iptables-persistent\nnetfilter-persistent save\nnetfilter-persistent reload\n```\n\n**Ubantuvbox**\n\n1.  --> \n2. cd /media  sudo sh VBoxLinuxAdditions.run\n3. sudo reboot \n\n### Substrate\n\n**NodeJs**\n\n : https://developer.aliyun.com/article/760687\n\n```\ncurl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -\nsudo apt install nodejs\n#\nnode --version\nnpm --version\nnpm config set registry http://registry.npm.taobao.org/ #\n```\n\n**yarn**\n\n```\ncurl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho \"deb https://dl.yarnpkg.com/debian/ stable main\" | sudo tee /etc/apt/sources.list.d/yarn.list\nsudo apt update\nsudo apt install yarn\n```\n\n**substrate**\n\n```\ncurl https://getsubstrate.io -sSf | bash -s -- --fast  #--fast\n```\n\n","source":"_posts/blockchain-1.md","raw":"---\ntitle: substrate\ntags:\n  - \ncategories:  \ndescription : substrate\ndate: 2020-10-30 13:53:30\n---\n### \nwiki : https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact\n\n : https://zhuanlan.zhihu.com/p/342576492\n\nubantu : ubuntu-20.04.2.0-desktop-amd64.iso\n\n### vboxubantu\n\n**ifconfig**\n\n```\nsudo apt install net-tools\n```\n\n**root**\n\nhttp://www.5sharing.com/m/view.php?aid=1541\n\n**ubanturoot**\n\nubanturootroot\n\n```\nsudo passwd root #rootubanto\nsu root #root\n```\n\n**ubantuxshell**\n\nxshellubuntusshubuntussh\n\n```\nsudo apt-get install openssh-server\nsudo service ssh restart #\n```\n\n**Ubanturootxshell**\n\n```\n /etc/ssh/sshd_config PermitRootLogin Prohibit-password #\nPermitRootLogin yes\nssh /etc/init.d/ssh restart\nroot\n```\n\n**Ubantu**\n\n```\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\niptables-save\napt-get install iptables-persistent\nnetfilter-persistent save\nnetfilter-persistent reload\n```\n\n**Ubantuvbox**\n\n1.  --> \n2. cd /media  sudo sh VBoxLinuxAdditions.run\n3. sudo reboot \n\n### Substrate\n\n**NodeJs**\n\n : https://developer.aliyun.com/article/760687\n\n```\ncurl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -\nsudo apt install nodejs\n#\nnode --version\nnpm --version\nnpm config set registry http://registry.npm.taobao.org/ #\n```\n\n**yarn**\n\n```\ncurl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho \"deb https://dl.yarnpkg.com/debian/ stable main\" | sudo tee /etc/apt/sources.list.d/yarn.list\nsudo apt update\nsudo apt install yarn\n```\n\n**substrate**\n\n```\ncurl https://getsubstrate.io -sSf | bash -s -- --fast  #--fast\n```\n\n","slug":"blockchain-1","published":1,"updated":"2021-06-07T03:20:15.938Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckpxmxgrw0000h8v2egzj7693","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>wiki : <a href=\"https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact\" target=\"_blank\" rel=\"noopener\">https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact</a></p>\n<p> : <a href=\"https://zhuanlan.zhihu.com/p/342576492\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/342576492</a></p>\n<p>ubantu : ubuntu-20.04.2.0-desktop-amd64.iso</p>\n<h3 id=\"vboxubantu\"><a href=\"#vboxubantu\" class=\"headerlink\" title=\"vboxubantu\"></a>vboxubantu</h3><p><strong>ifconfig</strong></p>\n<pre><code>sudo apt install net-tools</code></pre><p><strong>root</strong></p>\n<p><a href=\"http://www.5sharing.com/m/view.php?aid=1541\" target=\"_blank\" rel=\"noopener\">http://www.5sharing.com/m/view.php?aid=1541</a></p>\n<p><strong>ubanturoot</strong></p>\n<p>ubanturootroot</p>\n<pre><code>sudo passwd root #rootubanto\nsu root #root</code></pre><p><strong>ubantuxshell</strong></p>\n<p>xshellubuntusshubuntussh</p>\n<pre><code>sudo apt-get install openssh-server\nsudo service ssh restart #</code></pre><p><strong>Ubanturootxshell</strong></p>\n<pre><code> /etc/ssh/sshd_config PermitRootLogin Prohibit-password #\nPermitRootLogin yes\nssh /etc/init.d/ssh restart\nroot</code></pre><p><strong>Ubantu</strong></p>\n<pre><code>iptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\niptables-save\napt-get install iptables-persistent\nnetfilter-persistent save\nnetfilter-persistent reload</code></pre><p><strong>Ubantuvbox</strong></p>\n<ol>\n<li> &gt; </li>\n<li>cd /media  sudo sh VBoxLinuxAdditions.run</li>\n<li>sudo reboot </li>\n</ol>\n<h3 id=\"Substrate\"><a href=\"#Substrate\" class=\"headerlink\" title=\"Substrate\"></a>Substrate</h3><p><strong>NodeJs</strong></p>\n<p> : <a href=\"https://developer.aliyun.com/article/760687\" target=\"_blank\" rel=\"noopener\">https://developer.aliyun.com/article/760687</a></p>\n<pre><code>curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -\nsudo apt install nodejs\n#\nnode --version\nnpm --version\nnpm config set registry http://registry.npm.taobao.org/ #</code></pre><p><strong>yarn</strong></p>\n<pre><code>curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot; | sudo tee /etc/apt/sources.list.d/yarn.list\nsudo apt update\nsudo apt install yarn</code></pre><p><strong>substrate</strong></p>\n<pre><code>curl https://getsubstrate.io -sSf | bash -s -- --fast  #--fast</code></pre>","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>wiki : <a href=\"https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact\" target=\"_blank\" rel=\"noopener\">https://substrate.dev/docs/zh-CN/tutorials/create-your-first-substrate-chain/interact</a></p>\n<p> : <a href=\"https://zhuanlan.zhihu.com/p/342576492\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/342576492</a></p>\n<p>ubantu : ubuntu-20.04.2.0-desktop-amd64.iso</p>\n<h3 id=\"vboxubantu\"><a href=\"#vboxubantu\" class=\"headerlink\" title=\"vboxubantu\"></a>vboxubantu</h3><p><strong>ifconfig</strong></p>\n<pre><code>sudo apt install net-tools</code></pre><p><strong>root</strong></p>\n<p><a href=\"http://www.5sharing.com/m/view.php?aid=1541\" target=\"_blank\" rel=\"noopener\">http://www.5sharing.com/m/view.php?aid=1541</a></p>\n<p><strong>ubanturoot</strong></p>\n<p>ubanturootroot</p>\n<pre><code>sudo passwd root #rootubanto\nsu root #root</code></pre><p><strong>ubantuxshell</strong></p>\n<p>xshellubuntusshubuntussh</p>\n<pre><code>sudo apt-get install openssh-server\nsudo service ssh restart #</code></pre><p><strong>Ubanturootxshell</strong></p>\n<pre><code> /etc/ssh/sshd_config PermitRootLogin Prohibit-password #\nPermitRootLogin yes\nssh /etc/init.d/ssh restart\nroot</code></pre><p><strong>Ubantu</strong></p>\n<pre><code>iptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\niptables-save\napt-get install iptables-persistent\nnetfilter-persistent save\nnetfilter-persistent reload</code></pre><p><strong>Ubantuvbox</strong></p>\n<ol>\n<li> &gt; </li>\n<li>cd /media  sudo sh VBoxLinuxAdditions.run</li>\n<li>sudo reboot </li>\n</ol>\n<h3 id=\"Substrate\"><a href=\"#Substrate\" class=\"headerlink\" title=\"Substrate\"></a>Substrate</h3><p><strong>NodeJs</strong></p>\n<p> : <a href=\"https://developer.aliyun.com/article/760687\" target=\"_blank\" rel=\"noopener\">https://developer.aliyun.com/article/760687</a></p>\n<pre><code>curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -\nsudo apt install nodejs\n#\nnode --version\nnpm --version\nnpm config set registry http://registry.npm.taobao.org/ #</code></pre><p><strong>yarn</strong></p>\n<pre><code>curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot; | sudo tee /etc/apt/sources.list.d/yarn.list\nsudo apt update\nsudo apt install yarn</code></pre><p><strong>substrate</strong></p>\n<pre><code>curl https://getsubstrate.io -sSf | bash -s -- --fast  #--fast</code></pre>"},{"title":"influxdb()","description":"influxdb()","date":"2021-02-10T01:05:24.000Z","_content":"\n### \n\n```\n> insert cpu_usage,host=server01,location=cn-sz user=23.0,system=57.0\n> select * from cpu_usage\nname: cpu_usage\ntime             host     location system user\n----             ----     -------- ------ ----\n1557834774258860710 server01 cn-sz    55     25\n```\n\n- **Time**1-31557834774258860710MySQLInfluxDB\n- **Measurement**1-3cpu_usageMySQLTable\n- **Tag**1-3host=server01location=cn-sz1-3hostlocationserver01cn-sz\n- **Field**1-3user=23.0system=57.01-3usersystem23.057.0\n- **Point**1-31557834774258860710 server01 cn-sz 55 25SeriesTimestampMySQL \n- **Retention Policy**InfluxDBDuration Replication\n- **Series**","source":"_posts/influxdb-1.md","raw":"---\ntitle: influxdb()\ntags:\n  - influxdb\ncategories:  influxdb\ndescription : influxdb()\ndate: 2021-02-10 09:05:24\n---\n\n### \n\n```\n> insert cpu_usage,host=server01,location=cn-sz user=23.0,system=57.0\n> select * from cpu_usage\nname: cpu_usage\ntime             host     location system user\n----             ----     -------- ------ ----\n1557834774258860710 server01 cn-sz    55     25\n```\n\n- **Time**1-31557834774258860710MySQLInfluxDB\n- **Measurement**1-3cpu_usageMySQLTable\n- **Tag**1-3host=server01location=cn-sz1-3hostlocationserver01cn-sz\n- **Field**1-3user=23.0system=57.01-3usersystem23.057.0\n- **Point**1-31557834774258860710 server01 cn-sz 55 25SeriesTimestampMySQL \n- **Retention Policy**InfluxDBDuration Replication\n- **Series**","slug":"influxdb-1","published":1,"updated":"2021-04-30T01:08:11.109Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckpxmxgs00001h8v2bwk7a7ve","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>&gt; insert cpu_usage,host=server01,location=cn-sz user=23.0,system=57.0\n&gt; select * from cpu_usage\nname: cpu_usage\ntime             host     location system user\n----             ----     -------- ------ ----\n1557834774258860710 server01 cn-sz    55     25</code></pre><ul>\n<li><strong>Time</strong>1-31557834774258860710MySQLInfluxDB</li>\n<li><strong>Measurement</strong>1-3cpu_usageMySQLTable</li>\n<li><strong>Tag</strong>1-3host=server01location=cn-sz1-3hostlocationserver01cn-sz</li>\n<li><strong>Field</strong>1-3user=23.0system=57.01-3usersystem23.057.0</li>\n<li><strong>Point</strong>1-31557834774258860710 server01 cn-sz 55 25SeriesTimestampMySQL </li>\n<li><strong>Retention Policy</strong>InfluxDBDuration Replication</li>\n<li><strong>Series</strong></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><pre><code>&gt; insert cpu_usage,host=server01,location=cn-sz user=23.0,system=57.0\n&gt; select * from cpu_usage\nname: cpu_usage\ntime             host     location system user\n----             ----     -------- ------ ----\n1557834774258860710 server01 cn-sz    55     25</code></pre><ul>\n<li><strong>Time</strong>1-31557834774258860710MySQLInfluxDB</li>\n<li><strong>Measurement</strong>1-3cpu_usageMySQLTable</li>\n<li><strong>Tag</strong>1-3host=server01location=cn-sz1-3hostlocationserver01cn-sz</li>\n<li><strong>Field</strong>1-3user=23.0system=57.01-3usersystem23.057.0</li>\n<li><strong>Point</strong>1-31557834774258860710 server01 cn-sz 55 25SeriesTimestampMySQL </li>\n<li><strong>Retention Policy</strong>InfluxDBDuration Replication</li>\n<li><strong>Series</strong></li>\n</ul>\n"},{"title":"ElasticSearch(0)","date":"2021-04-24T11:45:46.000Z","description":"ElasticSearch","_content":"\n## match/term\n\n**Elasticsearch matchmatch_phrasequery_stringterm**\n\n\n\n```json\nPUT my_index\n{\n  \"mappings\": {\n    \"properties\": {\n      \"name\" : {\"type\": \"keyword\"}, //namekeyword\n      \"desc\" : {\"type\": \"text\"}  // desc text\n    }\n  }\n}\n//\nPOST my_index/_doc/1\n{\n  \"name\" : \"washing machin\",\n  \"desc\" : \"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"\n}\n```\n\n**term**\n\nterm :\n\n- keywordkeyword\n- textt,texttermtermtext\n\n```json\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name\": \"washing\"\n    }\n  }\n}\n//\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name\": \"washing machin\"\n    }\n  }\n}\n// ,namekeywordnamewashing machintermwashing machin\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"washing\"\n    }\n  }\n}\n//keywordwhere name = 'washing'\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"washing machin\"\n    }\n  }\n}\n//where name = 'washing machin'\n\n```\n\n```json\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": \"Elasticsearch\"\n    }\n  }\n}\n//desctextElasticsearchElasticsearch\n\nGET my_index/_analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"\n}\n\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": \"an Elasticsearch article\"\n    }\n  }\n}\n//an Elasticsearch article termMySQL=\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"desc\": \"an Elasticsearch article\"\n    }\n  }\n}\n//matchtexttextwhere desc = 'an' or desc = 'Elasticsearch' or desc = 'article'.\n```\n\n","source":"_posts/elasticsearch-01.md","raw":"---\ntitle: ElasticSearch(0)\ndate: 2021-04-24 19:45:46\ntags:\n - ElasticSearch\ncategories:  ElasticSearch\ndescription : ElasticSearch\n---\n\n## match/term\n\n**Elasticsearch matchmatch_phrasequery_stringterm**\n\n\n\n```json\nPUT my_index\n{\n  \"mappings\": {\n    \"properties\": {\n      \"name\" : {\"type\": \"keyword\"}, //namekeyword\n      \"desc\" : {\"type\": \"text\"}  // desc text\n    }\n  }\n}\n//\nPOST my_index/_doc/1\n{\n  \"name\" : \"washing machin\",\n  \"desc\" : \"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"\n}\n```\n\n**term**\n\nterm :\n\n- keywordkeyword\n- textt,texttermtermtext\n\n```json\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name\": \"washing\"\n    }\n  }\n}\n//\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name\": \"washing machin\"\n    }\n  }\n}\n// ,namekeywordnamewashing machintermwashing machin\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"washing\"\n    }\n  }\n}\n//keywordwhere name = 'washing'\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"washing machin\"\n    }\n  }\n}\n//where name = 'washing machin'\n\n```\n\n```json\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": \"Elasticsearch\"\n    }\n  }\n}\n//desctextElasticsearchElasticsearch\n\nGET my_index/_analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"\n}\n\nGET my_index/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": \"an Elasticsearch article\"\n    }\n  }\n}\n//an Elasticsearch article termMySQL=\n\nGET my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"desc\": \"an Elasticsearch article\"\n    }\n  }\n}\n//matchtexttextwhere desc = 'an' or desc = 'Elasticsearch' or desc = 'article'.\n```\n\n","slug":"elasticsearch-01","published":1,"updated":"2021-04-24T12:29:15.104Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckpxmxgsh0004h8v2a6axbhhq","content":"<h2 id=\"match-term\"><a href=\"#match-term\" class=\"headerlink\" title=\"match/term\"></a>match/term</h2><p><strong>Elasticsearch matchmatch_phrasequery_stringterm</strong></p>\n<p></p>\n<pre class=\" language-json\"><code class=\"language-json\">PUT my_index\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"mappings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> //namekeyword\n      <span class=\"token property\">\"desc\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">}</span>  // desc text\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//\nPOST my_index/_doc/<span class=\"token number\">1</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"washing machin\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"desc\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>term</strong></p>\n<p>term :</p>\n<ul>\n<li>keywordkeyword</li>\n<li>textt,texttermtermtext</li>\n</ul>\n<pre class=\" language-json\"><code class=\"language-json\">GET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"washing\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//\nGET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"washing machin\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n// <span class=\"token punctuation\">,</span>namekeywordnamewashing machintermwashing machin\n\nGET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"washing\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//keywordwhere name = 'washing'\n\nGET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"washing machin\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//where name = 'washing machin'\n</code></pre>\n<pre class=\" language-json\"><code class=\"language-json\">GET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"desc\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Elasticsearch\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//desctextElasticsearchElasticsearch\n\nGET my_index/_analyze\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"standard\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started\"</span>\n<span class=\"token punctuation\">}</span>\n\nGET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"desc\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"an Elasticsearch article\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//an Elasticsearch article termMySQL=\n\nGET my_index/_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"desc\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"an Elasticsearch article\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n//matchtexttextwhere desc = 'an' or desc = 'Elasticsearch' or desc = 'article'.</code></pre>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"match-term\"><a href=\"#match-term\" class=\"headerlink\" title=\"match/term\"></a>match/term</h2><p><strong>Elasticsearch matchmatch_phrasequery_stringterm</strong></p>\n<p></p>\n<pre><code class=\"json\">PUT my_index\n{\n  &quot;mappings&quot;: {\n    &quot;properties&quot;: {\n      &quot;name&quot; : {&quot;type&quot;: &quot;keyword&quot;}, //namekeyword\n      &quot;desc&quot; : {&quot;type&quot;: &quot;text&quot;}  // desc text\n    }\n  }\n}\n//\nPOST my_index/_doc/1\n{\n  &quot;name&quot; : &quot;washing machin&quot;,\n  &quot;desc&quot; : &quot;I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started&quot;\n}</code></pre>\n<p><strong>term</strong></p>\n<p>term :</p>\n<ul>\n<li>keywordkeyword</li>\n<li>textt,texttermtermtext</li>\n</ul>\n<pre><code class=\"json\">GET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;term&quot;: {\n      &quot;name&quot;: &quot;washing&quot;\n    }\n  }\n}\n//\nGET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;term&quot;: {\n      &quot;name&quot;: &quot;washing machin&quot;\n    }\n  }\n}\n// ,namekeywordnamewashing machintermwashing machin\n\nGET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;match&quot;: {\n      &quot;name&quot;: &quot;washing&quot;\n    }\n  }\n}\n//keywordwhere name = &#39;washing&#39;\n\nGET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;match&quot;: {\n      &quot;name&quot;: &quot;washing machin&quot;\n    }\n  }\n}\n//where name = &#39;washing machin&#39;\n</code></pre>\n<pre><code class=\"json\">GET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;term&quot;: {\n      &quot;desc&quot;: &quot;Elasticsearch&quot;\n    }\n  }\n}\n//desctextElasticsearchElasticsearch\n\nGET my_index/_analyze\n{\n  &quot;analyzer&quot;: &quot;standard&quot;,\n  &quot;text&quot;: &quot;I wrote an Elasticsearch article, which I think is quite easy to understand, and I hope it will be helpful for getting started&quot;\n}\n\nGET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;term&quot;: {\n      &quot;desc&quot;: &quot;an Elasticsearch article&quot;\n    }\n  }\n}\n//an Elasticsearch article termMySQL=\n\nGET my_index/_search\n{\n  &quot;query&quot;: {\n    &quot;match&quot;: {\n      &quot;desc&quot;: &quot;an Elasticsearch article&quot;\n    }\n  }\n}\n//matchtexttextwhere desc = &#39;an&#39; or desc = &#39;Elasticsearch&#39; or desc = &#39;article&#39;.</code></pre>\n"},{"title":"GoLang","description":null,"date":"2021-11-12T09:14:00.000Z","_content":"### \n****\n\n****\n\nGo(intfloatboolstringarraystruct)`*int``*int64``*string`\n\n\n\n```go\nfunc main(){\n    a := 10\n    b := &a\n    fmt.Printf(\"a:%d ptr:%p\\n\", a , &a)\n    fmt.Printf(\"b:%p type:%T\\n\", b, b)\n    fmt.Println(&b)\n    // \n    // a:10 ptr:0xc000054080\n    // b:0xc000054080 type:*int\n    // 0xc000080018\n}\n```\n\n![](go-pointer/1.png)\n\n\n\n-  `a := 10` 10`0xc00054080`aaa10\n- `b := &a`go`&a`a10`0xc00080018`&a,`0xc00054080`````b``\n- go&&b`0cx00080018`\n\n### golang\n\n :\n\n-   \n-  \n\n#### 1\n\n```go\nfunc TestOther1(t *testing.T) {\n\tvar a int64 = 10\n\tfmt.Printf(\"a %p\\n\", &a)\n\tmodifiedNumber(a)\n\tfmt.Printf(\"a %d\", a)\n}\nfunc modifiedNumber(c int64) {\n\tfmt.Printf(\"c %p\\n\", &c)\n\tc = 100\n}\n//a 0xc00009e298\n//c 0xc00009e2a0\n//a 10\n```\n\n![](go-pointer/2.png)\n\n int64``ca`0xc0009e298`10`0xc0009e2a0`ca\n\n#### 2\n\n```go\nfunc TestOther2(t *testing.T) {\n\tvar a int64 = 10\n\tfmt.Printf(\"a %p\", &a)\n\tfmt.Println()\n\tmodifiedNumber2(&a) // args\n\tfmt.Printf(\"a %d\", a)\n\tfmt.Println()\n}\nfunc modifiedNumber2(c *int64) { //args\n\tfmt.Printf(\"c %v\" , c)\n\tfmt.Println()\n\t*c = 100\n}\n//a 0xc00000a348\n//c 0xc00000a348\n//a 100\n```\n\n![](go-pointer/3.png)\n\ncca`0xc00000a348``*c = 100`*cgoc`0xc00000a348` *c =100`0xc000003a68`a100ac\n\n  golang","source":"_posts/go-pointer.md","raw":"---\ntitle: GoLang\ntags:\n  - GoLang\ncategories: \n  - GoLang\ndescription : \ndate: 2021-11-12 17:14:00\n---\n### \n****\n\n****\n\nGo(intfloatboolstringarraystruct)`*int``*int64``*string`\n\n\n\n```go\nfunc main(){\n    a := 10\n    b := &a\n    fmt.Printf(\"a:%d ptr:%p\\n\", a , &a)\n    fmt.Printf(\"b:%p type:%T\\n\", b, b)\n    fmt.Println(&b)\n    // \n    // a:10 ptr:0xc000054080\n    // b:0xc000054080 type:*int\n    // 0xc000080018\n}\n```\n\n![](go-pointer/1.png)\n\n\n\n-  `a := 10` 10`0xc00054080`aaa10\n- `b := &a`go`&a`a10`0xc00080018`&a,`0xc00054080`````b``\n- go&&b`0cx00080018`\n\n### golang\n\n :\n\n-   \n-  \n\n#### 1\n\n```go\nfunc TestOther1(t *testing.T) {\n\tvar a int64 = 10\n\tfmt.Printf(\"a %p\\n\", &a)\n\tmodifiedNumber(a)\n\tfmt.Printf(\"a %d\", a)\n}\nfunc modifiedNumber(c int64) {\n\tfmt.Printf(\"c %p\\n\", &c)\n\tc = 100\n}\n//a 0xc00009e298\n//c 0xc00009e2a0\n//a 10\n```\n\n![](go-pointer/2.png)\n\n int64``ca`0xc0009e298`10`0xc0009e2a0`ca\n\n#### 2\n\n```go\nfunc TestOther2(t *testing.T) {\n\tvar a int64 = 10\n\tfmt.Printf(\"a %p\", &a)\n\tfmt.Println()\n\tmodifiedNumber2(&a) // args\n\tfmt.Printf(\"a %d\", a)\n\tfmt.Println()\n}\nfunc modifiedNumber2(c *int64) { //args\n\tfmt.Printf(\"c %v\" , c)\n\tfmt.Println()\n\t*c = 100\n}\n//a 0xc00000a348\n//c 0xc00000a348\n//a 100\n```\n\n![](go-pointer/3.png)\n\ncca`0xc00000a348``*c = 100`*cgoc`0xc00000a348` *c =100`0xc000003a68`a100ac\n\n  golang","slug":"go-pointer","published":1,"updated":"2021-11-19T07:17:06.487Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4if0000zsv295atdo8q","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<p><strong></strong></p>\n<p>Go(intfloatboolstringarraystruct)<code>*int</code><code>*int64</code><code>*string</code></p>\n<p></p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    a <span class=\"token operator\">:=</span> <span class=\"token number\">10</span>\n    b <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>a\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a:%d ptr:%p\\n\"</span><span class=\"token punctuation\">,</span> a <span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b:%p type:%T\\n\"</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\" spellcheck=\"true\">// </span>\n    <span class=\"token comment\" spellcheck=\"true\">// a:10 ptr:0xc000054080</span>\n    <span class=\"token comment\" spellcheck=\"true\">// b:0xc000054080 type:*int</span>\n    <span class=\"token comment\" spellcheck=\"true\">// 0xc000080018</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><img src=\"/2021/11/12/go-pointer/1.png\" alt></p>\n<p></p>\n<ul>\n<li> <code>a := 10</code> 10<code>0xc00054080</code>aaa10</li>\n<li><code>b := &amp;a</code>go<code>&amp;a</code>a10<code>0xc00080018</code>&amp;a,<code>0xc00054080</code><code></code><code></code>b<code></code></li>\n<li>go&amp;&amp;b<code>0cx00080018</code></li>\n</ul>\n<h3 id=\"golang\"><a href=\"#golang\" class=\"headerlink\" title=\"golang\"></a>golang</h3><p> :</p>\n<ul>\n<li>  </li>\n<li> </li>\n</ul>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestOther1</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> a <span class=\"token builtin\">int64</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a %p\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">modifiedNumber</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a %d\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">modifiedNumber</span><span class=\"token punctuation\">(</span>c <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c %p\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">)</span>\n    c <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//a 0xc00009e298</span>\n<span class=\"token comment\" spellcheck=\"true\">//c 0xc00009e2a0</span>\n<span class=\"token comment\" spellcheck=\"true\">//a 10</span></code></pre>\n<p><img src=\"/2021/11/12/go-pointer/2.png\" alt></p>\n<p> int64<code></code>ca<code>0xc0009e298</code>10<code>0xc0009e2a0</code>ca</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestOther2</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> a <span class=\"token builtin\">int64</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">modifiedNumber2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\" spellcheck=\"true\">// args</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a %d\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">modifiedNumber2</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span><span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\" spellcheck=\"true\">//args</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c %v\"</span> <span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">*</span>c <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//a 0xc00000a348</span>\n<span class=\"token comment\" spellcheck=\"true\">//c 0xc00000a348</span>\n<span class=\"token comment\" spellcheck=\"true\">//a 100</span></code></pre>\n<p><img src=\"/2021/11/12/go-pointer/3.png\" alt></p>\n<p>cca<code>0xc00000a348</code><code>*c = 100</code>*cgoc<code>0xc00000a348</code> *c =100<code>0xc000003a68</code>a100ac</p>\n<p>  golang</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong></strong></p>\n<p><strong></strong></p>\n<p>Go(intfloatboolstringarraystruct)<code>*int</code><code>*int64</code><code>*string</code></p>\n<p></p>\n<pre><code class=\"go\">func main(){\n    a := 10\n    b := &amp;a\n    fmt.Printf(&quot;a:%d ptr:%p\\n&quot;, a , &amp;a)\n    fmt.Printf(&quot;b:%p type:%T\\n&quot;, b, b)\n    fmt.Println(&amp;b)\n    // \n    // a:10 ptr:0xc000054080\n    // b:0xc000054080 type:*int\n    // 0xc000080018\n}</code></pre>\n<p><img src=\"/2021/11/12/go-pointer/1.png\" alt></p>\n<p></p>\n<ul>\n<li> <code>a := 10</code> 10<code>0xc00054080</code>aaa10</li>\n<li><code>b := &amp;a</code>go<code>&amp;a</code>a10<code>0xc00080018</code>&amp;a,<code>0xc00054080</code><code></code><code></code>b<code></code></li>\n<li>go&amp;&amp;b<code>0cx00080018</code></li>\n</ul>\n<h3 id=\"golang\"><a href=\"#golang\" class=\"headerlink\" title=\"golang\"></a>golang</h3><p> :</p>\n<ul>\n<li>  </li>\n<li> </li>\n</ul>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><pre><code class=\"go\">func TestOther1(t *testing.T) {\n    var a int64 = 10\n    fmt.Printf(&quot;a %p\\n&quot;, &amp;a)\n    modifiedNumber(a)\n    fmt.Printf(&quot;a %d&quot;, a)\n}\nfunc modifiedNumber(c int64) {\n    fmt.Printf(&quot;c %p\\n&quot;, &amp;c)\n    c = 100\n}\n//a 0xc00009e298\n//c 0xc00009e2a0\n//a 10</code></pre>\n<p><img src=\"/2021/11/12/go-pointer/2.png\" alt></p>\n<p> int64<code></code>ca<code>0xc0009e298</code>10<code>0xc0009e2a0</code>ca</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><pre><code class=\"go\">func TestOther2(t *testing.T) {\n    var a int64 = 10\n    fmt.Printf(&quot;a %p&quot;, &amp;a)\n    fmt.Println()\n    modifiedNumber2(&amp;a) // args\n    fmt.Printf(&quot;a %d&quot;, a)\n    fmt.Println()\n}\nfunc modifiedNumber2(c *int64) { //args\n    fmt.Printf(&quot;c %v&quot; , c)\n    fmt.Println()\n    *c = 100\n}\n//a 0xc00000a348\n//c 0xc00000a348\n//a 100</code></pre>\n<p><img src=\"/2021/11/12/go-pointer/3.png\" alt></p>\n<p>cca<code>0xc00000a348</code><code>*c = 100</code>*cgoc<code>0xc00000a348</code> *c =100<code>0xc000003a68</code>a100ac</p>\n<p>  golang</p>\n"},{"title":"Docker","description":"Docker","date":"2019-07-18T02:00:00.000Z","_content":"### Docker\n\n```sh\n#\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine\n\n#\nyum install -y yum-utils\n\n#\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n#yum \nyum makecache fast\n\n#docker docker-ce  ee \nyum install docker-ce docker-ce-cli containerd.io\n\n#docker version \ndocker version\n\n```\n\n### Docker\n\n```shell\ndocker image pull xxx #\ndocker images #\ndocker image inspect xxx #\ndocker rmi xxx #  docker rmi $(docker images -aq) \ndocker build -f Dockerfile -t :[tag] . #\n```\n\n### Docker\n\n```shell\n#image\ndocker run [] image | docker container run [] image\n# \n--name=\"Name\"  tomcat01 tomcat02  \n-d  \n-it  \n-p  -p 8080():8080() \n-P() \n\n#\ndocker -it id/ /bin/bash\n#kill\ndocker stop/start/restart/kill id/\n#\ndocker rm id/\n#\ndocker inspect id/\n```\n\n\n\n### Docker-Compose\n\n```shell\n# Compose , docker-compose.yml  docker-compose.yaml \n#-f\ndocker-compose up\n\n# Compose \ndocker-compose stop\n\n# Compose \ndocker-compose rm\n\n# Compose \ndocker-compose restart\n\n# Compose \ndocker-compose ps\n\n#\ndocker-compose down\n```\n\n","source":"_posts/docker-study.md","raw":"---\ntitle: Docker\ntags:\n  - Docker\ncategories:  Docker\ndescription : Docker\ndate: 2019-07-18 10:00:00\n---\n### Docker\n\n```sh\n#\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine\n\n#\nyum install -y yum-utils\n\n#\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n#yum \nyum makecache fast\n\n#docker docker-ce  ee \nyum install docker-ce docker-ce-cli containerd.io\n\n#docker version \ndocker version\n\n```\n\n### Docker\n\n```shell\ndocker image pull xxx #\ndocker images #\ndocker image inspect xxx #\ndocker rmi xxx #  docker rmi $(docker images -aq) \ndocker build -f Dockerfile -t :[tag] . #\n```\n\n### Docker\n\n```shell\n#image\ndocker run [] image | docker container run [] image\n# \n--name=\"Name\"  tomcat01 tomcat02  \n-d  \n-it  \n-p  -p 8080():8080() \n-P() \n\n#\ndocker -it id/ /bin/bash\n#kill\ndocker stop/start/restart/kill id/\n#\ndocker rm id/\n#\ndocker inspect id/\n```\n\n\n\n### Docker-Compose\n\n```shell\n# Compose , docker-compose.yml  docker-compose.yaml \n#-f\ndocker-compose up\n\n# Compose \ndocker-compose stop\n\n# Compose \ndocker-compose rm\n\n# Compose \ndocker-compose restart\n\n# Compose \ndocker-compose ps\n\n#\ndocker-compose down\n```\n\n","slug":"docker-study","published":1,"updated":"2021-10-09T13:35:50.014Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4ij0001zsv21ijs980z","content":"<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre class=\" language-sh\"><code class=\"language-sh\">#\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine\n\n#\nyum install -y yum-utils\n\n#\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n#yum \nyum makecache fast\n\n#docker docker-ce  ee \nyum install docker-ce docker-ce-cli containerd.io\n\n#docker version \ndocker version\n</code></pre>\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre class=\" language-shell\"><code class=\"language-shell\">docker image pull xxx #\ndocker images #\ndocker image inspect xxx #\ndocker rmi xxx #  docker rmi $(docker images -aq) \ndocker build -f Dockerfile -t :[tag] . #</code></pre>\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre class=\" language-shell\"><code class=\"language-shell\">#image\ndocker run [] image | docker container run [] image\n# \n--name=\"Name\"  tomcat01 tomcat02  \n-d  \n-it  \n-p  -p 8080():8080() \n-P() \n\n#\ndocker -it id/ /bin/bash\n#kill\ndocker stop/start/restart/kill id/\n#\ndocker rm id/\n#\ndocker inspect id/</code></pre>\n<h3 id=\"Docker-Compose\"><a href=\"#Docker-Compose\" class=\"headerlink\" title=\"Docker-Compose\"></a>Docker-Compose</h3><pre class=\" language-shell\"><code class=\"language-shell\"># Compose , docker-compose.yml  docker-compose.yaml \n#-f\ndocker-compose up\n\n# Compose \ndocker-compose stop\n\n# Compose \ndocker-compose rm\n\n# Compose \ndocker-compose restart\n\n# Compose \ndocker-compose ps\n\n#\ndocker-compose down</code></pre>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre><code class=\"sh\">#\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine\n\n#\nyum install -y yum-utils\n\n#\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n#yum \nyum makecache fast\n\n#docker docker-ce  ee \nyum install docker-ce docker-ce-cli containerd.io\n\n#docker version \ndocker version\n</code></pre>\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre><code class=\"shell\">docker image pull xxx #\ndocker images #\ndocker image inspect xxx #\ndocker rmi xxx #  docker rmi $(docker images -aq) \ndocker build -f Dockerfile -t :[tag] . #</code></pre>\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><pre><code class=\"shell\">#image\ndocker run [] image | docker container run [] image\n# \n--name=&quot;Name&quot;  tomcat01 tomcat02  \n-d  \n-it  \n-p  -p 8080():8080() \n-P() \n\n#\ndocker -it id/ /bin/bash\n#kill\ndocker stop/start/restart/kill id/\n#\ndocker rm id/\n#\ndocker inspect id/</code></pre>\n<h3 id=\"Docker-Compose\"><a href=\"#Docker-Compose\" class=\"headerlink\" title=\"Docker-Compose\"></a>Docker-Compose</h3><pre><code class=\"shell\"># Compose , docker-compose.yml  docker-compose.yaml \n#-f\ndocker-compose up\n\n# Compose \ndocker-compose stop\n\n# Compose \ndocker-compose rm\n\n# Compose \ndocker-compose restart\n\n# Compose \ndocker-compose ps\n\n#\ndocker-compose down</code></pre>\n"},{"title":"Docker","description":"Docker","date":"2019-07-18T02:00:00.000Z","_content":"### DockerRedis\n\n***1.Docker***\n\n```shell\ndocker network create redis-cluster-net #Redisping\n[root@localhost ~]# docker network inspect redis-cluster-net #GateWay\n\"IPAM\": {\n            \"Driver\": \"default\",\n            \"Options\": {},\n            \"Config\": [\n                {\n                    \"Subnet\": \"172.20.0.0/16\",\n                    \"Gateway\": \"172.20.0.1\"\n                }\n            ]\n}\n```\n\n***2.6Redisdataredis.conf***\n\n```shell\nfor port in $(seq 1 6);\\\ndo \\\nmkdir -p /home/project/redis/node-${port}/conf \ntouch /home/project/redis/node-${port}/conf/redis.conf \ncat << EOF >> /home/project/redis/node-${port}/conf/redis.conf \nport 6379 \nbind 0.0.0.0\ncluster-enabled yes \ncluster-config-file nodes.conf \ncluster-node-timeout 5000 \ncluster-announce-ip 172.20.0.1${port} \ncluster-announce-port 6379 \ncluster-announce-bus-port 16379 \nappendonly yes\nEOF\ndone\n```\n\n***3.6redis***\n\n```shell\n\n\ndocker run -p 6371:6379 -p 16671:16379 --name redis-1 -v /home/project/redis/node-1/data:/data -v /home/project/redis/node-1/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6372:6379 -p 16672:16379 --name redis-2 -v /home/project/redis/node-2/data:/data -v /home/project/redis/node-2/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6373:6379 -p 16673:16379 --name redis-3 -v /home/project/redis/node-3/data:/data -v /home/project/redis/node-3/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6374:6379 -p 16674:16379 --name redis-4 -v /home/project/redis/node-4/data:/data -v /home/project/redis/node-4/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6375:6379 -p 16675:16379 --name redis-5 -v /home/project/redis/node-5/data:/data -v /home/project/redis/node-5/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6376:6379 -p 16676:16379 --name redis-6 -v /home/project/redis/node-6/data:/data -v /home/project/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n```\n\n6redisping\n\n```shell\n[root@localhost ~]# docker ps\nCONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES\n9547f6533dd7   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   13 minutes ago   Up 13 minutes   0.0.0.0:6376->6379/tcp, :::6376->6379/tcp, 0.0.0.0:16676->16379/tcp, :::16676->16379/tcp   redis-6\n379c980981ae   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6375->6379/tcp, :::6375->6379/tcp, 0.0.0.0:16675->16379/tcp, :::16675->16379/tcp   redis-5\nd61aaa73d81d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6374->6379/tcp, :::6374->6379/tcp, 0.0.0.0:16674->16379/tcp, :::16674->16379/tcp   redis-4\n314127dbe25d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6373->6379/tcp, :::6373->6379/tcp, 0.0.0.0:16673->16379/tcp, :::16673->16379/tcp   redis-3\nad87d3457967   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6372->6379/tcp, :::6372->6379/tcp, 0.0.0.0:16672->16379/tcp, :::16672->16379/tcp   redis-2\n67031339409f   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   15 minutes ago   Up 15 minutes   0.0.0.0:6371->6379/tcp, :::6371->6379/tcp, 0.0.0.0:16671->16379/tcp, :::16671->16379/tcp   redis-1\n```\n***4.***\n```shell\n#redis\ndocker exec -it redis-1 /bin/sh #redisbash\n#\nredis-cli --cluster create 172.20.0.11:6379 172.20.0.12:6379 172.20.0.13:6379 172.20.0.14:6379 172.20.0.15:6379 172.20.0.16:6379 --cluster-replicas 1\n#redis\n```\n\n\n","source":"_posts/docker-redis.md","raw":"---\ntitle: Docker\ntags:\n  - Docker\ncategories:  Docker\ndescription : Docker\ndate: 2019-07-18 10:00:00\n---\n### DockerRedis\n\n***1.Docker***\n\n```shell\ndocker network create redis-cluster-net #Redisping\n[root@localhost ~]# docker network inspect redis-cluster-net #GateWay\n\"IPAM\": {\n            \"Driver\": \"default\",\n            \"Options\": {},\n            \"Config\": [\n                {\n                    \"Subnet\": \"172.20.0.0/16\",\n                    \"Gateway\": \"172.20.0.1\"\n                }\n            ]\n}\n```\n\n***2.6Redisdataredis.conf***\n\n```shell\nfor port in $(seq 1 6);\\\ndo \\\nmkdir -p /home/project/redis/node-${port}/conf \ntouch /home/project/redis/node-${port}/conf/redis.conf \ncat << EOF >> /home/project/redis/node-${port}/conf/redis.conf \nport 6379 \nbind 0.0.0.0\ncluster-enabled yes \ncluster-config-file nodes.conf \ncluster-node-timeout 5000 \ncluster-announce-ip 172.20.0.1${port} \ncluster-announce-port 6379 \ncluster-announce-bus-port 16379 \nappendonly yes\nEOF\ndone\n```\n\n***3.6redis***\n\n```shell\n\n\ndocker run -p 6371:6379 -p 16671:16379 --name redis-1 -v /home/project/redis/node-1/data:/data -v /home/project/redis/node-1/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6372:6379 -p 16672:16379 --name redis-2 -v /home/project/redis/node-2/data:/data -v /home/project/redis/node-2/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6373:6379 -p 16673:16379 --name redis-3 -v /home/project/redis/node-3/data:/data -v /home/project/redis/node-3/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6374:6379 -p 16674:16379 --name redis-4 -v /home/project/redis/node-4/data:/data -v /home/project/redis/node-4/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6375:6379 -p 16675:16379 --name redis-5 -v /home/project/redis/node-5/data:/data -v /home/project/redis/node-5/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6376:6379 -p 16676:16379 --name redis-6 -v /home/project/redis/node-6/data:/data -v /home/project/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n```\n\n6redisping\n\n```shell\n[root@localhost ~]# docker ps\nCONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES\n9547f6533dd7   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   13 minutes ago   Up 13 minutes   0.0.0.0:6376->6379/tcp, :::6376->6379/tcp, 0.0.0.0:16676->16379/tcp, :::16676->16379/tcp   redis-6\n379c980981ae   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6375->6379/tcp, :::6375->6379/tcp, 0.0.0.0:16675->16379/tcp, :::16675->16379/tcp   redis-5\nd61aaa73d81d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6374->6379/tcp, :::6374->6379/tcp, 0.0.0.0:16674->16379/tcp, :::16674->16379/tcp   redis-4\n314127dbe25d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6373->6379/tcp, :::6373->6379/tcp, 0.0.0.0:16673->16379/tcp, :::16673->16379/tcp   redis-3\nad87d3457967   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6372->6379/tcp, :::6372->6379/tcp, 0.0.0.0:16672->16379/tcp, :::16672->16379/tcp   redis-2\n67031339409f   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   15 minutes ago   Up 15 minutes   0.0.0.0:6371->6379/tcp, :::6371->6379/tcp, 0.0.0.0:16671->16379/tcp, :::16671->16379/tcp   redis-1\n```\n***4.***\n```shell\n#redis\ndocker exec -it redis-1 /bin/sh #redisbash\n#\nredis-cli --cluster create 172.20.0.11:6379 172.20.0.12:6379 172.20.0.13:6379 172.20.0.14:6379 172.20.0.15:6379 172.20.0.16:6379 --cluster-replicas 1\n#redis\n```\n\n\n","slug":"docker-redis","published":1,"updated":"2021-06-18T01:15:27.673Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4iw0004zsv28b8xhers","content":"<h3 id=\"DockerRedis\"><a href=\"#DockerRedis\" class=\"headerlink\" title=\"DockerRedis\"></a>DockerRedis</h3><p><strong><em>1.Docker</em></strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">docker network create redis-cluster-net #Redisping\n[root@localhost ~]# docker network inspect redis-cluster-net #GateWay\n\"IPAM\": {\n            \"Driver\": \"default\",\n            \"Options\": {},\n            \"Config\": [\n                {\n                    \"Subnet\": \"172.20.0.0/16\",\n                    \"Gateway\": \"172.20.0.1\"\n                }\n            ]\n}</code></pre>\n<p><strong><em>2.6Redisdataredis.conf</em></strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">for port in $(seq 1 6);\\\ndo \\\nmkdir -p /home/project/redis/node-${port}/conf \ntouch /home/project/redis/node-${port}/conf/redis.conf \ncat << EOF >> /home/project/redis/node-${port}/conf/redis.conf \nport 6379 \nbind 0.0.0.0\ncluster-enabled yes \ncluster-config-file nodes.conf \ncluster-node-timeout 5000 \ncluster-announce-ip 172.20.0.1${port} \ncluster-announce-port 6379 \ncluster-announce-bus-port 16379 \nappendonly yes\nEOF\ndone</code></pre>\n<p><strong><em>3.6redis</em></strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">\n\ndocker run -p 6371:6379 -p 16671:16379 --name redis-1 -v /home/project/redis/node-1/data:/data -v /home/project/redis/node-1/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6372:6379 -p 16672:16379 --name redis-2 -v /home/project/redis/node-2/data:/data -v /home/project/redis/node-2/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6373:6379 -p 16673:16379 --name redis-3 -v /home/project/redis/node-3/data:/data -v /home/project/redis/node-3/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6374:6379 -p 16674:16379 --name redis-4 -v /home/project/redis/node-4/data:/data -v /home/project/redis/node-4/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6375:6379 -p 16675:16379 --name redis-5 -v /home/project/redis/node-5/data:/data -v /home/project/redis/node-5/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6376:6379 -p 16676:16379 --name redis-6 -v /home/project/redis/node-6/data:/data -v /home/project/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</code></pre>\n<p>6redisping</p>\n<pre class=\" language-shell\"><code class=\"language-shell\">[root@localhost ~]# docker ps\nCONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES\n9547f6533dd7   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   13 minutes ago   Up 13 minutes   0.0.0.0:6376->6379/tcp, :::6376->6379/tcp, 0.0.0.0:16676->16379/tcp, :::16676->16379/tcp   redis-6\n379c980981ae   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6375->6379/tcp, :::6375->6379/tcp, 0.0.0.0:16675->16379/tcp, :::16675->16379/tcp   redis-5\nd61aaa73d81d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6374->6379/tcp, :::6374->6379/tcp, 0.0.0.0:16674->16379/tcp, :::16674->16379/tcp   redis-4\n314127dbe25d   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6373->6379/tcp, :::6373->6379/tcp, 0.0.0.0:16673->16379/tcp, :::16673->16379/tcp   redis-3\nad87d3457967   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   14 minutes ago   Up 14 minutes   0.0.0.0:6372->6379/tcp, :::6372->6379/tcp, 0.0.0.0:16672->16379/tcp, :::16672->16379/tcp   redis-2\n67031339409f   redis:5.0.9-alpine3.11   \"docker-entrypoint.s\"   15 minutes ago   Up 15 minutes   0.0.0.0:6371->6379/tcp, :::6371->6379/tcp, 0.0.0.0:16671->16379/tcp, :::16671->16379/tcp   redis-1</code></pre>\n<p><strong><em>4.</em></strong></p>\n<pre class=\" language-shell\"><code class=\"language-shell\">#redis\ndocker exec -it redis-1 /bin/sh #redisbash\n#\nredis-cli --cluster create 172.20.0.11:6379 172.20.0.12:6379 172.20.0.13:6379 172.20.0.14:6379 172.20.0.15:6379 172.20.0.16:6379 --cluster-replicas 1\n#redis</code></pre>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"DockerRedis\"><a href=\"#DockerRedis\" class=\"headerlink\" title=\"DockerRedis\"></a>DockerRedis</h3><p><strong><em>1.Docker</em></strong></p>\n<pre><code class=\"shell\">docker network create redis-cluster-net #Redisping\n[root@localhost ~]# docker network inspect redis-cluster-net #GateWay\n&quot;IPAM&quot;: {\n            &quot;Driver&quot;: &quot;default&quot;,\n            &quot;Options&quot;: {},\n            &quot;Config&quot;: [\n                {\n                    &quot;Subnet&quot;: &quot;172.20.0.0/16&quot;,\n                    &quot;Gateway&quot;: &quot;172.20.0.1&quot;\n                }\n            ]\n}</code></pre>\n<p><strong><em>2.6Redisdataredis.conf</em></strong></p>\n<pre><code class=\"shell\">for port in $(seq 1 6);\\\ndo \\\nmkdir -p /home/project/redis/node-${port}/conf \ntouch /home/project/redis/node-${port}/conf/redis.conf \ncat &lt;&lt; EOF &gt;&gt; /home/project/redis/node-${port}/conf/redis.conf \nport 6379 \nbind 0.0.0.0\ncluster-enabled yes \ncluster-config-file nodes.conf \ncluster-node-timeout 5000 \ncluster-announce-ip 172.20.0.1${port} \ncluster-announce-port 6379 \ncluster-announce-bus-port 16379 \nappendonly yes\nEOF\ndone</code></pre>\n<p><strong><em>3.6redis</em></strong></p>\n<pre><code class=\"shell\">\n\ndocker run -p 6371:6379 -p 16671:16379 --name redis-1 -v /home/project/redis/node-1/data:/data -v /home/project/redis/node-1/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6372:6379 -p 16672:16379 --name redis-2 -v /home/project/redis/node-2/data:/data -v /home/project/redis/node-2/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6373:6379 -p 16673:16379 --name redis-3 -v /home/project/redis/node-3/data:/data -v /home/project/redis/node-3/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6374:6379 -p 16674:16379 --name redis-4 -v /home/project/redis/node-4/data:/data -v /home/project/redis/node-4/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6375:6379 -p 16675:16379 --name redis-5 -v /home/project/redis/node-5/data:/data -v /home/project/redis/node-5/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf\n\n\ndocker run -p 6376:6379 -p 16676:16379 --name redis-6 -v /home/project/redis/node-6/data:/data -v /home/project/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis-cluster-net --ip 172.20.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</code></pre>\n<p>6redisping</p>\n<pre><code class=\"shell\">[root@localhost ~]# docker ps\nCONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES\n9547f6533dd7   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   13 minutes ago   Up 13 minutes   0.0.0.0:6376-&gt;6379/tcp, :::6376-&gt;6379/tcp, 0.0.0.0:16676-&gt;16379/tcp, :::16676-&gt;16379/tcp   redis-6\n379c980981ae   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   14 minutes ago   Up 14 minutes   0.0.0.0:6375-&gt;6379/tcp, :::6375-&gt;6379/tcp, 0.0.0.0:16675-&gt;16379/tcp, :::16675-&gt;16379/tcp   redis-5\nd61aaa73d81d   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   14 minutes ago   Up 14 minutes   0.0.0.0:6374-&gt;6379/tcp, :::6374-&gt;6379/tcp, 0.0.0.0:16674-&gt;16379/tcp, :::16674-&gt;16379/tcp   redis-4\n314127dbe25d   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   14 minutes ago   Up 14 minutes   0.0.0.0:6373-&gt;6379/tcp, :::6373-&gt;6379/tcp, 0.0.0.0:16673-&gt;16379/tcp, :::16673-&gt;16379/tcp   redis-3\nad87d3457967   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   14 minutes ago   Up 14 minutes   0.0.0.0:6372-&gt;6379/tcp, :::6372-&gt;6379/tcp, 0.0.0.0:16672-&gt;16379/tcp, :::16672-&gt;16379/tcp   redis-2\n67031339409f   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s&quot;   15 minutes ago   Up 15 minutes   0.0.0.0:6371-&gt;6379/tcp, :::6371-&gt;6379/tcp, 0.0.0.0:16671-&gt;16379/tcp, :::16671-&gt;16379/tcp   redis-1</code></pre>\n<p><strong><em>4.</em></strong></p>\n<pre><code class=\"shell\">#redis\ndocker exec -it redis-1 /bin/sh #redisbash\n#\nredis-cli --cluster create 172.20.0.11:6379 172.20.0.12:6379 172.20.0.13:6379 172.20.0.14:6379 172.20.0.15:6379 172.20.0.16:6379 --cluster-replicas 1\n#redis</code></pre>\n"},{"title":"Rust","description":"Rust","date":"2020-08-13T16:00:00.000Z","_content":"\n### \n\n******\n\n:?`fmt::Debug``trait``#[derive(Debug)]`\n\n```rust\nfn main(){\n    #[derive(Debug)]\n\tstruct UnPrintable(i32);\n\tprintln!(\"{:?}\", DebugPrintable(13));\n    #[derive(Debug)]\n    struct Person<'a> {\n        name: &'a str,\n        age: u8\n    }\n    let name = \"Peter\";\n    let age = 27;\n    let peter = Person { name, age };\n    // \n    println!(\"{:#?}\", peter);\n}\n```\n\n******\n\n```rust\nlet immutable_binding = 1;  //\nlet _immutable_binding = 1; //_ \n```\n\n***Rustas***\n\n```rust\nlet decimal = 65.4321_f32;\n// \nlet integer: u8 = decimal;\n//  ^ \n// \nlet integer = decimal as u8;\n```\n\n******\n\n- From  Into\n- TryFrom  TryInto FromIntoResult\n- ToString  FromStr string\n\n```rust\nuse std::convert::From;\n#[derive(Debug)]\nstruct Number {\n    value: i32,\n}\n// From<i32>i32into()Number\n// i32Number let num: Number = 5.into();\nimpl From<i32> for Number {\n    fn from(item: i32) -> Self {\n        Number { value: item }\n    }\n}\nfn main(){\n    let int: i32 = 5;\n    let num: Number = int.into();\n    println!(\"My number is {:?}\", num);\n}\n```\n\n```rust\nuse std::convert::TryFrom;\nuse std::convert::TryInto;\n#[derive(Debug, PartialEq)]\nstruct EvenNumber(i32);\nimpl TryFrom<i32> for EvenNumber {\n    type Error = ();\n    fn try_from(value: i32) -> Result<Self, Self::Error> {\n        if value % 2 == 0 {\n            Ok(EvenNumber(value))\n        } else {\n            Err(())\n        }\n    }\n}\nfn main(){\n    let result: Result<EvenNumber, ()> = 8i32.try_into();\n    assert_eq!(result, Ok(EvenNumber(8)));\n    let result: Result<EvenNumber, ()> = 5i32.try_into();\n    assert_eq!(result, Err(()));\n}\n```\n\n***Rust***\n\n- iter() ,  \n- into_iter() ,   move\n- iter_mut() , mutably\n\n***Rustmove***\n\nmove``move\n\n```rust\nfn main() {\n    struct Point {\n        x: i64,\n        y: i64,\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(\"p address: {:p}\", &p);\n        (|| {\n            println!(\"movep address: {:p}\", &p);\n        })();\n        println!(\"p address: {:p}\", &p);\n        println!(\"------------------------------\");\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(\"p address: {:p}\", &p);\n        (move || {\n            println!(\"movep address: {:p}\", &p);\n        })();\n        //println!(\"p address: {:p}\", &p);//error[E0382]: borrow of moved value: `p`\n    }\n}\n```\n\n***Rust***\n\n\n\n- cfg  #[cfg(...)]\n- cfg!  cfg!(...)\n\n`#[cfg(xxx)]`  `#[cfg(not(xxx))]`\n\n```rust\n//  Linux \n#[cfg(target_os = \"linux\")]\nfn are_you_on_linux() {\n    println!(\"You are running linux!\")\n}\n// Linux\n#[cfg(not(target_os = \"linux\"))]\nfn are_you_on_linux() {\n    println!(\"You are *not* running linux!\")\n}\npub fn demo13(){\n    are_you_on_linux();\n}\n```\n\n`target_os``--cfg xxx`\n\n```rust\n#[cfg(some_condition)]\nfn conditional_function() {\n    println!(\"condition met!\")\n}\n#[cfg(not(some_condition))]\nfn conditional_function() {\n    println!(\"condition met not !\")\n}\nfn main() {\n    conditional_function();\n}\n// rustc --cfg some_condition xxx.rs && ./custom\n```\n\n***Rust(trait)***\n\ntrait \n\n-  trait  impl  trait\n-  trait \n\n```rust\npub trait Converter<T> {\n    fn convert(&self) -> T;\n}\nstruct MyInt;\nimpl Converter<i32> for MyInt {\n    fn convert(&self) -> i32 {\n        42\n    }\n}\nfn main(){\n    let my_int = MyInt;\n    let output: i32 = my_int.convert();\n    println!(\"output is: {}\", output);\n    \n    let output: f32 = my_int.convert(); //MyIntConverter<f32>trait\n    println!(\"output is: {}\", output);\n}\n```\n\n***trait***\n\n  `Animal`  trait `Animal` \n\n `Box + dyn`\n\n```rust\nstruct Sheep {}\nstruct Cow {}\ntrait Animal {\n    fn noise(&self) -> &'static str;\n}\nimpl Animal for Sheep {\n    fn noise(&self) -> &'static str {\n            \"baaaaah!\"\n    }\n}\nimpl Animal for Cow {\n    fn noise(&self) -> &'static str {\n        \"moooooo!\"\n    }\n}\nfn random_animal(random_number: f64) -> impl Animal {\n    if random_number < 0.5 {\n    \tSheep {}\n    }else{\n\t    Cow {}\n    }\n}\nfn random_animal_2(random_number: f64) -> Box<dyn Animal> {\n    if random_number < 0.5 {\n        Box::new(Sheep {})\n    }else {\n        Box::new(Cow {})\n    }\n}\nfn main {\n    let random_number = 0.234;\n    let animal = random_animal_2(random_number);\n    println!(\"You've randomly chosen an animal, and it says {}\", animal.noise());\n}\n```\n\n***Option<T>  unwrap***\n\n- `Some(T)` :  `T` \n- `None` : \n\n```rust\nfn give_commoner(gift: Option<&str>) {\n    match gift {\n        Some(\"snake\") => println!(\"Yuck! I'm throwing that snake in a fire.\"),\n        Some(inner)   => println!(\"{}? How nice.\", inner),\n        None          => println!(\"No gift? Oh well.\"),\n    }\n}\nfn give_princess(gift: Option<&str>) {\n    // `unwrap`  `None`  `panic`\n    let inside = gift.unwarp();\n    if inside == \"snake\" { \n        panic!(\"AAAaaaaa!!!!\");\n    }\n    println!(\"I love {}s!!!!!\", inside);\n}\nfn main(){\n\tlet food  = Some(\"chicken\");\n    let snake = Some(\"snake\");\n    let void  = None;\n    give_commoner(food);\n    give_commoner(snake);\n    give_commoner(void);\n\n    let bird = Some(\"robin\");\n    let nothing = None;\n    give_princess(bird);\n    give_princess(nothing);\n}\n```\n\n`?``Option`\n\n-  `current_age`  `None` `None`\n-  `current_age`  `Some` `u8`  `next_age`\n\n```rust\nfn next_birthday(current_age: Option<u8>) -> Option<String> {\n    let next_age: u8 = current_age?;\n    Some(format!(\"Next year I will be {}\", next_age))\n}\n```\n\n### \n\n|                                        |                                                  |\n| ------------------------------------------ | ---------------------------------------------------- |\n| #[derive(Debug)]                           | `Debug`                                  |\n| #![allow(dead_code)]                       |                      |\n| #![allow(overflowing_literals)]            |                          |\n| 1..10                                      | 11010                              |\n| 1..=10                                     | 11010                                |\n| move                                       | move |\n| \\#[derive(RustcDecodable, RustcEncodable)] |                                      |\n\n","source":"_posts/rust-node-1.md","raw":"---\ntitle: Rust\ntags:\n  - rust\ncategories: rust\ndescription : Rust\ndate: 2020-08-14\n---\n\n### \n\n******\n\n:?`fmt::Debug``trait``#[derive(Debug)]`\n\n```rust\nfn main(){\n    #[derive(Debug)]\n\tstruct UnPrintable(i32);\n\tprintln!(\"{:?}\", DebugPrintable(13));\n    #[derive(Debug)]\n    struct Person<'a> {\n        name: &'a str,\n        age: u8\n    }\n    let name = \"Peter\";\n    let age = 27;\n    let peter = Person { name, age };\n    // \n    println!(\"{:#?}\", peter);\n}\n```\n\n******\n\n```rust\nlet immutable_binding = 1;  //\nlet _immutable_binding = 1; //_ \n```\n\n***Rustas***\n\n```rust\nlet decimal = 65.4321_f32;\n// \nlet integer: u8 = decimal;\n//  ^ \n// \nlet integer = decimal as u8;\n```\n\n******\n\n- From  Into\n- TryFrom  TryInto FromIntoResult\n- ToString  FromStr string\n\n```rust\nuse std::convert::From;\n#[derive(Debug)]\nstruct Number {\n    value: i32,\n}\n// From<i32>i32into()Number\n// i32Number let num: Number = 5.into();\nimpl From<i32> for Number {\n    fn from(item: i32) -> Self {\n        Number { value: item }\n    }\n}\nfn main(){\n    let int: i32 = 5;\n    let num: Number = int.into();\n    println!(\"My number is {:?}\", num);\n}\n```\n\n```rust\nuse std::convert::TryFrom;\nuse std::convert::TryInto;\n#[derive(Debug, PartialEq)]\nstruct EvenNumber(i32);\nimpl TryFrom<i32> for EvenNumber {\n    type Error = ();\n    fn try_from(value: i32) -> Result<Self, Self::Error> {\n        if value % 2 == 0 {\n            Ok(EvenNumber(value))\n        } else {\n            Err(())\n        }\n    }\n}\nfn main(){\n    let result: Result<EvenNumber, ()> = 8i32.try_into();\n    assert_eq!(result, Ok(EvenNumber(8)));\n    let result: Result<EvenNumber, ()> = 5i32.try_into();\n    assert_eq!(result, Err(()));\n}\n```\n\n***Rust***\n\n- iter() ,  \n- into_iter() ,   move\n- iter_mut() , mutably\n\n***Rustmove***\n\nmove``move\n\n```rust\nfn main() {\n    struct Point {\n        x: i64,\n        y: i64,\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(\"p address: {:p}\", &p);\n        (|| {\n            println!(\"movep address: {:p}\", &p);\n        })();\n        println!(\"p address: {:p}\", &p);\n        println!(\"------------------------------\");\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(\"p address: {:p}\", &p);\n        (move || {\n            println!(\"movep address: {:p}\", &p);\n        })();\n        //println!(\"p address: {:p}\", &p);//error[E0382]: borrow of moved value: `p`\n    }\n}\n```\n\n***Rust***\n\n\n\n- cfg  #[cfg(...)]\n- cfg!  cfg!(...)\n\n`#[cfg(xxx)]`  `#[cfg(not(xxx))]`\n\n```rust\n//  Linux \n#[cfg(target_os = \"linux\")]\nfn are_you_on_linux() {\n    println!(\"You are running linux!\")\n}\n// Linux\n#[cfg(not(target_os = \"linux\"))]\nfn are_you_on_linux() {\n    println!(\"You are *not* running linux!\")\n}\npub fn demo13(){\n    are_you_on_linux();\n}\n```\n\n`target_os``--cfg xxx`\n\n```rust\n#[cfg(some_condition)]\nfn conditional_function() {\n    println!(\"condition met!\")\n}\n#[cfg(not(some_condition))]\nfn conditional_function() {\n    println!(\"condition met not !\")\n}\nfn main() {\n    conditional_function();\n}\n// rustc --cfg some_condition xxx.rs && ./custom\n```\n\n***Rust(trait)***\n\ntrait \n\n-  trait  impl  trait\n-  trait \n\n```rust\npub trait Converter<T> {\n    fn convert(&self) -> T;\n}\nstruct MyInt;\nimpl Converter<i32> for MyInt {\n    fn convert(&self) -> i32 {\n        42\n    }\n}\nfn main(){\n    let my_int = MyInt;\n    let output: i32 = my_int.convert();\n    println!(\"output is: {}\", output);\n    \n    let output: f32 = my_int.convert(); //MyIntConverter<f32>trait\n    println!(\"output is: {}\", output);\n}\n```\n\n***trait***\n\n  `Animal`  trait `Animal` \n\n `Box + dyn`\n\n```rust\nstruct Sheep {}\nstruct Cow {}\ntrait Animal {\n    fn noise(&self) -> &'static str;\n}\nimpl Animal for Sheep {\n    fn noise(&self) -> &'static str {\n            \"baaaaah!\"\n    }\n}\nimpl Animal for Cow {\n    fn noise(&self) -> &'static str {\n        \"moooooo!\"\n    }\n}\nfn random_animal(random_number: f64) -> impl Animal {\n    if random_number < 0.5 {\n    \tSheep {}\n    }else{\n\t    Cow {}\n    }\n}\nfn random_animal_2(random_number: f64) -> Box<dyn Animal> {\n    if random_number < 0.5 {\n        Box::new(Sheep {})\n    }else {\n        Box::new(Cow {})\n    }\n}\nfn main {\n    let random_number = 0.234;\n    let animal = random_animal_2(random_number);\n    println!(\"You've randomly chosen an animal, and it says {}\", animal.noise());\n}\n```\n\n***Option<T>  unwrap***\n\n- `Some(T)` :  `T` \n- `None` : \n\n```rust\nfn give_commoner(gift: Option<&str>) {\n    match gift {\n        Some(\"snake\") => println!(\"Yuck! I'm throwing that snake in a fire.\"),\n        Some(inner)   => println!(\"{}? How nice.\", inner),\n        None          => println!(\"No gift? Oh well.\"),\n    }\n}\nfn give_princess(gift: Option<&str>) {\n    // `unwrap`  `None`  `panic`\n    let inside = gift.unwarp();\n    if inside == \"snake\" { \n        panic!(\"AAAaaaaa!!!!\");\n    }\n    println!(\"I love {}s!!!!!\", inside);\n}\nfn main(){\n\tlet food  = Some(\"chicken\");\n    let snake = Some(\"snake\");\n    let void  = None;\n    give_commoner(food);\n    give_commoner(snake);\n    give_commoner(void);\n\n    let bird = Some(\"robin\");\n    let nothing = None;\n    give_princess(bird);\n    give_princess(nothing);\n}\n```\n\n`?``Option`\n\n-  `current_age`  `None` `None`\n-  `current_age`  `Some` `u8`  `next_age`\n\n```rust\nfn next_birthday(current_age: Option<u8>) -> Option<String> {\n    let next_age: u8 = current_age?;\n    Some(format!(\"Next year I will be {}\", next_age))\n}\n```\n\n### \n\n|                                        |                                                  |\n| ------------------------------------------ | ---------------------------------------------------- |\n| #[derive(Debug)]                           | `Debug`                                  |\n| #![allow(dead_code)]                       |                      |\n| #![allow(overflowing_literals)]            |                          |\n| 1..10                                      | 11010                              |\n| 1..=10                                     | 11010                                |\n| move                                       | move |\n| \\#[derive(RustcDecodable, RustcEncodable)] |                                      |\n\n","slug":"rust-node-1","published":1,"updated":"2021-06-21T06:33:02.868Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4ix0005zsv2e2f62itu","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong><em></em></strong></p>\n<p>:?<code>fmt::Debug</code><code>trait</code><code>#[derive(Debug)]</code></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token function\">UnPrintable</span><span class=\"token punctuation\">(</span>i32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{:?}\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DebugPrintable</span><span class=\"token punctuation\">(</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n    <span class=\"token keyword\">struct</span> Person<span class=\"token operator\">&lt;</span>'a<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>'a str<span class=\"token punctuation\">,</span>\n        age<span class=\"token punctuation\">:</span> u8\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> <span class=\"token string\">\"Peter\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> age <span class=\"token operator\">=</span> <span class=\"token number\">27</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> peter <span class=\"token operator\">=</span> Person <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> age <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\" spellcheck=\"true\">// </span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{:#?}\"</span><span class=\"token punctuation\">,</span> peter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong><em></em></strong></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> immutable_binding <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token keyword\">let</span> _immutable_binding <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//_ </span></code></pre>\n<p><strong><em>Rustas</em></strong></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> decimal <span class=\"token operator\">=</span> <span class=\"token number\">65.4321_f32</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">let</span> integer<span class=\"token punctuation\">:</span> u8 <span class=\"token operator\">=</span> decimal<span class=\"token punctuation\">;</span>\n<span class=\"token comment\" spellcheck=\"true\">//  ^ </span>\n<span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token keyword\">let</span> integer <span class=\"token operator\">=</span> decimal <span class=\"token keyword\">as</span> u8<span class=\"token punctuation\">;</span></code></pre>\n<p><strong><em></em></strong></p>\n<ul>\n<li>From  Into</li>\n<li>TryFrom  TryInto FromIntoResult</li>\n<li>ToString  FromStr string</li>\n</ul>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>convert<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>From<span class=\"token punctuation\">;</span>\n<span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n<span class=\"token keyword\">struct</span> Number <span class=\"token punctuation\">{</span>\n    value<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// From&lt;i32>i32into()Number</span>\n<span class=\"token comment\" spellcheck=\"true\">// i32Number let num: Number = 5.into();</span>\n<span class=\"token keyword\">impl</span> From<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span> <span class=\"token keyword\">for</span> Number <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">from</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Self <span class=\"token punctuation\">{</span>\n        Number <span class=\"token punctuation\">{</span> value<span class=\"token punctuation\">:</span> item <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> int<span class=\"token punctuation\">:</span> i32 <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> num<span class=\"token punctuation\">:</span> Number <span class=\"token operator\">=</span> int<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"My number is {:?}\"</span><span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>convert<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>TryFrom<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>convert<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>TryInto<span class=\"token punctuation\">;</span>\n<span class=\"token attribute attr-name\">#[derive(Debug, PartialEq)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token function\">EvenNumber</span><span class=\"token punctuation\">(</span>i32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">impl</span> TryFrom<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span> <span class=\"token keyword\">for</span> EvenNumber <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> Error <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">try_from</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Result<span class=\"token operator\">&lt;</span>Self<span class=\"token punctuation\">,</span> Self<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Error<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> value <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token function\">EvenNumber</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result<span class=\"token punctuation\">:</span> Result<span class=\"token operator\">&lt;</span>EvenNumber<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token number\">8i32</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert_eq!</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token function\">EvenNumber</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> result<span class=\"token punctuation\">:</span> Result<span class=\"token operator\">&lt;</span>EvenNumber<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token number\">5i32</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert_eq!</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong><em>Rust</em></strong></p>\n<ul>\n<li>iter() ,  </li>\n<li>into_iter() ,   move</li>\n<li>iter_mut() , mutably</li>\n</ul>\n<p><strong><em>Rustmove</em></strong></p>\n<p>move<code></code>move</p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">struct</span> Point <span class=\"token punctuation\">{</span>\n        x<span class=\"token punctuation\">:</span> i64<span class=\"token punctuation\">,</span>\n        y<span class=\"token punctuation\">:</span> i64<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> p <span class=\"token operator\">=</span> Point <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">:</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token number\">25</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p address: {:p}\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movep address: {:p}\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p address: {:p}\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"------------------------------\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> p <span class=\"token operator\">=</span> Point <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">:</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token number\">25</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p address: {:p}\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">move</span> <span class=\"token closure-params\"><span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movep address: {:p}\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\" spellcheck=\"true\">//println!(\"p address: {:p}\", &amp;p);//error[E0382]: borrow of moved value: `p`</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong><em>Rust</em></strong></p>\n<p></p>\n<ul>\n<li>cfg  #[cfg()]</li>\n<li>cfg!  cfg!()</li>\n</ul>\n<p><code>#[cfg(xxx)]</code>  <code>#[cfg(not(xxx))]</code></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token comment\" spellcheck=\"true\">//  Linux </span>\n#<span class=\"token punctuation\">[</span><span class=\"token function\">cfg</span><span class=\"token punctuation\">(</span>target_os <span class=\"token operator\">=</span> <span class=\"token string\">\"linux\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">are_you_on_linux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You are running linux!\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// Linux</span>\n#<span class=\"token punctuation\">[</span><span class=\"token function\">cfg</span><span class=\"token punctuation\">(</span><span class=\"token function\">not</span><span class=\"token punctuation\">(</span>target_os <span class=\"token operator\">=</span> <span class=\"token string\">\"linux\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">are_you_on_linux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You are *not* running linux!\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">demo13</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">are_you_on_linux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><code>target_os</code><code>--cfg xxx</code></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[cfg(some_condition)]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">conditional_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"condition met!\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token attribute attr-name\">#[cfg(not(some_condition))]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">conditional_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"condition met not !\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">conditional_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">// rustc --cfg some_condition xxx.rs &amp;&amp; ./custom</span></code></pre>\n<p><strong><em>Rust(trait)</em></strong></p>\n<p>trait </p>\n<ul>\n<li> trait  impl  trait</li>\n<li> trait </li>\n</ul>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">trait</span> Converter<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> T<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> MyInt<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">impl</span> Converter<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span> <span class=\"token keyword\">for</span> MyInt <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> i32 <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">42</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> my_int <span class=\"token operator\">=</span> MyInt<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> output<span class=\"token punctuation\">:</span> i32 <span class=\"token operator\">=</span> my_int<span class=\"token punctuation\">.</span><span class=\"token function\">convert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"output is: {}\"</span><span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> output<span class=\"token punctuation\">:</span> f32 <span class=\"token operator\">=</span> my_int<span class=\"token punctuation\">.</span><span class=\"token function\">convert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">//MyIntConverter&lt;f32>trait</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"output is: {}\"</span><span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong><em>trait</em></strong></p>\n<p>  <code>Animal</code>  trait <code>Animal</code> </p>\n<p> <code>Box + dyn</code></p>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Sheep <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> Cow <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">trait</span> Animal <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">noise</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span>'<span class=\"token keyword\">static</span> str<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">impl</span> Animal <span class=\"token keyword\">for</span> Sheep <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">noise</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span>'<span class=\"token keyword\">static</span> str <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"baaaaah!\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">impl</span> Animal <span class=\"token keyword\">for</span> Cow <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">noise</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span>'<span class=\"token keyword\">static</span> str <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"moooooo!\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">random_animal</span><span class=\"token punctuation\">(</span>random_number<span class=\"token punctuation\">:</span> f64<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">impl</span> Animal <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> random_number <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.5</span> <span class=\"token punctuation\">{</span>\n        Sheep <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n        Cow <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">random_animal_2</span><span class=\"token punctuation\">(</span>random_number<span class=\"token punctuation\">:</span> f64<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Box<span class=\"token operator\">&lt;</span>dyn Animal<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> random_number <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.5</span> <span class=\"token punctuation\">{</span>\n        Box<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>Sheep <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        Box<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>Cow <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> main <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> random_number <span class=\"token operator\">=</span> <span class=\"token number\">0.234</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> animal <span class=\"token operator\">=</span> <span class=\"token function\">random_animal_2</span><span class=\"token punctuation\">(</span>random_number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You've randomly chosen an animal, and it says {}\"</span><span class=\"token punctuation\">,</span> animal<span class=\"token punctuation\">.</span><span class=\"token function\">noise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong><em>Option<T>  unwrap</T></em></strong></p>\n<ul>\n<li><code>Some(T)</code> :  <code>T</code> </li>\n<li><code>None</code> : </li>\n</ul>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">give_commoner</span><span class=\"token punctuation\">(</span>gift<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span>str<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">match</span> gift <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"snake\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Yuck! I'm throwing that snake in a fire.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>inner<span class=\"token punctuation\">)</span>   <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}? How nice.\"</span><span class=\"token punctuation\">,</span> inner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        None          <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No gift? Oh well.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">give_princess</span><span class=\"token punctuation\">(</span>gift<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span>str<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\" spellcheck=\"true\">// `unwrap`  `None`  `panic`</span>\n    <span class=\"token keyword\">let</span> inside <span class=\"token operator\">=</span> gift<span class=\"token punctuation\">.</span><span class=\"token function\">unwarp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> inside <span class=\"token operator\">==</span> <span class=\"token string\">\"snake\"</span> <span class=\"token punctuation\">{</span> \n        <span class=\"token function\">panic!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AAAaaaaa!!!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I love {}s!!!!!\"</span><span class=\"token punctuation\">,</span> inside<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> food  <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chicken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> snake <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"snake\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> void  <span class=\"token operator\">=</span> None<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">give_commoner</span><span class=\"token punctuation\">(</span>food<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">give_commoner</span><span class=\"token punctuation\">(</span>snake<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">give_commoner</span><span class=\"token punctuation\">(</span>void<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> bird <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"robin\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> nothing <span class=\"token operator\">=</span> None<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">give_princess</span><span class=\"token punctuation\">(</span>bird<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">give_princess</span><span class=\"token punctuation\">(</span>nothing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><code>?</code><code>Option</code></p>\n<ul>\n<li> <code>current_age</code>  <code>None</code> <code>None</code></li>\n<li> <code>current_age</code>  <code>Some</code> <code>u8</code>  <code>next_age</code></li>\n</ul>\n<pre class=\" language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">next_birthday</span><span class=\"token punctuation\">(</span>current_age<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>u8<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Option<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> next_age<span class=\"token punctuation\">:</span> u8 <span class=\"token operator\">=</span> current_age?<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token function\">format!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Next year I will be {}\"</span><span class=\"token punctuation\">,</span> next_age<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>#[derive(Debug)]</td>\n<td><code>Debug</code></td>\n</tr>\n<tr>\n<td>#![allow(dead_code)]</td>\n<td></td>\n</tr>\n<tr>\n<td>#![allow(overflowing_literals)]</td>\n<td></td>\n</tr>\n<tr>\n<td>1..10</td>\n<td>11010</td>\n</tr>\n<tr>\n<td>1..=10</td>\n<td>11010</td>\n</tr>\n<tr>\n<td>move</td>\n<td>move</td>\n</tr>\n<tr>\n<td>#[derive(RustcDecodable, RustcEncodable)]</td>\n<td></td>\n</tr>\n</tbody></table>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong><em></em></strong></p>\n<p>:?<code>fmt::Debug</code><code>trait</code><code>#[derive(Debug)]</code></p>\n<pre><code class=\"rust\">fn main(){\n    #[derive(Debug)]\n    struct UnPrintable(i32);\n    println!(&quot;{:?}&quot;, DebugPrintable(13));\n    #[derive(Debug)]\n    struct Person&lt;&#39;a&gt; {\n        name: &amp;&#39;a str,\n        age: u8\n    }\n    let name = &quot;Peter&quot;;\n    let age = 27;\n    let peter = Person { name, age };\n    // \n    println!(&quot;{:#?}&quot;, peter);\n}</code></pre>\n<p><strong><em></em></strong></p>\n<pre><code class=\"rust\">let immutable_binding = 1;  //\nlet _immutable_binding = 1; //_ </code></pre>\n<p><strong><em>Rustas</em></strong></p>\n<pre><code class=\"rust\">let decimal = 65.4321_f32;\n// \nlet integer: u8 = decimal;\n//  ^ \n// \nlet integer = decimal as u8;</code></pre>\n<p><strong><em></em></strong></p>\n<ul>\n<li>From  Into</li>\n<li>TryFrom  TryInto FromIntoResult</li>\n<li>ToString  FromStr string</li>\n</ul>\n<pre><code class=\"rust\">use std::convert::From;\n#[derive(Debug)]\nstruct Number {\n    value: i32,\n}\n// From&lt;i32&gt;i32into()Number\n// i32Number let num: Number = 5.into();\nimpl From&lt;i32&gt; for Number {\n    fn from(item: i32) -&gt; Self {\n        Number { value: item }\n    }\n}\nfn main(){\n    let int: i32 = 5;\n    let num: Number = int.into();\n    println!(&quot;My number is {:?}&quot;, num);\n}</code></pre>\n<pre><code class=\"rust\">use std::convert::TryFrom;\nuse std::convert::TryInto;\n#[derive(Debug, PartialEq)]\nstruct EvenNumber(i32);\nimpl TryFrom&lt;i32&gt; for EvenNumber {\n    type Error = ();\n    fn try_from(value: i32) -&gt; Result&lt;Self, Self::Error&gt; {\n        if value % 2 == 0 {\n            Ok(EvenNumber(value))\n        } else {\n            Err(())\n        }\n    }\n}\nfn main(){\n    let result: Result&lt;EvenNumber, ()&gt; = 8i32.try_into();\n    assert_eq!(result, Ok(EvenNumber(8)));\n    let result: Result&lt;EvenNumber, ()&gt; = 5i32.try_into();\n    assert_eq!(result, Err(()));\n}</code></pre>\n<p><strong><em>Rust</em></strong></p>\n<ul>\n<li>iter() ,  </li>\n<li>into_iter() ,   move</li>\n<li>iter_mut() , mutably</li>\n</ul>\n<p><strong><em>Rustmove</em></strong></p>\n<p>move<code></code>move</p>\n<pre><code class=\"rust\">fn main() {\n    struct Point {\n        x: i64,\n        y: i64,\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(&quot;p address: {:p}&quot;, &amp;p);\n        (|| {\n            println!(&quot;movep address: {:p}&quot;, &amp;p);\n        })();\n        println!(&quot;p address: {:p}&quot;, &amp;p);\n        println!(&quot;------------------------------&quot;);\n    }\n    if true {\n        let mut p = Point { x: 25, y: 25 };\n        println!(&quot;p address: {:p}&quot;, &amp;p);\n        (move || {\n            println!(&quot;movep address: {:p}&quot;, &amp;p);\n        })();\n        //println!(&quot;p address: {:p}&quot;, &amp;p);//error[E0382]: borrow of moved value: `p`\n    }\n}</code></pre>\n<p><strong><em>Rust</em></strong></p>\n<p></p>\n<ul>\n<li>cfg  #[cfg()]</li>\n<li>cfg!  cfg!()</li>\n</ul>\n<p><code>#[cfg(xxx)]</code>  <code>#[cfg(not(xxx))]</code></p>\n<pre><code class=\"rust\">//  Linux \n#[cfg(target_os = &quot;linux&quot;)]\nfn are_you_on_linux() {\n    println!(&quot;You are running linux!&quot;)\n}\n// Linux\n#[cfg(not(target_os = &quot;linux&quot;))]\nfn are_you_on_linux() {\n    println!(&quot;You are *not* running linux!&quot;)\n}\npub fn demo13(){\n    are_you_on_linux();\n}</code></pre>\n<p><code>target_os</code><code>--cfg xxx</code></p>\n<pre><code class=\"rust\">#[cfg(some_condition)]\nfn conditional_function() {\n    println!(&quot;condition met!&quot;)\n}\n#[cfg(not(some_condition))]\nfn conditional_function() {\n    println!(&quot;condition met not !&quot;)\n}\nfn main() {\n    conditional_function();\n}\n// rustc --cfg some_condition xxx.rs &amp;&amp; ./custom</code></pre>\n<p><strong><em>Rust(trait)</em></strong></p>\n<p>trait </p>\n<ul>\n<li> trait  impl  trait</li>\n<li> trait </li>\n</ul>\n<pre><code class=\"rust\">pub trait Converter&lt;T&gt; {\n    fn convert(&amp;self) -&gt; T;\n}\nstruct MyInt;\nimpl Converter&lt;i32&gt; for MyInt {\n    fn convert(&amp;self) -&gt; i32 {\n        42\n    }\n}\nfn main(){\n    let my_int = MyInt;\n    let output: i32 = my_int.convert();\n    println!(&quot;output is: {}&quot;, output);\n\n    let output: f32 = my_int.convert(); //MyIntConverter&lt;f32&gt;trait\n    println!(&quot;output is: {}&quot;, output);\n}</code></pre>\n<p><strong><em>trait</em></strong></p>\n<p>  <code>Animal</code>  trait <code>Animal</code> </p>\n<p> <code>Box + dyn</code></p>\n<pre><code class=\"rust\">struct Sheep {}\nstruct Cow {}\ntrait Animal {\n    fn noise(&amp;self) -&gt; &amp;&#39;static str;\n}\nimpl Animal for Sheep {\n    fn noise(&amp;self) -&gt; &amp;&#39;static str {\n            &quot;baaaaah!&quot;\n    }\n}\nimpl Animal for Cow {\n    fn noise(&amp;self) -&gt; &amp;&#39;static str {\n        &quot;moooooo!&quot;\n    }\n}\nfn random_animal(random_number: f64) -&gt; impl Animal {\n    if random_number &lt; 0.5 {\n        Sheep {}\n    }else{\n        Cow {}\n    }\n}\nfn random_animal_2(random_number: f64) -&gt; Box&lt;dyn Animal&gt; {\n    if random_number &lt; 0.5 {\n        Box::new(Sheep {})\n    }else {\n        Box::new(Cow {})\n    }\n}\nfn main {\n    let random_number = 0.234;\n    let animal = random_animal_2(random_number);\n    println!(&quot;You&#39;ve randomly chosen an animal, and it says {}&quot;, animal.noise());\n}</code></pre>\n<p><strong><em>Option<T>  unwrap</T></em></strong></p>\n<ul>\n<li><code>Some(T)</code> :  <code>T</code> </li>\n<li><code>None</code> : </li>\n</ul>\n<pre><code class=\"rust\">fn give_commoner(gift: Option&lt;&amp;str&gt;) {\n    match gift {\n        Some(&quot;snake&quot;) =&gt; println!(&quot;Yuck! I&#39;m throwing that snake in a fire.&quot;),\n        Some(inner)   =&gt; println!(&quot;{}? How nice.&quot;, inner),\n        None          =&gt; println!(&quot;No gift? Oh well.&quot;),\n    }\n}\nfn give_princess(gift: Option&lt;&amp;str&gt;) {\n    // `unwrap`  `None`  `panic`\n    let inside = gift.unwarp();\n    if inside == &quot;snake&quot; { \n        panic!(&quot;AAAaaaaa!!!!&quot;);\n    }\n    println!(&quot;I love {}s!!!!!&quot;, inside);\n}\nfn main(){\n    let food  = Some(&quot;chicken&quot;);\n    let snake = Some(&quot;snake&quot;);\n    let void  = None;\n    give_commoner(food);\n    give_commoner(snake);\n    give_commoner(void);\n\n    let bird = Some(&quot;robin&quot;);\n    let nothing = None;\n    give_princess(bird);\n    give_princess(nothing);\n}</code></pre>\n<p><code>?</code><code>Option</code></p>\n<ul>\n<li> <code>current_age</code>  <code>None</code> <code>None</code></li>\n<li> <code>current_age</code>  <code>Some</code> <code>u8</code>  <code>next_age</code></li>\n</ul>\n<pre><code class=\"rust\">fn next_birthday(current_age: Option&lt;u8&gt;) -&gt; Option&lt;String&gt; {\n    let next_age: u8 = current_age?;\n    Some(format!(&quot;Next year I will be {}&quot;, next_age))\n}</code></pre>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>#[derive(Debug)]</td>\n<td><code>Debug</code></td>\n</tr>\n<tr>\n<td>#![allow(dead_code)]</td>\n<td></td>\n</tr>\n<tr>\n<td>#![allow(overflowing_literals)]</td>\n<td></td>\n</tr>\n<tr>\n<td>1..10</td>\n<td>11010</td>\n</tr>\n<tr>\n<td>1..=10</td>\n<td>11010</td>\n</tr>\n<tr>\n<td>move</td>\n<td>move</td>\n</tr>\n<tr>\n<td>#[derive(RustcDecodable, RustcEncodable)]</td>\n<td></td>\n</tr>\n</tbody></table>\n"},{"title":"GoLang","description":null,"date":"2021-05-18T09:14:00.000Z","_content":"### \n\n-  mapslicechannel \n- \n- \n- \n-  intbool \n- \n-  Go \n\n### slice\n\n```go\ntype Slice struct {\n\tData unsafe.Pointer\t // \n\tLen  int\t\t\t // \n\tCap  int\t\t\t // \n}\n```\n\n![](go-study-01/1.png)\n\n```go\nfunc TestSlice(t *testing.T) {\n\ta := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n\ts1 := a[0:5]\n\tfmt.Printf(\"len = %d, cap = %d \\n\", len(s1) , cap(s1))\n    s2 := a[3:5]\n\tfmt.Printf(\"len = %d, cap = %d \\n\", len(s2) , cap(s2))\n    s1 = append(s1,16)\n\tfmt.Println(a)\n}\n//\n//len = 5, cap = 8 \n//len = 2, cap = 5 \n//[0 1 2 3 4 16 6 7]\n```\n\nlencap\n\n- s1`Data unsafe.Pointer`a0s1`Data unsafe.Pointer`a3\n- ``s10cap = 8 s2cap = 5\n- s1 = append(s1,16)aa616\n\ns1 = append(s1,16)s1\n\n![](go-study-01/2.png)\n\n```go\nfunc TestSlice(t *testing.T) {\n    a := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n\ts3 := a[6:]\n    s3 = append(s3,19)\n    fmt.println(a)\n}\n//   [0 1 2 3 4 5 6 7]\n```\n\ns3 = append(s3,19)s3=appends3\n\n### makenew\n\nnew  Golang \n\n```go\nfunc new(Type) *Type\n```\n\n : \n\n- \n- \n- \n\n```go\nfunc TestNew(t *testing.T) {\n\ta := new(int64)\n\tfmt.Printf(\"a: %T  a: %v a: %v \\n\", a, *a, a)\n    // a: *int64  a: 0 a: 0xc00000a300 \n}\n```\n\n![](go-study-01/3.png)\n\nnew\n\nmakeGolang**slice,map,channel**\n\n```go\nfunc make(t Type, size ...IntegerType) Type\n```\n\n\n\n### newmake\n\nmakenew\n\nintdata = nil , len = 0 , cap = 0.\n\n```go\nvar ints []int\t\t#\n```\n\nmake\n\n```go\nints := make([]int , 2 ,5)\nints = append(ints, 16)\n```\n\nmake****append\n\n![](go-study-01/4.png)\n\nnew\n\n```go\nints := new([]int)\n(*ints)[0] = 1\t\t// \n*ints = append(*ints , 1)\nfmt.Println(*ints)\n```\n\nnew0makeintsdata = nil , len = 0 , cap = 0 \n\n![](go-study-01/5.png)\n\nnew`(*ints)[0] = 1`dataappend`*ints = append(*ints , 1)`\n\n### slice\n\nappendslice slice\n\n```go\nfunc TestSlice(t *testing.T) {\n\tints := []int{1,2}\n\tfmt.Printf(\"ints len = %d , cap = %d \\n\" , len(ints) , cap(ints))\n\tints = append(ints,3,4,5)\n\tfmt.Printf(\"ints len = %d , cap = %d \\n\" , len(ints) , cap(ints))\n}\n//ints len = 2 , cap = 2 \n//ints len = 5 , cap = 6\n```\n\nsliceoldCapcapoldCap=2append()5cap = 5\n\n-  oldCap * 2 < cap 2newCap = cap\n- \n  - oldLen < 1024     newCap = cap\n  - oldLen >= 1024  1/4   newCap = oldCap * 1.25","source":"_posts/go-study-01.md","raw":"---\ntitle: GoLang\ntags:\n  - GoLang\ncategories: \n  - GoLang\ndescription : \ndate: 2021-05-18 17:14:00\n---\n### \n\n-  mapslicechannel \n- \n- \n- \n-  intbool \n- \n-  Go \n\n### slice\n\n```go\ntype Slice struct {\n\tData unsafe.Pointer\t // \n\tLen  int\t\t\t // \n\tCap  int\t\t\t // \n}\n```\n\n![](go-study-01/1.png)\n\n```go\nfunc TestSlice(t *testing.T) {\n\ta := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n\ts1 := a[0:5]\n\tfmt.Printf(\"len = %d, cap = %d \\n\", len(s1) , cap(s1))\n    s2 := a[3:5]\n\tfmt.Printf(\"len = %d, cap = %d \\n\", len(s2) , cap(s2))\n    s1 = append(s1,16)\n\tfmt.Println(a)\n}\n//\n//len = 5, cap = 8 \n//len = 2, cap = 5 \n//[0 1 2 3 4 16 6 7]\n```\n\nlencap\n\n- s1`Data unsafe.Pointer`a0s1`Data unsafe.Pointer`a3\n- ``s10cap = 8 s2cap = 5\n- s1 = append(s1,16)aa616\n\ns1 = append(s1,16)s1\n\n![](go-study-01/2.png)\n\n```go\nfunc TestSlice(t *testing.T) {\n    a := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n\ts3 := a[6:]\n    s3 = append(s3,19)\n    fmt.println(a)\n}\n//   [0 1 2 3 4 5 6 7]\n```\n\ns3 = append(s3,19)s3=appends3\n\n### makenew\n\nnew  Golang \n\n```go\nfunc new(Type) *Type\n```\n\n : \n\n- \n- \n- \n\n```go\nfunc TestNew(t *testing.T) {\n\ta := new(int64)\n\tfmt.Printf(\"a: %T  a: %v a: %v \\n\", a, *a, a)\n    // a: *int64  a: 0 a: 0xc00000a300 \n}\n```\n\n![](go-study-01/3.png)\n\nnew\n\nmakeGolang**slice,map,channel**\n\n```go\nfunc make(t Type, size ...IntegerType) Type\n```\n\n\n\n### newmake\n\nmakenew\n\nintdata = nil , len = 0 , cap = 0.\n\n```go\nvar ints []int\t\t#\n```\n\nmake\n\n```go\nints := make([]int , 2 ,5)\nints = append(ints, 16)\n```\n\nmake****append\n\n![](go-study-01/4.png)\n\nnew\n\n```go\nints := new([]int)\n(*ints)[0] = 1\t\t// \n*ints = append(*ints , 1)\nfmt.Println(*ints)\n```\n\nnew0makeintsdata = nil , len = 0 , cap = 0 \n\n![](go-study-01/5.png)\n\nnew`(*ints)[0] = 1`dataappend`*ints = append(*ints , 1)`\n\n### slice\n\nappendslice slice\n\n```go\nfunc TestSlice(t *testing.T) {\n\tints := []int{1,2}\n\tfmt.Printf(\"ints len = %d , cap = %d \\n\" , len(ints) , cap(ints))\n\tints = append(ints,3,4,5)\n\tfmt.Printf(\"ints len = %d , cap = %d \\n\" , len(ints) , cap(ints))\n}\n//ints len = 2 , cap = 2 \n//ints len = 5 , cap = 6\n```\n\nsliceoldCapcapoldCap=2append()5cap = 5\n\n-  oldCap * 2 < cap 2newCap = cap\n- \n  - oldLen < 1024     newCap = cap\n  - oldLen >= 1024  1/4   newCap = oldCap * 1.25","slug":"go-study-01","published":1,"updated":"2021-11-23T06:25:51.468Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4ix0006zsv22qoidjh9","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li> mapslicechannel </li>\n<li></li>\n<li></li>\n<li></li>\n<li> intbool </li>\n<li></li>\n<li> Go </li>\n</ul>\n<h3 id=\"slice\"><a href=\"#slice\" class=\"headerlink\" title=\"slice\"></a>slice</h3><pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> Slice <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Data unsafe<span class=\"token punctuation\">.</span>Pointer     <span class=\"token comment\" spellcheck=\"true\">// </span>\n    Len  <span class=\"token builtin\">int</span>             <span class=\"token comment\" spellcheck=\"true\">// </span>\n    Cap  <span class=\"token builtin\">int</span>             <span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><img src=\"/2021/05/18/go-study-01/1.png\" alt></p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestSlice</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    a <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">}</span>\n    s1 <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"len = %d, cap = %d \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    s2 <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"len = %d, cap = %d \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>s2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>s2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    s1 <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//len = 5, cap = 8 </span>\n<span class=\"token comment\" spellcheck=\"true\">//len = 2, cap = 5 </span>\n<span class=\"token comment\" spellcheck=\"true\">//[0 1 2 3 4 16 6 7]</span></code></pre>\n<p>lencap</p>\n<ul>\n<li>s1<code>Data unsafe.Pointer</code>a0s1<code>Data unsafe.Pointer</code>a3</li>\n<li><code></code>s10cap = 8 s2cap = 5</li>\n<li>s1 = append(s1,16)aa616</li>\n</ul>\n<p>s1 = append(s1,16)s1</p>\n<p><img src=\"/2021/05/18/go-study-01/2.png\" alt></p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestSlice</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    a <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">}</span>\n    s3 <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    s3 <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>s3<span class=\"token punctuation\">,</span><span class=\"token number\">19</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//   [0 1 2 3 4 5 6 7]</span></code></pre>\n<p>s3 = append(s3,19)s3=appends3</p>\n<h3 id=\"makenew\"><a href=\"#makenew\" class=\"headerlink\" title=\"makenew\"></a>makenew</h3><p>new  Golang </p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span>Type<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Type</code></pre>\n<p> : </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestNew</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    a <span class=\"token operator\">:=</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a: %T  a: %v a: %v \\n\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\" spellcheck=\"true\">// a: *int64  a: 0 a: 0xc00000a300 </span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><img src=\"/2021/05/18/go-study-01/3.png\" alt></p>\n<p>new</p>\n<p>makeGolang<strong>slice,map,channel</strong></p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span>t Type<span class=\"token punctuation\">,</span> size <span class=\"token operator\">...</span>IntegerType<span class=\"token punctuation\">)</span> Type</code></pre>\n<p></p>\n<h3 id=\"newmake\"><a href=\"#newmake\" class=\"headerlink\" title=\"newmake\"></a>newmake</h3><p>makenew</p>\n<p>intdata = nil , len = 0 , cap = 0.</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> ints <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span>        #</code></pre>\n<p>make</p>\n<pre class=\" language-go\"><code class=\"language-go\">ints <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\nints <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></code></pre>\n<p>make<strong></strong>append</p>\n<p><img src=\"/2021/05/18/go-study-01/4.png\" alt></p>\n<p>new</p>\n<pre class=\" language-go\"><code class=\"language-go\">ints <span class=\"token operator\">:=</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>        <span class=\"token comment\" spellcheck=\"true\">// </span>\n<span class=\"token operator\">*</span>ints <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ints <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ints<span class=\"token punctuation\">)</span></code></pre>\n<p>new0makeintsdata = nil , len = 0 , cap = 0 </p>\n<p><img src=\"/2021/05/18/go-study-01/5.png\" alt></p>\n<p>new<code>(*ints)[0] = 1</code>dataappend<code>*ints = append(*ints , 1)</code></p>\n<h3 id=\"slice\"><a href=\"#slice\" class=\"headerlink\" title=\"slice\"></a>slice</h3><p>appendslice slice</p>\n<pre class=\" language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">TestSlice</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ints <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">}</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ints len = %d , cap = %d \\n\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    ints <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ints len = %d , cap = %d \\n\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>ints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\" spellcheck=\"true\">//ints len = 2 , cap = 2 </span>\n<span class=\"token comment\" spellcheck=\"true\">//ints len = 5 , cap = 6</span></code></pre>\n<p>sliceoldCapcapoldCap=2append()5cap = 5</p>\n<ul>\n<li> oldCap * 2 &lt; cap 2newCap = cap</li>\n<li><ul>\n<li>oldLen &lt; 1024     newCap = cap</li>\n<li>oldLen &gt;= 1024  1/4   newCap = oldCap * 1.25</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li> mapslicechannel </li>\n<li></li>\n<li></li>\n<li></li>\n<li> intbool </li>\n<li></li>\n<li> Go </li>\n</ul>\n<h3 id=\"slice\"><a href=\"#slice\" class=\"headerlink\" title=\"slice\"></a>slice</h3><pre><code class=\"go\">type Slice struct {\n    Data unsafe.Pointer     // \n    Len  int             // \n    Cap  int             // \n}</code></pre>\n<p><img src=\"/2021/05/18/go-study-01/1.png\" alt></p>\n<pre><code class=\"go\">func TestSlice(t *testing.T) {\n    a := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n    s1 := a[0:5]\n    fmt.Printf(&quot;len = %d, cap = %d \\n&quot;, len(s1) , cap(s1))\n    s2 := a[3:5]\n    fmt.Printf(&quot;len = %d, cap = %d \\n&quot;, len(s2) , cap(s2))\n    s1 = append(s1,16)\n    fmt.Println(a)\n}\n//\n//len = 5, cap = 8 \n//len = 2, cap = 5 \n//[0 1 2 3 4 16 6 7]</code></pre>\n<p>lencap</p>\n<ul>\n<li>s1<code>Data unsafe.Pointer</code>a0s1<code>Data unsafe.Pointer</code>a3</li>\n<li><code></code>s10cap = 8 s2cap = 5</li>\n<li>s1 = append(s1,16)aa616</li>\n</ul>\n<p>s1 = append(s1,16)s1</p>\n<p><img src=\"/2021/05/18/go-study-01/2.png\" alt></p>\n<pre><code class=\"go\">func TestSlice(t *testing.T) {\n    a := [8]int{0, 1, 2, 3, 4, 5, 6, 7}\n    s3 := a[6:]\n    s3 = append(s3,19)\n    fmt.println(a)\n}\n//   [0 1 2 3 4 5 6 7]</code></pre>\n<p>s3 = append(s3,19)s3=appends3</p>\n<h3 id=\"makenew\"><a href=\"#makenew\" class=\"headerlink\" title=\"makenew\"></a>makenew</h3><p>new  Golang </p>\n<pre><code class=\"go\">func new(Type) *Type</code></pre>\n<p> : </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<pre><code class=\"go\">func TestNew(t *testing.T) {\n    a := new(int64)\n    fmt.Printf(&quot;a: %T  a: %v a: %v \\n&quot;, a, *a, a)\n    // a: *int64  a: 0 a: 0xc00000a300 \n}</code></pre>\n<p><img src=\"/2021/05/18/go-study-01/3.png\" alt></p>\n<p>new</p>\n<p>makeGolang<strong>slice,map,channel</strong></p>\n<pre><code class=\"go\">func make(t Type, size ...IntegerType) Type</code></pre>\n<p></p>\n<h3 id=\"newmake\"><a href=\"#newmake\" class=\"headerlink\" title=\"newmake\"></a>newmake</h3><p>makenew</p>\n<p>intdata = nil , len = 0 , cap = 0.</p>\n<pre><code class=\"go\">var ints []int        #</code></pre>\n<p>make</p>\n<pre><code class=\"go\">ints := make([]int , 2 ,5)\nints = append(ints, 16)</code></pre>\n<p>make<strong></strong>append</p>\n<p><img src=\"/2021/05/18/go-study-01/4.png\" alt></p>\n<p>new</p>\n<pre><code class=\"go\">ints := new([]int)\n(*ints)[0] = 1        // \n*ints = append(*ints , 1)\nfmt.Println(*ints)</code></pre>\n<p>new0makeintsdata = nil , len = 0 , cap = 0 </p>\n<p><img src=\"/2021/05/18/go-study-01/5.png\" alt></p>\n<p>new<code>(*ints)[0] = 1</code>dataappend<code>*ints = append(*ints , 1)</code></p>\n<h3 id=\"slice\"><a href=\"#slice\" class=\"headerlink\" title=\"slice\"></a>slice</h3><p>appendslice slice</p>\n<pre><code class=\"go\">func TestSlice(t *testing.T) {\n    ints := []int{1,2}\n    fmt.Printf(&quot;ints len = %d , cap = %d \\n&quot; , len(ints) , cap(ints))\n    ints = append(ints,3,4,5)\n    fmt.Printf(&quot;ints len = %d , cap = %d \\n&quot; , len(ints) , cap(ints))\n}\n//ints len = 2 , cap = 2 \n//ints len = 5 , cap = 6</code></pre>\n<p>sliceoldCapcapoldCap=2append()5cap = 5</p>\n<ul>\n<li> oldCap * 2 &lt; cap 2newCap = cap</li>\n<li><ul>\n<li>oldLen &lt; 1024     newCap = cap</li>\n<li>oldLen &gt;= 1024  1/4   newCap = oldCap * 1.25</li>\n</ul>\n</li>\n</ul>\n"},{"title":"Solidity","description":"Solidity","date":"2021-05-30T05:53:30.000Z","_content":"\n### \n\n**Solidity````**\n\n`_age``_name`\n\n`age` `name` `name1`\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    int public _age;\n    string public _name;\n    function Person(int age,string name) {\n          _age = age;\n          _name = name;\n    }\n    function f(string name) {\n          var name1 = name;\n    }\n}\n```\n\n**Solidity`memory``storage`**\n\n`storage` : \n\n`memory` : solidity\n\n : \n\n- storage\n- memory\n- memory\n- `memory`****\n- `storage`****\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = \"liyuechun\";\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string memory name)  {\n        var name1 = name;\n        bytes(name1)[0] = 'L';\n    }\n}\n```\n\n`_name`liyuechunf()f()`_name`memorynamenamememoryname`_name`name_name\n\n\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = \"liyuechun\";\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string storage name) internal {\n        var name1 = name;\n        bytes(name1)[0] = 'L';\n    }\n}\n```\n\nmodifyName`_name`storagestorage`_name`modifyName(`_name`)`_name`name,name1**publicstorageinternalprivate**\n\n**Solidty`payable`,`view`,`pure`**\n\n- `payable`payable`msg.value`\n- `view`constantstorage\n- `pure` storage\n\n**Solidityinternalprivateexternalpublic**\n\n`public``private`\n\n- `public`\n- `private`\n\n\n public  private Solidity internal  external\n\n- internal  private  \n- external public  - \n\n`internalprivateexternalpublic`4****\n","source":"_posts/solidity.md","raw":"---\ntitle: Solidity\ntags:\n  - \ncategories:  \ndescription : Solidity\ndate: 2021-05-30 13:53:30\n---\n\n### \n\n**Solidity````**\n\n`_age``_name`\n\n`age` `name` `name1`\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    int public _age;\n    string public _name;\n    function Person(int age,string name) {\n          _age = age;\n          _name = name;\n    }\n    function f(string name) {\n          var name1 = name;\n    }\n}\n```\n\n**Solidity`memory``storage`**\n\n`storage` : \n\n`memory` : solidity\n\n : \n\n- storage\n- memory\n- memory\n- `memory`****\n- `storage`****\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = \"liyuechun\";\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string memory name)  {\n        var name1 = name;\n        bytes(name1)[0] = 'L';\n    }\n}\n```\n\n`_name`liyuechunf()f()`_name`memorynamenamememoryname`_name`name_name\n\n\n\n```java\npragma solidity >=0.4.22 <0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = \"liyuechun\";\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string storage name) internal {\n        var name1 = name;\n        bytes(name1)[0] = 'L';\n    }\n}\n```\n\nmodifyName`_name`storagestorage`_name`modifyName(`_name`)`_name`name,name1**publicstorageinternalprivate**\n\n**Solidty`payable`,`view`,`pure`**\n\n- `payable`payable`msg.value`\n- `view`constantstorage\n- `pure` storage\n\n**Solidityinternalprivateexternalpublic**\n\n`public``private`\n\n- `public`\n- `private`\n\n\n public  private Solidity internal  external\n\n- internal  private  \n- external public  - \n\n`internalprivateexternalpublic`4****\n","slug":"solidity","published":1,"updated":"2021-09-19T13:14:47.967Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckwbpt4jg000nzsv29eapec7c","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>Solidity<code></code><code></code></strong></p>\n<p><code>_age</code><code>_name</code></p>\n<p><code>age</code> <code>name</code> <code>name1</code></p>\n<pre class=\" language-java\"><code class=\"language-java\">pragma solidity <span class=\"token operator\">>=</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">22</span> <span class=\"token operator\">&lt;</span><span class=\"token number\">0.6</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\ncontract Person <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> <span class=\"token keyword\">public</span> _age<span class=\"token punctuation\">;</span>\n    string <span class=\"token keyword\">public</span> _name<span class=\"token punctuation\">;</span>\n    function <span class=\"token function\">Person</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> age<span class=\"token punctuation\">,</span>string name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          _age <span class=\"token operator\">=</span> age<span class=\"token punctuation\">;</span>\n          _name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    function <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>string name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          var name1 <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>Solidity<code>memory</code><code>storage</code></strong></p>\n<p><code>storage</code> : </p>\n<p><code>memory</code> : solidity</p>\n<p> : </p>\n<ul>\n<li>storage</li>\n<li>memory</li>\n<li>memory</li>\n<li><code>memory</code><strong></strong></li>\n<li><code>storage</code><strong></strong></li>\n</ul>\n<pre class=\" language-java\"><code class=\"language-java\">pragma solidity <span class=\"token operator\">>=</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">22</span> <span class=\"token operator\">&lt;</span><span class=\"token number\">0.6</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\ncontract Person <span class=\"token punctuation\">{</span>\n    string <span class=\"token keyword\">public</span>  _name<span class=\"token punctuation\">;</span>\n    function <span class=\"token function\">Person</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        _name <span class=\"token operator\">=</span> <span class=\"token string\">\"liyuechun\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    function <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">modifyName</span><span class=\"token punctuation\">(</span>_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    function <span class=\"token function\">modifyName</span><span class=\"token punctuation\">(</span>string memory name<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n        var name1 <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">bytes</span><span class=\"token punctuation\">(</span>name1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'L'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><code>_name</code>liyuechunf()f()<code>_name</code>memorynamenamememoryname<code>_name</code>name_name</p>\n<pre class=\" language-java\"><code class=\"language-java\">pragma solidity <span class=\"token operator\">>=</span><span class=\"token number\">0.4</span><span class=\"token punctuation\">.</span><span class=\"token number\">22</span> <span class=\"token operator\">&lt;</span><span class=\"token number\">0.6</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\ncontract Person <span class=\"token punctuation\">{</span>\n    string <span class=\"token keyword\">public</span>  _name<span class=\"token punctuation\">;</span>\n    function <span class=\"token function\">Person</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        _name <span class=\"token operator\">=</span> <span class=\"token string\">\"liyuechun\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    function <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">modifyName</span><span class=\"token punctuation\">(</span>_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    function <span class=\"token function\">modifyName</span><span class=\"token punctuation\">(</span>string storage name<span class=\"token punctuation\">)</span> internal <span class=\"token punctuation\">{</span>\n        var name1 <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">bytes</span><span class=\"token punctuation\">(</span>name1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'L'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>modifyName<code>_name</code>storagestorage<code>_name</code>modifyName(<code>_name</code>)<code>_name</code>name,name1<strong>publicstorageinternalprivate</strong></p>\n<p><strong>Solidty<code>payable</code>,<code>view</code>,<code>pure</code></strong></p>\n<ul>\n<li><code>payable</code>payable<code>msg.value</code></li>\n<li><code>view</code>constantstorage</li>\n<li><code>pure</code> storage</li>\n</ul>\n<p><strong>Solidityinternalprivateexternalpublic</strong></p>\n<p><code>public</code><code>private</code></p>\n<ul>\n<li><code>public</code></li>\n<li><code>private</code></li>\n</ul>\n<p> public  private Solidity internal  external</p>\n<ul>\n<li>internal  private  </li>\n<li>external public  - </li>\n</ul>\n<p><code>internalprivateexternalpublic</code>4<strong></strong></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>Solidity<code></code><code></code></strong></p>\n<p><code>_age</code><code>_name</code></p>\n<p><code>age</code> <code>name</code> <code>name1</code></p>\n<pre><code class=\"java\">pragma solidity &gt;=0.4.22 &lt;0.6.0;\ncontract Person {\n    int public _age;\n    string public _name;\n    function Person(int age,string name) {\n          _age = age;\n          _name = name;\n    }\n    function f(string name) {\n          var name1 = name;\n    }\n}</code></pre>\n<p><strong>Solidity<code>memory</code><code>storage</code></strong></p>\n<p><code>storage</code> : </p>\n<p><code>memory</code> : solidity</p>\n<p> : </p>\n<ul>\n<li>storage</li>\n<li>memory</li>\n<li>memory</li>\n<li><code>memory</code><strong></strong></li>\n<li><code>storage</code><strong></strong></li>\n</ul>\n<pre><code class=\"java\">pragma solidity &gt;=0.4.22 &lt;0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = &quot;liyuechun&quot;;\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string memory name)  {\n        var name1 = name;\n        bytes(name1)[0] = &#39;L&#39;;\n    }\n}</code></pre>\n<p><code>_name</code>liyuechunf()f()<code>_name</code>memorynamenamememoryname<code>_name</code>name_name</p>\n<pre><code class=\"java\">pragma solidity &gt;=0.4.22 &lt;0.6.0;\ncontract Person {\n    string public  _name;\n    function Person() {\n        _name = &quot;liyuechun&quot;;\n    }\n    function f() {\n        modifyName(_name);\n    }\n    function modifyName(string storage name) internal {\n        var name1 = name;\n        bytes(name1)[0] = &#39;L&#39;;\n    }\n}</code></pre>\n<p>modifyName<code>_name</code>storagestorage<code>_name</code>modifyName(<code>_name</code>)<code>_name</code>name,name1<strong>publicstorageinternalprivate</strong></p>\n<p><strong>Solidty<code>payable</code>,<code>view</code>,<code>pure</code></strong></p>\n<ul>\n<li><code>payable</code>payable<code>msg.value</code></li>\n<li><code>view</code>constantstorage</li>\n<li><code>pure</code> storage</li>\n</ul>\n<p><strong>Solidityinternalprivateexternalpublic</strong></p>\n<p><code>public</code><code>private</code></p>\n<ul>\n<li><code>public</code></li>\n<li><code>private</code></li>\n</ul>\n<p> public  private Solidity internal  external</p>\n<ul>\n<li>internal  private  </li>\n<li>external public  - </li>\n</ul>\n<p><code>internalprivateexternalpublic</code>4<strong></strong></p>\n"}],"PostAsset":[{"_id":"source/_posts/db-w-r-dynamic/db1.png","slug":"db1.png","post":"ckcujgdbf0000e0xlg085gsal","modified":0,"renderable":0},{"_id":"source/_posts/db-w-r-dynamic/AbstractRoutingDataSource.png","slug":"AbstractRoutingDataSource.png","post":"ckcujgdbf0000e0xlg085gsal","modified":0,"renderable":0},{"_id":"source/_posts/io/3.png","slug":"3.png","post":"ckn9yvhuq000hqwv2d2ae5br4","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/2.png","slug":"2.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/8.png","slug":"8.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/redis-rdb-aop/2.png","slug":"2.png","post":"ckn9yvhvq0037qwv2e2q19khp","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/2.png","slug":"2.png","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/4.png","slug":"4.png","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/3.png","slug":"3.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/7.png","slug":"7.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/15.png","slug":"15.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/16.png","slug":"16.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/hashmap/3.png","slug":"3.png","post":"ckn9yvhur000kqwv2a85nbo4u","modified":0,"renderable":0},{"_id":"source/_posts/hashmap/1.png","slug":"1.png","post":"ckn9yvhur000kqwv2a85nbo4u","modified":0,"renderable":0},{"_id":"source/_posts/io/4.png","slug":"4.png","post":"ckn9yvhuq000hqwv2d2ae5br4","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/9.png","slug":"9.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/3.png","slug":"3.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/kafka-muticustomerthread/1.png","slug":"1.png","post":"ckn9yvhv70016qwv27dy1djjx","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-use/1.png","slug":"1.png","post":"ckn9yvhvb001oqwv22g36hv60","modified":0,"renderable":0},{"_id":"source/_posts/mysql-masterslave-solve/1.jpg","slug":"1.jpg","post":"ckn9yvhvh0029qwv21eef5q0l","modified":0,"renderable":0},{"_id":"source/_posts/springcloud-1/1.png","slug":"1.png","post":"ckn9yvhvx0041qwv28f7z74rb","modified":0,"renderable":0},{"_id":"source/_posts/futuretask/1.png","slug":"1.png","post":"ckn9yvhun000cqwv27tig1h1x","modified":0,"renderable":0},{"_id":"source/_posts/futuretask/2.png","slug":"2.png","post":"ckn9yvhun000cqwv27tig1h1x","modified":0,"renderable":0},{"_id":"source/_posts/limit-single/1.png","slug":"1.png","post":"ckn9yvhv9001eqwv28yb05t1b","modified":0,"renderable":0},{"_id":"source/_posts/limit-single/2.png","slug":"2.png","post":"ckn9yvhv9001eqwv28yb05t1b","modified":0,"renderable":0},{"_id":"source/_posts/mysql-log/1.png","slug":"1.png","post":"ckn9yvhvf0022qwv2gwed7t7d","modified":0,"renderable":0},{"_id":"source/_posts/mysql-log/2.png","slug":"2.png","post":"ckn9yvhvf0022qwv2gwed7t7d","modified":0,"renderable":0},{"_id":"source/_posts/mysql-mvcc/1.png","slug":"1.png","post":"ckn9yvhvi002dqwv2a6o1e3ab","modified":0,"renderable":0},{"_id":"source/_posts/mysql-mvcc/2.png","slug":"2.png","post":"ckn9yvhvi002dqwv2a6o1e3ab","modified":0,"renderable":0},{"_id":"source/_posts/redis-aop-limit-boot/1.png","slug":"1.png","post":"ckn9yvhvj002kqwv229tjfcf0","modified":0,"renderable":0},{"_id":"source/_posts/redis-aop-limit-boot/2.png","slug":"2.png","post":"ckn9yvhvj002kqwv229tjfcf0","modified":0,"renderable":0},{"_id":"source/_posts/redis-known/1.png","slug":"1.png","post":"ckn9yvhvp0033qwv2cm36d9tz","modified":0,"renderable":0},{"_id":"source/_posts/redis-known/2.png","slug":"2.png","post":"ckn9yvhvp0033qwv2cm36d9tz","modified":0,"renderable":0},{"_id":"source/_posts/redis-sentinel/1.png","slug":"1.png","post":"ckn9yvhvr003bqwv25nzk0l95","modified":0,"renderable":0},{"_id":"source/_posts/redis-sentinel/2.png","slug":"2.png","post":"ckn9yvhvr003bqwv25nzk0l95","modified":0,"renderable":0},{"_id":"source/_posts/shardingjdbc-reg/1.png","slug":"1.png","post":"ckn9yvhvs003eqwv2b9h426cc","modified":0,"renderable":0},{"_id":"source/_posts/shardingjdbc-reg/2.png","slug":"2.png","post":"ckn9yvhvs003eqwv2b9h426cc","modified":0,"renderable":0},{"_id":"source/_posts/shardingphere-problem/1.png","slug":"1.png","post":"ckn9yvhvw003tqwv2c41fb2zf","modified":0,"renderable":0},{"_id":"source/_posts/shardingphere-problem/2.png","slug":"2.png","post":"ckn9yvhvw003tqwv2c41fb2zf","modified":0,"renderable":0},{"_id":"source/_posts/springcloud-2/1.png","slug":"1.png","post":"ckn9yvhvz0046qwv22hrf25le","modified":0,"renderable":0},{"_id":"source/_posts/springcloud-2/Hystrix.png","slug":"Hystrix.png","post":"ckn9yvhvz0046qwv22hrf25le","modified":0,"renderable":0},{"_id":"source/_posts/volatile/1.png","slug":"1.png","post":"ckn9yvhw6004sqwv2c40o9wr5","modified":0,"renderable":0},{"_id":"source/_posts/volatile/2.png","slug":"2.png","post":"ckn9yvhw6004sqwv2c40o9wr5","modified":0,"renderable":0},{"_id":"source/_posts/kafka-messge-complete/1.png","slug":"1.png","post":"ckn9yvhv3000zqwv2940fawon","modified":0,"renderable":0},{"_id":"source/_posts/kafka-messge-complete/2.png","slug":"2.png","post":"ckn9yvhv3000zqwv2940fawon","modified":0,"renderable":0},{"_id":"source/_posts/kafka-messge-complete/3.png","slug":"3.png","post":"ckn9yvhv3000zqwv2940fawon","modified":0,"renderable":0},{"_id":"source/_posts/redis-master-slave/1.png","slug":"1.png","post":"ckn9yvhvn002zqwv28sr9g006","modified":0,"renderable":0},{"_id":"source/_posts/redis-master-slave/2.png","slug":"2.png","post":"ckn9yvhvn002zqwv28sr9g006","modified":0,"renderable":0},{"_id":"source/_posts/redis-master-slave/3.png","slug":"3.png","post":"ckn9yvhvn002zqwv28sr9g006","modified":0,"renderable":0},{"_id":"source/_posts/redis-rdb-aop/1.png","slug":"1.png","post":"ckn9yvhvq0037qwv2e2q19khp","modified":0,"renderable":0},{"_id":"source/_posts/redis-rdb-aop/3.png","slug":"3.png","post":"ckn9yvhvq0037qwv2e2q19khp","modified":0,"renderable":0},{"_id":"source/_posts/zookeeper-lock/1.png","slug":"1.png","post":"ckn9yvhw80050qwv22sdp6hlv","modified":0,"renderable":0},{"_id":"source/_posts/zookeeper-lock/2.png","slug":"2.png","post":"ckn9yvhw80050qwv22sdp6hlv","modified":0,"renderable":0},{"_id":"source/_posts/zookeeper-lock/3.png","slug":"3.png","post":"ckn9yvhw80050qwv22sdp6hlv","modified":0,"renderable":0},{"_id":"source/_posts/gc-log/1.jpg","slug":"1.jpg","post":"ckn9yvhug0007qwv26zbi3n30","modified":0,"renderable":0},{"_id":"source/_posts/gc-log/2.jpg","slug":"2.jpg","post":"ckn9yvhug0007qwv26zbi3n30","modified":0,"renderable":0},{"_id":"source/_posts/gc-log/3.png","slug":"3.png","post":"ckn9yvhug0007qwv26zbi3n30","modified":0,"renderable":0},{"_id":"source/_posts/gc-log/4.png","slug":"4.png","post":"ckn9yvhug0007qwv26zbi3n30","modified":0,"renderable":0},{"_id":"source/_posts/io/1.png","slug":"1.png","post":"ckn9yvhuq000hqwv2d2ae5br4","modified":0,"renderable":0},{"_id":"source/_posts/io/2.png","slug":"2.png","post":"ckn9yvhuq000hqwv2d2ae5br4","modified":0,"renderable":0},{"_id":"source/_posts/kafka-base/1.png","slug":"1.png","post":"ckn9yvhuv000rqwv23h4c5d88","modified":0,"renderable":0},{"_id":"source/_posts/kafka-base/2.png","slug":"2.png","post":"ckn9yvhuv000rqwv23h4c5d88","modified":0,"renderable":0},{"_id":"source/_posts/kafka-base/3.png","slug":"3.png","post":"ckn9yvhuv000rqwv23h4c5d88","modified":0,"renderable":0},{"_id":"source/_posts/kafka-base/4.png","slug":"4.png","post":"ckn9yvhuv000rqwv23h4c5d88","modified":0,"renderable":0},{"_id":"source/_posts/sharding-student/1.png","slug":"1.png","post":"ckn9yvhvt003iqwv21k7k2dns","modified":0,"renderable":0},{"_id":"source/_posts/sharding-student/2.png","slug":"2.png","post":"ckn9yvhvt003iqwv21k7k2dns","modified":0,"renderable":0},{"_id":"source/_posts/sharding-student/3.png","slug":"3.png","post":"ckn9yvhvt003iqwv21k7k2dns","modified":0,"renderable":0},{"_id":"source/_posts/sharding-student/4.png","slug":"4.png","post":"ckn9yvhvt003iqwv21k7k2dns","modified":0,"renderable":0},{"_id":"source/_posts/spring-extend/1.png","slug":"1.png","post":"ckn9yvhvu003mqwv26ydf4751","modified":0,"renderable":0},{"_id":"source/_posts/spring-extend/2.png","slug":"2.png","post":"ckn9yvhvu003mqwv26ydf4751","modified":0,"renderable":0},{"_id":"source/_posts/spring-extend/3.png","slug":"3.png","post":"ckn9yvhvu003mqwv26ydf4751","modified":0,"renderable":0},{"_id":"source/_posts/spring-extend/4.png","slug":"4.png","post":"ckn9yvhvu003mqwv26ydf4751","modified":0,"renderable":0},{"_id":"source/_posts/executorservice/1.jpg","slug":"1.jpg","post":"ckn9yvhu70002qwv28poxegic","modified":0,"renderable":0},{"_id":"source/_posts/executorservice/1.png","slug":"1.png","post":"ckn9yvhu70002qwv28poxegic","modified":0,"renderable":0},{"_id":"source/_posts/executorservice/2.png","slug":"2.png","post":"ckn9yvhu70002qwv28poxegic","modified":0,"renderable":0},{"_id":"source/_posts/executorservice/3.png","slug":"3.png","post":"ckn9yvhu70002qwv28poxegic","modified":0,"renderable":0},{"_id":"source/_posts/executorservice/4.png","slug":"4.png","post":"ckn9yvhu70002qwv28poxegic","modified":0,"renderable":0},{"_id":"source/_posts/hashmap/2.png","slug":"2.png","post":"ckn9yvhur000kqwv2a85nbo4u","modified":0,"renderable":0},{"_id":"source/_posts/hashmap/4.png","slug":"4.png","post":"ckn9yvhur000kqwv2a85nbo4u","modified":0,"renderable":0},{"_id":"source/_posts/hashmap/5.png","slug":"5.png","post":"ckn9yvhur000kqwv2a85nbo4u","modified":0,"renderable":0},{"_id":"source/_posts/java-aqs/1.jpg","slug":"1.jpg","post":"ckn9yvhut000pqwv2cy3f903v","modified":0,"renderable":0},{"_id":"source/_posts/java-aqs/1.png","slug":"1.png","post":"ckn9yvhut000pqwv2cy3f903v","modified":0,"renderable":0},{"_id":"source/_posts/java-aqs/2.jpg","slug":"2.jpg","post":"ckn9yvhut000pqwv2cy3f903v","modified":0,"renderable":0},{"_id":"source/_posts/java-aqs/2.png","slug":"2.png","post":"ckn9yvhut000pqwv2cy3f903v","modified":0,"renderable":0},{"_id":"source/_posts/java-aqs/3.jpg","slug":"3.jpg","post":"ckn9yvhut000pqwv2cy3f903v","modified":0,"renderable":0},{"_id":"source/_posts/redis-data-type/1.png","slug":"1.png","post":"ckn9yvhvl002vqwv232lkay5s","modified":0,"renderable":0},{"_id":"source/_posts/redis-data-type/2.png","slug":"2.png","post":"ckn9yvhvl002vqwv232lkay5s","modified":0,"renderable":0},{"_id":"source/_posts/redis-data-type/3.png","slug":"3.png","post":"ckn9yvhvl002vqwv232lkay5s","modified":0,"renderable":0},{"_id":"source/_posts/redis-data-type/4.png","slug":"4.png","post":"ckn9yvhvl002vqwv232lkay5s","modified":0,"renderable":0},{"_id":"source/_posts/redis-data-type/5.png","slug":"5.png","post":"ckn9yvhvl002vqwv232lkay5s","modified":0,"renderable":0},{"_id":"source/_posts/sring-class/1.jpg","slug":"1.jpg","post":"ckn9yvhw5004nqwv2d3r39hb6","modified":0,"renderable":0},{"_id":"source/_posts/sring-class/1.png","slug":"1.png","post":"ckn9yvhw5004nqwv2d3r39hb6","modified":0,"renderable":0},{"_id":"source/_posts/sring-class/2.jpg","slug":"2.jpg","post":"ckn9yvhw5004nqwv2d3r39hb6","modified":0,"renderable":0},{"_id":"source/_posts/sring-class/3.png","slug":"3.png","post":"ckn9yvhw5004nqwv2d3r39hb6","modified":0,"renderable":0},{"_id":"source/_posts/sring-class/4.png","slug":"4.png","post":"ckn9yvhw5004nqwv2d3r39hb6","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/1.png","slug":"1.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/3.png","slug":"3.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/4.png","slug":"4.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/5.png","slug":"5.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/jvm-optimization/6.png","slug":"6.png","post":"ckn9yvhuy000vqwv29m0m7m80","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/1.png","slug":"1.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/2.png","slug":"2.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/3.png","slug":"3.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/4.png","slug":"4.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/5.png","slug":"5.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-netstat/6.png","slug":"6.png","post":"ckn9yvhv9001iqwv27jp34xc9","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/1.png","slug":"1.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/2.png","slug":"2.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/3.png","slug":"3.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/4.png","slug":"4.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/5.png","slug":"5.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/linux-top/6.png","slug":"6.png","post":"ckn9yvhva001mqwv2hanmfrzj","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/1.jpg","slug":"1.jpg","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/1.png","slug":"1.png","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/3.png","slug":"3.png","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/spring-forbean/5.png","slug":"5.png","post":"ckn9yvhvv003qqwv2c6353vtk","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/1.jpg","slug":"1.jpg","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/2.png","slug":"2.png","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/3.png","slug":"3.png","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/4.png","slug":"4.png","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/5.png","slug":"5.png","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/synchronized-up/6.png","slug":"6.png","post":"ckn9yvhw2004gqwv2f31ef3cp","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/1.png","slug":"1.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/2.png","slug":"2.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/4.png","slug":"4.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/5.png","slug":"5.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/threadlocal/6.png","slug":"6.png","post":"ckn9yvhw3004kqwv2gassfatz","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/1.png","slug":"1.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/2.png","slug":"2.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/4.png","slug":"4.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/5.png","slug":"5.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springboot-custom-start/6.png","slug":"6.png","post":"ckn9yvhvx003yqwv2626945nt","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/10.png","slug":"10.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/11.png","slug":"11.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/12.png","slug":"12.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/13.png","slug":"13.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/springmvc2/14.png","slug":"14.png","post":"ckn9yvhw00049qwv23866gmu1","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/0.png","slug":"0.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/1.png","slug":"1.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/2.png","slug":"2.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/3.png","slug":"3.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/4.png","slug":"4.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/5.png","slug":"5.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/6.png","slug":"6.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/blockingqueue/7.png","slug":"7.png","post":"ckn9yvhu00000qwv2glga3xcy","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/1.png","slug":"1.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/2.png","slug":"2.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/3.png","slug":"3.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/4.png","slug":"4.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/5.png","slug":"5.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/6.png","slug":"6.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/7.png","slug":"7.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-lock/8.png","slug":"8.png","post":"ckn9yvhvc001vqwv2huefgvah","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/1.png","slug":"1.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/2.png","slug":"2.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/3.png","slug":"3.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/4.png","slug":"4.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/5.png","slug":"5.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/6.png","slug":"6.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index/7.png","slug":"7.png","post":"ckn9yvhvg0026qwv29cdy8q8h","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/1.png","slug":"1.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/2.png","slug":"2.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/3.png","slug":"3.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/4.png","slug":"4.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/5.png","slug":"5.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/6.png","slug":"6.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/7.png","slug":"7.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/8.png","slug":"8.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build-2/9.png","slug":"9.png","post":"ckn9yvhvk002oqwv2f6a705s4","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/1.png","slug":"1.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/10.png","slug":"10.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/2.png","slug":"2.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/3.png","slug":"3.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/4.png","slug":"4.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/5.png","slug":"5.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/6.png","slug":"6.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/7.png","slug":"7.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/8.png","slug":"8.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/mysql-index-single/9.png","slug":"9.png","post":"ckn9yvhvd001zqwv29xvu66f7","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/1.png","slug":"1.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/10.png","slug":"10.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/2.png","slug":"2.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/3.png","slug":"3.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/4.png","slug":"4.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/5.png","slug":"5.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/6.png","slug":"6.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/7.png","slug":"7.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/8.png","slug":"8.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/redis-cluster-build/9.png","slug":"9.png","post":"ckn9yvhvi002gqwv259jp3j0j","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/1.png","slug":"1.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/10.png","slug":"10.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/2.png","slug":"2.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/3.png","slug":"3.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/4.png","slug":"4.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/5.png","slug":"5.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/6.png","slug":"6.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/7.png","slug":"7.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/springmvc/8.png","slug":"8.png","post":"ckn9yvhw1004eqwv24fnn05x6","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/1.jpg","slug":"1.jpg","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/1.png","slug":"1.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/10.png","slug":"10.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/11.png","slug":"11.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/12.png","slug":"12.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/13.png","slug":"13.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/14.png","slug":"14.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/2.png","slug":"2.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/3.png","slug":"3.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/4.png","slug":"4.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/5.png","slug":"5.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/6.png","slug":"6.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/7.png","slug":"7.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/8.png","slug":"8.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/mysql-explain/9.png","slug":"9.png","post":"ckn9yvhvb001sqwv2fa488nq5","modified":0,"renderable":0},{"_id":"source/_posts/go-pointer/1.png","slug":"1.png","post":"ckwbpt4if0000zsv295atdo8q","modified":0,"renderable":0},{"_id":"source/_posts/go-pointer/2.png","slug":"2.png","post":"ckwbpt4if0000zsv295atdo8q","modified":0,"renderable":0},{"_id":"source/_posts/go-pointer/3.png","slug":"3.png","post":"ckwbpt4if0000zsv295atdo8q","modified":0,"renderable":0},{"_id":"source/_posts/go-study-01/1.png","slug":"1.png","post":"ckwbpt4ix0006zsv22qoidjh9","modified":0,"renderable":0},{"_id":"source/_posts/go-study-01/2.png","slug":"2.png","post":"ckwbpt4ix0006zsv22qoidjh9","modified":0,"renderable":0},{"_id":"source/_posts/go-study-01/3.png","slug":"3.png","post":"ckwbpt4ix0006zsv22qoidjh9","modified":0,"renderable":0},{"_id":"source/_posts/go-study-01/4.png","slug":"4.png","post":"ckwbpt4ix0006zsv22qoidjh9","modified":0,"renderable":0},{"_id":"source/_posts/go-study-01/5.png","slug":"5.png","post":"ckwbpt4ix0006zsv22qoidjh9","modified":0,"renderable":0}],"PostCategory":[{"post_id":"ckn9yvhue0006qwv2fdat28gv","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhuo000dqwv2d41o3gvz"},{"post_id":"ckn9yvhu00000qwv2glga3xcy","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhuq000iqwv25vxl6rua"},{"post_id":"ckn9yvhug0007qwv26zbi3n30","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhus000lqwv2852ec1gm"},{"post_id":"ckn9yvhul000bqwv28px8gnnq","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhuu000qqwv28lp35s0c"},{"post_id":"ckn9yvhu70002qwv28poxegic","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhuw000sqwv20r660dku"},{"post_id":"ckn9yvhun000cqwv27tig1h1x","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhv1000wqwv20r1vblv5"},{"post_id":"ckn9yvhuc0005qwv2cft38t6r","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhv30010qwv29khz93mj"},{"post_id":"ckn9yvhur000kqwv2a85nbo4u","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhv50014qwv2dlj5cfyw"},{"post_id":"ckn9yvhut000pqwv2cy3f903v","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhv70018qwv2b2vy22vy"},{"post_id":"ckn9yvhuq000hqwv2d2ae5br4","category_id":"ckn9yvhut000nqwv2491z2enk","_id":"ckn9yvhv8001cqwv29ydyfb4b"},{"post_id":"ckn9yvhuy000vqwv29m0m7m80","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhv9001fqwv27p8a2c2v"},{"post_id":"ckn9yvhv50013qwv20sa97ixg","category_id":"ckn9yvhv2000xqwv27se1ajnh","_id":"ckn9yvhva001jqwv27vjn8gnx"},{"post_id":"ckn9yvhuv000rqwv23h4c5d88","category_id":"ckn9yvhv2000xqwv27se1ajnh","_id":"ckn9yvhva001nqwv2567j1m0w"},{"post_id":"ckn9yvhv70016qwv27dy1djjx","category_id":"ckn9yvhv2000xqwv27se1ajnh","_id":"ckn9yvhvb001pqwv22oo19zbp"},{"post_id":"ckn9yvhv3000zqwv2940fawon","category_id":"ckn9yvhv2000xqwv27se1ajnh","_id":"ckn9yvhvc001tqwv22fu10cgf"},{"post_id":"ckn9yvhv9001eqwv28yb05t1b","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhvd001wqwv26t9lad7p"},{"post_id":"ckn9yvhv9001iqwv27jp34xc9","category_id":"ckn9yvhut000nqwv2491z2enk","_id":"ckn9yvhvf0020qwv2hotq89ve"},{"post_id":"ckn9yvhva001mqwv2hanmfrzj","category_id":"ckn9yvhut000nqwv2491z2enk","_id":"ckn9yvhvg0023qwv2bpmx5gef"},{"post_id":"ckn9yvhv8001bqwv2a2f8989q","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvh0027qwv21t0aetcp"},{"post_id":"ckn9yvhvb001oqwv22g36hv60","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvh002aqwv24phagziz"},{"post_id":"ckn9yvhvb001sqwv2fa488nq5","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvi002eqwv23k3i6zf1"},{"post_id":"ckn9yvhvc001vqwv2huefgvah","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvj002hqwv2b25nda1t"},{"post_id":"ckn9yvhvd001zqwv29xvu66f7","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvk002lqwv2hf5n1f9c"},{"post_id":"ckn9yvhvf0022qwv2gwed7t7d","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvl002pqwv267pge075"},{"post_id":"ckn9yvhvg0026qwv29cdy8q8h","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvl002tqwv22g8v2l0m"},{"post_id":"ckn9yvhvh0029qwv21eef5q0l","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvm002xqwv2ersq6yxp"},{"post_id":"ckn9yvhvi002dqwv2a6o1e3ab","category_id":"ckn9yvhv9001gqwv240uigsrm","_id":"ckn9yvhvo0030qwv2f1vr8dcd"},{"post_id":"ckn9yvhvl002sqwv2gc3fal4k","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvp0035qwv2gw8r941d"},{"post_id":"ckn9yvhvi002gqwv259jp3j0j","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvr0038qwv23p4hb4qg"},{"post_id":"ckn9yvhvl002vqwv232lkay5s","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvs003cqwv296l1b201"},{"post_id":"ckn9yvhvn002zqwv28sr9g006","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvs003fqwv284kr53hk"},{"post_id":"ckn9yvhvj002kqwv229tjfcf0","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvu003jqwv26lbbgybv"},{"post_id":"ckn9yvhvp0033qwv2cm36d9tz","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvu003nqwv2b2dx8u3d"},{"post_id":"ckn9yvhvq0037qwv2e2q19khp","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvv003rqwv2eutv8xat"},{"post_id":"ckn9yvhvk002oqwv2f6a705s4","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvw003vqwv23fzlbtns"},{"post_id":"ckn9yvhvr003bqwv25nzk0l95","category_id":"ckn9yvhvk002mqwv253w783ef","_id":"ckn9yvhvx003zqwv270zpdxwo"},{"post_id":"ckn9yvhvs003eqwv2b9h426cc","category_id":"ckn9yvhvu003kqwv274ho83o7","_id":"ckn9yvhvy0043qwv23t30guw6"},{"post_id":"ckn9yvhvw003tqwv2c41fb2zf","category_id":"ckn9yvhvu003kqwv274ho83o7","_id":"ckn9yvhvz0047qwv2egaa268q"},{"post_id":"ckn9yvhvt003iqwv21k7k2dns","category_id":"ckn9yvhvu003kqwv274ho83o7","_id":"ckn9yvhw0004aqwv2fcpv5p8e"},{"post_id":"ckn9yvhvu003mqwv26ydf4751","category_id":"ckn9yvhvy0042qwv2drgndm5p","_id":"ckn9yvhw3004iqwv251f8e8o5"},{"post_id":"ckn9yvhw00049qwv23866gmu1","category_id":"ckn9yvhvy0042qwv2drgndm5p","_id":"ckn9yvhw5004lqwv2g474g9dp"},{"post_id":"ckn9yvhw1004eqwv24fnn05x6","category_id":"ckn9yvhvy0042qwv2drgndm5p","_id":"ckn9yvhw6004pqwv2h38jcmaq"},{"post_id":"ckn9yvhvv003qqwv2c6353vtk","category_id":"ckn9yvhvy0042qwv2drgndm5p","_id":"ckn9yvhw7004tqwv22ewag22t"},{"post_id":"ckn9yvhw2004gqwv2f31ef3cp","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhw8004wqwv2h59v2zni"},{"post_id":"ckn9yvhw3004kqwv2gassfatz","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhw90051qwv2gshn2ewy"},{"post_id":"ckn9yvhvx003yqwv2626945nt","category_id":"ckn9yvhvy0042qwv2drgndm5p","_id":"ckn9yvhw90053qwv25lzh741d"},{"post_id":"ckn9yvhw5004nqwv2d3r39hb6","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhwa0057qwv2ggutfzfz"},{"post_id":"ckn9yvhw6004sqwv2c40o9wr5","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhwa0059qwv2fjikhfmi"},{"post_id":"ckn9yvhvx0041qwv28f7z74rb","category_id":"ckn9yvhw6004oqwv2bebqbtxq","_id":"ckn9yvhwa005cqwv23cjygea9"},{"post_id":"ckn9yvhw7004vqwv2doo29zz0","category_id":"ckn9yvhua0003qwv20e2fceb2","_id":"ckn9yvhwa005eqwv20ia6fjt9"},{"post_id":"ckn9yvhvz0046qwv22hrf25le","category_id":"ckn9yvhw6004oqwv2bebqbtxq","_id":"ckn9yvhwb005hqwv25a3q4s3e"},{"post_id":"ckn9yvhw80050qwv22sdp6hlv","category_id":"ckn9yvhw90055qwv2dcjqfso9","_id":"ckn9yvhwb005jqwv23r1r0a6q"},{"post_id":"ckcujgdbf0000e0xlg085gsal","category_id":"ckn9yvhwi005uqwv2eypzfb12","_id":"ckn9yvhx4005vqwv2ch9o9ai9"},{"post_id":"ckpxmxgrw0000h8v2egzj7693","category_id":"ckpxmxgsc0002h8v23tnn8wbb","_id":"ckpxmxgsj0008h8v2hs5414u5"},{"post_id":"ckpxmxgs00001h8v2bwk7a7ve","category_id":"ckpxmxgsi0005h8v2bbvg6twm","_id":"ckpxmxgsk000ch8v26d9k58b6"},{"post_id":"ckpxmxgsh0004h8v2a6axbhhq","category_id":"ckpxmxgsk0009h8v28hs7gosd","_id":"ckpxmxgsk000eh8v2g9szcnre"},{"post_id":"ckwbpt4if0000zsv295atdo8q","category_id":"ckwbpt4ir0002zsv2f53i8sju","_id":"ckwbpt4j0000bzsv2hk6kd5mk"},{"post_id":"ckwbpt4ix0006zsv22qoidjh9","category_id":"ckwbpt4ir0002zsv2f53i8sju","_id":"ckwbpt4j2000ezsv2hy5x5xcj"},{"post_id":"ckwbpt4ij0001zsv21ijs980z","category_id":"ckwbpt4iy0007zsv2cwyr7zd6","_id":"ckwbpt4j3000hzsv2g1md8s3s"},{"post_id":"ckwbpt4iw0004zsv28b8xhers","category_id":"ckwbpt4iy0007zsv2cwyr7zd6","_id":"ckwbpt4j3000kzsv2bsug1lle"},{"post_id":"ckwbpt4ix0005zsv2e2f62itu","category_id":"ckwbpt4j2000gzsv2ax606pdu","_id":"ckwbpt4j3000mzsv2crh347k8"},{"post_id":"ckwbpt4jg000nzsv29eapec7c","category_id":"ckpxmxgsc0002h8v23tnn8wbb","_id":"ckwbpt4jk000pzsv2dlp7f8vk"}],"PostTag":[{"post_id":"ckcujgdbf0000e0xlg085gsal","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckcujgdbr0006e0xle9gc6mot"},{"post_id":"ckcujgdbf0000e0xlg085gsal","tag_id":"ckcujgdbq0004e0xlacni3caf","_id":"ckcujgdbs0007e0xla7jiczah"},{"post_id":"ckn9yvhu00000qwv2glga3xcy","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhul000aqwv221j27jro"},{"post_id":"ckn9yvhul000bqwv28px8gnnq","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhuq000gqwv26q1ug9dy"},{"post_id":"ckn9yvhu70002qwv28poxegic","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhur000jqwv2cw1y8acv"},{"post_id":"ckn9yvhun000cqwv27tig1h1x","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhut000oqwv2ed2dhfev"},{"post_id":"ckn9yvhut000pqwv2cy3f903v","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhuy000uqwv25khpgogv"},{"post_id":"ckn9yvhuc0005qwv2cft38t6r","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhv2000yqwv2cl5re8f5"},{"post_id":"ckn9yvhuc0005qwv2cft38t6r","tag_id":"ckn9yvhus000mqwv2gilvakeq","_id":"ckn9yvhv50012qwv25zl00ww9"},{"post_id":"ckn9yvhuy000vqwv29m0m7m80","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhv70015qwv2e50lbnb9"},{"post_id":"ckn9yvhue0006qwv2fdat28gv","tag_id":"ckn9yvhuw000tqwv24apr9pmb","_id":"ckn9yvhv80019qwv2eg8yao0x"},{"post_id":"ckn9yvhug0007qwv26zbi3n30","tag_id":"ckn9yvhv40011qwv21uhu3tid","_id":"ckn9yvhv9001dqwv295ah1ys3"},{"post_id":"ckn9yvhv8001bqwv2a2f8989q","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhv9001hqwv25uhyfhoj"},{"post_id":"ckn9yvhuq000hqwv2d2ae5br4","tag_id":"ckn9yvhv8001aqwv204102gyl","_id":"ckn9yvhva001lqwv2476j9rzr"},{"post_id":"ckn9yvhva001mqwv2hanmfrzj","tag_id":"ckn9yvhv8001aqwv204102gyl","_id":"ckn9yvhvb001rqwv251zh3wfk"},{"post_id":"ckn9yvhur000kqwv2a85nbo4u","tag_id":"ckn9yvhva001kqwv20b6a6xcz","_id":"ckn9yvhvc001uqwv26a1e58ua"},{"post_id":"ckn9yvhvb001oqwv22g36hv60","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvd001yqwv2h23j0bl0"},{"post_id":"ckn9yvhvb001sqwv2fa488nq5","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvf0021qwv25zw5hbqe"},{"post_id":"ckn9yvhuv000rqwv23h4c5d88","tag_id":"ckn9yvhvb001qqwv2cl3n1d7f","_id":"ckn9yvhvg0025qwv2csk38ba7"},{"post_id":"ckn9yvhvc001vqwv2huefgvah","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvh0028qwv2d5g28q5u"},{"post_id":"ckn9yvhvd001zqwv29xvu66f7","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvi002cqwv27rxmctaf"},{"post_id":"ckn9yvhv3000zqwv2940fawon","tag_id":"ckn9yvhvb001qqwv2cl3n1d7f","_id":"ckn9yvhvi002fqwv2e4nn4w94"},{"post_id":"ckn9yvhvf0022qwv2gwed7t7d","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvj002jqwv20me2hv0q"},{"post_id":"ckn9yvhvg0026qwv29cdy8q8h","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvk002nqwv258g6be1d"},{"post_id":"ckn9yvhv50013qwv20sa97ixg","tag_id":"ckn9yvhvb001qqwv2cl3n1d7f","_id":"ckn9yvhvl002qqwv23ene0w3l"},{"post_id":"ckn9yvhvh0029qwv21eef5q0l","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvl002uqwv2fp0e6esz"},{"post_id":"ckn9yvhvi002dqwv2a6o1e3ab","tag_id":"ckcujgdbn0002e0xlhojchej4","_id":"ckn9yvhvm002yqwv240hm1g1i"},{"post_id":"ckn9yvhv70016qwv27dy1djjx","tag_id":"ckn9yvhvb001qqwv2cl3n1d7f","_id":"ckn9yvhvp0032qwv27wrv63u5"},{"post_id":"ckn9yvhv9001eqwv28yb05t1b","tag_id":"ckn9yvhvj002iqwv28yks0ikq","_id":"ckn9yvhvq0036qwv2dstd11mi"},{"post_id":"ckn9yvhv9001iqwv27jp34xc9","tag_id":"ckn9yvhv8001aqwv204102gyl","_id":"ckn9yvhvr003aqwv2g3m65kev"},{"post_id":"ckn9yvhv9001iqwv27jp34xc9","tag_id":"ckn9yvhvl002rqwv2419y600x","_id":"ckn9yvhvs003dqwv29uhwcnqz"},{"post_id":"ckn9yvhvp0033qwv2cm36d9tz","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvt003hqwv23ekh07y6"},{"post_id":"ckn9yvhvi002gqwv259jp3j0j","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvu003lqwv2aqq6ecky"},{"post_id":"ckn9yvhvq0037qwv2e2q19khp","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvv003pqwv287x83r2c"},{"post_id":"ckn9yvhvr003bqwv25nzk0l95","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvv003sqwv20nyfg0rf"},{"post_id":"ckn9yvhvj002kqwv229tjfcf0","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvx003xqwv26hr391mz"},{"post_id":"ckn9yvhvj002kqwv229tjfcf0","tag_id":"ckn9yvhvj002iqwv28yks0ikq","_id":"ckn9yvhvx0040qwv2cjii38p1"},{"post_id":"ckn9yvhvk002oqwv2f6a705s4","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhvz0045qwv2cgp5bgu6"},{"post_id":"ckn9yvhvl002sqwv2gc3fal4k","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhw00048qwv2cs8cbuqe"},{"post_id":"ckn9yvhvl002vqwv232lkay5s","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhw1004dqwv2c9bd1tex"},{"post_id":"ckn9yvhvn002zqwv28sr9g006","tag_id":"ckn9yvhvo0031qwv2g28jadm3","_id":"ckn9yvhw2004fqwv2czzqhubu"},{"post_id":"ckn9yvhvs003eqwv2b9h426cc","tag_id":"ckn9yvhw1004cqwv22ro212lh","_id":"ckn9yvhw5004mqwv2ffi748nv"},{"post_id":"ckn9yvhw2004gqwv2f31ef3cp","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhw6004qqwv2hka627zn"},{"post_id":"ckn9yvhw3004kqwv2gassfatz","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhw7004uqwv2am9m0hzk"},{"post_id":"ckn9yvhvt003iqwv21k7k2dns","tag_id":"ckn9yvhw1004cqwv22ro212lh","_id":"ckn9yvhw8004xqwv26zce39nn"},{"post_id":"ckn9yvhw5004nqwv2d3r39hb6","tag_id":"ckn9yvhv40011qwv21uhu3tid","_id":"ckn9yvhw90052qwv2bxm18r7h"},{"post_id":"ckn9yvhw6004sqwv2c40o9wr5","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhw90054qwv2d2zj2bdk"},{"post_id":"ckn9yvhvu003mqwv26ydf4751","tag_id":"ckn9yvhw6004rqwv2dnchg5ey","_id":"ckn9yvhwa0058qwv24al3e555"},{"post_id":"ckn9yvhw7004vqwv2doo29zz0","tag_id":"ckn9yvhuc0004qwv27rup1c75","_id":"ckn9yvhwa005aqwv25p7u6tax"},{"post_id":"ckn9yvhvv003qqwv2c6353vtk","tag_id":"ckn9yvhw6004rqwv2dnchg5ey","_id":"ckn9yvhwa005dqwv27rgvbh3t"},{"post_id":"ckn9yvhvw003tqwv2c41fb2zf","tag_id":"ckn9yvhw1004cqwv22ro212lh","_id":"ckn9yvhwb005fqwv2gf8kcmrv"},{"post_id":"ckn9yvhvx003yqwv2626945nt","tag_id":"ckn9yvhw6004rqwv2dnchg5ey","_id":"ckn9yvhwb005iqwv2blxofsur"},{"post_id":"ckn9yvhvx0041qwv28f7z74rb","tag_id":"ckn9yvhwb005gqwv285ev22dq","_id":"ckn9yvhwb005lqwv260k5cqkh"},{"post_id":"ckn9yvhvz0046qwv22hrf25le","tag_id":"ckn9yvhwb005gqwv285ev22dq","_id":"ckn9yvhwc005nqwv2ea8mfgjy"},{"post_id":"ckn9yvhw00049qwv23866gmu1","tag_id":"ckn9yvhw6004rqwv2dnchg5ey","_id":"ckn9yvhwc005pqwv24t4p5ukq"},{"post_id":"ckn9yvhw1004eqwv24fnn05x6","tag_id":"ckn9yvhw6004rqwv2dnchg5ey","_id":"ckn9yvhwc005rqwv22zbc969k"},{"post_id":"ckn9yvhw80050qwv22sdp6hlv","tag_id":"ckn9yvhwc005qqwv24izndj6p","_id":"ckn9yvhwc005sqwv24w6qeond"},{"post_id":"ckpxmxgrw0000h8v2egzj7693","tag_id":"ckpxmxgsg0003h8v26sqzfbp6","_id":"ckpxmxgsj0007h8v2g992dd22"},{"post_id":"ckpxmxgs00001h8v2bwk7a7ve","tag_id":"ckpxmxgsj0006h8v2d13d2a41","_id":"ckpxmxgsk000bh8v2f6sh2da5"},{"post_id":"ckpxmxgsh0004h8v2a6axbhhq","tag_id":"ckpxmxgsk000ah8v2b341e828","_id":"ckpxmxgsk000dh8v22radfr6l"},{"post_id":"ckwbpt4if0000zsv295atdo8q","tag_id":"ckwbpt4iv0003zsv23afj0l8n","_id":"ckwbpt4j00009zsv2d4i472df"},{"post_id":"ckwbpt4ix0006zsv22qoidjh9","tag_id":"ckwbpt4iv0003zsv23afj0l8n","_id":"ckwbpt4j0000azsv24gwmd6qp"},{"post_id":"ckwbpt4ij0001zsv21ijs980z","tag_id":"ckwbpt4iz0008zsv2bjyo1svj","_id":"ckwbpt4j2000fzsv26je4fexk"},{"post_id":"ckwbpt4iw0004zsv28b8xhers","tag_id":"ckwbpt4iz0008zsv2bjyo1svj","_id":"ckwbpt4j3000jzsv2akdshcxl"},{"post_id":"ckwbpt4ix0005zsv2e2f62itu","tag_id":"ckwbpt4j3000izsv2aowi0s7a","_id":"ckwbpt4j3000lzsv24lbf20qt"},{"post_id":"ckwbpt4jg000nzsv29eapec7c","tag_id":"ckpxmxgsg0003h8v26sqzfbp6","_id":"ckwbpt4ji000ozsv28qar23bv"}],"Tag":[{"name":"mysql","_id":"ckcujgdbn0002e0xlhojchej4"},{"name":"","_id":"ckcujgdbq0004e0xlacni3caf"},{"name":"hexo","_id":"ckcujgdbr0005e0xlhecqaty2"},{"name":"java","_id":"ckn9yvhuc0004qwv27rup1c75"},{"name":"java8","_id":"ckn9yvhus000mqwv2gilvakeq"},{"name":"","_id":"ckn9yvhuw000tqwv24apr9pmb"},{"name":"jvm","_id":"ckn9yvhv40011qwv21uhu3tid"},{"name":"linux","_id":"ckn9yvhv8001aqwv204102gyl"},{"name":"java","_id":"ckn9yvhva001kqwv20b6a6xcz"},{"name":"kafka","_id":"ckn9yvhvb001qqwv2cl3n1d7f"},{"name":"","_id":"ckn9yvhvj002iqwv28yks0ikq"},{"name":"","_id":"ckn9yvhvl002rqwv2419y600x"},{"name":"redis","_id":"ckn9yvhvo0031qwv2g28jadm3"},{"name":"shardingjdbc","_id":"ckn9yvhw1004cqwv22ro212lh"},{"name":"spring","_id":"ckn9yvhw6004rqwv2dnchg5ey"},{"name":"SpringCloud","_id":"ckn9yvhwb005gqwv285ev22dq"},{"name":"zookeeper","_id":"ckn9yvhwc005qqwv24izndj6p"},{"name":"","_id":"ckpxmxgsg0003h8v26sqzfbp6"},{"name":"influxdb","_id":"ckpxmxgsj0006h8v2d13d2a41"},{"name":"ElasticSearch","_id":"ckpxmxgsk000ah8v2b341e828"},{"name":"GoLang","_id":"ckwbpt4iv0003zsv23afj0l8n"},{"name":"Docker","_id":"ckwbpt4iz0008zsv2bjyo1svj"},{"name":"rust","_id":"ckwbpt4j3000izsv2aowi0s7a"}]}}