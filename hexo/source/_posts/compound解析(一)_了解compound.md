## Compound简介

Compound是一个部署在以太坊上的去中心化借贷服务的智能合约。相较于传统的中心化金融，Compound拥有公开透明的利率模型，高隐私性，及时借贷，放贷免绑约的特色。

## Compound基本架构

![](compound解析(一)_了解compound/1.png)

这边我们采用DAI代币来说明。首先放贷人将DAI放入智能合约中，即可立即完成放贷并产生利息。而借款人通过抵押资产(ETH,USDT等)的方式借走智能合约上的DAI，并按照利率支付利息。

- 借款人可以抵押任何Compound支持的资产，但为了防止借款人付不出利息，抵押的资产必须>借出的资产且要高于一定比例。例如小明打算抵押1ETH币换取DAI，那么假设目前市场价1ETH=100DAI,由于当前**ETH的抵押率=0.75**，所以1ETH => 75 DAI。
- 借款人可以随时还款，还款时依照借款的利率和时间，决定总共的还款数量。同样的话，放贷人随时都可以连本带利的提出DAI。

## 关于放贷

实际上关于放贷在Compound智能合约上是当放贷人放入1DAI到智能合约时，智能合约会产生额外的cDAI给放贷人，而放贷人随时都可以通过cDAI换回DAI以及多出来的DAI利息。

**放贷是如何产生利息的？**

在Compound中每种代币市场都有一个兑换率，例如1DAI可以兑换40cDAI，并且这个兑换率是随着时间不断变化的。

举例

1. 小明在2019-10-10将1000 DAI 放入智能合约中，并获得40000 cDAI
2. 2019-10-10这天DAI与cDAI的兑换率 = 1 / 40 = 0.25
3. 2020-10-10这天小明打算将放贷的钱连本带利提出来，这时候查一下发现兑换率为0.275
4. 于是小明用他的40000cDAI来换DAI, 总共可以换回 40000 * 0.275 = 1100 DAI
5. 所以这多出来的100 DAI 就是小明这一年来放贷获得的利息

关于兑换率的计算公式如下

```
totalCash = 放入智能合約，但還沒被借走 DAI 的總數量
totalBorrows = 所有借款人，所應償還 DAI 的總數量 (含本金利息)
totalReserves = 保留金總數量 (借款人所應支付的利息，部分被視為保留金)
totalSupply = 所有放貸人所得到 cDAI 的總數量

兑换率 = (totalCash + totalBorrows - totalReserves) / totalSupply
```

上面公式可以看出，兑换率的高低取决于**totalBorrows**。若**借款的量越多兑换率增加越快**。

## 关于利率

注 : 关于利率在Compound中有**直线型**和**拐点型**两种。

既然是放贷和借款，那么放贷利息和借款利息分别怎么算呢？这就关乎**放贷年利率**和**借款年利率**。然而计算这两个利率还要引入一个**使用率**。

**使用率 : 所有放贷进来的钱中，已经被借走的比例。**

```
使用率 = totalBorrows / (totalCash + totalBorrows)
```

假设使用率等于62%，表示放贷人放进来的DAI中有62%被人借走了。

**借款年利率**

```
借款年利率 = 基础利率 + (使用率 * 加给利率)
```

假设当前 基础利率 = 5%，加给利率 = 12 %， 使用率 = 62.13%，那么

借款年利率 = 5% + （12% * 0.6213） = 12.4556%

所以借款人所需要支付利息的年利率在这个当下是12.46%

**放贷年利率**

放贷年利率受到如下因素影响

- 借款年利率(上面描述计算出来的)
- 使用率
- 保留利率

```
放贷年利率 = 借款年利率 * 使用率 * (1 - 保留利率)
```

**利率的更新周期**

上述提到的借款，放贷的年利率，那么在Compound里面，随着使用率的变化，利率多久更新一次？

实际上，只要使用率一有变化，Compound利率就会立即更新，而利率更新的最小单位就是**一个区块的时间**。

在以太坊上，平均每15秒会产生一个区块，因此利率的变化大于15秒就有可能发生变化。

假設實際上剛好 15 秒產生一個區塊，也就是 1 分鐘產生 4 個區塊，1 小時產生 240 個區塊。

1. 小明於 10 月 10 日 11:00 在 Compound DAI 智能合約借了 100000 DAI，這個時候的借款年利率 = 10%
2. 在 10 月 10 日 12:00 時，由於**使用率**的更新，小明的借款年利率變成 15%
3. 小明於 10 月 10 日 13:00 決定連本帶利償還所有債務

請問小明總共需要支付多少錢呢？

- 在 11:00~12:00 中，借款年利率 = 10%，因此小明需要多支付：
  100000 x 0.1 x 240 / 2102400 約= 1.14 DAI
  (1 小時產生 240 個區塊，一年產生 2102400 個區塊)
- 在 12:00~13:00 中，借款年利率 = 15%，因此小明需要多支付：
  (100000 + 1.14) x 0.15 x 240 / 2102400 約= 1.71 DAI
  (注意這邊需要把上一次的利息也算進去)
- 所以，小明還款時總共需要支付：
  100000 + 1.14 + 1.71 = 100002.85 DAI

## 关于清算

上面提到，借款人需要抵押资产。若不够还钱，抵押的资产就会被拿去用比市场价低的价格卖出，这就是清算。

每个Compound上面的资产都有其**抵押率**。也就是你抵押了这个资产，你能够用这个资产的多少比例借其他资产。

![](compound解析(一)_了解compound/2.png)

以上面的例子來說：

1. 假設小美想要抵押 ETH 來借 DAI，於是小美抵押了 3 ETH ，假設目前市價 1 ETH = 200 USD，於是小美抵押了相當於 600 USD 的資產。
2. 由於 ETH **抵押率** = 0.75，因此小美實際上能借的最大資產 = 600 x 0.75 = 450 USD
3. 小美於是借走了445 DAI (假設目前市價 1 DAI = 1 USD)
4. 假設經過一段時間後，小美需要償還 6 DAI 的利息，而 6 + 445 = 451 USD，已經超過了小美能借的最大資產量，但小美尚無償還的動作。
5. 於是，小美抵押的部分資產將會被**清算** (liquidate)，由於總共需要償還 451 USD，於是在 Compound 的清算機制下，最多會有一半 (451 / 2) 的借出資產被清算。
6. 例如：小美的 200 USD 被清算，乘以一個比例，假設為 1.1，小美的 220 USD 的 ETH，也就是 1.1 ETH 會被沒收，然後償還小美 200 USD (200 DAI) 的債務。
7. 於是清算後，小美被扣除了 1.1 ETH (相當於 220 USD)，償還了 200 USD 的 DAI 後，剩下 451–200 = 251 USD 需要償還。
   (實際運作上是開放給任何人，若幫小美償還 200 DAI，可以獲得小美抵押的 1.1 ETH，於是有了 10% 的獲利)
8. 而此時小美抵押的 ETH 剩下 1.9 ETH，於是目前可以借的最大資產 = 1.9 x 200 x 0.75 = 285 USD > 需要償還的 251 USD，清算結束。

## 疑问点汇总

1. compound的利率是动态变化的，假设有1000个人存款且每个人存的数目和时间不同，由于利率是动态变化的，按照传统的方式每次利率变化都要对这1000个人的利息进行计算，这样的计算量很大，对于区块链是不适合的，下面是Chatgpt的回答。

   1. 当涉及到大量用户的存款利息计算时，利率模型可以采用以下方式来解决计算量的问题：

      假设有一个利率模型，该模型将存款利率表示为指数形式，而不是具体的利率值。这个指数可以根据市场供求关系的变化进行调整。

      现在考虑一个场景：有1000个用户在Compound协议中存入了资金，每个用户的存款金额和存款开始时间都不同。存款利率在一段时间内发生了多次变化。

      如果按照传统的方式，每个用户的存款利息都需要实时计算，涉及大量的计算量和复杂的数据存储。这样的计算量可能会对系统的性能和资源消耗造成负担。

      而利率模型可以通过以下方式解决这个问题：

      1. 利率指数：利率模型根据市场供求关系和其他因素计算出一个利率指数，该指数反映了整个市场的存款利率变化情况。
      2. 存款利息计算：当用户存款时，系统记录用户的存款金额和存款开始时间。同时，记录下当时的利率指数。
      3. 利息更新：当存款利率发生变化时，系统只需要更新利率指数，而不需要重新计算每个用户的利息。
      4. 增量计算：当用户赎回存款或查询存款利息时，系统根据存款金额、存款开始时间和存款期间的利率指数变化来计算存款的利息。这个计算只涉及到利率指数的增量计算，而不需要针对每个用户的存款进行全量计算。

      通过利率模型，系统可以避免对每个用户存款进行实时计算，而是根据利率指数和存款的相关信息进行增量计算。这样可以大大减少计算量和复杂性，并提高系统的性能和效率。

      需要注意的是，这只是一个简化的例子，实际的利率模型可能更加复杂，并涉及更多的因素和算法。具体的利率模型和计算策略会根据Compound协议的实现而有所不同。

      对于Compound协议中的直线型利率模型，我将结合您之前的问题来解释利息计算的过程。

      假设您在Compound中存入了1个ETH，存款开始时的利率是5%。在存款期间内，利率发生了变化，分别为6%和4%。假设您存款的时间跨度为10000个区块。

      根据直线型利率模型，在利率发生变化时，存款的利率会线性插值，即根据时间的比例来计算实际的存款利率。这意味着存款在不同利率阶段的利息计算是根据存款时间和相应利率的比例来进行的。

      具体的利息计算步骤如下：

      1. 确定存款的利率阶段：根据存款开始时的利率和每个利率阶段的变化时间，确定存款所处的利率阶段。在您的例子中，存款开始时的利率是5%，然后在第100个区块时变为6%，在第9000个区块时又变为4%。
      2. 计算利率比例：根据存款时间和利率阶段的时间跨度，计算存款所处的利率阶段的时间比例。在您的例子中，存款时间为10000个区块，因此在第100个区块时的利率阶段的时间比例为100/10000 = 1%，在第9000个区块时的利率阶段的时间比例为9000/10000 = 90%。
      3. 计算利息：根据利率比例，将存款金额乘以相应的利率来计算利息。在您的例子中，利息的计算如下：
         - 第100个区块时的利息：1 ETH * 5% * 1% = 0.005 ETH
         - 第9000个区块时的利息：1 ETH * 6% * 90% = 0.054 ETH
         - 第9000个区块后的利息：1 ETH * 4% * 9% = 0.036 ETH
      4. 总利息：将每个阶段的利息相加得到总利息。在您的例子中，总利息为 0.005 ETH + 0.054 ETH + 0.036 ETH = 0.095 ETH。

      因此，根据Compound协议中的直线型利率模型和您的存款情况，最终您将获得0.095 ETH的利息。

      需要注意的是，这只是一个简化的示例，实际的利率计算和模型可能更加复杂，并涉及更多的因素和算法。具体的计算方式会根据Compound协议的实现而有所不同。

## 参考

- https://www.defidaonews.com/media/6662323
- https://medium.com/steaker-com/defi-%E7%9A%84%E4%B8%96%E7%95%8C-compound-%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90-%E5%88%A9%E7%8E%87%E6%A8%A1%E5%9E%8B%E7%AF%87-95e9b303c284
- https://juejin.cn/post/6974005248947929124#heading-6