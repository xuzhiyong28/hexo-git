---
title: redis主从复制原理
tags:
  - redis
categories: redis
description : redis主从复制原理
date: 2020-08-20 09:09:59
---
## Redis主从复制配置
```shell
127.0.0.1:6380> SLAVEOF 127.0.0.1 6379
```

## 原理详解

redis的复制功能分为**完整重同步**和**部分重同步**两个操作。
- 完整重同步操作，将从服务器的数据库状态更新至主服务器当前所处的数据库状态。
- 部分重同步操作，用于处理断线后重复制情况：当从服务器在断线后重新连接主服务器时，**如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。**

### 完整同步

同步的过程包括如下：

1. 从服务器向主服务器发送SYNC命令。
2. 收到SYNC后主服务器执行BGSAVE命令生成RDB文件，期间并使用一个缓冲区记录从现在开始执行的所有写命令。
3. BGSAVE命令执行完毕后，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器。
4. 从服务器接收并载入RDB文件，将状态更新与主服务器一致。

![bgsave执行逻辑](redis-master-slave/1.png)

### 部分重同步

xxx

#### SYNC命令

SYNC命令是一个非常耗费资源的操作。每次执行SYNC主从服务器需要执行的操作如下：

- 主服务器需要执行BGSAVE命令来生成RDB文件，这个生成操作会耗费主服务器大量的CPU、内存和磁盘I/O资源。
- 主服务器需要将自己生成的RDB文件发送给从服务器，这个发送操作会耗费主从服务器大量的网络资源（带宽和流量）
- 接收到RDB文件的从服务器需要载入主服务器发来的RDB文件，并且在载入期间，从**服务器会因为阻塞而没办法处理命令请求**

<font color=red>SYNC是一个如此消耗资源的命令，所以Redis最好在真需要的时候才需要执行SYNC命令。</font>